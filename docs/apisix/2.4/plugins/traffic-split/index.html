<!doctype html>
<html class="docs-version-2.4" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WQLBQL6GY3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WQLBQL6GY3",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/releases/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/releases/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/articles/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/articles/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"><title data-react-helmet="true">traffic-split | Apache APISIX® -- Cloud-Native API Gateway</title><meta data-react-helmet="true" property="og:image" content="https://apisix.apache.org/img/apache-apisix.png"><meta data-react-helmet="true" name="twitter:image" content="https://apisix.apache.org/img/apache-apisix.png"><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/docs/apisix/2.4/plugins/traffic-split"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="2.4"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-docs-apisix-2.4"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="traffic-split | Apache APISIX® -- Cloud-Native API Gateway"><meta data-react-helmet="true" name="description" content="&lt;!--"><meta data-react-helmet="true" property="og:description" content="&lt;!--"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/docs/apisix/2.4/plugins/traffic-split"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/docs/apisix/2.4/plugins/traffic-split" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/zh/docs/apisix/2.4/plugins/traffic-split" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/docs/apisix/2.4/plugins/traffic-split" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/css/styles.4ccf253e.css">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/js/runtime~main.9b9ef40f.js" as="script">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/js/main.12098c32.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">🤔 Have queries regarding apache APISIX, Join slack channel to discuss them <a target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/the-asf/shared_invite/zt-vlfbf7ch-HkbNHiU_uDlcH_RvaHv9gQ">join #apisix channel</a>! ⭐️</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/apisix/getting-started">Apache APISIX®️</a></li><li><a class="dropdown__link" href="/docs/dashboard/USER_GUIDE">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" href="/docs/ingress-controller/getting-started/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/general/security">General</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">FAQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/apisix/FAQ/">Apache APISIX®</a></li><li><a class="dropdown__link" href="/docs/dashboard/FAQ/">Apache APISIX® Dashboard</a></li><li><a class="dropdown__link" href="/docs/ingress-controller/FAQ/">Apache APISIX® Ingress Controller</a></li><li><a class="dropdown__link" href="/docs/helm-chart/FAQ/">Apache APISIX® Helm Chart</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/downloads">Downloads</a><a class="navbar__item navbar__link" href="/team">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/general/community">Community</a></li><li><a class="dropdown__link" href="/plugins">Plugin Hub</a></li><li><a class="dropdown__link" href="/releases">Releases</a></li><li><a class="dropdown__link" href="/help">Help</a></li></ul></div><a class="navbar__item navbar__link" href="/showcase">Showcase</a><a class="navbar__item navbar__link" href="/contribute">Contribute</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/apisix/2.4/plugins/traffic-split" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/docs/apisix/2.4/plugins/traffic-split" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_3AUJ"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_2LAn"><div class="sidebar_3jCp sidebarWithHideableNavbar_Uxjr"><a tabindex="-1" class="sidebarLogo_8bKs" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--dark_hz6m"><b>Apache APISIX®</b></a><div class="sidebarVersionSwitch_m-Df">Version:<div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/docs/apisix/2.4/architecture-design">2.4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/apisix/next/plugins/traffic-split">Next</a></li><li><a class="dropdown__link" href="/docs/apisix/plugins/traffic-split">2.11</a></li><li><a class="dropdown__link" href="/docs/apisix/2.10/plugins/traffic-split">2.10</a></li><li><a class="dropdown__link" href="/docs/apisix/2.9/plugins/traffic-split">2.9</a></li><li><a class="dropdown__link" href="/docs/apisix/2.8/plugins/traffic-split">2.8</a></li><li><a class="dropdown__link" href="/docs/apisix/2.7/plugins/traffic-split">2.7</a></li><li><a class="dropdown__link" href="/docs/apisix/2.6/plugins/traffic-split">2.6</a></li><li><a class="dropdown__link" href="/docs/apisix/2.5/plugins/traffic-split">2.5</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/apisix/2.4/plugins/traffic-split">2.4</a></li></ul></div></div><nav class="menu thin-scrollbar menu_1DcY menuWithAnnouncementBar_3IKd"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/architecture-design">Architecture Design</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/how-to-build">How to build Apache APISIX</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Plugins</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">General</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Transformation</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Authentication</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Security</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Traffic</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/limit-req">limit-req</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/limit-conn">limit-conn</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/limit-count">limit-connt</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/proxy-cache">proxy-cache</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/request-validation">request-validation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/proxy-mirror">proxy-mirror</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/apisix/2.4/plugins/api-breaker">api-breaker</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/apisix/2.4/plugins/traffic-split">traffic-split</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Monitoring</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Loggers</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/admin-api">Admin API</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/control-api">Control API</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/health-check">Health Check</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/router-radixtree">Router radixtree</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/stand-alone">Stand-alone mode</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/stream-proxy">Stream Proxy</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/grpc-proxy">gRPC Proxy</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/customize-nginx-configuration">Customize Nginx configuration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/dns">DNS</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/https">HTTPS</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/benchmark">Benchmark</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://github.com/apache/apisix/blob/master/CODE_STYLE" target="_blank" rel="noopener noreferrer" class="menu__link"><span>CODE_STYLE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/debug-function">Debug Function</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/apisix/2.4/FAQ">FAQ</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://github.com/apache/apisix/blob/master/CHANGELOG" target="_blank" rel="noopener noreferrer" class="menu__link"><span>CHANGELOG<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_3okl"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_1LB5"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_2AUC"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Apache APISIX® -- Cloud-Native API Gateway <b>2.4</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/apisix/plugins/traffic-split">latest version</a></b> (2.11).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.4</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>traffic-split</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><ul><li><a href="#name"><strong>Name</strong></a></li><li><a href="#attributes"><strong>Attributes</strong></a></li><li><a href="#how-to-enable"><strong>How To Enable</strong></a></li><li><a href="#example"><strong>Example</strong></a><ul><li><a href="#grayscale-release"><strong>Grayscale Release</strong></a></li><li><a href="#blue-green-release"><strong>Blue-green Release</strong></a></li><li><a href="#custom-release"><strong>Custom Release</strong></a></li></ul></li><li><a href="#disable-plugin"><strong>Disable Plugin</strong></a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="name"></a>Name<a class="hash-link" href="#name" title="Direct link to heading">#</a></h2><p>The traffic split plugin allows users to incrementally direct percentages of traffic between various upstreams.</p><p>Note: The ratio between each upstream may not so accurate since the drawback of weighted round robin algorithm (especially when the wrr state is reset).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="attributes"></a>Attributes<a class="hash-link" href="#attributes" title="Direct link to heading">#</a></h2><table><thead><tr><th>Name</th><th>Type</th><th>Requirement</th><th>Default</th><th>Valid</th><th>Description</th></tr></thead><tbody><tr><td>rules.match</td><td>array[object]</td><td>optional</td><td></td><td></td><td>List of matching rules.</td></tr><tr><td>rules.match.vars</td><td>array[array]</td><td>optional</td><td></td><td></td><td>A list consisting of one or more {var, operator, val} elements, like this: {{var, operator, val}, {var, operator, val}, ...}}. For example: {&quot;arg_name&quot;, &quot;==&quot;, &quot;json&quot;}, which means that the current request parameter name is json. The var here is consistent with the naming of Nginx internal variables, so request_uri, host, etc. can also be used; for the operator part, the currently supported operators are ==, ~=, ~~, &gt;, &lt;, in, has and !. For specific usage of operators, please see the <code>operator-list</code> part of <a href="https://github.com/api7/lua-resty-expr#operator-list" target="_blank" rel="noopener noreferrer">lua-resty-expr</a>.</td></tr><tr><td>rules.weighted_upstreams</td><td>array[object]</td><td>optional</td><td></td><td></td><td>List of upstream configuration rules.</td></tr><tr><td>weighted_upstreams.upstream_id</td><td>string/integer</td><td>optional</td><td></td><td></td><td>The upstream id is bound to the corresponding upstream.</td></tr><tr><td>weighted_upstreams.upstream</td><td>object</td><td>optional</td><td></td><td></td><td>Upstream configuration information.</td></tr><tr><td>upstream.type</td><td>enum</td><td>optional</td><td>roundrobin</td><td>[roundrobin, chash]</td><td>roundrobin supports weighted load, chash consistent hashing, the two are alternatives.</td></tr><tr><td>upstream.nodes</td><td>object</td><td>optional</td><td></td><td></td><td>In the hash table, the key of the internal element is the list of upstream machine addresses, in the format of address + Port, where the address part can be an IP or a domain name, such as 192.168.1.100:80, foo.com:80, etc. value is the weight of the node. In particular, when the weight value is 0, it has special meaning, which usually means that the upstream node is invalid and never wants to be selected.</td></tr><tr><td>upstream.timeout</td><td>object</td><td>optional</td><td>15</td><td></td><td>Set the timeout period for connecting, sending and receiving messages (time unit: second, all default to 15 seconds).</td></tr><tr><td>upstream.pass_host</td><td>enum</td><td>optional</td><td>&quot;pass&quot;</td><td>[&quot;pass&quot;, &quot;node&quot;, &quot;rewrite&quot;]</td><td>pass: pass the host requested by the client, node: pass the host requested by the client; use the host configured with the upstream node, rewrite: rewrite the host with the value configured by the upstream_host.</td></tr><tr><td><code>upstream.name</code></td><td>string</td><td>optional</td><td></td><td></td><td>Identify the upstream service name, usage scenario, etc.</td></tr><tr><td>upstream.upstream_host</td><td>string</td><td>optional</td><td></td><td></td><td>Only valid when pass_host is configured as rewrite.</td></tr><tr><td>weighted_upstreams.weight</td><td>integer</td><td>optional</td><td>weight = 1</td><td></td><td>The traffic is divided according to the <code>weight</code> value, and the roundrobin algorithm is used to divide multiple <code>weight</code>.</td></tr></tbody></table><p>The traffic-split plugin is mainly composed of two parts: <code>match</code> and <code>weighted_upstreams</code>. <code>match</code> is a custom conditional rule, and <code>weighted_upstreams</code> is upstream configuration information. If you configure <code>match</code> and <code>weighted_upstreams</code> information, then after the <code>match</code> rule is verified, it will be based on the <code>weight</code> value in <code>weighted_upstreams</code>; the ratio of traffic between each upstream in the plugin will be guided, otherwise, all traffic will be directly Reach the <code>upstream</code> configured on <code>route</code> or <code>service</code>. Of course, you can also configure only the <code>weighted_upstreams</code> part, which will directly guide the traffic ratio between each upstream in the plugin based on the <code>weight</code> value in <code>weighted_upstreams</code>.</p><p>Note: 1. In <code>match</code>, the expression in vars is the relationship of <code>and</code>, and the relationship between multiple <code>vars</code> is the relationship of <code>or</code>.  2. In the weighted_upstreams field of the plugin, if there is a structure with only <code>weight</code>, it means the upstream traffic weight value on <code>route</code> or <code>service</code>. Such as:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">&quot;weighted_upstreams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="how-to-enable"></a>How To Enable<a class="hash-link" href="#how-to-enable" title="Direct link to heading">#</a></h2><p>Create a route and enable the <code>traffic-split</code> plugin. When configuring the upstream information of the plugin, there are two ways:</p><ol><li>Configure upstream information through the <code>upstream</code> attribute in the plugin.</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;name&quot;: &quot;upstream_A&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;127.0.0.1:1981&quot;:10</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;timeout&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;connect&quot;: 15,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;send&quot;: 15,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;read&quot;: 15</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol start="2"><li>Use the <code>upstream_id</code> attribute in the plugin to bind upstream.</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream_id&quot;: 1,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><blockquote><p>Note: <strong>1.</strong> Use the <code>upstream_id</code> to bind the defined upstream, it can reuse upstream health detection, retry and other functions. <strong>2.</strong> Support the two configuration methods of <code>upstream</code> and <code>upstream_id</code> to be used together.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="grayscale-release"></a>Grayscale Release<a class="hash-link" href="#grayscale-release" title="Direct link to heading">#</a></h3><p>The <code>match</code> rule part is missing, and the traffic is split according to the <code>weight</code> value configured by the <code>weighted_upstreams</code> in the plugin. Divide <code>plugin&#x27;s upstream</code> and <code>route&#x27;s upstream</code> according to the traffic ratio of 3:2, of which 60% of the traffic reaches the upstream of the <code>1981</code> port in the plugin, and 40% of the traffic reaches the default <code>1980</code> port on the route Upstream.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;name&quot;: &quot;upstream_A&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;127.0.0.1:1981&quot;:10</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;timeout&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;connect&quot;: 15,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;send&quot;: 15,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;read&quot;: 15</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 3</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 2</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Test plugin:</strong></p><p>There are 5 requests, 3 requests hit the upstream of port 1981 of the plugin, and 2 requests hit the upstream of port 1980 of <code>route</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/index.html -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/index.html -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">world </span><span class="token number" style="color:#36acaa">1981</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="blue-green-release"></a>Blue-green Release<a class="hash-link" href="#blue-green-release" title="Direct link to heading">#</a></h3><p>Get the <code>match</code> rule parameter through the request header (you can also get it through the request parameter or NGINX variable). After the <code>match</code> rule is matched, it means that all requests hit the upstream configured by the plugin, otherwise the request only hits the <code>route</code> configured upstream.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;match&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;vars&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_release&quot;,&quot;==&quot;,&quot;new_release&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;name&quot;: &quot;upstream_A&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;127.0.0.1:1981&quot;:10</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Test plugin:</strong></p><p>The rule of <code>match</code> is matched, and all requests hit the upstream port 1981 configured by the plugin:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/index.html -H </span><span class="token string" style="color:#e3116c">&#x27;release: new_release&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">world </span><span class="token number" style="color:#36acaa">1981</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>match</code> rule fails to match, and all requests hit the 1980 port upstream configured on the <code>route</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/index.html -H </span><span class="token string" style="color:#e3116c">&#x27;release: old_release&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="custom-release"></a>Custom Release<a class="hash-link" href="#custom-release" title="Direct link to heading">#</a></h3><p>Multiple <code>vars</code> rules can be set in <code>match</code>. Multiple expressions in <code>vars</code> have an <code>add</code> relationship, and multiple <code>vars</code> rules have an <code>or</code> relationship; as long as one of the vars is required If the rule passes, the entire <code>match</code> passes.</p><p><strong>Example 1: Only one <code>vars</code> rule is configured, and multiple expressions in <code>vars</code> are in the relationship of <code>add</code>. In <code>weighted_upstreams</code>, the traffic is divided into 3:2 according to the value of <code>weight</code>, of which only the part of the <code>weight</code> value represents the proportion of upstream on the <code>route</code>. When <code>match</code> fails to pass, all traffic will only hit the upstream on the route.</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;match&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;vars&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;arg_name&quot;,&quot;==&quot;,&quot;jack&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_user-id&quot;,&quot;&gt;&quot;,&quot;23&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_apisix-key&quot;,&quot;~~&quot;,&quot;[a-z]+&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;name&quot;: &quot;upstream_A&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;127.0.0.1:1981&quot;:10</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 3</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 2</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The plugin sets the requested <code>match</code> rule and upstream with port <code>1981</code>, and the route has upstream with port <code>1980</code>.</p><p><strong>Test plugin:</strong></p><blockquote><ol><li>After the verification of the <code>match</code> rule is passed, 60% of the requests hit the upstream of the plugin port 1981, and 40% of the requests hit the upstream of the 1980 port of the <code>route</code>.</li></ol></blockquote><p>The match rule is successfully verified, and the upstream port of <code>1981</code> is hit.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">world </span><span class="token number" style="color:#36acaa">1981</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The match rule fails to verify, and it hits the upstream of the default port of <code>1980</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p><p><strong>Example 2: Configure multiple <code>vars</code> rules. Multiple expressions in <code>vars</code> are <code>add</code> relationships, and multiple <code>vars</code> are <code>or</code> relationships. According to the <code>weight</code> value in <code>weighted_upstreams</code>, the traffic is divided into 3:2, where only the part of the <code>weight</code> value represents the proportion of upstream on the route. When <code>match</code> fails to pass, all traffic will only hit the upstream on the route.</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;traffic-split&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;rules&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;match&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;vars&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;arg_name&quot;,&quot;==&quot;,&quot;jack&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_user-id&quot;,&quot;&gt;&quot;,&quot;23&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_apisix-key&quot;,&quot;~~&quot;,&quot;[a-z]+&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;vars&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;arg_name2&quot;,&quot;==&quot;,&quot;rose&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_user-id2&quot;,&quot;!&quot;,&quot;&gt;&quot;,&quot;33&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                [&quot;http_apisix-key2&quot;,&quot;~~&quot;,&quot;[a-z]+&quot;]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ],</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    &quot;weighted_upstreams&quot;: [</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;name&quot;: &quot;upstream_A&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                    &quot;127.0.0.1:1981&quot;:10</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 3</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                            &quot;weight&quot;: 2</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            ]</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    },</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The plugin sets the requested <code>match</code> rule and the upstream port of <code>1981</code>, and the route has upstream port of <code>1980</code>.</p><p><strong>Test plugin:</strong></p><blockquote><ol><li>The expressions of the two <code>vars</code> are matched successfully. After the <code>match</code> rule is verified, 60% of the requests hit the 1981 port upstream of the plugin, and 40% of the requests hit the 1980 port upstream of the <code>route</code>.</li></ol></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&amp;name2=rose&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id2:22&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key2: world&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">world </span><span class="token number" style="color:#36acaa">1981</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&amp;name2=rose&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id2:22&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key2: world&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p><blockquote><ol start="2"><li>The second expression of <code>vars</code> failed to match (missing the <code>name2</code> request parameter). After the <code>match</code> rule was verified, 60% of the requests hit the plugin&#x27;s 1981 port upstream, and 40% of the request traffic hits Go upstream to the 1980 port of <code>route</code>.</li></ol></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id2:22&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key2: world&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">world </span><span class="token number" style="color:#36acaa">1981</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id:30&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;user-id2:22&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key: hello&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;apisix-key2: world&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After 5 requests, the service of port <code>1981</code> was hit 3 times, and the service of port <code>1980</code> was hit 2 times.</p><blockquote><ol start="3"><li>The expression verification of two <code>vars</code> failed (missing the request parameters of <code>name</code> and <code>name2</code>), the <code>match</code> rule verification failed, and the response is the upstream data <code>hello 1980</code> of the default <code>route</code>.</li></ol></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;http://127.0.0.1:9080/index.html?name=jack&#x27;</span><span class="token plain"> -i</span></span><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hello </span><span class="token number" style="color:#36acaa">1980</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="disable-plugin"></a>Disable Plugin<a class="hash-link" href="#disable-plugin" title="Direct link to heading">#</a></h2><p>When you want to remove the traffic-split plugin, it&#x27;s very simple, just delete the corresponding json configuration in the plugin configuration, no need to restart the service, it will take effect immediately:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 -H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/index.html&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {},</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;127.0.0.1:1980&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/apisix/edit/release/2.4/docs/en/latest/plugins/traffic-split.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/apisix/2.4/plugins/api-breaker"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« api-breaker</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/apisix/2.4/plugins/prometheus"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">prometheus »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link">Summary</a></li><li><a href="#name" class="table-of-contents__link">Name</a></li><li><a href="#attributes" class="table-of-contents__link">Attributes</a></li><li><a href="#how-to-enable" class="table-of-contents__link">How To Enable</a></li><li><a href="#example" class="table-of-contents__link">Example</a><ul><li><a href="#grayscale-release" class="table-of-contents__link">Grayscale Release</a></li><li><a href="#blue-green-release" class="table-of-contents__link">Blue-green Release</a></li><li><a href="#custom-release" class="table-of-contents__link">Custom Release</a></li></ul></li><li><a href="#disable-plugin" class="table-of-contents__link">Disable Plugin</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ASF</div><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker</a></li><li class="footer__item"><a href="https://join.slack.com/t/the-asf/shared_invite/zt-vlfbf7ch-HkbNHiU_uDlcH_RvaHv9gQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://apisix.apache.org/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2019-2021 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9b9ef40f.js"></script>
<script src="/assets/js/main.12098c32.js"></script>
</body>
</html>