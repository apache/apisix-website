<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>apisix/zh-cn/discovery · Apache APISIX™</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;!--"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="apisix/zh-cn/discovery · Apache APISIX™"/><meta property="og:type" content="website"/><meta property="og:url" content="https://apisix.apache.org//"/><meta property="og:description" content="&lt;!--"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://apisix.apache.org/blog/atom.xml" title="Apache APISIX™ Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://apisix.apache.org/blog/feed.xml" title="Apache APISIX™ Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Apache APISIX™"/><h2 class="headerTitleWithLogo">Apache APISIX™</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/subscribe-guide" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/downloads" target="_self">Downloads</a></li><li class=""><a href="/team" target="_self">Team</a></li><li class=""><a href="/help" target="_self">Help</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">apisix/zh-cn/discovery</h1></header><article><div><span><!--
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
-->
[English](/apisix/discovery)
<h1><a class="anchor" aria-hidden="true" id="集成服务发现注册中心"></a><a href="#集成服务发现注册中心" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>集成服务发现注册中心</h1>
<ul>
<li><a href="#摘要"><strong>摘要</strong></a></li>
<li><a href="#如何扩展注册中心"><strong>如何扩展注册中心</strong></a>
<ul>
<li><a href="#基本步骤"><strong>基本步骤</strong></a></li>
<li><a href="#以-Eureka-举例"><strong>以 Eureka 举例</strong></a>
<ul>
<li><a href="#实现-eurekalua"><strong>实现 eureka.lua</strong></a></li>
<li><a href="#Eureka-与-APISIX-之间数据转换逻辑"><strong>Eureka 与 APISIX 之间数据转换逻辑</strong></a></li>
</ul></li>
</ul></li>
<li><a href="#注册中心配置"><strong>注册中心配置</strong></a>
<ul>
<li><a href="#初始化服务发现"><strong>初始化服务发现</strong></a></li>
<li><a href="#Eureka-的配置"><strong>Eureka 的配置</strong></a></li>
</ul></li>
<li><a href="#upstream-配置"><strong>upstream 配置</strong></a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="摘要"></a><a href="#摘要" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>摘要</h2>
<p>当业务量发生变化时，需要对上游服务进行扩缩容，或者因服务器硬件故障需要更换服务器。如果网关是通过配置来维护上游服务信息，在微服务架构模式下，其带来的维护成本可想而知。再者因不能及时更新这些信息，也会对业务带来一定的影响，还有人为误操作带来的影响也不可忽视，所以网关非常必要通过服务注册中心动态获取最新的服务实例信息。架构图如下所示：</p>
<p><img src="https://apisix.apache.org/images/discovery-cn.png" alt=""></p>
<ol>
<li>服务启动时将自身的一些信息，比如服务名、IP、端口等信息上报到注册中心；各个服务与注册中心使用一定机制（例如心跳）通信，如果注册中心与服务长时间无法通信，就会注销该实例；当服务下线时，会删除注册中心的实例信息；</li>
<li>网关会准实时地从注册中心获取服务实例信息；</li>
<li>当用户通过网关请求服务时，网关从注册中心获取的实例列表中选择一个进行代理；</li>
</ol>
<p>常见的注册中心：Eureka, Etcd, Consul, Nacos, Zookeeper等</p>
<h2><a class="anchor" aria-hidden="true" id="如何扩展注册中心？"></a><a href="#如何扩展注册中心？" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>如何扩展注册中心？</h2>
<h3><a class="anchor" aria-hidden="true" id="基本步骤"></a><a href="#基本步骤" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本步骤</h3>
<p>APISIX 要扩展注册中心其实是件非常容易的事情，其基本步骤如下：</p>
<ol>
<li>在 <code>apisix/discovery/</code> 目录中添加注册中心客户端的实现；</li>
<li>实现用于初始化的 <code>_M.init_worker()</code> 函数以及用于获取服务实例节点列表的 <code>_M.nodes(service_name)</code> 函数；</li>
<li>将注册中心数据转换为 APISIX 格式的数据；</li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="以-eureka-举例"></a><a href="#以-eureka-举例" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>以 Eureka 举例</h3>
<h4><a class="anchor" aria-hidden="true" id="实现-eurekalua"></a><a href="#实现-eurekalua" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 eureka.lua</h4>
<p>首先在 <code>apisix/discovery/</code> 目录中添加 <a href="../../apisix/discovery/eureka.lua"><code>eureka.lua</code></a>;</p>
<p>然后在 <code>eureka.lua</code> 实现用于初始化的 <code>init_worker</code> 函数以及用于获取服务实例节点列表的 <code>nodes</code> 函数即可：</p>
<pre><code class="hljs css language-lua"><span class="hljs-keyword">local</span> _M = {
    version = <span class="hljs-number">0.1</span>,
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.nodes</span><span class="hljs-params">(service_name)</span></span>
    ... ...
<span class="hljs-keyword">end</span>


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.init_worker</span><span class="hljs-params">()</span></span>
    ... ...
<span class="hljs-keyword">end</span>


<span class="hljs-keyword">return</span> _M
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="eureka-与-apisix-之间数据转换逻辑"></a><a href="#eureka-与-apisix-之间数据转换逻辑" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 与 APISIX 之间数据转换逻辑</h4>
<p>APISIX是通过 <code>upstream.nodes</code> 来配置上游服务的，所以使用注册中心后，通过注册中心获取服务的所有 node 后，赋值给 <code>upstream.nodes</code> 来达到相同的效果。那么 APISIX 是怎么将 Eureka 的数据转成 node 的呢？ 假如从 Eureka 获取如下数据：</p>
<pre><code class="hljs css language-json">{
  "applications": {
      "application": [
          {
              "name": "USER-SERVICE",                 # 服务名称
              "instance": [
                  {
                      "instanceId": "192.168.1.100:8761",
                      "hostName": "192.168.1.100",
                      "app": "USER-SERVICE",          # 服务名称
                      "ipAddr": "192.168.1.100",      # 实例 IP 地址
                      "status": "UP",                 # 状态
                      "overriddenStatus": "UNKNOWN",  # 覆盖状态
                      "port": {
                          "$": 8761,                  # 端口
                          "@enabled": "true"          # 开始端口
                      },
                      "securePort": {
                          "$": 443,
                          "@enabled": "false"
                      },
                      "metadata": {
                          "management.port": "8761",
                          "weight": 100               # 权重，需要通过 spring boot 应用的 eureka.instance.metadata-map.weight 进行配置
                      },
                      "homePageUrl": "http://192.168.1.100:8761/",
                      "statusPageUrl": "http://192.168.1.100:8761/actuator/info",
                      "healthCheckUrl": "http://192.168.1.100:8761/actuator/health",
                      ... ...
                  }
              ]
          }
      ]
  }
}
</code></pre>
<p>解析 instance 数据步骤：</p>
<ol>
<li>首先要选择状态为 “UP” 的实例： overriddenStatus 值不为 &quot;UNKNOWN&quot; 以 overriddenStatus 为准，否则以 status 的值为准；</li>
<li>IP 地址：以 ipAddr 的值为 IP; 并且必须是 IPv4 或 IPv6 格式的；</li>
<li>端口：端口取值规则是，如果 port[&quot;@enabled&quot;] 等于 &quot;true&quot; 那么使用 port[&quot;$&quot;] 的值；如果 securePort[&quot;@enabled&quot;] 等于 &quot;true&quot; 那么使用 securePort[&quot;$&quot;] 的值；</li>
<li>权重：权重取值顺序是，先判断 <code>metadata.weight</code> 是否有值，如果没有，则取配置中的 <code>eureka.weight</code> 的值, 如果还没有，则取默认值<code>100</code>；</li>
</ol>
<p>这个例子转成 APISIX nodes 的结果如下：</p>
<pre><code class="hljs css language-json">[
  {
    <span class="hljs-attr">"host"</span> : <span class="hljs-string">"192.168.1.100"</span>,
    <span class="hljs-attr">"port"</span> : <span class="hljs-number">8761</span>,
    <span class="hljs-attr">"weight"</span> : <span class="hljs-number">100</span>,
    <span class="hljs-attr">"metadata"</span> : {
      <span class="hljs-attr">"management.port"</span>: <span class="hljs-string">"8761"</span>,
    }
  }
]
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="注册中心配置"></a><a href="#注册中心配置" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>注册中心配置</h2>
<h3><a class="anchor" aria-hidden="true" id="初始化服务发现"></a><a href="#初始化服务发现" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>初始化服务发现</h3>
<p>首先要在 <code>conf/config.yaml</code> 文件中增加如下配置，添加不同的服务发现客户端，以便在使用过程中动态选择：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">discovery:</span>
  <span class="hljs-attr">eureka:</span>
      <span class="hljs-string">...</span>
</code></pre>
<p>此名称要与 <code>apisix/discovery/</code> 目录中实现对应注册中心的文件名保持一致。</p>
<p>现已支持注册中心有：Eureka 。</p>
<h3><a class="anchor" aria-hidden="true" id="eureka-的配置"></a><a href="#eureka-的配置" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Eureka 的配置</h3>
<p>在 <code>conf/config.yaml</code> 增加如下格式的配置：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">discovery:</span>
  <span class="hljs-attr">eureka:</span>
    <span class="hljs-attr">host:</span>                            <span class="hljs-comment"># it's possible to define multiple eureka hosts addresses of the same eureka cluster.</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"http://${username}:${password}@${eureka_host1}:${eureka_port1}"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"http://${username}:${password}@${eureka_host2}:${eureka_port2}"</span>
    <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/eureka/"</span>
    <span class="hljs-attr">fetch_interval:</span> <span class="hljs-number">30</span>               <span class="hljs-comment"># 从 eureka 中拉取数据的时间间隔，默认30秒</span>
    <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>                      <span class="hljs-comment"># default weight for node</span>
    <span class="hljs-attr">timeout:</span>
      <span class="hljs-attr">connect:</span> <span class="hljs-number">2000</span>                  <span class="hljs-comment"># 连接 eureka 的超时时间，默认2000ms</span>
      <span class="hljs-attr">send:</span> <span class="hljs-number">2000</span>                     <span class="hljs-comment"># 向 eureka 发送数据的超时时间，默认2000ms</span>
      <span class="hljs-attr">read:</span> <span class="hljs-number">5000</span>                     <span class="hljs-comment"># 从 eureka 读数据的超时时间，默认5000ms</span>
</code></pre>
<p>通过 <code>discovery.eureka.host</code> 配置 eureka 的服务器地址。</p>
<p>如果 eureka 的地址是 <code>http://127.0.0.1:8761/</code> ，并且不需要用户名和密码验证的话，配置如下：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">discovery:</span>
  <span class="hljs-attr">eureka:</span>
    <span class="hljs-attr">host:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"http://127.0.0.1:8761"</span>
    <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/eureka/"</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="upstream-配置"></a><a href="#upstream-配置" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>upstream 配置</h2>
<p>APISIX是通过 <code>upstream.discovery_type</code>选择使用的服务发现， <code>upstream.service_name</code> 与注册中心的服务名进行关联。下面是将 URL 为 &quot;/user/*&quot; 的请求路由到注册中心名为 &quot;USER-SERVICE&quot; 的服务上例子：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "uri": "/user/*",
    "upstream": {
        "service_name": "USER-SERVICE",
        "type": "roundrobin",
        "discovery_type": "eureka"
    }
}'

HTTP/1.1 201 Created
Date: Sat, 31 Aug 2019 01:17:15 GMT
Content-Type: text/plain
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX web server

{"node":{"value":{"uri":"\/user\/*","upstream": {"service_name": "USER-SERVICE", "type": "roundrobin", "discovery_type": "eureka"}},"createdIndex":61925,"key":"\/apisix\/routes\/1","modifiedIndex":61925},"action":"create"}
</code></pre>
<p>因为上游的接口 URL 可能会有冲突，通常会在网关通过前缀来进行区分：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "uri": "/a/*",
    "plugins": {
        "proxy-rewrite" : {
            regex_uri: ["^/a/(.*)", "/${1}"]
        }
    }
    "upstream": {
        "service_name": "A-SERVICE",
        "type": "roundrobin",
        "discovery_type": "eureka"
    }
}'
<span class="hljs-meta">
$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/apisix/admin/routes/2 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PUT -i -d '</span></span>
{
    "uri": "/b/*",
    "plugins": {
        "proxy-rewrite" : {
            regex_uri: ["^/b/(.*)", "/${1}"]
        }
    }
    "upstream": {
        "service_name": "B-SERVICE",
        "type": "roundrobin",
        "discovery_type": "eureka"
    }
}'
</code></pre>
<p>假如 A-SERVICE 和 B-SERVICE 都提供了一个 <code>/test</code> 的接口，通过上面的配置，可以通过 <code>/a/test</code> 访问 A-SERVICE 的 <code>/test</code> 接口，通过 <code>/b/test</code> 访问 B-SERVICE 的 <code>/test</code> 接口。</p>
<p><strong>注意</strong>：配置 <code>upstream.service_name</code> 后 <code>upstream.nodes</code> 将不再生效，而是使用从注册中心的数据来替换，即使注册中心的数据是空的。</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#摘要">摘要</a></li><li><a href="#如何扩展注册中心？">如何扩展注册中心？</a><ul class="toc-headings"><li><a href="#基本步骤">基本步骤</a></li><li><a href="#以-eureka-举例">以 Eureka 举例</a></li></ul></li><li><a href="#注册中心配置">注册中心配置</a><ul class="toc-headings"><li><a href="#初始化服务发现">初始化服务发现</a></li><li><a href="#eureka-的配置">Eureka 的配置</a></li></ul></li><li><a href="#upstream-配置">upstream 配置</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>ASF</h5><a href="https://www.apache.org/">Foundation</a><a href="https://www.apache.org/licenses/">License</a><a href="https://www.apache.org/events/">Events</a><a href="https://www.apache.org/security/">Security</a><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></div><div><h5>Community</h5><a href="https://github.com/apache/apisix/issues">GitHub Issue Tracker</a><a href="https://apisix.slack.com/">Slack</a><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/users">User Showcase</a><a href="/blog">Blog</a></div></section><a href="https://www.apache.org/" target="_blank" rel="noreferrer noopener" style="display:block;margin:1em auto;opacity:0.8;transition:opacity 0.15s ease-in-out;text-align:center"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" style="width:370px;height:64px"/></a><section class="copyright">Copyright © 2019-2020 The Apache Software Foundation. Apache APISIX, APISIX™, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZHVP417Y1Y',
                apiKey: '79e72fedcf3719ba85c552f710ade8a3',
                indexName: 'apache-apisix-website',
                inputSelector: '#search_input_react'
              });
            </script></body></html>