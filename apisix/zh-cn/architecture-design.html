<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>apisix/zh-cn/architecture-design · Apache APISIX™</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;!--"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="apisix/zh-cn/architecture-design · Apache APISIX™"/><meta property="og:type" content="website"/><meta property="og:url" content="https://apisix.apache.org//"/><meta property="og:description" content="&lt;!--"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://apisix.apache.org/blog/atom.xml" title="Apache APISIX™ Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://apisix.apache.org/blog/feed.xml" title="Apache APISIX™ Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Apache APISIX™"/><h2 class="headerTitleWithLogo">Apache APISIX™</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/subscrbe-guide" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/downloads" target="_self">Downloads</a></li><li class=""><a href="/team" target="_self">Team</a></li><li class=""><a href="/help" target="_self">Help</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">apisix/zh-cn/architecture-design</h1></header><article><div><span><!--
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
-->
<h1><a class="anchor" aria-hidden="true" id="目录"></a><a href="#目录" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>目录</h1>
<ul>
<li><a href="#apisix"><strong>APISIX</strong></a></li>
<li><a href="#apisix-config"><strong>APISIX Config</strong></a></li>
<li><a href="#route"><strong>Route</strong></a></li>
<li><a href="#service"><strong>Service</strong></a></li>
<li><a href="#plugin"><strong>Plugin</strong></a></li>
<li><a href="#script"><strong>Script</strong></a></li>
<li><a href="#upstream"><strong>Upstream</strong></a></li>
<li><a href="#router"><strong>Router</strong></a></li>
<li><a href="#consumer"><strong>Consumer</strong></a></li>
<li><a href="#Global-Rule"><strong>Global Rule</strong></a></li>
<li><a href="#Debug-mode"><strong>Debug mode</strong></a></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="apisix"></a><a href="#apisix" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>APISIX</h2>
<h3><a class="anchor" aria-hidden="true" id="插件加载流程"></a><a href="#插件加载流程" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件加载流程</h3>
<p><img src="https://apisix.apache.org/images/flow-load-plugin.png" alt="插件加载流程"></p>
<h3><a class="anchor" aria-hidden="true" id="插件内部结构"></a><a href="#插件内部结构" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>插件内部结构</h3>
<p><img src="https://apisix.apache.org/images/flow-plugin-internal.png" width="50%" height="50%"></p>
<h2><a class="anchor" aria-hidden="true" id="apisix-config"></a><a href="#apisix-config" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>APISIX Config</h2>
<p>通过修改本地 <code>conf/config.yaml</code> 文件完成对 APISIX 服务本身的基本配置。</p>
<p>比如修改 APISIX 默认监听端口为 8000，其他配置保持默认，在 <code>conf/config.yaml</code> 中只需这样配置：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">apisix:</span>
  <span class="hljs-attr">node_listen:</span> <span class="hljs-number">8000</span>             <span class="hljs-comment"># APISIX listening port</span>
</code></pre>
<p>比如指定 APISIX 默认监听端口为 8000，并且设置 etcd 地址为 <code>http://foo:2379</code>，
其他配置保持默认。在 <code>conf/config.yaml</code> 中只需这样配置：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">apisix:</span>
  <span class="hljs-attr">node_listen:</span> <span class="hljs-number">8000</span>             <span class="hljs-comment"># APISIX listening port</span>

<span class="hljs-attr">etcd:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"http://foo:2379"</span>       <span class="hljs-comment"># etcd address</span>
</code></pre>
<p>其他默认配置，可以在 <code>conf/config-default.yaml</code> 文件中看到，该文件是与 APISIX 源码强绑定，
<strong>永远不要</strong>手工修改 <code>conf/config-default.yaml</code> 文件。如果需要自定义任何配置，都应在 <code>conf/config.yaml</code> 文件中完成。</p>
<p><em>注意</em> 不要手工修改 APISIX 自身的 <code>conf/nginx.conf</code> 文件，当服务每次启动时，<code>apisix</code>
会根据 <code>conf/config.yaml</code> 配置自动生成新的 <code>conf/nginx.conf</code> 并自动启动服务。</p>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="route"></a><a href="#route" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Route</h2>
<p>Route 字面意思就是路由，通过定义一些规则来匹配客户端的请求，然后根据匹配结果加载并执行相应的
插件，并把请求转发给到指定 Upstream。</p>
<p>Route 中主要包含三部分内容：匹配规则(比如 uri、host、remote_addr 等)，插件配置(限流限速等)和上游信息。
请看下图示例，是一些 Route 规则的实例，当某些属性值相同时，图中用相同颜色标识。</p>
<p><img src="https://apisix.apache.org/images/routes-example.png" width="50%" height="50%"></p>
<p>我们直接在 Route 中完成所有参数的配置，优点是容易设置，每个 Route 都相对独立自由度比较高。但当我们的 Route 有比较多的重复配置（比如启用相同的插件配置或上游信息），一旦我们要更新这些相同属性时，就需要遍历所有 Route 并进行修改，给后期管理维护增加不少复杂度。</p>
<p>上面提及重复的缺点在 APISIX 中独立抽象了 <a href="#service">Service</a> 和 <a href="#upstream">Upstream</a> 两个概念来解决。</p>
<p>下面创建的 Route 示例，是把 URL 为 &quot;/index.html&quot; 的请求代理到地址为 &quot;39.97.63.215:80&quot; 的 Upstream 服务：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9180/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -i -d <span class="hljs-string">'</span></span>
{
    "uri": "/index.html",
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'

HTTP/1.1 201 Created
Date: Sat, 31 Aug 2019 01:17:15 GMT
Content-Type: text/plain
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX web server

{"node":{"value":{"uri":"\/index.html","upstream":{"nodes":{"39.97.63.215:80":1},"type":"roundrobin"}},"createdIndex":61925,"key":"\/apisix\/routes\/1","modifiedIndex":61925},"action":"create"}
</code></pre>
<p>当我们接收到成功应答，表示该 Route 已成功创建。</p>
<p>有关 Route 的具体选项，可具体查阅 <a href="/apisix/zh-cn/admin-api#route">Admin API 之 Route</a>。</p>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="service"></a><a href="#service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Service</h2>
<p><code>Service</code> 是某类 API 的抽象（也可以理解为一组 Route 的抽象）。它通常与上游服务抽象是一一对应的，<code>Route</code>
与 <code>Service</code> 之间，通常是 N:1 的关系，参看下图。</p>
<p><img src="https://apisix.apache.org/images/service-example.png" width="50%" height="50%"></p>
<p>不同 Route 规则同时绑定到一个 Service 上，这些 Route 将具有相同的上游和插件配置，减少冗余配置。</p>
<p>比如下面的例子，创建了一个启用限流插件的 Service，然后把 id 为 <code>100</code>、<code>101</code> 的 Route 都绑定在这个 Service 上。</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> create new Service</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9180/apisix/admin/services/200 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -d <span class="hljs-string">'</span></span>
{
    "plugins": {
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    },
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> create new Route and reference the service by id `200`</span></span>
curl http://127.0.0.1:9180/apisix/admin/routes/100 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "methods": ["GET"],
    "uri": "/index.html",
    "service_id": "200"
}'

curl http://127.0.0.1:9180/apisix/admin/routes/101 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "methods": ["GET"],
    "uri": "/foo/index.html",
    "service_id": "200"
}'
</code></pre>
<p>当然我们也可以为 Route 指定不同的插件参数或上游，比如下面这个 Route 设置了不同的限流参数，其他部分（比如上游）则继续使用 Service 中的配置参数。</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/102 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/bar/index.html",
    "id": "102",
    "service_id": "200",
    "plugins": {
        "limit-count": {
            "count": 2000,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    }
}'
</code></pre>
<p>注意：当 Route 和 Service 都开启同一个插件时，Route 参数的优先级是高于 Service 的。</p>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="plugin"></a><a href="#plugin" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Plugin</h2>
<p><code>Plugin</code> 表示将在 <code>HTTP</code> 请求/响应生命周期期间执行的插件配置。</p>
<p><code>Plugin</code> 配置可直接绑定在 <code>Route</code> 上，也可以被绑定在 <code>Service</code> 或 <code>Consumer</code>上。而对于同一
个插件的配置，只能有一份是有效的，配置选择优先级总是 <code>Consumer</code> &gt; <code>Route</code> &gt; <code>Service</code>。</p>
<p>在 <code>conf/config.yaml</code> 中，可以声明本地 APISIX 节点都支持哪些插件。这是个白名单机制，不在该
白名单的插件配置，都将会被自动忽略。这个特性可用于临时关闭或打开特定插件，应对突发情况非常有效。
如果你想在现有插件的基础上新增插件，注意需要拷贝 <code>conf/config-default.yaml</code> 的插件节点内容到 <code>conf/config.yaml</code> 的插件节点中。</p>
<p>插件的配置可以被直接绑定在指定 Route 中，也可以被绑定在 Service 中，不过 Route 中的插件配置
优先级更高。</p>
<p>一个插件在一次请求中只会执行一次，即使被同时绑定到多个不同对象中（比如 Route 或 Service）。
插件运行先后顺序是根据插件自身的优先级来决定的，例如：</p>
<pre><code class="hljs css language-lua"><span class="hljs-keyword">local</span> _M = {
    version = <span class="hljs-number">0.1</span>,
    priority = <span class="hljs-number">0</span>, <span class="hljs-comment">-- 这个插件的优先级为 0</span>
    name = plugin_name,
    schema = schema,
    metadata_schema = metadata_schema,
}
</code></pre>
<p>插件配置作为 Route 或 Service 的一部分提交的，放到 <code>plugins</code> 下。它内部是使用插件
名字作为哈希的 key 来保存不同插件的配置项。</p>
<pre><code class="hljs css language-json">{
    ...
    "plugins": {
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        },
        "prometheus": {}
    }
}
</code></pre>
<p>并不是所有插件都有具体配置项，比如 <code>prometheus</code> 下是没有任何具体配置项，这时候用一个空的对象
标识即可。</p>
<p><a href="/apisix/zh-cn/plugins">查看 APISIX 已支持插件列表</a></p>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="script"></a><a href="#script" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Script</h2>
<p><code>Script</code> 表示将在 <code>HTTP</code> 请求/响应生命周期期间执行的脚本。</p>
<p><code>Script</code> 配置可直接绑定在 <code>Route</code> 上。</p>
<p><code>Script</code> 与 <code>Plugin</code> 互斥，且优先执行 <code>Script</code> ，这意味着配置 <code>Script</code> 后，<code>Route</code> 上配置的 <code>Plugin</code> 将不被执行。</p>
<p>理论上，在 <code>Script</code> 中可以写任意 lua 代码，也可以直接调用已有插件以重用已有的代码。</p>
<p><code>Script</code> 也有执行阶段概念，支持 <code>access</code>、<code>header_filer</code>、<code>body_filter</code> 和 <code>log</code> 阶段。系统会在相应阶段中自动执行 <code>Script</code> 脚本中对应阶段的代码。</p>
<pre><code class="hljs css language-json">{
    ...
    "script": "local _M = {} \n function _M.access(api_ctx) \n ngx.log(ngx.INFO,\"hit access phase\") \n end \nreturn _M"
}
</code></pre>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="upstream"></a><a href="#upstream" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upstream</h2>
<p>Upstream 是虚拟主机抽象，对给定的多个服务节点按照配置规则进行负载均衡。Upstream 的地址信息可以直接配置到 <code>Route</code>（或 <code>Service</code>) 上，当 Upstream 有重复时，就需要用“引用”方式避免重复了。</p>
<p><img src="https://apisix.apache.org/images/upstream-example.png" width="50%" height="50%"></p>
<p>如上图所示，通过创建 Upstream 对象，在 <code>Route</code> 用 ID 方式引用，就可以确保只维护一个对象的值了。</p>
<p>Upstream 的配置可以被直接绑定在指定 <code>Route</code> 中，也可以被绑定在 <code>Service</code> 中，不过 <code>Route</code> 中的配置
优先级更高。这里的优先级行为与 <code>Plugin</code> 非常相似</p>
<h3><a class="anchor" aria-hidden="true" id="配置参数"></a><a href="#配置参数" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>配置参数</h3>
<p>APISIX 的 Upstream 除了基本的复杂均衡算法选择外，还支持对上游做主被动健康检查、重试等逻辑，具体看下面表格。</p>
<table>
<thead>
<tr><th>名字</th><th>可选</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>type</td><td>必填</td><td><code>roundrobin</code> 支持权重的负载，<code>chash</code> 一致性哈希，两者是二选一的</td></tr>
<tr><td>nodes</td><td>与 <code>k8s_deployment_info</code>、 <code>service_name</code> 三选一</td><td>哈希表，内部元素的 key 是上游机器地址列表，格式为<code>地址 + Port</code>，其中地址部分可以是 IP 也可以是域名，比如 <code>192.168.1.100:80</code>、<code>foo.com:80</code> 等。value 则是节点的权重。当权重值为 <code>0</code> 代表该上游节点失效，不会被选中，可以用于暂时摘除节点的情况。</td></tr>
<tr><td>service_name</td><td>与 <code>nodes</code>、 <code>k8s_deployment_info</code> 三选一</td><td>用于设置上游服务名，并配合注册中心使用，详细可参考<a href="/apisix/zh-cn/discovery">集成服务发现注册中心</a></td></tr>
<tr><td>k8s_deployment_info</td><td>与 <code>nodes</code>、 <code>service_name</code> 三选一</td><td>哈希表</td><td>字段包括 <code>namespace</code>、<code>deploy_name</code>、<code>service_name</code>、<code>port</code>、<code>backend_type</code>，其中 <code>port</code> 字段为数值，<code>backend_type</code> 为 <code>pod</code> 或 <code>service</code>，其他为字符串</td></tr>
<tr><td>key</td><td>可选</td><td>在 <code>type</code> 等于 <code>chash</code> 是必选项。 <code>key</code> 需要配合 <code>hash_on</code> 来使用，通过 <code>hash_on</code> 和 <code>key</code> 来查找对应的 node <code>id</code></td></tr>
<tr><td>hash_on</td><td>可选</td><td><code>hash_on</code> 支持的类型有 <code>vars</code>（Nginx内置变量），<code>header</code>（自定义header），<code>cookie</code>，<code>consumer</code>，默认值为 <code>vars</code></td></tr>
<tr><td>checks</td><td>可选</td><td>配置健康检查的参数，详细可参考<a href="/apisix/health-check">health-check</a></td></tr>
<tr><td>retries</td><td>可选</td><td>使用底层的 Nginx 重试机制将请求传递给下一个上游，默认 APISIX 会启用重试机制，根据配置的后端节点个数设置重试次数，如果此参数显式被设置将会覆盖系统默认设置的重试次数。</td></tr>
<tr><td>labels</td><td>可选</td><td>用于标识属性的键值对。</td></tr>
<tr><td>pass_host</td><td>可选</td><td><code>pass</code> 透传客户端请求的 host, <code>node</code> 不透传客户端请求的 host, 使用 upstream node 配置的 host, <code>rewrite</code> 使用 <code>upstream_host</code> 配置的值重写 host 。</td></tr>
<tr><td>upstream_host</td><td>可选</td><td>只在 <code>pass_host</code> 配置为 <code>rewrite</code> 时有效。</td></tr>
</tbody>
</table>
<p><code>hash_on</code> 比较复杂，这里专门说明下：</p>
<ol>
<li>设为 <code>vars</code> 时，<code>key</code> 为必传参数，目前支持的 Nginx 内置变量有 <code>uri, server_name, server_addr, request_uri, remote_port, remote_addr, query_string, host, hostname, arg_***</code>，其中 <code>arg_***</code> 是来自URL的请求参数，<a href="http://nginx.org/en/docs/varindex.html">Nginx 变量列表</a></li>
<li>设为 <code>header</code> 时, <code>key</code> 为必传参数，其值为自定义的 header name, 即 &quot;http_<code>key</code>&quot;</li>
<li>设为 <code>cookie</code> 时, <code>key</code> 为必传参数，其值为自定义的 cookie name，即 &quot;cookie_<code>key</code>&quot;</li>
<li>设为 <code>consumer</code> 时，<code>key</code> 不需要设置。此时哈希算法采用的 <code>key</code> 为认证通过的 <code>consumer_name</code>。</li>
<li>如果指定的 <code>hash_on</code> 和 <code>key</code> 获取不到值时，就是用默认值：<code>remote_addr</code>。</li>
</ol>
<p>创建上游对象用例：</p>
<pre><code class="hljs css language-json">curl http://127.0.0.1:9180/apisix/admin/upstreams/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "type": "roundrobin",
    "k8s_deployment_info": {
        "namespace": "test-namespace",
        "deploy_name": "test-deploy-name",
        "service_name": "test-service-name",
        "backend_type": "pod",
        "port": 8080
    }
}'

curl http://127.0.0.1:9180/apisix/admin/upstreams/2 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "type": "chash",
    "key": "remote_addr",
    "nodes": {
        "127.0.0.1:80": 1,
        "foo.com:80": 2
    }
}'
</code></pre>
<p>上游对象创建后，均可以被具体 <code>Route</code> 或 <code>Service</code> 引用，例如：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "upstream_id": 2
}'
</code></pre>
<p>为了方便使用，也可以直接把上游地址直接绑到某个 <code>Route</code> 或 <code>Service</code> ，例如：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    },
    "upstream": {
        "type": "roundrobin",
        "nodes": {
            "39.97.63.215:80": 1
        }
    }
}'
</code></pre>
<p>下面是一个配置了健康检查的示例：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/index.html",
    "plugins": {
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    },
    "upstream": {
         "nodes": {
            "39.97.63.215:80": 1
        }
        "type": "roundrobin",
        "retries": 2,
        "checks": {
            "active": {
                "http_path": "/status",
                "host": "foo.com",
                "healthy": {
                    "interval": 2,
                    "successes": 1
                },
                "unhealthy": {
                    "interval": 1,
                    "http_failures": 2
                }
            }
        }
    }
}'
</code></pre>
<p>更多细节可以参考<a href="/apisix/health-check">健康检查的文档</a>。</p>
<p>下面是几个使用不同<code>hash_on</code>类型的配置示例：</p>
<h4><a class="anchor" aria-hidden="true" id="consumer"></a><a href="#consumer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Consumer</h4>
<p>创建一个consumer对象:</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "username": "jack",
    "plugins": {
    "key-auth": {
           "key": "auth-jack"
        }
    }
}'
</code></pre>
<p>新建路由，打开<code>key-auth</code>插件认证，<code>upstream</code>的<code>hash_on</code>类型为<code>consumer</code>：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "plugins": {
        "key-auth": {}
    },
    "upstream": {
        "nodes": {
            "127.0.0.1:1980": 1,
            "127.0.0.1:1981": 1
        },
        "type": "chash",
        "hash_on": "consumer"
    },
    "uri": "/server_port"
}'
</code></pre>
<p>测试请求，认证通过后的<code>consumer_name</code>将作为负载均衡哈希算法的哈希值：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9080/server_port -H "apikey: auth-jack"
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="cookie"></a><a href="#cookie" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cookie</h5>
<p>新建路由和<code>Upstream</code>，<code>hash_on</code>类型为<code>cookie</code>：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/hash_on_cookie",
    "upstream": {
        "key": "sid",
        "type ": "chash",
        "hash_on ": "cookie",
        "nodes ": {
            "127.0.0.1:1980": 1,
            "127.0.0.1:1981": 1
        }
    }
}'
</code></pre>
<p>客户端请求携带<code>Cookie</code>：</p>
<pre><code class="hljs css language-shell"> curl http://127.0.0.1:9080/hash_on_cookie -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -H "Cookie: sid=3c183a30cffcda1408daf1c61d47b274"
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="header"></a><a href="#header" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Header</h5>
<p>新建路由和<code>Upstream</code>，<code>hash_on</code>类型为<code>header</code>， <code>key</code>为<code>content-type</code>：</p>
<pre><code class="hljs css language-shell">curl http://127.0.0.1:9180/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    "uri": "/hash_on_header",
    "upstream": {
        "key": "content-type",
        "type ": "chash",
        "hash_on ": "header",
        "nodes ": {
            "127.0.0.1:1980": 1,
            "127.0.0.1:1981": 1
        }
    }
}'
</code></pre>
<p>客户端请求携带<code>content-type</code>的<code>header</code>：</p>
<pre><code class="hljs css language-shell"> curl http://127.0.0.1:9080/hash_on_header -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -H "Content-Type: application/json"
</code></pre>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="router"></a><a href="#router" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Router</h2>
<p>APISIX 区别于其他 API 网关的一大特点是允许用户选择不同 Router 来更好匹配自由业务，在性能、自由之间做最适合选择。</p>
<p>在本地配置 <code>conf/config.yaml</code> 中设置最符合自身业务需求的路由。</p>
<ul>
<li><p><code>apisix.router.http</code>: HTTP 请求路由。</p>
<ul>
<li><code>radixtree_uri</code>: （默认）只使用 <code>uri</code> 作为主索引。基于 <code>radixtree</code> 引擎，支持全量和深前缀匹配，更多见 <a href="/apisix/router-radixtree">如何使用 router-radixtree</a>。
<ul>
<li><code>绝对匹配</code>：完整匹配给定的 <code>uri</code> ，比如 <code>/foo/bar</code>，<code>/foo/glo</code>。</li>
<li><code>前缀匹配</code>：末尾使用 <code>*</code> 代表给定的 <code>uri</code> 是前缀匹配。比如 <code>/foo*</code>，则允许匹配 <code>/foo/</code>、<code>/foo/a</code>和<code>/foo/b</code>等。</li>
<li><code>匹配优先级</code>：优先尝试绝对匹配，若无法命中绝对匹配，再尝试前缀匹配。</li>
<li><code>任意过滤属性</code>：允许指定任何 Nginx 内置变量作为过滤条件，比如 URL 请求参数、请求头、cookie 等。</li>
</ul></li>
<li><code>radixtree_host_uri</code>: 使用 <code>host + uri</code> 作为主索引（基于 <code>radixtree</code> 引擎），对当前请求会同时匹配 host 和 uri，支持的匹配条件与 <code>radixtree_uri</code> 基本一致。</li>
</ul></li>
<li><p><code>apisix.router.ssl</code>: SSL 加载匹配路由。</p>
<ul>
<li><code>radixtree_sni</code>: （默认）使用 <code>SNI</code> (Server Name Indication) 作为主索引（基于 radixtree 引擎）。</li>
</ul></li>
</ul>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="consumer-1"></a><a href="#consumer-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Consumer</h2>
<p>对于 API 网关通常可以用请求域名、客户端 IP 地址等字段识别到某类请求方，
然后进行插件过滤并转发请求到指定上游，但有时候这个深度不够。</p>
<p><img src="https://apisix.apache.org/images/consumer-who.png" width="50%" height="50%"></p>
<p>如上图所示，作为 API 网关，需要知道 API Consumer（消费方）具体是谁，这样就可以对不同 API Consumer 配置不同规则。</p>
<table>
<thead>
<tr><th>字段</th><th>必选</th><th>说明</th></tr>
</thead>
<tbody>
<tr><td>username</td><td>是</td><td>Consumer 名称。</td></tr>
<tr><td>plugins</td><td>否</td><td>该 Consumer 对应的插件配置，它的优先级是最高的：Consumer &gt; Route &gt; Service。对于具体插件配置，可以参考 <a href="#plugin">Plugins</a> 章节。</td></tr>
</tbody>
</table>
<p>在 APISIX 中，识别 Consumer 的过程如下图：</p>
<p><img src="https://apisix.apache.org/images/consumer-internal.png" width="50%" height="50%"></p>
<ol>
<li>授权认证：比如有 <a href="/apisix/plugins/key-auth">key-auth</a>、<a href="/apisix/zh-cn/plugins/jwt-auth">JWT</a> 等。</li>
<li>获取 consumer_name：通过授权认证，即可自然获取到对应的 Consumer name，它是 Consumer 对象的唯一识别标识。</li>
<li>获取 Consumer 上绑定的 Plugin 或 Upstream 信息：完成对不同 Consumer 做不同配置的效果。</li>
</ol>
<p>概括一下，Consumer 是某类服务的消费者，需与用户认证体系配合才能使用。
比如不同的 Consumer 请求同一个 API，网关服务根据当前请求用户信息，对应不同的 Plugin 或 Upstream 配置。</p>
<p>此外，大家也可以参考 <a href="/apisix/plugins/key-auth">key-auth</a> 认证授权插件的调用逻辑，辅助大家来进一步理解 Consumer 概念和使用。</p>
<p>如何对某个 Consumer 开启指定插件，可以看下面例子：</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建 Consumer ，指定认证插件 key-auth ，并开启特定插件 <span class="hljs-built_in">limit</span>-count</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9180/apisix/admin/consumers -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -d <span class="hljs-string">'</span></span>
{
    "username": "jack",
    "plugins": {
        "key-auth": {
            "key": "auth-one"
        },
        "limit-count": {
            "count": 2,
            "time_window": 60,
            "rejected_code": 503,
            "key": "remote_addr"
        }
    }
}'
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> 创建 Router，设置路由规则和启用插件配置</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9180/apisix/admin/routes/1 -H '</span>X-API-KEY: edd1c9f034335f136f87ad84b625c8f1<span class="hljs-string">' -X PUT -d '</span></span>
{
    "plugins": {
        "key-auth": {}
    },
    "upstream": {
        "nodes": {
            "127.0.0.1:1980": 1
        },
        "type": "roundrobin"
    },
    "uri": "/hello"
}'
<span class="hljs-meta">
#</span><span class="bash"> 发测试请求，前两次返回正常，没达到限速阈值</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/hello -H <span class="hljs-string">'apikey: auth-one'</span> -I</span>
...
<span class="hljs-meta">
$</span><span class="bash"> curl http://127.0.0.1:9080/hello -H <span class="hljs-string">'apikey: auth-one'</span> -I</span>
...
<span class="hljs-meta">
#</span><span class="bash"> 第三次测试返回 503，请求被限制</span>
<span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:9080/hello -H <span class="hljs-string">'apikey: auth-one'</span> -I</span>
HTTP/1.1 503 Service Temporarily Unavailable
...

</code></pre>
<p>结合 <a href="/apisix/zh-cn/plugins/consumer-restriction">consumer-restriction</a> 插件，限制jack对该 route 的访问</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">#</span><span class="bash"> 设置黑名单，禁止jack访问该API</span>
<span class="hljs-meta">
$</span><span class="bash"> curl http://127.0.0.1:9180/apisix/admin/routes/1 -H <span class="hljs-string">'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</span> -X PUT -d <span class="hljs-string">'</span></span>
{
    "plugins": {
        "key-auth": {},
        "consumer-restriction": {
            "blacklist": [
                "jack"
            ]
        }
    },
    "upstream": {
        "nodes": {
            "127.0.0.1:1980": 1
        },
        "type": "roundrobin"
    },
    "uri": "/hello"
}'
<span class="hljs-meta">
#</span><span class="bash"><span class="hljs-string"> 反复测试，均返回 403，jack被禁止访问</span></span>
<span class="hljs-meta">$</span><span class="bash"><span class="hljs-string"> curl http://127.0.0.1:9080/hello -H '</span>apikey: auth-one<span class="hljs-string">' -I</span></span>
HTTP/1.1 403
...

</code></pre>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="global-rule"></a><a href="#global-rule" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Global Rule</h2>
<p><a href="#Plugin">Plugin</a> 只能绑定在 <a href="#Service">Service</a> 或者 <a href="#Route">Route</a> 上，如果我们需要一个能作用于所有请求的 <a href="#Plugin">Plugin</a> 该怎么办呢？
这时候我们可以使用 <code>GlobalRule</code> 来注册一个全局的 <a href="#Plugin">Plugin</a>:</p>
<pre><code class="hljs css language-shell">curl -X PUT \
  https://{apisix_listen_address}/apisix/admin/global_rules/1 \
  -H 'Content-Type: application/json' \
  -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' \
  -d '{
        "plugins": {
            "limit-count": {
                "time_window": 60,
                "policy": "local",
                "count": 2,
                "key": "remote_addr",
                "rejected_code": 503
            }
        }
    }'
</code></pre>
<p>如上所注册的 <code>limit-count</code> 插件将会作用于所有的请求。</p>
<p>我们可以通过以下接口查看所有的 <code>GlobalRule</code>:</p>
<pre><code class="hljs css language-shell">curl https://{apisix_listen_address}/apisix/admin/global_rules -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'
</code></pre>
<p><a href="#目录">返回目录</a></p>
<h2><a class="anchor" aria-hidden="true" id="debug-mode"></a><a href="#debug-mode" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Debug mode</h2>
<h3><a class="anchor" aria-hidden="true" id="基本调试模式"></a><a href="#基本调试模式" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>基本调试模式</h3>
<p>设置 <code>conf/config.yaml</code> 中的 <code>apisix.enable_debug</code> 为 <code>true</code>，即可开启基本调试模式。</p>
<p>比如对 <code>/hello</code> 开启了 <code>limit-conn</code>和<code>limit-count</code>插件，这时候应答头中会有 <code>Apisix-Plugins: limit-conn, limit-count</code>。</p>
<pre><code class="hljs css language-shell"><span class="hljs-meta">$</span><span class="bash"> curl http://127.0.0.1:1984/hello -i</span>
HTTP/1.1 200 OK
Content-Type: text/plain
Transfer-Encoding: chunked
Connection: keep-alive
Apisix-Plugins: limit-conn, limit-count
X-RateLimit-Limit: 2
X-RateLimit-Remaining: 1
Server: openresty

hello world
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="高级调试模式"></a><a href="#高级调试模式" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>高级调试模式</h3>
<p>设置 <code>conf/debug.yaml</code> 中的选项，开启高级调试模式。由于 APISIX 服务启动后是每秒定期检查该文件，
当可以正常读取到 <code>#END</code> 结尾时，才认为文件处于写完关闭状态。</p>
<p>根据文件最后修改时间判断文件内容是否有变化，如有变化则重新加载，如没变化则跳过本次检查。
所以高级调试模式的开启、关闭都是热更新方式完成。</p>
<table>
<thead>
<tr><th>名字</th><th>可选项</th><th>说明</th><th>默认值</th></tr>
</thead>
<tbody>
<tr><td>hook_conf.enable</td><td>必选项</td><td>是否开启 hook 追踪调试。开启后将打印指定模块方法的请求参数或返回值</td><td>false</td></tr>
<tr><td>hook_conf.name</td><td>必选项</td><td>开启 hook 追踪调试的模块列表名称</td><td></td></tr>
<tr><td>hook_conf.log_level</td><td>必选项</td><td>打印请求参数和返回值的日志级别</td><td>warn</td></tr>
<tr><td>hook_conf.is_print_input_args</td><td>必选项</td><td>是否打印输入参数</td><td>true</td></tr>
<tr><td>hook_conf.is_print_return_value</td><td>必选项</td><td>是否打印返回值</td><td>true</td></tr>
</tbody>
</table>
<p>请看下面示例：</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">hook_conf:</span>
  <span class="hljs-attr">enable:</span> <span class="hljs-literal">false</span>                 <span class="hljs-comment"># 是否开启 hook 追踪调试</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">hook_phase</span>              <span class="hljs-comment"># 开启 hook 追踪调试的模块列表名称</span>
  <span class="hljs-attr">log_level:</span> <span class="hljs-string">warn</span>               <span class="hljs-comment"># 日志级别</span>
  <span class="hljs-attr">is_print_input_args:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment"># 是否打印输入参数</span>
  <span class="hljs-attr">is_print_return_value:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment"># 是否打印返回值</span>

<span class="hljs-attr">hook_phase:</span>                     <span class="hljs-comment"># 模块函数列表，名字：hook_phase</span>
  <span class="hljs-attr">apisix:</span>                       <span class="hljs-comment"># 引用的模块名称</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">http_access_phase</span>         <span class="hljs-comment"># 函数名：数组</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">http_header_filter_phase</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">http_body_filter_phase</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">http_log_phase</span>

<span class="hljs-comment">#END</span>
</code></pre>
<p><a href="#目录">返回目录</a></p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#apisix">APISIX</a><ul class="toc-headings"><li><a href="#插件加载流程">插件加载流程</a></li><li><a href="#插件内部结构">插件内部结构</a></li></ul></li><li><a href="#apisix-config">APISIX Config</a></li><li><a href="#route">Route</a></li><li><a href="#service">Service</a></li><li><a href="#plugin">Plugin</a></li><li><a href="#script">Script</a></li><li><a href="#upstream">Upstream</a><ul class="toc-headings"><li><a href="#配置参数">配置参数</a></li></ul></li><li><a href="#router">Router</a></li><li><a href="#consumer-1">Consumer</a></li><li><a href="#global-rule">Global Rule</a></li><li><a href="#debug-mode">Debug mode</a><ul class="toc-headings"><li><a href="#基本调试模式">基本调试模式</a></li><li><a href="#高级调试模式">高级调试模式</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>ASF</h5><a href="https://www.apache.org/">Foundation</a><a href="https://www.apache.org/licenses/">License</a><a href="http://www.apache.org/events/current-event/">Events</a><a href="https://www.apache.org/security/">Security</a><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></div><div><h5>Community</h5><a href="https://github.com/apache/apisix/issues">GitHub Issue Tracker</a><a href="https://apisix.slack.com/">Slack</a><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/users">User Showcase</a><a href="/blog">Blog</a></div></section><a href="https://www.apache.org/" target="_blank" rel="noreferrer noopener" style="display:block;margin:1em auto;opacity:0.8;transition:opacity 0.15s ease-in-out;text-align:center"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" style="width:370px;height:64px"/></a><section class="copyright">Copyright © 2019-2020 The Apache Software Foundation. Apache APISIX, APISIX™, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZHVP417Y1Y',
                apiKey: '79e72fedcf3719ba85c552f710ade8a3',
                indexName: 'apache-apisix-website',
                inputSelector: '#search_input_react'
              });
            </script></body></html>