"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[52896],{35318:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>c});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=p(n),c=i,h=m["".concat(l,".").concat(c)]||m[c]||g[c]||r;return n?a.createElement(h,s(s({ref:t},u),{},{components:n})):a.createElement(h,s({ref:t},u))}));function c(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:i,s[1]=o;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},64314:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(25773),i=(n(27378),n(35318));const r={title:'A "Tiny" APISIX Plugin',authors:[{name:"Navendu Pottekkat",title:"Author",url:"https://github.com/navendu-pottekkat",image_url:"https://avatars.githubusercontent.com/u/49474499"}],keywords:["Wasm","Go","Plugin"],description:'A "tiny" example to demonstrate how Apache APISIX supports Wasm plugins.',tags:["Plugins"],image:"https://static.apiseven.com/uploads/2023/06/27/Z8CkI8kj_wasm-cover.png"},s=void 0,o={permalink:"/blog/2023/07/07/tiny-apisix-plugin",source:"@site/blog/2023/07/07/tiny-apisix-plugin.md",title:'A "Tiny" APISIX Plugin',description:'A "tiny" example to demonstrate how Apache APISIX supports Wasm plugins.',date:"2023-07-07T00:00:00.000Z",formattedDate:"July 7, 2023",tags:[{label:"Plugins",permalink:"/blog/tags/plugins"}],readingTime:5.095,truncated:!0,authors:[{name:"Navendu Pottekkat",title:"Author",url:"https://github.com/navendu-pottekkat",image_url:"https://avatars.githubusercontent.com/u/49474499",imageURL:"https://avatars.githubusercontent.com/u/49474499"}],prevItem:{title:"How to Use Vault to Manage Certificates in APISIX",permalink:"/blog/2023/07/09/apisix-integrates-with-vault"},nextItem:{title:"Biweekly Report (June 19 - July 02)",permalink:"/blog/2023/07/05/weekly-report"}},l={authorsImageUrls:[void 0]},p=[{value:"APISIX and Wasm",id:"apisix-and-wasm",children:[],level:2},{value:"A &quot;Tiny&quot; Go Plugin",id:"a-tiny-go-plugin",children:[],level:2},{value:"Configuring APISIX to Run the Plugin",id:"configuring-apisix-to-run-the-plugin",children:[],level:2},{value:"Testing the Plugin",id:"testing-the-plugin",children:[],level:2},{value:"Wasm for the Win?",id:"wasm-for-the-win",children:[],level:2}],u={toc:p};function g(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},'In this article, we will write a "tiny" Go plugin for APISIX, compile it to a Wasm binary, run it in APISIX, and learn how it all works. We will also compare the benefits and costs of using Wasm plugins, external plugins (plugin runners), and native Lua plugins.')),(0,i.kt)("head",null,(0,i.kt)("link",{rel:"canonical",href:"https://navendu.me/posts/tiny-apisix-plugin/"})),(0,i.kt)("p",null,"A key feature of Apache APISIX is its pluggable architecture. In addition to providing ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/plugins/"},"80+ Lua plugins")," out of the box, APISIX also supports external plugins written in other languages through ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/go-plugin-runner/getting-started/"},"plugin runners")," and ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/wasm/"},"WebAssembly (Wasm)"),"."),(0,i.kt)("p",null,'In this article, we will write a "tiny" Go plugin for APISIX, compile it to a Wasm binary, run it in APISIX, and learn how it all works. We will also compare the benefits and costs of using Wasm plugins, external plugins (plugin runners), and native Lua plugins.'),(0,i.kt)("h2",{id:"apisix-and-wasm"},"APISIX and Wasm"),(0,i.kt)("p",null,"APISIX supports Wasm through the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/proxy-wasm/spec"},"WebAssembly for Proxies (proxy-wasm) specification"),". APISIX is a host environment that implements the specification, and developers can use the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/proxy-wasm/spec#sdks"},"SDKs")," available in multiple languages to create plugins."),(0,i.kt)("p",null,"Using Wasm plugins in APISIX has multiple advantages:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Many programming languages compile to Wasm. This allows you to leverage the capabilities of your tech stack in APISIX plugins."),(0,i.kt)("li",{parentName:"ul"},"The plugins run inside APISIX and not on external plugin runners. This means you compromise less on performance while writing external plugins."),(0,i.kt)("li",{parentName:"ul"},"Wasm plugins run inside APISIX but in a separate VM. So even if the plugin crashes, APISIX can continue to run."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("em",{parentName:"li"},"APISIX can only maintain its Wasm support without having to maintain plugin runners for multiple languages","*","."))),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"*"," These advantages come with a set of caveats which we will look at later.")),(0,i.kt)("p",null,"APISIX's plugin architecture below shows native Lua plugins, external plugins through plugin runners, and Wasm plugins:"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/06/27/yBnZnCrv_plugin-route-light.png",alt:"Lua plugins, plugin runners, and Wasm plugins"})),(0,i.kt)("h2",{id:"a-tiny-go-plugin"},'A "Tiny" Go Plugin'),(0,i.kt)("p",null,"Let's get coding! To write a Go plugin, we will use the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/tetratelabs/proxy-wasm-go-sdk"},"proxy-wasm-go-sdk"),"."),(0,i.kt)("p",null,'Reading through the documentation, you will understand why this plugin is called "tiny," i.e., the SDK uses the ',(0,i.kt)("a",{parentName:"p",href:"https://tinygo.org/"},"TinyGo")," compiler instead of the official Go compiler. You can read more about why this is the case on the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/tetratelabs/proxy-wasm-go-sdk/blob/main/doc/OVERVIEW.md"},"SDK\\'s overview page"),", but the TLDR version is that the Go compiler can only produce Wasm binaries that run in the browser."),(0,i.kt)("p",null,"For our example, we will create a plugin that adds a response header. The code below is pretty self-explanatory, and you can refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/t/wasm/"},"other plugins")," for more implementation details:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go",metastring:'title="main.go"',title:'"main.go"'},'// references:\n// https://github.com/tetratelabs/proxy-wasm-go-sdk/tree/main/examples\n// https://github.com/apache/apisix/blob/master/t/wasm/\npackage main\n\nimport (\n    "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm"\n    "github.com/tetratelabs/proxy-wasm-go-sdk/proxywasm/types"\n\n    "github.com/valyala/fastjson"\n)\n\nfunc main() {\n    proxywasm.SetVMContext(&vmContext{})\n}\n\n// each plugin has its own VMContext.\n// it is responsible for creating multiple PluginContexts for each route.\ntype vmContext struct {\n    types.DefaultVMContext\n}\n\n// each route has its own PluginContext.\n// it corresponds to one instance of the plugin.\nfunc (*vmContext) NewPluginContext(contextID uint32) types.PluginContext {\n    return &pluginContext{}\n}\n\ntype header struct {\n    Name  string\n    Value string\n}\n\ntype pluginContext struct {\n    types.DefaultPluginContext\n    Headers []header\n}\n\nfunc (ctx *pluginContext) OnPluginStart(pluginConfigurationSize int) types.OnPluginStartStatus {\n    data, err := proxywasm.GetPluginConfiguration()\n    if err != nil {\n        proxywasm.LogErrorf("error reading plugin configuration: %v", err)\n        return types.OnPluginStartStatusFailed\n    }\n\n    var p fastjson.Parser\n    v, err := p.ParseBytes(data)\n    if err != nil {\n        proxywasm.LogErrorf("error decoding plugin configuration: %v", err)\n        return types.OnPluginStartStatusFailed\n    }\n    headers := v.GetArray("headers")\n    ctx.Headers = make([]header, len(headers))\n    for i, hdr := range headers {\n        ctx.Headers[i] = header{\n            Name:  string(hdr.GetStringBytes("name")),\n            Value: string(hdr.GetStringBytes("value")),\n        }\n    }\n    return types.OnPluginStartStatusOK\n}\n\n// each HTTP request to a route has its own HTTPContext\nfunc (ctx *pluginContext) NewHttpContext(contextID uint32) types.HttpContext {\n    return &httpContext{parent: ctx}\n}\n\ntype httpContext struct {\n    types.DefaultHttpContext\n    parent *pluginContext\n}\n\nfunc (ctx *httpContext) OnHttpResponseHeaders(numHeaders int, endOfStream bool) types.Action {\n    plugin := ctx.parent\n    for _, hdr := range plugin.Headers {\n        proxywasm.ReplaceHttpResponseHeader(hdr.Name, hdr.Value)\n    }\n\n    return types.ActionContinue\n}\n')),(0,i.kt)("p",null,"To compile our plugin to a Wasm binary, we can run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"tinygo build -o custom_response_header.go.wasm -scheduler=none -target=wasi ./main.go\n")),(0,i.kt)("h2",{id:"configuring-apisix-to-run-the-plugin"},"Configuring APISIX to Run the Plugin"),(0,i.kt)("p",null,"To use the Wasm plugin, we first have to update our APISIX configuration file to add this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="config.yaml"',title:'"config.yaml"'},"wasm:\n  plugins:\n    - name: custom-response-header\n      priority: 7000\n      file: /opt/apisix/wasm/custom_response_header.go.wasm\n")),(0,i.kt)("p",null,"Now we can create a route and enable this plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="apisix.yaml"',title:'"apisix.yaml"'},'routes:\n  - uri: /*\n    upstream:\n      type: roundrobin\n      nodes:\n        "127.0.0.1:80": 1\n    plugins:\n      custom-response-header:\n       conf: |\n        {\n          "headers": [{\n            "name": "X-Go-Wasm", "value": "APISIX"\n          }]\n        }\n#END\n')),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The above configuration assumes that APISIX is deployed in ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/deployment-modes/#standalone"},"standalone mode"),"."))),(0,i.kt)("h2",{id:"testing-the-plugin"},"Testing the Plugin"),(0,i.kt)("p",null,"We can send a request to the created route to test the plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"curl http://127.0.0.1:9080 -s --head\n")),(0,i.kt)("p",null,"The response header would be as shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"...\nX-Go-Wasm: APISIX\n")),(0,i.kt)("h2",{id:"wasm-for-the-win"},"Wasm for the Win?"),(0,i.kt)("p",null,"From this article, it seems like using Wasm plugins benefits both users and APISIX maintainers."),(0,i.kt)("p",null,"A test using our example ",(0,i.kt)("inlineCode",{parentName:"p"},"custom-response-header")," function implemented through a Lua plugin, an external Go plugin runner, and a Wasm plugin show how the performance varies:"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/06/27/bbkiAJgI_plugin-performance-light.png",alt:"Wasm plugins aren't that bad!"})),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Running 30s tests with 5 threads and 50 connections using ",(0,i.kt)("a",{parentName:"em",href:"https://github.com/wg/wrk"},"wrk"),".")),(0,i.kt)("p",null,"Looking solely at this example, it might be tempting to ask why anyone would want to use plugin runners or write Lua plugins.\xa0Well, all the advantages of using Wasm comes with the following caveats:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Limited plugins"),": The Wasm implementation of programming languages often lacks complete support. For Go, we were limited to using the TinyGo compiler, similar to other languages."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Immature stack"),": Wasm and its usage outside the browser is still a relatively new concept. The proxy-wasm spec also has its limitations due to its relative novelty."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Lack of concurrency"),": Wasm does not have built-in concurrency support. This could be a deal breaker for typical APISIX uses cases where high performance is critical."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Better alternatives"),": Since APISIX can be extended using Lua plugins or plugin runners, there are always alternatives to using Wasm.")),(0,i.kt)("p",null,"Despite these caveats, the future of Wasm in APISIX and other proxies seems promising. You can choose to hop on the Wasm bandwagon if its benefits tip the scale against these costs. But currently, APISIX plans to continue supporting all three ways of creating custom plugins for the foreseeable future."))}g.isMDXComponent=!0}}]);