"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[7543],{35318:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>h});var a=t(27378);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var p=a.createContext({}),u=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},s=function(e){var n=u(e.components);return a.createElement(p.Provider,{value:n},e.children)},g={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),c=u(t),h=i,d=c["".concat(p,".").concat(h)]||c[h]||g[h]||r;return t?a.createElement(d,o(o({ref:n},s),{},{components:t})):a.createElement(d,o({ref:n},s))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=c;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=t[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},46333:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>o,default:()=>g,frontMatter:()=>r,metadata:()=>l,toc:()=>u});var a=t(25773),i=(t(27378),t(35318));const r={title:"How to Write an Apache APISIX Plugin in Java",slug:"2021/06/21/use-java-to-write-apache-apisix-plugins",author:"Zhengsong Tu",authorURL:"https://github.com/tzssangglass",authorImageURL:"https://avatars.githubusercontent.com/u/30819887?v=4",keywords:["APISIX","Apache APISIX","Java","plugin"],description:"The cloud native API Gateway Apache APISIX already supports Java to write plugins. Users can not only write plugins in Java language, but also integrate into the Spring Cloud ecosystem.",tags:["Ecosystem"]},o=void 0,l={permalink:"/blog/2021/06/21/use-java-to-write-apache-apisix-plugins",source:"@site/blog/2021/06/21/use-Java-to-write-Apache-APISIX-plugins.md",title:"How to Write an Apache APISIX Plugin in Java",description:"The cloud native API Gateway Apache APISIX already supports Java to write plugins. Users can not only write plugins in Java language, but also integrate into the Spring Cloud ecosystem.",date:"2021-06-21T00:00:00.000Z",formattedDate:"June 21, 2021",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.58,truncated:!0,authors:[{name:"Zhengsong Tu",url:"https://github.com/tzssangglass",imageURL:"https://avatars.githubusercontent.com/u/30819887?v=4"}],prevItem:{title:"Deploy APISIX and APISIX Ingress Controller on Rancher",permalink:"/blog/2021/06/23/deploy-great-open-source-gateway-and-ingress-controller-fast"},nextItem:{title:"APISIX Ingress Controller 1.0 Release",permalink:"/blog/2021/06/18/first-ga-version-v1.0-of-apache-apisix-ingress-controller-released"}},p={authorsImageUrls:[void 0]},u=[{value:"Introduction",id:"introduction",children:[{value:"Why Apache APISIX Supports Writing Plugins in Multiple Programming Languages?",id:"why-apache-apisix-supports-writing-plugins-in-multiple-programming-languages",children:[],level:3},{value:"Multiple Programming Languages Architecture Diagram",id:"multiple-programming-languages-architecture-diagram",children:[],level:3}],level:2},{value:"Building Development Environment",id:"building-development-environment",children:[],level:2},{value:"Enabling Debug\xa0Mode",id:"enabling-debugmode",children:[{value:"Configuring Apache APISIX into Debug\xa0Mode",id:"configuring-apache-apisix-into-debugmode",children:[],level:3},{value:"Setting apisix-java-plugin-runner to Debug\xa0Mode",id:"setting-apisix-java-plugin-runner-to-debugmode",children:[],level:3}],level:2},{value:"How to Develop a Java Plugin for Apache\xa0APISIX?",id:"how-to-develop-a-java-plugin-for-apacheapisix",children:[{value:"Scenario",id:"scenario",children:[],level:3},{value:"Configuring Apache\xa0APISIX",id:"configuring-apacheapisix",children:[],level:3},{value:"Developing a Java\xa0Plugin",id:"developing-a-javaplugin",children:[],level:3},{value:"Testing the\xa0Plugin",id:"testing-theplugin",children:[],level:3}],level:2},{value:"Deploying the\xa0Plugin",id:"deploying-theplugin",children:[],level:2},{value:"Video Tutorial",id:"video-tutorial",children:[],level:2}],s={toc:u};function g(e){let{components:n,...t}=e;return(0,i.kt)("wrapper",(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Apache APISIX now supports writing plugins in Java! You can now write plugins in a programming language you are familiar with.")),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("h3",{id:"why-apache-apisix-supports-writing-plugins-in-multiple-programming-languages"},"Why Apache APISIX Supports Writing Plugins in Multiple Programming Languages?"),(0,i.kt)("p",null,"Apache APISIX has been supporting customized plugins since the day it was born. But it only supported plugins written in Lua. As a result, developers need to have Lua and OpenResty-related development skills to actually write their own plugins. However, Lua and OpenResty are relatively less popular languages with fewer developers compared to Java and Go. Besides, learning Lua and OpenResty from scratch requires a lot of time and effort."),(0,i.kt)("p",null,"During technological selection, the most important consideration for the development team is whether the chosen product matches the team's technology stack. The niche technology stack limits Apache APISIX to become the first choice of API Gateway product in many scenarios."),(0,i.kt)("p",null,"Now, Apache APISIX supports multi-language development plugins. More importantly, the development ecosystem where the language is supported, so users can use their familiar technology stack to develop Apache APISIX. With Apache APISIX supporting plugins written in Java, for example, users can not only write plugins in Java but also integrate into the Spring Cloud ecosystem and use a wide range of technical components within the ecosystem."),(0,i.kt)("h3",{id:"multiple-programming-languages-architecture-diagram"},"Multiple Programming Languages Architecture Diagram"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639464774923-50cebc94-6344-4ea6-88a6-2b424c5f8567.png",alt:"Multiple Programming Languages Architecture Diagram"})),(0,i.kt)("p",null,"The left side of the diagram shows the workflow of Apache APISIX. The right side of the diagram is the plugin runner, which is a generic term for projects with multiple programming languages support. The apisix-java-plugin-runner is a plugin runner that supports the Java language."),(0,i.kt)("p",null,"When you configure a plugin runner in Apache APISIX, Apache APISIX starts a subprocess to run the plugin runner, which belongs to the same user as the Apache APISIX process. When we restart or reload Apache APISIX, the plugin runner will also be restarted."),(0,i.kt)("p",null,"If you configure the ext-plugin-* plugin for a given route, a request hitting that route will trigger Apache APISIX to perform an RPC call to the plugin runner via a Unix socket. The call is broken down into two phases:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"ext-plugin-pre-req: Before executing the Apache APISIX built-in plugin (Lua plugin)"),(0,i.kt)("li",{parentName:"ul"},"ext-plugin-post-req: After executing the Apache APISIX built-in plugin (Lua plugin)")),(0,i.kt)("p",null,"Please configure the timing of the plugin runner execution as needed.\nThe plugin runner processes the RPC call, creates a simulated request inside it, and then runs the multiple programming languages written a plugin and returns the result to Apache APISIX."),(0,i.kt)("p",null,"The order of execution of multiple programming languages plugins is defined in the ext-plugin-* plugin configuration entry. Like other plugins, they can be enabled and redefined on the fly."),(0,i.kt)("h2",{id:"building-development-environment"},"Building Development Environment"),(0,i.kt)("p",null,"First, you need to build the Apache APISIX runtime or development environment, please refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/docs/en/latest/building-apisix.md"},"Build Apache APISIX"),", and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-java-plugin-runner/blob/main/docs/en/latest/development.md"},"Build apisix-java-plugin-runner"),"."),(0,i.kt)("p",null,"Note: Apache APISIX and apisix-java-plugin-runner need to be located on the same instance."),(0,i.kt)("h2",{id:"enabling-debugmode"},"Enabling Debug\xa0Mode"),(0,i.kt)("h3",{id:"configuring-apache-apisix-into-debugmode"},"Configuring Apache APISIX into Debug\xa0Mode"),(0,i.kt)("p",null,"When Apache APISIX is configured into debug mode, it is allowed to run external plugins in a debugging manner. Add the following configuration to ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," to enable debug mode for Apache APISIX."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"ext-plugin:\n  path_for_test: /tmp/runner.sock\n")),(0,i.kt)("p",null,"The configuration above means that Apache APISIX acts as the client and listens to the Unix Domain Socket link located at ",(0,i.kt)("inlineCode",{parentName:"p"},"/tmp/runner.sock"),"."),(0,i.kt)("h3",{id:"setting-apisix-java-plugin-runner-to-debugmode"},"Setting apisix-java-plugin-runner to Debug\xa0Mode"),(0,i.kt)("p",null,"Before starting the ",(0,i.kt)("inlineCode",{parentName:"p"},"Mainclass(org.apache.apisix.plugin.runner.PluginRunnerApplication)"),", you need to configure the user-level environment variables ",(0,i.kt)("inlineCode",{parentName:"p"},"APISIX_LISTEN_ADDRESS=unix:/tmp/runner.sock and APISIX_CONF_EXPIRE_TIME=3600"),"."),(0,i.kt)("p",null,"If you are using IDEA for development, the configured environment variables are shown below."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639464890287-ee6bbc3a-3f8b-4de7-9ce4-7670fb0c3f64.png",alt:"configured environment"})),(0,i.kt)("p",null,"apisix-java-plugin-runner is equivalent to the server side and will actively create the ",(0,i.kt)("inlineCode",{parentName:"p"},"/tmp/runner.sock")," file at startup and communicate with Apache APISIX on this file for Unix Domain Socket."),(0,i.kt)("h2",{id:"how-to-develop-a-java-plugin-for-apacheapisix"},"How to Develop a Java Plugin for Apache\xa0APISIX?"),(0,i.kt)("h3",{id:"scenario"},"Scenario"),(0,i.kt)("p",null,"Let's say we have a scenario like this: we need to verify the validity of the token in the request header. The way to verify the token is to carry the token as a parameter in the request and access the SSO fixed interface."),(0,i.kt)("h3",{id:"configuring-apacheapisix"},"Configuring Apache\xa0APISIX"),(0,i.kt)("p",null,"First, name the plugin ",(0,i.kt)("inlineCode",{parentName:"p"},"TokenValidator"),", and then design the properties. In order to achieve dynamic configuration as far as possible, the properties are designed as follows."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "validate_header": "token",\n  "validate_url": "https://www.sso.foo.com/token/validate",\n  "rejected_code": "403"\n}\n')),(0,i.kt)("p",null,"Start Apache APISIX, then add a new route configuration specifying that the route requires a call to apisix-java-plugin-runner's ",(0,i.kt)("inlineCode",{parentName:"p"},"TokenValidator")," plugin, as shown in the following example."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "uri":"/get",\n    "plugins":{\n        "ext-plugin-pre-req":{\n            "conf":[\n                {\n                    "name":"TokenValidator",\n                    "value":"{\\"validate_header\\":\\"token\\",\\"validate_url\\":\\"https://www.sso.foo.com/token/validate\\",\\"rejected_code\\":\\"403\\"}"\n                }\n            ]\n        }\n    },\n    "upstream":{\n        "nodes":{\n            "httpbin.org:80":1\n        },\n        "type":"roundrobin"\n    }\n}\n')),(0,i.kt)("p",null,"Note that the properties of ",(0,i.kt)("inlineCode",{parentName:"p"},"TokenValidator")," need to be escaped by json and configured as string type (the upstream address here is configured as httpbin.org to simplify the debugging process)."),(0,i.kt)("h3",{id:"developing-a-javaplugin"},"Developing a Java\xa0Plugin"),(0,i.kt)("p",null,"Add ",(0,i.kt)("inlineCode",{parentName:"p"},"TokenValidatr.java")," with the following initial code skeleton In the ",(0,i.kt)("inlineCode",{parentName:"p"},"runner-plugin/src/main/java/org/apache/apisix/plugin/runner/filter")," directory."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-Java"},'package org.apache.apisix.plugin.runner.filter;\n\nimport org.apache.apisix.plugin.runner.HttpRequest;\nimport org.apache.apisix.plugin.runner.HttpResponse;\nimport org.springframework.stereotype.Component;\nimport reactor.core.publisher.Mono;\n\n\n@Component\npublic class TokenValidator implements PluginFilter {\n\n    @Override\n    public String name() {\n        return "TokenValidator";\n    }\n\n    @Override\n    public Mono<Void> filter(HttpRequest request, HttpResponse response, PluginFilterChain chain) {\n        return chain.filter(request, response);\n    }\n}\n')),(0,i.kt)("p",null,"This plugin inherits the ",(0,i.kt)("inlineCode",{parentName:"p"},"PluginFilter")," interface and overrides the ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," and the ",(0,i.kt)("inlineCode",{parentName:"p"},"filter")," function. Rewrite the return value of ",(0,i.kt)("inlineCode",{parentName:"p"},"name"),' to be consistent with "name" in the route attribute of APISIX configuration earlier. The complete code is as follows.'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-Java"},'package org.apache.apisix.plugin.runner.filter;\n\nimport com.google.gson.Gson;\nimport org.apache.apisix.plugin.runner.HttpRequest;\nimport org.apache.apisix.plugin.runner.HttpResponse;\nimport org.springframework.stereotype.Component;\nimport reactor.core.publisher.Mono;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\n@Component\npublic class TokenValidator implements PluginFilter {\n\n    @Override\n    public String name() {\n        return "TokenValidator";\n    }\n\n    @Override\n    public Mono<Void> filter(HttpRequest request, HttpResponse response, PluginFilterChain chain) {\n        // parse `conf` to json\n        String configStr = request.getConfig(this);\n        Gson gson = new Gson();\n        Map<String, Object> conf = new HashMap<>();\n        conf = gson.fromJson(configStr, conf.getClass());\n\n        // get configuration parameters\n        String token = request.getHeader((String) conf.get("validate_header"));\n        String validate_url = (String) conf.get("validate_url");\n        boolean flag = validate(token, validate_url);\n\n        // token verification results\n        if (!flag) {\n            String rejected_code = (String) conf.get("rejected_code");\n            response.setStatusCode(Integer.parseInt(rejected_code));\n            return chain.filter(request, response);\n        }\n\n        return chain.filter(request, response);\n    }\n\n    private Boolean validate(String token, String validate_url) {\n        //TODO: improve the validation process\n        return true;\n    }\n}\n')),(0,i.kt)("h3",{id:"testing-theplugin"},"Testing the\xa0Plugin"),(0,i.kt)("p",null,"The upstream service configured on Apache APISIX is httpbin.org, which allows you to access Apache APISIX, trigger the route, and have Apache APISIX call apisix-java-plugin-runner to execute the TokenValidator plugin and test the functionality of the Java plugin."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -H \'token: 123456\' 127.0.0.1:9080/get\n{\n "args": {},\n "headers": {\n "Accept": "/",\n "Host": "127.0.0.1",\n "Token": "123456",\n "User-Agent": "curl/7.71.1",\n "X-Amzn-Trace-Id": "Root=1-60cb0424-02b5bf804cfeab5252392f96",\n "X-Forwarded-Host": "127.0.0.1"\n },\n "origin": "127.0.0.1",\n "url": "http://127.0.0.1/get"\n}\n')),(0,i.kt)("h2",{id:"deploying-theplugin"},"Deploying the\xa0Plugin"),(0,i.kt)("p",null,"After the development of the plugin is completed, the deployment operation can be found in referred to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-java-plugin-runner/blob/main/docs/how-it-works.md#run"},"Deploying apisix-java-plugin-runner"),"."),(0,i.kt)("h2",{id:"video-tutorial"},"Video Tutorial"),(0,i.kt)("iframe",{height:"350",width:"600",src:"https://api7-website-1301662268.file.myqcloud.com/2021-06-21-use-Java-to-write-Apache-APISIX-plugins.mp4",frameborder:"0"}))}g.isMDXComponent=!0}}]);