"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[45069],{3905:function(e,t,n){n.d(t,{Zo:function(){return l},kt:function(){return u}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=a.createContext({}),c=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},l=function(e){var t=c(e.components);return a.createElement(p.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,p=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=c(n),u=o,m=d["".concat(p,".").concat(u)]||d[u]||h[u]||i;return n?a.createElement(m,r(r({ref:t},l),{},{components:n})):a.createElement(m,r({ref:t},l))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=d;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},24535:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return r},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return c},toc:function(){return l},default:function(){return d}});var a=n(87462),o=n(63366),i=(n(67294),n(3905)),r={title:"Using Apache APISIX Ingress Gateway to access Custom Monitoring in KubeSphere",author:"Haili Zhang",authorURL:"https://github.com/webup",authorImageURL:"https://avatars.githubusercontent.com/u/2936504?v=4",keywords:["KubeSphere","Apache APISIX","Kubenetes","Ingress Controller","Monitor"],description:"This article will take Apache APISIX Ingress Controller as an example to show you in detail how to quickly use different types of gateways and status monitoring for Kubernetes clusters through KubeSphere.",tags:["Technology"]},s=void 0,p={permalink:"/blog/2021/11/30/use-apisix-ingress-in-kubesphere",source:"@site/blog/2021/11/30/use-apisix-ingress-in-kubesphere.md",title:"Using Apache APISIX Ingress Gateway to access Custom Monitoring in KubeSphere",description:"This article will take Apache APISIX Ingress Controller as an example to show you in detail how to quickly use different types of gateways and status monitoring for Kubernetes clusters through KubeSphere.",date:"2021-11-30T00:00:00.000Z",formattedDate:"November 30, 2021",tags:[{label:"Technology",permalink:"/blog/tags/technology"}],readingTime:12.7,truncated:!0,authors:[{name:"Haili Zhang",url:"https://github.com/webup",imageURL:"https://avatars.githubusercontent.com/u/2936504?v=4"}],prevItem:{title:"Apache APISIX 2.11.0 is officially released with more new features",permalink:"/blog/2021/12/01/release-apache-apisix-2.11"},nextItem:{title:"Contributer to Committer journey @Apache APISIX",permalink:"/blog/2021/11/26/apache-apisix-committer-experience"}},c={authorsImageUrls:[void 0]},l=[{value:"Preparation",id:"preparation",children:[{value:"Installing KubeSphere",id:"installing-kubesphere",children:[]},{value:"Deploying the httpbin demo application",id:"deploying-the-httpbin-demo-application",children:[]},{value:"Additional Project Gateway Details",id:"additional-project-gateway-details",children:[]}]},{value:"Getting Started with Clustered Gateways",id:"getting-started-with-clustered-gateways",children:[]},{value:"A Quick Look at Apache APISIX Ingress Controller",id:"a-quick-look-at-apache-apisix-ingress-controller",children:[{value:"How to deploy",id:"how-to-deploy",children:[]},{value:"Dashboard Usage",id:"dashboard-usage",children:[]},{value:"How to use",id:"how-to-use",children:[]}]},{value:"Custom Monitoring of Apache APISIX Gateways",id:"custom-monitoring-of-apache-apisix-gateways",children:[{value:"Exposing relevant Prometheus monitoring metrics",id:"exposing-relevant-prometheus-monitoring-metrics",children:[]},{value:"Creating a ServiceMonitor for monitoring metrics",id:"creating-a-servicemonitor-for-monitoring-metrics",children:[]},{value:"Indicator access to custom monitoring panel",id:"indicator-access-to-custom-monitoring-panel",children:[]}]},{value:"Summary",id:"summary",children:[]}],h={toc:l};function d(e){var t=e.components,n=(0,o.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This article will take Apache APISIX Ingress Controller as an example to show you in detail how to quickly use different types of gateways and status monitoring for Kubernetes clusters through KubeSphere.")),(0,i.kt)("p",null,"In early November, KubeSphere released version 3.2.0, which added a full set of monitoring and management pages for project gateways, and introduced cluster gateways to provide global Ingress gateway capabilities at the cluster level."),(0,i.kt)("p",null,"To help users better understand how to deploy and use third-party Ingress Controllers in the new version of KubeSphere, this article will use the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/ingress-controller/getting-started/"},"Apache APISIX Ingress Controller")," as an example to show you how to quickly use different types of gateways for Kubernetes clusters with KubeSphere and perform status monitoring."),(0,i.kt)("h2",{id:"preparation"},"Preparation"),(0,i.kt)("h3",{id:"installing-kubesphere"},"Installing KubeSphere"),(0,i.kt)("p",null,"There are two ways to install KubeSphere."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Install directly on ",(0,i.kt)("a",{parentName:"li",href:"https://kubesphere.com.cn/docs/quick-start/all-in-one-on-linux/"},"Linux")),(0,i.kt)("li",{parentName:"ol"},"Install on ",(0,i.kt)("a",{parentName:"li",href:"https://kubesphere.com.cn/docs/quick-start/minimal-kubesphere-on-k8s/"},"existing Kubernetes"))),(0,i.kt)("p",null,"The monitoring module is already included in the minimal installation of KubeSphere, so there is no need to enable it additionally, and you can confirm the installation status via the Monitoring tab on the System Components page."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638255471644-e1327ffc-dbed-4890-a15c-819f28731fc9.png",alt:"Confirm installation status"})),(0,i.kt)("h3",{id:"deploying-the-httpbin-demo-application"},"Deploying the httpbin demo application"),(0,i.kt)("p",null,"Since we need to demonstrate the access control capabilities of the gateway, we must first have an accessible application as a backend service for the gateway. Here we use the ",(0,i.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/kennethreitz/httpbin/"},"kennethreitz/httpbin")," container application provided by ",(0,i.kt)("a",{parentName:"p",href:"httpbin.org"},"httpbin.org")," as our demo application."),(0,i.kt)("p",null,'In KubeSphere, we can either create a new project or use an existing one. After entering the project page, select "Services" under "Application Loads" to directly create a stateless workload and generate a companion service.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638255616585-b0f5a674-f06a-4b18-baf9-8d6006abeead.png",alt:"Create a Service"})),(0,i.kt)("p",null,"Use the default port ",(0,i.kt)("inlineCode",{parentName:"p"},"80")," of the ",(0,i.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/kennethreitz/httpbin/"},"kennethreitz/httpbin")," container as the service port, and make sure you can see the corresponding entry for ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin")," under both the Workloads and Services pages after creation, as shown in the following image."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638255786442-924bf704-9b9d-413f-9fc0-be6650a6ff4a.png",alt:"Service"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638255792974-7f354950-e34a-427a-9ff7-aa3af0a56dd6.png",alt:"Workload"})),(0,i.kt)("h3",{id:"additional-project-gateway-details"},"Additional Project Gateway Details"),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"Project Gateway")," is a feature that has been live since KubeSphere 3.0. The Gateway in the KubeSphere Project is an NGINX Ingress controller. The mechanism built into KubeSphere for HTTP load balancing is called ",(0,i.kt)("strong",{parentName:"p"},"Application Routing"),", which defines the rules for connecting from the outside to the clustered service. To allow access to services from the outside, users can create routing resources to define URI paths, back-end service names, and other information."),(0,i.kt)("p",null,"Following the ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin"),' service project deployed above, open the Gateway Settings page in Project Settings and perform the "Enable Gateway" operation. For convenience, just select ',(0,i.kt)("inlineCode",{parentName:"p"},"NodePort"),' as the "Access Method".'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256005754-d1e8bf9a-0ecc-4c6e-8ceb-0c25b04fef20.png",alt:"Project setting"})),(0,i.kt)("p",null,'After complete the above operation, go back to the Gateway page, wait for a moment and refresh the page, you can get the deployment completion status as shown below, where you can see that NodePort is given two node ports by default. Next, we use the "Manage" button in the upper right corner to "View Details".'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256011357-960f6852-31b3-4702-8911-17d07ec19d7b.png",alt:"Deployment complete"})),(0,i.kt)("p",null,"At this point we are looking at the new monitoring page for the project/cluster gateway in version 3.2.0. Next we need to create an application route for the httpbin service."),(0,i.kt)("p",null,'Go to the Application Routing page from Application Load and start "creating" the route. After naming the route ',(0,i.kt)("inlineCode",{parentName:"p"},"httpbin"),', we specify a domain name for testing purposes and set the "path" to ',(0,i.kt)("inlineCode",{parentName:"p"},"/"),', select "service" ',(0,i.kt)("inlineCode",{parentName:"p"},"httpbin"),' and "port" ',(0,i.kt)("inlineCode",{parentName:"p"},"80"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241684770-ce94fe24-58a6-4b9b-9507-d802713b4c38.png",alt:"Apply routin"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241689985-149fc2f7-456b-423c-8cfc-00800dc24917.png",alt:"Create route"})),(0,i.kt)("p",null,"After skipping the advanced settings in the next step, the route creation is completed and you can get the ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin")," application route entry as shown in the figure below."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256382273-109728eb-4d19-4c2b-ab92-9a2909c3eff8.png",alt:"Route creation"})),(0,i.kt)("p",null,"Next, we can access the httpbin application service through the NodePort address of the project gateway and the specified domain name (e.g., ",(0,i.kt)("a",{parentName:"p",href:"http://httpbin.ui:32516"},"http://httpbin.ui:32516"),' here), refresh or manipulate the request generation function of the page at will, and then enter the details page of the gateway, you can see that the "Monitoring" panel has appeared some built-in monitoring indicators.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256419345-48476f01-b293-401b-9e4f-8bf64a9fab90.png",alt:"Generation function"})),(0,i.kt)("h4",{id:"specifying-the-nodeport-node-port"},"Specifying the NodePort Node Port"),(0,i.kt)("p",null,"For public cloud environments that use NodePort to expose access to the outside world, the open ports are usually limited and controlled, so we need to modify the NodePort used by the gateway."),(0,i.kt)("p",null,"Since the gateway is managed by KubeSphere, to modify the NodePort of the gateway service, you need to have access to the ",(0,i.kt)("inlineCode",{parentName:"p"},"kubesphere-controls-system")," project. Once inside the project, you can find the gateway service named ",(0,i.kt)("inlineCode",{parentName:"p"},"kubesphere-router-<project-namespace>"),' on the "Services" page under "Application Load", and the NodePort is open for external access.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256523468-408ee36f-aac7-4bb4-9cd3-2473a95a52f4.png",alt:"Application Load"})),(0,i.kt)("h2",{id:"getting-started-with-clustered-gateways"},"Getting Started with Clustered Gateways"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"KubeSphere 3.2.0 supports global gateways at the cluster level, so all projects can share the same gateway, and previously created project gateways are not affected by the cluster gateway. Gateways for all projects can be managed and configured centrally, eliminating the need to switch to a different enterprise space to configure gateways.")),(0,i.kt)("p",null,'If you are using KubeSphere version 3.2.0, we recommend using the cluster gateway feature to unify the application routing across the cluster. To enable the cluster gateway, it\'s very simple: use an account with cluster management privileges to access one of the clusters you can manage (e.g. default cluster here), and under "Gateway Settings" in "Cluster Settings", you can "Enable Gateway" and view the "Project Gateway".'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256574546-920473f3-e8ac-4cf9-932b-4202888e7a54.png",alt:"Project gateway"})),(0,i.kt)("p",null,"The way the cluster gateway is opened and the modification of the aligned NodePort access port are basically the same as the previous project gateway, so we won't go into details here."),(0,i.kt)("p",null,"However, there is one point that needs special attention: after the cluster gateway is opened, the gateway of the project that has been opened will remain; however, the project that has not yet created a gateway cannot create a separate gateway, and will use the cluster gateway directly."),(0,i.kt)("p",null,'The following figure shows the overview of all gateways in the "Gateway Settings" page for projects that have already created gateways, after having both project and cluster gateways.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256658706-ac5107fe-2fd7-4521-b830-9ae1fdf762e1.png",alt:"Gateway setting"})),(0,i.kt)("h2",{id:"a-quick-look-at-apache-apisix-ingress-controller"},"A Quick Look at Apache APISIX Ingress Controller"),(0,i.kt)("p",null,"Apache APISIX is an open source, high-performance, dynamic cloud-native gateway donated to the Apache Foundation by Shenzhen Tributary Technology Co. in 2019, and is now the top open source project of the Apache Foundation and the most active gateway project on GitHub.Apache APISIX currently covers API gateways, LB Kubernetes Ingress, Service Mesh, and many other scenarios."),(0,i.kt)("h3",{id:"how-to-deploy"},"How to deploy"),(0,i.kt)("p",null,"First add the Apache APISIX Helm Chart repository. After that, select an enterprise space and add the following ",(0,i.kt)("a",{parentName:"p",href:"https://charts.apiseven.com"},"Apache APISIX repository"),' via "Application Repository" under "Application Management".'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638256788584-dca2d21b-3ffc-4bb4-bd73-56dedb6d005a.png",alt:"Application repository"})),(0,i.kt)("p",null,"Next, create a project named ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-system"),". Once you are on the project page, select the Create an Application in Application Load method to deploy Apache APISIX, and select the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix")," application template to start the deployment."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241691528-80090ab6-85de-401f-96d7-58118b3cbd88.png",alt:"start the deployment"})),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Why deploy the Apache APISIX application Helm Chart directly instead of deploying the Apache APISIX Ingress Controller directly?")),(0,i.kt)("p",null,"This is because the Apache APISIX Ingress Controller is currently strongly associated with the Apache APISIX Gateway (as shown in the figure below), and it is currently most convenient to deploy Apache APISIX Gateway + Dashboard + Ingress Controller through Apache APISIX Helm Charts at the same time. Ingress Controller is the most convenient, so this article recommends using Apache APISIX Helm Charts directly for the deployment of the whole set of components."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241693072-9b3146f5-bcc6-4441-b002-f1a07603a8c4.png",alt:"Why use APISIX gateway"})),(0,i.kt)("p",null,'Name the application apisix to avoid mismatches between workloads and service names of multiple components (Gateway, Dashboard, Ingress Controller); in the "Application Settings" section edited in the installation steps, please fill in the following configuration (please pay special attention to the notes marked with ',"[Note]",", the rest (The rest can be edited and modified by yourself as needed)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"global:\n  imagePullSecrets: []\n  \napisix:\n  enabled: true\n  customLuaSharedDicts: []\n  image:\n    repository: apache/apisix\n    pullPolicy: IfNotPresent\n    tag: 2.10.1-alpine\n  replicaCount: 1\n  podAnnotations: {}\n  podSecurityContext: {}\n  securityContext: {}\n  resources: {}\n  nodeSelector: {}\n  tolerations: []\n  affinity: {}\n  podAntiAffinity:\n    enabled: false\n\nnameOverride: ''\nfullnameOverride: ''\n\ngateway:\n  type: NodePort\n  externalTrafficPolicy: Cluster\n  http:\n    enabled: true\n    servicePort: 80\n    containerPort: 9080\n  tls:\n    enabled: false\n    servicePort: 443\n    containerPort: 9443\n    existingCASecret: ''\n    certCAFilename: ''\n    http2:\n      enabled: true\n  stream:\n    enabled: false\n    only: false\n    tcp: []\n    udp: []\n  ingress:\n    enabled: false\n    annotations: {}\n    hosts:\n      - host: apisix.local\n        paths: []\n    tls: []\n\nadmin:\n  enabled: true\n  type: ClusterIP\n  externalIPs: []\n  port: 9180\n  servicePort: 9180\n  cors: true\n  credentials:\n    admin: edd1c9f034335f136f87ad84b625c8f1\n    viewer: 4054f7cf07e344346cd3f287985e76a2\n  allow:\n    ipList:\n      - 0.0.0.0/0\n\nplugins:\n  - api-breaker\n  - authz-keycloak\n  - basic-auth\n  - batch-requests\n  - consumer-restriction\n  - cors\n  - echo\n  - fault-injection\n  - grpc-transcode\n  - hmac-auth\n  - http-logger\n  - ip-restriction\n  - ua-restriction\n  - jwt-auth\n  - kafka-logger\n  - key-auth\n  - limit-conn\n  - limit-count\n  - limit-req\n  - node-status\n  - openid-connect\n  - authz-casbin\n  - prometheus\n  - proxy-cache\n  - proxy-mirror\n  - proxy-rewrite\n  - redirect\n  - referer-restriction\n  - request-id\n  - request-validation\n  - response-rewrite\n  - serverless-post-function\n  - serverless-pre-function\n  - sls-logger\n  - syslog\n  - tcp-logger\n  - udp-logger\n  - uri-blocker\n  - wolf-rbac\n  - zipkin\n  - traffic-split\n  - gzip\n  - real-ip\n  # [note] add this plug-in to cooperate with Dashboard to display service information\n  - server-info\n\nstream_plugins:\n  - mqtt-proxy\n  - ip-restriction\n  - limit-conn\n\ncustomPlugins:\n  enabled: true\n  luaPath: /opts/custom_plugins/?.lua\n  # [note] the following configuration ensures that the Prometheus plug-in can expose indicators to the outside world.\n  plugins:\n   - name: prometheus\n     attrs:\n       export_addr:\n         ip: 0.0.0.0\n          port: 9091\n      configMap:\n       name: prometheus\n        mounts: []\n\ndns:\n  resolvers:\n    - 127.0.0.1\n    - 172.20.0.10\n    - 114.114.114.114\n    - 223.5.5.5\n    - 1.1.1.1\n    - 8.8.8.8\n  validity: 30\n  timeout: 5\n\nautoscaling:\n  enabled: false\n  minReplicas: 1\n  maxReplicas: 100\n  targetCPUUtilizationPercentage: 80\n  targetMemoryUtilizationPercentage: 80\n\nconfigurationSnippet:\n  main: ''\n  httpStart: ''\n  httpEnd: ''\n  httpSrv: ''\n  httpAdmin: ''\n  stream: ''\n\netcd:\n  enabled: true\n  host:\n    - 'http://etcd.host:2379'\n  prefix: /apisix\n  timeout: 30\n  auth:\n    rbac:\n      enabled: false\n      user: ''\n      password: ''\n    tls:\n      enabled: false\n      existingSecret: ''\n      certFilename: ''\n      certKeyFilename: ''\n      verify: true\n  service:\n    port: 2379\n  replicaCount: 3\n\ndashboard:\n  enabled: true\n  # [note] Enable NodePort for Dashboard to facilitate subsequent use\n  service:\n   type: NodePort\n\ningress-controller:\n  enabled: true\n  config:\n    apisix:\n     # [note] Be sure to set the namespace where gateway is located\n      serviceNamespace: apisix-system\n  serviceMonitor:\n    enabled: true\n    namespace: 'apisix-system'\n    interval: 15s\n")),(0,i.kt)("p",null,'After successful deployment, click the application name to enter the details page, and you can see the following service deployment and working status operation status display under the "Resource Status" tab.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241694605-7d88f095-fef5-43f4-9752-8dc5a2f9abc4.png",alt:"Resource status"})),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The default configuration parameters for the other two Helm Charts of the Apache APISIX project can be found in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-helm-chart/blob/master/charts/apisix-dashboard/values.yaml"},"Dashboard")," and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-helm-chart/blob/master/charts/apisix-ingress-controller/values.yaml"},"Ingress Controller")," ",(0,i.kt)("inlineCode",{parentName:"p"},"values.yaml"),"."))),(0,i.kt)("h3",{id:"dashboard-usage"},"Dashboard Usage"),(0,i.kt)("p",null,"After the Apache APISIX application is deployed, you can check the current status of the Apache APISIX gateway through the Apache APISIX Dashboard."),(0,i.kt)("p",null,"You can find the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-dashboard")," service from the application load-services page. Since we have enabled NodePort for Dashboard in the application configuration, you can access Dashboard directly through the NodePort port here."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241699353-8d54dfe9-8439-4085-8e7d-02583a1d0d9e.png",alt:"Dahboard view"})),(0,i.kt)("p",null,"Log in to the Apache APISIX Dashboard with the default user name and password ",(0,i.kt)("inlineCode",{parentName:"p"},"admin"),", and you can enter the System Information page to view the information of Apache APISIX nodes currently connected to management."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241703083-0915a427-9aab-41e6-8c76-be60d70fc135.png",alt:"Enter name and password"})),(0,i.kt)("h3",{id:"how-to-use"},"How to use"),(0,i.kt)("p",null,'Next, let\'s go back to the "Apply Routes" page, create another route (e.g. ',(0,i.kt)("inlineCode",{parentName:"p"},"apisix-httpbin"),"), set the path to ",(0,i.kt)("inlineCode",{parentName:"p"},"/*")," ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin")," ",(0,i.kt)("inlineCode",{parentName:"p"},"80")," and add the key ",(0,i.kt)("inlineCode",{parentName:"p"},"kubernetes.io/ingress.class"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix")," to it."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241705123-6fe3ba11-bc08-4fb2-a8b1-73066ce73679.png",alt:"Create route"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241706790-3989c06d-c803-4c16-869a-6fa000b5744b.png",alt:"Setting details"})),(0,i.kt)("h4",{id:"verify-that-the-application-route-is-effective"},"Verify that the application route is effective"),(0,i.kt)("p",null,'Go back to the Apache APISIX Dashboard and enter the "Routes" page. You can see that the newly created application route has been recognized by the Apache APISIX Ingress Controller and automatically added to the Apache APISIX gateway, and you can also see an automatically created upstream entry in the "Upstream" page.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241712811-db1f93dd-2963-4034-b461-26733d173bae.png",alt:"Verify route is effective"})),(0,i.kt)("p",null,"Next, go back to the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-system"),' project "Services" page, find the port corresponding to the ',(0,i.kt)("inlineCode",{parentName:"p"},"apisix-gateway")," service, and access ",(0,i.kt)("inlineCode",{parentName:"p"},"<apisix-httpbin application routing domain name>:<apisix-gateway external access port>")," (for example, ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin.ui:30408")," here) to access the backend service associated with the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-httpbin")," application route."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241716159-134e6bd8-9e08-46de-8d46-39142c439b8f.png",alt:"Service page"})),(0,i.kt)("h2",{id:"custom-monitoring-of-apache-apisix-gateways"},"Custom Monitoring of Apache APISIX Gateways"),(0,i.kt)("p",null,"Monitoring capabilities can be augmented when using the Apache APISIX gateway through the Prometheus plug-in and the custom monitoring capabilities that come with KubeSphere."),(0,i.kt)("h3",{id:"exposing-relevant-prometheus-monitoring-metrics"},"Exposing relevant Prometheus monitoring metrics"),(0,i.kt)("p",null,"Since we have already enabled the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/prometheus"},"Prometheus plugin")," when deploying the Apache APISIX application, we only need to expose the interface to the Prometheus monitoring metrics."),(0,i.kt)("p",null,"Go to the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-system"),' project, find apisix on the "Workloads" page and go to the deployment details page, then select "Edit Settings" from "More Actions" in the left action panel.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241718162-86d110b6-2c40-461c-9cf4-a13b73cf5768.png",alt:"APISIX workloads page"})),(0,i.kt)("p",null,"In the pop-up panel, go to the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix"),' container editing interface, find "Port Settings", add a new port named ',(0,i.kt)("inlineCode",{parentName:"p"},"prom")," to map to port ",(0,i.kt)("inlineCode",{parentName:"p"},"9091")," of the container, save it and the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix")," workload will restart."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241721050-c3e9409c-4ec8-4ff1-bcf8-045ea57ec179.png",alt:"APISIX container"})),(0,i.kt)("h3",{id:"creating-a-servicemonitor-for-monitoring-metrics"},"Creating a ServiceMonitor for monitoring metrics"),(0,i.kt)("p",null,"Next, we need to connect the exposed metrics interface to KubeSphere's own Prometheus to make it accessible (to grab the metrics data)."),(0,i.kt)("p",null,"Since KubeSphere maintains the internal Prometheus system through the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/prometheus-operator/prometheus-operator"},"Prometheus Operator"),", the quickest way to access the metrics is to create a ServiceMonitor resource directly."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: apisix\n  namespace: apisix-system\nspec:\n  endpoints:\n    - scheme: http\n     # [note] use the container port name exposed by the workload in the previous step\n     targetPort: prom\n     # [note] you need to bind the metric interface path corresponding to apisix correctly.\n     path: /apisix/prometheus/metrics\n      interval: 15s\n  namespaceSelector:\n    matchNames:\n      - apisix-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: apisix\n      app.kubernetes.io/version: 2.10.0\n      helm.sh/chart: apisix-0.7.2\n")),(0,i.kt)("p",null,"Create the ServiceMonitor resource using ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl apply -f your_service_monitor.yaml"),". Once created, you can also search for the ServiceMonitor resource in the cluster's CRD management page and find a custom resource named ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix"),", if you have cluster management privileges, and make subsequent YAML changes here."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241723331-64cb363e-b6af-4af4-93f3-29a79c9a5e77.png",alt:"Create ServiceMonitor"})),(0,i.kt)("h3",{id:"indicator-access-to-custom-monitoring-panel"},"Indicator access to custom monitoring panel"),(0,i.kt)("p",null,'Find "Custom Monitoring" under "Monitoring Alarms" in the menu list on the left side of the project, and start to "create" custom monitoring panels.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241724906-d9531809-4682-49b3-b90b-d7f3a03e70e3.png",alt:"Create monitor panels"})),(0,i.kt)("p",null,'Fill in "Name" in the pop-up window, select "Custom" monitoring template, and go to "Next" to create the monitoring panel.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241727938-cd3843f9-0e22-4316-91d2-84b56cd66f21.png",alt:"Setting details"})),(0,i.kt)("p",null,"After entering the edit page now click on the ",(0,i.kt)("inlineCode",{parentName:"p"},"+"),' area on the left side and configure the Prometheus monitoring metrics in the "Data" area on the right side. For example, here we can use ',(0,i.kt)("inlineCode",{parentName:"p"},"sum(apisix_nginx_http_current_connections)")," to count the total number of connections to the Apache APISIX gateway in real time."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241729416-3d2024f1-9586-44ac-ad6c-7472c8924fc8.png",alt:"Connect to APISIX gateway"})),(0,i.kt)("p",null,'After saving, find "+ Add monitoring item" in the bottom-right corner of the page and select "Line Chart" to create the Nginx connection state metric: use ',(0,i.kt)("inlineCode",{parentName:"p"},"sum(apisix_nginx_http_current_connections) by (state)")," as the metric, ",(0,i.kt)("inlineCode",{parentName:"p"},"{{state}}"),' as the legend name, and "Legend type" as the stacked graph to get a result similar to the one below. Save the template and get your first custom monitoring panel!'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241730747-298fe17e-fb34-4da6-ac9d-8b1efde4521c.png",alt:"Get custom monitoring panel"})),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The Prometheus metrics currently provided by the Apache APISIX gateway can be found in the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/zh/docs/apisix/plugins/prometheus/#%25E5%258F%25AF%25E6%259C%2589%25E7%259A%2584%25E6%258C%2587%25E6%25A0%2587"},"available metrics section")," of the official documentation.")),(0,i.kt)("p",null,"Since the metrics configuration process is a bit tricky, it is recommended to import the ",(0,i.kt)("a",{parentName:"p",href:"https://grafana.com/grafana/dashboards/11719"},"Apache APISIX Grafana template"),' directly from the cluster-level "Custom Monitoring" (download the JSON and import it via "Local Upload").'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241733535-168ce86b-6654-4278-941d-23fb44003c90.png",alt:"Import Grafana template"})),(0,i.kt)("p",null,"KubeSphere is also ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/kubesphere/kubesphere/issues/4433"},"actively working")," on introducing the Grafana template import into the project's custom monitoring capabilities, so stay tuned!"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638241735167-4c6d3a9a-8190-41b5-9e89-7f09384c7113.png",alt:"Finish work"})),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,'This article is a very detailed step-by-step guide for you to fully understand and follow along with how to "interoperate Apache APISIX Ingress gateway with KubeSphere and perform custom monitoring". We hope that reading this article will deepen your understanding of Apache APISIX Ingress Controller and Apache APISIX application.'))}d.isMDXComponent=!0}}]);