"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[80915],{35318:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>d});var n=o(27378);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),h=p(o),d=r,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||a;return o?n.createElement(m,s(s({ref:t},c),{},{components:o})):n.createElement(m,s({ref:t},c))}));function d(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,s=new Array(a);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var p=2;p<a;p++)s[p]=o[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,o)}h.displayName="MDXCreateElement"},58816:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>p});var n=o(25773),r=(o(27378),o(35318));const a={title:"Release Apache APISIX 2.14.1",authors:[{name:"Zexuan Luo",title:"Author",url:"https://github.com/spacewander",image_url:"https://avatars.githubusercontent.com/u/4161644?v=4"},{name:"Fei Han",title:"Technical Writer",url:"https://github.com/hf400159",image_url:"https://github.com/hf400159.png"}],keywords:["Apache APISIX","2.14.1","Release Notes","API Gateway","WebSocket"],description:"2.14.1 is officially released! This release supports service discovery on CP and Web Socket-based pubsub proxy and non-HTTP Layer 7 protocols.",tags:["Community"]},s=void 0,i={permalink:"/blog/2022/05/31/release-apache-apisix-2.14",source:"@site/blog/2022/05/31/release-apache-apisix-2.14.md",title:"Release Apache APISIX 2.14.1",description:"2.14.1 is officially released! This release supports service discovery on CP and Web Socket-based pubsub proxy and non-HTTP Layer 7 protocols.",date:"2022-05-31T00:00:00.000Z",formattedDate:"May 31, 2022",tags:[{label:"Community",permalink:"/blog/tags/community"}],readingTime:6.58,truncated:!0,authors:[{name:"Zexuan Luo",title:"Author",url:"https://github.com/spacewander",image_url:"https://avatars.githubusercontent.com/u/4161644?v=4",imageURL:"https://avatars.githubusercontent.com/u/4161644?v=4"},{name:"Fei Han",title:"Technical Writer",url:"https://github.com/hf400159",image_url:"https://github.com/hf400159.png",imageURL:"https://github.com/hf400159.png"}],prevItem:{title:"Biweekly Report (May 16th - May 31th)",permalink:"/blog/2022/06/07/weekly-report-0607"},nextItem:{title:"Biweekly Report (May 1 - May 15)",permalink:"/blog/2022/05/19/weekly-report-0519"}},l={authorsImageUrls:[void 0,void 0]},p=[{value:"Pubsub proxy framework based on WebSocket",id:"pubsub-proxy-framework-based-on-websocket",children:[],level:2},{value:"Manage non-HTTP layer 7 protocols based on the xRPC framework",id:"manage-non-http-layer-7-protocols-based-on-the-xrpc-framework",children:[],level:2},{value:"The Control Plane supports service discovery",id:"the-control-plane-supports-service-discovery",children:[],level:2},{value:"Initial support for Istio",id:"initial-support-for-istio",children:[],level:2},{value:"More plugins and functions",id:"more-plugins-and-functions",children:[],level:2}],c={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Exploratory release - Apache APISIX 2.14.1 is officially released. This release supports not only service discovery on the control plane, but also Istio, a WebSocket-based pubsub proxy framework, and an xRPC-based framework for managing non-HTTP layer 7 protocols.")),(0,r.kt)("p",null,"It has been more than two months since the last APISIX v2.13 LTS version was released. In the past, each minor version release of APISIX will bring you new functions. However, the functions released in APISIX v2.14.1 will keep up with the forefront of technology, bringing you many exploratory new functions, and will explore the release of APISIX v3. Welcome to explore these new functions."),(0,r.kt)("p",null,"Next, let's take a look at what exploratory new features are supported by APISIX."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1653985197318-dfabcc34-29c5-4f51-a471-c37af73a3f29.png",alt:"Apache APISIX 2.14.0 Features Preview"})),(0,r.kt)("h2",{id:"pubsub-proxy-framework-based-on-websocket"},"Pubsub proxy framework based on WebSocket"),(0,r.kt)("p",null,"Before APISIX v2.14.1, whether it was proxying gRPC requests or ordinary HTTP requests, the upstream of APISIX was a docking application server, which could not meet the needs of diversified scenarios. For example, if users need to use other upstream types (such as Kafka), they can only achieve it through other means. However, in APISIX v2.14.1, APISIX has added a Websocket-based message subscription broker framework, which allows clients to subscribe to messages in a specified message queue (upstream) through APISIX. Now you can use APISIX to subscribe to Kafka messages."),(0,r.kt)("p",null,"Taking Kafka as an example, we need to configure the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X PUT \'http://127.0.0.1:9080/apisix/admin/routes/kafka\' \\\n    -H \'X-API-KEY: ${api-key}\' \\\n    -H \'Content-Type: application/json\' \\\n    -d \'{\n    "uri": "/kafka",\n    "upstream": {\n        "nodes": {\n            "kafka-server1:9092": 1,\n            "kafka-server2:9092": 1,\n            "kafka-server3:9092": 1\n        },\n        "type": "none",\n        "scheme": "kafka"\n    }\n}\'\n')),(0,r.kt)("p",null,"The above example is to add a Kafka-type upstream to the route and include multiple Brokers.\nYou can subscribe to this upstream by referring to the following steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"First, establish a connection via WebSocket."),(0,r.kt)("li",{parentName:"ol"},"Get the current offset of a Partition in Topic. The following example uses Protobuf to encode the associated request and response:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"message PubSubReq {\n    int64 sequence = 1;\n    oneof req {\n        CmdEmpty cmd_empty                       = 31;\n        CmdPing cmd_ping                         = 32;\n        CmdKafkaFetch      cmd_kafka_fetch       = 33;\n        CmdKafkaListOffset cmd_kafka_list_offset = 34;\n    };\n}\n\nmessage PubSubResp {\n    int64 sequence = 1;\n    oneof resp {\n        ErrorResp error_resp                       = 31;\n        PongResp pong_resp                         = 32;\n        KafkaFetchResp kafka_fetch_resp            = 33;\n        KafkaListOffsetResp kafka_list_offset_resp = 34;\n    };\n}\n")),(0,r.kt)("p",null,"For example, the request to get the offset is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"message CmdKafkaListOffset {\n    string topic = 1;\n    int32 partition = 2;\n    int64 timestamp = 3;\n}\n")),(0,r.kt)("p",null,"For the specific meaning of each field, please refer to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/apisix/include/apisix/model/pubsub.proto"},"pubsub.proto"),"."),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Every subsequent subscription operation can obtain the latest message according to the current offset.\nNote: After the message is successfully obtained, the current offset needs to be updated, and the updated offset is the previously returned offset + 1.")),(0,r.kt)("p",null,"For specific operations, please refer to the source code and test cases:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/blob/master/t/pubsub/kafka.t"},"kafka.t")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/blob/master/t/lib/pubsub.lua"},"pubsub.lua"))),(0,r.kt)("p",null,"Although the current Pubsub framework only provides the low-level interface, it already fulfills the two most basic requirements:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Expose Kafka service capabilities through commonly used ",(0,r.kt)("inlineCode",{parentName:"li"},"80/443")," ports, without requiring an additional layer of application server encapsulation."),(0,r.kt)("li",{parentName:"ul"},"Allows adding authentication plug-ins to add security protection to Kafka services like using a general Websocket framework.")),(0,r.kt)("p",null,"If you encounter problems during actual use, you can report to the Apache APISIX community by submitting an issue, and the community will continue to improve and enhance this function based on the feedback from users."),(0,r.kt)("h2",{id:"manage-non-http-layer-7-protocols-based-on-the-xrpc-framework"},"Manage non-HTTP layer 7 protocols based on the xRPC framework"),(0,r.kt)("p",null,"APISIX supports proxy TCP protocol in early versions, but in some scenarios, pure TCP protocol proxy cannot meet user requirements. Because some functions can only be implemented after encoding and decoding the application protocol, users need a proxy for a specific application protocol, such as Redis Proxy, Kafka Proxy, etc."),(0,r.kt)("p",null,"Beginning with APISIX v2.14.1, APISIX provides the xRPC framework, which allows developers to customize specific application protocols on the framework. Based on the xRPC framework, APISIX can provide proxy support for several major application protocols. At the same time, users can also support their own private TCP-based application protocols based on this framework, so that it has the precise granularity similar to HTTP protocol proxy and higher-level layer 7 control."),(0,r.kt)("p",null,"At present, APISIX has implemented the proxy function of Redis on the xRPC framework, which supports injecting delays and selectively recording log content according to commands. Although APISIX needs to encode and decode the Redis protocol, in a simple SET/GET performance test, using APISIX with dual worker processes as a proxy, its performance can reach 80% of the direct connection to Redis."),(0,r.kt)("p",null,"You can create a stream route that proxies the Redis protocol by referring to the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/apisix/admin/stream_routes/1 \\\n-H \'X-API-KEY: ${api-key}\' -X PUT -d \'\n{\n    "upstream": {\n        "type": "none",\n        "nodes": {\n            "127.0.0.1:6379": 1\n        }\n    },\n    "protocol": {\n        "name": "redis",\n        "conf": {\n            "faults": [{\n                "commands": ["get", "ping"],\n                "delay": 5\n            }]\n        },\n        logger = {\n            [\n                "name": "syslog",\n                "filter": [\n                    ["rpc_time", ">=", 1],\n                ],\n                "conf": {\n                    "host": "127.0.0.1",\n                    "port": 8125,\n                    "sock_type": "udp",\n                    "batch_max_size": 1,\n                    "flush_limit": 1\n                }\n            ]\n        }\n    }\n}\'\n')),(0,r.kt)("p",null,"When the command is GET or ping, there will be a 5 second delay. At the same time, after each command is executed, it will judge whether it takes more than 1 second. If so, it will trigger the corresponding ",(0,r.kt)("inlineCode",{parentName:"p"},"logger")," object and send the ",(0,r.kt)("inlineCode",{parentName:"p"},"syslog")," UDP log to ",(0,r.kt)("inlineCode",{parentName:"p"},"127.0.0.1:8125"),"."),(0,r.kt)("h2",{id:"the-control-plane-supports-service-discovery"},"The Control Plane supports service discovery"),(0,r.kt)("p",null,"Before v2.14.1, APISIX only supported service discovery on the data plane. In this case, each APISIX instance needs to obtain service discovery data, but users have reported the following problems in the actual application process:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Each APISIX instance needs to pull data from the service discovery system, which complicates the network topology."),(0,r.kt)("li",{parentName:"ol"},"Service discovery configuration needs to be configured on each APISIX instance. To change the password, you must modify the configuration file and publish it to each APISIX instance."),(0,r.kt)("li",{parentName:"ol"},"Currently, many service discovery systems do not provide Lua SDK. If you want to use these service discovery systems, you need to directly connect to the HTTP API provided by the server (if it exists).")),(0,r.kt)("p",null,"Therefore, starting from v2.14.1, APISIX will support service discovery on the control plane. Service discovery will be implemented through the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/apisix-seed/"},"APISIX-Seed")," project."),(0,r.kt)("p",null,"The principle of this function is to use ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix-seed")," to simultaneously monitor the Upstream-related resources in etcd and the corresponding upstream service resources in the service discovery component, and update the relevant Upstream information in etcd when the upstream service resources in the service discovery component change."),(0,r.kt)("p",null,"The specific implementation process is as follows:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1653983575757-97b39a39-8bd1-4e1e-b708-a7b43976c342.png",alt:"error/APISIX-Seed.png"})),(0,r.kt)("p",null,"At present, the solution of the control plane service discovery also has shortcomings, such as the greater pressure on etcd. Therefore, APISIX will keep both service discovery schemes at the same time, and prove which scheme is better through more practical applications."),(0,r.kt)("h2",{id:"initial-support-for-istio"},"Initial support for Istio"),(0,r.kt)("p",null,"In order to adapt to a wider range of application scenarios, starting from v2.14.1, APISIX will try to be compatible with Istio, and start to explore in the field of service mesh in the form of Istio as the control plane and APISIX as the Data Plane."),(0,r.kt)("p",null,"Since the configuration of Istio is issued through the xDS protocol, the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/amesh"},"Amesh")," project was developed to convert the xDS issued by Istio into the configuration of APISIX. At present, APISIX has been able to run through the official Istio Simple Bookstore App demo. In subsequent releases, APISIX will continue to expand support for xDS, bringing the capabilities of Istio and APISIX closer together."),(0,r.kt)("h2",{id:"more-plugins-and-functions"},"More plugins and functions"),(0,r.kt)("p",null,"In addition to the exploratory features mentioned above, this release also provides users with some more traditional features:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Added ",(0,r.kt)("inlineCode",{parentName:"li"},"casdoor")," plugin to improve the interaction experience with Casdoor."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"response-rewrite")," plugin has added a replacement filter for Body.")),(0,r.kt)("p",null,"For more details on feature updates and bug fixes, please refer to the official ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/CHANGELOG.md"},"Releases CHANGELOG"),"."))}u.isMDXComponent=!0}}]);