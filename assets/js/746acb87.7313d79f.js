"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[82931],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(n),u=i,k=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return n?a.createElement(k,l(l({ref:t},d),{},{components:n})):a.createElement(k,l({ref:t},d))}));function u(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,l=new Array(r);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},68946:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>s});var a=n(87462),i=(n(67294),n(3905));const r={title:"authz-keycloak",keywords:["Apache APISIX","API Gateway","Plugin","Authz Keycloak","authz-keycloak"],description:"This document contains information about the Apache APISIX authz-keycloak Plugin."},l=void 0,o={unversionedId:"plugins/authz-keycloak",id:"plugins/authz-keycloak",isDocsHomePage:!1,title:"authz-keycloak",description:"This document contains information about the Apache APISIX authz-keycloak Plugin.",source:"@site/docs/apisix/plugins/authz-keycloak.md",sourceDirName:"plugins",slug:"/plugins/authz-keycloak",permalink:"/docs/apisix/next/plugins/authz-keycloak",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/authz-keycloak.md",tags:[],version:"current",frontMatter:{title:"authz-keycloak",keywords:["Apache APISIX","API Gateway","Plugin","Authz Keycloak","authz-keycloak"],description:"This document contains information about the Apache APISIX authz-keycloak Plugin."},sidebar:"docs",previous:{title:"basic-auth",permalink:"/docs/apisix/next/plugins/basic-auth"},next:{title:"authz-casdoor",permalink:"/docs/apisix/next/plugins/authz-casdoor"}},s=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[{value:"Discovery and endpoints",id:"discovery-and-endpoints",children:[]},{value:"Client ID and secret",id:"client-id-and-secret",children:[]},{value:"Policy enforcement mode",id:"policy-enforcement-mode",children:[]},{value:"Permissions",id:"permissions",children:[]},{value:"Automatically mapping HTTP method to scope",id:"automatically-mapping-http-method-to-scope",children:[]},{value:"Generating a token using <code>password</code> grant",id:"generating-a-token-using-password-grant",children:[]}]},{value:"Enable Plugin",id:"enable-plugin",children:[]},{value:"Example usage",id:"example-usage",children:[]},{value:"Delete Plugin",id:"delete-plugin",children:[]},{value:"Plugin roadmap",id:"plugin-roadmap",children:[]}],p={toc:s};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"description"},"Description"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"authz-keycloak")," Plugin can be used to add authentication with ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/"},"Keycloak Identity Server"),"."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Although this Plugin was developed to work with Keycloak, it should work with any OAuth/OIDC and UMA compliant identity providers as well."))),(0,i.kt)("p",null,"Refer to ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/authorization_services/"},"Authorization Services Guide")," for more information on Keycloak."),(0,i.kt)("h2",{id:"attributes"},"Attributes"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Name"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Required"),(0,i.kt)("th",{parentName:"tr",align:null},"Default"),(0,i.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"discovery"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"https://host.domain/realms/foo/.well-known/uma2-configuration"},"https://host.domain/realms/foo/.well-known/uma2-configuration")),(0,i.kt)("td",{parentName:"tr",align:null},"URL to ",(0,i.kt)("a",{parentName:"td",href:"https://www.keycloak.org/docs/latest/authorization_services/index.html"},"discovery document")," of Keycloak Authorization Services.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"token_endpoint"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"https://host.domain/realms/foo/protocol/openid-connect/token"},"https://host.domain/realms/foo/protocol/openid-connect/token")),(0,i.kt)("td",{parentName:"tr",align:null},"An OAuth2-compliant token endpoint that supports the ",(0,i.kt)("inlineCode",{parentName:"td"},"urn:ietf:params:oauth:grant-type:uma-ticket")," grant type. If provided, overrides the value from discovery.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"resource_registration_endpoint"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("a",{parentName:"td",href:"https://host.domain/realms/foo/authz/protection/resource_set"},"https://host.domain/realms/foo/authz/protection/resource_set")),(0,i.kt)("td",{parentName:"tr",align:null},"A UMA-compliant resource registration endpoint. If provided, overrides the value from discovery.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"client_id"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"True"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"The identifier of the resource server to which the client is seeking access.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"client_secret"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"The client secret, if required. You can use APISIX secret to store and reference this value. APISIX currently supports storing secrets in two ways. ",(0,i.kt)("a",{parentName:"td",href:"/docs/apisix/next/terminology/secret"},"Environment Variables and HashiCorp Vault"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"grant_type"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},'"urn:ietf:params:oauth:grant-type:uma-ticket"'),(0,i.kt)("td",{parentName:"tr",align:null},'["urn:ietf:params:oauth:grant-type:uma-ticket"]'),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"policy_enforcement_mode"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},'"ENFORCING"'),(0,i.kt)("td",{parentName:"tr",align:null},'["ENFORCING", "PERMISSIVE"]'),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"permissions"),(0,i.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"An array of strings, each representing a set of one or more resources and scopes the client is seeking access.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"lazy_load_paths"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"false"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"When set to true, dynamically resolves the request URI to resource(s) using the resource registration endpoint instead of the static permission.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"http_method_as_scope"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"false"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"When set to true, maps the HTTP request type to scope of the same name and adds to all requested permissions.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"timeout"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"3000"),(0,i.kt)("td",{parentName:"tr",align:null},"[1000, ...]"),(0,i.kt)("td",{parentName:"tr",align:null},"Timeout in ms for the HTTP connection with the Identity Server.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"access_token_expires_in"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"300"),(0,i.kt)("td",{parentName:"tr",align:null},"[1, ...]"),(0,i.kt)("td",{parentName:"tr",align:null},"Expiration time(s) of the access token.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"access_token_expires_leeway"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"0"),(0,i.kt)("td",{parentName:"tr",align:null},"[0, ...]"),(0,i.kt)("td",{parentName:"tr",align:null},"Expiration leeway(s) for access_token renewal. When set, the token will be renewed access_token_expires_leeway seconds before expiration. This avoids errors in cases where the access_token just expires when reaching the OAuth Resource Server.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"refresh_token_expires_in"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"3600"),(0,i.kt)("td",{parentName:"tr",align:null},"[1, ...]"),(0,i.kt)("td",{parentName:"tr",align:null},"The expiration time(s) of the refresh token.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"refresh_token_expires_leeway"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"0"),(0,i.kt)("td",{parentName:"tr",align:null},"[0, ...]"),(0,i.kt)("td",{parentName:"tr",align:null},"Expiration leeway(s) for refresh_token renewal. When set, the token will be renewed refresh_token_expires_leeway seconds before expiration. This avoids errors in cases where the refresh_token just expires when reaching the OAuth Resource Server.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"ssl_verify"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"true"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"When set to true, verifies if TLS certificate matches hostname.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"cache_ttl_seconds"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"86400 (equivalent to 24h)"),(0,i.kt)("td",{parentName:"tr",align:null},"positive integer >= 1"),(0,i.kt)("td",{parentName:"tr",align:null},"Maximum time in seconds up to which the Plugin caches discovery documents and tokens used by the Plugin to authenticate to Keycloak.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"keepalive"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"true"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"When set to true, enables HTTP keep-alive to keep connections open after use. Set to ",(0,i.kt)("inlineCode",{parentName:"td"},"true")," if you are expecting a lot of requests to Keycloak.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"keepalive_timeout"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"60000"),(0,i.kt)("td",{parentName:"tr",align:null},"positive integer >= 1000"),(0,i.kt)("td",{parentName:"tr",align:null},"Idle time after which the established HTTP connections will be closed.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"keepalive_pool"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null},"5"),(0,i.kt)("td",{parentName:"tr",align:null},"positive integer >= 1"),(0,i.kt)("td",{parentName:"tr",align:null},"Maximum number of connections in the connection pool.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"access_denied_redirect_uri"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"[1, 2048]"),(0,i.kt)("td",{parentName:"tr",align:null},"URI to redirect the user to instead of returning an error message like ",(0,i.kt)("inlineCode",{parentName:"td"},'"error_description":"not_authorized"'),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"password_grant_token_generation_incoming_uri"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"/api/token"),(0,i.kt)("td",{parentName:"tr",align:null},"Set this to generate token using the password grant type. The Plugin will compare incoming request URI to this value.")))),(0,i.kt)("p",null,"NOTE: ",(0,i.kt)("inlineCode",{parentName:"p"},'encrypt_fields = {"client_secret"}')," is also defined in the schema, which means that the field will be stored encrypted in etcd. See ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/next/plugin-develop#encrypted-storage-fields"},"encrypted storage fields"),"."),(0,i.kt)("h3",{id:"discovery-and-endpoints"},"Discovery and endpoints"),(0,i.kt)("p",null,"It is recommended to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"discovery")," attribute as the ",(0,i.kt)("inlineCode",{parentName:"p"},"authz-keycloak")," Plugin can discover the Keycloak API endpoints from it."),(0,i.kt)("p",null,"If set, the ",(0,i.kt)("inlineCode",{parentName:"p"},"token_endpoint")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"resource_registration_endpoint")," will override the values obtained from the discovery document."),(0,i.kt)("h3",{id:"client-id-and-secret"},"Client ID and secret"),(0,i.kt)("p",null,"The Plugin needs the ",(0,i.kt)("inlineCode",{parentName:"p"},"client_id")," attribute for identification and to specify the context in which to evaluate permissions when interacting with Keycloak."),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy_load_paths")," attribute is set to true, then the Plugin additionally needs to obtain an access token for itself from Keycloak. In such cases, if the client access to Keycloak is confidential, you need to configure the ",(0,i.kt)("inlineCode",{parentName:"p"},"client_secret")," attribute."),(0,i.kt)("h3",{id:"policy-enforcement-mode"},"Policy enforcement mode"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"policy_enforcement_mode")," attribute specifies how policies are enforced when processing authorization requests sent to the server."),(0,i.kt)("h4",{id:"enforcing-mode"},(0,i.kt)("inlineCode",{parentName:"h4"},"ENFORCING")," mode"),(0,i.kt)("p",null,"Requests are denied by default even when there is no policy associated with a resource."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"policy_enforcement_mode")," is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"ENFORCING")," by default."),(0,i.kt)("h4",{id:"permissive-mode"},(0,i.kt)("inlineCode",{parentName:"h4"},"PERMISSIVE")," mode"),(0,i.kt)("p",null,"Requests are allowed when there is no policy associated with a given resource."),(0,i.kt)("h3",{id:"permissions"},"Permissions"),(0,i.kt)("p",null,"When handling incoming requests, the Plugin can determine the permissions to check with Keycloak statically or dynamically from the properties of the request."),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy_load_paths")," attribute is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),", the permissions are taken from the ",(0,i.kt)("inlineCode",{parentName:"p"},"permissions")," attribute. Each entry in ",(0,i.kt)("inlineCode",{parentName:"p"},"permissions")," needs to be formatted as expected by the token endpoint's ",(0,i.kt)("inlineCode",{parentName:"p"},"permission")," parameter. See ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/authorization_services/index.html#_service_obtaining_permissions"},"Obtaining Permissions"),"."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"A valid permission can be a single resource or a resource paired with on or more scopes."))),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy_load_paths")," attribute is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),", the request URI is resolved to one or more resources configured in Keycloak using the resource registration endpoint. The resolved resources are used as the permissions to check."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"This requires the Plugin to obtain a separate access token for itself from the token endpoint. So, make sure to set the ",(0,i.kt)("inlineCode",{parentName:"p"},"Service Accounts Enabled")," option in the client settings in Keycloak."),(0,i.kt)("p",{parentName:"div"},"Also make sure that the issued access token contains the ",(0,i.kt)("inlineCode",{parentName:"p"},"resource_access")," claim with the ",(0,i.kt)("inlineCode",{parentName:"p"},"uma_protection")," role to ensure that the Plugin is able to query resources through the Protection API."))),(0,i.kt)("h3",{id:"automatically-mapping-http-method-to-scope"},"Automatically mapping HTTP method to scope"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"http_method_as_scope")," is often used together with ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy_load_paths")," but can also be used with a static permission list."),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"http_method_as_scope")," attribute is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),", the Plugin maps the request's HTTP method to the scope with the same name. The scope is then added to every permission to check."),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy_load_paths")," attribute is set to false, the Plugin adds the mapped scope to any of the static permissions configured in the ",(0,i.kt)("inlineCode",{parentName:"p"},"permissions")," attribute\u2014even if they contain on or more scopes already."),(0,i.kt)("h3",{id:"generating-a-token-using-password-grant"},"Generating a token using ",(0,i.kt)("inlineCode",{parentName:"h3"},"password")," grant"),(0,i.kt)("p",null,"To generate a token using ",(0,i.kt)("inlineCode",{parentName:"p"},"password")," grant, you can set the value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"password_grant_token_generation_incoming_uri")," attribute."),(0,i.kt)("p",null,"If the incoming URI matches the configured attribute and the request method is POST, a token is generated using the ",(0,i.kt)("inlineCode",{parentName:"p"},"token_endpoint"),"."),(0,i.kt)("p",null,"You also need to add ",(0,i.kt)("inlineCode",{parentName:"p"},"application/x-www-form-urlencoded")," as ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Type")," header and ",(0,i.kt)("inlineCode",{parentName:"p"},"username")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"password")," as parameters."),(0,i.kt)("p",null,"The example below shows a request if the ",(0,i.kt)("inlineCode",{parentName:"p"},"password_grant_token_generation_incoming_uri")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"/api/token"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"curl --location --request POST 'http://127.0.0.1:9080/api/token' \\\n--header 'Accept: application/json, text/plain, */*' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'username=<User_Name>' \\\n--data-urlencode 'password=<Password>'\n")),(0,i.kt)("h2",{id:"enable-plugin"},"Enable Plugin"),(0,i.kt)("p",null,"The example below shows how you can enable the ",(0,i.kt)("inlineCode",{parentName:"p"},"authz-keycloak")," Plugin on a specific Route. ",(0,i.kt)("inlineCode",{parentName:"p"},"${realm}")," represents the realm name in Keycloak."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can fetch the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/5 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/get",\n    "plugins": {\n        "authz-keycloak": {\n            "token_endpoint": "http://127.0.0.1:8090/realms/${realm}/protocol/openid-connect/token",\n            "permissions": ["resource name#scope name"],\n            "client_id": "Client ID"\n        }\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:8080": 1\n        }\n    }\n}\'\n')),(0,i.kt)("h2",{id:"example-usage"},"Example usage"),(0,i.kt)("p",null,"Once you have enabled the Plugin on a Route you can use it."),(0,i.kt)("p",null,"First, you have to get the JWT token from Keycloak:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://<YOUR_KEYCLOAK_HOST>/realms/<YOUR_REALM>/protocol/openid-connect/token" \\\n  -d "client_id=<YOUR_CLIENT_ID>" \\\n  -d "client_secret=<YOUR_CLIENT_SECRET>" \\\n  -d "username=<YOUR_USERNAME>" \\\n  -d "password=<YOUR_PASSWORD>" \\\n  -d "grant_type=password"\n')),(0,i.kt)("p",null,"You should see a response similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJoT3ludlBPY2d6Y3VWWnYtTU42bXZKMUczb0dOX2d6MFo3WFl6S2FSa1NBIn0.eyJleHAiOjE3MDMyOTAyNjAsImlhdCI6MTcwMzI4OTk2MCwianRpIjoiMjJhOGFmMzItNDM5Mi00Yzg3LThkM2UtZDkyNDVmZmNiYTNmIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMS44Mzo4MDgwL3JlYWxtcy9xdWlja3N0YXJ0LXJlYWxtIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjAyZWZlY2VlLTBmYTgtNDg1OS1iYmIwLTgyMGZmZDdjMWRmYSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsInNlc3Npb25fc3RhdGUiOiI1YzIzZjVkZC1hN2ZhLTRlMmItOWQxNC02MmI1YzYyNmU1NDYiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImRlZmF1bHQtcm9sZXMtcXVpY2tzdGFydC1yZWFsbSIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6ImVtYWlsIHByb2ZpbGUiLCJzaWQiOiI1YzIzZjVkZC1hN2ZhLTRlMmItOWQxNC02MmI1YzYyNmU1NDYiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InF1aWNrc3RhcnQtdXNlciJ9.WNZQiLRleqCxw-JS-MHkqXnX_BPA9i6fyVHqF8l-L-2QxcqTAwbIp7AYKX-z90CG6EdRXOizAEkQytB32eVWXaRkLeTYCI7wIrT8XSVTJle4F88ohuBOjDfRR61yFh5k8FXXdAyRzcR7tIeE2YUFkRqw1gCT_VEsUuXPqm2wTKOmZ8fRBf4T-rP4-ZJwPkHAWc_nG21TmLOBCSulzYqoC6Lc-OvX5AHde9cfRuXx-r2HhSYs4cXtvX-ijA715MY634CQdedheoGca5yzPsJWrAlBbCruN2rdb4u5bDxKU62pJoJpmAsR7d5qYpYVA6AsANDxHLk2-W5F7I_IxqR0YQ","expires_in":300,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJjN2IwYmY4NC1kYjk0LTQ5YzctYWIyZC01NmU3ZDc1MmRkNDkifQ.eyJleHAiOjE3MDMyOTE3NjAsImlhdCI6MTcwMzI4OTk2MCwianRpIjoiYzcyZjAzMzctYmZhNS00MWEzLTlhYjEtZmJlNGY0NmZjMDgxIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMS44Mzo4MDgwL3JlYWxtcy9xdWlja3N0YXJ0LXJlYWxtIiwiYXVkIjoiaHR0cDovLzE5Mi4xNjguMS44Mzo4MDgwL3JlYWxtcy9xdWlja3N0YXJ0LXJlYWxtIiwic3ViIjoiMDJlZmVjZWUtMGZhOC00ODU5LWJiYjAtODIwZmZkN2MxZGZhIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsInNlc3Npb25fc3RhdGUiOiI1YzIzZjVkZC1hN2ZhLTRlMmItOWQxNC02MmI1YzYyNmU1NDYiLCJzY29wZSI6ImVtYWlsIHByb2ZpbGUiLCJzaWQiOiI1YzIzZjVkZC1hN2ZhLTRlMmItOWQxNC02MmI1YzYyNmU1NDYifQ.7AH7ppbVOlkYc9CoJ7kLSlDUkmFuNga28Amugn2t724","token_type":"Bearer","not-before-policy":0,"session_state":"5c23f5dd-a7fa-4e2b-9d14-62b5c626e546","scope":"email profile"}\n')),(0,i.kt)("p",null,"Now you can make requests with the access token:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"curl http://127.0.0.1:9080/get -H 'Authorization: Bearer ${ACCESS_TOKEN}'\n")),(0,i.kt)("p",null,"To learn more about how you can integrate authorization policies into your API workflows you can checkout the unit test ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/t/plugin/authz-keycloak.t"},"authz-keycloak.t"),"."),(0,i.kt)("p",null,"Run the following Docker image and go to ",(0,i.kt)("inlineCode",{parentName:"p"},"http://localhost:8090")," to view the associated policies for the unit tests."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=123456 -p 8090:8080 sshniro/keycloak-apisix\n")),(0,i.kt)("p",null,"The image below shows how the policies are configured in the Keycloak server:"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/apache/apisix/master/docs/assets/images/plugin/authz-keycloak.png",alt:"Keycloak policy design"})),(0,i.kt)("h2",{id:"delete-plugin"},"Delete Plugin"),(0,i.kt)("p",null,"To remove the ",(0,i.kt)("inlineCode",{parentName:"p"},"authz-keycloak")," Plugin, you can delete the corresponding JSON configuration from the Plugin configuration. APISIX will automatically reload and you do not have to restart for this to take effect."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/5 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/get",\n    "plugins": {\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:8080": 1\n        }\n    }\n}\'\n')),(0,i.kt)("h2",{id:"plugin-roadmap"},"Plugin roadmap"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Currently, the ",(0,i.kt)("inlineCode",{parentName:"p"},"authz-keycloak")," Plugin requires you to define the resource name and the required scopes to enforce policies for a Route. Keycloak's official adapted (Java, Javascript) provides path matching by querying Keycloak paths dynamically and lazy loading the paths to identity resources. Upcoming releases of the Plugin will support this function.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To support reading scope and configurations from the Keycloak JSON file."))))}d.isMDXComponent=!0}}]);