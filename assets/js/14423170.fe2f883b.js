"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[46621],{35318:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),g=i,h=d["".concat(s,".").concat(g)]||d[g]||p[g]||r;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},65094:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=n(25773),i=(n(27378),n(35318));const r={title:"360 Built Unified L7 Load Balancer Using Apache APISIX",authors:[{name:"360 ZYUN Cloud",title:"Author"},{name:"Yilia Lin",title:"Technical Writer",url:"https://github.com/Yilialinn",image_url:"https://github.com/Yilialinn.png"}],keywords:["open source","API gateway","Apache APISIX",360,"L7 load balancing","API gateway use case"],description:"360 unifies Layer 7 load balancing using APISIX, gaining VPC, cloud-native, and fine-grained routing in one seamless upgrade.",tags:["Case Studies"],image:"https://static.api7.ai/uploads/2025/09/05/SWaSLAns_360-zyun-cloud-use-case.webp"},o=void 0,l={permalink:"/blog/2025/09/03/360-built-unified-l7-load-balancer-with-apisix",source:"@site/blog/2025/09/03/360-built-unified-l7-load-balancer-with-apisix.md",title:"360 Built Unified L7 Load Balancer Using Apache APISIX",description:"360 unifies Layer 7 load balancing using APISIX, gaining VPC, cloud-native, and fine-grained routing in one seamless upgrade.",date:"2025-09-03T00:00:00.000Z",formattedDate:"September 3, 2025",tags:[{label:"Case Studies",permalink:"/blog/tags/case-studies"}],readingTime:4.96,truncated:!0,authors:[{name:"360 ZYUN Cloud",title:"Author"},{name:"Yilia Lin",title:"Technical Writer",url:"https://github.com/Yilialinn",image_url:"https://github.com/Yilialinn.png",imageURL:"https://github.com/Yilialinn.png"}],prevItem:{title:"2025 Monthly Report (September 01 - September 30)",permalink:"/blog/2025/09/30/2025-sep-monthly-report"},nextItem:{title:"2025 Monthly Report (August 01 - August 31)",permalink:"/blog/2025/08/31/2025-august-monthly-report"}},s={authorsImageUrls:[void 0,void 0]},c=[{value:"About 360 and 360 ZYUN Cloud",id:"about-360-and-360-zyun-cloud",children:[],level:2},{value:"Project Background",id:"project-background",children:[],level:2},{value:"Service Architecture Design",id:"service-architecture-design",children:[{value:"1. Overall Architecture",id:"1-overall-architecture",children:[],level:3},{value:"2. Service Deployment Architecture",id:"2-service-deployment-architecture",children:[],level:3},{value:"Traffic Path",id:"traffic-path",children:[],level:3},{value:"Conclusion &amp; Future Outlook",id:"conclusion--future-outlook",children:[],level:3}],level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"360 unifies Layer 7 load balancing using APISIX, gaining VPC, cloud-native, and fine-grained routing in one seamless upgrade.")),(0,i.kt)("h2",{id:"about-360-and-360-zyun-cloud"},"About 360 and 360 ZYUN Cloud"),(0,i.kt)("p",null,"360 Security Technology Inc., also branded as ",(0,i.kt)("a",{parentName:"p",href:"https://www.linkedin.com/company/qihoo-360/"},"Qihoo 360"),", is a leading Internet and security technology enterprise and the first advocate of free Internet security in China. In the wave of AI, it is committed to helping industries and organizations achieve intelligent digital transformation."),(0,i.kt)("p",null,"360 ZYUN Cloud is the intelligent data cloud foundation of 360, offering a wide range of products and services, including databases, middleware, storage, big data, artificial intelligence, computing, networking, video, and IoT integration, and communications, as well as one-stop solutions."),(0,i.kt)("p",null,'Positioned as an open enterprise application service platform with the mission of "aggregating the value of data and enabling an intelligent future," 360 ZYUN Cloud provides robust products and technical services for businesses and applications across industries, helping enterprises and organizations unlock greater commercial value.'),(0,i.kt)("h2",{id:"project-background"},"Project Background"),(0,i.kt)("p",null,"Layer 7 (L7) load balancing, which operates at the application layer of the OSI model, provides deep inspection of protocols like HTTP/HTTPS and supports a rich set of advanced routing rules. Unlike Layer 4 (L4) load balancing, which only considers IP addresses and ports, L7 load balancing understands application-layer content, enabling far more granular traffic control."),(0,i.kt)("p",null,"Our existing internal L7 load-balancing system at 360 faced two critical limitations:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"It was built for traditional data center infrastructure and did not support Virtual Private Clouds (VPCs), making it unable to meet the needs of our cloud-based tenants."),(0,i.kt)("li",{parentName:"ol"},"While it supported bare-metal and virtual machine backends, it was not designed for modern, cloud-native workloads such as containers.")),(0,i.kt)("p",null,"To overcome these challenges, we initiated the Unified L7 Load Balancing project. The goal was to build a single, comprehensive load balancing service that supports a hybrid network architecture and can route traffic to diverse backend instance types."),(0,i.kt)("p",null,"The core features required for this new service were:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Intelligent Routing:")," Fine-grained traffic routing by parsing HTTP headers (",(0,i.kt)("inlineCode",{parentName:"li"},"User-Agent"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Cookie"),"), URL paths, and other parameters."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Session Persistence:")," Ensuring user requests are consistently directed to the same backend server by injecting cookies or generating session IDs."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Active Health Checks:")," Proactively monitoring the health of backend upstreams to prevent requests from being sent to unhealthy instances."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Dynamic Configuration (Hot Reloading):")," Allowing configuration changes to take effect in real-time without service interruptions, simplifying maintenance."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"High Availability (HA):")," Ensuring instance reliability through cluster-based failover, session persistence, and multi-AZ deployments.")),(0,i.kt)("h2",{id:"service-architecture-design"},"Service Architecture Design"),(0,i.kt)("h3",{id:"1-overall-architecture"},"1. Overall Architecture"),(0,i.kt)("p",null,"The unified L7 load balancing architecture is composed of two main components: a ",(0,i.kt)("strong",{parentName:"p"},"control plane")," and a ",(0,i.kt)("strong",{parentName:"p"},"data plane"),"."),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"control plane")," is responsible for configuration management. In addition to our existing ",(0,i.kt)("inlineCode",{parentName:"p"},"LBC-API")," (shared by L4 and L7), we integrated the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix admin API")," for managing L7 rules. We use an ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd")," cluster as the configuration store; its millisecond-level notification mechanism enables real-time configuration updates, which is ideal for scalable, containerized environments. In VPC scenarios, the control plane assigns a unique internal IP to each upstream to mask its real VPC IP address."),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"data plane")," is the component that processes client requests and forwards user traffic. It is stateless but supports a wide range of functions, including authentication, SSL/TLS offloading, logging, and observability. For VPC traffic, the data plane integrates with our FNAT gateway's forwarding logic. Using the mapping between the unique internal IP and the real VPC IP, it encapsulates traffic in ",(0,i.kt)("strong",{parentName:"p"},"VXLAN")," packets before sending them to the host machine where the upstream instance is running."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2025/09/04/yXqvnBrv_2.1-en.webp",alt:"360 L7 Load Balancing Architecture"})),(0,i.kt)("p",null,"L7 resources (e.g., ",(0,i.kt)("inlineCode",{parentName:"p"},"service"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"route"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"upstream"),") are managed via calls to the internal ",(0,i.kt)("inlineCode",{parentName:"p"},"LBC-API"),". The workflow is as follows:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The API then calls the ",(0,i.kt)("inlineCode",{parentName:"li"},"apisix admin API")," to persist the configuration into the ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd")," cluster."),(0,i.kt)("li",{parentName:"ol"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"LBC-AGENT")," process listens for changes in ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd")," and applies VPC IP mapping configurations to the FNAT data plane."),(0,i.kt)("li",{parentName:"ol"},"The APISIX data plane nodes also listen for changes in ",(0,i.kt)("inlineCode",{parentName:"li"},"etcd"),", allowing new L7 routing rules to take effect dynamically."),(0,i.kt)("li",{parentName:"ol"},"Traffic from our on-prem data center (IDC) is forwarded directly to its destination IP, while traffic destined for VPCs is encapsulated and forwarded to its host."),(0,i.kt)("li",{parentName:"ol"},"To use the service, teams simply point their application's DNS to the corresponding Virtual IP (EIP for public services or a VPC-internal VIP).")),(0,i.kt)("h3",{id:"2-service-deployment-architecture"},"2. Service Deployment Architecture"),(0,i.kt)("p",null,"Our deployment architecture is shown in the diagram below. It has several features:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Unified Interface:"),' Our internal "Stack" platform provides a single OpenAPI for all teams, including our container cloud platform, to manage their L7 load balancing resources.'),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"High Availability:")," The control plane and storage are deployed at a regional level. The data plane is deployed in a clustered mode within each Availability Zone (AZ), ensuring that if one server fails, requests are automatically redirected to other nodes in the cluster."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Hybrid L4/L7 Deployment:")," We reuse existing L4 capabilities, which reduces development overhead and creates a seamless hybrid infrastructure.")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2025/09/04/vAoZwckf_2.2-en.webp",alt:"360 Service Deployment Architecture"})),(0,i.kt)("h3",{id:"traffic-path"},"Traffic Path"),(0,i.kt)("p",null,"Traffic flows through one of two primary paths depending on the environment:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Classic Network (On-Prem) L7 Traffic:"),"\nPublic EIP -> L4 Load Balancer (idc vip) -> ",(0,i.kt)("strong",{parentName:"li"},"L7 LB Gateway")," -> IDC-routable IP (VM, pod, etc.)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"VPC Cloud L7 Traffic:"),"\nPublic EIP -> L4 Load Balancer (vpc vip) -> ",(0,i.kt)("strong",{parentName:"li"},"L7 LB Gateway with VXLAN encapsulation")," -> VPC-internal IP (VM, pod, etc.)")),(0,i.kt)("p",{align:"center"},(0,i.kt)("img",{width:"500",alt:"Traffic Path Diagram",src:"https://static.api7.ai/uploads/2025/09/04/zO2tt4qq_3.1-en.webp"})),(0,i.kt)("h3",{id:"conclusion--future-outlook"},"Conclusion & Future Outlook"),(0,i.kt)("p",null,"The unified Layer-7 load balancing service has now been fully launched across all three regions within 360, and container services have also been adapted."),(0,i.kt)("p",null,"At present, the unified Layer-7 load balancing only supports relatively basic features, with more functional enhancements planned, such as SSL offloading optimization, supporting forwarding rules with redirect, traffic mirroring, and support for additional protocol types. It is gradually evolving toward intelligence, transforming from a simple traffic distribution tool into an intelligent scheduling hub."))}p.isMDXComponent=!0}}]);