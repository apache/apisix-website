"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[41349],{35318:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>d});var r=a(27378);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),p=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=p(a),d=n,m=h["".concat(s,".").concat(d)]||h[d]||u[d]||o;return a?r.createElement(m,i(i({ref:t},c),{},{components:a})):r.createElement(m,i({ref:t},c))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}h.displayName="MDXCreateElement"},86034:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=a(25773),n=(a(27378),a(35318));const o={title:"Hardening Apache APISIX with the OWASP's Coraza and Core Ruleset",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["APISIX","OWASP","Coraza"],description:"The Open Worldwide Application Security Project is an online community that produces freely available articles, methodologies, documentation, tools, and technologies in the fields of IoT, system software and web application security. The OWASP provides free and open resources. It is led by a non-profit called The OWASP Foundation. The OWASP Top 10 - 2021 is the published result of recent research based on comprehensive data compiled from over 40 partner organizations. The OWASP regularly publishes a Top 10 vulnerability report. The report targets vulnerabilities in web applications. In this post, I'd like to describe how to fix some of them via the Apache APISIX API Gateway.\n",tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2024/02/10/vVlFQu7C_img-HDlf4Xx9m1iqS0Ico3oBZ.png"},i=void 0,l={permalink:"/blog/2024/02/13/apisix-owasp-coraza-core-ruleset",source:"@site/blog/2024/02/13/apisix-owasp-coraza-core-ruleset.md",title:"Hardening Apache APISIX with the OWASP's Coraza and Core Ruleset",description:"The Open Worldwide Application Security Project is an online community that produces freely available articles, methodologies, documentation, tools, and technologies in the fields of IoT, system software and web application security. The OWASP provides free and open resources. It is led by a non-profit called The OWASP Foundation. The OWASP Top 10 - 2021 is the published result of recent research based on comprehensive data compiled from over 40 partner organizations. The OWASP regularly publishes a Top 10 vulnerability report. The report targets vulnerabilities in web applications. In this post, I'd like to describe how to fix some of them via the Apache APISIX API Gateway.\n",date:"2024-02-13T00:00:00.000Z",formattedDate:"February 13, 2024",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.61,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Secure your API with these 16 Practices with Apache APISIX - part 1",permalink:"/blog/2024/02/20/secure-api-practices-apisix-1"},nextItem:{title:"Unlock All-in-One Observability for APISIX with DeepFlow",permalink:"/blog/2024/02/07/unlock-observability-for-apisix-with-deepflow"}},s={authorsImageUrls:[void 0]},p=[{value:"The OWASP Top 10 2021",id:"the-owasp-top-10-2021",children:[],level:2},{value:"Nobody cares about security",id:"nobody-cares-about-security",children:[],level:2},{value:"The OWASP Core Ruleset and Coraza",id:"the-owasp-core-ruleset-and-coraza",children:[],level:2},{value:"Putting it all together",id:"putting-it-all-together",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],c={toc:p};function u(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,r.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("head",null,(0,n.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/apisix-owasp-coraza-core-ruleset/"})),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"In this post, I'd like to describe how to fix some of them via the ",(0,n.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX API Gateway"),".")),(0,n.kt)("h2",{id:"the-owasp-top-10-2021"},"The OWASP Top 10 2021"),(0,n.kt)("p",null,"In 2021, the report mentions:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"A01:2021-Broken Access Control"),(0,n.kt)("li",{parentName:"ul"},"A02:2021-Cryptographic Failures"),(0,n.kt)("li",{parentName:"ul"},"A03:2021-Injection"),(0,n.kt)("li",{parentName:"ul"},"A04:2021-Insecure"),(0,n.kt)("li",{parentName:"ul"},"A05:2021-Security Misconfiguration"),(0,n.kt)("li",{parentName:"ul"},"A06:2021-Vulnerable and Outdated Components"),(0,n.kt)("li",{parentName:"ul"},"A07:2021-Identification and Authentication Failures"),(0,n.kt)("li",{parentName:"ul"},"A08:2021-Software and Data Integrity Failures"),(0,n.kt)("li",{parentName:"ul"},"A09:2021-Security Logging and Monitoring Failures"),(0,n.kt)("li",{parentName:"ul"},"A10:2021-Server-Side Request Forgery")),(0,n.kt)("p",null,"For more details, please check the complete ",(0,n.kt)("a",{parentName:"p",href:"https://owasp.org/www-project-top-ten/"},"report"),"."),(0,n.kt)("p",null,"Fixing a vulnerability depends on its exact nature. For example, fixing ",(0,n.kt)("em",{parentName:"p"},"Vulnerable and Outdated Components")," is process-driven, requiring discipline in managing versions and retiring older ones. Some, however, are technical and only require proper configuration in the reverse proxy or API Gateway, ",(0,n.kt)("em",{parentName:"p"},"e.g."),", ",(0,n.kt)("em",{parentName:"p"},"Server Side Request Forgery"),"."),(0,n.kt)("h2",{id:"nobody-cares-about-security"},"Nobody cares about security"),(0,n.kt)("p",null,"Security is a touchy subject because hardening security doesn't bring any value to the business. Career-driven managers won't care about security as they won't be able to showcase they increased the company's profit by X% on their next yearly evaluation. Unless the board considers security seriously, chances are nobody will care. For this reason, most organizations implement checkbox-based security, aka plausible deniability. If you're interested in implementing security properly, I've written some thoughts in a previous blog post: ",(0,n.kt)("a",{parentName:"p",href:"https://blog.frankel.ch/treat-security-as-risk/"},"Treat security as a risk"),"."),(0,n.kt)("p",null,"All in all, securing applications will not get a lot of budget, if any. Hence, we must be smart about it and search for an existing component. Fortunately, the OWASP offers an out-of-the-box configuration to handle the Top 10, which is fixable via a configuration named ",(0,n.kt)("strong",{parentName:"p"},"Core Rule Set"),". Unfortunately, it targets ModSecurity:"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"ModSecurity, sometimes called Modsec, is an open-source web application firewall (WAF). Originally designed as a module for the Apache HTTP Server, it has evolved to provide an array of Hypertext Transfer Protocol request and response filtering capabilities along with other security features across a number of different platforms including Apache HTTP Server, Microsoft IIS and Nginx. It is free software released under the Apache license 2.0."),(0,n.kt)("p",{parentName:"blockquote"},"--",(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/ModSecurity"},"ModSecurity on Wikipedia"))),(0,n.kt)("p",null,"While it's theoretically possible to configure Nginx via Apache APISIX configuration, there's another more straightforward way."),(0,n.kt)("h2",{id:"the-owasp-core-ruleset-and-coraza"},"The OWASP Core Ruleset and Coraza"),(0,n.kt)("p",null,"The description of the Core Ruleset is pretty relevant to our needs:"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"The OWASP\xae ModSecurity Core Rule Set (CRS) is a set of generic attack detection rules for use with ModSecurity or compatible web application firewalls. The CRS aims to protect web applications from a wide range of attacks, including the OWASP Top Ten, with a minimum of false alerts. The CRS provides protection against many common attack categories, including:"),(0,n.kt)("ul",{parentName:"blockquote"},(0,n.kt)("li",{parentName:"ul"},"SQL Injection (SQLi)"),(0,n.kt)("li",{parentName:"ul"},"Cross Site Scripting (XSS)"),(0,n.kt)("li",{parentName:"ul"},"Local File Inclusion (LFI)"),(0,n.kt)("li",{parentName:"ul"},"Remote File Inclusion (RFI)"),(0,n.kt)("li",{parentName:"ul"},"PHP Code Injection"),(0,n.kt)("li",{parentName:"ul"},"Java Code Injection"),(0,n.kt)("li",{parentName:"ul"},"HTTPoxy"),(0,n.kt)("li",{parentName:"ul"},"Shellshock"),(0,n.kt)("li",{parentName:"ul"},"Unix/Windows Shell Injection"),(0,n.kt)("li",{parentName:"ul"},"Session Fixation"),(0,n.kt)("li",{parentName:"ul"},"Scripting/Scanner/Bot Detection"),(0,n.kt)("li",{parentName:"ul"},"Metadata/Error Leakages")),(0,n.kt)("p",{parentName:"blockquote"},"--",(0,n.kt)("a",{parentName:"p",href:"https://coreruleset.org/"},"OWASP\xae ModSecurity Core Rule Set website"))),(0,n.kt)("p",null,"OWASP also provides ",(0,n.kt)("a",{parentName:"p",href:"https://coraza.io/"},"Coraza"),", a port of ModSecurity available as a Go library. ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/proxy-wasm/spec"},"Coraza Proxy Wasm")," is built on top of Coraza and implements the ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/proxy-wasm/spec"},"proxy-wasm ABI"),", which specifies a set of Wasm interfaces for proxies. Finally, Apache APISIX offers proxy-wasm integration."),(0,n.kt)("h2",{id:"putting-it-all-together"},"Putting it all together"),(0,n.kt)("p",null,"Let's sum up:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"The OWASP provides a list of the Top 10 web security vulnerabilities"),(0,n.kt)("li",{parentName:"ol"},"It implements them for ModSecurity via the Core Ruleset"),(0,n.kt)("li",{parentName:"ol"},"Coraza is a port of ModSecurity, available as a proxy-wasm implementation")),(0,n.kt)("p",null,"We can configure Apache APISIX with sane and secure defaults this way. Let's do it."),(0,n.kt)("p",null,"First things first: Coraza isn't part of the Apache APISIX distribution. Yet, it's straightforward to add it here with Docker:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-docker"},"FROM apache/apisix:3.8.0-debian\n\nENV VERSION 0.5.0                                                           #1\nENV CORAZA_FILENAME coraza-proxy-wasm-${VERSION}.zip                        #1\n\nADD https://github.com/corazawaf/coraza-proxy-wasm/releases/download/$VERSION/$CORAZA_FILENAME . #2\n\nUSER root                                                                   #3\n\nRUN <<EOF\n\n  apt-get install zip -y                                                    #4\n  unzip $CORAZA_FILENAME -d /usr/local/apisix/proxywasm\n  rm $CORAZA_FILENAME\n  apt-get remove zip -y\n  chown -R apisix:apisix /usr/local/apisix/proxywasm\n\nEOF\n\nUSER apisix                                                                 #5\n")),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Define variables for better maintainability"),(0,n.kt)("li",{parentName:"ol"},"Get the Coraza Wasm release"),(0,n.kt)("li",{parentName:"ol"},"In recent APISIX versions, the user is ",(0,n.kt)("inlineCode",{parentName:"li"},"apisix")," to harden security. As we need to install packages, we must switch to ",(0,n.kt)("inlineCode",{parentName:"li"},"root"),"."),(0,n.kt)("li",{parentName:"ol"},"Install ",(0,n.kt)("inlineCode",{parentName:"li"},"unzip")," as it's not installed, unzip the downloaded archive, remove the archive, uninstall ",(0,n.kt)("inlineCode",{parentName:"li"},"unzip"),", and change the owner of the extracted folder"),(0,n.kt)("li",{parentName:"ol"},"Switch back to user ",(0,n.kt)("inlineCode",{parentName:"li"},"apisix"))),(0,n.kt)("p",null,"The next step is configuring APISIX itself to use the Coraza Wasm plugin."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"wasm:\n  plugins:\n    - name: coraza-filter                                                   #1\n      priority: 7999                                                        #2\n      file: /usr/local/apisix/proxywasm/coraza-proxy-wasm.wasm              #3\n")),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Filter's name set in Wasm code"),(0,n.kt)("li",{parentName:"ol"},"Set the highest priority so it runs before any other plugin"),(0,n.kt)("li",{parentName:"ol"},"Path to the extracted file, see the ",(0,n.kt)("inlineCode",{parentName:"li"},"Dockerfile")," above")),(0,n.kt)("p",null,"Finally, we can assign the plugin to routes or set it as a global rule to apply to every route. I'm using static configuration:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"global_rules:\n  - id: 1\n    plugins:\n      coraza-filter:                                                        #1\n        conf:\n          directives_map:                                                   #2\n            default:\n              - SecDebugLogLevel 9                                          #3\n              - SecRuleEngine On                                            #4\n              - Include @crs-setup-conf                                     #5\n              - Include @owasp_crs/*.conf                                   #6\n          default_directives: default                                       #7\n")),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Configure the ",(0,n.kt)("inlineCode",{parentName:"li"},"coraza-filter")," plugin now that it's available"),(0,n.kt)("li",{parentName:"ol"},"Define configurations. Here, we define a single one, ",(0,n.kt)("inlineCode",{parentName:"li"},"default"),", but we could define several and use different ones in different routes"),(0,n.kt)("li",{parentName:"ol"},"Increase the log level to see what happens in logs"),(0,n.kt)("li",{parentName:"ol"},"Switch on the engine"),(0,n.kt)("li",{parentName:"ol"},"Use Coraza setup"),(0,n.kt)("li",{parentName:"ol"},"Use all rules. We could pick and choose the ones we want for more fine-grained control"),(0,n.kt)("li",{parentName:"ol"},"Use the ",(0,n.kt)("inlineCode",{parentName:"li"},"default")," configuration defined above")),(0,n.kt)("p",null,"We proceed to define routes to ",(0,n.kt)("a",{parentName:"p",href:"https://httpbin.org/"},"https://httpbin.org/")," to test our setup. Let's call the route to ",(0,n.kt)("inlineCode",{parentName:"p"},"/get"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"curl localhost:9080?user=foobar\n")),(0,n.kt)("p",null,"The response is as expected:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {\n    "user": "foobar"\n  },\n  "headers": {\n    "Accept": "*/*",\n    "Host": "localhost",\n    "User-Agent": "curl/8.4.0",\n    "X-Amzn-Trace-Id": "Root=1-65b9fa13-75900dc029e156ec764ae204",\n    "X-Forwarded-Host": "localhost"\n  },\n  "origin": "192.168.65.1, 176.153.7.175",\n  "url": "http://localhost/get?user=foobar"\n}\n')),(0,n.kt)("p",null,"Now, let's try to send JavaScript in the query string. There's no way this request is expected server-side, so our infrastructure should protect us from it."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"curl 'localhost:9080?user=<script>alert(1)<\/script>'\n")),(0,n.kt)("p",null,"The response is a 403 HTTP status code.\nIf we look at the log, we can see the following hints:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'Coraza: Warning. XSS Attack Detected via libinjection [file "@owasp_crs/REQUEST-941-APPLICATION-ATTACK-XSS.conf"]\nCoraza: Warning. NoScript XSS InjectionChecker: HTML Injection\nCoraza: Warning. Javascript method detected\nCoraza: Access denied (phase 1). Inbound Anomaly Score Exceeded in phase 1\n')),(0,n.kt)("p",null,"Coraza did the job!"),(0,n.kt)("h2",{id:"conclusion"},"Conclusion"),(0,n.kt)("p",null,"Most organizations don't incentivize for security. Hence, we need to be smart about it and use existing components as much as possible."),(0,n.kt)("p",null,"We can harden Apache APISIX against the OWASP Top 10 by using Coraza and the Core Ruleset."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"To go further:")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://owasp.org/www-project-top-ten/"},"OWASP Security Top 10")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://coreruleset.org/"},"OWASP ModSecurity Core Ruleset")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://coraza.io/"},"OWASP Coraza WAF")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://docs.api7.ai/apisix/how-to-guide/security/waf/integrate-with-coraza"},"APISIX - Integrate with Coraza"))),(0,n.kt)("p",null,"The complete source code for this post can be found on ",(0,n.kt)("a",{parentName:"p",href:"https://github.com//ajavageek/apisix-coraza"},"GitHub"),"."))}u.isMDXComponent=!0}}]);