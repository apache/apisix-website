"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[67451],{35318:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(27378);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=p(a),m=r,d=h["".concat(s,".").concat(m)]||h[m]||u[m]||o;return a?n.createElement(d,i(i({ref:t},c),{},{components:a})):n.createElement(d,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},72644:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(25773),r=(a(27378),a(35318));const o={title:"Random and fixed routes with Apache APISIX",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["APISIX","routes","split-traffic"],description:"My ideas for blog posts inevitably start to dry up after over two years at Apache APISIX. Hence, I did some triage on the [APISIX repo](https://github.com/apache/apisix/issues). I stumbled upon this one question.\n",tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2024/06/12/2XTLbwyU_tower-1897536.jpg"},i=void 0,l={permalink:"/blog/2024/06/13/fixed-routes-apisix",source:"@site/blog/2024/06/13/fixed-routes-apisix.md",title:"Random and fixed routes with Apache APISIX",description:"My ideas for blog posts inevitably start to dry up after over two years at Apache APISIX. Hence, I did some triage on the [APISIX repo](https://github.com/apache/apisix/issues). I stumbled upon this one question.\n",date:"2024-06-13T00:00:00.000Z",formattedDate:"June 13, 2024",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.52,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Monthly Report (June 01 - June 30)",permalink:"/blog/2024/06/30/monthly-report"},nextItem:{title:"Even more OpenTelemetry!",permalink:"/blog/2024/06/06/even-more-opentelemetry"}},s={authorsImageUrls:[void 0]},p=[],c={toc:p};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/fixed-routes-apisix/"})),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"My ideas for blog posts inevitably start to dry up after over two years at ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX"),". Hence, I did some triage on the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/issues"},"APISIX repo"),". I stumbled upon this one question:")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"We have a requirement to use a plugin, where we need to route the traffic on percentage basis. I'll give an example for better understanding."),(0,r.kt)("p",{parentName:"blockquote"},"We have an URL ",(0,r.kt)("a",{parentName:"p",href:"https://xyz.com/ca/fr/index.html"},"https://xyz.com/ca/fr/index.html")," where ca is country (canada) and fr is french language. Now the traffic needs to routed 10% to ",(0,r.kt)("a",{parentName:"p",href:"https://xyz.com/ca/en/index.html"},"https://xyz.com/ca/en/index.html")," and the remaining 90% to ",(0,r.kt)("a",{parentName:"p",href:"https://xyz.com/ca/fr/index.html"},"https://xyz.com/ca/fr/index.html"),". And whenever we're routing the traffic to ",(0,r.kt)("a",{parentName:"p",href:"https://xyz.com/ca/en/index.html"},"https://xyz.com/ca/en/index.html")," we need to set a cookie. So for next call, if the cookie is there, it should directly go to ",(0,r.kt)("a",{parentName:"p",href:"https://xyz.com/ca/en/index.html"},"https://xyz.com/ca/en/index.html")," else it should go via a 10:90 traffic split. What is the best possible way to achieve this ??"),(0,r.kt)("p",{parentName:"blockquote"},"-- ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/issues/11279"},"help request: Setting cookie based on a condition"))),(0,r.kt)("p",null,"The use case is interesting, and I decided to tackle it."),(0,r.kt)("p",null,"I'll rephrase the requirements first:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If no cookie is set, randomly forward the request to one of the upstreams"),(0,r.kt)("li",{parentName:"ul"},"If a cookie has been set, forward the request to the correct upstream.")),(0,r.kt)("p",null,"For easier testing:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"I change the odds from 10:90 to 50:50"),(0,r.kt)("li",{parentName:"ul"},"I use the root instead of a host plus a path")),(0,r.kt)("p",null,"Finally, I assume that the upstream sets the cookie."),(0,r.kt)("p",null,"Newcomers to Apache APISIX understand the matching algorithm very quickly: if a request matches a route's host, method, and path, forward it to the upstream set."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"routes:\n  - id: 1\n    uri: /hello\n    host: foo.com\n    methods:\n      - GET\n      - PUT\n      - POST\n    upstream_id: 1\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl --resolve foo.com:127.0.0.1 http://foo.com/hello            #1\ncurl -X POST --resolve foo.com:127.0.0.1 http://foo.com/hello    #2\ncurl -X PUT --resolve foo.com:127.0.0.1 http://foo.com/hello     #2\ncurl --resolve bar.com:127.0.0.1 http://bar.com/hello            #3\ncurl --resolve foo.com:127.0.0.1 http://foo.com/hello/john       #4\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Matches host, method as ",(0,r.kt)("inlineCode",{parentName:"li"},"curl")," defaults to ",(0,r.kt)("inlineCode",{parentName:"li"},"GET"),", and path"),(0,r.kt)("li",{parentName:"ol"},"Matches host, method, and path"),(0,r.kt)("li",{parentName:"ol"},"Doesn't match host"),(0,r.kt)("li",{parentName:"ol"},"Doesn't match path as the configured path doesn't hold a ",(0,r.kt)("inlineCode",{parentName:"li"},"*")," character")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"path")," is the only required parameter; neither ",(0,r.kt)("inlineCode",{parentName:"p"},"host")," nor ",(0,r.kt)("inlineCode",{parentName:"p"},"methods")," are. ",(0,r.kt)("inlineCode",{parentName:"p"},"host")," defaults to any host and ",(0,r.kt)("inlineCode",{parentName:"p"},"methods")," to any method."),(0,r.kt)("p",null,"Beyond these three main widespread matching parameters, others are available, ",(0,r.kt)("em",{parentName:"p"},"e.g."),", ",(0,r.kt)("inlineCode",{parentName:"p"},"remote_addrs")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"vars"),". Let's focus on the latter. The documentation on the Route API is pretty concise:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Matches based on the specified variables consistent with variables in Nginx. Takes the form ",(0,r.kt)("inlineCode",{parentName:"p"},"[[var, operator, val], [var, operator, val], ...]]"),". Note that this is case sensitive when matching a cookie name. See ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr"},"lua-resty-expr")," for more details."),(0,r.kt)("p",{parentName:"blockquote"},"-- ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/admin-api/#request-body-parameters"},"Route API"))),(0,r.kt)("p",null,"One can only understand ",(0,r.kt)("inlineCode",{parentName:"p"},"vars")," in the Router Radix Tree documentation. The Router Radix Tree powers the Apache APISIX's matching engine."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Nginx provides a variety of built-in variables that can be used to filter routes based on certain criteria. Here is an example of how to filter routes by Nginx built-in variables:"),(0,r.kt)("p",{parentName:"blockquote"},"-- ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/router-radixtree/#how-to-filter-route-by-nginx-built-in-variable"},"How to filter route by Nginx built-in variable?")),(0,r.kt)("pre",{parentName:"blockquote"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'$ curl http://127.0.0.1:9180/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -i -d \'\n{\n   "uri": "/index.html",\n   "vars": [\n       ["http_host", "==", "iresty.com"],\n       ["cookie_device_id", "==", "a66f0cdc4ba2df8c096f74c9110163a9"],\n       ["arg_name", "==", "json"],\n       ["arg_age", ">", "18"],\n       ["arg_address", "~~", "China.*"]\n   ],\n   "upstream": {\n       "type": "roundrobin",\n       "nodes": {\n           "127.0.0.1:1980": 1\n       }\n   }\n}\'\n')),(0,r.kt)("p",{parentName:"blockquote"},"This route will require the request header ",(0,r.kt)("inlineCode",{parentName:"p"},"host")," equal ",(0,r.kt)("inlineCode",{parentName:"p"},"iresty.com"),", request cookie key ",(0,r.kt)("inlineCode",{parentName:"p"},"_device_id")," equal ",(0,r.kt)("inlineCode",{parentName:"p"},"a66f0cdc4ba2df8c096f74c9110163a9"),", etc.  You can learn more at ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-radixtree#new"},"radixtree-new"),".")),(0,r.kt)("p",null,"Among all Nginx variables, we can find ",(0,r.kt)("inlineCode",{parentName:"p"},"$cookie_xxx"),". Hence, we can come up with the following configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'routes:\n  - name: Check for French cookie\n    uri: /\n    vars: [[ "cookie_site", "==", "fr" ]]             #1\n    upstream_id: 1\n  - name: Check for English cookie\n    uri: /\n    vars: [[ "cookie_site", "==", "en" ]]             #2\n    upstream_id: 2\n')),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Match if a cookie named ",(0,r.kt)("inlineCode",{parentName:"li"},"site")," has value ",(0,r.kt)("inlineCode",{parentName:"li"},"fr")),(0,r.kt)("li",{parentName:"ol"},"Match if a cookie named ",(0,r.kt)("inlineCode",{parentName:"li"},"site")," has value ",(0,r.kt)("inlineCode",{parentName:"li"},"en"))),(0,r.kt)("p",null,"We need to configure the final route, the one used when no cookie is set. We use the ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," plugin to assign a route randomly."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin can be used to dynamically direct portions of traffic to various Upstream services."),(0,r.kt)("p",{parentName:"blockquote"},"This is done by configuring ",(0,r.kt)("inlineCode",{parentName:"p"},"match"),", which are custom rules for splitting traffic, and ",(0,r.kt)("inlineCode",{parentName:"p"},"weighted_upstreams")," which is a set of Upstreams to direct traffic to."),(0,r.kt)("p",{parentName:"blockquote"},"When a request is matched based on the ",(0,r.kt)("inlineCode",{parentName:"p"},"match")," attribute configuration, it will be directed to the Upstreams based on their configured ",(0,r.kt)("inlineCode",{parentName:"p"},"weights"),". You can also omit using the ",(0,r.kt)("inlineCode",{parentName:"p"},"match")," attribute and direct all traffic based on ",(0,r.kt)("inlineCode",{parentName:"p"},"weighted_upstreams"),"."),(0,r.kt)("p",{parentName:"blockquote"},"-- ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/traffic-split/"},"traffic-split"))),(0,r.kt)("p",null,"The third route is the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"  - name: Let the fate decide\n    uri: /\n    upstream_id: 1                                    #1\n    plugins:\n      traffic-split:\n        rules:\n          - weighted_upstreams:\n              - weight: 50                            #1\n              - upstream_id: 2                        #2\n                weight: 50                            #2\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The weight of the upstream ",(0,r.kt)("inlineCode",{parentName:"li"},"1")," is ",(0,r.kt)("inlineCode",{parentName:"li"},"50")),(0,r.kt)("li",{parentName:"ol"},"The upstream ",(0,r.kt)("inlineCode",{parentName:"li"},"2")," weight is also ",(0,r.kt)("inlineCode",{parentName:"li"},"50")," out of the total weight sum. It's a half-half chance of APISIX forwarding it to either upstream")),(0,r.kt)("p",null,"At this point, we need to solve one remaining issue: the order in which APISIX will evaluate the routes. When routes' paths are disjoint, the order plays no role; when they are overlapping, it does."),(0,r.kt)("p",null,"For example, if APISIX evaluates the last route first, it will forward the request to a random upstream, even though a cookie might have been set. We need to force the evaluation of the first two routes first. For that, APISIX offers the ",(0,r.kt)("inlineCode",{parentName:"p"},"priority")," parameter; its value is ",(0,r.kt)("inlineCode",{parentName:"p"},"0")," by default. It evaluates routes matching by order of decreasing priority. We need to override it to evaluate the random route last."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"  - name: Let the fate decide\n    uri: /\n    upstream_id: 1\n    priority: -1\n#...\n")),(0,r.kt)("p",null,"You can try the setup in a browser or with ",(0,r.kt)("inlineCode",{parentName:"p"},"curl"),'. With curl, we can set the "first" request like this:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -v localhost:9080\n")),(0,r.kt)("p",null,"If the upstream sets the cookie correctly, you should see the following line among the different response headers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"Set-Cookie: site=fr\n")),(0,r.kt)("p",null,"Since curl doesn't store cookies by default, the value should change across several calls. If we set the cookie, the value stays constant:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -v --cookie 'site=en' localhost:9080                  #1\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The cookie name is case-sensitive; beware")),(0,r.kt)("p",null,"The browser keeps the cookie, so it's even simpler. Just go to <http:localhost:9080> and refresh several times: the content is the same as well. The content will change if you change the cookie to another possible value and request again."),(0,r.kt)("p",null,"The complete source code for this post can be found on ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/fixed-route-apisix"},"GitHub"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To go further:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/issues/11279"},"Setting cookie based on a condition")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/router-radixtree/"},"router-radixtree")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/admin-api/#route-api"},"Route Admin API"))))}u.isMDXComponent=!0}}]);