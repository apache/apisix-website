"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[71419],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),d=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=d(n),c=r,k=m["".concat(o,".").concat(c)]||m[c]||u[c]||l;return n?a.createElement(k,i(i({ref:t},p),{},{components:n})):a.createElement(k,i({ref:t},p))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var d=2;d<l;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},40985:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>o});var a=n(87462),r=(n(67294),n(3905));const l={title:"limit-conn",keywords:["Apache APISIX","API Gateway","Limit Connection"],description:"The limit-conn plugin restricts the rate of requests by managing concurrent connections. Requests exceeding the threshold may be delayed or rejected, ensuring controlled API usage and preventing overload."},i=void 0,s={unversionedId:"plugins/limit-conn",id:"version-3.12/plugins/limit-conn",isDocsHomePage:!1,title:"limit-conn",description:"The limit-conn plugin restricts the rate of requests by managing concurrent connections. Requests exceeding the threshold may be delayed or rejected, ensuring controlled API usage and preventing overload.",source:"@site/docs-apisix_versioned_docs/version-3.12/plugins/limit-conn.md",sourceDirName:"plugins",slug:"/plugins/limit-conn",permalink:"/docs/apisix/3.12/plugins/limit-conn",editUrl:"/edit#https://github.com/apache/apisix/edit/release/3.12/docs/en/latest/plugins/limit-conn.md",tags:[],version:"3.12",frontMatter:{title:"limit-conn",keywords:["Apache APISIX","API Gateway","Limit Connection"],description:"The limit-conn plugin restricts the rate of requests by managing concurrent connections. Requests exceeding the threshold may be delayed or rejected, ensuring controlled API usage and preventing overload."},sidebar:"version-3.12/docs",previous:{title:"limit-req",permalink:"/docs/apisix/3.12/plugins/limit-req"},next:{title:"limit-count",permalink:"/docs/apisix/3.12/plugins/limit-count"}},o=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Apply Rate Limiting by Remote Address",id:"apply-rate-limiting-by-remote-address",children:[]},{value:"Apply Rate Limiting by Remote Address and Consumer Name",id:"apply-rate-limiting-by-remote-address-and-consumer-name",children:[]},{value:"Rate Limit WebSocket Connections",id:"rate-limit-websocket-connections",children:[]},{value:"Share Quota Among APISIX Nodes with a Redis Server",id:"share-quota-among-apisix-nodes-with-a-redis-server",children:[]},{value:"Share Quota Among APISIX Nodes with a Redis Cluster",id:"share-quota-among-apisix-nodes-with-a-redis-cluster",children:[]}]}],d={toc:o};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/limit-conn"})),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugin limits the rate of requests by the number of concurrent connections. Requests exceeding the threshold will be delayed or rejected based on the configuration, ensuring controlled resource usage and preventing overload."),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"conn"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"> 0"),(0,r.kt)("td",{parentName:"tr",align:null},"The maximum number of concurrent requests allowed. Requests exceeding the configured limit and below ",(0,r.kt)("inlineCode",{parentName:"td"},"conn + burst")," will be delayed.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"burst"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},">= 0"),(0,r.kt)("td",{parentName:"tr",align:null},"The number of excessive concurrent requests allowed to be delayed per second. Requests exceeding the limit will be rejected immediately.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"default_conn_delay"),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"> 0"),(0,r.kt)("td",{parentName:"tr",align:null},"Processing latency allowed in seconds for concurrent requests exceeding ",(0,r.kt)("inlineCode",{parentName:"td"},"conn + burst"),", which can be dynamically adjusted based on ",(0,r.kt)("inlineCode",{parentName:"td"},"only_use_default_delay")," setting.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"only_use_default_delay"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If false, delay requests proportionally based on how much they exceed the ",(0,r.kt)("inlineCode",{parentName:"td"},"conn")," limit. The delay grows larger as congestion increases. For instance, with ",(0,r.kt)("inlineCode",{parentName:"td"},"conn")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"5"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"burst")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"3"),", and ",(0,r.kt)("inlineCode",{parentName:"td"},"default_conn_delay")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"1"),", 6 concurrent requests would result in a 1-second delay, 7 requests a 2-second delay, 8 requests a 3-second delay, and so on, until the total limit of ",(0,r.kt)("inlineCode",{parentName:"td"},"conn + burst")," is reached, beyond which requests are rejected. If true, use ",(0,r.kt)("inlineCode",{parentName:"td"},"default_conn_delay")," to delay all excessive requests within the ",(0,r.kt)("inlineCode",{parentName:"td"},"burst")," range. Requests beyond ",(0,r.kt)("inlineCode",{parentName:"td"},"conn + burst")," are rejected immediately. For instance, with ",(0,r.kt)("inlineCode",{parentName:"td"},"conn")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"5"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"burst")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"3"),", and ",(0,r.kt)("inlineCode",{parentName:"td"},"default_conn_delay")," being ",(0,r.kt)("inlineCode",{parentName:"td"},"1"),", 6, 7, or 8 concurrent requests are all delayed by exactly 1 second each.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"key_type"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"var"),(0,r.kt)("td",{parentName:"tr",align:null},'["var","var_combination"]'),(0,r.kt)("td",{parentName:"tr",align:null},"The type of key. If the ",(0,r.kt)("inlineCode",{parentName:"td"},"key_type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"var"),", the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is interpreted a variable. If the ",(0,r.kt)("inlineCode",{parentName:"td"},"key_type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"var_combination"),", the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is interpreted as a combination of variables.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"key"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"remote_addr"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The key to count requests by. If the ",(0,r.kt)("inlineCode",{parentName:"td"},"key_type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"var"),", the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is interpreted a variable. The variable does not need to be prefixed by a dollar sign (",(0,r.kt)("inlineCode",{parentName:"td"},"$"),"). If the ",(0,r.kt)("inlineCode",{parentName:"td"},"key_type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"var_combination"),", the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is interpreted as a combination of variables. All variables should be prefixed by dollar signs (",(0,r.kt)("inlineCode",{parentName:"td"},"$"),"). For example, to configure the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," to use a combination of two request headers ",(0,r.kt)("inlineCode",{parentName:"td"},"custom-a")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"custom-b"),", the ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," should be configured as ",(0,r.kt)("inlineCode",{parentName:"td"},"$http_custom_a $http_custom_b"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rejected_code"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"503"),(0,r.kt)("td",{parentName:"tr",align:null},"[200,...,599]"),(0,r.kt)("td",{parentName:"tr",align:null},"The HTTP status code returned when a request is rejected for exceeding the threshold.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rejected_msg"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"non-empty"),(0,r.kt)("td",{parentName:"tr",align:null},"The response body returned when a request is rejected for exceeding the threshold.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"allow_degradation"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, allow APISIX to continue handling requests without the Plugin when the Plugin or its dependencies become unavailable.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"policy"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"local"),(0,r.kt)("td",{parentName:"tr",align:null},'["local","redis","redis-cluster"]'),(0,r.kt)("td",{parentName:"tr",align:null},"The policy for rate limiting counter. If it is ",(0,r.kt)("inlineCode",{parentName:"td"},"local"),", the counter is stored in memory locally. If it is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),", the counter is stored on a Redis instance. If it is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis-cluster"),", the counter is stored in a Redis cluster.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_host"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The address of the Redis node. Required when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_port"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"6379"),(0,r.kt)("td",{parentName:"tr",align:null},"[1,...]"),(0,r.kt)("td",{parentName:"tr",align:null},"The port of the Redis node when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_username"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The username for Redis if Redis ACL is used. If you use the legacy authentication method ",(0,r.kt)("inlineCode",{parentName:"td"},"requirepass"),", configure only the ",(0,r.kt)("inlineCode",{parentName:"td"},"redis_password"),". Used when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_password"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The password of the Redis node when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis")," or ",(0,r.kt)("inlineCode",{parentName:"td"},"redis-cluster"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_ssl"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, use SSL to connect to Redis cluster when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, verify the server SSL certificate when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_database"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},">= 0"),(0,r.kt)("td",{parentName:"tr",align:null},"The database number in Redis when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"1000"),(0,r.kt)("td",{parentName:"tr",align:null},"[1,...]"),(0,r.kt)("td",{parentName:"tr",align:null},"The Redis timeout value in milliseconds when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis")," or ",(0,r.kt)("inlineCode",{parentName:"td"},"redis-cluster"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_cluster_nodes"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The list of the Redis cluster nodes with at least two addresses. Required when policy is redis-cluster.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_cluster_name"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"The name of the Redis cluster. Required when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis-cluster"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_cluster_ssl"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, use SSL to connect to Redis cluster when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"redis_cluster_ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, verify the server SSL certificate when ",(0,r.kt)("inlineCode",{parentName:"td"},"policy")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"redis-cluster"),".")))),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below demonstrate how you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," in different scenarios."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"apply-rate-limiting-by-remote-address"},"Apply Rate Limiting by Remote Address"),(0,r.kt)("p",null,"The following example demonstrates how to use ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," to rate limit requests by ",(0,r.kt)("inlineCode",{parentName:"p"},"remote_addr"),", with example connection and burst thresholds."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugin to allow 2 concurrent requests and 1 excessive concurrent request. Additionally:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Configure the Plugin to allow 0.1 second of processing latency for concurrent requests exceeding ",(0,r.kt)("inlineCode",{parentName:"li"},"conn + burst"),"."),(0,r.kt)("li",{parentName:"ul"},"Set the key type to ",(0,r.kt)("inlineCode",{parentName:"li"},"vars")," to interpret ",(0,r.kt)("inlineCode",{parentName:"li"},"key")," as a variable."),(0,r.kt)("li",{parentName:"ul"},"Calculate rate limiting count by request's ",(0,r.kt)("inlineCode",{parentName:"li"},"remote_address"),"."),(0,r.kt)("li",{parentName:"ul"},"Set ",(0,r.kt)("inlineCode",{parentName:"li"},"policy")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"local")," to use the local counter in memory."),(0,r.kt)("li",{parentName:"ul"},"Customize the ",(0,r.kt)("inlineCode",{parentName:"li"},"rejected_code")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"429"),".")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "limit-conn-route",\n    "uri": "/get",\n    "plugins": {\n      "limit-conn": {\n        "conn": 2,\n        "burst": 1,\n        "default_conn_delay": 0.1,\n        "key_type": "var",\n        "key": "remote_addr",\n        "policy": "local",\n        "rejected_code": 429\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send five concurrent requests to the route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'seq 1 5 | xargs -n1 -P5 bash -c \'curl -s -o /dev/null -w "Response: %{http_code}\\n" "http://127.0.0.1:9080/get"\'\n')),(0,r.kt)("p",null,"You should see responses similar to the following, where excessive requests are rejected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Response: 200\nResponse: 200\nResponse: 200\nResponse: 429\nResponse: 429\n")),(0,r.kt)("h3",{id:"apply-rate-limiting-by-remote-address-and-consumer-name"},"Apply Rate Limiting by Remote Address and Consumer Name"),(0,r.kt)("p",null,"The following example demonstrates how to use ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," to rate limit requests by a combination of variables, ",(0,r.kt)("inlineCode",{parentName:"p"},"remote_addr")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"consumer_name"),"."),(0,r.kt)("p",null,"Create a Consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "john"\n  }\'\n')),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Credential for the Consumer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/john/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-key-auth",\n    "plugins": {\n      "key-auth": {\n        "key": "john-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a second Consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"jane"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "jane"\n  }\'\n')),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Credential for the Consumer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/jane/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-jane-key-auth",\n    "plugins": {\n      "key-auth": {\n        "key": "jane-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugins, and specify in the ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugin to use a combination of variables as the rate limiting key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "limit-conn-route",\n    "uri": "/get",\n    "plugins": {\n      "key-auth": {},\n      "limit-conn": {\n        "conn": 2,\n        "burst": 1,\n        "default_conn_delay": 0.1,\n        "rejected_code": 429,\n        "key_type": "var_combination",\n        "key": "$remote_addr $consumer_name"\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send five concurrent requests as the Consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'seq 1 5 | xargs -n1 -P5 bash -c \'curl -s -o /dev/null -w "Response: %{http_code}\\n" "http://127.0.0.1:9080/get" -H "apikey: john-key"\'\n')),(0,r.kt)("p",null,"You should see responses similar to the following, where excessive requests are rejected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Response: 200\nResponse: 200\nResponse: 200\nResponse: 429\nResponse: 429\n")),(0,r.kt)("p",null,"Immediately send five concurrent requests as the Consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"jane"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'seq 1 5 | xargs -n1 -P5 bash -c \'curl -s -o /dev/null -w "Response: %{http_code}\\n" "http://127.0.0.1:9080/get" -H "apikey: jane-key"\'\n')),(0,r.kt)("p",null,"You should also see responses similar to the following, where excessive requests are rejected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Response: 200\nResponse: 200\nResponse: 200\nResponse: 429\nResponse: 429\n")),(0,r.kt)("h3",{id:"rate-limit-websocket-connections"},"Rate Limit WebSocket Connections"),(0,r.kt)("p",null,"The following example demonstrates how you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugin to limit the number of concurrent WebSocket connections."),(0,r.kt)("p",null,"Start a ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/jmalloc/echo-server"},"sample upstream WebSocket server"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker run -d \\\n  -p 8080:8080 \\\n  --name websocket-server \\\n  --network=apisix-quickstart-net \\\n  jmalloc/echo-server\n")),(0,r.kt)("p",null,"Create a Route to the server WebSocket endpoint and enable WebSocket for the route. Adjust the WebSocket server address accordingly."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "ws-route",\n  "uri": "/.ws",\n  "plugins": {\n    "limit-conn": {\n      "conn": 2,\n      "burst": 1,\n      "default_conn_delay": 0.1,\n      "key_type": "var",\n      "key": "remote_addr",\n      "rejected_code": 429\n    }\n  },\n  "enable_websocket": true,\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "websocket-server:8080": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,"Install a WebSocket client, such as ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/vi/websocat"},"websocat"),", if you have not already. Establish connection with the WebSocket server through the route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'websocat "ws://127.0.0.1:9080/.ws"\n')),(0,r.kt)("p",null,'Send a "hello" message in the terminal, you should see the WebSocket server echoes back the same message:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Request served by 1cd244052136\nhello\nhello\n")),(0,r.kt)("p",null,"Open three more terminal sessions and run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'websocat "ws://127.0.0.1:9080/.ws"\n')),(0,r.kt)("p",null,"You should see the last terminal session prints ",(0,r.kt)("inlineCode",{parentName:"p"},"429 Too Many Requests")," when you try to establish a WebSocket connection with the server, due to the rate limiting effect."),(0,r.kt)("h3",{id:"share-quota-among-apisix-nodes-with-a-redis-server"},"Share Quota Among APISIX Nodes with a Redis Server"),(0,r.kt)("p",null,"The following example demonstrates the rate limiting of requests across multiple APISIX nodes with a Redis server, such that different APISIX nodes share the same rate limiting quota."),(0,r.kt)("p",null,"On each APISIX instance, create a Route  with the following configurations. Adjust the address of the Admin API, Redis host, port, password, and database accordingly."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "limit-conn-route",\n    "uri": "/get",\n    "plugins": {\n      "limit-conn": {\n        "conn": 1,\n        "burst": 1,\n        "default_conn_delay": 0.1,\n        "rejected_code": 429,\n        "key_type": "var",\n        "key": "remote_addr",\n        "policy": "redis",\n        "redis_host": "192.168.xxx.xxx",\n        "redis_port": 6379,\n        "redis_password": "p@ssw0rd",\n        "redis_database": 1\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send five concurrent requests to the route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'seq 1 5 | xargs -n1 -P5 bash -c \'curl -s -o /dev/null -w "Response: %{http_code}\\n" "http://127.0.0.1:9080/get"\'\n')),(0,r.kt)("p",null,"You should see responses similar to the following, where excessive requests are rejected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Response: 200\nResponse: 200\nResponse: 429\nResponse: 429\nResponse: 429\n")),(0,r.kt)("p",null,"This shows the two routes configured in different APISIX instances share the same quota."),(0,r.kt)("h3",{id:"share-quota-among-apisix-nodes-with-a-redis-cluster"},"Share Quota Among APISIX Nodes with a Redis Cluster"),(0,r.kt)("p",null,"You can also use a Redis cluster to apply the same quota across multiple APISIX nodes, such that different APISIX nodes share the same rate limiting quota."),(0,r.kt)("p",null,"Ensure that your Redis instances are running in ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/docs/management/scaling/#create-and-use-a-redis-cluster"},"cluster mode"),". A minimum of two nodes are required for the ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-conn")," Plugin configurations."),(0,r.kt)("p",null,"On each APISIX instance, create a Route with the following configurations. Adjust the address of the Admin API, Redis cluster nodes, password, cluster name, and SSL varification accordingly."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "limit-conn-route",\n    "uri": "/get",\n    "plugins": {\n      "limit-conn": {\n        "conn": 1,\n        "burst": 1,\n        "default_conn_delay": 0.1,\n        "rejected_code": 429,\n        "key_type": "var",\n        "key": "remote_addr",\n        "policy": "redis-cluster",\n        "redis_cluster_nodes": [\n          "192.168.xxx.xxx:6379",\n          "192.168.xxx.xxx:16379"\n        ],\n        "redis_password": "p@ssw0rd",\n        "redis_cluster_name": "redis-cluster-1",\n        "redis_cluster_ssl": true\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send five concurrent requests to the route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'seq 1 5 | xargs -n1 -P5 bash -c \'curl -s -o /dev/null -w "Response: %{http_code}\\n" "http://127.0.0.1:9080/get"\'\n')),(0,r.kt)("p",null,"You should see responses similar to the following, where excessive requests are rejected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Response: 200\nResponse: 200\nResponse: 429\nResponse: 429\nResponse: 429\n")),(0,r.kt)("p",null,"This shows the two routes configured in different APISIX instances share the same quota."))}p.isMDXComponent=!0}}]);