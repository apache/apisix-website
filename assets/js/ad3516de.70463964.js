"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[73196],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=p(n),g=r,m=u["".concat(s,".").concat(g)]||u[g]||c[g]||l;return n?a.createElement(m,i(i({ref:t},d),{},{components:n})):a.createElement(m,i({ref:t},d))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},42209:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=n(87462),r=(n(67294),n(3905));const l={title:"elasticsearch-logger",keywords:["Apache APISIX","API Gateway","Plugin","Elasticsearch-logger"],description:"The elasticsearch-logger Plugin pushes request and response logs in batches to Elasticsearch and supports the customization of log formats."},i=void 0,o={unversionedId:"plugins/elasticsearch-logger",id:"plugins/elasticsearch-logger",isDocsHomePage:!1,title:"elasticsearch-logger",description:"The elasticsearch-logger Plugin pushes request and response logs in batches to Elasticsearch and supports the customization of log formats.",source:"@site/docs/apisix/plugins/elasticsearch-logger.md",sourceDirName:"plugins",slug:"/plugins/elasticsearch-logger",permalink:"/docs/apisix/next/plugins/elasticsearch-logger",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/elasticsearch-logger.md",tags:[],version:"current",frontMatter:{title:"elasticsearch-logger",keywords:["Apache APISIX","API Gateway","Plugin","Elasticsearch-logger"],description:"The elasticsearch-logger Plugin pushes request and response logs in batches to Elasticsearch and supports the customization of log formats."},sidebar:"docs",previous:{title:"loggly",permalink:"/docs/apisix/next/plugins/loggly"},next:{title:"tencent-cloud-cls",permalink:"/docs/apisix/next/plugins/tencent-cloud-cls"}},s=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Plugin Metadata",id:"plugin-metadata",children:[]},{value:"Examples",id:"examples",children:[{value:"Log in the Default Log Format",id:"log-in-the-default-log-format",children:[]},{value:"Log Request and Response Headers With Plugin Metadata",id:"log-request-and-response-headers-with-plugin-metadata",children:[]},{value:"Log Request Bodies Conditionally",id:"log-request-bodies-conditionally",children:[]}]}],p={toc:s};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/elasticsearch-logger"})),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," Plugin pushes request and response logs in batches to ",(0,r.kt)("a",{parentName:"p",href:"https://www.elastic.co"},"Elasticsearch")," and supports the customization of log formats. When enabled, the Plugin will serialize the request context information to ",(0,r.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#docs-bulk"},"Elasticsearch Bulk format")," and add them to the queue, before they are pushed to Elasticsearch. See ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/batch-processor"},"batch processor")," for more details."),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_addrs"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch API endpoint addresses. If multiple endpoints are configured, they will be written randomly.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"field"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch ",(0,r.kt)("inlineCode",{parentName:"td"},"field")," configuration.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"field.index"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch ",(0,r.kt)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-index-field.html#mapping-index-field"},"_index field"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"log_format"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Custom log format in key-value pairs in JSON format. Support ",(0,r.kt)("a",{parentName:"td",href:"/docs/apisix/next/apisix-variable"},"APISIX")," or ",(0,r.kt)("a",{parentName:"td",href:"http://nginx.org/en/docs/varindex.html"},"NGINX variables")," in values.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"auth"),(0,r.kt)("td",{parentName:"tr",align:null},"array"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch ",(0,r.kt)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/setting-up-authentication.html"},"authentication")," configuration.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"auth.username"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch ",(0,r.kt)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/setting-up-authentication.html"},"authentication")," username.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"auth.password"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch ",(0,r.kt)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/setting-up-authentication.html"},"authentication")," password.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"true"),(0,r.kt)("td",{parentName:"tr",align:null},"If true, perform SSL verification.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"10"),(0,r.kt)("td",{parentName:"tr",align:null},"Elasticsearch send data timeout in seconds.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"include_req_body"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null},"If true, include the request body in the log. Note that if the request body is too big to be kept in the memory, it can not be logged due to NGINX's limitations.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"include_req_body_expr"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[array]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"An array of one or more conditions in the form of ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/api7/lua-resty-expr"},"lua-resty-expr"),". Used when the ",(0,r.kt)("inlineCode",{parentName:"td"},"include_req_body")," is true. Request body would only be logged when the expressions configured here evaluate to true.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"include_resp_body"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null},"If true, include the response body in the log.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"include_resp_body_expr"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[array]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"An array of one or more conditions in the form of ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/api7/lua-resty-expr"},"lua-resty-expr"),". Used when the ",(0,r.kt)("inlineCode",{parentName:"td"},"include_resp_body")," is true. Response body would only be logged when the expressions configured here evaluate to true.")))),(0,r.kt)("p",null,"NOTE: ",(0,r.kt)("inlineCode",{parentName:"p"},'encrypt_fields = {"auth.password"}')," is also defined in the schema, which means that the field will be stored encrypted in etcd. See ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/plugin-develop#encrypted-storage-fields"},"encrypted storage fields"),"."),(0,r.kt)("p",null,"This Plugin supports using batch processors to aggregate and process entries (logs/data) in a batch. This avoids the need for frequently submitting the data. The batch processor submits data every ",(0,r.kt)("inlineCode",{parentName:"p"},"5")," seconds or when the data in the queue reaches ",(0,r.kt)("inlineCode",{parentName:"p"},"1000"),". See ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/batch-processor#configuration"},"Batch Processor")," for more information or setting your custom configuration."),(0,r.kt)("h2",{id:"plugin-metadata"},"Plugin Metadata"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"log_format"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Custom log format in key-value pairs in JSON format. Support ",(0,r.kt)("a",{parentName:"td",href:"/docs/apisix/next/apisix-variable"},"APISIX variables")," and ",(0,r.kt)("a",{parentName:"td",href:"http://nginx.org/en/docs/varindex.html"},"NGINX variables")," in values.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"max_pending_entries"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Maximum number of pending entries that can be buffered in batch processor before it starts dropping them.")))),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below demonstrate how you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," Plugin for different scenarios."),(0,r.kt)("p",null,"To follow along the examples, start an Elasticsearch instance in Docker:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'docker run -d \\\n  --name elasticsearch \\\n  --network apisix-quickstart-net \\\n  -v elasticsearch_vol:/usr/share/elasticsearch/data/ \\\n  -p 9200:9200 \\\n  -p 9300:9300 \\\n  -e ES_JAVA_OPTS="-Xms512m -Xmx512m" \\\n  -e discovery.type=single-node \\\n  -e xpack.security.enabled=false \\\n  docker.elastic.co/elasticsearch/elasticsearch:7.17.1\n')),(0,r.kt)("p",null,"Start a Kibana instance in Docker to visualize the indexed data in Elasticsearch:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'docker run -d \\\n  --name kibana \\\n  --network apisix-quickstart-net \\\n  -p 5601:5601 \\\n  -e ELASTICSEARCH_HOSTS="http://elasticsearch:9200" \\\n  docker.elastic.co/kibana/kibana:7.17.1\n')),(0,r.kt)("p",null,"If successful, you should see the Kibana dashboard on ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:5601"},"localhost:5601"),"."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the APISIX ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"log-in-the-default-log-format"},"Log in the Default Log Format"),(0,r.kt)("p",null,"The following example demonstrates how you can enable the ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," Plugin on a route, which logs client requests and responses to the Route and pushes logs to Elasticsearch."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," to configure the ",(0,r.kt)("inlineCode",{parentName:"p"},"index")," field as ",(0,r.kt)("inlineCode",{parentName:"p"},"gateway"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "elasticsearch-logger-route",\n    "uri": "/anything",\n    "plugins": {\n      "elasticsearch-logger": {\n        "endpoint_addrs": ["http://elasticsearch:9200"],\n        "field": {\n          "index": "gateway"\n        }\n      }\n    },\n    "upstream": {\n      "nodes": {\n        "httpbin.org:80": 1\n      },\n      "type": "roundrobin"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route to generate a log entry:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything"\n')),(0,r.kt)("p",null,"You should receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response."),(0,r.kt)("p",null,"Navigate to the Kibana dashboard on ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:5601"},"localhost:5601")," and under ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab, create a new index pattern ",(0,r.kt)("inlineCode",{parentName:"p"},"gateway")," to fetch the data from Elasticsearch. Once configured, navigate back to the ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab and you should see a log generated, similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "_index": "gateway",\n  "_id": "CE-JL5QBOkdYRG7kEjTJ",\n  "_version": 1,\n  "_score": 1,\n  "_source": {\n    "request": {\n      "headers": {\n        "host": "127.0.0.1:9080",\n        "accept": "*/*",\n        "user-agent": "curl/8.6.0"\n      },\n      "size": 85,\n      "querystring": {},\n      "method": "GET",\n      "url": "http://127.0.0.1:9080/anything",\n      "uri": "/anything"\n    },\n    "response": {\n      "headers": {\n        "content-type": "application/json",\n        "access-control-allow-credentials": "true",\n        "server": "APISIX/3.11.0",\n        "content-length": "390",\n        "access-control-allow-origin": "*",\n        "connection": "close",\n        "date": "Mon, 13 Jan 2025 10:18:14 GMT"\n      },\n      "status": 200,\n      "size": 618\n    },\n    "route_id": "elasticsearch-logger-route",\n    "latency": 585.00003814697,\n    "apisix_latency": 18.000038146973,\n    "upstream_latency": 567,\n    "upstream": "50.19.58.113:80",\n    "server": {\n      "hostname": "0b9a772e68f8",\n      "version": "3.11.0"\n    },\n    "service_id": "",\n    "client_ip": "192.168.65.1"\n  },\n  "fields": {\n    ...\n  }\n}\n')),(0,r.kt)("h3",{id:"log-request-and-response-headers-with-plugin-metadata"},"Log Request and Response Headers With Plugin Metadata"),(0,r.kt)("p",null,"The following example demonstrates how you can customize log format using ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/terminology/plugin-metadata"},"Plugin Metadata")," and ",(0,r.kt)("a",{parentName:"p",href:"http://nginx.org/en/docs/varindex.html"},"NGINX variables")," to log specific headers from request and response."),(0,r.kt)("p",null,"In APISIX, ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/terminology/plugin-metadata"},"Plugin Metadata")," is used to configure the common metadata fields of all Plugin instances of the same plugin. It is useful when a Plugin is enabled across multiple resources and requires a universal update to their metadata fields."),(0,r.kt)("p",null,"First, create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "elasticsearch-logger-route",\n    "uri": "/anything",\n    "plugins": {\n      "elasticsearch-logger": {\n        "endpoint_addrs": ["http://elasticsearch:9200"],\n        "field": {\n          "index": "gateway"\n      }\n    },\n    "upstream": {\n      "nodes": {\n        "httpbin.org:80": 1\n      },\n      "type": "roundrobin"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Next, configure the Plugin metadata for ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/plugin_metadata/elasticsearch-logger" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "log_format": {\n      "host": "$host",\n      "@timestamp": "$time_iso8601",\n      "client_ip": "$remote_addr",\n      "env": "$http_env",\n      "resp_content_type": "$sent_http_Content_Type"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"env")," header:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -H "env: dev"\n')),(0,r.kt)("p",null,"You should receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response."),(0,r.kt)("p",null,"Navigate to the Kibana dashboard on ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:5601"},"localhost:5601")," and under ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab, create a new index pattern ",(0,r.kt)("inlineCode",{parentName:"p"},"gateway")," to fetch the data from Elasticsearch, if you have not done so already. Once configured, navigate back to the ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab and you should see a log generated, similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "_index": "gateway",\n  "_id": "Ck-WL5QBOkdYRG7kODS0",\n  "_version": 1,\n  "_score": 1,\n  "_source": {\n    "client_ip": "192.168.65.1",\n    "route_id": "elasticsearch-logger-route",\n    "@timestamp": "2025-01-06T10:32:36+00:00",\n    "host": "127.0.0.1",\n    "resp_content_type": "application/json"\n  },\n  "fields": {\n    ...\n  }\n}\n')),(0,r.kt)("h3",{id:"log-request-bodies-conditionally"},"Log Request Bodies Conditionally"),(0,r.kt)("p",null,"The following example demonstrates how you can conditionally log request body."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch-logger")," to only log request body if the URL query string ",(0,r.kt)("inlineCode",{parentName:"p"},"log_body")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "plugins": {\n      "elasticsearch-logger": {\n        "endpoint_addrs": ["http://elasticsearch:9200"],\n        "field": {\n          "index": "gateway"\n        },\n        "include_req_body": true,\n        "include_req_body_expr": [["arg_log_body", "==", "yes"]]\n      }\n    },\n    "upstream": {\n      "nodes": {\n        "httpbin.org:80": 1\n      },\n      "type": "roundrobin"\n    },\n  "uri": "/anything",\n  "id": "elasticsearch-logger-route"\n}\'\n')),(0,r.kt)("p",null,"Send a request to the Route with an URL query string satisfying the condition:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything?log_body=yes" -X POST -d \'{"env": "dev"}\'\n')),(0,r.kt)("p",null,"You should receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response."),(0,r.kt)("p",null,"Navigate to the Kibana dashboard on ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:5601"},"localhost:5601")," and under ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab, create a new index pattern ",(0,r.kt)("inlineCode",{parentName:"p"},"gateway")," to fetch the data from Elasticsearch, if you have not done so already. Once configured, navigate back to the ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab and you should see a log generated, similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "_index": "gateway",\n  "_id": "Dk-cL5QBOkdYRG7k7DSW",\n  "_version": 1,\n  "_score": 1,\n  "_source": {\n    "request": {\n      "headers": {\n        "user-agent": "curl/8.6.0",\n        "accept": "*/*",\n        "content-length": "14",\n        "host": "127.0.0.1:9080",\n        "content-type": "application/x-www-form-urlencoded"\n      },\n      "size": 182,\n      "querystring": {\n        "log_body": "yes"\n      },\n      "body": "{\\"env\\": \\"dev\\"}",\n      "method": "POST",\n      "url": "http://127.0.0.1:9080/anything?log_body=yes",\n      "uri": "/anything?log_body=yes"\n    },\n    "start_time": 1735965595203,\n    "response": {\n      "headers": {\n        "content-type": "application/json",\n        "server": "APISIX/3.11.0",\n        "access-control-allow-credentials": "true",\n        "content-length": "548",\n        "access-control-allow-origin": "*",\n        "connection": "close",\n        "date": "Mon, 13 Jan 2025 11:02:32 GMT"\n      },\n      "status": 200,\n      "size": 776\n    },\n    "route_id": "elasticsearch-logger-route",\n    "latency": 703.9999961853,\n    "apisix_latency": 34.999996185303,\n    "upstream_latency": 669,\n    "upstream": "34.197.122.172:80",\n    "server": {\n      "hostname": "0b9a772e68f8",\n      "version": "3.11.0"\n    },\n    "service_id": "",\n    "client_ip": "192.168.65.1"\n  },\n  "fields": {\n    ...\n  }\n}\n')),(0,r.kt)("p",null,"Send a request to the Route without any URL query string:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -X POST -d \'{"env": "dev"}\'\n')),(0,r.kt)("p",null,"Navigate to the Kibana dashboard ",(0,r.kt)("strong",{parentName:"p"},"Discover")," tab and you should see a log generated, but without the request body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "_index": "gateway",\n  "_id": "EU-eL5QBOkdYRG7kUDST",\n  "_version": 1,\n  "_score": 1,\n  "_source": {\n    "request": {\n      "headers": {\n        "content-type": "application/x-www-form-urlencoded",\n        "accept": "*/*",\n        "content-length": "14",\n        "host": "127.0.0.1:9080",\n        "user-agent": "curl/8.6.0"\n      },\n      "size": 169,\n      "querystring": {},\n      "method": "POST",\n      "url": "http://127.0.0.1:9080/anything",\n      "uri": "/anything"\n    },\n    "start_time": 1735965686363,\n    "response": {\n      "headers": {\n        "content-type": "application/json",\n        "access-control-allow-credentials": "true",\n        "server": "APISIX/3.11.0",\n        "content-length": "510",\n        "access-control-allow-origin": "*",\n        "connection": "close",\n        "date": "Mon, 13 Jan 2025 11:15:54 GMT"\n      },\n      "status": 200,\n      "size": 738\n    },\n    "route_id": "elasticsearch-logger-route",\n    "latency": 680.99999427795,\n    "apisix_latency": 4.9999942779541,\n    "upstream_latency": 676,\n    "upstream": "34.197.122.172:80",\n    "server": {\n      "hostname": "0b9a772e68f8",\n      "version": "3.11.0"\n    },\n    "service_id": "",\n    "client_ip": "192.168.65.1"\n  },\n  "fields": {\n    ...\n  }\n}\n')),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If you have customized the ",(0,r.kt)("inlineCode",{parentName:"p"},"log_format")," in addition to setting ",(0,r.kt)("inlineCode",{parentName:"p"},"include_req_body")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"include_resp_body")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),", the Plugin would not include the bodies in the logs."),(0,r.kt)("p",{parentName:"div"},"As a workaround, you may be able to use the NGINX variable ",(0,r.kt)("inlineCode",{parentName:"p"},"$request_body")," in the log format, such as:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "elasticsearch-logger": {\n    ...,\n    "log_format": {"body": "$request_body"}\n  }\n}\n')))))}d.isMDXComponent=!0}}]);