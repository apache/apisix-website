"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[18736],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>h});var a=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var p=a.createContext({}),l=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=l(e.components);return a.createElement(p.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=l(t),h=i,m=d["".concat(p,".").concat(h)]||d[h]||c[h]||r;return t?a.createElement(m,o(o({ref:n},u),{},{components:t})):a.createElement(m,o({ref:n},u))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=d;var s={};for(var p in n)hasOwnProperty.call(n,p)&&(s[p]=n[p]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<r;l++)o[l]=t[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},51371:(e,n,t)=>{t.r(n),t.d(n,{contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=t(87462),i=(t(67294),t(3905));const r={title:"public-api",keywords:["Apache APISIX","API Gateway","Public API"],description:"The public-api plugin exposes an internal API endpoint, making it publicly accessible. One of the primary use cases of this plugin is to expose internal endpoints created by other plugins."},o=void 0,s={unversionedId:"plugins/public-api",id:"plugins/public-api",isDocsHomePage:!1,title:"public-api",description:"The public-api plugin exposes an internal API endpoint, making it publicly accessible. One of the primary use cases of this plugin is to expose internal endpoints created by other plugins.",source:"@site/docs/apisix/plugins/public-api.md",sourceDirName:"plugins",slug:"/plugins/public-api",permalink:"/docs/apisix/next/plugins/public-api",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/public-api.md",tags:[],version:"current",frontMatter:{title:"public-api",keywords:["Apache APISIX","API Gateway","Public API"],description:"The public-api plugin exposes an internal API endpoint, making it publicly accessible. One of the primary use cases of this plugin is to expose internal endpoints created by other plugins."},sidebar:"docs",previous:{title:"csrf",permalink:"/docs/apisix/next/plugins/csrf"},next:{title:"GM",permalink:"/docs/apisix/next/plugins/gm"}},p=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Expose Prometheus Metrics at Custom Endpoint",id:"expose-prometheus-metrics-at-custom-endpoint",children:[]},{value:"Expose Batch Requests Endpoint",id:"expose-batch-requests-endpoint",children:[]}]}],l={toc:p};function u(e){let{components:n,...t}=e;return(0,i.kt)("wrapper",(0,a.Z)({},l,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("head",null,(0,i.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/public-api"})),(0,i.kt)("h2",{id:"description"},"Description"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin exposes an internal API endpoint, making it publicly accessible. One of the primary use cases of this Plugin is to expose internal endpoints created by other Plugins."),(0,i.kt)("h2",{id:"attributes"},"Attributes"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Name"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Required"),(0,i.kt)("th",{parentName:"tr",align:null},"Default"),(0,i.kt)("th",{parentName:"tr",align:null},"Valid Values"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"uri"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"False"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"Internal endpoint to expose. If not configured, expose the Route URI.")))),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("p",null,"The examples below demonstrate how you can configure ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," in different scenarios."),(0,i.kt)("h3",{id:"expose-prometheus-metrics-at-custom-endpoint"},"Expose Prometheus Metrics at Custom Endpoint"),(0,i.kt)("p",null,"The following example demonstrates how you can disable the Prometheus export server that, by default, exposes an endpoint on port ",(0,i.kt)("inlineCode",{parentName:"p"},"9091"),", and expose APISIX Prometheus metrics on a new public API endpoint on port ",(0,i.kt)("inlineCode",{parentName:"p"},"9080"),", which APISIX uses to listen to other client requests."),(0,i.kt)("p",null,"You will also configure the Route such that the internal endpoint ",(0,i.kt)("inlineCode",{parentName:"p"},"/apisix/prometheus/metrics")," is exposed at a custom endpoint."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If a large quantity of metrics is being collected, the Plugin could take up a significant amount of CPU resources for metric computations and negatively impact the processing of regular requests."),(0,i.kt)("p",{parentName:"div"},"To address this issue, APISIX uses ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/process.md#enable_privileged_agent"},"privileged agent")," and offloads the metric computations to a separate process. This optimization applies automatically if you use the metric endpoint configured under ",(0,i.kt)("inlineCode",{parentName:"p"},"plugin_attr.prometheus.export_addr")," in the configuration file. If you expose the metric endpoint with the ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin, you will not benefit from this optimization."))),(0,i.kt)("p",null,"Disable the Prometheus export server in the configuration file and reload APISIX for changes to take effect:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="conf/config.yaml"',title:'"conf/config.yaml"'},"plugin_attr:\n  prometheus:\n    enable_export_server: false\n")),(0,i.kt)("p",null,"Next, create a Route with the ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin and expose a public API endpoint for APISIX metrics. You should set the Route ",(0,i.kt)("inlineCode",{parentName:"p"},"uri")," to the custom endpoint path and set the Plugin ",(0,i.kt)("inlineCode",{parentName:"p"},"uri")," to the internal endpoint to be exposed."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "prometheus-metrics",\n    "uri": "/prometheus_metrics",\n    "plugins": {\n      "public-api": {\n        "uri": "/apisix/prometheus/metrics"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"Send a request to the custom metrics endpoint:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/prometheus_metrics"\n')),(0,i.kt)("p",null,"You should see an output similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'# HELP apisix_http_requests_total The total number of client requests since APISIX started\n# TYPE apisix_http_requests_total gauge\napisix_http_requests_total 1\n# HELP apisix_nginx_http_current_connections Number of HTTP connections\n# TYPE apisix_nginx_http_current_connections gauge\napisix_nginx_http_current_connections{state="accepted"} 1\napisix_nginx_http_current_connections{state="active"} 1\napisix_nginx_http_current_connections{state="handled"} 1\napisix_nginx_http_current_connections{state="reading"} 0\napisix_nginx_http_current_connections{state="waiting"} 0\napisix_nginx_http_current_connections{state="writing"} 1\n...\n')),(0,i.kt)("h3",{id:"expose-batch-requests-endpoint"},"Expose Batch Requests Endpoint"),(0,i.kt)("p",null,"The following example demonstrates how you can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin to expose an endpoint for the ",(0,i.kt)("inlineCode",{parentName:"p"},"batch-requests")," Plugin, which is used for assembling multiple requests into one single request before sending them to the gateway."),(0,i.kt)("p",null,"Create a sample Route to httpbin's ",(0,i.kt)("inlineCode",{parentName:"p"},"/anything")," endpoint for verification purpose:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "httpbin-anything",\n    "uri": "/anything",\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"Create a Route with ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin and set the Route ",(0,i.kt)("inlineCode",{parentName:"p"},"uri")," to the internal endpoint to be exposed:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "batch-requests",\n    "uri": "/apisix/batch-requests",\n    "plugins": {\n      "public-api": {}\n    }\n  }\'\n')),(0,i.kt)("p",null,"Send a pipelined request consisting of a GET and a POST request to the exposed batch requests endpoint:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/apisix/batch-requests" -X POST -d \'\n{\n  "pipeline": [\n    {\n      "method": "GET",\n      "path": "/anything"\n    },\n    {\n      "method": "POST",\n      "path": "/anything",\n      "body": "a post request"\n    }\n  ]\n}\'\n')),(0,i.kt)("p",null,"You should receive responses from both requests, similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  {\n    "reason": "OK",\n    "body": "{\\n  \\"args\\": {}, \\n  \\"data\\": \\"\\", \\n  \\"files\\": {}, \\n  \\"form\\": {}, \\n  \\"headers\\": {\\n    \\"Accept\\": \\"*/*\\", \\n    \\"Host\\": \\"127.0.0.1\\", \\n    \\"User-Agent\\": \\"curl/8.6.0\\", \\n    \\"X-Amzn-Trace-Id\\": \\"Root=1-67b6e33b-5a30174f5534287928c54ca9\\", \\n    \\"X-Forwarded-Host\\": \\"127.0.0.1\\"\\n  }, \\n  \\"json\\": null, \\n  \\"method\\": \\"GET\\", \\n  \\"origin\\": \\"192.168.107.1, 43.252.208.84\\", \\n  \\"url\\": \\"http://127.0.0.1/anything\\"\\n}\\n",\n    "headers": {\n      ...\n    },\n    "status": 200\n  },\n  {\n    "reason": "OK",\n    "body": "{\\n  \\"args\\": {}, \\n  \\"data\\": \\"a post request\\", \\n  \\"files\\": {}, \\n  \\"form\\": {}, \\n  \\"headers\\": {\\n    \\"Accept\\": \\"*/*\\", \\n    \\"Content-Length\\": \\"14\\", \\n    \\"Host\\": \\"127.0.0.1\\", \\n    \\"User-Agent\\": \\"curl/8.6.0\\", \\n    \\"X-Amzn-Trace-Id\\": \\"Root=1-67b6e33b-0eddcec07f154dac0d77876f\\", \\n    \\"X-Forwarded-Host\\": \\"127.0.0.1\\"\\n  }, \\n  \\"json\\": null, \\n  \\"method\\": \\"POST\\", \\n  \\"origin\\": \\"192.168.107.1, 43.252.208.84\\", \\n  \\"url\\": \\"http://127.0.0.1/anything\\"\\n}\\n",\n    "headers": {\n      ...\n    },\n    "status": 200\n  }\n]\n')),(0,i.kt)("p",null,"If you would like to expose the batch requests endpoint at a custom endpoint, create a Route with ",(0,i.kt)("inlineCode",{parentName:"p"},"public-api")," Plugin as such. You should set the Route ",(0,i.kt)("inlineCode",{parentName:"p"},"uri")," to the custom endpoint path and set the plugin ",(0,i.kt)("inlineCode",{parentName:"p"},"uri")," to the internal endpoint to be exposed."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "batch-requests",\n    "uri": "/batch-requests",\n    "plugins": {\n      "public-api": {\n        "uri": "/apisix/batch-requests"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"The batch requests endpoint should now be exposed as ",(0,i.kt)("inlineCode",{parentName:"p"},"/batch-requests"),", instead of ",(0,i.kt)("inlineCode",{parentName:"p"},"/apisix/batch-requests"),"."),(0,i.kt)("p",null,"Send a pipelined request consisting of a GET and a POST request to the exposed batch requests endpoint:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/batch-requests" -X POST -d \'\n{\n  "pipeline": [\n    {\n      "method": "GET",\n      "path": "/anything"\n    },\n    {\n      "method": "POST",\n      "path": "/anything",\n      "body": "a post request"\n    }\n  ]\n}\'\n')),(0,i.kt)("p",null,"You should receive responses from both requests, similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'[\n  {\n    "reason": "OK",\n    "body": "{\\n  \\"args\\": {}, \\n  \\"data\\": \\"\\", \\n  \\"files\\": {}, \\n  \\"form\\": {}, \\n  \\"headers\\": {\\n    \\"Accept\\": \\"*/*\\", \\n    \\"Host\\": \\"127.0.0.1\\", \\n    \\"User-Agent\\": \\"curl/8.6.0\\", \\n    \\"X-Amzn-Trace-Id\\": \\"Root=1-67b6e33b-5a30174f5534287928c54ca9\\", \\n    \\"X-Forwarded-Host\\": \\"127.0.0.1\\"\\n  }, \\n  \\"json\\": null, \\n  \\"method\\": \\"GET\\", \\n  \\"origin\\": \\"192.168.107.1, 43.252.208.84\\", \\n  \\"url\\": \\"http://127.0.0.1/anything\\"\\n}\\n",\n    "headers": {\n      ...\n    },\n    "status": 200\n  },\n  {\n    "reason": "OK",\n    "body": "{\\n  \\"args\\": {}, \\n  \\"data\\": \\"a post request\\", \\n  \\"files\\": {}, \\n  \\"form\\": {}, \\n  \\"headers\\": {\\n    \\"Accept\\": \\"*/*\\", \\n    \\"Content-Length\\": \\"14\\", \\n    \\"Host\\": \\"127.0.0.1\\", \\n    \\"User-Agent\\": \\"curl/8.6.0\\", \\n    \\"X-Amzn-Trace-Id\\": \\"Root=1-67b6e33b-0eddcec07f154dac0d77876f\\", \\n    \\"X-Forwarded-Host\\": \\"127.0.0.1\\"\\n  }, \\n  \\"json\\": null, \\n  \\"method\\": \\"POST\\", \\n  \\"origin\\": \\"192.168.107.1, 43.252.208.84\\", \\n  \\"url\\": \\"http://127.0.0.1/anything\\"\\n}\\n",\n    "headers": {\n      ...\n    },\n    "status": 200\n  }\n]\n')))}u.isMDXComponent=!0}}]);