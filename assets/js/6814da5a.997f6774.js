"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[49910],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(27378);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),g=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=g(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=g(n),d=o,h=u["".concat(s,".").concat(d)]||u[d]||p[d]||i;return n?a.createElement(h,r(r({ref:t},c),{},{components:n})):a.createElement(h,r({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var g=2;g<i;g++)r[g]=n[g];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},25320:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>g});var a=n(25773),o=(n(27378),n(35318));const i={title:"Apache APISIX Integrates with SkyWalking for Log Processing",authors:[{name:"Haochao Zhuang",title:"Author",url:"https://github.com/dmsolr",image_url:"https://avatars.githubusercontent.com/u/29735230?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4"}],keywords:["Apache APISIX","API Gateway","Apache SkyWalking","Log Process","Plugin"],description:"This paper mainly introduces two Apache APISIX integrated SkyWalking log plugins to provide a more convenient operation and environment for log processing in Apache APISIX.",tags:["Plugins","Ecosystem"],image:"https://static.apiseven.com/2022/blog/0818/plugins/skywalking.png"},r=void 0,l={permalink:"/blog/2021/12/07/apisix-integrate-skywalking-plugin",source:"@site/blog/2021/12/07/apisix-integrate-skywalking-plugin.md",title:"Apache APISIX Integrates with SkyWalking for Log Processing",description:"This paper mainly introduces two Apache APISIX integrated SkyWalking log plugins to provide a more convenient operation and environment for log processing in Apache APISIX.",date:"2021-12-07T00:00:00.000Z",formattedDate:"December 7, 2021",tags:[{label:"Plugins",permalink:"/blog/tags/plugins"},{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:6.37,truncated:!0,authors:[{name:"Haochao Zhuang",title:"Author",url:"https://github.com/dmsolr",image_url:"https://avatars.githubusercontent.com/u/29735230?v=4",imageURL:"https://avatars.githubusercontent.com/u/29735230?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4",imageURL:"https://avatars.githubusercontent.com/u/39793568?v=4"}],prevItem:{title:"API Log Monitor with Apache APISIX & RocketMQ",permalink:"/blog/2021/12/08/apisix-integrate-rocketmq-logger-plugin"},nextItem:{title:"Biweekly Report (Nov.15 - Nov.30)",permalink:"/blog/2021/12/02/weekly-report-1130"}},s={authorsImageUrls:[void 0,void 0]},g=[{value:"Feature Development Background",id:"feature-development-background",children:[],level:2},{value:"Introduction of the New Plugins",id:"introduction-of-the-new-plugins",children:[{value:"SkyWalking Logger Plugin",id:"skywalking-logger-plugin",children:[{value:"How to Use",id:"how-to-use",children:[{value:"Step 1: Create a route",id:"step-1-create-a-route",children:[],level:5},{value:"Step 2: Log Processing",id:"step-2-log-processing",children:[],level:5}],level:4}],level:3},{value:"SkyWalking Error Logger Plugin",id:"skywalking-error-logger-plugin",children:[{value:"How to Use",id:"how-to-use-1",children:[{value:"Step 1: Bind the route",id:"step-1-bind-the-route",children:[],level:5},{value:"Step 2: LAL Processing",id:"step-2-lal-processing",children:[],level:5}],level:4}],level:3}],level:2},{value:"Summary",id:"summary",children:[],level:2}],c={toc:g};function p(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"This paper mainly introduces two Apache APISIX integrated SkyWalking log plug-ins to provide a more convenient operation and environment for log processing in Apache APISIX.")),(0,o.kt)("p",null,"In the field of observability, the three main directions of data collection and analysis, Metrics, Logger and Tracing, are usually used to achieve insight into the operational status of applications."),(0,o.kt)("p",null,"Apache APISIX has integrated Apache SkyWaling Tracing capabilities as early as version 1.4, with features such as error logging and access log collection added in subsequent versions. Now with Apache SkyWalking's support for Metrics, it enables Apache APISIX to implement a one-stop observable solution in integrated mode, covering both logging, metrics and call tracing."),(0,o.kt)("h2",{id:"feature-development-background"},"Feature Development Background"),(0,o.kt)("p",null,"Those of you who are familiar with Apache APISIX should know that Apache APISIX produces two types of logs during operation, namely the access log and the error log."),(0,o.kt)("p",null,"Access logs record detailed information about each request and are logs generated within the scope of the request, so they can be directly associated with Tracing. Error logs, on the other hand, are Apache APISIX runtime output log messages, which are application-wide logs, but cannot be 100% associated with requests."),(0,o.kt)("p",null,"At present, Apache APISIX provides very rich log processing plug-ins, including TCP/HTTP/Kafka and other collection and reporting plug-ins, but they are weakly associated with Tracing. Take Apache SkyWalking as an example. We extract the SkyWalking Tracing Conetxt Header from the log records of Apache APISIX and export it to the file system, and then use the log processing framework (fluentbit) to convert the logs into a log format acceptable to SkyWalking. The Tracing Context is then parsed and extracted to obtain the Tracing ID to establish a connection with the Trace."),(0,o.kt)("p",null,"Obviously, the above way of handling the process is tedious and complicated, and requires additional conversion of log formats. For this reason, in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/pull/5550"},"PR#5500")," we have implemented the Apache SkyWalking access log into the Apache APISIX plug-in ecosystem to make it easier for users to collect and process logs using Apache SkyWalking in Apache APISIX."),(0,o.kt)("h2",{id:"introduction-of-the-new-plugins"},"Introduction of the New Plugins"),(0,o.kt)("h3",{id:"skywalking-logger-plugin"},"SkyWalking Logger Plugin"),(0,o.kt)("p",null,"The SkyWalking Logger plugin parses the SkyWalking Tracing Context Header and prints the relevant Tracing Context information to the log, thus enabling the log to be associated with the call chain."),(0,o.kt)("p",null,"By using this plug-in, Apache APISIX can get the SkyWalking Tracing Context and associate it with Tracing even if the SkyWalking Tracing plug-in is not turned on, if Apache SkyWalking is already integrated downstream."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638781626018-da50a39d-da16-4914-b4f5-8ac9b4312e19.png",alt:"Log content"})),(0,o.kt)("p",null,"The above Content is the log content, where the Apache APISIX metadata configuration is used to collect request-related information. You can later modify the Log Format to customize the log content by Plugin Metadata, please refer to the ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/skywalking-logger#metadata"},"official documentation.")),(0,o.kt)("h4",{id:"how-to-use"},"How to Use"),(0,o.kt)("p",null,'When using this plugin, since the SkyWalking plugin is "not enabled" by default, you need to manually modify the ',(0,o.kt)("inlineCode",{parentName:"p"},"plugins")," section in the ",(0,o.kt)("inlineCode",{parentName:"p"},"conf/default-apisix.yaml")," file to enable the plugin."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"plugins:\n  ...\n  - error-log-logger\n  ...\n")),(0,o.kt)("p",null,"Then you can use the SkyWalking Tracing plug-in to get the tracing data directly, so you can verify that the Logging plug-in-related features are enabled and working properly."),(0,o.kt)("h5",{id:"step-1-create-a-route"},"Step 1: Create a route"),(0,o.kt)("p",null,"Next, create a route and bind the SkyWalking Tracing plugin and the SkyWalking Logging plugin. More details of the plugin configuration can be found in the ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/skywalking-logger"},"official Apache APISIX documentation"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X PUT \'http://192.168.0.108:9080/apisix/admin/routes/1001\' \\\n-H \'X-API-KEY:  edd1c9f034335f136f87ad84b625c8f1\' \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n    "uri": "/get",\n    "plugins": {\n        "skywalking": {\n            "sample_ratio": 1\n        },\n        "skywalking-logger": {\n            "endpoint_addr": "http://127.0.0.1:12800"\n        }\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "httpbin.org:80": 1\n        }\n    }\n}\'\n')),(0,o.kt)("h5",{id:"step-2-log-processing"},"Step 2: Log Processing"),(0,o.kt)("p",null,"On the Apache SkyWalking side, you can use LAL (Logger Analysis Language) scripts for log processing, such as Tag extraction, SkyWalking metadata correction, and so on."),(0,o.kt)("p",null,"The main purpose of Tag extraction here is to facilitate subsequent retrieval and to add dependencies to the Metrics statistics. The following code can be used to configure the SkyWalking LAL script to complete the Tag extraction. For more information on how to use the SkyWalking LAL script, please refer to the ",(0,o.kt)("a",{parentName:"p",href:"https://skywalking.apache.org/docs/main/latest/en/concepts-and-designs/lal/"},"official Apache SkyWalking documentation"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"# The default LAL script to save all logs, behaving like the versions before 8.5.0.\nrules:\n  - name: default\n    dsl: |\n      filter {\n        json {\n          abortOnFailure false\n        }\n\n        extractor {\n          tag routeId: parsed.route_id\n          tag upstream: parsed.upstream\n          tag clientIp: parsed.client_ip\n          tag latency: parsed.latency\n        }\n\n        sink {\n        }\n      }\n")),(0,o.kt)("p",null,"After configuring the above LAL script in SkyWalking OAP Server the following log will be displayed."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638781696137-6ba3a486-08c0-49e1-bc57-e144f95918a2.png",alt:"LALscript details"})),(0,o.kt)("p",null,"Details of the expanded log are as follows."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638781751540-d597ace7-1de1-4baf-b361-1c136dfe5e05.png",alt:"Expanded log"})),(0,o.kt)("p",null,"As you can see from the above, displaying ",(0,o.kt)("inlineCode",{parentName:"p"},"routeId"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"upstream")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"clientIp")," as key-value pairs is much easier than searching directly in the log body. This is because the Tag format not only supports log display format and search, but also generates information such as Metrics using MAL statistics."),(0,o.kt)("h3",{id:"skywalking-error-logger-plugin"},"SkyWalking Error Logger Plugin"),(0,o.kt)("p",null,"The error-log-logger plug-in now supports the SkyWalking log format, and you can now use the http-error-log plug-in to quickly connect Apache APISIX error logs to Apache SkyWalking. Currently, error logs do not have access to SkyWalking Tracing Context information, and therefore cannot be directly associated with SkyWalking Tracing."),(0,o.kt)("p",null,"The main reason for the error log to be integrated into SkyWalking is to centralize the Apache APISIX log data and to make it easier to view all observable data within SkyWalking."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638781827612-f7d88e0e-0159-44ba-bc1e-b718695bc3b8.png",alt:"SkyWalking dashboard"})),(0,o.kt)("h4",{id:"how-to-use-1"},"How to Use"),(0,o.kt)("p",null,'Since the error-log-logger plugin is "not enabled" by default, you still need to enable the plugin in the way mentioned above.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"plugins:\n  ...\n  - error-log-logger\n  ...\n")),(0,o.kt)("h5",{id:"step-1-bind-the-route"},"Step 1: Bind the route"),(0,o.kt)("p",null,'After enabling, you need to bind the plugin to routes or global rules. Here we take "bind routes" as an example.'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X PUT \'http://192.168.0.108:9080/apisix/admin/plugin_metadata/error-log-logger\' \\\n-H \'X-API-KEY:  edd1c9f034335f136f87ad84b625c8f1\' \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n    "inactive_timeout": 10,\n    "level": "ERROR",\n    "skywalking": {\n        "endpoint_addr": "http://127.0.0.1:12800/v3/logs"\n    }\n}\'\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Note that the ",(0,o.kt)("inlineCode",{parentName:"p"},"endpoint_addr")," is the SkyWalking OAP Server address and needs to have the URI (i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"/v3/logs"),").")),(0,o.kt)("h5",{id:"step-2-lal-processing"},"Step 2: LAL Processing"),(0,o.kt)("p",null,"In much the same way as the Access Log processing, the logs are also processed by LAL when they reach SkyWalking OAP Server. Therefore, we can still use the SkyWalking LAL script to analyze and process the log messages."),(0,o.kt)("p",null,"It is important to note that the Error Log message body is in text format. If you are extracting tags, you will need to use regular expressions to do this. Unlike Access Log, which handles the message body in a slightly different way, Acces Log uses JSON format and can directly reference the fields of the JSON object using JSON parsing, but the rest of the process is largely the same."),(0,o.kt)("p",null,"Tags can also be used to optimize the display and retrieval for subsequent metrics calculations using SkyWalking MAL."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'rules:\n  - name: apisix-errlog\n    dsl: |\n      filter {\n        text {\n          regexp "(?<datetime>\\\\d{4}/\\\\d{2}/\\\\d{2} \\\\d{2}:\\\\d{2}:\\\\d{2}) \\\\[(?<level>\\\\w+)\\\\] \\\\d+\\\\#\\\\d+:( \\\\*\\\\d+ \\\\[(?<module>\\\\w+)\\\\] (?<position>.*\\\\.lua:\\\\d+): (?<function>\\\\w+\\\\(\\\\)):)* (?<msg>.+)"\n        }\n        extractor {\n          tag level: parsed.level\n          if (parsed?.module) {\n            tag module: parsed.module\n            tag position: parsed.position\n            tag function: parsed.function\n          }\n        }\n        sink {\n        }\n      }\n')),(0,o.kt)("p",null,"After the LAL script used by SkyWalking OAP Server, some of the Tags will be extracted from the logs, as shown below."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1638781886771-b98c80de-4ea2-4cf3-ad1c-26250da231f7.png",alt:"Tags details"})),(0,o.kt)("h2",{id:"summary"},"Summary"),(0,o.kt)("p",null,"This article introduces two logging plug-ins for Apache APISIX that integrate with SkyWalking to provide a more convenient operation and environment for logging in Apache APISIX afterwards."),(0,o.kt)("p",null,"We hope that through this article, you will have a fuller understanding of the new features and be able to use Apache APISIX for centralized management of observable data more conveniently in the future."))}p.isMDXComponent=!0}}]);