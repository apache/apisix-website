"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[89369],{35318:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=c(n),d=i,m=h["".concat(s,".").concat(d)]||h[d]||u[d]||r;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},43370:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=n(25773),i=(n(27378),n(35318));const r={title:"API Gateway APISIX Integrates Keycloak for Authentication",authors:[{name:"Xinxin Zhu",title:"Author",url:"https://github.com/starsz",image_url:"https://avatars.githubusercontent.com/u/25628854?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4"}],keywords:["Apache APISIX","API Gateway","Keycloak","Authentication","Integration"],description:"This article shows you how to use OpenID-Connect protocol and Keycloak for identity authentication in API Gateway Apache APISIX through detailed steps.",tags:["Plugins","Authentication"],image:"https://static.apiseven.com/2022/blog/0818/plugins/keycloak.png"},o=void 0,l={permalink:"/blog/2021/12/10/integrate-keycloak-auth-in-apisix",source:"@site/blog/2021/12/10/integrate-keycloak-auth-in-apisix.md",title:"API Gateway APISIX Integrates Keycloak for Authentication",description:"This article shows you how to use OpenID-Connect protocol and Keycloak for identity authentication in API Gateway Apache APISIX through detailed steps.",date:"2021-12-10T00:00:00.000Z",formattedDate:"December 10, 2021",tags:[{label:"Plugins",permalink:"/blog/tags/plugins"},{label:"Authentication",permalink:"/blog/tags/authentication"}],readingTime:5.38,truncated:!0,authors:[{name:"Xinxin Zhu",title:"Author",url:"https://github.com/starsz",image_url:"https://avatars.githubusercontent.com/u/25628854?v=4",imageURL:"https://avatars.githubusercontent.com/u/25628854?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4",imageURL:"https://avatars.githubusercontent.com/u/39793568?v=4"}],prevItem:{title:"Monitor APISIX Ingress Controller with Prometheus",permalink:"/blog/2021/12/13/monitor-apisix-ingress-controller-with-prometheus"},nextItem:{title:"API Log Monitor with Apache APISIX & RocketMQ",permalink:"/blog/2021/12/08/apisix-integrate-rocketmq-logger-plugin"}},s={authorsImageUrls:[void 0,void 0]},c=[{value:"How to Use",id:"how-to-use",children:[{value:"Environment Preparation",id:"environment-preparation",children:[{value:"Start Keycloak",id:"start-keycloak",children:[],level:4},{value:"Configure Keycloak",id:"configure-keycloak",children:[{value:"Create a realm",id:"create-a-realm",children:[],level:5},{value:"Create a Client",id:"create-a-client",children:[],level:5},{value:"Configure the Client",id:"configure-the-client",children:[],level:5},{value:"Create Users",id:"create-users",children:[],level:5}],level:4},{value:"Create Routes",id:"create-routes",children:[{value:"Get client_id and client_secret",id:"get-client_id-and-client_secret",children:[],level:5},{value:"Get the discovery configuration",id:"get-the-discovery-configuration",children:[],level:5},{value:"Create a route and enable the plug-in",id:"create-a-route-and-enable-the-plug-in",children:[],level:5}],level:4}],level:3},{value:"Access Testing",id:"access-testing",children:[{value:"Access Apache APISIX",id:"access-apache-apisix",children:[],level:4},{value:"Successful access",id:"successful-access",children:[],level:4},{value:"Logout",id:"logout",children:[],level:4}],level:3}],level:2},{value:"Summary",id:"summary",children:[],level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This article shows you how to use OpenID-Connect protocol and Keycloak for identity authentication in Apache APISIX through detailed steps.")),(0,i.kt)("head",null,(0,i.kt)("link",{rel:"canonical",href:"https://www.keycloak.org/2021/12/apisix"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639129658486-393e8a3a-ccf2-496d-9b46-4db741bd6e55.png",alt:"Keycloak-APISIX Integration"})),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/"},"Keycloak")," is an open source identity and access management solution for modern applications and services. Keycloak supports Single-Sign On, which enables services to interface with Keycloak through protocols such as OpenID Connect, OAuth 2.0, etc. Keycloak also supports integrations with different authentication services, such as Github, Google and Facebook."),(0,i.kt)("p",null,"In addition, Keycloak also supports user federation, and can import users through LDAP and Kerberos. For more information about Keycloak, please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/about"},"official documentation"),"."),(0,i.kt)("h2",{id:"how-to-use"},"How to Use"),(0,i.kt)("h3",{id:"environment-preparation"},"Environment Preparation"),(0,i.kt)("p",null,"Make sure that Apache APISIX is started in your environment before proceeding with the following steps."),(0,i.kt)("h4",{id:"start-keycloak"},"Start Keycloak"),(0,i.kt)("p",null,"Here we use ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose")," to start Keycloak with PostgreSQL."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"version: '3.7'\n\nservices:\n  postgres:\n      image: postgres:12.2\n      container_name: postgres\n      environment:\n        POSTGRES_DB: keycloak\n        POSTGRES_USER: keycloak\n        POSTGRES_PASSWORD: password\n\n  keycloak:\n      image: jboss/keycloak:9.0.2\n      container_name: keycloak\n      environment:\n        DB_VENDOR: POSTGRES\n        DB_ADDR: postgres\n        DB_DATABASE: keycloak\n        DB_USER: keycloak\n        DB_PASSWORD: password\n        KEYCLOAK_USER: admin\n        KEYCLOAK_PASSWORD: password\n        PROXY_ADDRESS_FORWARDING: \"true\"\n      ports:\n        - 8080:8080\n      depends_on:\n        - postgres\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"docker-compose up\n")),(0,i.kt)("p",null,"After execution, you need to verify that Keycloak and postgres have started successfully."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"docker-compose ps\n")),(0,i.kt)("h4",{id:"configure-keycloak"},"Configure Keycloak"),(0,i.kt)("p",null,'After Keycloak is started, use your browser to access "',(0,i.kt)("a",{parentName:"p",href:"http://127.0.0.1:8080/auth/admin/%22"},'http://127.0.0.1:8080/auth/admin/"')," and type the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin/password")," account password to log in to the administrator console."),(0,i.kt)("h5",{id:"create-a-realm"},"Create a realm"),(0,i.kt)("p",null,"First, you need to create a realm named ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix_test_realm"),". In Keycloak, a realm is a workspace dedicated to managing projects, and the resources of different realms are isolated from each other."),(0,i.kt)("p",null,"The realm in Keycloak is divided into two categories: one is the ",(0,i.kt)("inlineCode",{parentName:"p"},"master realm"),", which is created when Keycloak is first started and used to manage the admin account and create other realm. the second is the ",(0,i.kt)("inlineCode",{parentName:"p"},"other realm"),", which is created by the admin in the master realm and can be used to create, manage and use users and applications in this realm. The second category is the other realm, created by admin in the master realm, where users and applications can be created, managed and used. For more details, please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/getting_started/index.html#realms-and-users"},"realm and users section in Keycloak"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101202459-72803240-b358-4c69-a9ca-4b6751a8547d.png",alt:"Create realm"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101243617-0498379f-392e-4837-8f37-eee558c21e3d.png",alt:"Edit realm title"})),(0,i.kt)("h5",{id:"create-a-client"},"Create a Client"),(0,i.kt)("p",null,"The next step is to create the ",(0,i.kt)("inlineCode",{parentName:"p"},"OpenID Connect Client"),". In Keycloak, Client means a client that is allowed to initiate authentication to Keycloak."),(0,i.kt)("p",null,"In this example scenario, ",(0,i.kt)("inlineCode",{parentName:"p"},"Apache APISIX")," is equivalent to a client that is responsible for initiating authentication requests to Keycloak, so we create a Client with the name ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix"),". More details about the Client can be found in ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/server_admin/#_oidc_clients"},"Keycloak OIDC Clients"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101288379-9a46b92a-294e-4b40-ac7e-408284a3d0ad.png",alt:"Create OpenID Client"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101327347-c8ab463a-1cb0-4eb0-a26f-17d7c0c54846.png",alt:"Creat Client title"})),(0,i.kt)("h5",{id:"configure-the-client"},"Configure the Client"),(0,i.kt)("p",null,"After the Client is created, you need to configure the Apache APISIX access type for the Client."),(0,i.kt)("p",null,"In Keycloak, there are three types of Access Type:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Confidential"),": which is used for applications that need to perform browser login, and the client will get the ",(0,i.kt)("inlineCode",{parentName:"li"},"access token")," through ",(0,i.kt)("inlineCode",{parentName:"li"},"client secret"),", mostly used in web systems rendered by the server."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Public"),": for applications that need to perform browser login, mostly used in front-end projects implemented using vue and react."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Bearer-only"),": for applications that don't need to perform browser login, only allow access with ",(0,i.kt)("inlineCode",{parentName:"li"},"bearer token"),", mostly used in RESTful API scenarios.")),(0,i.kt)("p",null,"For more details about Client settings, please refer to ",(0,i.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/server_admin/#advanced-settings"},"Keycloak OIDC Clients Advanced Settings"),"."),(0,i.kt)("p",null,'Since we are using Apache APISIX as the Client on the server side, we can choose either "confidential" Access Type or "Bearer-only" Access Type. For the demonstration below, we are using "confidential" Access Type as an example.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101355171-e368730b-2a72-4c4d-9397-cf4a1c8f2806.png",alt:"Set Client type"})),(0,i.kt)("h5",{id:"create-users"},"Create Users"),(0,i.kt)("p",null,'Keycloak supports interfacing with other third-party user systems, such as Google and Facebook, or importing or manually creating users using LDAP . Here we will use "manually creating users" to demonstrate.'),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101385277-b2f578c0-e68a-4945-83ac-7a77145bb056.png",alt:"Create user"})),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101406281-724bbb50-96fc-4aa8-aec1-9414f83c199d.png",alt:"Add user info"})),(0,i.kt)("p",null,"Then set the user's password in the Credentials page."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101430209-d289459a-5014-4a2d-864f-7917b84b1c0c.png",alt:"Set user password"})),(0,i.kt)("h4",{id:"create-routes"},"Create Routes"),(0,i.kt)("p",null,"After Keycloak is configured, you need to create a route and open the ",(0,i.kt)("inlineCode",{parentName:"p"},"Openid-Connect")," plugin . For details on the configuration of this plugin, please refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/openid-connect"},"Apache APISIX OpenID-Connect plugin"),"."),(0,i.kt)("h5",{id:"get-client_id-and-client_secret"},"Get client_id and client_secret"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101454807-ff8c8b77-bdac-4ac6-966e-a2f5e2418b7a.png",alt:"Get Client infos"})),(0,i.kt)("p",null,"In the above configuration."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_id")," is the name used when creating the Client before, i.e. ",(0,i.kt)("inlineCode",{parentName:"li"},"apisix")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_secret")," should be obtained from Clients-apisix-Credentials, for example: ",(0,i.kt)("inlineCode",{parentName:"li"},"d5c42c50-3e71-4bbbe-aa9e-31083ab29da4"),".")),(0,i.kt)("h5",{id:"get-the-discovery-configuration"},"Get the discovery configuration"),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101585273-7eb31728-fe4c-4af3-84d1-76c1a97e7e35.png",alt:"Get configuration"})),(0,i.kt)("p",null,"Go to Realm Settings-General-Endpoints, select the ",(0,i.kt)("inlineCode",{parentName:"p"},"OpenID Endpoint Configuration")," link and copy the address that the link points to, for example:",(0,i.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:8080/auth/realms/apisix_test_realm/.well-known/openid-configuration"),"."),(0,i.kt)("h5",{id:"create-a-route-and-enable-the-plug-in"},"Create a route and enable the plug-in"),(0,i.kt)("p",null,"Use the following command to access the Apache APISIX Admin interface to create a route, set the upstream to ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin.org"),", and enable the plug-in OpenID Connect for authentication."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note: If you select ",(0,i.kt)("inlineCode",{parentName:"p"},"bearer-only")," as the Access Type when creating a Client, you need to set ",(0,i.kt)("inlineCode",{parentName:"p"},"bearer_only")," to true when configuring the route, so that access to Apache APISIX will not jump to the Keycloak login screen.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl  -XPOST 127.0.0.1:9080/apisix/admin/routes -H "X-Api-Key: edd1c9f034335f136f87ad84b625c8f1" -d \'{\n    "uri":"/*",\n    "plugins":{\n        "openid-connect":{\n            "client_id":"apisix",\n            "client_secret":"d5c42c50-3e71-4bbe-aa9e-31083ab29da4",\n            "discovery":"http://127.0.0.1:8080/auth/realms/apisix_test_realm/.well-known/openid-configuration",\n            "scope":"openid profile",\n            "bearer_only":false,\n            "realm":"apisix_test_realm",\n            "introspection_endpoint_auth_method":"client_secret_post",\n            "redirect_uri":"http://127.0.0.1:9080/"\n        }\n    },\n    "upstream":{\n        "type":"roundrobin",\n        "nodes":{\n            "httpbin.org:80":1\n        }\n    }\n}\'\n')),(0,i.kt)("h3",{id:"access-testing"},"Access Testing"),(0,i.kt)("p",null,"Once the above configuration is complete, we are ready to perform the relevant access tests in Apache APISIX."),(0,i.kt)("h4",{id:"access-apache-apisix"},"Access Apache APISIX"),(0,i.kt)("p",null,"Use your browser to access ",(0,i.kt)("a",{parentName:"p",href:"http://127.0.0.1:9080/image/png"},"http://127.0.0.1:9080/image/png"),"."),(0,i.kt)("p",null,"Since the OpenID-Connect plugin is enabled and ",(0,i.kt)("inlineCode",{parentName:"p"},"bearer-only")," is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),", when you access this path for the first time, Apache APISIX will redirect to the login screen configured in ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix_test_realm")," in Keycloak and make a user login request."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101623370-cc668e0f-0c2c-469c-9a3e-3118c271d63f.png",alt:"Login Page"})),(0,i.kt)("p",null,"Enter the User peter created during the Keycloak configuration to complete user login."),(0,i.kt)("h4",{id:"successful-access"},"Successful access"),(0,i.kt)("p",null,"After a successful login, the browser will again redirect the link to ",(0,i.kt)("a",{parentName:"p",href:"http://127.0.0.1:9080/image/png"},"http://127.0.0.1:9080/image/png")," and will successfully access the image content. The content is identical to that of the upstream ",(0,i.kt)("a",{parentName:"p",href:"http://httpbin.org/image/png"},"http://httpbin.org/image/png"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1639101644015-6d541202-dfff-4de3-ad47-f49dd65911a6.png",alt:"Access successfully"})),(0,i.kt)("h4",{id:"logout"},"Logout"),(0,i.kt)("p",null,'After the test, use your browser to access "http:/127.0.0.1:9080/logout" to logout your account.'),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note: The logout path can be specified by ",(0,i.kt)("inlineCode",{parentName:"p"},"logout_path")," in the OpenID-Connect plug-in configuration, the default is ",(0,i.kt)("inlineCode",{parentName:"p"},"logout"),".")),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"This article shows the procedure of using OpenID-Connect protocol and Keycloak for authentication in Apache APISIX. By integrating with Keycloak, Apache APISIX can be configured to authenticate and authenticate users and application services, which greatly reduces the development work involved."),(0,i.kt)("p",null,"For more information about the implementation of authentication in Apache APISIX with Okta, see ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/zh/blog/2021/08/16/Using-the-Apache-APISIX-OpenID-Connect-Plugin-for-Centralized-Authentication/"},"this article"),"."))}u.isMDXComponent=!0}}]);