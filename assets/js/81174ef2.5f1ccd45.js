"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[25498],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>u});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=p(a),u=i,m=h["".concat(l,".").concat(u)]||h[u]||d[u]||o;return a?n.createElement(m,r(r({ref:t},c),{},{components:a})):n.createElement(m,r({ref:t},c))}));function u(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var p=2;p<o;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},82179:(e,t,a)=>{a.r(t),a.d(t,{contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var n=a(87462),i=(a(67294),a(3905));const o={title:"FAQ",keywords:["Apache APISIX","API Gateway","FAQ"],description:"This article lists solutions to common problems when using Apache APISIX."},r=void 0,s={unversionedId:"FAQ",id:"version-3.10/FAQ",isDocsHomePage:!1,title:"FAQ",description:"This article lists solutions to common problems when using Apache APISIX.",source:"@site/docs-apisix_versioned_docs/version-3.10/FAQ.md",sourceDirName:".",slug:"/FAQ",permalink:"/docs/apisix/3.10/FAQ",editUrl:"/edit#https://github.com/apache/apisix/edit/release/3.10/docs/en/latest/FAQ.md",tags:[],version:"3.10",frontMatter:{title:"FAQ",keywords:["Apache APISIX","API Gateway","FAQ"],description:"This article lists solutions to common problems when using Apache APISIX."},sidebar:"version-3.10/docs",previous:{title:"Deployment modes",permalink:"/docs/apisix/3.10/deployment-modes"},next:{title:"Integration service discovery registry",permalink:"/docs/apisix/3.10/discovery"}},l=[{value:"Why do I need a new API gateway?",id:"why-do-i-need-a-new-api-gateway",children:[]},{value:"How does Apache APISIX differ from other API gateways?",id:"how-does-apache-apisix-differ-from-other-api-gateways",children:[]},{value:"What is the performance impact of using Apache APISIX?",id:"what-is-the-performance-impact-of-using-apache-apisix",children:[]},{value:"Which platforms does Apache APISIX support?",id:"which-platforms-does-apache-apisix-support",children:[]},{value:"What does it mean by &quot;Apache APISIX is fully dynamic&quot;?",id:"what-does-it-mean-by-apache-apisix-is-fully-dynamic",children:[]},{value:"Does Apache APISIX have a user interface?",id:"does-apache-apisix-have-a-user-interface",children:[]},{value:"Can I write my own Plugins for Apache APISIX?",id:"can-i-write-my-own-plugins-for-apache-apisix",children:[]},{value:"Why does Apache APISIX use etcd for the configuration center?",id:"why-does-apache-apisix-use-etcd-for-the-configuration-center",children:[]},{value:"When installing Apache APISIX dependencies with LuaRocks, why does it cause a timeout or result in a slow or unsuccessful installation?",id:"when-installing-apache-apisix-dependencies-with-luarocks-why-does-it-cause-a-timeout-or-result-in-a-slow-or-unsuccessful-installation",children:[]},{value:"How do I build the APISIX-Runtime environment?",id:"how-do-i-build-the-apisix-runtime-environment",children:[]},{value:"How can I make a gray release with Apache APISIX?",id:"how-can-i-make-a-gray-release-with-apache-apisix",children:[]},{value:"How do I redirect HTTP traffic to HTTPS with Apache APISIX?",id:"how-do-i-redirect-http-traffic-to-https-with-apache-apisix",children:[]},{value:"How do I change Apache APISIX&#39;s log level?",id:"how-do-i-change-apache-apisixs-log-level",children:[]},{value:"How do I reload my custom Plugins for Apache APISIX?",id:"how-do-i-reload-my-custom-plugins-for-apache-apisix",children:[]},{value:"How do I configure Apache APISIX to listen on multiple ports when handling HTTP or HTTPS requests?",id:"how-do-i-configure-apache-apisix-to-listen-on-multiple-ports-when-handling-http-or-https-requests",children:[]},{value:"After uploading the SSL certificate, why can&#39;t the corresponding route be accessed through HTTPS + IP?",id:"after-uploading-the-ssl-certificate-why-cant-the-corresponding-route-be-accessed-through-https--ip",children:[]},{value:"How does Apache APISIX achieve millisecond-level configuration synchronization?",id:"how-does-apache-apisix-achieve-millisecond-level-configuration-synchronization",children:[]},{value:"How do I customize the Apache APISIX instance id?",id:"how-do-i-customize-the-apache-apisix-instance-id",children:[]},{value:"Why are there errors saying &quot;failed to fetch data from etcd, failed to read etcd dir, etcd key: xxxxxx&quot; in the error.log?",id:"why-are-there-errors-saying-failed-to-fetch-data-from-etcd-failed-to-read-etcd-dir-etcd-key-xxxxxx-in-the-errorlog",children:[]},{value:"How do I setup high availability Apache APISIX clusters?",id:"how-do-i-setup-high-availability-apache-apisix-clusters",children:[]},{value:"Why does the <code>make deps</code> command fail when installing Apache APISIX from source?",id:"why-does-the-make-deps-command-fail-when-installing-apache-apisix-from-source",children:[]},{value:"How do I access the APISIX Dashboard through Apache APISIX proxy?",id:"how-do-i-access-the-apisix-dashboard-through-apache-apisix-proxy",children:[]},{value:"How do I use regular expressions (regex) for matching <code>uri</code> in a Route?",id:"how-do-i-use-regular-expressions-regex-for-matching-uri-in-a-route",children:[]},{value:"Does the Upstream node support configuring a FQDN address?",id:"does-the-upstream-node-support-configuring-a-fqdn-address",children:[]},{value:"What is the <code>X-API-KEY</code> of the Admin API? Can it be modified?",id:"what-is-the-x-api-key-of-the-admin-api-can-it-be-modified",children:[]},{value:"How do I allow all IPs to access Apache APISIX&#39;s Admin API?",id:"how-do-i-allow-all-ips-to-access-apache-apisixs-admin-api",children:[]},{value:"How do I auto renew SSL certificates with acme.sh?",id:"how-do-i-auto-renew-ssl-certificates-with-acmesh",children:[]},{value:"How do I strip a prefix from a path before forwarding to Upstream in Apache APISIX?",id:"how-do-i-strip-a-prefix-from-a-path-before-forwarding-to-upstream-in-apache-apisix",children:[]},{value:"How do I fix the error <code>unable to get local issuer certificate</code> in Apache APISIX?",id:"how-do-i-fix-the-error-unable-to-get-local-issuer-certificate-in-apache-apisix",children:[]},{value:"How do I fix the error <code>module &#39;resty.worker.events&#39; not found</code> in Apache APISIX?",id:"how-do-i-fix-the-error-module-restyworkerevents-not-found-in-apache-apisix",children:[]},{value:"What is the difference between <code>plugin-metadata</code> and <code>plugin-configs</code> in Apache APISIX?",id:"what-is-the-difference-between-plugin-metadata-and-plugin-configs-in-apache-apisix",children:[]},{value:"After deploying Apache APISIX, how to detect the survival of the APISIX data plane?",id:"after-deploying-apache-apisix-how-to-detect-the-survival-of-the-apisix-data-plane",children:[]},{value:"What are the scenarios with high APISIX latency related to etcd and how to fix them?",id:"what-are-the-scenarios-with-high-apisix-latency-related-to-etcd-and-how-to-fix-them",children:[]},{value:"Why is the file-logger logging garbled?",id:"why-is-the-file-logger-logging-garbled",children:[]},{value:"How does APISIX configure ETCD with authentication?",id:"how-does-apisix-configure-etcd-with-authentication",children:[]},{value:"What is the difference between SSLs, <code>tls.client_cert</code> in upstream configurations, and <code>ssl_trusted_certificate</code> in <code>config.yaml</code>?",id:"what-is-the-difference-between-ssls-tlsclient_cert-in-upstream-configurations-and-ssl_trusted_certificate-in-configyaml",children:[]},{value:"Where can I find more answers?",id:"where-can-i-find-more-answers",children:[]}],p={toc:l};function c(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"why-do-i-need-a-new-api-gateway"},"Why do I need a new API gateway?"),(0,i.kt)("p",null,"As organizations move towards cloud native microservices, there is a need for an API gateway that is performant, flexible, secure and scalable."),(0,i.kt)("p",null,"APISIX outperforms other API gateways in these metrics while being platform agnostic and fully dynamic delivering features like supporting multiple protocols, fine-grained routing and multi-language support."),(0,i.kt)("h2",{id:"how-does-apache-apisix-differ-from-other-api-gateways"},"How does Apache APISIX differ from other API gateways?"),(0,i.kt)("p",null,"Apache APISIX differs in the following ways:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"It uses etcd to save and synchronize configurations rather than relational databases like PostgreSQL or MySQL. The real-time event notification system in etcd is easier to scale than in these alternatives. This allows APISIX to synchronize the configuration in real-time, makes the code concise and avoids a single point of failure."),(0,i.kt)("li",{parentName:"ul"},"Fully dynamic."),(0,i.kt)("li",{parentName:"ul"},"Supports ",(0,i.kt)("a",{parentName:"li",href:"/docs/apisix/3.10/terminology/plugin#hot-reload"},"hot loading of Plugins"),".")),(0,i.kt)("h2",{id:"what-is-the-performance-impact-of-using-apache-apisix"},"What is the performance impact of using Apache APISIX?"),(0,i.kt)("p",null,"Apache APISIX delivers the best performance among other API gateways with a single-core QPS of 18,000 with an average delay of 0.2 ms."),(0,i.kt)("p",null,"Specific results of the performance benchmarks can be found ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/3.10/benchmark"},"here"),"."),(0,i.kt)("h2",{id:"which-platforms-does-apache-apisix-support"},"Which platforms does Apache APISIX support?"),(0,i.kt)("p",null,"Apache APISIX is platform agnostic and avoids vendor lock-in. It is built for cloud native environments and can run on bare-metal machines to Kubernetes. It even support Apple Silicon chips."),(0,i.kt)("h2",{id:"what-does-it-mean-by-apache-apisix-is-fully-dynamic"},'What does it mean by "Apache APISIX is fully dynamic"?'),(0,i.kt)("p",null,"Apache APISIX is fully dynamic in the sense that it doesn't require restarts to change its behavior."),(0,i.kt)("p",null,"It does the following dynamically:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Reloading Plugins"),(0,i.kt)("li",{parentName:"ul"},"Proxy rewrites"),(0,i.kt)("li",{parentName:"ul"},"Proxy mirror"),(0,i.kt)("li",{parentName:"ul"},"Response rewrites"),(0,i.kt)("li",{parentName:"ul"},"Health checks"),(0,i.kt)("li",{parentName:"ul"},"Traffic split")),(0,i.kt)("h2",{id:"does-apache-apisix-have-a-user-interface"},"Does Apache APISIX have a user interface?"),(0,i.kt)("p",null,"Yes. Apache APISIX has an experimental feature called ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-dashboard"},"Apache APISIX Dashboard"),", which is independent from Apache APISIX. To work with Apache APISIX through a user interface, you can deploy the Apache APISIX Dashboard."),(0,i.kt)("h2",{id:"can-i-write-my-own-plugins-for-apache-apisix"},"Can I write my own Plugins for Apache APISIX?"),(0,i.kt)("p",null,"Yes. Apache APISIX is flexible and extensible through the use of custom Plugins that can be specific to user needs."),(0,i.kt)("p",null,"You can write your own Plugins by referring to ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/3.10/plugin-develop"},"How to write your own Plugins"),"."),(0,i.kt)("h2",{id:"why-does-apache-apisix-use-etcd-for-the-configuration-center"},"Why does Apache APISIX use etcd for the configuration center?"),(0,i.kt)("p",null,"In addition to the basic functionality of storing the configurations, Apache APISIX also needs a storage system that supports these features:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Distributed deployments in clusters."),(0,i.kt)("li",{parentName:"ol"},"Guarded transactions by comparisons."),(0,i.kt)("li",{parentName:"ol"},"Multi-version concurrency control."),(0,i.kt)("li",{parentName:"ol"},"Notifications and watch streams."),(0,i.kt)("li",{parentName:"ol"},"High performance with minimum read/write latency.")),(0,i.kt)("p",null,"etcd provides these features and more making it ideal over other databases like PostgreSQL and MySQL."),(0,i.kt)("p",null,"To learn more on how etcd compares with other alternatives see this ",(0,i.kt)("a",{parentName:"p",href:"https://etcd.io/docs/latest/learning/why/#comparison-chart"},"comparison chart"),"."),(0,i.kt)("h2",{id:"when-installing-apache-apisix-dependencies-with-luarocks-why-does-it-cause-a-timeout-or-result-in-a-slow-or-unsuccessful-installation"},"When installing Apache APISIX dependencies with LuaRocks, why does it cause a timeout or result in a slow or unsuccessful installation?"),(0,i.kt)("p",null,"This is likely because the LuaRocks server used is blocked."),(0,i.kt)("p",null,"To solve this you can use https_proxy or use the ",(0,i.kt)("inlineCode",{parentName:"p"},"--server")," flag to specify a faster LuaRocks server."),(0,i.kt)("p",null,"You can run the command below to see the available servers (needs LuaRocks 3.0+):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"luarocks config rocks_servers\n")),(0,i.kt)("p",null,"Mainland China users can use ",(0,i.kt)("inlineCode",{parentName:"p"},"luarocks.cn")," as the LuaRocks server. You can use this wrapper with the Makefile to set this up:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"make deps ENV_LUAROCKS_SERVER=https://luarocks.cn\n")),(0,i.kt)("p",null,"If this does not solve your problem, you can try getting a detailed log by using the ",(0,i.kt)("inlineCode",{parentName:"p"},"--verbose")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"-v")," flag to diagnose the problem."),(0,i.kt)("h2",{id:"how-do-i-build-the-apisix-runtime-environment"},"How do I build the APISIX-Runtime environment?"),(0,i.kt)("p",null,"Some functions need to introduce additional NGINX modules, which requires APISIX to run on APISIX-Runtime. If you need these functions, you can refer to the code in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/apisix-build-tools"},"api7/apisix-build-tools")," to build your own APISIX-Runtime environment."),(0,i.kt)("h2",{id:"how-can-i-make-a-gray-release-with-apache-apisix"},"How can I make a gray release with Apache APISIX?"),(0,i.kt)("p",null,"Let's take an example query ",(0,i.kt)("inlineCode",{parentName:"p"},"foo.com/product/index.html?id=204&page=2")," and consider that you need to make a gray release based on the ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," in the query string with this condition:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Group A: ",(0,i.kt)("inlineCode",{parentName:"li"},"id <= 1000")),(0,i.kt)("li",{parentName:"ol"},"Group B: ",(0,i.kt)("inlineCode",{parentName:"li"},"id > 1000"))),(0,i.kt)("p",null,"There are two different ways to achieve this in Apache APISIX:"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can fetch the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Using the ",(0,i.kt)("inlineCode",{parentName:"li"},"vars")," field in a ",(0,i.kt)("a",{parentName:"li",href:"/docs/apisix/3.10/terminology/route"},"Route"),":")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/index.html",\n    "vars": [\n        ["arg_id", "<=", "1000"]\n    ],\n    "plugins": {\n        "redirect": {\n            "uri": "/test?group_id=1"\n        }\n    }\n}\'\n\ncurl -i http://127.0.0.1:9180/apisix/admin/routes/2 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/index.html",\n    "vars": [\n        ["arg_id", ">", "1000"]\n    ],\n    "plugins": {\n        "redirect": {\n            "uri": "/test?group_id=2"\n        }\n    }\n}\'\n')),(0,i.kt)("p",null,"All the available operators of the current ",(0,i.kt)("inlineCode",{parentName:"p"},"lua-resty-radixtree")," are listed ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-radixtree#operator-list"},"here"),"."),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Using the ",(0,i.kt)("a",{parentName:"li",href:"/docs/apisix/3.10/plugins/traffic-split"},"traffic-split")," Plugin.")),(0,i.kt)("h2",{id:"how-do-i-redirect-http-traffic-to-https-with-apache-apisix"},"How do I redirect HTTP traffic to HTTPS with Apache APISIX?"),(0,i.kt)("p",null,"For example, you need to redirect traffic from ",(0,i.kt)("inlineCode",{parentName:"p"},"http://foo.com")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"https://foo.com"),"."),(0,i.kt)("p",null,"Apache APISIX provides several different ways to achieve this:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Setting ",(0,i.kt)("inlineCode",{parentName:"li"},"http_to_https")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"true")," in the ",(0,i.kt)("a",{parentName:"li",href:"/docs/apisix/3.10/plugins/redirect"},"redirect")," Plugin:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/1  -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/hello",\n    "host": "foo.com",\n    "plugins": {\n        "redirect": {\n            "http_to_https": true\n        }\n    }\n}\'\n')),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Advanced routing with ",(0,i.kt)("inlineCode",{parentName:"li"},"vars")," in the redirect Plugin:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1  -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/hello",\n    "host": "foo.com",\n    "vars": [\n        [\n            "scheme",\n            "==",\n            "http"\n        ]\n    ],\n    "plugins": {\n        "redirect": {\n            "uri": "https://$host$request_uri",\n            "ret_code": 301\n        }\n    }\n}\'\n')),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Using the ",(0,i.kt)("inlineCode",{parentName:"li"},"serverless")," Plugin:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1  -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/hello",\n    "plugins": {\n        "serverless-pre-function": {\n            "phase": "rewrite",\n            "functions": ["return function() if ngx.var.scheme == \\"http\\" and ngx.var.host == \\"foo.com\\" then ngx.header[\\"Location\\"] = \\"https://foo.com\\" .. ngx.var.request_uri; ngx.exit(ngx.HTTP_MOVED_PERMANENTLY); end; end"]\n        }\n    }\n}\'\n')),(0,i.kt)("p",null,"To test this serverless Plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"curl -i -H 'Host: foo.com' http://127.0.0.1:9080/hello\n")),(0,i.kt)("p",null,"The response should be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"HTTP/1.1 301 Moved Permanently\nDate: Mon, 18 May 2020 02:56:04 GMT\nContent-Type: text/html\nContent-Length: 166\nConnection: keep-alive\nLocation: https://foo.com/hello\nServer: APISIX web server\n\n<html>\n<head><title>301 Moved Permanently</title></head>\n<body>\n<center><h1>301 Moved Permanently</h1></center>\n<hr><center>openresty</center>\n</body>\n</html>\n")),(0,i.kt)("h2",{id:"how-do-i-change-apache-apisixs-log-level"},"How do I change Apache APISIX's log level?"),(0,i.kt)("p",null,"By default the log level of Apache APISIX is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"warn"),". You can set this to ",(0,i.kt)("inlineCode",{parentName:"p"},"info")," to trace the messages printed by ",(0,i.kt)("inlineCode",{parentName:"p"},"core.log.info"),"."),(0,i.kt)("p",null,"For this, you can set the ",(0,i.kt)("inlineCode",{parentName:"p"},"error_log_level")," parameter in your configuration file (conf/config.yaml) as shown below and reload Apache APISIX."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'nginx_config:\n  error_log_level: "info"\n')),(0,i.kt)("h2",{id:"how-do-i-reload-my-custom-plugins-for-apache-apisix"},"How do I reload my custom Plugins for Apache APISIX?"),(0,i.kt)("p",null,"All Plugins in Apache APISIX are hot reloaded."),(0,i.kt)("p",null,"You can learn more about hot reloading of Plugins ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/3.10/terminology/plugin#hot-reload"},"here"),"."),(0,i.kt)("h2",{id:"how-do-i-configure-apache-apisix-to-listen-on-multiple-ports-when-handling-http-or-https-requests"},"How do I configure Apache APISIX to listen on multiple ports when handling HTTP or HTTPS requests?"),(0,i.kt)("p",null,"By default, Apache APISIX listens only on port 9080 when handling HTTP requests."),(0,i.kt)("p",null,"To configure Apache APISIX to listen on multiple ports, you can:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Modify the parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"node_listen")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"}," apisix:\n   node_listen:\n     - 9080\n     - 9081\n     - 9082\n")),(0,i.kt)("p",{parentName:"li"},"Similarly for HTTPS requests, modify the parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"ssl.listen")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"apisix:\n  ssl:\n    enable: true\n    listen:\n      - port: 9443\n      - port: 9444\n      - port: 9445\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Reload or restart Apache APISIX."))),(0,i.kt)("h2",{id:"after-uploading-the-ssl-certificate-why-cant-the-corresponding-route-be-accessed-through-https--ip"},"After uploading the SSL certificate, why can't the corresponding route be accessed through HTTPS + IP?"),(0,i.kt)("p",null,"If you directly use HTTPS + IP address to access the server, the server will use the IP address to compare with the bound SNI. Since the SSL certificate is bound to the domain name, the corresponding resource cannot be found in the SNI, so that the certificate will be verified. The authentication fails, and the user cannot access the gateway via HTTPS + IP."),(0,i.kt)("p",null,"You can implement this function by setting the ",(0,i.kt)("inlineCode",{parentName:"p"},"fallback_sni")," parameter in the configuration file and configuring the domain name. When the user uses HTTPS + IP to access the gateway, when the SNI is empty, it will fall back to the default SNI to achieve HTTPS + IP access to the gateway."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="./conf/config.yaml"',title:'"./conf/config.yaml"'},'apisix\n  ssl\uff1a\n    fallback_sni: "${your sni}"\n')),(0,i.kt)("h2",{id:"how-does-apache-apisix-achieve-millisecond-level-configuration-synchronization"},"How does Apache APISIX achieve millisecond-level configuration synchronization?"),(0,i.kt)("p",null,"Apache APISIX uses etcd for its configuration center. etcd provides subscription functions like ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-etcd/blob/master/api_v3.md#watch"},"watch")," and ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-etcd/blob/master/api_v3.md#watchdir"},"watchdir")," that can monitor changes to specific keywords or directories."),(0,i.kt)("p",null,"In Apache APISIX, we use ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-etcd/blob/master/api_v3.md#watchdir"},"etcd.watchdir")," to monitor changes in a directory."),(0,i.kt)("p",null,"If there is no change in the directory being monitored, the process will be blocked until it times out or run into any errors."),(0,i.kt)("p",null,"If there are changes in the directory being monitored, etcd will return this new data within milliseconds and Apache APISIX will update the cache memory."),(0,i.kt)("h2",{id:"how-do-i-customize-the-apache-apisix-instance-id"},"How do I customize the Apache APISIX instance id?"),(0,i.kt)("p",null,"By default, Apache APISIX reads the instance id from ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/apisix.uid"),". If this is not found and no id is configured, Apache APISIX will generate a ",(0,i.kt)("inlineCode",{parentName:"p"},"uuid")," for the instance id."),(0,i.kt)("p",null,"To specify a meaningful id to bind Apache APISIX to your internal system, set the ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," in your ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apisix:\n  id: "your-id"\n')),(0,i.kt)("h2",{id:"why-are-there-errors-saying-failed-to-fetch-data-from-etcd-failed-to-read-etcd-dir-etcd-key-xxxxxx-in-the-errorlog"},'Why are there errors saying "failed to fetch data from etcd, failed to read etcd dir, etcd key: xxxxxx" in the error.log?'),(0,i.kt)("p",null,"Please follow the troubleshooting steps described below:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Make sure that there aren't any networking issues between Apache APISIX and your etcd deployment in your cluster.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"If your network is healthy, check whether you have enabled the ",(0,i.kt)("a",{parentName:"p",href:"https://etcd.io/docs/v3.4/dev-guide/api_grpc_gateway/"},"gRPC gateway")," for etcd. The default state depends on whether you used command line options or a configuration file to start the etcd server."),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If you used command line options, gRPC gateway is enabled by default. You can enable it manually as shown below:")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"etcd --enable-grpc-gateway --data-dir=/path/to/data\n")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Note"),": This flag is not shown while running ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd --help"),"."),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If you used a configuration file, gRPC gateway is disabled by default. You can manually enable it as shown below:")),(0,i.kt)("p",{parentName:"li"},"In ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd.json"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "enable-grpc-gateway": true,\n  "data-dir": "/path/to/data"\n}\n')),(0,i.kt)("p",{parentName:"li"},"In ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd.conf.yml"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-yml"},"enable-grpc-gateway: true\n")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": This distinction was eliminated by etcd in their latest master branch but wasn't backported to previous versions."),(0,i.kt)("h2",{id:"how-do-i-setup-high-availability-apache-apisix-clusters"},"How do I setup high availability Apache APISIX clusters?"),(0,i.kt)("p",null,"Apache APISIX can be made highly available by adding a load balancer in front of it as APISIX's data plane is stateless and can be scaled when needed."),(0,i.kt)("p",null,"The control plane of Apache APISIX is highly available as it relies only on an etcd cluster."),(0,i.kt)("h2",{id:"why-does-the-make-deps-command-fail-when-installing-apache-apisix-from-source"},"Why does the ",(0,i.kt)("inlineCode",{parentName:"h2"},"make deps")," command fail when installing Apache APISIX from source?"),(0,i.kt)("p",null,"When executing ",(0,i.kt)("inlineCode",{parentName:"p"},"make deps")," to install Apache APISIX from source, you can get an error as shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ make deps\n......\nError: Failed installing dependency: https://luarocks.org/luasec-0.9-1.src.rock - Could not find header file for OPENSSL\n  No file openssl/ssl.h in /usr/local/include\nYou may have to install OPENSSL in your system and/or pass OPENSSL_DIR or OPENSSL_INCDIR to the luarocks command.\nExample: luarocks install luasec OPENSSL_DIR=/usr/local\nmake: *** [deps] Error 1\n")),(0,i.kt)("p",null,"This is caused by the missing OpenResty openssl development kit. To install it, refer ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/3.10/install-dependencies"},"installing dependencies"),"."),(0,i.kt)("h2",{id:"how-do-i-access-the-apisix-dashboard-through-apache-apisix-proxy"},"How do I access the APISIX Dashboard through Apache APISIX proxy?"),(0,i.kt)("p",null,"You can follow the steps below to configure this:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Configure different ports for Apache APISIX proxy and Admin API. Or, disable the Admin API.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"deployment:\n  admin:\n    admin_listen: # use a separate port\n      ip: 127.0.0.1\n      port: 9180\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Add a proxy Route for the Apache APISIX dashboard:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1  -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uris":[ "/*" ],\n    "name":"apisix_proxy_dashboard",\n    "upstream":{\n        "nodes":[\n            {\n                "host":"127.0.0.1",\n                "port":9000,\n                "weight":1\n            }\n        ],\n        "type":"roundrobin"\n    }\n}\'\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": The Apache APISIX Dashboard is listening on ",(0,i.kt)("inlineCode",{parentName:"p"},"127.0.0.1:9000"),"."),(0,i.kt)("h2",{id:"how-do-i-use-regular-expressions-regex-for-matching-uri-in-a-route"},"How do I use regular expressions (regex) for matching ",(0,i.kt)("inlineCode",{parentName:"h2"},"uri")," in a Route?"),(0,i.kt)("p",null,"You can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"vars")," field in a Route for matching regular expressions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/*",\n    "vars": [\n        ["uri", "~~", "^/[a-z]+$"]\n    ],\n    "upstream": {\n            "type": "roundrobin",\n            "nodes": {\n                "127.0.0.1:1980": 1\n            }\n    }\n}\'\n')),(0,i.kt)("p",null,"And to test this request:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"# uri matched\n$ curl http://127.0.0.1:9080/hello -i\nHTTP/1.1 200 OK\n...\n\n# uri didn't match\n$ curl http://127.0.0.1:9080/12ab -i\nHTTP/1.1 404 Not Found\n...\n")),(0,i.kt)("p",null,"For more info on using ",(0,i.kt)("inlineCode",{parentName:"p"},"vars")," refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr"},"lua-resty-expr"),"."),(0,i.kt)("h2",{id:"does-the-upstream-node-support-configuring-a-fqdn-address"},"Does the Upstream node support configuring a ",(0,i.kt)("a",{parentName:"h2",href:"https://en.wikipedia.org/wiki/Fully_qualified_domain_name"},"FQDN")," address?"),(0,i.kt)("p",null,"Yes. The example below shows configuring the FQDN ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin.default.svc.cluster.local")," (a Kubernetes service):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/1  -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/ip",\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "httpbin.default.svc.cluster.local": 1\n        }\n    }\n}\'\n')),(0,i.kt)("p",null,"To test this Route:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl http://127.0.0.1:9080/ip -i\nHTTP/1.1 200 OK\n...\n")),(0,i.kt)("h2",{id:"what-is-the-x-api-key-of-the-admin-api-can-it-be-modified"},"What is the ",(0,i.kt)("inlineCode",{parentName:"h2"},"X-API-KEY")," of the Admin API? Can it be modified?"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"X-API-KEY")," of the Admin API refers to the ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix.admin_key.key")," in your ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," file. It is the access token for the Admin API."),(0,i.kt)("p",null,"By default, it is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"edd1c9f034335f136f87ad84b625c8f1")," and can be modified by changing the parameter in your ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apisix:\n  admin_key\n    -\n      name: "admin"\n      key: newkey\n      role: admin\n')),(0,i.kt)("p",null,"Now, to access the Admin API:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl -i http://127.0.0.1:9180/apisix/admin/routes/1  -H \'X-API-KEY: newkey\' -X PUT -d \'\n{\n    "uris":[ "/*" ],\n    "name":"admin-token-test",\n    "upstream":{\n        "nodes":[\n            {\n                "host":"127.0.0.1",\n                "port":1980,\n                "weight":1\n            }\n        ],\n        "type":"roundrobin"\n    }\n}\'\n\nHTTP/1.1 200 OK\n......\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": By using the default token, you could be exposed to security risks. It is required to update it when deploying to a production environment."),(0,i.kt)("h2",{id:"how-do-i-allow-all-ips-to-access-apache-apisixs-admin-api"},"How do I allow all IPs to access Apache APISIX's Admin API?"),(0,i.kt)("p",null,"By default, Apache APISIX only allows IPs in the range ",(0,i.kt)("inlineCode",{parentName:"p"},"127.0.0.0/24")," to access the Admin API."),(0,i.kt)("p",null,"To allow IPs in all ranges, you can update your configuration file as show below and restart or reload Apache APISIX."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"deployment:\n  admin:\n    allow_admin:\n      - 0.0.0.0/0\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": This should only be used in non-production environments to allow all clients to access Apache APISIX and is not safe for production environments. Always authorize specific IP addresses or address ranges for production environments."),(0,i.kt)("h2",{id:"how-do-i-auto-renew-ssl-certificates-with-acmesh"},"How do I auto renew SSL certificates with acme.sh?"),(0,i.kt)("p",null,"You can run the commands below to achieve this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl --output /root/.acme.sh/renew-hook-update-apisix.sh --silent https://gist.githubusercontent.com/anjia0532/9ebf8011322f43e3f5037bc2af3aeaa6/raw/65b359a4eed0ae990f9188c2afa22bacd8471652/renew-hook-update-apisix.sh\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"chmod +x /root/.acme.sh/renew-hook-update-apisix.sh\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'acme.sh  --issue  --staging  -d demo.domain --renew-hook "/root/.acme.sh/renew-hook-update-apisix.sh  -h http://apisix-admin:port -p /root/.acme.sh/demo.domain/demo.domain.cer -k /root/.acme.sh/demo.domain/demo.domain.key -a xxxxxxxxxxxxx"\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"acme.sh --renew --domain demo.domain\n")),(0,i.kt)("p",null,"You can check ",(0,i.kt)("a",{parentName:"p",href:"https://juejin.cn/post/6965778290619449351"},"this post")," for a more detailed instruction on setting this up."),(0,i.kt)("h2",{id:"how-do-i-strip-a-prefix-from-a-path-before-forwarding-to-upstream-in-apache-apisix"},"How do I strip a prefix from a path before forwarding to Upstream in Apache APISIX?"),(0,i.kt)("p",null,"To strip a prefix from a path in your route, like to take ",(0,i.kt)("inlineCode",{parentName:"p"},"/foo/get")," and strip it to ",(0,i.kt)("inlineCode",{parentName:"p"},"/get"),", you can use the ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/3.10/plugins/proxy-rewrite"},"proxy-rewrite")," Plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1 -H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "uri": "/foo/*",\n    "plugins": {\n        "proxy-rewrite": {\n            "regex_uri": ["^/foo/(.*)","/$1"]\n        }\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "httpbin.org:80": 1\n        }\n    }\n}\'\n')),(0,i.kt)("p",null,"And to test this configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/foo/get -i\nHTTP/1.1 200 OK\n...\n{\n  ...\n  "url": "http://127.0.0.1/get"\n}\n')),(0,i.kt)("h2",{id:"how-do-i-fix-the-error-unable-to-get-local-issuer-certificate-in-apache-apisix"},"How do I fix the error ",(0,i.kt)("inlineCode",{parentName:"h2"},"unable to get local issuer certificate")," in Apache APISIX?"),(0,i.kt)("p",null,"You can manually set the path to your certificate by adding it to your ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," file as shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apisix:\n  ssl:\n    ssl_trusted_certificate: /path/to/certs/ca-certificates.crt\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": When you are trying to connect TLS services with cosocket and if APISIX does not trust the peer's TLS certificate, you should set the parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix.ssl.ssl_trusted_certificate"),"."),(0,i.kt)("p",null,"For example, if you are using Nacos for service discovery in APISIX, and Nacos has TLS enabled (configured host starts with ",(0,i.kt)("inlineCode",{parentName:"p"},"https://"),"), you should set ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix.ssl.ssl_trusted_certificate")," and use the same CA certificate as Nacos."),(0,i.kt)("h2",{id:"how-do-i-fix-the-error-module-restyworkerevents-not-found-in-apache-apisix"},"How do I fix the error ",(0,i.kt)("inlineCode",{parentName:"h2"},"module 'resty.worker.events' not found")," in Apache APISIX?"),(0,i.kt)("p",null,"This error is caused by installing Apache APISIX in the ",(0,i.kt)("inlineCode",{parentName:"p"},"/root"),' directory. The worker process would by run by the user "nobody" and it would not have enough permissions to access the files in the ',(0,i.kt)("inlineCode",{parentName:"p"},"/root")," directory."),(0,i.kt)("p",null,"To fix this, you can change the APISIX installation directory to the recommended directory: ",(0,i.kt)("inlineCode",{parentName:"p"},"/usr/local"),"."),(0,i.kt)("h2",{id:"what-is-the-difference-between-plugin-metadata-and-plugin-configs-in-apache-apisix"},"What is the difference between ",(0,i.kt)("inlineCode",{parentName:"h2"},"plugin-metadata")," and ",(0,i.kt)("inlineCode",{parentName:"h2"},"plugin-configs")," in Apache APISIX?"),(0,i.kt)("p",null,"The differences between the two are described in the table below:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"th"},"plugin-metadata")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"th"},"plugin-config")))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Metadata of a Plugin shared by all configuration instances of the Plugin."),(0,i.kt)("td",{parentName:"tr",align:null},"Collection of configuration instances of multiple different Plugins.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Used when there are property changes that needs to be propagated across all configuration instances of a Plugin."),(0,i.kt)("td",{parentName:"tr",align:null},"Used when you need to reuse a common set of configuration instances so that it can be extracted to a ",(0,i.kt)("inlineCode",{parentName:"td"},"plugin-config")," and bound to different Routes.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Takes effect on all the entities bound to the configuration instances of the Plugin."),(0,i.kt)("td",{parentName:"tr",align:null},"Takes effect on Routes bound to the ",(0,i.kt)("inlineCode",{parentName:"td"},"plugin-config"),".")))),(0,i.kt)("h2",{id:"after-deploying-apache-apisix-how-to-detect-the-survival-of-the-apisix-data-plane"},"After deploying Apache APISIX, how to detect the survival of the APISIX data plane?"),(0,i.kt)("p",null,"You can create a route named ",(0,i.kt)("inlineCode",{parentName:"p"},"health-info")," and enable the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/fault-injection/"},"fault-injection")," plugin (where YOUR-TOKEN is the user's token; 127.0.0.1 is the IP address of the control plane, which can be modified by yourself):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/health-info \\\n-H \'X-API-KEY: YOUR-TOKEN\' -X PUT -d \'\n{\n   "plugins": {\n     "fault-injection": {\n       "abort": {\n        "http_status": 200,\n        "body": "fine"\n       }\n     }\n   },\n   "uri": "/status"\n}\'\n')),(0,i.kt)("p",null,"Verification:"),(0,i.kt)("p",null,"Access the ",(0,i.kt)("inlineCode",{parentName:"p"},"/status")," of the Apache APISIX data plane to detect APISIX. If the response code is 200, it means APISIX is alive."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"This method only detects whether the APISIX data plane is alive or not. It does not mean that the routing and other functions of APISIX are normal. These require more routing-level detection."))),(0,i.kt)("h2",{id:"what-are-the-scenarios-with-high-apisix-latency-related-to-etcd-and-how-to-fix-them"},"What are the scenarios with high APISIX latency related to ",(0,i.kt)("a",{parentName:"h2",href:"https://etcd.io/"},"etcd")," and how to fix them?"),(0,i.kt)("p",null,"etcd is the data storage component of apisix, and its stability is related to the stability of APISIX."),(0,i.kt)("p",null,"In actual scenarios, if APISIX uses a certificate to connect to etcd through HTTPS, the following two problems of high latency for data query or writing may occur:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Query or write data through APISIX Admin API."),(0,i.kt)("li",{parentName:"ol"},"In the monitoring scenario, Prometheus crawls the APISIX data plane Metrics API timeout.")),(0,i.kt)("p",null,"These problems related to higher latency seriously affect the service stability of APISIX, and the reason why such problems occur is mainly because etcd provides two modes of operation: HTTP (HTTPS) and gRPC. And APISIX uses the HTTP (HTTPS) protocol to operate etcd by default.\nIn this scenario, etcd has a bug about HTTP/2: if etcd is operated over HTTPS (HTTP is not affected), the upper limit of HTTP/2 connections is the default ",(0,i.kt)("inlineCode",{parentName:"p"},"250")," in Golang. Therefore, when the number of APISIX data plane nodes is large, once the number of connections between all APISIX nodes and etcd exceeds this upper limit, the response of APISIX API interface will be very slow."),(0,i.kt)("p",null,"In Golang, the default upper limit of HTTP/2 connections is ",(0,i.kt)("inlineCode",{parentName:"p"},"250"),", the code is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"package http2\n\nimport ...\n\nconst (\n    prefaceTimeout         = 10 * time.Second\n    firstSettingsTimeout   = 2 * time.Second // should be in-flight with preface anyway\n    handlerChunkWriteSize  = 4 << 10\n    defaultMaxStreams      = 250 // TODO: make this 100 as the GFE seems to?\n    maxQueuedControlFrames = 10000\n)\n\n")),(0,i.kt)("p",null,"etcd officially maintains two main branches, ",(0,i.kt)("inlineCode",{parentName:"p"},"3.4")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"3.5"),". In the ",(0,i.kt)("inlineCode",{parentName:"p"},"3.4")," series, the recently released ",(0,i.kt)("inlineCode",{parentName:"p"},"3.4.20")," version has fixed this issue. As for the ",(0,i.kt)("inlineCode",{parentName:"p"},"3.5")," version, the official is preparing to release the ",(0,i.kt)("inlineCode",{parentName:"p"},"3.5.5")," version a long time ago, but it has not been released as of now (2022.09.13). So, if you are using etcd version less than ",(0,i.kt)("inlineCode",{parentName:"p"},"3.5.5"),", you can refer to the following ways to solve this problem:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Change the communication method between APISIX and etcd from HTTPS to HTTP."),(0,i.kt)("li",{parentName:"ol"},"Roll back the etcd to ",(0,i.kt)("inlineCode",{parentName:"li"},"3.4.20"),"."),(0,i.kt)("li",{parentName:"ol"},"Clone the etcd source code and compile the ",(0,i.kt)("inlineCode",{parentName:"li"},"release-3.5")," branch directly (this branch has fixed the problem of HTTP/2 connections, but the new version has not been released yet).")),(0,i.kt)("p",null,"The way to recompile etcd is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"git checkout release-3.5\nmake GOOS=linux GOARCH=amd64\n")),(0,i.kt)("p",null,"The compiled binary is in the bin directory, replace it with the etcd binary of your server environment, and then restart etcd:"),(0,i.kt)("p",null,"For more information, please refer to:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/etcd-io/etcd/issues/14185"},"when etcd node have many http long polling connections, it may cause etcd to respond slowly to http requests.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/issues/7078"},"bug: when apisix starts for a while, its communication with etcd starts to time out")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/issues/7353"},"the prometheus metrics API is tool slow")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/etcd-io/etcd/pull/14169"},"Support configuring ",(0,i.kt)("inlineCode",{parentName:"a"},"MaxConcurrentStreams")," for http2"))),(0,i.kt)("p",null,"Another solution is to switch to an experimental gRPC-based configuration synchronization. This requires setting ",(0,i.kt)("inlineCode",{parentName:"p"},"use_grpc: true")," in the configuration file ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'  etcd:\n    use_grpc: true\n    host:\n      - "http://127.0.0.1:2379"\n    prefix: "/apisix"\n')),(0,i.kt)("h2",{id:"why-is-the-file-logger-logging-garbled"},"Why is the file-logger logging garbled?"),(0,i.kt)("p",null,"If you are using the ",(0,i.kt)("inlineCode",{parentName:"p"},"file-logger")," plugin but getting garbled logs, one possible reason is your upstream response has returned a compressed response body. You can fix this by setting the accept-encoding in the request header to not receive compressed responses using the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/proxy-rewrite/"},"proxy-rewirte")," plugin:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/routes/1 \\\n-H \'X-API-KEY: YOUR-TOKEN\' -X PUT -d \'\n{\n    "methods":[\n        "GET"\n    ],\n    "uri":"/test/index.html",\n    "plugins":{\n        "proxy-rewrite":{\n            "headers":{\n                "set":{\n                    "accept-encoding":"gzip;q=0,deflate,sdch"\n                }\n            }\n        }\n    },\n    "upstream":{\n        "type":"roundrobin",\n        "nodes":{\n            "127.0.0.1:80":1\n        }\n    }\n}\'\n')),(0,i.kt)("h2",{id:"how-does-apisix-configure-etcd-with-authentication"},"How does APISIX configure ETCD with authentication?"),(0,i.kt)("p",null,"Suppose you have an ETCD cluster that enables the auth. To access this cluster, you need to configure the correct username and password for Apache APISIX in ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'deployment:\n  etcd:\n    host:\n      - "http://127.0.0.1:2379"\n    user: etcd_user             # username for etcd\n    password: etcd_password     # password for etcd\n')),(0,i.kt)("p",null,"For other ETCD configurations, such as expiration times, retries, and so on, you can refer to the ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd")," section in the sample configuration ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml.example")," file."),(0,i.kt)("h2",{id:"what-is-the-difference-between-ssls-tlsclient_cert-in-upstream-configurations-and-ssl_trusted_certificate-in-configyaml"},"What is the difference between SSLs, ",(0,i.kt)("inlineCode",{parentName:"h2"},"tls.client_cert")," in upstream configurations, and ",(0,i.kt)("inlineCode",{parentName:"h2"},"ssl_trusted_certificate")," in ",(0,i.kt)("inlineCode",{parentName:"h2"},"config.yaml"),"?"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"ssls")," is managed through the ",(0,i.kt)("inlineCode",{parentName:"p"},"/apisix/admin/ssls")," API. It's used for managing TLS certificates. These certificates may be used during TLS handshake (between Apache APISIX and its clients). Apache APISIX uses Server Name Indication (SNI) to differentiate between certificates of different domains."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"tls.client_cert"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"tls.client_key"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"tls.client_cert_id")," in upstream are used for mTLS communication with the upstream."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"ssl_trusted_certificate")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," configures a trusted CA certificate. It is used for verifying some certificates signed by private authorities within APISIX, to avoid APISIX rejects the certificate. Note that it is not used to trust the certificates of APISIX upstream, because APISIX does not verify the legality of the upstream certificates. Therefore, even if the upstream uses an invalid TLS certificate, it can still be accessed without configuring a root certificate."),(0,i.kt)("h2",{id:"where-can-i-find-more-answers"},"Where can I find more answers?"),(0,i.kt)("p",null,"You can find more answers on:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/general/join/#join-the-slack-channel"},"Apache APISIX Slack Channel")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/general/join/#subscribe-to-the-mailing-list"},"Ask questions on APISIX mailing list")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc"},"GitHub Issues")," and ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/apache/apisix/discussions"},"GitHub Discussions"))))}c.isMDXComponent=!0}}]);