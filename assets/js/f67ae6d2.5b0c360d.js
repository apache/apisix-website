"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[70646],{35318:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var o=n(27378);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=o.createContext({}),s=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=s(e.components);return o.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),h=s(n),m=r,d=h["".concat(p,".").concat(m)]||h[m]||c[m]||a;return n?o.createElement(d,i(i({ref:t},u),{},{components:n})):o.createElement(d,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=h;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var s=2;s<a;s++)i[s]=n[s];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},41107:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>l,toc:()=>s});var o=n(25773),r=(n(27378),n(35318));const a={title:"Chopping the monolith in a smarter way",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["DevOps","Performance","Architecture","System Architecture","System Design"],description:"In my previous post Chopping the Monolith, I explained that some parts of a monolith are pretty stable and only the fast-changing parts are worth being \"chopped.\" I turned the post into a talk and presented it at several conferences. I think it's pretty well received; I believe it's because most developers understand, or have direct experience, that microservices are not a good fit for traditional organizations, as per Conway's Law.\n",tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2023/11/29/LfrGvISN_roger_stone.jpg"},i=void 0,l={permalink:"/blog/2023/11/30/chopping-monolith-smarter-way",source:"@site/blog/2023/11/30/chopping-monolith-smarter-way.md",title:"Chopping the monolith in a smarter way",description:"In my previous post Chopping the Monolith, I explained that some parts of a monolith are pretty stable and only the fast-changing parts are worth being \"chopped.\" I turned the post into a talk and presented it at several conferences. I think it's pretty well received; I believe it's because most developers understand, or have direct experience, that microservices are not a good fit for traditional organizations, as per Conway's Law.\n",date:"2023-11-30T00:00:00.000Z",formattedDate:"November 30, 2023",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:3.54,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Biweekly Report (November 20 - December 03)",permalink:"/blog/2023/12/04/bi-weekly-report"},nextItem:{title:"Biweekly Report (November 06 - November 19)",permalink:"/blog/2023/11/23/bi-weekly-report"}},p={authorsImageUrls:[void 0]},s=[{value:"Apache APISIX configuration",id:"apache-apisix-configuration",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],u={toc:s};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"In my previous post ",(0,r.kt)("a",{parentName:"p",href:"https://blog.frankel.ch/chopping-monolith-smarter-way/"},"Chopping the Monolith"),", I explained that some parts of a monolith are pretty stable and only the fast-changing parts are worth being \"chopped.\" I turned the post into a talk and presented it at several conferences. I think it's pretty well received; I believe it's because most developers understand, or have direct experience, that microservices are not a good fit for traditional organizations, as per ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Conway%27s_law"},"Conway's Law"),".")),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/chopping-monolith-smarter-way/"})),(0,r.kt)("p",null,"In the talk, I use an e-commerce webapp as an example."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/11/29/Cjqme0MX_original-flow.svg",alt:"Regular requests flow"})),(0,r.kt)("p",null,"The pricing needs to change often due to business requirements, and it is a good candidate for chopping. The idea is first to expose pricing as an HTTP route."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/11/29/YMKWYnRr_forked-flow.svg",alt:"Forked requests flow"})),(0,r.kt)("p",null,"At this point, we can configure the Gateway to forward pricing calls with the cart payload to another component, ",(0,r.kt)("em",{parentName:"p"},"e.g."),", a  ",(0,r.kt)("abbr",{title:"Function-as-a-Service"},"FaaS"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/11/29/Su1xz9Qf_forked-flow-to-faas.svg",alt:"Forked requests flow"})),(0,r.kt)("p",null,"I expected a lot of pushback because we now need twice the number of HTTP calls. Given that the client is remote, it has a non-trivial performance cost. It has yet to be mentioned, but I'd like to offer another better-designed approach today."),(0,r.kt)("p",null,"In particular, we can move the forked calls from the client to the API Gateway. We still have twice the number of calls, but since the Gateway is much closer to the upstream(s), the performance hit is much lower."),(0,r.kt)("p",null,"No one will be surprised I'm using ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bzp2010/apisix-plugin-pipeline-request"},"apisix-pipeline-request-plugin README")," for my demos. It implements a plugin architecture and comes bundled with plugins that address most possible requirements. We need a plugin that pipes an HTTP call's output to another HTTP call's input. It's not part of the current out-of-the-box plugin portfolio; however, when no plugin fits your requirement, you can develop your own - or find one that does. My colleague Zeping Bai has developed such a plugin:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"When handling client requests, the plugin will iterate through the nodes section of the configuration, requesting them in turn."),(0,r.kt)("p",{parentName:"blockquote"},"In the first request, it will send the complete method, query, header, and body of the client request, while in subsequent requests it will only send the last response with the POST method."),(0,r.kt)("p",{parentName:"blockquote"},"The successful response will be recorded in a temporary variable, and each request in the loop will get the response body of the previous request and overwrite the response body of the current request."),(0,r.kt)("p",{parentName:"blockquote"},"When the loop ends, the response body will be sent to the client as the final response."),(0,r.kt)("p",{parentName:"blockquote"},"-- ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bzp2010/apisix-plugin-pipeline-request"},"apisix-pipeline-request-plugin README"))),(0,r.kt)("p",null,"The final sequence is the following:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/11/29/H8K0uGVZ_forked-flow-with-pipeline.svg",alt:"Requests flow using the pipeline plugin"})),(0,r.kt)("p",null,"Note that the ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix-pipeline-request-plugin")," consumes the input. As we want to return all the necessary data, we must return both the cart lines and the price in the payload. The pricing should return the cart lines, which is not an issue since it receives it as an input."),(0,r.kt)("h2",{id:"apache-apisix-configuration"},"Apache APISIX configuration"),(0,r.kt)("p",null,"The Apache APISIX configuration is the following:"),(0,r.kt)("table",null,(0,r.kt)("thead",null,(0,r.kt)("tr",null,(0,r.kt)("th",null,"Route"),(0,r.kt)("th",null,"URI"),(0,r.kt)("th",null,"Plugins"),(0,r.kt)("th",null,"Comment"))),(0,r.kt)("tbody",null,(0,r.kt)("tr",null,(0,r.kt)("td",null,"#1"),(0,r.kt)("td",null,(0,r.kt)("code",null,"/*")),(0,r.kt)("td",null,"\xa0"),(0,r.kt)("td",null,"Catch-all route for front-end resources")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"#2"),(0,r.kt)("td",null,(0,r.kt)("code",null,"/api*")),(0,r.kt)("td",null,(0,r.kt)("code",null,"proxy-rewrite")),(0,r.kt)("td",null,(0,r.kt)("ul",null,(0,r.kt)("li",null,"Catch-all route for back-end API calls"),(0,r.kt)("li",null,"The plugin rewrites URIs to remove the ",(0,r.kt)("code",null,"/api")," prefix")))),(0,r.kt)("tr",null,(0,r.kt)("td",null,"#3"),(0,r.kt)("td",null,(0,r.kt)("code",null,"/api/checkout")),(0,r.kt)("td",null,(0,r.kt)("code",null,"pipeline-request")),(0,r.kt)("td",null,"The magic happens here:",(0,r.kt)("ul",null,(0,r.kt)("li",null,"The first pipeline node calls the monolith to return the cart lines"),(0,r.kt)("li",null,"The second calls the pricing component with the cart lines to return the cart lines and the pricing computed in the component")))),(0,r.kt)("tr",null,(0,r.kt)("td",null,"#4"),(0,r.kt)("td",null,(0,r.kt)("code",null,"/api/price")),(0,r.kt)("td",null,(0,r.kt)("code",null,"azure-functions")),(0,r.kt)("td",null,"I implement the pricing in an Azure FaaS, but it's an implementation detail")))),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"In this post, I offer another alternative to chop the monolith. Instead of forking the call on the client side, we fork the call on the Gateway side. While Apache APISIX doesn't offer such a plugin out-of-the-box, the community fills in the blank with the ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix-pipeline-request-plugin"),"."),(0,r.kt)("p",null,"Compared to the original solution, this alternative has a couple of benefits:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Better performance, as the fork happens closer to the Gateway"),(0,r.kt)("li",{parentName:"ul"},"No impact client-side")),(0,r.kt)("p",null,"The complete source code for this post can be found on ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nfrankel/chop-monolith/tree/api"},"GitHub"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To go further:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://blog.frankel.ch/chopping-monolith/"},"Chopping the monolith, the original way")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/bzp2010/apisix-plugin-pipeline-request"},"apisix-pipeline-request-plugin")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://api7.ai/blog/chaining-api-requests-with-api-gateway"},"Chaining API requests with API Gateway"))))}c.isMDXComponent=!0}}]);