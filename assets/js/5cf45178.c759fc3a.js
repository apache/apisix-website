"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[75796],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(27378);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=s(n),g=a,m=d["".concat(p,".").concat(g)]||d[g]||u[g]||i;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},18461:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var r=n(25773),a=(n(27378),n(35318));const i={title:"Use API gateway to proxy gRPC service",authors:[{name:"Bozhong Yu",title:"Author",url:"https://github.com/zaunist",image_url:"https://avatars.githubusercontent.com/u/38528079?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4"}],keywords:["Apache APISIX","gRPC","Google","proto","plugin"],description:"This article shows you how to proxy client HTTP traffic to the back-end gRPC service via the `grpc-transcode` plugin in API Gateway Apache APISIX.",tags:["Ecosystem"]},o=void 0,l={permalink:"/blog/2021/12/30/apisix-proxy-grpc-service",source:"@site/blog/2021/12/30/apisix-proxy-grpc-service.md",title:"Use API gateway to proxy gRPC service",description:"This article shows you how to proxy client HTTP traffic to the back-end gRPC service via the `grpc-transcode` plugin in API Gateway Apache APISIX.",date:"2021-12-30T00:00:00.000Z",formattedDate:"December 30, 2021",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:4.02,truncated:!0,authors:[{name:"Bozhong Yu",title:"Author",url:"https://github.com/zaunist",image_url:"https://avatars.githubusercontent.com/u/38528079?v=4",imageURL:"https://avatars.githubusercontent.com/u/38528079?v=4"},{name:"Sylvia",title:"Technical Writer",url:"https://github.com/SylviaBABY",image_url:"https://avatars.githubusercontent.com/u/39793568?v=4",imageURL:"https://avatars.githubusercontent.com/u/39793568?v=4"}],prevItem:{title:"Use APISIX and Authing to implement authentication",permalink:"/blog/2022/01/04/authing"},nextItem:{title:"Apache APISIX Dashboard Unauthorized Access Vulnerability Announcement (CVE-2021-45232)",permalink:"/blog/2021/12/28/dashboard-cve-2021-45232"}},p={authorsImageUrls:[void 0,void 0]},s=[{value:"Introduction",id:"introduction",children:[{value:"Apache APISIX",id:"apache-apisix",children:[],level:3},{value:"gRPC",id:"grpc",children:[],level:3}],level:2},{value:"Plugin Introduction",id:"plugin-introduction",children:[{value:"Integration Principle",id:"integration-principle",children:[],level:3}],level:2},{value:"How to use",id:"how-to-use",children:[{value:"Environment Preparation",id:"environment-preparation",children:[{value:"Step 1: Configure the grpc-server-example service",id:"step-1-configure-the-grpc-server-example-service",children:[],level:4},{value:"Step 2: Configure Apache APISIX",id:"step-2-configure-apache-apisix",children:[],level:4}],level:3},{value:"Testing Requests",id:"testing-requests",children:[],level:3},{value:"Disabling the plugin",id:"disabling-the-plugin",children:[],level:3}],level:2},{value:"Summary",id:"summary",children:[],level:2}],c={toc:s};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This article shows you how to proxy client HTTP traffic to the back-end gRPC service via the ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin in Apache APISIX.")),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("h3",{id:"apache-apisix"},"Apache APISIX"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX")," is a dynamic, real-time, high-performance API gateway that provides load balancing, dynamic upstream, canary release, service fusion, authentication, observability, and other rich traffic management features. Apache APISIX not only supports dynamic change and hot-plugging of plug-ins, but also has a rich library of plug-in resources."),(0,a.kt)("h3",{id:"grpc"},"gRPC"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://grpc.io/"},"gRPC")," is an open source remote procedure call system initiated by Google. The system is based on HTTP/2 protocol transport, using Protocol Buffers as the interface description language, and can be run in any environment. The gRPC service provides pluggable mode support for load balancing, link tracing, health checking, and authentication, effectively connecting multiple services between data centers."),(0,a.kt)("h2",{id:"plugin-introduction"},"Plugin Introduction"),(0,a.kt)("p",null,"In order to add support for gRPC service proxies, Apache APISIX has released ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode"),", a gRPC-based plugin that invokes gRPC services in a RESTful way."),(0,a.kt)("p",null,"The plugin supports specifying the contents of ",(0,a.kt)("inlineCode",{parentName:"p"},".proto")," files in Apache APISIX and implementing proxies for different gRPC services through user-defined gRPC services."),(0,a.kt)("h3",{id:"integration-principle"},"Integration Principle"),(0,a.kt)("p",null,"The user specifies the ",(0,a.kt)("inlineCode",{parentName:"p"},".proto")," content in Apache APISIX, binds the corresponding proto by the ",(0,a.kt)("inlineCode",{parentName:"p"},"proto_id")," in the ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin, and configures the Service and Method defined in the ",(0,a.kt)("inlineCode",{parentName:"p"},".proto")," to implement a proxy for the gRPC service."),(0,a.kt)("p",null,"The basic principle is as follows: the user can configure a ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin in the route, and when the route matches the request, it will forward the gRPC request to the upstream service."),(0,a.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin supports configuration of ",(0,a.kt)("inlineCode",{parentName:"p"},"proto_id"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc service name"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc service method"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc deadline"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"pb_option"),". Based on the configuration, the upstream gRPC service is invoked and the response obtained from the upstream gRPC service is returned to the client."))),(0,a.kt)("h2",{id:"how-to-use"},"How to use"),(0,a.kt)("h3",{id:"environment-preparation"},"Environment Preparation"),(0,a.kt)("p",null,"Before configuring Apache APISIX, you need to start the gRPC service."),(0,a.kt)("h4",{id:"step-1-configure-the-grpc-server-example-service"},"Step 1: Configure the grpc-server-example service"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Clone the ",(0,a.kt)("inlineCode",{parentName:"li"},"grpc-server-example")," repository.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"git clone https://github.com/api7/grpc_server_example\n")),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Start grpc-server.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"cd grpc_server_example\ngo run main.go\n")),(0,a.kt)("ol",{start:3},(0,a.kt)("li",{parentName:"ol"},"Verify the gRPC service, it is recommended to use ",(0,a.kt)("inlineCode",{parentName:"li"},"grpcurl")," to verify the availability of the service.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'grpcurl -d \'{"name": "zhangsan"}\' -plaintext 127.0.0.1:50051 helloworld.Greeter.SayHello\n')),(0,a.kt)("p",null,"After correctly starting the gRPC service, executing the above command will output the following."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n "message": "Hello zhangsan"\n}\n')),(0,a.kt)("h4",{id:"step-2-configure-apache-apisix"},"Step 2: Configure Apache APISIX"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Add proto")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/apisix/admin/proto/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "content" : "syntax = \\"proto3\\";\n    package helloworld;\n    service Greeter {\n        rpc SayHello (HelloRequest) returns (HelloReply) {}\n    }\n    message HelloRequest {\n        string name = 1;\n    }\n    message HelloReply {\n        string message = 1;\n    }"\n}\'\n')),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"In the specified Route, proxy the gRPC service interface.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "methods": ["GET"],\n    "uri": "/grpctest",\n    "plugins": {\n        "grpc-transcode": {\n         "proto_id": "1",\n         "service": "helloworld.Greeter",\n         "method": "SayHello"\n        }\n    },\n    "upstream": {\n        "scheme": "grpc",\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:50051": 1\n        }\n    }\n}\'\n')),(0,a.kt)("p",null,"Details of the specific code interpretation and supported parameters can be found below."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"left"},"Name"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Type"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Requirement"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Default"),(0,a.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"proto_id"),(0,a.kt)("td",{parentName:"tr",align:"left"},"string/integer"),(0,a.kt)("td",{parentName:"tr",align:"left"},"required"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N/A"),(0,a.kt)("td",{parentName:"tr",align:"left"},(0,a.kt)("inlineCode",{parentName:"td"},".proto")," content id")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"service"),(0,a.kt)("td",{parentName:"tr",align:"left"},"string"),(0,a.kt)("td",{parentName:"tr",align:"left"},"required"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N/A"),(0,a.kt)("td",{parentName:"tr",align:"left"},"the grpc service name")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"method"),(0,a.kt)("td",{parentName:"tr",align:"left"},"string"),(0,a.kt)("td",{parentName:"tr",align:"left"},"required"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N/A"),(0,a.kt)("td",{parentName:"tr",align:"left"},"the method name of grpc service")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"deadline"),(0,a.kt)("td",{parentName:"tr",align:"left"},"number"),(0,a.kt)("td",{parentName:"tr",align:"left"},"optional"),(0,a.kt)("td",{parentName:"tr",align:"left"},"0"),(0,a.kt)("td",{parentName:"tr",align:"left"},"deadline for grpc in milliseconds")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"left"},"pb_option"),(0,a.kt)("td",{parentName:"tr",align:"left"},"array","[string(pb_option_def)]"),(0,a.kt)("td",{parentName:"tr",align:"left"},"optional"),(0,a.kt)("td",{parentName:"tr",align:"left"},"N/A"),(0,a.kt)("td",{parentName:"tr",align:"left"},"protobuf options")))),(0,a.kt)("h3",{id:"testing-requests"},"Testing Requests"),(0,a.kt)("p",null,"Here we will use cURL for testing."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i http://127.0.0.1:9080/grpctest\\?name=world\nHTTP/1.1 200 OK\nDate: Mon, 27 Dec 2021 06:24:47 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/2.11.0\nTrailer: grpc-status\nTrailer: grpc-message\n\n{"message":"Hello world"}\ngrpc-status: 0\ngrpc-message:\n')),(0,a.kt)("p",null,"The feedback from the code shows that the request was successfully proxied to the back-end gRPC service."),(0,a.kt)("h3",{id:"disabling-the-plugin"},"Disabling the plugin"),(0,a.kt)("p",null,"If you are done using the ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin on the route, simply remove the plugin-related configuration from the route configuration to turn off the ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin on the route."),(0,a.kt)("p",null,"Thanks to the Apache APISIX plugin hot-loading mode, there is no need to restart Apache APISIX to turn it on and off."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'# Disable the plugin\ncurl http://127.0.0.1:9080/apisix/admin/routes/111 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "methods": ["GET"],\n    "uri": "/grpctest",\n    "plugins": {},\n    "upstream": {\n        "scheme": "grpc",\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:50051": 1\n        }\n    }\n}\'\n')),(0,a.kt)("h2",{id:"summary"},"Summary"),(0,a.kt)("p",null,"This article provides a step-by-step guide to using the ",(0,a.kt)("inlineCode",{parentName:"p"},"grpc-transcode")," plugin to proxy requests to a back-end gRPC service via RESTful. By using this plugin, Apache APISIX can be configured to proxy to the gRPC service only."),(0,a.kt)("p",null,"For more descriptions and a complete configuration list of the grpc-transcode plugin, please refer to the ",(0,a.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/next/plugins/grpc-transcode/"},"official documentation"),"."))}u.isMDXComponent=!0}}]);