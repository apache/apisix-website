"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[24733],{35318:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||r;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1417:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var a=n(25773),i=(n(27378),n(35318));const r={title:"Coraza: Elevating APISIX with Cutting-Edge WAF Features",authors:[{name:"Guohao Wang",title:"Author",url:"https://github.com/sn0rt",image_url:"https://avatars.githubusercontent.com/u/2706161?v=4"},{name:"Yilia Lin",title:"Technical Writer",url:"https://github.com/Yilialinn",image_url:"https://avatars.githubusercontent.com/u/114121331?v=4"}],keywords:["APISIX","Coraza","WAF"],description:"The integration of APISIX and Coraza provides reliable security protection and ensures the integrity and reliability of API services.",tags:["Ecosystem"],image:"https://static.api7.ai/uploads/2025/03/27/vFVg9LxN_apisix-coraza.webp"},o=void 0,s={permalink:"/blog/2023/09/08/APISIX-integrates-with-Coraza",source:"@site/blog/2023/09/08/APISIX-integrates-with-Coraza.md",title:"Coraza: Elevating APISIX with Cutting-Edge WAF Features",description:"The integration of APISIX and Coraza provides reliable security protection and ensures the integrity and reliability of API services.",date:"2023-09-08T00:00:00.000Z",formattedDate:"September 8, 2023",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:6.77,truncated:!0,authors:[{name:"Guohao Wang",title:"Author",url:"https://github.com/sn0rt",image_url:"https://avatars.githubusercontent.com/u/2706161?v=4",imageURL:"https://avatars.githubusercontent.com/u/2706161?v=4"},{name:"Yilia Lin",title:"Technical Writer",url:"https://github.com/Yilialinn",image_url:"https://avatars.githubusercontent.com/u/114121331?v=4",imageURL:"https://avatars.githubusercontent.com/u/114121331?v=4"}],prevItem:{title:"Biweekly Report (August 28 - September 10)",permalink:"/blog/2023/09/13/biweekly-report"},nextItem:{title:"Release Apache APISIX 3.5.0",permalink:"/blog/2023/09/01/release-apache-apisix-3.5.0"}},l={authorsImageUrls:[void 0,void 0]},c=[{value:"Apache APISIX",id:"apache-apisix",children:[],level:2},{value:"Coraza",id:"coraza",children:[],level:2},{value:"Why APISIX Prefers Coraza-WAF?",id:"why-apisix-prefers-coraza-waf",children:[{value:"Open-Source Community",id:"open-source-community",children:[],level:3},{value:"Support Wasm Plugins",id:"support-wasm-plugins",children:[],level:3},{value:"Using Core Rule Set",id:"using-core-rule-set",children:[],level:3},{value:"Easy Installation and Deployment",id:"easy-installation-and-deployment",children:[],level:3}],level:2},{value:"How to Use Coraza in APISIX",id:"how-to-use-coraza-in-apisix",children:[{value:"Configuring APISIX Integration with coraza-proxy-wasm",id:"configuring-apisix-integration-with-coraza-proxy-wasm",children:[],level:3},{value:"Configuring the <code>/anything</code> route to integrate Coraza&#39;s WAF rules",id:"configuring-the-anything-route-to-integrate-corazas-waf-rules",children:[],level:3}],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The integration of APISIX and Coraza provides reliable security protection and ensures the integrity and reliability of API services.")),(0,i.kt)("p",null,"With the rapid advancement of cloud-native technology, securing APIs has become increasingly crucial. In response to this growing need, ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix"},"Apache APISIX")," has introduced a range of cutting-edge features. Among them, it is commendable that APISIX has integrated the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/corazawaf/coraza-proxy-wasm"},"coraza-proxy-wasm")," plugin. We will delve into APISIX's enhanced WAF capabilities and explore how Coraza can fortify applications against a wide array of web attacks, ensuring comprehensive security."),(0,i.kt)("h2",{id:"apache-apisix"},"Apache APISIX"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX")," is a dynamic, real-time, high-performance open-source API gateway that provides rich traffic management functions such as load balancing, dynamic upstream, canary release, circuit breaking, authentication, and observability. Being built based on NGINX and LuaJIT, Apache APISIX has ultra-high performance with a single-core QPS of up to 23,000 and an average delay of only 0.2 milliseconds. It can solve problems in traditional architecture, and at the same time adapt to the needs of the cloud-native era."),(0,i.kt)("p",null,"As an API gateway, Apache APISIX has a wide range of application scenarios. It can be applied to scenarios such as gateways, Kubernetes Ingress, and service mesh, and can help enterprises quickly and safely process API and microservice traffic. At present, it has been tested and highly recognized by worldwide enterprises and organizations such as Amber Group, ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/blog/2021/11/03/airwallex-usercase/"},"Airwallex"),", Lotus Cars, vivo, and European Factory Platform."),(0,i.kt)("h2",{id:"coraza"},"Coraza"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Web_application_firewall"},"WAF"),", or Web Application Firewall, is a network security tool designed to safeguard web applications against various cyberattacks by filtering and monitoring HTTP communications between web applications and the internet."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://coraza.io/"},"Coraza")," is a highly renowned open-source WAF implementation. Integrating Coraza with APISIX significantly enhances APISIX's ability to protect upstream services."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"It provides specific advantages in the following areas:")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Attack Detection and Prevention: Coraza, through real-time analysis and monitoring of HTTP and HTTPS traffic, can detect and prevent common web attacks such as SQL injection, Cross-Site Scripting (XSS), Cross-Site Request Forgery (CSRF), and more.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Logging and Reporting Capabilities: Coraza offers advanced logging and reporting features, allowing administrators to track and analyze security events within the system. This aids in promptly identifying potential threats and taking appropriate measures to address security issues.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Flexibility and Scalability: It provides flexible configuration options, allowing administrators to customize according to specific application needs. It supports custom rules and policies, which can be configured based on specific security requirements. Additionally, it can integrate with other security tools and systems, providing a more comprehensive security solution."))),(0,i.kt)("h2",{id:"why-apisix-prefers-coraza-waf"},"Why APISIX Prefers Coraza-WAF?"),(0,i.kt)("h3",{id:"open-source-community"},"Open-Source Community"),(0,i.kt)("p",null,"When selecting a new WAF solution, APISIX places significant importance on its support for the open-source community. Similar to APISIX, Coraza has an active developer community. The support of the open-source community enables Coraza to provide timely updates and support. Community members actively participate in the development and maintenance of Coraza, continuously improving and optimizing the code, and addressing vulnerabilities and security issues. Users benefit from these timely updates, maintaining the security and stability of their applications."),(0,i.kt)("p",null,"The Coraza open-source community coordinates with the development and evolution of APISIX. As a WAF solution for APISIX, Coraza can closely integrate with the features and capabilities of APISIX to meet users' security needs. Collaboration and feedback from the open-source community contribute to driving further development of the solution and ensuring its compatibility and consistency with APISIX."),(0,i.kt)("h3",{id:"support-wasm-plugins"},"Support Wasm Plugins"),(0,i.kt)("p",null,"APISIX supports developing plugins with ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/blog/2021/11/19/apisix-supports-wasm/#how-to-use-wasm-in-apache-apisix"},"WebAssembly (Wasm)"),", and Coraza also provides Wasm plugins as an option. Therefore, integrating Coraza with APISIX incurs relatively low costs."),(0,i.kt)("p",null,"Wasm can be utilized cross-platform, allowing APISIX and Coraza to work seamlessly without additional extensive modifications or adaptations. This eliminates extensive code modifications and adaptations."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The benefits of this low-cost integration include:")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Verified Solution: Although the Coraza wasm plugin was not developed specifically for APISIX, it has been validated on the Istio platform. In terms of functionality, the plugin can provide guarantees consistent with Istio."),(0,i.kt)("li",{parentName:"ol"},"Low Development and Maintenance Costs: The Coraza wasm plugin is a platform-independent binary file, making its release and development process extremely convenient. Extending the Coraza wasm plugin can be achieved with proxy-wasm-go-sdk, where releasing only requires updating the binary file, further simplifying the process.")),(0,i.kt)("h3",{id:"using-core-rule-set"},"Using Core Rule Set"),(0,i.kt)("p",null,"Traditional WAF solutions often require the installation and configuration of specific modules on web servers, such as NGINX, to integrate and communicate with the WAF engine. This integration process can be cumbersome for Ops engineers, involving complex configurations and compatibility issues with different software versions."),(0,i.kt)("p",null,"However, Coraza utilizes the Core Rule Set (CRS) as its rule set. CRS is a widely adopted and validated open-source set of rules designed for the detection and defense of common attacks in web applications. What sets Coraza apart from traditional WAF solutions is its ability to directly parse and execute CRS rules without additional compilation of NGINX. The use of CRS provides enhanced security protection for APISIX along with support from the CRS community."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"This design brings several important benefits:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Simplified Maintenance for Coraza: As it doesn't require the support of nginx_module, the Ops engineers do not need to deal with complex module installation and configuration processes. Instead, they can focus on maintaining and updating the CRS rule set, ensuring it contains the latest security rules and fixes.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Increased Stability and Reliability of the Entire Solution: CRS, as a mature rule set, has undergone long-term practice and improvement and has been widely adopted and supported by the community. This means Coraza users can benefit from the collective wisdom of the CRS community and receive timely security updates and fixes."))),(0,i.kt)("h3",{id:"easy-installation-and-deployment"},"Easy Installation and Deployment"),(0,i.kt)("p",null,"Coraza doesn't require the support of nginx_module, making it easy to maintain. This is because Coraza is an independent WAF that doesn't rely on NGINX or support from other web server modules and can integrate with different web servers."),(0,i.kt)("p",null,"This independence makes Coraza's maintenance easier as it doesn't need to depend on specific web server configurations or module installations. Administrators can configure and manage Coraza independently without worrying about compatibility with other server components."),(0,i.kt)("h2",{id:"how-to-use-coraza-in-apisix"},"How to Use Coraza in APISIX"),(0,i.kt)("p",null,"Please note that to use Coraza functionality, you need to install the APISIX master version. Currently, this feature is in the preview stage, and it is expected to be officially supported in version 3.6.0."),(0,i.kt)("h3",{id:"configuring-apisix-integration-with-coraza-proxy-wasm"},"Configuring APISIX Integration with coraza-proxy-wasm"),(0,i.kt)("p",null,"Navigate to the directory of ",(0,i.kt)("inlineCode",{parentName:"p"},"APISIX")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cd /home/ubuntu/apisix-master\n")),(0,i.kt)("p",null,"Modify the configuration ",(0,i.kt)("inlineCode",{parentName:"p"},"file conf/config-default.yaml")," and cancel the original comment in the wasm configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"wasm:\n  plugins:\n    - name: coraza-filter\n      priority: 7999\n      file: /home/ubuntu/coraza-proxy-wasm/build/main.wasm # Write absolute path\n")),(0,i.kt)("h3",{id:"configuring-the-anything-route-to-integrate-corazas-waf-rules"},"Configuring the ",(0,i.kt)("inlineCode",{parentName:"h3"},"/anything")," route to integrate Coraza's WAF rules"),(0,i.kt)("p",null,"Reconfigure routing and enable the ",(0,i.kt)("inlineCode",{parentName:"p"},"coraza-filter")," plugin"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl -i http://127.0.0.1:9180/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'{\n  "uri": "/anything",\n  "plugins": {\n    "coraza-filter": {\n      "conf": {\n        "directives_map": {\n          "default": [\n            "SecDebugLogLevel 9",\n            "SecRuleEngine On",\n            "SecRule REQUEST_URI \\"@beginsWith /anything\\" \\"id:101,phase:1,t:lowercase,deny\\""\n          ]\n        },\n        "default_directives": "default"\n      }\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,i.kt)("p",null,"Test the WAF rules and we can see 403"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://localhost:9080/anything -v\n*   Trying 127.0.0.1:9080...\n* TCP_NODELAY set\n* Connected to localhost (127.0.0.1) port 9080 (#0)\n> GET /anything HTTP/1.1\n> Host: localhost:9080\n> User-Agent: curl/7.68.0\n> Accept: */*\n>\n* Mark bundle as not supporting multiuse\n< HTTP/1.1 403 Forbidden\n< Date: Thu, 31 Aug 2023 09:09:18 GMT\n< Content-Type: text/html; charset=utf-8\n< Content-Length: 225\n< Connection: keep-alive\n< Server: APISIX/3.4.0\n<\n<html>\n<head><title>403 Forbidden</title></head>\n<body>\n<center><h1>403 Forbidden</h1></center>\n<hr><center>openresty</center>\n<p><em>Powered by <a href="https://apisix.apache.org/">APISIX</a>.</em></p></body>\n</html>\n* Connection #0 to host localhost left intact\n')),(0,i.kt)("p",null,"Check logs ",(0,i.kt)("inlineCode",{parentName:"p"},"logs/error.log")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'2023/08/31 09:20:39 [info] 126240#126240: *23933 Transaction interrupted tx_id="JVhHVfDuGjVbfgvDjik" context_id=2 action="deny" phase="http_request_headers", client: 127.0.0.1, server: _, request: "GET /anything HTTP/1.1", host: "localhost:9080"\n2023/08/31 09:20:39 [debug] 126240#126240: *23933 Interruption already handled, sending downstream the local response tx_id="JVhHVfDuGjVbfgvDjik" context_id=2 interruption_handled_phase="http_request_headers"\n')),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"Coraza is a powerful WAF framework that offers extensive security features and flexible configuration options, suitable for protecting enterprise web applications from various threats. The integration of APISIX with Coraza is a significant new feature of APISIX. Coraza, as an easy-to-maintain solution, integrated with APISIX, provides enterprises with robust API management and security features."))}u.isMDXComponent=!0}}]);