"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[72282],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},d=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=l(n),m=i,h=u["".concat(s,".").concat(m)]||u[m]||p[m]||r;return n?a.createElement(h,c(c({ref:t},d),{},{components:n})):a.createElement(h,c({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,c=new Array(r);c[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,c[1]=o;for(var l=2;l<r;l++)c[l]=n[l];return a.createElement.apply(null,c)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},98015:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>c,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>s});var a=n(87462),i=(n(67294),n(3905));const r={title:"Mutual TLS Authentication",keywords:["Apache APISIX","Mutual TLS","mTLS"],description:"This document describes how you can secure communication to and within APISIX with mTLS."},c=void 0,o={unversionedId:"mtls",id:"mtls",isDocsHomePage:!1,title:"Mutual TLS Authentication",description:"This document describes how you can secure communication to and within APISIX with mTLS.",source:"@site/docs/apisix/mtls.md",sourceDirName:".",slug:"/mtls",permalink:"/docs/apisix/next/mtls",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/mtls.md",tags:[],version:"current",frontMatter:{title:"Mutual TLS Authentication",keywords:["Apache APISIX","Mutual TLS","mTLS"],description:"This document describes how you can secure communication to and within APISIX with mTLS."},sidebar:"docs",previous:{title:"Running APISIX in AWS with AWS CDK",permalink:"/docs/apisix/next/aws"},next:{title:"Debug Function",permalink:"/docs/apisix/next/debug-function"}},s=[{value:"Protect Admin API",id:"protect-admin-api",children:[{value:"Why use it",id:"why-use-it",children:[]},{value:"How to configure",id:"how-to-configure",children:[]},{value:"How client calls",id:"how-client-calls",children:[]}]},{value:"etcd with mTLS",id:"etcd-with-mtls",children:[{value:"How to configure",id:"how-to-configure-1",children:[]}]},{value:"Protect Route",id:"protect-route",children:[{value:"Why use it",id:"why-use-it-1",children:[]},{value:"How to configure",id:"how-to-configure-2",children:[]}]},{value:"mTLS Between APISIX and Upstream",id:"mtls-between-apisix-and-upstream",children:[{value:"Why use it",id:"why-use-it-2",children:[]},{value:"How to configure",id:"how-to-configure-3",children:[]}]}],l={toc:s};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"protect-admin-api"},"Protect Admin API"),(0,i.kt)("h3",{id:"why-use-it"},"Why use it"),(0,i.kt)("p",null,"Mutual TLS authentication provides a better way to prevent unauthorized access to APISIX."),(0,i.kt)("p",null,"The clients will provide their certificates to the server and the server will check whether the cert is signed by the supplied CA and decide whether to serve the request."),(0,i.kt)("h3",{id:"how-to-configure"},"How to configure"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Generate self-signed key pairs, including ca, server, client key pairs.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Modify configuration items in ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/config.yaml"),":"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="conf/config.yaml"',title:'"conf/config.yaml"'},'  admin_listen:\n    ip: 127.0.0.1\n    port: 9180\n  https_admin: true\n\n  admin_api_mtls:\n    admin_ssl_ca_cert: "/data/certs/mtls_ca.crt"              # Path of your self-signed ca cert.\n    admin_ssl_cert: "/data/certs/mtls_server.crt"             # Path of your self-signed server side cert.\n    admin_ssl_cert_key: "/data/certs/mtls_server.key"         # Path of your self-signed server side key.\n')),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Run command:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"apisix init\napisix reload\n")),(0,i.kt)("h3",{id:"how-client-calls"},"How client calls"),(0,i.kt)("p",null,"Please replace the following certificate paths and domain name with your real ones."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Note: The same CA certificate as the server needs to be used *")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You can fetch the ",(0,i.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl --cacert /data/certs/mtls_ca.crt --key /data/certs/mtls_client.key --cert /data/certs/mtls_client.crt  https://admin.apisix.dev:9180/apisix/admin/routes -H "X-API-KEY: $admin_key"\n')),(0,i.kt)("h2",{id:"etcd-with-mtls"},"etcd with mTLS"),(0,i.kt)("h3",{id:"how-to-configure-1"},"How to configure"),(0,i.kt)("p",null,"You need to configure ",(0,i.kt)("inlineCode",{parentName:"p"},"etcd.tls")," for APISIX to work on an etcd cluster with mTLS enabled as shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="conf/config.yaml"',title:'"conf/config.yaml"'},"deployment:\n  role: traditional\n  role_traditional:\n    config_provider: etcd\n  etcd:\n    tls:\n      cert: /data/certs/etcd_client.pem       # path of certificate used by the etcd client\n      key: /data/certs/etcd_client.key        # path of key used by the etcd client\n")),(0,i.kt)("p",null,"If APISIX does not trust the CA certificate that used by etcd server, we need to set up the CA certificate."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="conf/config.yaml"',title:'"conf/config.yaml"'},"apisix:\n  ssl:\n    ssl_trusted_certificate: /path/to/certs/ca-certificates.crt       # path of CA certificate used by the etcd server\n")),(0,i.kt)("h2",{id:"protect-route"},"Protect Route"),(0,i.kt)("h3",{id:"why-use-it-1"},"Why use it"),(0,i.kt)("p",null,"Using mTLS is a way to verify clients cryptographically. It is useful and important in cases where you want to have encrypted and secure traffic in both directions."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Note: the mTLS protection only happens in HTTPS. If your route can also be accessed via HTTP, you should add additional protection in HTTP or disable the access via HTTP.*")),(0,i.kt)("h3",{id:"how-to-configure-2"},"How to configure"),(0,i.kt)("p",null,"We provide a ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/next/tutorials/client-to-apisix-mtls"},"tutorial")," that explains in detail how to configure mTLS between the client and APISIX."),(0,i.kt)("p",null,"When configuring ",(0,i.kt)("inlineCode",{parentName:"p"},"ssl"),", use parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"client.ca")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"client.depth")," to configure the root CA that signing client certificates and the max length of certificate chain. Please refer to ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/next/admin-api#ssl"},"Admin API")," for details."),(0,i.kt)("p",null,"Here is an example shell script to create SSL with mTLS (id is ",(0,i.kt)("inlineCode",{parentName:"p"},"1"),", changes admin API url if needed):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/ssls/1 \\\n-H "X-API-KEY: $admin_key" -X PUT -d \'\n{\n    "cert": "\'"$(cat t/certs/mtls_server.crt)"\'",\n    "key": "\'"$(cat t/certs/mtls_server.key)"\'",\n    "snis": [\n        "admin.apisix.dev"\n    ],\n    "client": {\n        "ca": "\'"$(cat t/certs/mtls_ca.crt)"\'",\n        "depth": 10\n    }\n}\'\n')),(0,i.kt)("p",null,"Send a request to verify:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl --resolve \'mtls.test.com:<APISIX_HTTPS_PORT>:<APISIX_URL>\' "https://<APISIX_URL>:<APISIX_HTTPS_PORT>/hello" -k --cert ./client.pem --key ./client.key\n\n* Added admin.apisix.dev:9443:127.0.0.1 to DNS cache\n* Hostname admin.apisix.dev was found in DNS cache\n*   Trying 127.0.0.1:9443...\n* Connected to admin.apisix.dev (127.0.0.1) port 9443 (#0)\n* ALPN: offers h2\n* ALPN: offers http/1.1\n*  CAfile: t/certs/mtls_ca.crt\n*  CApath: none\n* [CONN-0-0][CF-SSL] (304) (OUT), TLS handshake, Client hello (1):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, Server hello (2):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, Unknown (8):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, Request CERT (13):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, Certificate (11):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, CERT verify (15):\n* [CONN-0-0][CF-SSL] (304) (IN), TLS handshake, Finished (20):\n* [CONN-0-0][CF-SSL] (304) (OUT), TLS handshake, Certificate (11):\n* [CONN-0-0][CF-SSL] (304) (OUT), TLS handshake, CERT verify (15):\n* [CONN-0-0][CF-SSL] (304) (OUT), TLS handshake, Finished (20):\n* SSL connection using TLSv1.3 / AEAD-AES256-GCM-SHA384\n* ALPN: server accepted h2\n* Server certificate:\n*  subject: C=cn; ST=GuangDong; L=ZhuHai; CN=admin.apisix.dev; OU=ops\n*  start date: Dec  1 10:17:24 2022 GMT\n*  expire date: Aug 18 10:17:24 2042 GMT\n*  subjectAltName: host "admin.apisix.dev" matched cert\'s "admin.apisix.dev"\n*  issuer: C=cn; ST=GuangDong; L=ZhuHai; CN=ca.apisix.dev; OU=ops\n*  SSL certificate verify ok.\n* Using HTTP2, server supports multiplexing\n* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0\n* h2h3 [:method: GET]\n* h2h3 [:path: /hello]\n* h2h3 [:scheme: https]\n* h2h3 [:authority: admin.apisix.dev:9443]\n* h2h3 [user-agent: curl/7.87.0]\n* h2h3 [accept: */*]\n* Using Stream ID: 1 (easy handle 0x13000bc00)\n> GET /hello HTTP/2\n> Host: admin.apisix.dev:9443\n> user-agent: curl/7.87.0\n> accept: */*\n')),(0,i.kt)("p",null,"Please make sure that the SNI fits the certificate domain."),(0,i.kt)("h2",{id:"mtls-between-apisix-and-upstream"},"mTLS Between APISIX and Upstream"),(0,i.kt)("h3",{id:"why-use-it-2"},"Why use it"),(0,i.kt)("p",null,"Sometimes the upstream requires mTLS. In this situation, the APISIX acts as the client, it needs to provide client certificate to communicate with upstream."),(0,i.kt)("h3",{id:"how-to-configure-3"},"How to configure"),(0,i.kt)("p",null,"When configuring ",(0,i.kt)("inlineCode",{parentName:"p"},"upstreams"),", we could use parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"tls.client_cert")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"tls.client_key")," to configure the client certificate APISIX used to communicate with upstreams. Please refer to ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/next/admin-api#upstream"},"Admin API")," for details."),(0,i.kt)("p",null,"This feature requires APISIX to run on ",(0,i.kt)("a",{parentName:"p",href:"/docs/apisix/next/FAQ#how-do-i-build-the-apisix-runtime-environment"},"APISIX-Runtime"),"."),(0,i.kt)("p",null,"Here is a similar shell script to patch a existed upstream with mTLS (changes admin API url if needed):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9180/apisix/admin/upstreams/1 \\\n-H "X-API-KEY: $admin_key" -X PATCH -d \'\n{\n    "tls": {\n        "client_cert": "\'"$(cat t/certs/mtls_client.crt)"\'",\n        "client_key": "\'"$(cat t/certs/mtls_client.key)"\'"\n    }\n}\'\n')))}d.isMDXComponent=!0}}]);