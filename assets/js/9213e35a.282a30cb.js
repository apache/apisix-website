"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[78217],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(27378);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=u(n),m=o,f=h["".concat(s,".").concat(m)]||h[m]||p[m]||a;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var u=2;u<a;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},68538:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>u});var r=n(25773),o=(n(27378),n(35318));const a={title:"The right feature at the right place",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["Cross-cutting concerns","Architecture","Resiliency","Solution Architecture"],description:"Before moving to Developer Relations, I transitioned from Software Architect to Solution Architect long ago. It's a reasonably common career move. The problem in this situation is two-fold:\n1. You know perfectly well software libraries 2. You don't know well infrastructure components\nIt seems logical that people in this situation try to solve problems with the solutions they are most familiar with. However, it doesn't mean it's the best approach. It's a bad one in most cases.\n",tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2023/03/01/UTBANOhW_choice-geedae7b7e1.jpg"},i=void 0,l={permalink:"/blog/2023/02/23/right-feature-right-place",source:"@site/blog/2023/02/23/right-feature-right-place.md",title:"The right feature at the right place",description:"Before moving to Developer Relations, I transitioned from Software Architect to Solution Architect long ago. It's a reasonably common career move. The problem in this situation is two-fold:\n1. You know perfectly well software libraries 2. You don't know well infrastructure components\nIt seems logical that people in this situation try to solve problems with the solutions they are most familiar with. However, it doesn't mean it's the best approach. It's a bad one in most cases.\n",date:"2023-02-23T00:00:00.000Z",formattedDate:"February 23, 2023",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.38,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Biweekly Report (Feb 13 - Feb 26)",permalink:"/blog/2023/03/02/weekly-report-0226"},nextItem:{title:"Securing Admin Access to Apache APISIX",permalink:"/blog/2023/02/09/secure-apisix-admin"}},s={authorsImageUrls:[void 0]},u=[{value:"A concrete example",id:"a-concrete-example",children:[],level:2},{value:"The golden case for API Gateways",id:"the-golden-case-for-api-gateways",children:[],level:2},{value:"Discussion: what belongs where?",id:"discussion-what-belongs-where",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Before moving to Developer Relations, I transitioned from Software Architect to Solution Architect long ago. It's a reasonably common career move. The problem in this situation is two-fold:"),(0,o.kt)("ol",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ol"},"You know perfectly well software libraries"),(0,o.kt)("li",{parentName:"ol"},"You don't know well infrastructure components")),(0,o.kt)("p",{parentName:"blockquote"},"It seems logical that people in this situation try to solve problems with the solutions they are most familiar with. However, it doesn't mean it's the best approach. It's a bad one in most cases.")),(0,o.kt)("head",null,(0,o.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/right-feature-right-place/"})),(0,o.kt)("h2",{id:"a-concrete-example"},"A concrete example"),(0,o.kt)("p",null,'Imagine an API application. It runs on the JVM, and it\'s written in the "Reactive" style with the help of the Spring Boot framework.'),(0,o.kt)("p",null,"One of the requirements is to limit the number of calls a user can make in a timeframe. In the API world, such a Rate Limiting feature is widespread."),(0,o.kt)("p",null,"With my software architect hat on, I'll search for a JVM library that does it. Because I have a bit of experience, I know of the excellent Bucket4J library:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Java rate-limiting library based on token-bucket algorithm"),(0,o.kt)("p",{parentName:"blockquote"},"-- ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/bucket4j/bucket4j"},"Bucket4J"))),(0,o.kt)("p",null,"It's just a matter of integrating the library into my code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'val beans = beans {\n    bean {\n        val props = ref<BucketProperties>()                  //1\n        BucketFactory().create(                              //2\n            props.size,\n            props.refresh.tokens,\n            props.refresh.duration\n        )\n    }\n    bean {\n        coRouter {\n            val handler = HelloHandler(ref())                //3\n            GET("/hello") { handler.hello(it) }\n            GET("/hello/{who}") { handler.helloWho(it) }\n        }\n    }\n}\n\nclass HelloHandler(private val bucket: Bucket) {             //3\n\n    private suspend fun rateLimit(                           //4\n        req: ServerRequest,\n        f: suspend (ServerRequest) -> ServerResponse\n    ) = if (bucket.tryConsume(1))\n            f.invoke(req)\n        else\n            ServerResponse.status(429).buildAndAwait()\n\n    suspend fun hello(req: ServerRequest) = rateLimit(req) { //5\n        ServerResponse.ok().bodyValueAndAwait("Hello World!")\n    }\n}\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Get configuration properties from a ",(0,o.kt)("inlineCode",{parentName:"li"},"@ConfigurationProperties"),"-annotated class"),(0,o.kt)("li",{parentName:"ol"},"Create a properly-configured bucket"),(0,o.kt)("li",{parentName:"ol"},"Pass the bucket to the handler"),(0,o.kt)("li",{parentName:"ol"},"Create a reusable rate-limiting wrapper based on the bucket"),(0,o.kt)("li",{parentName:"ol"},"Wrap the call")),(0,o.kt)("p",null,"At this point, the bucket is for the whole app. If we want a dedicated bucket per user, as per the requirements, we need to:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Bring in Spring Security to authenticate users (or write our own authentication mechanism)"),(0,o.kt)("li",{parentName:"ol"},"Create a bucket per user"),(0,o.kt)("li",{parentName:"ol"},"Store the bucket server-side and bind it to the user session")),(0,o.kt)("p",null,"While it's perfectly acceptable, it's a lot of effort for a feature that one can implement cheaper elsewhere."),(0,o.kt)("h2",{id:"the-golden-case-for-api-gateways"},"The golden case for API Gateways"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"A place for everything, everything in its place")),(0,o.kt)("p",null,"This quote is associated with Samuel Smiles, Mrs. Isabella Beeton, and Benjamin Franklin."),(0,o.kt)("p",null,"In any case, cross-cutting features don't belong in the application but in infrastructure components. Our feature is an API, so it's a perfect use-case for an API Gateway. We can simplify the code by removing Bucket4J and configuring an API Gateway in front of the application."),(0,o.kt)("p",null,"Here's how to do it with ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'consumers:\n  - username: joe\n    plugins:\n      key-auth:                               #1\n        key: joe\n  - username: jane\n    plugins:\n      key-auth:                               #1\n        key: jane\nroutes:\n  - uri: /hello*\n    upstream:\n      type: roundrobin\n      nodes:\n        "resilient-boot:8080": 1\n    plugins:\n      limit-req:                              #2\n        rate: 1\n        burst: 0\n        key: consumer_name                    #3\n        rejected_code: 429\n      key-auth: ~                             #1\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"We use a simple HTTP header for authentication for demo purposes. Real-world apps would use OAuth2.0 or OpenID Connect, but the principle is the same"),(0,o.kt)("li",{parentName:"ol"},"Rate limiting plugin"),(0,o.kt)("li",{parentName:"ol"},"Configure a bucket per consumer")),(0,o.kt)("h2",{id:"discussion-what-belongs-where"},"Discussion: what belongs where?"),(0,o.kt)("p",null,"Before answering the question, let me go through a detour first. The book ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Thinking,_Fast_and_Slow"},"Thinking, Fast and Slow"),' makes the case that the brain has two "modes":'),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},'The book\'s main thesis is that of a dichotomy between two modes of thought: "System 1" is fast, instinctive and emotional; "System 2" is slower, more deliberative, and more logical.')),(0,o.kt)("p",null,"Also, System 2 is much more energy-consuming. Because we are lazy, we tend to favor System 1 - fast and instinctive. Hence, as architects, we will generally favor the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Solutions we are familiar with, ",(0,o.kt)("em",{parentName:"li"},"e.g."),", libraries for former software architects"),(0,o.kt)("li",{parentName:"ul"},'Rules to apply blindly. As a side comment, it\'s the main reason for herd mentality in the tech industry, such as "microservices everywhere"')),(0,o.kt)("p",null,"Hence, take the following advice as guidelines and not rules. Now that this has been said, here's my stance."),(0,o.kt)("p",null,"First, you need to categorize whether the feature is purely technical. For example, classical rate-limiting to prevent ",(0,o.kt)("abbr",{title:"Distributed Denial of Service"},"DDoS")," is purely technical. Such technical features belong in the infrastructure: every Reverse-Proxy worth its salt has this kind of rate-limiting."),(0,o.kt)("p",null,"The more business-related a feature, the closer it must be to the application. Our use-case is slightly business-related because rate-limiting is per user. Still, the API Gateway provides the feature out of the box."),(0,o.kt)("p",null,"Then, know your infrastructure components. It's impossible to know all the components, but you should have a passing knowledge of the elements available inside your org. If you're using a Cloud Provider, get a map of all their proposed services."),(0,o.kt)("p",null,"Regarding the inability to know all the components, talk to your SysAdmins. My experience has shown me that most organizations must utilize their SysAdmins effectively. The latter would like to be more involved in the overall system architecture design but are rarely requested to. Most SysAdmins love to share their knowledge!"),(0,o.kt)("p",null,"You also need to think about configuration. If you need to configure each library component on each instance, that's a huge red flag; prefer an infrastructure component. Some libraries offer a centralized configuration solution, ",(0,o.kt)("em",{parentName:"p"},"e.g."),", ",(0,o.kt)("a",{parentName:"p",href:"https://docs.spring.io/spring-cloud-config/"},"Spring Cloud Config"),". Carefully evaluate the additional complexity of such a component and its failure rate compared to other dedicated infrastructure components."),(0,o.kt)("p",null,"Organizations influence choice ",(0,o.kt)("em",{parentName:"p"},"a lot"),". The same problem in two different organizational contexts may result in two opposite solutions. Familiarity with a solution generally trumps other solutions' better fit."),(0,o.kt)("p",null,"Finally, as I mentioned in the introduction, your experience will influence your choices: former software architects prefer app-centric solutions, and former sys admins infrastructure solutions. One should be careful to limit one's bias toward one's preferred solution, which might not be the best fit in a different context."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"In this post, I've taken the example of per-user rate limiting to show how one can implement it in a library and an infrastructure component. Then, I generalized this example and gave a couple of guidelines. I hope they will help you make better choices regarding where to place a feature in your system."),(0,o.kt)("p",null,"The complete source code for this post can be found on ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/resilient-boot"},"GitHub"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To go further:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/bucket4j/bucket4j"},"Bucket4J")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.spring.io/spring-cloud-config/"},"Spring Cloud Config")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/plugins/limit-req/"},"Apache APISIX rate limiting plugin"))))}p.isMDXComponent=!0}}]);