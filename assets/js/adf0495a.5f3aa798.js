"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[32150],{35318:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(27378);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(n),h=i,d=c["".concat(s,".").concat(h)]||c[h]||m[h]||r;return n?a.createElement(d,o(o({ref:t},p),{},{components:n})):a.createElement(d,o({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1325:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>u});var a=n(25773),i=(n(27378),n(35318));const r={title:"Differentiating rate limits in Apache APISIX",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["APISIX","Rate Limiting","Consumer","Consumer Groups"],description:'In my talk Evolving your APIs, I mention that an API Gateways is a Reverse Proxy "on steroids". One key difference between the former and the latter is that the API Gateway is not unfriendly to business logic. The poster child is rate-limiting.\n',tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2024/07/27/U4BZicm8_speedometer-1249610.jpg"},o=void 0,l={permalink:"/blog/2024/07/25/different-rate-limits-apisix",source:"@site/blog/2024/07/25/different-rate-limits-apisix.md",title:"Differentiating rate limits in Apache APISIX",description:'In my talk Evolving your APIs, I mention that an API Gateways is a Reverse Proxy "on steroids". One key difference between the former and the latter is that the API Gateway is not unfriendly to business logic. The poster child is rate-limiting.\n',date:"2024-07-25T00:00:00.000Z",formattedDate:"July 25, 2024",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.12,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Monthly Report (July 01 - July 31)",permalink:"/blog/2024/07/31/monthly-report"},nextItem:{title:"Advanced URL rewriting with Apache APISIX",permalink:"/blog/2024/07/18/advanced-url-rewrite-apisix"}},s={authorsImageUrls:[void 0]},u=[{value:"Rate-limiting for the masses",id:"rate-limiting-for-the-masses",children:[],level:2},{value:"Per-consumer rate limiting",id:"per-consumer-rate-limiting",children:[],level:2},{value:"Per-group rate limiting",id:"per-group-rate-limiting",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],p={toc:u};function m(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("head",null,(0,i.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/different-rate-limits-apisix/"})),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},'In my talk Evolving your APIs, I mention that an API Gateway is a Reverse Proxy "on steroids". One key difference between the former and the latter is that the API Gateway is not unfriendly to business logic. The poster child is rate-limiting.')),(0,i.kt)("p",null,"Rate-limiting is an age-old Reverse Proxy feature focused on protecting against ",(0,i.kt)("abbr",{title:"Distributed Denial of Service"},"DDoS")," attacks. It treats all clients the same and is purely technical. In this day and age, most API providers offer different subscription tiers; the higher the tier, the higher the rate limit, and the more you pay incidentally. It's not technical anymore and requires to differentiate between clients."),(0,i.kt)("p",null,"In this post, I want to detail how to do it with Apache APISIX. Note I take most of the material from the ",(0,i.kt)("a",{parentName:"p",href:"https://nfrankel.github.io/apisix-workshop/"},"workshop"),"."),(0,i.kt)("h2",{id:"rate-limiting-for-the-masses"},"Rate-limiting for the masses"),(0,i.kt)("p",null,"Apache APISIX offers no less than three plugins to rate limit requests:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/plugins/limit-conn/"},"limit conn"),": limits the number of concurrent requests"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://https://apisix.apache.org/docs/apisix/plugins/limit-req/"},"limit req"),": limits the number of requests based on the ",(0,i.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Leaky_bucket"},"Leaky Bucket")," algorithm"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://https://apisix.apache.org/docs/apisix/plugins/limit-count/"},"limit count"),": limits the number of requests based on a fixed time window")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"limit-count")," plugin is a good candidate for this post."),(0,i.kt)("p",null,"Let's configure the plugin for a route:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'routes:\n  - uri: /get\n    upstream:\n      nodes:\n        "http://httpbin.org:80": 1\n    plugins:\n      limit-count:                     #1\n        count: 1                       #2\n        time_window: 60                #2\n        rejected_code: 429             #3\n#END\n')),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Set the ",(0,i.kt)("inlineCode",{parentName:"li"},"limit-count")," plugin"),(0,i.kt)("li",{parentName:"ol"},"Limit requests to one every 60 seconds"),(0,i.kt)("li",{parentName:"ol"},"Override the default HTTP response code, ",(0,i.kt)("em",{parentName:"li"},"i.e."),", ",(0,i.kt)("inlineCode",{parentName:"li"},"503"))),(0,i.kt)("p",null,"At this point, we configured regular rate limiting."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl -v http://localhost:9080/get\ncurl -v http://localhost:9080/get\n")),(0,i.kt)("p",null,"If we execute the second request before a minute has passed, the result is the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 429 Too Many Requests\nDate: Tue, 09 Jul 2024 06:55:07 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 241\nConnection: keep-alive\nX-RateLimit-Limit: 1                   #1\nX-RateLimit-Remaining: 0               #2\nX-RateLimit-Reset: 59                  #3\nServer: APISIX/3.9.1\n\n<html>\n<head><title>429 Too Many Requests</title></head>\n<body>\n<center><h1>429 Too Many Requests</h1></center>\n<hr><center>openresty</center>\n<p><em>Powered by <a href="https://apisix.apache.org/">APISIX</a>.</em></p></body>\n</html>\n')),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Configured limit"),(0,i.kt)("li",{parentName:"ol"},"Remaining quota"),(0,i.kt)("li",{parentName:"ol"},"Waiting time in seconds before quota replenishment")),(0,i.kt)("h2",{id:"per-consumer-rate-limiting"},"Per-consumer rate limiting"),(0,i.kt)("p",null,"To configure per-consumer rate limiting, we first need to implement request authentication. APISIX offers many authentication plugins; we shall use the simplest one, ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/key-auth/"},(0,i.kt)("inlineCode",{parentName:"a"},"key-auth")),". ",(0,i.kt)("inlineCode",{parentName:"p"},"key-auth")," checks a specific HTTP request header - ",(0,i.kt)("inlineCode",{parentName:"p"},"apikey")," by default."),(0,i.kt)("p",null,"Here's how we configure consumers:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"consumers:\n  - username: johndoe                  #1\n    plugins:\n      key-auth:\n        key: john                      #2\n  - username: janedoe                  #1\n    plugins:\n      key-auth:\n        key: jane                      #2\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Users"),(0,i.kt)("li",{parentName:"ol"},"HTTP header request value")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'apikey: john' localhost:9080/get #1\ncurl -H 'apikey: jane' localhost:9080/get #2\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Authenticate as ",(0,i.kt)("inlineCode",{parentName:"li"},"johndoe")),(0,i.kt)("li",{parentName:"ol"},"Authenticate as ",(0,i.kt)("inlineCode",{parentName:"li"},"janedoe"))),(0,i.kt)("p",null,"In general, you attach plugins to APISIX routes but can also attach them to consumers. We can now move the ",(0,i.kt)("inlineCode",{parentName:"p"},"limit-count")," plugin."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'routes:\n  - uri: /get\n    upstream:\n      nodes:\n        "httpbin:80": 1\n    plugins:\n      key-auth: ~                      #1\n\nconsumers:\n  - username: johndoe\n    plugins:\n      key-auth:\n        key: john\n      limit-count:\n        count: 1                       #2\n        time_window: 60\n        rejected_code: 429\n  - username: janedoe\n    plugins:\n      key-auth:\n        key: jane\n      limit-count:\n        count: 5                       #2\n        time_window: 60\n        rejected_code: 429\n#END\n')),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The route is only accessible to requests authenticating with ",(0,i.kt)("inlineCode",{parentName:"li"},"key-auth")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"johndoe")," has a lower limit count than ",(0,i.kt)("inlineCode",{parentName:"li"},"janedoe"),". Did he forget to pay his subscription fees?")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'apikey: john' localhost:9080/get\ncurl -H 'apikey: john' localhost:9080/get\ncurl -H 'apikey: jane' localhost:9080/get\ncurl -H 'apikey: jane' localhost:9080/get\n")),(0,i.kt)("p",null,"The second request gets rate-limited."),(0,i.kt)("h2",{id:"per-group-rate-limiting"},"Per-group rate limiting"),(0,i.kt)("p",null,"We never attach permissions directly to identities in Identity Management systems. It's considered bad practice because when a person moves around the organization, we need to add and remove permissions one by one. The good practice is to attach permissions to groups and set the person in that group. When the person moves, we change their group; the person loses permissions from the old group and gets permissions from the new group. People get their permissions ",(0,i.kt)("em",{parentName:"p"},"transitively")," via their groups."),(0,i.kt)("p",null,"Apache APISIX offers an abstraction called a ",(0,i.kt)("inlineCode",{parentName:"p"},"Consumer Group")," for this."),(0,i.kt)("p",null,"Let's create two consumer groups with different rate limit values:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"consumer_groups:\n  - id: 1\n    plugins:\n      limit-count:\n        count: 1\n        time_window: 60\n        rejected_code: 429\n  - id: 2\n    plugins:\n      limit-count:\n        count: 5\n        time_window: 60\n        rejected_code: 429\n")),(0,i.kt)("p",null,"The next step is to attach consumers to these groups:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"consumers:\n  - username: johndoe\n    group_id: 1\n    plugins:\n      key-auth:\n        key: john\n  - username: janedoe\n    group_id: 2\n    plugins:\n      key-auth:\n        key: jane\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'apikey: john' localhost:9080/get\ncurl -H 'apikey: john' localhost:9080/get\ncurl -H 'apikey: jane' localhost:9080/get\ncurl -H 'apikey: jane' localhost:9080/get\n")),(0,i.kt)("p",null,"The second request gets rate-limited."),(0,i.kt)("p",null,"We have the same results as before with two benefits. The first one is as I wrote above: when consumers move in and out, they change their permissions accordingly."),(0,i.kt)("p",null,"The second benefit is that the limit count is shared among all consumers of a group.  Indeed, when you set a limit, you don't want each consumer to be rate limited at X requests per Y second; you want the group as a whole to share the limit. In this way, if a single consumer is very active, they will naturally cap the rate of other consumers who share the same group."),(0,i.kt)("p",null,"Of course, you can set a limit on both a consumer and the group it belongs to. In this case, the lowest limit will apply first."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"consumers:\n  - username: johndoe\n    group_id: 2                        #1\n    plugins:\n      key-auth:\n        key: john\n      limit-count:\n        count: 1                       #2\n        time_window: 60\n        rejected_code: 429\n  - username: janedoe\n    group_id: 2\n    plugins:\n      key-auth:\n        key: jane\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Move ",(0,i.kt)("inlineCode",{parentName:"li"},"johndoe")," to group 2"),(0,i.kt)("li",{parentName:"ol"},"Limit him individually")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'apikey: john' localhost:9080/get\ncurl -H 'apikey: john' localhost:9080/get #1\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"johndoe")," hits the limit here, but ",(0,i.kt)("inlineCode",{parentName:"li"},"janedoe")," now only has four requests left from this minute, as the former used one request")),(0,i.kt)("h2",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,'In this post, we implement rate limiting with Apache APISIX. We set the rate limit on a route and moved it to individual consumers. Then we moved it to consumer groups, so all consumers in a group share the same "pool".'),(0,i.kt)("p",null,"The complete source code for this post can be found on ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/rate-limit-apisix"},"GitHub"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"To go further:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/terminology/consumer/"},"Consumer")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/terminology/consumer-group/"},"Consumer Group")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://nfrankel.github.io/apisix-workshop/"},"Apache APISIX Hands-on Lab"))))}m.isMDXComponent=!0}}]);