"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[51888],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},64934:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const i={title:"Integration service discovery registry"},o=void 0,s={unversionedId:"discovery",id:"discovery",isDocsHomePage:!1,title:"Integration service discovery registry",description:"When system traffic changes, the number of servers of the upstream service also increases or decreases, or the server needs to be replaced due to its hardware failure. If the gateway maintains upstream service information through configuration, the maintenance costs in the microservices architecture pattern are unpredictable. Furthermore, due to the untimely update of these information, will also bring a certain impact for the business, and the impact of human error operation can not be ignored. So it is very necessary for the gateway to automatically get the latest list of service instances through the service registry\u3002As shown in the figure below\uff1a",source:"@site/docs/apisix/discovery.md",sourceDirName:".",slug:"/discovery",permalink:"/docs/apisix/next/discovery",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/discovery.md",tags:[],version:"current",frontMatter:{title:"Integration service discovery registry"},sidebar:"docs",previous:{title:"FAQ",permalink:"/docs/apisix/next/FAQ"},next:{title:"DNS",permalink:"/docs/apisix/next/discovery/dns"}},l=[{value:"Summary",id:"summary",children:[]},{value:"How to extend the discovery client?",id:"how-to-extend-the-discovery-client",children:[{value:"Basic steps",id:"basic-steps",children:[]},{value:"the example of Eureka",id:"the-example-of-eureka",children:[]}]},{value:"Configuration for discovery client",id:"configuration-for-discovery-client",children:[{value:"Initial service discovery",id:"initial-service-discovery",children:[]},{value:"Configuration for Eureka",id:"configuration-for-eureka",children:[]}]},{value:"Upstream setting",id:"upstream-setting",children:[{value:"L7",id:"l7",children:[]},{value:"L4",id:"l4",children:[]}]},{value:"Embedded control api for debugging",id:"embedded-control-api-for-debugging",children:[]}],c={toc:l};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"When system traffic changes, the number of servers of the upstream service also increases or decreases, or the server needs to be replaced due to its hardware failure. If the gateway maintains upstream service information through configuration, the maintenance costs in the microservices architecture pattern are unpredictable. Furthermore, due to the untimely update of these information, will also bring a certain impact for the business, and the impact of human error operation can not be ignored. So it is very necessary for the gateway to automatically get the latest list of service instances through the service registry\u3002As shown in the figure below\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://raw.githubusercontent.com/apache/apisix/master/docs/assets/images/discovery.png",alt:"discovery through service registry"})),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"When the service starts, it will report some of its information, such as the service name, IP, port and other information to the registry. The services communicate with the registry using a mechanism such as a heartbeat, and if the registry and the service are unable to communicate for a long time, the instance will be cancel.When the service goes offline, the registry will delete the instance information."),(0,r.kt)("li",{parentName:"ol"},"The gateway gets service instance information from the registry in near-real time."),(0,r.kt)("li",{parentName:"ol"},"When the user requests the service through the gateway, the gateway selects one instance from the registry for proxy.")),(0,r.kt)("h2",{id:"how-to-extend-the-discovery-client"},"How to extend the discovery client?"),(0,r.kt)("h3",{id:"basic-steps"},"Basic steps"),(0,r.kt)("p",null,"It is very easy for APISIX to extend the discovery client, the basic steps are as follows"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the implementation of registry client in the 'apisix/discovery/' directory;")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Implement the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M.init_worker()")," function for initialization and the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M.nodes(service_name)")," function for obtaining the list of service instance nodes;")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If you need the discovery module to export the debugging information online, implement the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M.dump_data()")," function;")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Convert the registry data into data in APISIX;"))),(0,r.kt)("h3",{id:"the-example-of-eureka"},"the example of Eureka"),(0,r.kt)("h4",{id:"implementation-of-eureka-client"},"Implementation of Eureka client"),(0,r.kt)("p",null,"First, create a directory ",(0,r.kt)("inlineCode",{parentName:"p"},"eureka")," under ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix/discovery"),";"),(0,r.kt)("p",null,"After that, add ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/apisix/discovery/init.lua"},(0,r.kt)("inlineCode",{parentName:"a"},"init.lua"))," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix/discovery/eureka")," directory;"),(0,r.kt)("p",null,"Then implement the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M.init_worker()")," function for initialization and the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M.nodes(service_name)")," function for obtaining the list of service instance nodes in ",(0,r.kt)("inlineCode",{parentName:"p"},"init.lua"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-lua"},"local _M = {\n    version = 1.0,\n}\n\n\nfunction _M.nodes(service_name)\n    ... ...\nend\n\n\nfunction _M.init_worker()\n    ... ...\nend\n\n\nfunction _M.dump_data()\n    return {config = your_config, services = your_services, other = ... }\nend\n\n\nreturn _M\n")),(0,r.kt)("p",null,"Finally, provide the schema for YAML configuration in the ",(0,r.kt)("inlineCode",{parentName:"p"},"schema.lua")," under ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix/discovery/eureka"),"."),(0,r.kt)("h4",{id:"how-convert-eurekas-instance-data-to-apisixs-node"},"How convert Eureka's instance data to APISIX's node?"),(0,r.kt)("p",null,"Here's an example of Eureka's data\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "applications": {\n      "application": [\n          {\n              "name": "USER-SERVICE",                 # service name\n              "instance": [\n                  {\n                      "instanceId": "192.168.1.100:8761",\n                      "hostName": "192.168.1.100",\n                      "app": "USER-SERVICE",          # service name\n                      "ipAddr": "192.168.1.100",      # IP address\n                      "status": "UP",\n                      "overriddenStatus": "UNKNOWN",\n                      "port": {\n                          "$": 8761,\n                          "@enabled": "true"\n                      },\n                      "securePort": {\n                          "$": 443,\n                          "@enabled": "false"\n                      },\n                      "metadata": {\n                          "management.port": "8761",\n                          "weight": 100               # Setting by \'eureka.instance.metadata-map.weight\' of the spring boot application\n                      },\n                      "homePageUrl": "http://192.168.1.100:8761/",\n                      "statusPageUrl": "http://192.168.1.100:8761/actuator/info",\n                      "healthCheckUrl": "http://192.168.1.100:8761/actuator/health",\n                      ... ...\n                  }\n              ]\n          }\n      ]\n  }\n}\n')),(0,r.kt)("p",null,"Deal with the Eureka's instance data need the following steps :"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"select the UP instance. When the value of ",(0,r.kt)("inlineCode",{parentName:"li"},"overriddenStatus"),' is "UP" or the value of ',(0,r.kt)("inlineCode",{parentName:"li"},"overriddenStatus"),' is "UNKNOWN" and the value of ',(0,r.kt)("inlineCode",{parentName:"li"},"status"),' is "UP".'),(0,r.kt)("li",{parentName:"ol"},"Host. The ",(0,r.kt)("inlineCode",{parentName:"li"},"ipAddr")," is the IP address of instance; and must be IPv4 or IPv6."),(0,r.kt)("li",{parentName:"ol"},"Port. If the value of ",(0,r.kt)("inlineCode",{parentName:"li"},'port["@enabled"]'),' is equal to "true", using the value of ',(0,r.kt)("inlineCode",{parentName:"li"},'port["\\$"]'),", If the value of ",(0,r.kt)("inlineCode",{parentName:"li"},'securePort["@enabled"]'),' is equal to "true", using the value of ',(0,r.kt)("inlineCode",{parentName:"li"},'securePort["\\$"]'),"."),(0,r.kt)("li",{parentName:"ol"},"Weight. ",(0,r.kt)("inlineCode",{parentName:"li"},"local weight = metadata.weight or local_conf.eureka.weight or 100"))),(0,r.kt)("p",null,"The result of this example is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'[\n  {\n    "host" : "192.168.1.100",\n    "port" : 8761,\n    "weight" : 100,\n    "metadata" : {\n      "management.port": "8761"\n    }\n  }\n]\n')),(0,r.kt)("h2",{id:"configuration-for-discovery-client"},"Configuration for discovery client"),(0,r.kt)("h3",{id:"initial-service-discovery"},"Initial service discovery"),(0,r.kt)("p",null,"Add the following configuration to ",(0,r.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," to add different service discovery clients for dynamic selection during use:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"discovery:\n  eureka:\n      ...\n")),(0,r.kt)("p",null,"This name should be consistent with the file name of the implementation registry in the ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix/discovery/")," directory."),(0,r.kt)("p",null,"The supported discovery client: Eureka."),(0,r.kt)("h3",{id:"configuration-for-eureka"},"Configuration for Eureka"),(0,r.kt)("p",null,"Add following configuration in ",(0,r.kt)("inlineCode",{parentName:"p"},"conf/config.yaml")," \uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'discovery:\n  eureka:\n    host:                            # it\'s possible to define multiple eureka hosts addresses of the same eureka cluster.\n      - "http://${username}:${password}@${eureka_host1}:${eureka_port1}"\n      - "http://${username}:${password}@${eureka_host2}:${eureka_port2}"\n    prefix: "/eureka/"\n    fetch_interval: 30               # 30s\n    weight: 100                      # default weight for node\n    timeout:\n      connect: 2000                  # 2000ms\n      send: 2000                     # 2000ms\n      read: 5000                     # 5000ms\n')),(0,r.kt)("h2",{id:"upstream-setting"},"Upstream setting"),(0,r.kt)("h3",{id:"l7"},"L7"),(0,r.kt)("p",null,'Here is an example of routing a request with a URL of "/user/*" to a service which named "user-service" and use eureka discovery client in the registry :'),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9180/apisix/admin/routes/1 -H "X-API-KEY: $admin_key" -X PUT -i -d \'\n{\n    "uri": "/user/*",\n    "upstream": {\n        "service_name": "USER-SERVICE",\n        "type": "roundrobin",\n        "discovery_type": "eureka"\n    }\n}\'\n\nHTTP/1.1 201 Created\nDate: Sat, 31 Aug 2019 01:17:15 GMT\nContent-Type: text/plain\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX web server\n\n{"node":{"value":{"uri":"\\/user\\/*","upstream": {"service_name": "USER-SERVICE", "type": "roundrobin", "discovery_type": "eureka"}},"createdIndex":61925,"key":"\\/apisix\\/routes\\/1","modifiedIndex":61925}}\n')),(0,r.kt)("p",null,"Because the upstream interface URL may have conflict, usually in the gateway by prefix to distinguish:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9180/apisix/admin/routes/1 -H "X-API-KEY: $admin_key" -X PUT -i -d \'\n{\n    "uri": "/a/*",\n    "plugins": {\n        "proxy-rewrite" : {\n            "regex_uri": ["^/a/(.*)", "/${1}"]\n        }\n    },\n    "upstream": {\n        "service_name": "A-SERVICE",\n        "type": "roundrobin",\n        "discovery_type": "eureka"\n    }\n}\'\n\n$ curl http://127.0.0.1:9180/apisix/admin/routes/2 -H "X-API-KEY: $admin_key" -X PUT -i -d \'\n{\n    "uri": "/b/*",\n    "plugins": {\n        "proxy-rewrite" : {\n            "regex_uri": ["^/b/(.*)", "/${1}"]\n        }\n    },\n    "upstream": {\n        "service_name": "B-SERVICE",\n        "type": "roundrobin",\n        "discovery_type": "eureka"\n    }\n}\'\n')),(0,r.kt)("p",null,"Suppose both A-SERVICE and B-SERVICE provide a ",(0,r.kt)("inlineCode",{parentName:"p"},"/test")," API. The above configuration allows access to A-SERVICE's ",(0,r.kt)("inlineCode",{parentName:"p"},"/test")," API through ",(0,r.kt)("inlineCode",{parentName:"p"},"/a/test")," and B-SERVICE's ",(0,r.kt)("inlineCode",{parentName:"p"},"/test")," API through ",(0,r.kt)("inlineCode",{parentName:"p"},"/b/test"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Notice"),"\uff1aWhen configuring ",(0,r.kt)("inlineCode",{parentName:"p"},"upstream.service_name"),",  ",(0,r.kt)("inlineCode",{parentName:"p"},"upstream.nodes")," will no longer take effect, but will be replaced by 'nodes' obtained from the registry."),(0,r.kt)("h3",{id:"l4"},"L4"),(0,r.kt)("p",null,"Eureka service discovery also supports use in L4, the configuration method is similar to L7."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9180/apisix/admin/stream_routes/1 -H "X-API-KEY: $admin_key" -X PUT -i -d \'\n{\n    "remote_addr": "127.0.0.1",\n    "upstream": {\n        "scheme": "tcp",\n        "discovery_type": "eureka",\n        "service_name": "APISIX-EUREKA",\n        "type": "roundrobin"\n    }\n}\'\nHTTP/1.1 200 OK\nDate: Fri, 30 Dec 2022 03:52:19 GMT\nContent-Type: application/json\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/3.0.0\nAccess-Control-Allow-Origin: *\nAccess-Control-Allow-Credentials: true\nAccess-Control-Expose-Headers: *\nAccess-Control-Max-Age: 3600\nX-API-VERSION: v3\n\n{"key":"\\/apisix\\/stream_routes\\/1","value":{"remote_addr":"127.0.0.1","upstream":{"hash_on":"vars","type":"roundrobin","discovery_type":"eureka","scheme":"tcp","pass_host":"pass","service_name":"APISIX-EUREKA"},"id":"1","create_time":1672106762,"update_time":1672372339}}\n')),(0,r.kt)("h2",{id:"embedded-control-api-for-debugging"},"Embedded control api for debugging"),(0,r.kt)("p",null,"Sometimes we need the discovery client to export online data snapshot in memory when running for debugging, and if you implement the ",(0,r.kt)("inlineCode",{parentName:"p"},"_M. dump_data()")," function:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-lua"},"function _M.dump_data()\n    return {config = local_conf.discovery.eureka, services = applications}\nend\n")),(0,r.kt)("p",null,"Then you can call its control api as below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"GET /v1/discovery/{discovery_type}/dump\n")),(0,r.kt)("p",null,"eg:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl http://127.0.0.1:9090/v1/discovery/eureka/dump\n")))}p.isMDXComponent=!0}}]);