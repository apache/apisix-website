"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[45927],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(27378);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=o,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||r;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4484:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(25773),o=(n(27378),n(35318));const r={title:"Backend-for-Frontend: the demo",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["API gateway","Apache APISIX","System architecture","Mciroservices"],description:"The Backend-For-Frontend pattern describes how to return different data for each client in a microservices architecture. This article goes through the code required to implement the different possible implementations.",tags:["Ecosystem"],image:"https://static.apiseven.com/2022/11/03/63634494405e7.png"},i=void 0,l={permalink:"/blog/2022/08/17/backend-for-frontend-demo",source:"@site/blog/2022/08/17/backend-for-frontend-demo.md",title:"Backend-for-Frontend: the demo",description:"The Backend-For-Frontend pattern describes how to return different data for each client in a microservices architecture. This article goes through the code required to implement the different possible implementations.",date:"2022-08-17T00:00:00.000Z",formattedDate:"August 17, 2022",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:7.86,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Fault Injection Testing with API Gateway",permalink:"/blog/2022/08/28/fault-injection-testing-with-api-gateway"},nextItem:{title:"GCP, AWS, Azure, and OCI ARM-Based Server Performance Comparison",permalink:"/blog/2022/08/12/arm-performance-google-aws-azure-with-apisix"}},s={authorsImageUrls:[void 0]},p=[{value:"The use-case",id:"the-use-case",children:[],level:2},{value:"Setting up the demo",id:"setting-up-the-demo",children:[],level:2},{value:"Migrating to microservices",id:"migrating-to-microservices",children:[],level:2},{value:"Dedicated backend-for-frontend",id:"dedicated-backend-for-frontend",children:[],level:2},{value:"Backend-for-frontend at the API Gateway level",id:"backend-for-frontend-at-the-api-gateway-level",children:[],level:2},{value:"Bonus: a poor man&#39;s BFF",id:"bonus-a-poor-mans-bff",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],c={toc:p};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"This article describes a demo code to implement the Backend-For-Frontend pattern.")),(0,o.kt)("head",null,(0,o.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/backend-for-frontend-demo/"})),(0,o.kt)("p",null,"In ",(0,o.kt)("a",{parentName:"p",href:"https://blog.frankel.ch/backend-for-frontend/"},"one of my earlier posts"),", I described the Backend-for-Frontend pattern. In short, it offers a single facade over multiple backend parts. Moreover, it provides each client type, ",(0,o.kt)("em",{parentName:"p"},"e.g.")," desktop, mobile, exactly the data that it needs and not more in the format required by this client type."),(0,o.kt)("h2",{id:"the-use-case"},"The use-case"),(0,o.kt)("p",null,"Imagine the following use-case. In a e-commerce shop, the home page should display multiple ",(0,o.kt)("em",{parentName:"p"},"unrelated")," data at once."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},'Products: The business could configure which items are shown on the home page. They could be generic, "hero" products, or personalized, products that the customer ordered previously.'),(0,o.kt)("li",{parentName:"ul"},"News: Again, the newsfeed could be generic or personalized."),(0,o.kt)("li",{parentName:"ul"},"Profile-related information"),(0,o.kt)("li",{parentName:"ul"},"Cart content"),(0,o.kt)("li",{parentName:"ul"},"Non-business related information, such as build number, build timestamp, version, etc.")),(0,o.kt)("p",null,"Depending on the client, we want more or less data. For example, on a client with limited display size, we probably want to limit a product to its name and its image. On the other hand, on desktop, we are happy to display both the above, plus a catch phrase (or a more catchy - and longer - name) and the full description."),(0,o.kt)("p",null,"Every client requires its specific data and for performance reasons, we want to fetch them in a single call. It sounds like a use-case for ",(0,o.kt)("abbr",{title:"Backend-for-Frontend"},"BFF"),"."),(0,o.kt)("h2",{id:"setting-up-the-demo"},"Setting up the demo"),(0,o.kt)("p",null,"In order to simplify things, I'll keep only three sources of data: products, news and technical data. Three unrelated data sources are enough to highlight the issue."),(0,o.kt)("p",null,"In the demo, I'm using Python and Flask, but the underlying technology is irrelevant, since BFF is an architectural pattern."),(0,o.kt)("p",null,"The initial situation is a monolith. The monolith offers an endpoint for each data source, and a single aggregating endpoint for all of them:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"@app.route(\"/\")\ndef home():\n    return {\n      'products': products,       #1\n      'news': news,               #1\n      'info': debug               #1\n  }\n")),(0,o.kt)("p",null,"Somehow get the data internally, ",(0,o.kt)("em",{parentName:"p"},"e.g."),", from the database."),(0,o.kt)("p",null,"At this point, everything is fine. We can provide different data depending on the client:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"If we want to put the responsibility on the client, we provide a dedicated endpoint"),(0,o.kt)("li",{parentName:"ul"},"If we want it server-side, we can read the ",(0,o.kt)("inlineCode",{parentName:"li"},"User-Agent")," from the request (or agree on a specific ",(0,o.kt)("inlineCode",{parentName:"li"},"X-")," HTTP header)")),(0,o.kt)("p",null,"As it doesn't add anything to the demo, I won't provide different data depending on the client in the following."),(0,o.kt)("h2",{id:"migrating-to-microservices"},"Migrating to microservices"),(0,o.kt)("p",null,"At one point, the organization decides to migrate to a microservices architecture. The reason might be because the CTO read about microservices in a blog post, because the team lead wants to add microservices on its resume, or even because the development grew too big and the organization do need to evolve. In any case, the monolith has to be split in ",(0,o.kt)("em",{parentName:"p"},"two")," microservices: a catalog providing products and a newsfeed providing... news."),(0,o.kt)("p",null,"Here's the code for each microservice:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'@app.route("/info")\ndef info():\n    return debug                 #1\n\n\n@app.route("/products")\ndef get_products():\n    return jsonify(products)     #2\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Each microservice has its own ",(0,o.kt)("inlineCode",{parentName:"li"},"debug")," endpoint"),(0,o.kt)("li",{parentName:"ol"},"The payload is not an object anymore but an array")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'@app.route("/info")\ndef info():\n    return debug                 #1\n\n\n@app.route("/news")\ndef get_news():\n    return jsonify(news)         #1\n')),(0,o.kt)("p",null,"As shown above, now each client needs two calls, and filter out data that are not relevant."),(0,o.kt)("h2",{id:"dedicated-backend-for-frontend"},"Dedicated backend-for-frontend"),(0,o.kt)("p",null,"Because of the issues highlighted above, a solution is to develop one application that does the aggregation and filtering. There should be one for each client type, and it should be cared for by the same team as the client. Again, for this demo, it's enough to have a single one that only does aggregation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"@app.route(\"/\")\ndef home():\n    products = requests.get(products_uri).json()            #1\n    catalog_info = requests.get(catalog_info_uri).json()    #2\n    news = requests.get(news_uri).json()                    #1\n    news_info = requests.get(news_info_uri).json()          #2\n    return {\n      'products': products,\n      'news': news,\n      'info': {                                             #3\n          'catalog': catalog_info,\n          'news': news_info\n      }\n    }\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Get data"),(0,o.kt)("li",{parentName:"ol"},"Get debug info"),(0,o.kt)("li",{parentName:"ol"},"The returned JSON should be designed for easy consumption on the client side. To illustrate it, I chose for the debug data to be nested instead of top-level.")),(0,o.kt)("h2",{id:"backend-for-frontend-at-the-api-gateway-level"},"Backend-for-frontend at the API Gateway level"),(0,o.kt)("p",null,"If you're offering APIs, whether internally or to the outside world, chances are high that you're already using an API Gateway. If not, you should probably ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/terminology/api-gateway/"},"deeply consider")," starting to. In the following, I assume that you do use one."),(0,o.kt)("p",null,"In the previous section, we developed a dedicated backend-for-frontend application. However, requests already go through the gateway. In this case, the gateway can be seen as a container where to deploy BFF plugins. I'll be using ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX")," to demo how to do it, but the idea can be replicated on other gateways as well."),(0,o.kt)("p",null,"First things first, there's no generic way to achieve the result we want. For this reason, we cannot rely on an existing plugin, but we have to design our own. APISIX documents ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugin-develop/"},"how to do so"),". Our goal is to fetch data from all endpoints as above, but via the plugin."),(0,o.kt)("p",null,"First, we need to expose a dedicated endpoint, ",(0,o.kt)("em",{parentName:"p"},"e.g."),", ",(0,o.kt)("inlineCode",{parentName:"p"},"/bff/desktop")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"/bff/phone"),". APISIX allows such ",(0,o.kt)("em",{parentName:"p"},"virtual")," endpoints via the ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/public-api/"},"public-api")," plugin. Next, we need to develop our plugin, ",(0,o.kt)("inlineCode",{parentName:"p"},"bff"),". Here's the configuration snippet:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"routes:\n  - uri: /                     #1\n    plugins:\n      bff: ~                   #2\n      public-api: ~            #2\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"For demo purposes, I preferred to set it at the root instead of ",(0,o.kt)("inlineCode",{parentName:"li"},"/bff/*")),(0,o.kt)("li",{parentName:"ol"},"Declare the two plugins. Note that I'm using the ",(0,o.kt)("a",{parentName:"li",href:"https://apisix.apache.org/docs/apisix/deployment-modes/#standalone"},"stand-alone mode"),".")),(0,o.kt)("p",null,"First, we need to describe the plugin and not forget to return it at the end of the file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua"},"local plugin_name = 'bff-plugin'\n\nlocal _M = {                           --1\n    version = 1.0,\n    priority = 100,                    --2\n    name = plugin_name,\n    schema = {},                       --3\n}\n\nreturn _M                              --4\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The table needs to be named ",(0,o.kt)("inlineCode",{parentName:"li"},"_M")),(0,o.kt)("li",{parentName:"ol"},"In this scenario, ",(0,o.kt)("inlineCode",{parentName:"li"},"priority")," is irrelevant as no other plugins are involved (but ",(0,o.kt)("inlineCode",{parentName:"li"},"public_api"),")"),(0,o.kt)("li",{parentName:"ol"},"No schema is necessary as there's no configuration"),(0,o.kt)("li",{parentName:"ol"},"Don't forget to return it!")),(0,o.kt)("p",null,"A plugin that has a public API needs to define an ",(0,o.kt)("inlineCode",{parentName:"p"},"api()")," function returning an object describing matching HTTP methods, the matching URI, and the handler function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-lua"},"function _M.api()\n    return {\n        {\n            methods = { 'GET' },\n            uri = \"/\",\n            handler = fetch_all_data,\n        }\n    }\nend\n")),(0,o.kt)("p",null,"Now, we have to define the ",(0,o.kt)("inlineCode",{parentName:"p"},"fetch_all_data")," function. It's only a matter of making HTTP calls to the catalog and newsfeed microservices. Have a look at ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/backend-for-frontend/blob/master/bff_plugin/init.lua#L24-L52"},"the code")," if you're interested in the exact details."),(0,o.kt)("p",null,"At this point, the (single) client can query ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:9080/")," and get the complete payload."),(0,o.kt)("p",null,'In a "real life" microservices-based organization, every team should be independent of each other. With this approach, each can develop its own BFF as a plugin and deploy it independently in the gateway.'),(0,o.kt)("h2",{id:"bonus-a-poor-mans-bff"},"Bonus: a poor man's BFF"),(0,o.kt)("p",null,"The microservices architecture creates two problems for clients:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The need to fetch all data and filter out the unnecessary ones"),(0,o.kt)("li",{parentName:"ol"},"Multiple calls to each service")),(0,o.kt)("p",null,"The BFF pattern allows to fix both of them, at the cost of custom development, regardless whether it's for a dedicated app or a gateway plugin. If you're not willing to spend time in custom development, you can still avoid #2 by using a nifty plugin of Apache APISIX, ",(0,o.kt)("inlineCode",{parentName:"p"},"batch-requests"),":"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"batch-requests")," plugin accepts multiple requests, sends them from APISIX via HTTP pipelining, and returns an aggregated response to the client."),(0,o.kt)("p",{parentName:"blockquote"},"This improves the performance significantly in cases where the client needs to access multiple APIs."),(0,o.kt)("p",{parentName:"blockquote"},"-- ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/batch-requests/"},"batch-requests"))),(0,o.kt)("p",null,"In essence, the client would need to send the following payload to a previously configured endpoint:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "timeout": 502,\n    "pipeline": [\n        {\n            "method": "GET",\n            "path": "/products"\n        },\n        {\n            "method": "GET",\n            "path": "/news"\n        },\n        {\n            "method": "GET",\n            "path": "/catalog/info"\n        },\n        {\n            "method": "GET",\n            "path": "/news/info"\n        }\n    ]\n}\n')),(0,o.kt)("p",null,"The response will in turn look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'[\n  {\n    "status": 200,\n    "reason": "OK",\n    "body": "{\\"ret\\":200,\\"products\\":\\"[ ... ]\\"}",\n    "headers": {\n      "Connection": "keep-alive",\n      "Date": "Sat, 11 Apr 2020 17:53:20 GMT",\n      "Content-Type": "application/json",\n      "Content-Length": "123",\n      "Server": "APISIX web server"\n    }\n  },\n  {\n    "status": 200,\n    "reason": "OK",\n    "body": "{\\"ret\\":200,\\"news\\":\\"[ ... ]\\"}",\n    "headers": {\n      "Connection": "keep-alive",\n      "Date": "Sat, 11 Apr 2020 17:53:20 GMT",\n      "Content-Type": "application/json",\n      "Content-Length": "456",\n      "Server": "APISIX web server"\n    }\n  },\n  {\n    "status": 200,\n    "reason": "OK",\n    "body": "{\\"ret\\":200,\\"version\\":\\"...\\"}",\n    "headers": {\n      "Connection": "keep-alive",\n      "Date": "Sat, 11 Apr 2020 17:53:20 GMT",\n      "Content-Type": "application/json",\n      "Content-Length": "78",\n      "Server": "APISIX web server"\n    }\n  },\n  {\n    "status": 200,\n    "reason": "OK",\n    "body": "{\\"ret\\":200,\\"version\\":\\"...\\"}",\n    "headers": {\n      "Connection": "keep-alive",\n      "Date": "Sat, 11 Apr 2020 17:53:20 GMT",\n      "Content-Type": "application/json",\n      "Content-Length": "90",\n      "Server": "APISIX web server"\n    }\n  }\n]\n')),(0,o.kt)("p",null,"It's up to the client to filter out unnecessary data. It's not as good as true BFF, but we still managed to make a single call out of 4."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"A microservices architecture brings a ton of technical issues to cope with. Among them is the need to dispatch only the required data to each kind of client. The BFF pattern aims to cope with this issue."),(0,o.kt)("p",null,"In the previous ",(0,o.kt)("a",{parentName:"p",href:"https://blog.frankel.ch/backend-for-frontend/"},"post"),", I described the pattern from a theoretical point of view. In this post, I used a very simple ecommerce use-case to demo how to implement BFF with and without the help of Apache APISIX."),(0,o.kt)("p",null,"The complete source code for this post can be found on ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/backend-for-frontend"},"GitHub"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To go further:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://samnewman.io/patterns/architectural/bff/"},"Pattern: Backends For Frontends")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/dotnet/architecture/microservices/architect-microservice-container-applications/direct-client-to-microservice-communication-versus-the-api-gateway-pattern"},"The API gateway pattern versus the Direct client-to-microservice communication")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.manuelkruisz.com/blog/posts/api-gateway-vs-bff"},"API Gateway vs Backend For Frontend"))))}d.isMDXComponent=!0}}]);