"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[61569],{35318:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(27378);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=a.createContext({}),l=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=l(e.components);return a.createElement(c.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=l(t),h=r,m=d["".concat(c,".").concat(h)]||d[h]||u[h]||i;return t?a.createElement(m,s(s({ref:n},p),{},{components:t})):a.createElement(m,s({ref:n},p))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,s=new Array(i);s[0]=d;var o={};for(var c in n)hasOwnProperty.call(n,c)&&(o[c]=n[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var l=2;l<i;l++)s[l]=t[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},48799:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var a=t(25773),r=(t(27378),t(35318));const i={title:"How to Integrate API Gateway and Consul? Not Consul K/V",authors:[{name:"Yihao LI",title:"Author",url:"https://github.com/Fabriceli",image_url:"https://github.com/Fabriceli.png"}],keywords:["API Gateway","Consul","Service Discovery","Service Register"],description:"Apache APISIX supports the Consul service discovery registry. This article will walk you through the process of implementing service discovery and service registry in APISIX.",tags:["Ecosystem"],image:"https://static.apiseven.com/2022/blog/0818/ecosystem/HashiCorp%20Consul.png"},s=void 0,o={permalink:"/blog/2023/01/18/consul-with-apisix",source:"@site/blog/2023/01/18/consul-with-apisix.md",title:"How to Integrate API Gateway and Consul? Not Consul K/V",description:"Apache APISIX supports the Consul service discovery registry. This article will walk you through the process of implementing service discovery and service registry in APISIX.",date:"2023-01-18T00:00:00.000Z",formattedDate:"January 18, 2023",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:4.455,truncated:!0,authors:[{name:"Yihao LI",title:"Author",url:"https://github.com/Fabriceli",image_url:"https://github.com/Fabriceli.png",imageURL:"https://github.com/Fabriceli.png"}],prevItem:{title:"Securing Admin Access to Apache APISIX",permalink:"/blog/2023/02/09/secure-apisix-admin"},nextItem:{title:"Accessing APISIX-Dashboard from Everywhere with Keycloak Authentication",permalink:"/blog/2023/01/02/accessing_apisix-dashboard_from_everywhere_with_keycloak_authentication"}},c={authorsImageUrls:[void 0]},l=[{value:"Background",id:"background",children:[{value:"About Apache APISIX",id:"about-apache-apisix",children:[],level:3},{value:"About Consul",id:"about-consul",children:[],level:3}],level:2},{value:"Preparation Phase",id:"preparation-phase",children:[],level:2},{value:"Add a Route",id:"add-a-route",children:[],level:2},{value:"Test and Verify the Result",id:"test-and-verify-the-result",children:[],level:2},{value:"Summary",id:"summary",children:[],level:2}],p={toc:l};function u(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Apache APISIX supports the Consul service discovery registry. This article will walk you through the process of implementing service discovery and service registry in Apache APISIX.")),(0,r.kt)("h2",{id:"background"},"Background"),(0,r.kt)("h3",{id:"about-apache-apisix"},"About Apache APISIX"),(0,r.kt)("p",null,"Apache APISIX is an open source, dynamic, scalable, and high-performance cloud native API gateway for all your APIs and microservices."),(0,r.kt)("p",null,"APISIX facilitates interface traffic handling for websites, mobile and IoT applications by providing services such as load balancing, dynamic upstream, canary release, fine-grained routing, rate limiting, and many more."),(0,r.kt)("h3",{id:"about-consul"},"About Consul"),(0,r.kt)("p",null,"Consul is a distributed, highly available, and data center aware solution to connect and configure applications across dynamic, distributed infrastructure. Consul provides several key features: Multi-Datacenter, Service Mesh, Service Discovery, Health Checking, Key/Value Storage"),(0,r.kt)("h2",{id:"preparation-phase"},"Preparation Phase"),(0,r.kt)("p",null,"The test environments in this article are built in Docker using docker-compose."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download Apache APISIX"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"git clone https://github.com/apache/apisix-docker.git\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create and run Consul"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"docker run --rm --name consul_1 -d -p 8500:8500 consul:1.8 consul agent -server -bootstrap-expect=1 -node=agent-one -client 0.0.0.0 -log-level info -data-dir=/consul/data -enable-script-checks\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Update Apache APISIX config file ",(0,r.kt)("inlineCode",{parentName:"p"},"apisix_conf/config.yaml")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'# config.yml\n# ... other config\ndiscovery:\n  consul:\n    servers:\n      - "http://127.0.0.1:8500"\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Start Apache APISIX"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"# cd example folder\uff0cand start APISIX\ndocker-compose -f docker-compose.yml -p apisix-docker  up -d\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Example contains two web services that you can use directly to test."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"sudo docker inspect -f='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(sudo docker ps -aq) | grep web\n# Outputs\n/apisix-docker-web1-1 - 172.21.0.5\n/apisix-docker-web2-1 - 172.21.0.6\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Register the test service to Consul via Consul HTTP API."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'# Register with the corresponding IP and port\ncurl --location --request PUT \'http://127.0.0.1:8500/v1/agent/service/register\' \\\n  --header \'Content-Type: application/json\' \\\n  --data \'{\n      "ID": "service_a1",\n      "Name": "service_a",\n     "Tags": ["primary", "v1"],\n     "Address": "172.21.0.5",\n     "Port": 9081,\n     "Weights": {\n         "Passing": 10,\n         "Warning": 1\n     }\n  }\'\n\ncurl --location --request PUT \'http://127.0.0.1:8500/v1/agent/service/register\' \\\n  --header \'Content-Type: application/json\' \\\n  --data \'{\n    "ID": "service_a2",\n    "Name": "service_a",\n    "Tags": ["primary", "v1"],\n    "Address": "172.21.0.6",\n    "Port": 9082,\n    "Weights": {\n      "Passing": 10,\n      "Warning": 1\n    }\n }\'\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Check whether the test service is registered successfully."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl --location --request GET 'http://127.0.0.1:8500/v1/catalog/service/service_a'\n")),(0,r.kt)("p",{parentName:"li"}," The URL ",(0,r.kt)("inlineCode",{parentName:"p"},"/v1/catalog/service/:service_name")," end with the path parameters which specifies the name of the service.\nThe following return message indicates successful registration."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},' [{\n   "ID": "7a36c6f1-f701-9c67-8db8-7b8551d36b4a",\n   "Node": "agent-one",\n   "Address": "172.23.0.2",\n   "Datacenter": "dc1",\n   "TaggedAddresses": {\n     "lan": "172.23.0.2",\n     "lan_ipv4": "172.23.0.2",\n     "wan": "172.23.0.2",\n     "wan_ipv4": "172.23.0.2"\n   },\n   "NodeMeta": {\n     "consul-network-segment": ""\n   },\n   "ServiceKind": "",\n   "ServiceID": "service_a1",\n   "ServiceName": "service_a",\n   "ServiceTags": ["primary", "v1"],\n   "ServiceAddress": "172.20.10.2",\n   "ServiceTaggedAddresses": {\n     "lan_ipv4": {\n       "Address": "172.20.10.2",\n       "Port": 9082\n     },\n     "wan_ipv4": {\n       "Address": "172.20.10.2",\n       "Port": 9082\n     }\n   },\n   "ServiceWeights": {\n     "Passing": 10,\n     "Warning": 1\n   },\n   "ServiceMeta": {},\n   "ServicePort": 9082,\n   "ServiceEnableTagOverride": false,\n   "ServiceProxy": {\n     "MeshGateway": {},\n     "Expose": {}\n   },\n   "ServiceConnect": {},\n   "CreateIndex": 46,\n   "ModifyIndex": 124\n }, {\n   "ID": "7a36c6f1-f701-9c67-8db8-7b8551d36b4a",\n   "Node": "agent-one",\n   "Address": "172.23.0.2",\n   "Datacenter": "dc1",\n   "TaggedAddresses": {\n     "lan": "172.23.0.2",\n     "lan_ipv4": "172.23.0.2",\n     "wan": "172.23.0.2",\n     "wan_ipv4": "172.23.0.2"\n   },\n   "NodeMeta": {\n     "consul-network-segment": ""\n   },\n   "ServiceKind": "",\n   "ServiceID": "service_a2",\n   "ServiceName": "service_a",\n   "ServiceTags": ["primary", "v1"],\n   "ServiceAddress": "172.20.10.2",\n   "ServiceTaggedAddresses": {\n     "lan_ipv4": {\n       "Address": "172.20.10.2",\n       "Port": 9081\n     },\n     "wan_ipv4": {\n       "Address": "172.20.10.2",\n       "Port": 9081\n     }\n   },\n   "ServiceWeights": {\n     "Passing": 10,\n     "Warning": 1\n   },\n   "ServiceMeta": {},\n   "ServicePort": 9081,\n   "ServiceEnableTagOverride": false,\n   "ServiceProxy": {\n     "MeshGateway": {},\n     "Expose": {}\n   },\n   "ServiceConnect": {},\n   "CreateIndex": 47,\n   "ModifyIndex": 125\n }]\n')))),(0,r.kt)("h2",{id:"add-a-route"},"Add a Route"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"X-API-KEY")," need to be determined before adding them. ",(0,r.kt)("inlineCode",{parentName:"p"},"X-API-KEY"),": For the Admin API access token, in this example, we use the default ",(0,r.kt)("inlineCode",{parentName:"p"},"edd1c9f034335f136f87ad84b625c8f1"),".\nHere the request with URL ",(0,r.kt)("inlineCode",{parentName:"p"},"/consul/web/*")," is routed to Consul service ",(0,r.kt)("inlineCode",{parentName:"p"},"service_a"),". Also, the ",(0,r.kt)("inlineCode",{parentName:"p"},"discovery_type")," must be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"consul")," to start the corresponding module.\nAdd Consul to the route using the Admin API provided by Apache APISIX."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'curl http://127.0.0.1:9180/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -i -d \'\n{\n    "uri": "/consul/web/*",\n    "upstream": {\n        "service_name": "service_a",\n        "type": "roundrobin",\n        "discovery_type": "consul"\n    }\n}\'\n')),(0,r.kt)("p",null,"The following return message indicates successful addition."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "value": {\n    "status": 1,\n    "uri": "\\/*",\n    "update_time": 1674029322,\n    "id": "1",\n    "upstream": {\n      "hash_on": "vars",\n      "discovery_type": "consul",\n      "pass_host": "pass",\n      "scheme": "http",\n      "service_name": "service_a",\n      "type": "roundrobin"\n    },\n    "create_time": 1674029322,\n    "priority": 0\n  },\n  "key": "\\/apisix\\/routes\\/1"\n}\n')),(0,r.kt)("h2",{id:"test-and-verify-the-result"},"Test and Verify the Result"),(0,r.kt)("p",null,"The request results show that the new route in Apache APISIX has been able to find the correct service address through Consul and request it to both nodes based on the load balancing policy."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"# the first request\ncurl -s http://127.0.0.1:9080/consul/web/\n# Output\nhello web2%\n\n# the second request\ncurl -s http://127.0.0.1:9080/consul/web/\n# Output\nhello web1%\n\n# Note: It is also possible that both requests will return\n#       the same result as web1 or web2.\n#       This is caused by the nature of load balancing and\n#       you can try to make more requests.\n")),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"The first half of this article describes how Apache APISIX works with Consul to implement the Consul service discovery registry to solve the problem of service information management and maintenance. The second half of this article focuses on how to use Apache APISIX in Docker with Consul. Of course, the application in the actual scenario needs to be analyzed according to the business scenario and the existing system architecture."),(0,r.kt)("p",null,"More instructions on using the Consul registry in Apache APISIX can be found in the ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/discovery/consul_kv/"},"official documentation"),"."),(0,r.kt)("p",null,"Apache APISIX is also currently working on additional plugins to support the integration of additional services, so if you are interested, feel free to start a discussion in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/discussions"},"GitHub Discussion"),", or via the ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/general/join"},"mailing list")," to communicate."))}u.isMDXComponent=!0}}]);