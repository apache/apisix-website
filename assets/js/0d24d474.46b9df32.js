"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[46562],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),p=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,h=u["".concat(i,".").concat(c)]||u[c]||m[c]||o;return n?a.createElement(h,l(l({ref:t},d),{},{components:n})):a.createElement(h,l({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=u;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},32566:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>i});var a=n(87462),r=(n(67294),n(3905));const o={title:"body-transformer",keywords:["Apache APISIX","API Gateway","Plugin","BODY TRANSFORMER","body-transformer"],description:"The body-transformer Plugin performs template-based transformations to transform the request and/or response bodies from one format to another, for example, from JSON to JSON, JSON to HTML, or XML to YAML."},l=void 0,s={unversionedId:"plugins/body-transformer",id:"plugins/body-transformer",isDocsHomePage:!1,title:"body-transformer",description:"The body-transformer Plugin performs template-based transformations to transform the request and/or response bodies from one format to another, for example, from JSON to JSON, JSON to HTML, or XML to YAML.",source:"@site/docs/apisix/plugins/body-transformer.md",sourceDirName:"plugins",slug:"/plugins/body-transformer",permalink:"/docs/apisix/next/plugins/body-transformer",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/body-transformer.md",tags:[],version:"current",frontMatter:{title:"body-transformer",keywords:["Apache APISIX","API Gateway","Plugin","BODY TRANSFORMER","body-transformer"],description:"The body-transformer Plugin performs template-based transformations to transform the request and/or response bodies from one format to another, for example, from JSON to JSON, JSON to HTML, or XML to YAML."},sidebar:"docs",previous:{title:"degraphql",permalink:"/docs/apisix/next/plugins/degraphql"},next:{title:"attach-consumer-label",permalink:"/docs/apisix/next/plugins/attach-consumer-label"}},i=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Transform between JSON and XML SOAP",id:"transform-between-json-and-xml-soap",children:[]},{value:"Modify Request Body",id:"modify-request-body",children:[]},{value:"Generate Request Body Using Variables",id:"generate-request-body-using-variables",children:[]},{value:"Transform Body from YAML to JSON",id:"transform-body-from-yaml-to-json",children:[]},{value:"Transform Form URL Encoded Body to JSON",id:"transform-form-url-encoded-body-to-json",children:[]},{value:"Transform GET Request Query Parameter to Body",id:"transform-get-request-query-parameter-to-body",children:[]},{value:"Transform Plain Media Type",id:"transform-plain-media-type",children:[]},{value:"Transform Multipart Media Type",id:"transform-multipart-media-type",children:[]}]}],p={toc:i};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/body-transformer"})),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer")," Plugin performs template-based transformations to transform the request and/or response bodies from one format to another, for example, from JSON to JSON, JSON to HTML, or XML to YAML."),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"request")),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Request body transformation configuration.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"request.input_format")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"[",(0,r.kt)("inlineCode",{parentName:"td"},"xml"),",",(0,r.kt)("inlineCode",{parentName:"td"},"json"),",",(0,r.kt)("inlineCode",{parentName:"td"},"encoded"),",",(0,r.kt)("inlineCode",{parentName:"td"},"args"),",",(0,r.kt)("inlineCode",{parentName:"td"},"plain"),",",(0,r.kt)("inlineCode",{parentName:"td"},"multipart"),"]"),(0,r.kt)("td",{parentName:"tr",align:null},"Request body original media type. If unspecified, the value would be determined by the ",(0,r.kt)("inlineCode",{parentName:"td"},"Content-Type")," header to apply the corresponding decoder. The ",(0,r.kt)("inlineCode",{parentName:"td"},"xml")," option corresponds to ",(0,r.kt)("inlineCode",{parentName:"td"},"text/xml")," media type. The ",(0,r.kt)("inlineCode",{parentName:"td"},"json")," option corresponds to ",(0,r.kt)("inlineCode",{parentName:"td"},"application/json")," media type. The ",(0,r.kt)("inlineCode",{parentName:"td"},"encoded")," option corresponds to ",(0,r.kt)("inlineCode",{parentName:"td"},"application/x-www-form-urlencoded")," media type. The ",(0,r.kt)("inlineCode",{parentName:"td"},"args")," option corresponds to GET requests. The ",(0,r.kt)("inlineCode",{parentName:"td"},"plain")," option corresponds to ",(0,r.kt)("inlineCode",{parentName:"td"},"text/plain")," media type. The ",(0,r.kt)("inlineCode",{parentName:"td"},"multipart")," option corresponds to ",(0,r.kt)("inlineCode",{parentName:"td"},"multipart/related")," media type. If the media type is neither type, the value would be left unset and the transformation template will be directly applied.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"request.template")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Request body transformation template. The template uses ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/bungle/lua-resty-template"},"lua-resty-template")," syntax. See the ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/bungle/lua-resty-template#template-syntax"},"template syntax")," for more details. You can also use auxiliary functions ",(0,r.kt)("inlineCode",{parentName:"td"},"_escape_json()")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"_escape_xml()")," to escape special characters such as double quotes, ",(0,r.kt)("inlineCode",{parentName:"td"},"_body")," to access request body, and ",(0,r.kt)("inlineCode",{parentName:"td"},"_ctx")," to access context variables.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"request.template_is_base64")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Set to true if the template is base64 encoded.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"response")),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Response body transformation configuration.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"response.input_format")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"[",(0,r.kt)("inlineCode",{parentName:"td"},"xml"),",",(0,r.kt)("inlineCode",{parentName:"td"},"json"),"]"),(0,r.kt)("td",{parentName:"tr",align:null},"Response body original media type. If unspecified, the value would be determined by the ",(0,r.kt)("inlineCode",{parentName:"td"},"Content-Type")," header to apply the corresponding decoder. If the media type is neither ",(0,r.kt)("inlineCode",{parentName:"td"},"xml")," nor ",(0,r.kt)("inlineCode",{parentName:"td"},"json"),", the value would be left unset and the transformation template will be directly applied.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"response.template")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Response body transformation template.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"response.template_is_base64")),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Set to true if the template is base64 encoded.")))),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below demonstrate how you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer")," for different scenarios."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("p",null,"The transformation template uses ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bungle/lua-resty-template"},"lua-resty-template")," syntax. See the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/bungle/lua-resty-template#template-syntax"},"template syntax")," to learn more."),(0,r.kt)("p",null,"You can also use auxiliary functions ",(0,r.kt)("inlineCode",{parentName:"p"},"_escape_json()")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"_escape_xml()")," to escape special characters such as double quotes, ",(0,r.kt)("inlineCode",{parentName:"p"},"_body")," to access request body, and ",(0,r.kt)("inlineCode",{parentName:"p"},"_ctx")," to access context variables."),(0,r.kt)("p",null,"In all cases, you should ensure that the transformation template is a valid JSON string."),(0,r.kt)("h3",{id:"transform-between-json-and-xml-soap"},"Transform between JSON and XML SOAP"),(0,r.kt)("p",null,"The following example demonstrates how to transform the request body from JSON to XML and the response body from XML to JSON when working with a SOAP Upstream service."),(0,r.kt)("p",null,"Start the sample SOAP service:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /tmp\ngit clone https://github.com/spring-guides/gs-soap-service.git\ncd gs-soap-service/complete\n./mvnw spring-boot:run\n")),(0,r.kt)("p",null,"Create the request and response transformation templates:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'req_template=$(cat <<EOF | awk \'{gsub(/"/,"\\\\\\"");};1\' | awk \'{$1=$1};1\' | tr -d \'\\r\\n\'\n<?xml version="1.0"?>\n<soap-env:Envelope xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/">\n <soap-env:Body>\n  <ns0:getCountryRequest xmlns:ns0="http://spring.io/guides/gs-producing-web-service">\n   <ns0:name>{{_escape_xml(name)}}</ns0:name>\n  </ns0:getCountryRequest>\n </soap-env:Body>\n</soap-env:Envelope>\nEOF\n)\n\nrsp_template=$(cat <<EOF | awk \'{gsub(/"/,"\\\\\\"");};1\' | awk \'{$1=$1};1\' | tr -d \'\\r\\n\'\n{% if Envelope.Body.Fault == nil then %}\n{\n  "status":"{{_ctx.var.status}}",\n  "currency":"{{Envelope.Body.getCountryResponse.country.currency}}",\n  "population":{{Envelope.Body.getCountryResponse.country.population}},\n  "capital":"{{Envelope.Body.getCountryResponse.country.capital}}",\n  "name":"{{Envelope.Body.getCountryResponse.country.name}}"\n}\n{% else %}\n{\n  "message":{*_escape_json(Envelope.Body.Fault.faultstring[1])*},\n  "code":"{{Envelope.Body.Fault.faultcode}}"\n  {% if Envelope.Body.Fault.faultactor ~= nil then %}\n  , "actor":"{{Envelope.Body.Fault.faultactor}}"\n  {% end %}\n}\n{% end %}\nEOF\n)\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"awk")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"tr")," are used above to manipulate the template such that the template would be a valid JSON string."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer")," using the templates created previously. In the Plugin, set the request input format as JSON, the response input format as XML, and the ",(0,r.kt)("inlineCode",{parentName:"p"},"Content-Type")," header to ",(0,r.kt)("inlineCode",{parentName:"p"},"text/xml")," for the Upstream service to respond properly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "methods": ["POST"],\n    "uri": "/ws",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "template": "\'"$req_template"\'",\n          "input_format": "json"\n        },\n        "response": {\n          "template": "\'"$rsp_template"\'",\n          "input_format": "xml"\n        }\n      },\n      "proxy-rewrite": {\n        "headers": {\n          "set": {\n            "Content-Type": "text/xml"\n          }\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "localhost:8080": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"If it is cumbersome to adjust complex text files to be valid transformation templates, you can use the base64 utility to encode the files, such as the following:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"body-transformer": {\n  "request": {\n    "template": "\'"$(base64 -w0 /path/to/request_template_file)"\'"\n  },\n  "response": {\n    "template": "\'"$(base64 -w0 /path/to/response_template_file)"\'"\n  }\n}\n')))),(0,r.kt)("p",null,"Send a request with a valid JSON body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/ws" -X POST -d \'{"name": "Spain"}\'\n')),(0,r.kt)("p",null,"The JSON body sent in the request will be transformed into XML before being forwarded to the Upstream SOAP service, and the response body will be transformed back from XML to JSON."),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "status": "200",\n  "currency": "EUR",\n  "population": 46704314,\n  "capital": "Madrid",\n  "name": "Spain"\n}\n')),(0,r.kt)("h3",{id:"modify-request-body"},"Modify Request Body"),(0,r.kt)("p",null,"The following example demonstrates how to dynamically modify the request body."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer"),", in which the template appends the word ",(0,r.kt)("inlineCode",{parentName:"p"},"world")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," and adds ",(0,r.kt)("inlineCode",{parentName:"p"},"10")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"age")," to set them as values to ",(0,r.kt)("inlineCode",{parentName:"p"},"foo")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"bar")," respectively:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "template": "{\\"foo\\":\\"{{name .. \\" world\\"}}\\",\\"bar\\":{{age+10}}}"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{"name":"hello","age":20}\' \\\n  -i\n')),(0,r.kt)("p",null,"You should see a response of the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "{\\"foo\\":\\"hello world\\",\\"bar\\":30}",\n  ...\n  "json": {\n    "bar": 30,\n    "foo": "hello world"\n  },\n  "method": "POST",\n  ...\n}\n')),(0,r.kt)("h3",{id:"generate-request-body-using-variables"},"Generate Request Body Using Variables"),(0,r.kt)("p",null,"The following example demonstrates how to generate request body dynamically using the ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx")," context variables."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer"),", in which the template accesses the request argument using the ",(0,r.kt)("a",{parentName:"p",href:"https://nginx.org/en/docs/http/ngx_http_core_module.html"},"Nginx variable")," ",(0,r.kt)("inlineCode",{parentName:"p"},"arg_name"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "template": "{\\"foo\\":\\"{{_ctx.var.arg_name .. \\" world\\"}}\\"}"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," argument:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything?name=hello"\n')),(0,r.kt)("p",null,"You should see a response like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {\n    "name": "hello"\n  },\n  ...,\n  "json": {\n    "foo": "hello world"\n  },\n...\n}\n')),(0,r.kt)("h3",{id:"transform-body-from-yaml-to-json"},"Transform Body from YAML to JSON"),(0,r.kt)("p",null,"The following example demonstrates how to transform request body from YAML to JSON."),(0,r.kt)("p",null,"Create the request transformation template:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'req_template=$(cat <<EOF | awk \'{gsub(/"/,"\\\\\\"");};1\'\n{%\n    local yaml = require("tinyyaml")\n    local body = yaml.parse(_body)\n%}\n{"foobar":"{{body.foobar.foo .. " " .. body.foobar.bar}}"}\nEOF\n)\n')),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer")," that uses the template:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "template": "\'"$req_template"\'"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route with a YAML body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'body=\'\nfoobar:\n  foo: hello\n  bar: world\'\n\ncurl "http://127.0.0.1:9080/anything" -X POST \\\n  -d "$body" \\\n  -H "Content-Type: text/yaml" \\\n  -i\n')),(0,r.kt)("p",null,"You should see a response similar to the following, which verifies that the YAML body was appropriately transformed to JSON:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "{\\"foobar\\":\\"hello world\\"}",\n  ...\n  "json": {\n    "foobar": "hello world"\n  },\n...\n}\n')),(0,r.kt)("h3",{id:"transform-form-url-encoded-body-to-json"},"Transform Form URL Encoded Body to JSON"),(0,r.kt)("p",null,"The following example demonstrates how to transform ",(0,r.kt)("inlineCode",{parentName:"p"},"form-urlencoded")," body to JSON."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer")," which sets the ",(0,r.kt)("inlineCode",{parentName:"p"},"input_format")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"encoded")," and configures a template that appends string ",(0,r.kt)("inlineCode",{parentName:"p"},"world")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," input, add ",(0,r.kt)("inlineCode",{parentName:"p"},"10")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"age")," input:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "input_format": "encoded",\n          "template": "{\\"foo\\":\\"{{name .. \\" world\\"}}\\",\\"bar\\":{{age+10}}}"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a POST request to the Route with an encoded body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/x-www-form-urlencoded" \\\n  -d \'name=hello&age=20\'\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {\n    "{\\"foo\\":\\"hello world\\",\\"bar\\":30}": ""\n  },\n  "headers": {\n    ...\n  },\n  ...\n}\n')),(0,r.kt)("h3",{id:"transform-get-request-query-parameter-to-body"},"Transform GET Request Query Parameter to Body"),(0,r.kt)("p",null,"The following example demonstrates how to transform a GET request query parameter to request body. Note that this does not transform the HTTP method. To transform the method, see ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/plugins/proxy-rewrite"},(0,r.kt)("inlineCode",{parentName:"a"},"proxy-rewrite")),"."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer"),", which sets the ",(0,r.kt)("inlineCode",{parentName:"p"},"input_format")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"args")," and configures a template that adds a message to the request:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "input_format": "args",\n          "template": "{\\"message\\": \\"hello {{name}}\\"}"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a GET request to the Route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything?name=john"\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "{\\"message\\": \\"hello john\\"}",\n  "files": {},\n  "form": {},\n  "headers": {\n    ...\n  },\n  "json": {\n    "message": "hello john"\n  },\n  "method": "GET",\n  ...\n}\n')),(0,r.kt)("h3",{id:"transform-plain-media-type"},"Transform Plain Media Type"),(0,r.kt)("p",null,"The following example demonstrates how to transform requests with ",(0,r.kt)("inlineCode",{parentName:"p"},"plain")," media type."),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer"),", which sets the ",(0,r.kt)("inlineCode",{parentName:"p"},"input_format")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"plain")," and configures a template to remove ",(0,r.kt)("inlineCode",{parentName:"p"},"not")," and a subsequent space from the body string:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "input_format": "plain",\n          "template": "{\\"message\\": \\"{* string.gsub(_body, \\"not \\", \\"\\") *}\\"}"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a POST request to the Route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/anything\" -X POST \\\n  -d 'not actually json' \\\n  -i\n")),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {\n    "{\\"message\\": \\"actually json\\"}": ""\n  },\n  "headers": {\n    ...\n  },\n  ...\n}\n')),(0,r.kt)("h3",{id:"transform-multipart-media-type"},"Transform Multipart Media Type"),(0,r.kt)("p",null,"The following example demonstrates how to transform requests with ",(0,r.kt)("inlineCode",{parentName:"p"},"multipart")," media type."),(0,r.kt)("p",null,"Create a request transformation template which adds a ",(0,r.kt)("inlineCode",{parentName:"p"},"status")," to the body based on the ",(0,r.kt)("inlineCode",{parentName:"p"},"age")," provided in the request body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'req_template=$(cat <<EOF | awk \'{gsub(/"/,"\\\\\\"");};1\'\n{%\n  local core = require \'apisix.core\'\n  local cjson = require \'cjson\'\n\n  if tonumber(context.age) > 18 then\n      context._multipart:set_simple("status", "adult")\n  else\n      context._multipart:set_simple("status", "minor")\n  end\n\n  local body = context._multipart:tostring()\n%}{* body *}\nEOF\n)\n')),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"body-transformer"),", which sets the ",(0,r.kt)("inlineCode",{parentName:"p"},"input_format")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"multipart")," and uses the previously created request template for transformation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "body-transformer-route",\n    "uri": "/anything",\n    "plugins": {\n      "body-transformer": {\n        "request": {\n          "input_format": "multipart",\n          "template": "\'"$req_template"\'"\n        }\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a multipart POST request to the Route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X POST \\\n  -F "name=john" \\\n  -F "age=10" \\\n  "http://127.0.0.1:9080/anything"\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {\n    "age": "10",\n    "name": "john",\n    "status": "minor"\n  },\n  "headers": {\n    "Accept": "*/*",\n    "Content-Length": "361",\n    "Content-Type": "multipart/form-data; boundary=------------------------qtPjk4c8ZjmGOXNKzhqnOP",\n    ...\n  },\n  ...\n}\n')))}d.isMDXComponent=!0}}]);