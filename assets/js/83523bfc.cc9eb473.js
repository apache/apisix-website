"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5930],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return u}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=p(n),u=r,g=m["".concat(l,".").concat(u)]||m[u]||h[u]||i;return n?a.createElement(g,s(s({ref:t},c),{},{components:n})):a.createElement(g,s({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var p=2;p<i;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},67549:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return o},metadata:function(){return l},assets:function(){return p},toc:function(){return c},default:function(){return m}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),s={title:"Tutorial: How to use Cert Manager to manage certificates in Apache APISIX Ingress Controller",author:"Chao Zhang",authorURL:"https://github.com/tokers",authorImageURL:"https://avatars.githubusercontent.com/u/10428333?v=4",keywords:["Apache APISIX Ingress Controller","Apache APISIX","Cert Manager","Kubernetes"],description:"This article shows how to create a certificate and pair it with Apache APISIX Ingress Controller via the Cert Manager.",tags:["Technology"]},o=void 0,l={permalink:"/blog/2021/10/22/cert-manager-in-ingress",source:"@site/blog/2021/10/22/cert-manager-in-ingress.md",title:"Tutorial: How to use Cert Manager to manage certificates in Apache APISIX Ingress Controller",description:"This article shows how to create a certificate and pair it with Apache APISIX Ingress Controller via the Cert Manager.",date:"2021-10-22T00:00:00.000Z",formattedDate:"October 22, 2021",tags:[{label:"Technology",permalink:"/blog/tags/technology"}],readingTime:5.82,truncated:!0,authors:[{name:"Chao Zhang",url:"https://github.com/tokers",imageURL:"https://avatars.githubusercontent.com/u/10428333?v=4"}],prevItem:{title:"From 0 to 1, How APISIX Ingress Has Grown and Gained Since Joining The Community",permalink:"/blog/2021/10/26/APISIX-Ingress"},nextItem:{title:"Webinar | Apache APISIX \xd7 Apache SkyWalking Online Meetup",permalink:"/blog/2021/10/18/meetup"}},p={authorsImageUrls:[void 0]},c=[{value:"Step 1: Environmental Preparation",id:"step-1-environmental-preparation",children:[]},{value:"Step 2\uff1aInstall Apache APISIX Ingress Controller",id:"step-2\uff1ainstall-apache-apisix-ingress-controller",children:[]},{value:"Step 3\uff1aInstall Cert Manager",id:"step-3\uff1ainstall-cert-manager",children:[]},{value:"Step 4: Apply for a Certificate and Test it",id:"step-4-apply-for-a-certificate-and-test-it",children:[]},{value:"Summary",id:"summary",children:[]}],h={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This article shows how to create a certificate and pair it with Apache APISIX Ingress Controller via the Cert Manager.")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller"},"Apache APISIX Ingress Controller"),"  is a ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/"},"Kubernetes Ingress Controller")," Open Source Tool that uses ",(0,i.kt)("a",{parentName:"p",href:"http://apisix.apache.org/"},"Apache APISIX")," as a data surface and has been updated to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller/blob/master/CHANGELOG.md#130"},"v1.3")," with features such as certificate management, load balancing, Canary Publishing, and more."),(0,i.kt)("p",null,"For a long time, certificate management is not a simple thing although Apache APISIX Ingress Controller supports extracting certificates and private keys from Kubernetes Secrets Resources and converting them into Apache APISIX recognizable SSL objects, but this is only a part of the whole certificate management chain, certificate issuance, rotation, revocation logic still need to be implemented by administrators, especially when the number of certificates is relatively large, the workload is often not small, so it takes up a lot of the administrator\u2019s time."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/"},"Cert Manager")," is a piece of software dedicated to simplifying certificate management on the Kubernetes platform and supports docking many different certificate sources, such as ",(0,i.kt)("a",{parentName:"p",href:"https://letsencrypt.org/"},"Let\u2019s Encrypt")," and ",(0,i.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/"},"HashiCorp Vault"),"."),(0,i.kt)("p",null,"If you\u2019re having trouble with certificate management when using Apache APISIX Ingress Controller, using the Cert Manager is a good option, and this article shows how to create a certificate and pair it with Apache APISIX Ingress Controller via the Cert Manager."),(0,i.kt)("h2",{id:"step-1-environmental-preparation"},"Step 1: Environmental Preparation"),(0,i.kt)("p",null,"If you want to follow the instructions in this article, make sure the following environments and tools are in place:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"To prepare a usable Kubernetes cluster, in the development environment, you can use ",(0,i.kt)("a",{parentName:"li",href:"https://kind.sigs.k8s.io/"},"Kind")," and ",(0,i.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tutorials/hello-minikube/"},"Minikube")),(0,i.kt)("li",{parentName:"ol"},"Install ",(0,i.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tutorials/hello-minikube/"},"kubectl")),(0,i.kt)("li",{parentName:"ol"},"Install ",(0,i.kt)("a",{parentName:"li",href:"https://helm.sh/"},"Helm v3"))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note that all of the following operations will be performed in the ingress-apisix namespace, so you need to create the namespace first: ",(0,i.kt)("inlineCode",{parentName:"p"},"kubectl create namespace ingress-apisix"))),(0,i.kt)("h2",{id:"step-2\uff1ainstall-apache-apisix-ingress-controller"},"Step 2\uff1aInstall Apache APISIX Ingress Controller"),(0,i.kt)("p",null,"You can install Apache APISIX Ingress Controller via Helm, including Apache APISIX and etcd clusters for data planes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"helm repo add apisix https://charts.apiseven.com\nhelm repo update\nhelm install apisix apisix/apisix --set gateway.tls.enabled=true --set ingress-controller.enabled=true --namespace ingress-apisix\n")),(0,i.kt)("p",null,"Click to view the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-helm-chart/blob/master/charts/apisix/README.md"},"installation details"),"."),(0,i.kt)("h2",{id:"step-3\uff1ainstall-cert-manager"},"Step 3\uff1aInstall Cert Manager"),(0,i.kt)("p",null,"To Install Cert Manager from Helm, click to view the ",(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/installation/"},"installation details"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"helm install cert-manager jetstack/cert-manager --namespace ingress-apisix  --set prometheus.enabled=false --set installCRDs=true\n")),(0,i.kt)("p",null,"Please wait for a moment after installation to check the running status of the components and make sure that all the components are working properly. You can do this by following the command."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get all -n ingress-apisix\n")),(0,i.kt)("p",null,"The result is as follows, indicating that all components are working properly."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"NAME                                             READY   STATUS        RESTARTS   AGE\npod/apisix-5d99956d88-j68sj                      1/1     Running       0          63s\npod/apisix-69459554d4-btnwn                      0/1     Terminating   0          57m\npod/apisix-etcd-0                                1/1     Running       0          57m\npod/apisix-etcd-1                                1/1     Running       0          57m\npod/apisix-etcd-2                                0/1     Running       0          50s\npod/apisix-ingress-controller-7b5c767cc7-j62hb   1/1     Running       0          55m\npod/cert-manager-5ffd4f6c89-q9f7m                1/1     Running       0          45m\npod/cert-manager-cainjector-748dc889c5-nrvkh     1/1     Running       0          45m\npod/cert-manager-startupapicheck-kmgxf           0/1     Completed     0          45m\npod/cert-manager-webhook-bc964d98b-mkjj7         1/1     Running       0          45m\n\nNAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\nservice/apisix-admin                ClusterIP   10.96.16.25     <none>        9180/TCP                     57m\nservice/apisix-etcd                 ClusterIP   10.96.232.251   <none>        2379/TCP,2380/TCP            57m\nservice/apisix-etcd-headless        ClusterIP   None            <none>        2379/TCP,2380/TCP            57m\nservice/apisix-gateway              NodePort    10.96.118.75    <none>        80:32039/TCP,443:30107/TCP   57m\nservice/apisix-ingress-controller   ClusterIP   10.96.13.76     <none>        80/TCP                       57m\nservice/cert-manager-webhook        ClusterIP   10.96.182.188   <none>        443/TCP                      45m\n\nNAME                                        READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/apisix                      1/1     1            1           57m\ndeployment.apps/apisix-ingress-controller   1/1     1            1           57m\ndeployment.apps/cert-manager                1/1     1            1           45m\ndeployment.apps/cert-manager-cainjector     1/1     1            1           45m\ndeployment.apps/cert-manager-webhook        1/1     1            1           45m\n\nNAME                                                   DESIRED   CURRENT   READY   AGE\nreplicaset.apps/apisix-5d99956d88                      1         1         1       63s\nreplicaset.apps/apisix-69459554d4                      0         0         0       57m\nreplicaset.apps/apisix-ingress-controller-74c6b5fbdd   0         0         0       57m\nreplicaset.apps/apisix-ingress-controller-7b5c767cc7   1         1         1       55m\nreplicaset.apps/apisix-ingress-controller-7d58db957c   0         0         0       55m\nreplicaset.apps/cert-manager-5ffd4f6c89                1         1         1       45m\nreplicaset.apps/cert-manager-cainjector-748dc889c5     1         1         1       45m\nreplicaset.apps/cert-manager-webhook-bc964d98b         1         1         1       45m\n\nNAME                           READY   AGE\nstatefulset.apps/apisix-etcd   2/3     57m\n\nNAME                                     COMPLETIONS   DURATION   AGE\njob.batch/cert-manager-startupapicheck   1/1           6m24s      45m\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The mechanism of the ",(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/"},"Kubernetes Controller Manager")," determines that the Pod name will be different.")),(0,i.kt)("h2",{id:"step-4-apply-for-a-certificate-and-test-it"},"Step 4: Apply for a Certificate and Test it"),(0,i.kt)("p",null,"First we need to configure the credential issuing object."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"# issuer.yaml\napiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: issuer\n  namespace: ingress-apisix\nspec:\n  selfSigned: {}\n")),(0,i.kt)("p",null,"And create a self-signed certificate issuer."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f issuer.yaml\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Note that self-signed authoring objects are not recommended for use in production environments! See ",(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/configuration/"},"here")," for more on the configuration of the certificate authority object.")),(0,i.kt)("p",null,"\u3002Then create a certificate for the domain name ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin. org"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'# httpbin-cert.yaml\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: httpbin\n  namespace: ingress-apisix\nspec:\n  secretName: httpbin\n  duration: 2160h # 90d\n  renewBefore: 360h # 15d\n  subject:\n    organizations:\n      - foo\n  commonName: httpbin.org\n  isCA: false\n  privateKey:\n    algorithm: RSA\n    encoding: PKCS1\n    size: 2048\n  usages:\n    - server auth\n  dnsNames:\n    - "httpbin.org"\n    - "*.httpbin.org"\n  issuerRef:\n    name: issuer\n    kind: Issuer\n    group: cert-manager.io\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl apply -f httpbin-cert.yaml\n")),(0,i.kt)("p",null,"At this point, it is necessary to see whether the corresponding Secrets have been created."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get secrets -n ingress-apisix httpbin\nNAME      TYPE                DATA   AGE\nhttpbin   kubernetes.io/tls   3      2m5s\n")),(0,i.kt)("p",null,"With the above validation, the creation of the Secrets object has been captured by Apache APISIX Ingress Controller, we try to access Apache APISIX Ingress Controller to verify the certificate is valid, first we need to create additional routing objects."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"# Create backend\nkubectl run httpbin --image kennethreitz/httpbin --namespace ingress-apisix\nkubectl expose pod httpbin -n ingress-apisix --port 80\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"# Define ApisixTls Objects\napiVersion: apisix.apache.org/v1\nkind: ApisixTls\nmetadata:\n  name: httpbin\n  namespace: ingress-apisix\nspec:\n  hosts:\n  - httpbin.org\n  secret:\n    name: httpbin\n    namespace: ingress-apisix\n---\n# Define the route to access the backend\napiVersion: apisix.apache.org/v2beta1\nkind: ApisixRoute\nmetadata:\n  name: httpbin\n  namespace: ingress-apisix\nspec:\n  http:\n  - name: httpbin\n    match:\n      paths:\n      - /*\n      hosts:\n      - httpbin.org\n    backends:\n    - serviceName: httpbin\n      servicePort: 80\n")),(0,i.kt)("p",null,"Next access the service ",(0,i.kt)("inlineCode",{parentName:"p"},"apisix-gateway"),". Note that the service is ",(0,i.kt)("inlineCode",{parentName:"p"},"NodePort")," by default, and you can change its type as needed. If your Kubernetes cluster is hosted by the cloud vendor, consider changing it to the ",(0,i.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," type, to get an externally accessible IP."),(0,i.kt)("p",null,"Here we map the service to local via port forwarding."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl port-forward -n ingress-apisix svc/apisix-gateway 8443:443\n")),(0,i.kt)("p",null,"Then start configuring access."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl https://httpbin.org:8443/json --resolve \'httpbin.org:8443:127.0.0.1\' -sk\n{\n  "slideshow": {\n    "author": "Yours Truly",\n    "date": "date of publication",\n    "slides": [\n      {\n        "title": "Wake up to WonderWidgets!",\n        "type": "all"\n      },\n      {\n        "items": [\n          "Why <em>WonderWidgets</em> are great",\n          "Who <em>buys</em> WonderWidgets"\n        ],\n        "title": "Overview",\n        "type": "all"\n      }\n    ],\n    "title": "Sample Slide Show"\n  }\n}\n')),(0,i.kt)("p",null,"After the above operation, you can see that the access was successful, that the certificate has been validated. Note that since the certificate is self-signed, the ",(0,i.kt)("inlineCode",{parentName:"p"},"-k")," option needs to be added to ignore the certificate validation."),(0,i.kt)("p",null,"In addition, if you want to rotate the certificate, remove the ",(0,i.kt)("inlineCode",{parentName:"p"},"httpbin")," as the Secret object, and Cert Manager immediately creates a new httpbin Secret object and includes the new certificate."),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"This article focuses on how to use the CERT Manager to create and manage certificates in Apache APISIX Ingress Controller. For more on Apache APISIX Ingress, ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/zh/blog/2021/10/09/apisix-ingress-techblog/"},"see this article"),"."),(0,i.kt)("p",null,"Or take part in a biweekly ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix-ingress-controller/issues/614"},"online discussion")," on the Apache APISIX Ingress Project to share current project progress, best practices, and design ideas."))}m.isMDXComponent=!0}}]);