"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[29297],{35318:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>p});var n=a(27378);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(a),p=i,m=d["".concat(l,".").concat(p)]||d[p]||h[p]||o;return a?n.createElement(m,r(r({ref:t},u),{},{components:a})):n.createElement(m,r({ref:t},u))}));function p(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},43470:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var n=a(25773),i=(a(27378),a(35318));const o={title:"How APISIX implemented in China Mobile Cloud",author:"Yanshan Chen",keywords:["Apache APISIX","China Mobile","OSS","User Case","API Gateway"],description:"This article introduces how China Mobile Cloud develops products and improves and updates its functions based on the cloud-native API gateway Apache APISIX.",tags:["Case Studies"],image:"https://static.apiseven.com/2022/blog/0817/%E7%A7%BB%E5%8A%A8%E4%BA%91.png"},r=void 0,s={permalink:"/blog/2021/09/13/china-mobile-cloud-usercase",source:"@site/blog/2021/09/13/china-mobile-cloud-usercase.md",title:"How APISIX implemented in China Mobile Cloud",description:"This article introduces how China Mobile Cloud develops products and improves and updates its functions based on the cloud-native API gateway Apache APISIX.",date:"2021-09-13T00:00:00.000Z",formattedDate:"September 13, 2021",tags:[{label:"Case Studies",permalink:"/blog/tags/case-studies"}],readingTime:7.725,truncated:!0,authors:[{name:"Yanshan Chen"}],prevItem:{title:"Youzanyun PaaS for comprehensive micro-service governance with APISX",permalink:"/blog/2021/09/14/youzan"},nextItem:{title:"How can I contribute to an open source project without writing code?",permalink:"/blog/2021/09/09/how-to-contribute-to-an-openSource-without-coding"}},l={authorsImageUrls:[void 0]},c=[{value:"Background Information",id:"background-information",children:[],level:2},{value:"Why Did We Choose Apache APISIX as a Gateway?",id:"why-did-we-choose-apache-apisix-as-a-gateway",children:[{value:"Why Did We Abandon Nginx?",id:"why-did-we-abandon-nginx",children:[{value:"Reason 1: Lack of Overall Capabilities",id:"reason-1-lack-of-overall-capabilities",children:[],level:4},{value:"Reason 2: Inflexible Configuration",id:"reason-2-inflexible-configuration",children:[],level:4}],level:3},{value:"Why Did We Choose Apache APISIX?",id:"why-did-we-choose-apache-apisix",children:[{value:"Reason 1: Based on the Need for Product Architecture",id:"reason-1-based-on-the-need-for-product-architecture",children:[],level:4},{value:"Reason 2: Implementation of Fine-grained Business Functions",id:"reason-2-implementation-of-fine-grained-business-functions",children:[],level:4},{value:"Reason 3: SLA Service Level Guarantee",id:"reason-3-sla-service-level-guarantee",children:[],level:4}],level:3}],level:2},{value:"What Did We Change in Apache APISIX Data Plane?",id:"what-did-we-change-in-apache-apisix-data-plane",children:[{value:"Improvement 1: Separate Access for Internal and External Network Requests",id:"improvement-1-separate-access-for-internal-and-external-network-requests",children:[],level:3},{value:"Improvement 2: Request for Fuse Protection",id:"improvement-2-request-for-fuse-protection",children:[],level:3},{value:"Improvement 3: Customize Constant Key to Achieve Global Flow-limit",id:"improvement-3-customize-constant-key-to-achieve-global-flow-limit",children:[],level:3},{value:"Improvement 4: New Function Feature Switches",id:"improvement-4-new-function-feature-switches",children:[{value:"Switch 1: Temporarily Turn off an Object Storage Function",id:"switch-1-temporarily-turn-off-an-object-storage-function",children:[],level:4},{value:"Switch 2: Support the Highest Priority for GET Requests",id:"switch-2-support-the-highest-priority-for-get-requests",children:[],level:4},{value:"Switch 3: Return 501 Not Implemented for Ordered List Requests",id:"switch-3-return-501-not-implemented-for-ordered-list-requests",children:[],level:4}],level:3},{value:"Improvement 5: Transparent Upgrade/Expansion/Configuration Change",id:"improvement-5-transparent-upgradeexpansionconfiguration-change",children:[],level:3},{value:"Improvement 6: Request Log Tracking Analysis Based on Request-id",id:"improvement-6-request-log-tracking-analysis-based-on-request-id",children:[],level:3},{value:"Improvement 7: Cross Available Zones Request Scheduling Feature",id:"improvement-7-cross-available-zones-request-scheduling-feature",children:[],level:3}],level:2},{value:"Future Plans",id:"future-plans",children:[],level:2}],u={toc:c};function h(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This article is compiled from a presentation given by Yanshan Chen from China Mobile Cloud Competence Center at ApacheCon 2021 Asia. By reading this article, you can learn how China Mobile Cloud is developing and improving and updating its products based on Apache APISIX to create a better mobile cloud object storage.")),(0,i.kt)("h2",{id:"background-information"},"Background Information"),(0,i.kt)("p",null,"As the builder of China Mobile\u2019s cloud facilities, provider of cloud services and aggregator of cloud ecology, China Mobile\u2019s Cloud Competence Center has assumed six major responsibilities for mobile cloud: technology research and development, planning and construction, operation and maintenance, cooperation and introduction, sales support, and support for cloud deployment."),(0,i.kt)("p",null,"As of October 2020, a total of 25 public cloud nodes have been built nationwide, with a provincial coverage rate of over 80%. Among them, object storage EOS, as one of the underlying infrastructure capabilities, has been deployed in all resource pools, and the overall available scale has reached EB level."),(0,i.kt)("p",null,"Mobile cloud object storage has gone through four generations of development history changes. Starting from self-research and development, through functional expansion, deep customization, performance improvement to the latest generation has a cross-regional global correction and deletion architecture, to achieve the effect of off-site multi-live disaster recovery. Throughout the years, it can be said that the progress is rapid."),(0,i.kt)("p",null,"In the early stage of cloud object storage technology selection, we investigated many API gateways, including Nginx, Apache APISIX, etc., and finally chose Apache APISIX, which can not only meet the current business requirements, but also provide more ideas and choices for our products in terms of system availability and maintainability, which is similar to that of Apache APISIX. The overall product evolution plan and technology stack are more compatible."),(0,i.kt)("h2",{id:"why-did-we-choose-apache-apisix-as-a-gateway"},"Why Did We Choose Apache APISIX as a Gateway?"),(0,i.kt)("h3",{id:"why-did-we-abandon-nginx"},"Why Did We Abandon Nginx?"),(0,i.kt)("h4",{id:"reason-1-lack-of-overall-capabilities"},"Reason 1: Lack of Overall Capabilities"),(0,i.kt)("p",null,"Apache APISIX as a microservice gateway, compared with other API gateways, its upstream routing plugins are fully dynamic, and no restart is required to modify the configuration. The plugin also supports hot-loading, so you can plug and unplug and modify the plugin at any time. These capabilities are not available in Nginx, especially in scenarios with very high business continuity requirements."),(0,i.kt)("h4",{id:"reason-2-inflexible-configuration"},"Reason 2: Inflexible Configuration"),(0,i.kt)("p",null,"Apache APISIX supports all-platform, multi-protocol, fully dynamic, fine-grained routing, security protection, and is O&M friendly, and can be docked to Prometheus, SkyWalking, etc., with highly scalable These are the capabilities that are needed in real production."),(0,i.kt)("h3",{id:"why-did-we-choose-apache-apisix"},"Why Did We Choose Apache APISIX?"),(0,i.kt)("h4",{id:"reason-1-based-on-the-need-for-product-architecture"},"Reason 1: Based on the Need for Product Architecture"),(0,i.kt)("p",null,"As mentioned earlier, object storage has now gone through four generations of development. With the richness of the product features, the scale of the entire architecture cluster becomes larger, there is a need for more control surface policies, including traffic governance, service governance and other policies to ensure the stable operation of the entire system."),(0,i.kt)("h4",{id:"reason-2-implementation-of-fine-grained-business-functions"},"Reason 2: Implementation of Fine-grained Business Functions"),(0,i.kt)("p",null,"Apache APISIX features, functional plugins, and custom development capabilities are available to meet our business needs during subsequent development."),(0,i.kt)("h4",{id:"reason-3-sla-service-level-guarantee"},"Reason 3: SLA Service Level Guarantee"),(0,i.kt)("p",null,"The general SLA service level availability emphasizes two metrics: system mean time to failure and system mean time to repair failure. How to effectively lengthen the system mean time to failure? How to effectively reduce the system mean time to repair? These two questions are our key considerations. Apache APISIX has good traffic management and service management related capabilities in both fault isolation and self-healing."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1631500451210-60ba58d6-1fc4-4db6-b658-5e0066bb1c9b.png",alt:"SLA Service Level"})),(0,i.kt)("h2",{id:"what-did-we-change-in-apache-apisix-data-plane"},"What Did We Change in Apache APISIX Data Plane?"),(0,i.kt)("h3",{id:"improvement-1-separate-access-for-internal-and-external-network-requests"},"Improvement 1: Separate Access for Internal and External Network Requests"),(0,i.kt)("p",null,"Currently our business model has two domains, the intranet domain and the extranet domain. The intranet domain name access is the east-west access of the resource pool, such as the internal virtual machine of the resource pool, application platform class products, etc. The extranet domain name is equivalent to pure public network access, such as: public cloud, toC and toB customers in the public network, accessing object storage via satellite or physical private line."),(0,i.kt)("p",null,"By accessing Apache APISIX, we realize multi-domain certificate configuration for internal and external domain names, and provide encrypted access function, and realize the function of dynamic loading of SSL certificate. For 24-hour uninterrupted business, it is very important to be able to dynamically update SSL certificate."),(0,i.kt)("h3",{id:"improvement-2-request-for-fuse-protection"},"Improvement 2: Request for Fuse Protection"),(0,i.kt)("p",null,"Here we first give you a brief description of the current Object Storage EOS node management after accessing Apache APISIX. The entire object store is divided into a data plane and a control plane. The data plane mainly carries the I/O flow of the whole business. The business data is processed from APISIX\u2019s Layer 7 traffic governance module as the entry point, through the APISIX back-end upstream Accesser, which is the main module for business interface processing."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646731748455-69e4da37-1a58-4303-968e-3a636e308d04.png",alt:"Fuse Protection"})),(0,i.kt)("p",null,"The control plane has several main services, including the autopilot service Manager, the observable system Observer, and the chaos engineering fault injection module Checker. there is also an additional overall interaction orchestration system Orchestrator and a canary release platform Publisher."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646731771583-36c98076-1434-4bb6-820d-41de725223bf.png",alt:"Control Plane Services"})),(0,i.kt)("p",null,"In order to achieve request fusion protection, the data plane is connected to Apache APISIX to achieve the processing capability of request intervention. The observable system at the control plane is mainly built based on Prometheus, which collects indicators and alerts, and finally realizes the overall fusion protection at the back-end."),(0,i.kt)("h3",{id:"improvement-3-customize-constant-key-to-achieve-global-flow-limit"},"Improvement 3: Customize Constant Key to Achieve Global Flow-limit"),(0,i.kt)("p",null,"limit-conn key This plugin mainly supports remote_addr, server_addr, X-Forwarded-For, X-Real-IP, but cannot do full limit flow for north-south gateway traffic.\nIn order to match our business requirements, we customize a constant constant as the range of imit-conn key. The right side of the above figure is the modified configuration after accessing Apache APISIX, and the constant constant constant key is used to achieve the function of global flow-limit."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646731806833-166c115f-26bb-4657-a7c1-9a24e043f399.png",alt:"Global Flow-limit"})),(0,i.kt)("h3",{id:"improvement-4-new-function-feature-switches"},"Improvement 4: New Function Feature Switches"),(0,i.kt)("h4",{id:"switch-1-temporarily-turn-off-an-object-storage-function"},"Switch 1: Temporarily Turn off an Object Storage Function"),(0,i.kt)("p",null,"In the gateway layer by accessing Apache APISIX, it is compatible with the S3 interface specification to avoid wasting resources on the access layer and persistence layer of the back-end service."),(0,i.kt)("h4",{id:"switch-2-support-the-highest-priority-for-get-requests"},"Switch 2: Support the Highest Priority for GET Requests"),(0,i.kt)("p",null,"With the support of GET request priority, GET requests have the highest priority when retrieving user data, higher than PUT, DELETE and other requests."),(0,i.kt)("h4",{id:"switch-3-return-501-not-implemented-for-ordered-list-requests"},"Switch 3: Return 501 Not Implemented for Ordered List Requests"),(0,i.kt)("p",null,"In the object storage will generally have a bucket of Ordered List feature requirements. The third and fourth generation of mobile cloud object storage for tens of billions of file objects, if still using Ordered List, on the one hand, request access to the back-end response time will be particularly long, on the other hand, will take up more resources, the stability of the back-end a greater challenge."),(0,i.kt)("p",null,"Therefore, after accessing Apache APISIX, the request will be rejected directly at the gateway level, and the status code of 501 Not Implemented will be returned."),(0,i.kt)("h3",{id:"improvement-5-transparent-upgradeexpansionconfiguration-change"},"Improvement 5: Transparent Upgrade/Expansion/Configuration Change"),(0,i.kt)("p",null,"Combined with the Apache APISIX Layer 7 governance capabilities, we perform upgrades, scaling and configuration changes to key components upstream and across the I/O path to control back-end weighting through dynamic scaling and dynamic upgrade operations for subsequent request processing."),(0,i.kt)("h3",{id:"improvement-6-request-log-tracking-analysis-based-on-request-id"},"Improvement 6: Request Log Tracking Analysis Based on Request-id"),(0,i.kt)("p",null,"Based on access.log, we have implemented a centralized log collection management method to collect APISIX logs and logs of other processes, and then perform a comprehensive analysis."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646731841734-478f5fe5-186c-4d1e-b754-009ba4942ead.png",alt:"Log Tracking"})),(0,i.kt)("p",null,"The configuration item on the right side of the image above uses the request-id plugin of Apache APISIX. Each request is assigned a request-id when it passes through APISIX, which is used in the business logic processing layer (Accesser) and the data persistence layer, which in turn filters out the log timestamps of the different components in the official Loki panel and helps to automate some analysis using AI later."),(0,i.kt)("h3",{id:"improvement-7-cross-available-zones-request-scheduling-feature"},"Improvement 7: Cross Available Zones Request Scheduling Feature"),(0,i.kt)("p",null,"The backend of the current load balancing is a seven-layer traffic governance layer based on APISIX implementation, which achieves multi-live capability by equal ECMP + BGP routing. We define three traffic types, each APISIX node receives service traffic and only hits the upstream service of this node to process (level0, purple line), similar to SideCar mode.\nIf a node has a problem upstream, it will be forwarded to other upstream nodes in the same AZ for processing (green line). If all upstream nodes hang, the ability to invoke requests across AZs (level2, red line) is implemented based on Apache APISIX, which writes the requests to other AZs and finally achieves request scheduling across AZs."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646731904721-e1b2a9ee-0f3c-41da-8a6b-c20a027df1b6.png",alt:"Cross Available Zones Request Scheduling"})),(0,i.kt)("h2",{id:"future-plans"},"Future Plans"),(0,i.kt)("p",null,"The future of mobile cloud object storage will fully embrace cloud-native, and gradually achieve the following plans:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Integrate data surface functions, and eventually achieve a comprehensive containerized deployment orchestration.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Successively access the APISIX-based Ingress Controller, through APISIX to unify access portal.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Strengthen the integration capability with Autopilot Manager and Observer subsystem to further achieve fault isolation and self-healing.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Move the authentication capability of object storage S3 to the interface layer. Better achieve unified authentication and security access to protect the back-end effect."))))}h.isMDXComponent=!0}}]);