"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[87213],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),p=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(n),c=r,h=m["".concat(o,".").concat(c)]||m[c]||u[c]||i;return n?a.createElement(h,l(l({ref:t},d),{},{components:n})):a.createElement(h,l({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var p=2;p<i;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},76189:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var a=n(87462),r=(n(67294),n(3905));const i={title:"traffic-split",keywords:["Apache APISIX","API Gateway","Traffic Split","Blue-green Deployment","Canary Deployment"],description:"The traffic-split Plugin directs traffic to various Upstream services based on conditions and/or weights. It provides a dynamic and flexible approach to implement release strategies and manage traffic."},l=void 0,s={unversionedId:"plugins/traffic-split",id:"plugins/traffic-split",isDocsHomePage:!1,title:"traffic-split",description:"The traffic-split Plugin directs traffic to various Upstream services based on conditions and/or weights. It provides a dynamic and flexible approach to implement release strategies and manage traffic.",source:"@site/docs/apisix/plugins/traffic-split.md",sourceDirName:"plugins",slug:"/plugins/traffic-split",permalink:"/docs/apisix/next/plugins/traffic-split",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/traffic-split.md",tags:[],version:"current",frontMatter:{title:"traffic-split",keywords:["Apache APISIX","API Gateway","Traffic Split","Blue-green Deployment","Canary Deployment"],description:"The traffic-split Plugin directs traffic to various Upstream services based on conditions and/or weights. It provides a dynamic and flexible approach to implement release strategies and manage traffic."},sidebar:"docs",previous:{title:"api-breaker",permalink:"/docs/apisix/next/plugins/api-breaker"},next:{title:"request-id",permalink:"/docs/apisix/next/plugins/request-id"}},o=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Implement Canary Release",id:"implement-canary-release",children:[]},{value:"Implement Blue-Green Deployment",id:"implement-blue-green-deployment",children:[]},{value:"Define Matching Condition for POST Request With APISIX Expressions",id:"define-matching-condition-for-post-request-with-apisix-expressions",children:[]},{value:"Define AND Matching Conditions With APISIX Expressions",id:"define-and-matching-conditions-with-apisix-expressions",children:[]},{value:"Define OR Matching Conditions With APISIX Expressions",id:"define-or-matching-conditions-with-apisix-expressions",children:[]},{value:"Configure Different Rules for Different Upstreams",id:"configure-different-rules-for-different-upstreams",children:[]}]}],p={toc:o};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/traffic-split"})),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin directs traffic to various Upstream services based on conditions and/or weights. It provides a dynamic and flexible approach to implement release strategies and manage traffic."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"The traffic ratio between Upstream services may be less accurate since round robin algorithm is used to direct traffic (especially when the state is reset)."))),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.match"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[object]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"An array of one or more pairs of matching conditions and actions to be executed.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.match"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[object]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Rules to match for conditional traffic split.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.match.vars"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[array]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"An array of one or more matching conditions in the form of ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr")," to conditionally execute the plugin.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[object]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"List of Upstream configurations.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream_id"),(0,r.kt)("td",{parentName:"tr",align:null},"string/integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"ID of the configured Upstream object.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.weight"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"weight = 1"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Weight for each upstream.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Configuration of the upstream. Certain configuration options Upstream are not supported here. These fields are ",(0,r.kt)("inlineCode",{parentName:"td"},"service_name"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"discovery_type"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"checks"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"retries"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"retry_timeout"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"desc"),", and ",(0,r.kt)("inlineCode",{parentName:"td"},"labels"),". As a workaround, you can create an Upstream object and configure it in ",(0,r.kt)("inlineCode",{parentName:"td"},"upstream_id"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.type"),(0,r.kt)("td",{parentName:"tr",align:null},"array"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"roundrobin"),(0,r.kt)("td",{parentName:"tr",align:null},"[roundrobin, chash]"),(0,r.kt)("td",{parentName:"tr",align:null},"Algorithm for traffic splitting. ",(0,r.kt)("inlineCode",{parentName:"td"},"roundrobin")," for weighted round robin and ",(0,r.kt)("inlineCode",{parentName:"td"},"chash")," for consistent hashing.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.hash_on"),(0,r.kt)("td",{parentName:"tr",align:null},"array"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"vars"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Used when ",(0,r.kt)("inlineCode",{parentName:"td"},"type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"chash"),". Support hashing on ",(0,r.kt)("a",{parentName:"td",href:"https://nginx.org/en/docs/varindex.html"},"NGINX  variables"),", headers, cookie, Consumer, or a combination of ",(0,r.kt)("a",{parentName:"td",href:"https://nginx.org/en/docs/varindex.html"},"NGINX  variables"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.key"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Used when ",(0,r.kt)("inlineCode",{parentName:"td"},"type")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"chash"),". When ",(0,r.kt)("inlineCode",{parentName:"td"},"hash_on")," is set to ",(0,r.kt)("inlineCode",{parentName:"td"},"header")," or ",(0,r.kt)("inlineCode",{parentName:"td"},"cookie"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is required. When ",(0,r.kt)("inlineCode",{parentName:"td"},"hash_on")," is set to ",(0,r.kt)("inlineCode",{parentName:"td"},"consumer"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"key")," is not required as the Consumer name will be used as the key automatically.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.nodes"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Addresses of the Upstream nodes.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"15"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Timeout in seconds for connecting, sending and receiving messages.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.pass_host"),(0,r.kt)("td",{parentName:"tr",align:null},"array"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},'"pass"'),(0,r.kt)("td",{parentName:"tr",align:null},'["pass", "node", "rewrite"]'),(0,r.kt)("td",{parentName:"tr",align:null},"Mode deciding how the host name is passed. ",(0,r.kt)("inlineCode",{parentName:"td"},"pass")," passes the client's host name to the upstream. ",(0,r.kt)("inlineCode",{parentName:"td"},"node")," passes the host configured in the node of the upstream. ",(0,r.kt)("inlineCode",{parentName:"td"},"rewrite")," passes the value configured in ",(0,r.kt)("inlineCode",{parentName:"td"},"upstream_host"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.name"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Identifier for the Upstream for specifying service name, usage scenarios, and so on.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"rules.weighted_upstreams.upstream.upstream_host"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Used when ",(0,r.kt)("inlineCode",{parentName:"td"},"pass_host")," is ",(0,r.kt)("inlineCode",{parentName:"td"},"rewrite"),". Host name of the upstream.")))),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below show different use cases for using the ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"implement-canary-release"},"Implement Canary Release"),(0,r.kt)("p",null,"The following example demonstrates how to implement canary release with this Plugin."),(0,r.kt)("p",null,"A Canary release is a gradual deployment in which an increasing percentage of traffic is directed to a new release, allowing for a controlled and monitored rollout. This method ensures that any potential issues or bugs in the new release can be identified and addressed early on, before fully redirecting all traffic."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin with the following rules:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/headers",\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                },\n                "weight": 3\n              },\n              {\n                "weight": 2\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "scheme": "https",\n      "pass_host": "node",\n      "nodes": {\n        "mock.api7.ai:443":1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"The proportion of traffic to each Upstream is determined by the weight of the Upstream relative to the total weight of all upstreams. Here, the total weight is calculated as: 3 + 2 = 5."),(0,r.kt)("p",null,"Therefore, 60% of the traffic are to be forwarded to ",(0,r.kt)("inlineCode",{parentName:"p"},"httpbin.org")," and the other 40% of the traffic are to be forwarded to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),"."),(0,r.kt)("p",null,"Send 10 consecutive requests to the Route to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 10 | xargs -I{} curl "http://127.0.0.1:9080/headers" -sL) && \\\n  count_httpbin=$(echo "$resp" | grep "httpbin.org" | wc -l) && \\\n  count_mockapi7=$(echo "$resp" | grep "mock.api7.ai" | wc -l) && \\\n  echo httpbin.org: $count_httpbin, mock.api7.ai: $count_mockapi7\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"httpbin.org: 6, mock.api7.ai: 4\n")),(0,r.kt)("p",null,"Adjust the Upstream weights accordingly to complete the canary release."),(0,r.kt)("h3",{id:"implement-blue-green-deployment"},"Implement Blue-Green Deployment"),(0,r.kt)("p",null,"The following example demonstrates how to implement blue-green deployment with this Plugin."),(0,r.kt)("p",null,"Blue-green deployment is a deployment strategy that involves maintaining two identical environments: the ",(0,r.kt)("em",{parentName:"p"},"blue")," and the ",(0,r.kt)("em",{parentName:"p"},"green"),". The blue environment refers to the current production deployment and the green environment refers to the new deployment. Once the green environment is tested to be ready for production, traffic will be routed to the green environment, making it the new production deployment."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin to execute the Plugin to redirect traffic only when the request contains a header ",(0,r.kt)("inlineCode",{parentName:"p"},"release: new_release"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/headers",\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "match": [\n              {\n                "vars": [\n                  ["http_release","==","new_release"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                }\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "scheme": "https",\n      "pass_host": "node",\n      "nodes": {\n        "mock.api7.ai:443":1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"release")," header:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/headers\" -H 'release: new_release'\n")),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "headers": {\n    "Accept": "*/*",\n    "Host": "httpbin.org",\n    ...\n  }\n}\n')),(0,r.kt)("p",null,"Send a request to the Route without any additional header:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/headers"\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "headers": {\n    "accept": "*/*",\n    "host": "mock.api7.ai",\n    ...\n  }\n}\n')),(0,r.kt)("h3",{id:"define-matching-condition-for-post-request-with-apisix-expressions"},"Define Matching Condition for POST Request With APISIX Expressions"),(0,r.kt)("p",null,"The following example demonstrates how to use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr")," in rules to conditionally execute the Plugin when certain condition of a POST request is satisfied."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin with the following rules:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/post",\n    "methods": ["POST"],\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "match": [\n              {\n                "vars": [\n                  ["post_arg_id", "==", "1"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                }\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "scheme": "https",\n      "pass_host": "node",\n      "nodes": {\n        "mock.api7.ai:443":1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a POST request with body ",(0,r.kt)("inlineCode",{parentName:"p"},"id=1"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/post\" -X POST \\\n  -H 'Content-Type: application/x-www-form-urlencoded' \\\n  -d 'id=1'\n")),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {\n    "id": "1"\n  },\n  "headers": {\n    "Accept": "*/*",\n    "Content-Length": "4",\n    "Content-Type": "application/x-www-form-urlencoded",\n    "Host": "httpbin.org",\n    ...\n  },\n  ...\n}\n')),(0,r.kt)("p",null,"Send a POST request without ",(0,r.kt)("inlineCode",{parentName:"p"},"id=1")," in the body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/post\" -X POST \\\n  -H 'Content-Type: application/x-www-form-urlencoded' \\\n  -d 'random=string'\n")),(0,r.kt)("p",null,"You should see that the request was forwarded to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),"."),(0,r.kt)("h3",{id:"define-and-matching-conditions-with-apisix-expressions"},"Define AND Matching Conditions With APISIX Expressions"),(0,r.kt)("p",null,"The following example demonstrates how to use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr")," in rules to conditionally execute the Plugin when multiple conditions are satisfied."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin to redirect traffic only when all three conditions are satisfied:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/headers",\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "match": [\n              {\n                "vars": [\n                  ["arg_name","==","jack"],\n                  ["http_user-id",">","23"],\n                  ["http_apisix-key","~~","[a-z]+"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                },\n                "weight": 3\n              },\n              {\n                "weight": 2\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "scheme": "https",\n      "pass_host": "node",\n      "nodes": {\n        "mock.api7.ai:443":1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"If conditions are satisfied, 60% of the traffic should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"httpbin.org")," and the other 40% should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),". If conditions are not satisfied, all traffic should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),"."),(0,r.kt)("p",null,"Send 10 consecutive requests that satisfy all conditions to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 10 | xargs -I{} curl "http://127.0.0.1:9080/headers?name=jack" -H \'user-id: 30\' -H \'apisix-key: helloapisix\' -sL) && \\\n  count_httpbin=$(echo "$resp" | grep "httpbin.org" | wc -l) && \\\n  count_mockapi7=$(echo "$resp" | grep "mock.api7.ai" | wc -l) && \\\n  echo httpbin.org: $count_httpbin, mock.api7.ai: $count_mockapi7\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"httpbin.org: 6, mock.api7.ai: 4\n")),(0,r.kt)("p",null,"Send 10 consecutive requests that do not satisfy the conditions to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 10 | xargs -I{} curl "http://127.0.0.1:9080/headers?name=random" -sL) && \\\n  count_httpbin=$(echo "$resp" | grep "httpbin.org" | wc -l) && \\\n  count_mockapi7=$(echo "$resp" | grep "mock.api7.ai" | wc -l) && \\\n  echo httpbin.org: $count_httpbin, mock.api7.ai: $count_mockapi7\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"httpbin.org: 0, mock.api7.ai: 10\n")),(0,r.kt)("h3",{id:"define-or-matching-conditions-with-apisix-expressions"},"Define OR Matching Conditions With APISIX Expressions"),(0,r.kt)("p",null,"The following example demonstrates how to use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr")," in rules to conditionally execute the Plugin when either set of the condition is satisfied."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin to redirect traffic when either set of the configured conditions are satisfied:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/headers",\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "match": [\n              {\n                "vars": [\n                  ["arg_name","==","jack"],\n                  ["http_user-id",">","23"],\n                  ["http_apisix-key","~~","[a-z]+"]\n                ]\n              },\n              {\n                "vars": [\n                  ["arg_name2","==","rose"],\n                  ["http_user-id2","!",">","33"],\n                  ["http_apisix-key2","~~","[a-z]+"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                },\n                "weight": 3\n              },\n              {\n                "weight": 2\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "scheme": "https",\n      "pass_host": "node",\n      "nodes": {\n        "mock.api7.ai:443":1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Alternatively, you can also use the OR operator in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr")," for these conditions."),(0,r.kt)("p",null,"If conditions are satisfied, 60% of the traffic should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"httpbin.org")," and the other 40% should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),". If conditions are not satisfied, all traffic should be directed to ",(0,r.kt)("inlineCode",{parentName:"p"},"mock.api7.ai"),"."),(0,r.kt)("p",null,"Send 10 consecutive requests that satisfy the second set of conditions to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 10 | xargs -I{} curl "http://127.0.0.1:9080/headers?name2=rose" -H \'user-id:30\' -H \'apisix-key2: helloapisix\' -sL) && \\\n  count_httpbin=$(echo "$resp" | grep "httpbin.org" | wc -l) && \\\n  count_mockapi7=$(echo "$resp" | grep "mock.api7.ai" | wc -l) && \\\n  echo httpbin.org: $count_httpbin, mock.api7.ai: $count_mockapi7\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},"httpbin.org: 6, mock.api7.ai: 4\n")),(0,r.kt)("p",null,"Send 10 consecutive requests that do not satisfy any set of conditions to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 10 | xargs -I{} curl "http://127.0.0.1:9080/headers?name=random" -sL) && \\\n  count_httpbin=$(echo "$resp" | grep "httpbin.org" | wc -l) && \\\n  count_mockapi7=$(echo "$resp" | grep "mock.api7.ai" | wc -l) && \\\n  echo httpbin.org: $count_httpbin, mock.api7.ai: $count_mockapi7\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},"httpbin.org: 0, mock.api7.ai: 10\n")),(0,r.kt)("h3",{id:"configure-different-rules-for-different-upstreams"},"Configure Different Rules for Different Upstreams"),(0,r.kt)("p",null,"The following example demonstrates how to set one-to-one mapping between rule sets and upstreams."),(0,r.kt)("p",null,"Create a Route and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"traffic-split")," Plugin with the following matching rules to redirect traffic when the request contains a header ",(0,r.kt)("inlineCode",{parentName:"p"},"x-api-id: 1")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"x-api-id: 2"),", to the corresponding Upstream service:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/headers",\n    "id": "traffic-split-route",\n    "plugins": {\n      "traffic-split": {\n        "rules": [\n          {\n            "match": [\n              {\n                "vars": [\n                  ["http_x-api-id","==","1"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "httpbin.org:443":1\n                  }\n                },\n                "weight": 1\n              }\n            ]\n          },\n          {\n            "match": [\n              {\n                "vars": [\n                  ["http_x-api-id","==","2"]\n                ]\n              }\n            ],\n            "weighted_upstreams": [\n              {\n                "upstream": {\n                  "type": "roundrobin",\n                  "scheme": "https",\n                  "pass_host": "node",\n                  "nodes": {\n                    "mock.api7.ai:443":1\n                  }\n                },\n                "weight": 1\n              }\n            ]\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "postman-echo.com:443": 1\n      },\n      "scheme": "https",\n      "pass_host": "node"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request with header ",(0,r.kt)("inlineCode",{parentName:"p"},"x-api-id: 1"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/headers\" -H 'x-api-id: 1'\n")),(0,r.kt)("p",null,"You should see an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "headers": {\n    "Accept": "*/*",\n    "Host": "httpbin.org",\n    ...\n  }\n}\n')),(0,r.kt)("p",null,"Send a request with header ",(0,r.kt)("inlineCode",{parentName:"p"},"x-api-id: 2"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl \"http://127.0.0.1:9080/headers\" -H 'x-api-id: 2'\n")),(0,r.kt)("p",null,"You should see an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "headers": {\n    "accept": "*/*",\n    "host": "mock.api7.ai",\n    ...\n  }\n}\n')),(0,r.kt)("p",null,"Send a request without any additional header:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/headers"\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "headers": {\n    "accept": "*/*",\n    "host": "postman-echo.com",\n    ...\n  }\n}\n')))}d.isMDXComponent=!0}}]);