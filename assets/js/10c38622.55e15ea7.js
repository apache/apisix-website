"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[16849],{35318:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(27378);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(a),m=o,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||r;return a?n.createElement(h,i(i({ref:t},c),{},{components:a})):n.createElement(h,i({ref:t},c))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3432:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var n=a(25773),o=(a(27378),a(35318));const r={title:"Apache APISIX without etcd",authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258"}],keywords:["Architecture","etcd","MySQL"],description:"While a great database, etcd is not devoid of issues. In this post, I'll show how you can use Apache APISIX with MySQL.\n",tags:["Ecosystem"],image:"https://static.apiseven.com/uploads/2023/07/26/T33IqLZ8_information-1641937.jpg"},i=void 0,l={permalink:"/blog/2023/07/27/apisix-without-etcd",source:"@site/blog/2023/07/27/apisix-without-etcd.md",title:"Apache APISIX without etcd",description:"While a great database, etcd is not devoid of issues. In this post, I'll show how you can use Apache APISIX with MySQL.\n",date:"2023-07-27T00:00:00.000Z",formattedDate:"July 27, 2023",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:5.225,truncated:!0,authors:[{name:"Nicolas Fr\xe4nkel",title:"Author",url:"https://github.com/nfrankel",image_url:"https://avatars.githubusercontent.com/u/752258",imageURL:"https://avatars.githubusercontent.com/u/752258"}],prevItem:{title:"Biweekly Report (July 17 - July 30)",permalink:"/blog/2023/08/02/weekly-report"},nextItem:{title:"Release Apache APISIX 3.2.2",permalink:"/blog/2023/07/23/release-apache-apisix-3.2.2"}},s={authorsImageUrls:[void 0]},p=[{value:"The kine project",id:"the-kine-project",children:[],level:2},{value:"ETCD adapter",id:"etcd-adapter",children:[],level:2},{value:"Demo",id:"demo",children:[],level:2},{value:"Testing",id:"testing",children:[],level:2},{value:"Conclusion",id:"conclusion",children:[],level:2}],c={toc:p};function u(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"While a great database, etcd is not devoid of issues. In this post, I'll show how you can use Apache APISIX with MySQL.")),(0,o.kt)("head",null,(0,o.kt)("link",{rel:"canonical",href:"https://blog.frankel.ch/apisix-without-etcd/"})),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://etcd.io/"},"etcd")," is an excellent key-value distributed database used internally by Kubernetes and managed by the CNCF. It's a great option, and that's the reason why Apache APISIX uses it too. Yet, it's not devoid of issues."),(0,o.kt)("p",null,"First, some mention scalability, but one can expect this from a distributed data store that values consistency. Another issue may be the need for more familiarity with etcd. It's relatively new, so your Ops team may need help operating it correctly while having decades of operating MySQL or Postgres. Finally, only a few etcd users are aware that it lacks maintainers:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"In the last few months, primary maintainers G.L. (Amazon, announcement) and S.B. (Red Hat) have stopped actively participating in the project. This leaves the project with only one active and two occasionally-reviewing maintainers, M.S. (Google),  P.T. (Google), both are relatively new to the project (1 month and 1 year of tenure) and S.P.Z. (IBM). Other maintainers are either dormant or have very minimal activity over the last six months. ",(0,o.kt)("strong",{parentName:"p"},"The project is effectively unmaintained")," ",(0,o.kt)("em",{parentName:"p"},"(emphasis mine)"),"."),(0,o.kt)("p",{parentName:"blockquote"},"-- ",(0,o.kt)("a",{parentName:"p",href:"https://groups.google.com/a/kubernetes.io/g/steering/c/e-O-tVSCJOk/m/N9IkiWLEAgAJ"},"Google Groups of Kubernetes Steering Committee, March 2022"))),(0,o.kt)("p",null,"For all those reasons, you may prefer to use a standard SQL database with Apache APISIX. In this post, I'll show how you can use MySQL."),(0,o.kt)("h2",{id:"the-kine-project"},"The kine project"),(0,o.kt)("p",null,"It would be a lot of effort if each product had to introduce an abstraction layer and different adapters for both etcd and other databases. kine is a project that aims to offer a translation step between etcd calls and other implementations:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Kine is an etcdshim that translates etcd API to:"),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},"SQLite"),(0,o.kt)("li",{parentName:"ul"},"Postgres"),(0,o.kt)("li",{parentName:"ul"},"MySQL"),(0,o.kt)("li",{parentName:"ul"},"NATS Jetstream")),(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("strong",{parentName:"p"},"Features")),(0,o.kt)("ul",{parentName:"blockquote"},(0,o.kt)("li",{parentName:"ul"},"Can be ran standalone so any k8s (not just K3s) can use Kine"),(0,o.kt)("li",{parentName:"ul"},"Implements a subset of etcdAPI (not usable at all for general purpose etcd)"),(0,o.kt)("li",{parentName:"ul"},"Translates etcdTX calls into the desired API (Create, Update, Delete)")),(0,o.kt)("p",{parentName:"blockquote"},"-- ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/k3s-io/kine"},"Kine (Kine is not etcd)"))),(0,o.kt)("p",null,"In essence, kine is a Go library that translates etcd calls to the datastore you want (among those implemented)."),(0,o.kt)("p",null,"Yet, using kine directly is a non-trivial effort. Fortunately, ",(0,o.kt)("a",{parentName:"p",href:"https://api7.ai/"},"api7"),", the company that gave Apache APISIX to the Apache Software Foundation, provides a component already focused on APISIX usage."),(0,o.kt)("h2",{id:"etcd-adapter"},"ETCD adapter"),(0,o.kt)("p",null,"ETCD adapter wraps kine to be APISIX-specific:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"ETCD Adapter mimics the ETCD V3 APIs best effort. It incorporates the kine as the Server side implementation, and it develops a totally in-memory watchable backend."),(0,o.kt)("p",{parentName:"blockquote"},"Not all features in ETCD V3 APIs supported, this is designed for Apache APISIX, so it's inherently not a generic solution."),(0,o.kt)("p",{parentName:"blockquote"},"-- ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/api7/etcd-adapter/"},"ETCD adapter"))),(0,o.kt)("p",null,"Two things of note:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"At the moment of this writing, the adapter supports either local in-memory storage or MySQL"),(0,o.kt)("li",{parentName:"ul"},"It's available as an embeddable library but also as a standalone component")),(0,o.kt)("p",null,"Therefore, we can design our architecture as the following:"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/07/26/aioB38NC_overall-architecture.svg",alt:"Overall architecture"})),(0,o.kt)("h2",{id:"demo"},"Demo"),(0,o.kt)("p",null,"Let's implement the above architecture with an additional admin UI over MySQL. I'll use Docker Compose:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3"\n\nservices:\n  apisix:\n    image: apache/apisix:3.4.0-debian                         #1\n    volumes:\n      - ./config.yaml:/usr/local/apisix/conf/config.yaml:ro\n    ports:\n      - "9080:9080"\n      - "9180:9180"\n    depends_on:\n      - etcd-adapter\n    restart: always                                           #2\n  etcd-adapter:\n    build: ./etcd-adapter                                     #3\n    volumes:\n      - ./adapter.yml:/etcd-adapter/conf/config.yaml:ro       #4\n    depends_on:\n      - mysql\n    restart: always                                           #2\n  mysql:\n    image: bitnami/mysql:8.0                                  #5\n    ports:\n      - "3306:3306"\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_USER: etcd\n      MYSQL_PASSWORD: etcd\n      MYSQL_DATABASE: apisix\n  adminer:\n    image: adminer:standalone                                 #6\n    ports:\n      - "8080:8080"\n    environment:\n      ADMINER_DEFAULT_SERVER: mysql\n    depends_on:\n      - mysql\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Latest version of Apache APISIX, yeah!"),(0,o.kt)("li",{parentName:"ol"},"To avoid any failure with dependencies between containers, restart until it works. Kubernetes's manifests would involve health checks"),(0,o.kt)("li",{parentName:"ol"},"api7.ai still needs to provide a container. We need to build from the source code"),(0,o.kt)("li",{parentName:"ol"},"Override the default configuration file with a context-specific one"),(0,o.kt)("li",{parentName:"ol"},"The regular MySQL image didn't work for me. Let's take the one from Bitnami"),(0,o.kt)("li",{parentName:"ol"},"Adminer, formerly known as PHP myAdmin, will help to visualize the database state")),(0,o.kt)("p",null,"ETCD-adapter's configuration looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"server:\n  host: 0.0.0.0                 #1\n  port: 12379\n\nlog:\n  level: info\n\ndatasource:\n  type: mysql                   #2\n  mysql:\n    host: mysql                 #3\n    port: 3306                  #3\n    username: etcd              #3\n    password: etcd              #3\n    database: apisix\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Bind any IP since Docker will assign a random one"),(0,o.kt)("li",{parentName:"ol"},"Implementation type. The default is ",(0,o.kt)("inlineCode",{parentName:"li"},"btree"),"; we need to change it."),(0,o.kt)("li",{parentName:"ol"},"As configured in the ",(0,o.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," file")),(0,o.kt)("p",null,"Finally, here's Apache APISIX configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'deployment:\n  admin:\n    allow_admin:\n      - 0.0.0.0/0\n  etcd:\n    host:\n      - "http://etcd-adapter:12379"   #1\n')),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Use this etcd instance, which is the adapter")),(0,o.kt)("h2",{id:"testing"},"Testing"),(0,o.kt)("p",null,"Now that we are set let's test our system by creating a route:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'{\n  "methods": ["GET"],\n  "uris": ["/get"],\n  "upstream": {\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\' http://localhost:9180/apisix/admin/routes/1\n')),(0,o.kt)("p",null,"We can now get it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' http://localhost:9180/apisix/admin/routes/1\n")),(0,o.kt)("p",null,"We can also check via the Adminer interface that it has been persisted via MySQL:"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://static.apiseven.com/uploads/2023/07/26/PaAJJVIM_adminer.jpg",alt:"Adminer screenshot displaying the new route"})),(0,o.kt)("p",null,"Unfortunately, we need to stop at this point. Getting all routes doesn't work:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' http://localhost:9180/apisix/admin/routes\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"header":{"revision":"1689689596"},"message":"Key not found"}\n')),(0,o.kt)("p",null,"Worse, using the route fails:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl localhost:9080/get\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"error_msg":"404 Route Not Found"}\n')),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"etcd is an excellent piece of infrastructure Kubernetes uses, but there might be better choices in some contexts. Worse, it might become a security threat in the future - or is already one, because of the lack of maintenance. Being able to move away from etcd is a considerable benefit."),(0,o.kt)("p",null,"kine offers an etcd-compatible facade and multiple implementations. Using kine with Apache APISIX requires some adaptation effort, already done in ETCD-Adapter."),(0,o.kt)("p",null,"Currently, ETCD-Adapter is not feature-complete (to say the least) and requires more love. That's why it was not donated to the Apache Foundation yet. If you're a Go developer and are interested in the project, feel free to subscribe to the ",(0,o.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/general/join/"},"Apache APISIX mailing list and/or join our Slack")," to offer your help."),(0,o.kt)("p",null,"The complete source code for this post can be found on GitHub:"),(0,o.kt)("p",null,"{% embed ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ajavageek/apisix-mysql"},"https://github.com/ajavageek/apisix-mysql")," %}"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To go further:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/k3s-io/kine"},"Kine")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/api7/ETCD-adapter"},"ETCD Adapter")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://martinheinz.dev/blog/100"},"Goodbye etcd, Hello PostgreSQL: Running Kubernetes with an SQL Database"))))}u.isMDXComponent=!0}}]);