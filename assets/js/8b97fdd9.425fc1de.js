"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[67394],{3905:(t,e,n)=>{n.d(e,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var p=a.createContext({}),u=function(t){var e=a.useContext(p),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},d=function(t){var e=u(t.components);return a.createElement(p.Provider,{value:e},t.children)},m={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},s=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,p=t.parentName,d=o(t,["components","mdxType","originalType","parentName"]),s=u(n),c=r,k=s["".concat(p,".").concat(c)]||s[c]||m[c]||l;return n?a.createElement(k,i(i({ref:e},d),{},{components:n})):a.createElement(k,i({ref:e},d))}));function c(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,i=new Array(l);i[0]=s;var o={};for(var p in e)hasOwnProperty.call(e,p)&&(o[p]=e[p]);o.originalType=t,o.mdxType="string"==typeof t?t:r,i[1]=o;for(var u=2;u<l;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}s.displayName="MDXCreateElement"},83143:(t,e,n)=>{n.r(e),n.d(e,{contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={title:"ai-aliyun-content-moderation",keywords:["Apache APISIX","API Gateway","Plugin","ai-aliyun-content-moderation"],description:"This document contains information about the Apache APISIX ai-aliyun-content-moderation Plugin."},i=void 0,o={unversionedId:"plugins/ai-aliyun-content-moderation",id:"plugins/ai-aliyun-content-moderation",isDocsHomePage:!1,title:"ai-aliyun-content-moderation",description:"This document contains information about the Apache APISIX ai-aliyun-content-moderation Plugin.",source:"@site/docs/apisix/plugins/ai-aliyun-content-moderation.md",sourceDirName:"plugins",slug:"/plugins/ai-aliyun-content-moderation",permalink:"/docs/apisix/next/plugins/ai-aliyun-content-moderation",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/ai-aliyun-content-moderation.md",tags:[],version:"current",frontMatter:{title:"ai-aliyun-content-moderation",keywords:["Apache APISIX","API Gateway","Plugin","ai-aliyun-content-moderation"],description:"This document contains information about the Apache APISIX ai-aliyun-content-moderation Plugin."},sidebar:"docs",previous:{title:"ai-aws-content-moderation",permalink:"/docs/apisix/next/plugins/ai-aws-content-moderation"},next:{title:"ai-prompt-decorator",permalink:"/docs/apisix/next/plugins/ai-prompt-decorator"}},p=[{value:"Description",id:"description",children:[]},{value:"Plugin Attributes",id:"plugin-attributes",children:[]},{value:"Example usage",id:"example-usage",children:[]}],u={toc:p};function d(t){let{components:e,...n}=t;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-aliyun-content-moderation")," plugin integrates with Aliyun's content moderation service to check both request and response content for inappropriate material when working with LLMs. It supports both real-time streaming checks and final packet moderation."),(0,r.kt)("p",null,"This plugin must be used in routes that utilize the ai-proxy or ai-proxy-multi plugins."),(0,r.kt)("h2",{id:"plugin-attributes"},"Plugin Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Field")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Required")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Type")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Description")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun service endpoint URL")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"region_id"),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun region identifier")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"access_key_id"),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun access key ID")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"access_key_secret"),(0,r.kt)("td",{parentName:"tr",align:null},"Yes"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun access key secret")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"check_request"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enable request content moderation. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"true"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"check_response"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enable response content moderation. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_mode"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Streaming moderation mode. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},'"final_packet"'),". Valid values: ",(0,r.kt)("inlineCode",{parentName:"td"},'["realtime", "final_packet"]'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_cache_size"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Integer"),(0,r.kt)("td",{parentName:"tr",align:null},"Max characters per moderation batch in realtime mode. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"128"),". Must be ",(0,r.kt)("inlineCode",{parentName:"td"},">= 1"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_interval"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"Seconds between batch checks in realtime mode. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"3"),". Must be ",(0,r.kt)("inlineCode",{parentName:"td"},">= 0.1"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"request_check_service"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun service for request moderation. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},'"llm_query_moderation"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"request_check_length_limit"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"Max characters per request moderation chunk. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"2000"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"response_check_service"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Aliyun service for response moderation. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},'"llm_response_moderation"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"response_check_length_limit"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"Max characters per response moderation chunk. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"5000"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"risk_level_bar"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Threshold for content rejection. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},'"high"'),". Valid values: ",(0,r.kt)("inlineCode",{parentName:"td"},'["none", "low", "medium", "high", "max"]'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"deny_code"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"HTTP status code for rejected content. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"200"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"deny_message"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"Custom message for rejected content. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"-"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Integer"),(0,r.kt)("td",{parentName:"tr",align:null},"Request timeout in milliseconds. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"10000"),". Must be ",(0,r.kt)("inlineCode",{parentName:"td"},">= 1"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"No"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"Enable SSL certificate verification. Default: ",(0,r.kt)("inlineCode",{parentName:"td"},"true"),".")))),(0,r.kt)("h2",{id:"example-usage"},"Example usage"),(0,r.kt)("p",null,"First initialise these shell variables:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"ADMIN_API_KEY=edd1c9f034335f136f87ad84b625c8f1\nALIYUN_ACCESS_KEY_ID=your-aliyun-access-key-id\nALIYUN_ACCESS_KEY_SECRET=your-aliyun-access-key-secret\nALIYUN_REGION=cn-hangzhou\nALIYUN_ENDPOINT=https://green.cn-hangzhou.aliyuncs.com\nOPENAI_KEY=your-openai-api-key\n")),(0,r.kt)("p",null,"Create a route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-aliyun-content-moderation")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy")," plugin like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/v1/chat/completions",\n    "plugins": {\n      "ai-proxy": {\n        "provider": "openai",\n        "auth": {\n          "header": {\n            "Authorization": "Bearer \'"$OPENAI_KEY"\'"\n          }\n        },\n        "override": {\n          "endpoint": "http://localhost:6724/v1/chat/completions"\n        }\n      },\n      "ai-aliyun-content-moderation": {\n        "endpoint": "\'"$ALIYUN_ENDPOINT"\'",\n        "region_id": "\'"$ALIYUN_REGION"\'",\n        "access_key_id": "\'"$ALIYUN_ACCESS_KEY_ID"\'",\n        "access_key_secret": "\'"$ALIYUN_ACCESS_KEY_SECRET"\'",\n        "risk_level_bar": "high",\n        "check_request": true,\n        "check_response": true,\n        "deny_code": 400,\n        "deny_message": "Your request violates content policy"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy")," plugin is used here as it simplifies access to LLMs. However, you may configure the LLM in the upstream configuration as well."),(0,r.kt)("p",null,"Now send a request:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/v1/chat/completions -i \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "gpt-3.5-turbo",\n    "messages": [\n      {"role": "user", "content": "I want to kill you"}\n    ],\n    "stream": false\n  }\'\n')),(0,r.kt)("p",null,"Then the request will be blocked with error like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 400 Bad Request\nContent-Type: application/json\n\n{"id":"chatcmpl-123","object":"chat.completion","model":"gpt-3.5-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"Your request violates content policy"},"finish_reason":"stop"}],"usage":{"prompt_tokens":0,"completion_tokens":0,"total_tokens":0}}\n')))}d.isMDXComponent=!0}}]);