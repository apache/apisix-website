"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[64048],{3905:function(e,t,a){a.d(t,{Zo:function(){return h},kt:function(){return d}});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var c=n.createContext({}),l=function(e){var t=n.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},h=function(e){var t=l(e.components);return n.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,c=e.parentName,h=s(e,["components","mdxType","originalType","parentName"]),u=l(a),d=o,m=u["".concat(c,".").concat(d)]||u[d]||p[d]||i;return a?n.createElement(m,r(r({ref:t},h),{},{components:a})):n.createElement(m,r({ref:t},h))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var l=2;l<i;l++)r[l]=a[l];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},31218:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return r},contentTitle:function(){return s},metadata:function(){return c},assets:function(){return l},toc:function(){return h},default:function(){return u}});var n=a(87462),o=a(63366),i=(a(67294),a(3905)),r={title:"WPS has teamed up with Apache APISIX to create a new gateway experience",author:"Qiang Zhang",keywords:["Apache APISIX","API Gateway","WPS"],description:"In this article, Zhang Qiang, head of SRE network in WPS, explains how WPS can use Apache APISIX to handle Mega QPS, and update and improve gateway practices based on Apache APISIX.",tags:["User Case"]},s=void 0,c={permalink:"/blog/2021/09/28/WPS-usercase",source:"@site/blog/2021/09/28/WPS-usercase.md",title:"WPS has teamed up with Apache APISIX to create a new gateway experience",description:"In this article, Zhang Qiang, head of SRE network in WPS, explains how WPS can use Apache APISIX to handle Mega QPS, and update and improve gateway practices based on Apache APISIX.",date:"2021-09-28T00:00:00.000Z",formattedDate:"September 28, 2021",tags:[{label:"User Case",permalink:"/blog/tags/user-case"}],readingTime:7.6,truncated:!0,authors:[{name:"Qiang Zhang"}],prevItem:{title:"Release Apache APISIX 2.10.0",permalink:"/blog/2021/09/29/release-apache-apisix-2.10"},nextItem:{title:"Why is Apache APISIX Ingress a new option for building container gateways into the UPYUN?",permalink:"/blog/2021/09/24/youpaicloud-usercase"}},l={authorsImageUrls:[void 0]},h=[{value:"Background",id:"background",children:[]},{value:"Gateway Evolution in WPS",id:"gateway-evolution-in-wps",children:[]},{value:"Why Apache APISIX\uff1f",id:"why-apache-apisix\uff1f",children:[]},{value:"Experience of Gateway Smooth Migration",id:"experience-of-gateway-smooth-migration",children:[]},{value:"Shared State Improvements Based on Apache APISIX",id:"shared-state-improvements-based-on-apache-apisix",children:[{value:"Improvement 1: Optimize ETCD Architecture with Multiple Machines Listening",id:"improvement-1-optimize-etcd-architecture-with-multiple-machines-listening",children:[]},{value:"Improvement 2: Solve the Performance Problem During Routing Validation",id:"improvement-2-solve-the-performance-problem-during-routing-validation",children:[]},{value:"More Experience with Shared State",id:"more-experience-with-shared-state",children:[]}]},{value:"Open Source Discussion",id:"open-source-discussion",children:[{value:"The Trade-off Between Stability and Function",id:"the-trade-off-between-stability-and-function",children:[]},{value:"Based on Apache APISIX Production Experience",id:"based-on-apache-apisix-production-experience",children:[]}]}],p={toc:h};function u(e){var t=e.components,a=(0,o.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"In this article, Zhang Qiang, head of SRE network in WPS, explains how WPS can use Apache APISIX to handle Mega QPS, and update and improve gateway practices based on Apache APISIX.")),(0,i.kt)("h2",{id:"background"},"Background"),(0,i.kt)("p",null,"WPS is currently the largest domestic office software manufacturers, its products include WPS Office, Kdocs, Docer and so on. At the business level, deployed by thousands of businesses in a container on an internal cloud native platform, ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/"},"Apache APISIX")," at WPS is currently responsible for providing gateway services to the mid-stage business (Mega QPS) ."),(0,i.kt)("h2",{id:"gateway-evolution-in-wps"},"Gateway Evolution in WPS"),(0,i.kt)("p",null,"In phase 1.0, we didn\u2019t have a strong requirement for API Gateway features, we just wanted to solve the operations problem, so we did our own research based on OpenResty and Lua to implement dynamic Upstream, blacklist, WAF and so on. Although self-developed, but left some problems in the function, such as:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"It\u2019s only as dynamic as the Upstream dimension"),(0,i.kt)("li",{parentName:"ul"},"Need to Reload to bring out the new domain name"),(0,i.kt)("li",{parentName:"ul"},"The bottom design is simple, the function expansion ability is not strong")),(0,i.kt)("p",null,"Following the strong demand for API Gateway functionality, we began to investigate the related open source Gateway products."),(0,i.kt)("h2",{id:"why-apache-apisix\uff1f"},"Why Apache APISIX\uff1f"),(0,i.kt)("p",null,"In fact, when the research on gateway products began in late 2019, Kong was one of the more popular choices."),(0,i.kt)("p",null,"However, subsequent tests showed that Kong\u2019s performance was not quite up to our expectations, and we didn\u2019t think that Kong\u2019s architecture was very good: its configuration center used PostgreSQL, so Kong can only use the non-event driver to update the route, relying on each node to refresh the route."),(0,i.kt)("p",null,"On further investigation, we discovered ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix"},"Apache APISIX"),". First of all, Apache APISIX performs better than Kong, and there\u2019s a very detailed graph in Apache APISIX\u2019s GitHub Readme that shows the ",(0,i.kt)("a",{parentName:"p",href:"https://gist.github.com/membphis/137db97a4bf64d3653aa42f3e016bd01"},"performance of Apache APISIX Compared to Kong"),", which are basically consistent with the data we\u2019ve tested ourselves."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1632796929580-a6d7847c-bba6-4417-a7f0-9c127313264e.png",alt:"Performance comparison between Apache APISIX and Kong"})),(0,i.kt)("p",null,"In terms of architecture, Apache APISIX\u2019s ETCD configuration is a better choice for us."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1632796952262-b814e37d-cbc5-43f5-b504-ab1751a9aa83.png",alt:"Apache APISIX architecture"})),(0,i.kt)("p",null,"The main reason, of course, is that we feel that community is also important. If the community is active, it will be able to update iterations, troubleshoot problems, and optimize functionality quickly. From GitHub and regular email feedback we can see that the Apache APISIX community is active, providing a strong guarantee of product functionality and stability."),(0,i.kt)("h2",{id:"experience-of-gateway-smooth-migration"},"Experience of Gateway Smooth Migration"),(0,i.kt)("p",null,"When most of my friends started working with Apache APISIX, they used the CLI to generate configurations and instances. However, during our smooth migration, we did not use the CLI to generate the configuration."),(0,i.kt)("p",null,"The main reason is that Apache APISIX does some Phase in OpenResty, such as initializing the init, init_worker, HTTP, and Upstream related phases."),(0,i.kt)("p",null,"Corresponding to the Apache APISIX configuration, we found that these can be migrated from the CLI smoothly."),(0,i.kt)("p",null,"So for these reasons, we ended up doing the following smooth migration:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"CLI generation configuration without Apache APISIX"),(0,i.kt)("li",{parentName:"ul"},"Introduce a Package Path for Apache APISIX and make Apache APISIX the Default Server"),(0,i.kt)("li",{parentName:"ul"},"KEEP domain names in other static configurations, and because the new domain name is not in the static configuration, Fallback to Apache APISIX"),(0,i.kt)("li",{parentName:"ul"},"Eventually the static configuration was migrated gradually to Apache APISIX")),(0,i.kt)("p",null,"Of course, in addition to the above, we recommend a \u201cLight-mixing mode\u201d that uses static configuration with Apache APISIX as Location, with some of the Phase or Lua code mentioned earlier. Doing so allows you to introduce special configurations into your static configuration, make it dynamic, etc. ."),(0,i.kt)("h2",{id:"shared-state-improvements-based-on-apache-apisix"},"Shared State Improvements Based on Apache APISIX"),(0,i.kt)("p",null,"First of all, in my opinion, \u201cThe Shared State is the biggest factor in the stability of the feed, which is definitely not an issue.\u201dWhy?"),(0,i.kt)("p",null,"Because forwarding efficiency can be addressed by scaling laterally, the Shared State is a critical module because it is Shared by all nodes."),(0,i.kt)("p",null,"So after using Apache APISIX, we made a few tweaks and optimizations to focus on the Shared State layer."),(0,i.kt)("h3",{id:"improvement-1-optimize-etcd-architecture-with-multiple-machines-listening"},"Improvement 1: Optimize ETCD Architecture with Multiple Machines Listening"),(0,i.kt)("p",null,"In a typical corporate gateway architecture, multiple machines are involved, some as many as a few hundred, and each machine has to take into account the number of workers. So when multiple machines monitor the same Key, the pressure on the ETCD is greater, because one of the ETCD mechanisms is to ensure data consistency, requiring all events to be returned to the listening request before new requests can be processed, the request is discarded when the send buffer is full. So when multiple machines listen at the same time will cause the ETCD to run overtime, Overload error, and so on."),(0,i.kt)("p",null,"To solve the above problem, we use our own ETCD Proxy. The previous connection between Apache APISIX and ETCD is shown on the left side of the figure below, with each node connected to the ETCD. So as a large-scale entry, the number of connections can be particularly large, putting pressure on the ETCD."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1632796985052-c2453a37-edc1-4102-bbb7-8e03627765d5.png",alt:"etcd Proxy"})),(0,i.kt)("p",null,"Since we are listening to the same Key, we make a proxy to do a uniform listening and return the results to Apache APISIX when there is feedback. As shown on the right side of the image above, the ETCD Proxy component is placed between Apache APISIX and ETCD to monitor changes in Key values."),(0,i.kt)("h3",{id:"improvement-2-solve-the-performance-problem-during-routing-validation"},"Improvement 2: Solve the Performance Problem During Routing Validation"),(0,i.kt)("p",null,"As companies grow in size, so will the number of routes. In practice, Apache APISIX reconstructs the prefix tree used to match the route each time the route is updated. This is mainly due to poor sort performance of ",(0,i.kt)("inlineCode",{parentName:"p"},"table.sort"),"."),(0,i.kt)("p",null,"In the process of practice, we observe that the CPU of the gateway increases and the packet loss rate increases when the route is updated frequently."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1632797671795-141a410b-0dd5-4873-b3dc-56f892aa2f07.png",alt:"CPU Flame Diagram"})),(0,i.kt)("p",null,"In terms of CPU ramp-up, it is clear from the flame diagram that the majority of CPU time is allocated to the ",(0,i.kt)("inlineCode",{parentName:"p"},"auxsort"),", which is triggered by FUNCC. The FUNCC trigger also points to the problem of proving that the data did not pass through Luajit and that only the rightmost part of the graph processed normal requests."),(0,i.kt)("p",null,"The main reason for this is LuaJIT\u2019s ",(0,i.kt)("inlineCode",{parentName:"p"},"table.sort")," doesn\u2019t rely entirely on the JIT mode, as you can see in the ",(0,i.kt)("a",{parentName:"p",href:"http://wiki.luajit.org/NYI"},"Luajit wiki"),", so it works in the Lua code environment with low efficiency."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1632797702785-9afdc28d-6c7a-4643-8cac-72b41fee8e2b.png",alt:"LuaJIT Wiki"})),(0,i.kt)("p",null,"We solved this problem ourselves using pure Lua code to implement the sort configuration for the above scenario, but Apache APISIX has since fixed the problem, the idea is similar to what we understand."),(0,i.kt)("h3",{id:"more-experience-with-shared-state"},"More Experience with Shared State"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"When you modify Apache APISIX or do your own plug-in development, make sure you do Schema validation, including nulls, especially in the matching section. Because if something goes wrong in the matching section, it can have an impact on the whole."),(0,i.kt)("li",{parentName:"ol"},"Do a good job of business split planning. Plan your ETCD Prefix and IP numbers according to your traffic, and deploy more robust clusters to minimize systemic risks.")),(0,i.kt)("h2",{id:"open-source-discussion"},"Open Source Discussion"),(0,i.kt)("h3",{id:"the-trade-off-between-stability-and-function"},"The Trade-off Between Stability and Function"),(0,i.kt)("p",null,"WPS has been using Apache APISIX for almost two years now, and as a product user, I think Apache APISIX is really a stable and reliable open source product, keep up to date with the latest community releases."),(0,i.kt)("p",null,"But as anyone who has ever used an open source product will know, there will be some new features in the updated version, but there will also be some stability issues, so how do we choose between the updated version and the stability."),(0,i.kt)("p",null,"There is no universal answer to this question, but I personally feel that for Apache APISIX, try to keep up with the official version."),(0,i.kt)("p",null,"As far as the Jinshan District Office is concerned, we currently have a very high level of stability due to the large-scale use of Apache APISIX. We\u2019ve had some trouble keeping up with the official updates, so we recommend keeping up with the official version as much as possible."),(0,i.kt)("p",null,"If you\u2019re like the rest of us, you may not always be able to keep up with the official version, but you should at least be able to check out GitHub\u2019s ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix"},"Master Change Log")," and other documentation on a weekly basis and keep an eye on product changes."),(0,i.kt)("h3",{id:"based-on-apache-apisix-production-experience"},"Based on Apache APISIX Production Experience"),(0,i.kt)("p",null,"Based on Apache APISIX, we have packaged a number of product features, such as multi-room application scaling, one-click blocking routing, and so on. In practical application, we realize that Apache APISIX is a very flexible and powerful product, so we should understand one point when we make the transition to production: powerful = unavoidable complexity and danger."),(0,i.kt)("p",null,"Apache APISIX itself has a lot of code design, for example, some plug-ins may need to be modified to compile their own, because after all, the respective application scenario can not be unified."),(0,i.kt)("p",null,"Finally, based on the practical experience mentioned above, it is also recommended that the granularity of gateway sharing should be planned well in advance to reduce the problems of subsequent use."))}u.isMDXComponent=!0}}]);