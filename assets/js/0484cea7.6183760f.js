"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[55321],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=p(n),c=r,k=m["".concat(s,".").concat(c)]||m[c]||u[c]||l;return n?a.createElement(k,i(i({ref:t},d),{},{components:n})):a.createElement(k,i({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1910:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var a=n(87462),r=(n(67294),n(3905));const l={title:"response-rewrite",keywords:["Apache APISIX","API Gateway","Plugin","Response Rewrite","response-rewrite"],description:"The response-rewrite Plugin offers options to rewrite responses that APISIX and its Upstream services return to clients. With the Plugin, you can modify HTTP status codes, request headers, response body, and more."},i=void 0,o={unversionedId:"plugins/response-rewrite",id:"plugins/response-rewrite",isDocsHomePage:!1,title:"response-rewrite",description:"The response-rewrite Plugin offers options to rewrite responses that APISIX and its Upstream services return to clients. With the Plugin, you can modify HTTP status codes, request headers, response body, and more.",source:"@site/docs/apisix/plugins/response-rewrite.md",sourceDirName:"plugins",slug:"/plugins/response-rewrite",permalink:"/docs/apisix/next/plugins/response-rewrite",editUrl:"/edit#https://github.com/apache/apisix/edit/master/docs/en/latest/plugins/response-rewrite.md",tags:[],version:"current",frontMatter:{title:"response-rewrite",keywords:["Apache APISIX","API Gateway","Plugin","Response Rewrite","response-rewrite"],description:"The response-rewrite Plugin offers options to rewrite responses that APISIX and its Upstream services return to clients. With the Plugin, you can modify HTTP status codes, request headers, response body, and more."},sidebar:"docs",previous:{title:"ocsp-stapling",permalink:"/docs/apisix/next/plugins/ocsp-stapling"},next:{title:"proxy-rewrite",permalink:"/docs/apisix/next/plugins/proxy-rewrite"}},s=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Rewrite Header and Body",id:"rewrite-header-and-body",children:[]},{value:"Rewrite Header With RegEx Filter",id:"rewrite-header-with-regex-filter",children:[]},{value:"Decode Body from Base64",id:"decode-body-from-base64",children:[]},{value:"Rewrite Response and Its Connection with Execution Phases",id:"rewrite-response-and-its-connection-with-execution-phases",children:[]}]}],p={toc:s};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("head",null,(0,r.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/response-rewrite"})),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin offers options to rewrite responses that APISIX and its Upstream services return to clients. With the Plugin, you can modify HTTP status codes, request headers, response body, and more."),(0,r.kt)("p",null,"For instance, you can use this Plugin to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Support ",(0,r.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS"},"CORS")," by setting ",(0,r.kt)("inlineCode",{parentName:"li"},"Access-Control-Allow-*")," headers."),(0,r.kt)("li",{parentName:"ul"},"Indicate redirection by setting HTTP status codes and ",(0,r.kt)("inlineCode",{parentName:"li"},"Location")," header.")),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can also use the ",(0,r.kt)("a",{parentName:"p",href:"/docs/apisix/next/plugins/redirect"},"redirect")," Plugin to set up redirects."))),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"status_code"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"[200, 598]"),(0,r.kt)("td",{parentName:"tr",align:null},"New HTTP status code in the response. If unset, falls back to the original status code.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"body"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"New response body. The ",(0,r.kt)("inlineCode",{parentName:"td"},"Content-Length")," header would also be reset. Should not be configured with ",(0,r.kt)("inlineCode",{parentName:"td"},"filters"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"body_base64"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, decode the response body configured in ",(0,r.kt)("inlineCode",{parentName:"td"},"body")," before sending to client, which is useful for image and protobuf decoding. Note that this configuration cannot be used to decode Upstream response.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"headers"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Actions to be executed in the order of ",(0,r.kt)("inlineCode",{parentName:"td"},"add"),", ",(0,r.kt)("inlineCode",{parentName:"td"},"remove"),", and ",(0,r.kt)("inlineCode",{parentName:"td"},"set"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"headers.add"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Headers to append to requests. If a header already present in the request, the header value will be appended. Header value could be set to a constant, or one or more ",(0,r.kt)("a",{parentName:"td",href:"https://nginx.org/en/docs/http/ngx_http_core_module.html"},"Nginx variables"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"headers.set"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Headers to set to requests. If a header already present in the request, the header value will be overwritten. Header value could be set to a constant, or one or more",(0,r.kt)("a",{parentName:"td",href:"https://nginx.org/en/docs/http/ngx_http_core_module.html"},"Nginx variables"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"headers.remove"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Headers to remove from requests.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"vars"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[array]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"An array of one or more matching conditions in the form of ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/api7/lua-resty-expr#operator-list"},"lua-resty-expr"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"filters"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[object]"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"List of filters that modify the response body by replacing one specified string with another. Should not be configured with ",(0,r.kt)("inlineCode",{parentName:"td"},"body"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"filters.regex"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"RegEx pattern to match on the response body.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"filters.scope"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},'"once"'),(0,r.kt)("td",{parentName:"tr",align:null},'["once","global"]'),(0,r.kt)("td",{parentName:"tr",align:null},"Scope of substitution. ",(0,r.kt)("inlineCode",{parentName:"td"},"once")," substitutes the first matched instance and ",(0,r.kt)("inlineCode",{parentName:"td"},"global")," substitutes globally.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"filters.replace"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Content to substitute with.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"filters.options"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},'"jo"'),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"RegEx options to control how the match operation should be performed. See ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/openresty/lua-nginx-module#ngxrematch"},"Lua NGINX module")," for the available options.")))),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below demonstrate how you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," on a Route in different scenarios."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"rewrite-header-and-body"},"Rewrite Header and Body"),(0,r.kt)("p",null,"The following example demonstrates how to add response body and headers, only to responses with ",(0,r.kt)("inlineCode",{parentName:"p"},"200")," HTTP status codes."),(0,r.kt)("p",null,"Create a Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "response-rewrite-route",\n    "methods": ["GET"],\n    "uri": "/headers",\n    "plugins": {\n      "response-rewrite": {\n        "body": "{\\"code\\":\\"ok\\",\\"message\\":\\"new json body\\"}",\n        "headers": {\n          "set": {\n            "X-Server-id": 3,\n            "X-Server-status": "on",\n            "X-Server-balancer-addr": "$balancer_ip:$balancer_port"\n          }\n        },\n        "vars": [\n          [ "status","==",200 ]\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/headers"\n')),(0,r.kt)("p",null,"You should receive a ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'...\nX-Server-id: 3\nX-Server-status: on\nX-Server-balancer-addr: 50.237.103.220:80\n\n{"code":"ok","message":"new json body"}\n')),(0,r.kt)("h3",{id:"rewrite-header-with-regex-filter"},"Rewrite Header With RegEx Filter"),(0,r.kt)("p",null,"The following example demonstrates how to use RegEx filter matching to replace ",(0,r.kt)("inlineCode",{parentName:"p"},"X-Amzn-Trace-Id")," for responses."),(0,r.kt)("p",null,"Create a Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "response-rewrite-route",\n    "methods": ["GET"],\n    "uri": "/headers",\n    "plugins":{\n      "response-rewrite":{\n        "filters":[\n          {\n            "regex":"X-Amzn-Trace-Id",\n            "scope":"global",\n            "replace":"X-Amzn-Trace-Id-Replace"\n          }\n        ]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/headers"\n')),(0,r.kt)("p",null,"You should see a response similar to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'{\n  "headers": {\n    "Accept": "*/*",\n    "Host": "127.0.0.1",\n    "User-Agent": "curl/8.2.1",\n    "X-Amzn-Trace-Id-Replace": "Root=1-6500095d-1041b05e2ba9c6b37232dbc7",\n    "X-Forwarded-Host": "127.0.0.1"\n  }\n}\n')),(0,r.kt)("h3",{id:"decode-body-from-base64"},"Decode Body from Base64"),(0,r.kt)("p",null,"The following example demonstrates how to Decode Body from Base64 format."),(0,r.kt)("p",null,"Create a Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "response-rewrite-route",\n    "methods": ["GET"],\n    "uri": "/get",\n    "plugins":{\n      "response-rewrite": {\n        "body": "SGVsbG8gV29ybGQ=",\n        "body_base64": true\n        }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/get"\n')),(0,r.kt)("p",null,"You should see a response of the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Hello World\n")),(0,r.kt)("h3",{id:"rewrite-response-and-its-connection-with-execution-phases"},"Rewrite Response and Its Connection with Execution Phases"),(0,r.kt)("p",null,"The following example demonstrates the connection between the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin and ",(0,r.kt)("a",{parentName:"p",href:"/apisix/key-concepts/plugins#plugins-execution-lifecycle"},"execution phases")," by configuring the Plugin with the ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Plugin, and see how the response is still rewritten to ",(0,r.kt)("inlineCode",{parentName:"p"},"200 OK")," in the case of an unauthenticated request."),(0,r.kt)("p",null,"Create a Consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"jack"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "jack"\n  }\'\n')),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," credential for the Consumer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/jack/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-jack-key-auth",\n    "plugins": {\n      "key-auth": {\n        "key": "jack-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a Route with ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," to rewrite the response status code and body:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n   -H "X-API-KEY: ${admin_key}" \\\n   -d \'{\n    "id": "response-rewrite-route",\n    "uri": "/get",\n    "plugins": {\n      "key-auth": {},\n      "response-rewrite": {\n        "status_code": 200,\n        "body": "{\\"code\\": 200, \\"msg\\": \\"success\\"}"\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send a request to the Route with the valid key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"curl -i \"http://127.0.0.1:9080/get\" -H 'apikey: jack-key'\n")),(0,r.kt)("p",null,"You should receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response of the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'{"code": 200, "msg": "success"}\n')),(0,r.kt)("p",null,"Send a request to the Route without any key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/get"\n')),(0,r.kt)("p",null,"You should still receive an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response of the same, instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," from the ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Plugin. This shows that the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin still rewrites the response."),(0,r.kt)("p",null,"This is because ",(0,r.kt)("strong",{parentName:"p"},"header_filter")," and ",(0,r.kt)("strong",{parentName:"p"},"body_filter")," phase logics of the ",(0,r.kt)("inlineCode",{parentName:"p"},"response-rewrite")," Plugin will continue to run after ",(0,r.kt)("a",{parentName:"p",href:"https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/#ngxexit"},(0,r.kt)("inlineCode",{parentName:"a"},"ngx.exit"))," in the ",(0,r.kt)("strong",{parentName:"p"},"access")," or ",(0,r.kt)("strong",{parentName:"p"},"rewrite")," phases from other plugins."),(0,r.kt)("p",null,"The following table summarizes the impact of ",(0,r.kt)("inlineCode",{parentName:"p"},"ngx.exit")," on execution phases."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Phase"),(0,r.kt)("th",{parentName:"tr",align:null},"rewrite"),(0,r.kt)("th",{parentName:"tr",align:null},"access"),(0,r.kt)("th",{parentName:"tr",align:null},"header_filter"),(0,r.kt)("th",{parentName:"tr",align:null},"body_filter"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"rewrite")),(0,r.kt)("td",{parentName:"tr",align:null},"ngx.exit"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"access")),(0,r.kt)("td",{parentName:"tr",align:null},"\xd7"),(0,r.kt)("td",{parentName:"tr",align:null},"ngx.exit"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"header_filter")),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"ngx.exit"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"body_filter")),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\xd7"),(0,r.kt)("td",{parentName:"tr",align:null},"ngx.exit")))),(0,r.kt)("p",null,"For example, if ",(0,r.kt)("inlineCode",{parentName:"p"},"ngx.exit")," takes places in the ",(0,r.kt)("strong",{parentName:"p"},"rewrite")," phase, it will interrupt the execution of ",(0,r.kt)("strong",{parentName:"p"},"access")," phase but not interfere with ",(0,r.kt)("strong",{parentName:"p"},"header_filter")," and ",(0,r.kt)("strong",{parentName:"p"},"body_filter")," phases."))}d.isMDXComponent=!0}}]);