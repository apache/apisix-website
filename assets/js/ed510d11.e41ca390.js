"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[70467],{35318:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var r=n(27378);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=a,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||i;return n?r.createElement(m,o(o({ref:t},p),{},{components:n})):r.createElement(m,o({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},88009:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var r=n(25773),a=(n(27378),n(35318));const i={title:"Integrate API Gateway with Eureka",authors:[{name:"Yong Qian",title:"Author",url:"https://github.com/nic-6443",image_url:"https://avatars.githubusercontent.com/u/22141303?v=4"},{name:"Fei Han",title:"Technical Writer",url:"https://github.com/hf400159",image_url:"https://avatars.githubusercontent.com/u/97138894?v=4"}],keywords:["API Gateway","Apache APISIX","Eureka","Service Discovery","Servici Register"],description:"This article describes how to enable Eureka as a service discovery in the API gateway Apache APISIX and how to use diagnostic tools to find problems in the link.",tags:["Ecosystem"]},o=void 0,s={permalink:"/blog/2022/03/05/apisix-integration-eureka-service-discovery",source:"@site/blog/2022/03/05/apisix-integration-eureka-service-discovery.md",title:"Integrate API Gateway with Eureka",description:"This article describes how to enable Eureka as a service discovery in the API gateway Apache APISIX and how to use diagnostic tools to find problems in the link.",date:"2022-03-05T00:00:00.000Z",formattedDate:"March 5, 2022",tags:[{label:"Ecosystem",permalink:"/blog/tags/ecosystem"}],readingTime:6.375,truncated:!0,authors:[{name:"Yong Qian",title:"Author",url:"https://github.com/nic-6443",image_url:"https://avatars.githubusercontent.com/u/22141303?v=4",imageURL:"https://avatars.githubusercontent.com/u/22141303?v=4"},{name:"Fei Han",title:"Technical Writer",url:"https://github.com/hf400159",image_url:"https://avatars.githubusercontent.com/u/97138894?v=4",imageURL:"https://avatars.githubusercontent.com/u/97138894?v=4"}],prevItem:{title:"Biweekly Report (Mar 1st - Mar 14th)",permalink:"/blog/2022/03/24/weekly-report-0314"},nextItem:{title:"APISIX Integrates ClickHouse to Improve Log Efficiency",permalink:"/blog/2022/03/04/apigateway-clickhouse-makes-logging-easier"}},l={authorsImageUrls:[void 0,void 0]},c=[{value:"Preparation Phase",id:"preparation-phase",children:[],level:2},{value:"Eureka Server",id:"eureka-server",children:[{value:"Access the HTTP Service of Eureka Client",id:"access-the-http-service-of-eureka-client",children:[],level:3}],level:2},{value:"Proxying SpringCloud Applications using APISIX",id:"proxying-springcloud-applications-using-apisix",children:[{value:"Start Apache APISIX",id:"start-apache-apisix",children:[],level:3},{value:"Create and Configure a Route",id:"create-and-configure-a-route",children:[],level:3},{value:"Request Routing",id:"request-routing",children:[],level:3},{value:"Simulate Instance Downtime",id:"simulate-instance-downtime",children:[],level:3},{value:"Diagnostic Tools",id:"diagnostic-tools",children:[],level:3}],level:2},{value:"Summary",id:"summary",children:[],level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"This article describes how to enable Eureka as a service discovery in the API gateway Apache APISIX and how to use diagnostic tools to find problems in the link.")),(0,a.kt)("p",null,"In microservices architecture, large and complex systems are vertically divided into smaller subsystems based on function or business requirements, which exist as independently deployed sub-processes that communicate with each other through network calls. How these independently deployed services discover each other is the first problem to be solved, so there is often a centralized registry in microservice architectures."),(0,a.kt)("p",null,"As the most core development framework in the Java ecosystem, Spring continues to liberate the productivity of Java developers from Spring MVC to Spring Boot, and Spring Cloud is Spring's answer to the micro-service architecture in the Cloud native era."),(0,a.kt)("p",null,"In Spring Cloud, Eureka acts as a registry. Eureka is an open source Registry service written in the Java language by Netflix that plays a key role in Netflix's infrastructure."),(0,a.kt)("p",null,"Apache APISIX is a dynamic, real-time, high-performance API gateway that provides rich traffic management features such as load balancing, dynamic upstream, canary release, circuit breaking, authentication, observability, and more. As an industry-leading microservice gateway, Apache APISIX provides native support for Eureka. This article will use the Spring Cloud demo project as an example to show you the main functions and features of Apache APISIX docking Eureka service discovery."),(0,a.kt)("h2",{id:"preparation-phase"},"Preparation Phase"),(0,a.kt)("p",null,"This demonstration uses the official ",(0,a.kt)("a",{parentName:"p",href:"https://spring.io/projects/spring-cloud-netflix#overview"},(0,a.kt)("inlineCode",{parentName:"a"},"spring-cloud-netflix"))," tutorial provided by Spring as an example, which provides the Eureka Server started with SpringBoot as the registration center of Spring Cloud. We also use the same method to start the Eureka server for demonstration. Please visit  ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/spring-cloud-samples/eureka%EF%BC%8C"},(0,a.kt)("inlineCode",{parentName:"a"},"spring-cloud-samples/eureka"))," for the project address."),(0,a.kt)("p",null,"The following will introduce you to the relevant code and startup method."),(0,a.kt)("h2",{id:"eureka-server"},"Eureka Server"),(0,a.kt)("p",null,"Spring Cloud provides an ",(0,a.kt)("inlineCode",{parentName:"p"},"EnableEurekaServer")," annotation for Eureka, which can directly start an Eureka Server in the way of Spring Boot."),(0,a.kt)("p",null,"The code example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Java"},"@SpringBootApplication\n@EnableEurekaServer\npublic class EurekaApplication {\n        public static void main(String[] args) {\n                SpringApplication.run(EurekaApplication.class,args);\n        }\n}\n")),(0,a.kt)("p",null,"The startup method can directly refer to the following code:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Shell"},"git clone git@github.com:spring-cloud-samples/eureka.git\n# Execute in the project root directory\n./gradlew bootRun\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"application.yml")," file in the ",(0,a.kt)("inlineCode",{parentName:"p"},"resources")," directory defines the Eureka Server listening on port ",(0,a.kt)("inlineCode",{parentName:"p"},"8761"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-YAML"},"server:\n  port: 8761\n")),(0,a.kt)("h3",{id:"access-the-http-service-of-eureka-client"},"Access the HTTP Service of Eureka Client"),(0,a.kt)("p",null,"The client annotation corresponding to ",(0,a.kt)("inlineCode",{parentName:"p"},"EnableEurekaServer")," is ",(0,a.kt)("inlineCode",{parentName:"p"},"EnableEurekaClient"),". Using ",(0,a.kt)("inlineCode",{parentName:"p"},"EnableEurekaClient")," can easily register an HTTP application started with Spring Boot to Eureka."),(0,a.kt)("p",null,"The code example is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Java"},'@SpringBootApplication\n@EnableEurekaClient\n@RestController\npublic class Application {\n\n        @Value("${server.port}")\n        int serverPort;\n\n        @RequestMapping("/")\n        public String home() {\n                return String.format("server-%s"\uff0cserverPort);\n        }\n\n        public static void main(String[] args) {\n                new SpringApplicationBuilder(Application.class).web(WebApplicationType.SERVLET).run(args);\n        }\n\n}\n')),(0,a.kt)("p",null,"Here we expose an HTTP service on the ",(0,a.kt)("inlineCode",{parentName:"p"},"/")," path and return the port currently used by Spring Boot, so that we can use different configuration files to start multiple instances to demonstrate the effect of APISIX on load balancing the list of server instances registered with Eureka."),(0,a.kt)("p",null,"The configuration file is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-JAVA"},"spring.application.name=a-bootiful-client # will be used as the application name registered in Eureka\nserver.port=8080 # Modify Modify the listening port to start multiple instances\n")),(0,a.kt)("p",null,"Set the listening ports to ",(0,a.kt)("inlineCode",{parentName:"p"},"8080"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"8081"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"8082"),", and start three Spring Boot instances. After completion, use a browser to access port ",(0,a.kt)("inlineCode",{parentName:"p"},"8761")," of Eureka Server to view the results of service registration."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646350535070-7615a784-df05-4e94-a88e-b039c111de53.png",alt:"error/results example.png"})),(0,a.kt)("p",null,"You can see that three instances are registered under the application ",(0,a.kt)("inlineCode",{parentName:"p"},"A-BOOTIFUL-CLIENT"),", exposing ports ",(0,a.kt)("inlineCode",{parentName:"p"},"8080"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"8081"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"8082"),", and they are all in the UP state."),(0,a.kt)("h2",{id:"proxying-springcloud-applications-using-apisix"},"Proxying SpringCloud Applications using APISIX"),(0,a.kt)("p",null,"Next, we will implement the request chain as shown in the following figure:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1646350644536-7b68a4a3-b523-4c82-8e19-822624ff2c95.png",alt:"error/request link.png"})),(0,a.kt)("h3",{id:"start-apache-apisix"},"Start Apache APISIX"),(0,a.kt)("p",null,"First, you need to find ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix.discovery")," in the configuration file ",(0,a.kt)("inlineCode",{parentName:"p"},"config.yaml")," of Apache APISIX, modify the related configuration of Eureka Server connection information, and finally start APISIX."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-YAML"},'  discovery:                       # service discovery center\n      eureka:\n        host:                        # it\'s possible to define multiple eureka hosts addresses of the same eureka cluster.\n          - "http://172.23.79.129:8761" # Access address of Eureka Server started by Spring Boot\n        prefix: /eureka/\n        fetch_interval: 30           # default 30s\n        weight: 100                  # default weight for node\n        timeout:\n          connect: 2000              # default 2000ms\n          send: 2000                 # default 2000ms\n          read: 5000                 # default 5000ms\n\n')),(0,a.kt)("h3",{id:"create-and-configure-a-route"},"Create and Configure a Route"),(0,a.kt)("p",null,"Create a Route and enable the Eureka Service Discovery plugin in Upstream."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"upstream.discovery_type")," is ",(0,a.kt)("inlineCode",{parentName:"li"},"eureka"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"upstream.service_name")," is the application name ",(0,a.kt)("inlineCode",{parentName:"li"},"A-BOOTIFUL-CLIENT")," registered in Eureka.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Shell"},'curl http://172.30.45.72:9180/apisix/admin/routes/1 \\\n-H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -i -d \'\n    "uri": "/*"\uff0c\n    "host": "eureka-demo",\n    "upstream": {\n        "service_name": "A-BOOTIFUL-CLIENT",\n        "type": "roundrobin",\n        "discovery_type": "eureka"\n    }\n}\'\n')),(0,a.kt)("h3",{id:"request-routing"},"Request Routing"),(0,a.kt)("p",null,"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," command to make multiple requests to verify the load balance effect."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Shell"},'$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8081%\n$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8080%\n$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8082%\n$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8081%\n$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8080%\n$ curl http://172.30.45.72:9080/ -H "Host: eureka-demo"\nserver-8082%\n')),(0,a.kt)("p",null,"From the above returned results, you can see that requests are allocated to the three instances registered in Eureka in turn. This is because the load balancing algorithm we use is roundrobin, and all backend instances will be allocated requests in turn."),(0,a.kt)("h3",{id:"simulate-instance-downtime"},"Simulate Instance Downtime"),(0,a.kt)("p",null,"Stop the ",(0,a.kt)("inlineCode",{parentName:"p"},"8081")," instance, simulate the downtime of the instance, and observe the effect of the request."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Shell"},'$ while true; do curl http://172.30.45.72:9080/ -H "Host: eureka-demo"; echo; sleep 1; done\n\nserver-8080\nserver-8082\nserver-8081\n\nserver-8080\nserver-8082\nserver-8081\n\nserver-8080\nserver-8082\n\nserver-8080\nserver-8082\n')),(0,a.kt)("p",null,"It can be seen from the above results that after closing the ",(0,a.kt)("inlineCode",{parentName:"p"},"8081")," instance, Apache APISIX will synchronize to the latest instance list of Eureka in time, and then forward the request to the correct backend."),(0,a.kt)("h3",{id:"diagnostic-tools"},"Diagnostic Tools"),(0,a.kt)("p",null,"In microservice systems, unexpected forwarding problems are often encountered. The reasons for these problems may come from various links in service discovery, such as: client registration exception, registration center data exception, gateway reading registration data exception, etc., diagnostic tools that can be used in the link when an anomaly occurs will be particularly important."),(0,a.kt)("p",null,"Therefore, APISIX provides a diagnostic interface in the Service Discovery plugin, which can easily query the list of services currently being used by the gateway. Combined with the console of the registry, we can quickly diagnose the link from the gateway to the registry."),(0,a.kt)("p",null,"The diagnostic interface is exposed on port ",(0,a.kt)("inlineCode",{parentName:"p"},"9090")," of the loopback interface by default, and the access method is ",(0,a.kt)("inlineCode",{parentName:"p"},"GET /v1/discovery/{discovery_type}/dump"),", for example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Shell"},'curl http://localhost:9090/v1/discovery/eureka/dump\n\n{\n  "services": {\n    "A-BOOTIFUL-CLIENT": [\n      {\n        "weight": 100,\n        "metadata": {\n          "management.port": "8081"\n        },\n        "host": "192.168.50.164",\n        "port": 8081\n      },\n      {\n        "weight": 100,\n        "metadata": {\n          "management.port": "8080"\n        },\n        "host": "192.168.50.164",\n        "port": 8080\n      },\n      {\n        "weight": 100,\n        "metadata": {\n          "management.port": "8082"\n        },\n        "host": "192.168.50.164",\n        "port": 8082\n      }\n    ]\n  },\n  "config": {\n    "prefix": "\\/eureka\\/",\n    "timeout": {\n      "connect": 2000,\n      "send": 2000,\n      "read": 5000\n    },\n    "fetch_interval": 30,\n    "host": [\n      "http:\\/\\/172.23.79.129:8761"\n    ],\n    "weight": 100\n  }\n}\n')),(0,a.kt)("p",null,"In this way, the Eureka data that APISIX is using is queried."),(0,a.kt)("h2",{id:"summary"},"Summary"),(0,a.kt)("p",null,"Spring Cloud is a popular microservice framework, and Apache APISIX provides the ability to handle Spring Cloud application traffic by supporting Eureka Service Discovery. We can see that the close integration of these two ecosystems makes the implementation of the microservice architecture change. It is simpler and more efficient, so that business development can focus more on business value."),(0,a.kt)("p",null,"For more instructions and complete configuration information about the ",(0,a.kt)("inlineCode",{parentName:"p"},"eureka")," plugin, please refer to the ",(0,a.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/discovery/eureka/"},"Apache APISIX official documentation"),"."),(0,a.kt)("p",null,"Apache APISIX is also currently working on additional plugins to support the integration of additional services, so if you are interested, feel free to start a discussion in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/discussions"},"GitHub Discussion"),", or via the ",(0,a.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/general/join"},"mailing list")," to communicate."))}u.isMDXComponent=!0}}]);