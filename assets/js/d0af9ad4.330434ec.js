"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[43214],{35318:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>d});var n=a(27378);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=u(a),d=i,m=h["".concat(l,".").concat(d)]||h[d]||p[d]||r;return a?n.createElement(m,o(o({ref:t},c),{},{components:a})):n.createElement(m,o({ref:t},c))}));function d(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var u=2;u<r;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},58069:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>u});var n=a(25773),i=(a(27378),a(35318));const r={title:"HashiCorp Vault Secure Storage Backend in Apache APISIX Ecosystem",authors:[{name:"Bisakh Mondal",title:"Author",url:"https://github.com/bisakhmondal",image_url:"https://avatars.githubusercontent.com/u/41498427?v=4"},{name:"Yilin Zeng",title:"Technical Writer",url:"https://github.com/yzeng25",image_url:"https://avatars.githubusercontent.com/u/36651058?v=4"}],keywords:["Apache APISIX","HashiCorp","Vault","jwt-auth","authentication"],description:"This article describe the upcoming release of the Vault with Apache APISIX integration, and show the details of configuration.",tags:["Authentication","Ecosystem","Plugins"],image:"https://static.apiseven.com/2022/blog/0818/plugins/vault.png"},o=void 0,s={permalink:"/blog/2022/01/21/apisix-hashicorp-vault-integration",source:"@site/blog/2022/01/21/apisix-hashicorp-vault-integration.md",title:"HashiCorp Vault Secure Storage Backend in Apache APISIX Ecosystem",description:"This article describe the upcoming release of the Vault with Apache APISIX integration, and show the details of configuration.",date:"2022-01-21T00:00:00.000Z",formattedDate:"January 21, 2022",tags:[{label:"Authentication",permalink:"/blog/tags/authentication"},{label:"Ecosystem",permalink:"/blog/tags/ecosystem"},{label:"Plugins",permalink:"/blog/tags/plugins"}],readingTime:12.245,truncated:!0,authors:[{name:"Bisakh Mondal",title:"Author",url:"https://github.com/bisakhmondal",image_url:"https://avatars.githubusercontent.com/u/41498427?v=4",imageURL:"https://avatars.githubusercontent.com/u/41498427?v=4"},{name:"Yilin Zeng",title:"Technical Writer",url:"https://github.com/yzeng25",image_url:"https://avatars.githubusercontent.com/u/36651058?v=4",imageURL:"https://avatars.githubusercontent.com/u/36651058?v=4"}],prevItem:{title:"Webinar | APISIX in QingCloud! ",permalink:"/blog/2022/01/24/apisix-with-qingcloud-meetup"},nextItem:{title:"Get More Details About xRPC",permalink:"/blog/2022/01/21/apisix-xrpc-details-and-miltilingual"}},l={authorsImageUrls:[void 0,void 0]},u=[{value:"What is Vault",id:"what-is-vault",children:[],level:2},{value:"About APISIX jwt-auth Plugin",id:"about-apisix-jwt-auth-plugin",children:[],level:2},{value:"Steps to Use Vault with Apache APISIX",id:"steps-to-use-vault-with-apache-apisix",children:[{value:"Configure Vault",id:"configure-vault",children:[{value:"Step 1: Spin Up a Vault Server",id:"step-1-spin-up-a-vault-server",children:[],level:4},{value:"Step 2: Generate a Vault Access Token for APISIX",id:"step-2-generate-a-vault-access-token-for-apisix",children:[],level:4}],level:3},{value:"Adding vault configuration into Apache APISIX",id:"adding-vault-configuration-into-apache-apisix",children:[],level:3},{value:"Create an APISIX Consumer",id:"create-an-apisix-consumer",children:[{value:"Set Up a Test Upstream Server",id:"set-up-a-test-upstream-server",children:[],level:4},{value:"Create an APISIX Route with Authentication Enabled",id:"create-an-apisix-route-with-authentication-enabled",children:[],level:4},{value:"Generate Token from jwt-auth Plugin",id:"generate-token-from-jwt-auth-plugin",children:[],level:4},{value:"Request APISIX Server",id:"request-apisix-server",children:[],level:4}],level:3},{value:"Different Use Cases Where Vault Can be Integrated with APISIX jwt-auth plugin",id:"different-use-cases-where-vault-can-be-integrated-with-apisix-jwt-auth-plugin",children:[],level:3},{value:"Disable Vault from Plugin",id:"disable-vault-from-plugin",children:[],level:3}],level:2},{value:"Summary",id:"summary",children:[],level:2},{value:"Reference",id:"reference",children:[],level:2}],c={toc:u};function p(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This article describe the upcoming release of the Vault with Apache APISIX integration, and show the details of configuration.")),(0,i.kt)("p",null,"With the rise of microservice-based architecture, keeping things secure has become much more challenging than earlier. We are far beyond the point where our 100 instances of backend servers are accessing our database server with a single static secret credential because if in case of a credential leakage the whole system is compromised and revocation of that credential causes a massive service outage (now no one can access anything unless the instances are reconfigured). We can't eliminate the possibility of a security breach because sometimes unexpected does happen. Instead, it's totally up to us to control the blast radius in these situations. To tackle scenarios like this, a popular solution like ",(0,i.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/"},"HashiCorp Vault")," comes into the picture in a production environment to act as an identity-based secrets and encryption management system. In this article, I have demonstrated how to integrate Vault with Apache APISIX (a cloud-native API Gateway) ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/jwt-auth"},"jwt-auth plugin")," to effectively use excellence from both worlds."),(0,i.kt)("h2",{id:"what-is-vault"},"What is Vault"),(0,i.kt)("p",null,"HashiCorp Vault is designed to help organizations manage access to secrets and transmit them safely within an organization. Secrets are defined as any form of sensitive credentials that need to be tightly controlled and monitored and can be used to unlock sensitive information. Secrets could be in the form of passwords, API keys, SSH keys, RSA tokens, or OTP. In the real world where it is very common to have a secret sprawl where secrets get stored into the config file or as a variable in actual program code which as a consequence sometimes even end up in a version control system like GitHub, BitBucket or GitLab, possess a major threat in security. Vault solves this problem by centralizing secrets. It provides encrypted storage for static secrets, generation of dynamic secrets with a TTL lease, authentication of users (machines or humans) to make sure they\u2019re authorized to access a particular secret and many more. So that even in case of a security breach the blast radius is much small and contained."),(0,i.kt)("p",null,"Vault makes it very easy to control and manage access by providing us with a unilateral interface to manage every secret in your infrastructure. Not only that, it also provides the flexibility to create detailed audit logs and keep track of who accessed what."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.apiseven.com/202108/1642770417379-a91960a5-5aac-45fa-9277-801a4ee2afc6.png",alt:"HashiCorp Vault"})),(0,i.kt)("h2",{id:"about-apisix-jwt-auth-plugin"},"About APISIX jwt-auth Plugin"),(0,i.kt)("p",null,"It is an authentication plugin that can be attached to any APISIX route to perform JWT (JSON web token, ",(0,i.kt)("a",{parentName:"p",href:"https://jwt.io/introduction"},"read more"),") authentication before the request gets forwarded to the upstream URI. In short, it is a secure authentication mechanism that leads to authorization to critical resources. Typically, a private key, or a text secret, is used by the issuer to sign the JWT. The receiver of the JWT will verify the signature to ensure that the token hasn\u2019t been altered after it was signed by the issuer. The total integrity of the whole jwt mechanism depends on the signing secret (may it be a text secret of RSA keypairs). That makes it difficult for unauthenticated sources to guess the signing key and attempt to change the claims within the JWT."),(0,i.kt)("p",null,"So the storage of these keys in a secure environment is extremely crucial. Falling into wrong hands may jeopardize the security of the whole infrastructure. Though we from the APISIX side take all the means to follow standard SecOps practices, it's quite natural in the production environment to have a centralized key management solution like HashiCorp vault to have elaborate audit trails, periodic key rotation, key revocation etc. And it would be quite a troublesome issue if each time you have to update Apache APISIX configuration whenever a key rotation occurs throughout the infrastructure."),(0,i.kt)("h2",{id:"steps-to-use-vault-with-apache-apisix"},"Steps to Use Vault with Apache APISIX"),(0,i.kt)("p",null,"For integration with Vault, Apache APISIX needs to be loaded with vault configuration at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/conf/config.yaml"},"config.yaml"),"."),(0,i.kt)("p",null,"Internally, APISIX communicates with vault server ",(0,i.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/secrets/kv/kv-v1"},"KV secret engine v1")," HTTP ",(0,i.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/api/secret/kv/kv-v1"},"APIs"),". As most enterprise solution prefers to stick with KV Secrets Engine - Version 1 in their production environment, during the initial phase of APISIX-Vault support we have gone with version 1 only. In later releases, we will add the support of K/V version 2."),(0,i.kt)("p",null,"The main idea of using vault, instead of the APISIX etcd backend is the security concern in a low trust environment. We, the APISIX developers, understand your priorities seriously. That's why we recommend using vault access tokens that are short scoped and can grant APISIX server limited access."),(0,i.kt)("h3",{id:"configure-vault"},"Configure Vault"),(0,i.kt)("p",null,"If you have already a Vault instance running with the necessary privileges, feel free to skip this section. This section shares the best practices to use Vault inside the Apache APISIX ecosystem. Please follow the steps mentioned below."),(0,i.kt)("h4",{id:"step-1-spin-up-a-vault-server"},"Step 1: Spin Up a Vault Server"),(0,i.kt)("p",null,"Here you have multiple options, feel free to choose between docker, precompiled binary or building from source. As to communicate with the vault server, you need a vault CLI client, I would prefer going with precompiled binary instead of the Docker approach. Anyway, it's totally up to you (feel free to consult ",(0,i.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/install"},"Vault's official installation docs"),"). To spin up a development server, please run the following command."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vault server -dev -dev-root-token-id=root\n\u2026\nWARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory\nand starts unsealed with a single unseal key. The root token is already\nauthenticated to the CLI, so you can immediately begin using Vault.\nYou may need to set the following environment variable:\nexport VAULT_ADDR='http://127.0.0.1:8200'\nThe unseal key and root token are displayed below in case you want to\nseal/unseal the Vault or re-authenticate.\nUnseal Key: 12hURx2eDPKK1tzK+8TkgH9pPhPNJFpyfc/imCLgJKY=\nRoot Token: root\nDevelopment mode should NOT be used in production installations!\n")),(0,i.kt)("p",null,"Set your current CLI with the correct environment variables."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ export VAULT_ADDR='http://127.0.0.1:8200'\n$ export VAULT_TOKEN='root'\n")),(0,i.kt)("p",null,"Enable vault k/v version 1 secret engine backend with a suitable path prefix. In this demo, we are going to choose the ",(0,i.kt)("inlineCode",{parentName:"p"},"kv")," path so that we don't have a collision with the vault default secret path for kv version 2."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vault secrets enable -path=kv -version=1 kv\nSuccess! Enabled the kv secrets engine at: kv/\n\n\n# To reconfirm the status, run\n$ vault secrets list\nPath          Type         Accessor              Description\n----          ----         --------              -----------\ncubbyhole/    cubbyhole    cubbyhole_4eeb394c    per-token private secret storage\nidentity/     identity     identity_5ca6201e     identity store\nkv/           kv           kv_92cd6d37           n/a\nsecret/       kv           kv_6dd46a53           key/value secret storage\nsys/          system       system_2045ddb1       system endpoints used for control, policy and debugging\n")),(0,i.kt)("h4",{id:"step-2-generate-a-vault-access-token-for-apisix"},"Step 2: Generate a Vault Access Token for APISIX"),(0,i.kt)("p",null,"This article is regarding using vault in ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," plugin perspective. So, for an APISIX consumer (if you are unfamiliar with consumers in the APISIX ecosystem, please read the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/terminology/consumer"},"document about Apache APISIX Consumer"),") with username ",(0,i.kt)("inlineCode",{parentName:"p"},"jack")," the ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," plugin looks up (if enabled with vault configuration) for secret/s at ",(0,i.kt)("inlineCode",{parentName:"p"},"<vault.prefix inside config.yaml>/consumer/<consumer.username>/jwt-auth")," into vault kv storage. In this context, if you are assigning ",(0,i.kt)("inlineCode",{parentName:"p"},"kv/apisix")," namespace (vault path) as ",(0,i.kt)("inlineCode",{parentName:"p"},"vault.prefix")," inside config.yaml for all apisix related data retrieval, we suggest you to create a policy for path ",(0,i.kt)("inlineCode",{parentName:"p"},"kv/apisix/consumer/*"),". The extra asterisk (*) at the end ensure the policy allows read for any path that has a ",(0,i.kt)("inlineCode",{parentName:"p"},"kv/apisix/consumer")," prefix."),(0,i.kt)("p",null,"Create a policy file in HashiCorp Configuration Language (HCL)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ tee apisix-policy.hcl << EOF\npath "kv/apisix/consumer/*" {\n    capabilities = ["read"]\n}\nEOF\n')),(0,i.kt)("p",null,"Applying the policy into vault instance."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ vault policy write apisix-policy apisix-policy.hcl\n\nSuccess! Uploaded policy: apisix-policy\n")),(0,i.kt)("p",null,"Generate a token with the newly defined policy that has been configured with the small access boundary."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ vault token create -policy="apisix-policy"\n\n\nKey                  Value\n---                  -----\ntoken                s.KUWFVhIXgoRuQbbp3j1eMVGa\ntoken_accessor       nPXT3q0mfZkLmhshfioOyx8L\ntoken_duration       768h\ntoken_renewable      true\ntoken_policies       ["apisix-policy" "default"]\nidentity_policies    []\npolicies             ["apisix-policy" "default"]\n')),(0,i.kt)("p",null,"In this demonstration ",(0,i.kt)("inlineCode",{parentName:"p"},"s.KUWFVhIXgoRuQbbp3j1eMVGa")," is your access token."),(0,i.kt)("h3",{id:"adding-vault-configuration-into-apache-apisix"},"Adding vault configuration into Apache APISIX"),(0,i.kt)("p",null,"As discussed earlier, Apache APISIX communicates with Vault instance through Vault HTTP APIs. The necessary configuration must be added into ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/blob/master/conf/config.yaml"},"config.yaml"),".\nHere is the brief information about different fields that you can use:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"host: The host address where the vault server is running."),(0,i.kt)("li",{parentName:"ul"},"timeout: HTTP timeout for each request."),(0,i.kt)("li",{parentName:"ul"},"token: The generated token from vault instance that can grant access to read data from the vault."),(0,i.kt)("li",{parentName:"ul"},"prefix: enabling a prefix allows you to better enforcement of policies, generate limited scoped tokens and tightly control the data that can be accessed from APISIX. Valid prefixes are (",(0,i.kt)("inlineCode",{parentName:"li"},"kv/apisix"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"secret")," etc.)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"vault:\n  host: 'http://0.0.0.0:8200'\n  timeout: 10\n  token: 's.KUWFVhIXgoRuQbbp3j1eMVGa'\n  prefix: 'kv/apisix'\n")),(0,i.kt)("h3",{id:"create-an-apisix-consumer"},"Create an APISIX Consumer"),(0,i.kt)("p",null,"APISIX has a consumer-level abstraction that goes side by side with authentication scenarios. To enable authentication for any APISIX route, a consumer is needed with a suitable configuration for that specific type of authentication service. Then only APISIX can forward the request to the upstream URI by successfully performing authentication wrt. the consumer configuration. APISIX consumer has two fields - one is ",(0,i.kt)("inlineCode",{parentName:"p"},"username")," (required) to identify one consumer from the others and another is ",(0,i.kt)("inlineCode",{parentName:"p"},"plugins")," that holds the consumer specific plugin configurations."),(0,i.kt)("p",null,"Here, in this article, we will create a consumer with ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," plugin. It performs JWT authentication for the respective route/s or service/s."),(0,i.kt)("p",null,"To enable ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," with vault configuration, make a request to:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/consumers -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "username": "jack",\n    "plugins": {\n        "jwt-auth": {\n            "key": "test-key",\n            "vault": {}\n        }\n    }\n}\'\n')),(0,i.kt)("p",null,"Here the plugin looks up for key secret inside vault path (",(0,i.kt)("inlineCode",{parentName:"p"},"<vault.prefix from conf.yaml>/consumer/jack/jwt-auth"),") for consumer ",(0,i.kt)("inlineCode",{parentName:"p"},"jack")," mentioned in the consumer config and uses it for subsequent signing and jwt verification. If the key is not found in the same path, the plugin logs error and fails to perform jwt authentication."),(0,i.kt)("h4",{id:"set-up-a-test-upstream-server"},"Set Up a Test Upstream Server"),(0,i.kt)("p",null,"To test the behaviour, you can create a route for an upstream (a simple ping handler that returns pong). You can set it up with a plain go HTTP-Server."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'// simple upstream server\npackage main\n\n\nimport "net/http"\n\n\nfunc ping(w http.ResponseWriter, req *http.Request) {\n    w.Write([]byte("secure/pong\\n"))\n}\n\n\nfunc main() {\n    http.HandleFunc("/secure/ping", ping)\n    http.ListenAndServe(":9999", nil)\n}\n')),(0,i.kt)("h4",{id:"create-an-apisix-route-with-authentication-enabled"},"Create an APISIX Route with Authentication Enabled"),(0,i.kt)("p",null,"Create an APISIX route with this secure ping HTTP server and ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," authentication plugin enabled."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/routes/1 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "jwt-auth": {}\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:9999": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/secure/ping"\n}\'\n')),(0,i.kt)("h4",{id:"generate-token-from-jwt-auth-plugin"},"Generate Token from jwt-auth Plugin"),(0,i.kt)("p",null,"Now sign a jwt secret from APISIX that can be used and passed for making requests to the ",(0,i.kt)("inlineCode",{parentName:"p"},"http://localhost:9080/secure/ping")," proxy route to the APISIX server."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl http://127.0.0.1:9080/apisix/plugin/jwt/sign\\?key\\=test-key -i\nHTTP/1.1 200 OK\nDate: Tue, 18 Jan 2022 07:50:57 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/2.11.0\n\n\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJ0ZXN0LWtleSIsImV4cCI6MTY0MjU3ODY1N30.nkyev1_KUapVgY_QVYETsSApA6gEkDWS8tsHFV1EpD8\n")),(0,i.kt)("p",null,"In the previous step, if you see something like the ",(0,i.kt)("inlineCode",{parentName:"p"},"failed to sign jwt")," message please make sure you have a secret key stored into vault ",(0,i.kt)("inlineCode",{parentName:"p"},"kv/apisix/consumers/jack/jwt-auth")," path."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"# example\n$ vault kv put kv/apisix/consumer/jack/jwt-auth secret=$ecr3t-c0d3\nSuccess! Data written to: kv/apisix/consumer/jack/jwt-auth\n")),(0,i.kt)("h4",{id:"request-apisix-server"},"Request APISIX Server"),(0,i.kt)("p",null,"Now, make a request to the APISIX proxy for route ",(0,i.kt)("inlineCode",{parentName:"p"},"/secure/ping"),". Upon successful validation, it will forward the request to our go HTTP server."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl http://127.0.0.1:9080/secure/ping -H 'Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJ0ZXN0LWtleSIsImV4cCI6MTY0MjU3ODU5M30.IYudBr7FTgRme70u4rEBoYNtGmGByzgfGlt8hctI__Q' -i\nHTTP/1.1 200 OK\nContent-Type: text/plain; charset=utf-8\nContent-Length: 12\nConnection: keep-alive\nDate: Tue, 18 Jan 2022 08:00:04 GMT\nServer: APISIX/2.11.0\n\n\nsecure/pong\n")),(0,i.kt)("p",null,"Any request without a valid jwt will throw an ",(0,i.kt)("inlineCode",{parentName:"p"},"HTTP 401 Unauthorized")," error."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/secure/ping -i\nHTTP/1.1 401 Unauthorized\nDate: Tue, 18 Jan 2022 08:00:33 GMT\nContent-Type: text/plain; charset=utf-8\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX/2.11.0\n\n\n{"message":"Missing JWT token in request"}\n')),(0,i.kt)("h3",{id:"different-use-cases-where-vault-can-be-integrated-with-apisix-jwt-auth-plugin"},"Different Use Cases Where Vault Can be Integrated with APISIX jwt-auth plugin"),(0,i.kt)("p",null,"Apache APISIX ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," plugin can be configured to fetch simple text secret keys as well as RS256 public-private key pairs from vault storage."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"For the early version of this integration support, the plugin expects the key name of secrets stored into the vault path is among ","[ ",(0,i.kt)("inlineCode",{parentName:"p"},"secret"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"public_key"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"private_key"),"]"," to successfully use the key. In future releases, we are going to add the support of referencing custom-named keys."))),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"You have stored HS256 signing secret inside the vault and you want to use it for jwt signing and verification."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/consumers -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n {\n     "username": "jack",\n     "plugins": {\n         "jwt-auth": {\n             "key": "key-1",\n             "vault": {}\n         }\n     }\n }\'\n')),(0,i.kt)("p",{parentName:"li"},"Here the plugin looks up for key ",(0,i.kt)("inlineCode",{parentName:"p"},"secret")," inside vault path (",(0,i.kt)("inlineCode",{parentName:"p"},"<vault.prefix from conf.yaml>/consumer/jack/jwt-auth"),") for consumer jack mentioned in the consumer config and uses it for subsequent signing and jwt verification. If the key is not found in the same path, the plugin logs an error and fails to perform jwt authentication.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"RS256 RSA keypairs, both public and private keys are stored in the vault."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/consumers -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n {\n     "username": "jim",\n     "plugins": {\n         "jwt-auth": {\n             "key": "rsa-keypair",\n             "algorithm": "RS256",\n             "vault": {}\n         }\n     }\n }\'\n')),(0,i.kt)("p",{parentName:"li"},"The plugin looks up for ",(0,i.kt)("inlineCode",{parentName:"p"},"public_key")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"private_key")," keys inside vault kv path (",(0,i.kt)("inlineCode",{parentName:"p"},"<vault.prefix from conf.yaml>/consumer/jim/jwt-auth"),") for ",(0,i.kt)("inlineCode",{parentName:"p"},"jim")," mentioned inside plugin vault configuration. If not found, authentication fails."),(0,i.kt)("p",{parentName:"li"},"If you are unsure, how to store public and private keys into vault kv storage, use this command"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'# provided, your current directory contains the files named "public.pem" and "private.pem"\n $ vault kv put kv/apisix/consumer/jim/jwt-auth public_key=@public.pem private_key=@private.pem\n Success! Data written to: kv/apisix/consumer/jim/jwt-auth\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Public key in consumer configuration, while the private key is in the vault."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/consumers -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n {\n     "username": "john",\n     "plugins": {\n         "jwt-auth": {\n             "key": "user-key",\n             "algorithm": "RS256",\n             "public_key": "-----BEGIN PUBLIC KEY-----\\n\u2026\u2026\\n-----END PUBLIC KEY-----"\n             "vault": {}\n         }\n     }\n }\'\n')),(0,i.kt)("p",{parentName:"li"},"This plugin uses RSA public key from consumer configuration and uses the private key directly fetched from the vault."))),(0,i.kt)("h3",{id:"disable-vault-from-plugin"},"Disable Vault from Plugin"),(0,i.kt)("p",null,"Now, to disable the vault lookup from the ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," plugin simply remove the empty vault object from the consumer plugin configuration (in this case it is ",(0,i.kt)("inlineCode",{parentName:"p"},"jack"),"). This will make the jwt plugin to lookup signing secrets (both HS256/HS512 or RS512 keypairs) into plugin configuration for subsequent requests to the URI route where the ",(0,i.kt)("inlineCode",{parentName:"p"},"jwt-auth")," configuration has been enabled. Even if you have vault configuration enabled in APISIX ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," no request will be sent to the vault server."),(0,i.kt)("p",null,"APISIX plugins are hot-reloaded, therefore is no need to restart APISIX."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'$ curl http://127.0.0.1:9080/apisix/admin/consumers -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "username": "jack",\n    "plugins": {\n        "jwt-auth": {\n            "key": "test-key",\n            "secret": "my-secret-key"\n        }\n    }\n}\'\n')),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"This article brings you the upcoming release of the Vault-Apache APISIX integration and related details."),(0,i.kt)("p",null,"Feel free to start a discussion in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/apache/apisix/discussions"},"GitHub Discussions")," or communicate via the ",(0,i.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/general/join"},"mailing list"),"."),(0,i.kt)("h2",{id:"reference"},"Reference"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://blog.bisakh.com/blog/vault-apisix-jwt-auth"},"Bisakh's Blog")))}p.isMDXComponent=!0}}]);