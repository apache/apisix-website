"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[39809],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=i.createContext({}),c=function(e){var t=i.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=c(e.components);return i.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),h=a,m=u["".concat(o,".").concat(h)]||u[h]||d[h]||l;return n?i.createElement(m,r(r({ref:t},p),{},{components:n})):i.createElement(m,r({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,r=new Array(l);r[0]=u;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<l;c++)r[c]=n[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},41317:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>r,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>o});var i=n(87462),a=(n(67294),n(3905));const l={title:"Set Up SSO with Keycloak (OIDC)",keywords:["APISIX","API Gateway","OIDC","Keycloak"],description:"This article describes how to integrate APISIX with Keycloak using the authorization code grant, client credentials grant, and password grant, using the openid-connect Plugin."},r=void 0,s={unversionedId:"tutorials/keycloak-oidc",id:"version-3.14/tutorials/keycloak-oidc",isDocsHomePage:!1,title:"Set Up SSO with Keycloak (OIDC)",description:"This article describes how to integrate APISIX with Keycloak using the authorization code grant, client credentials grant, and password grant, using the openid-connect Plugin.",source:"@site/docs-apisix_versioned_docs/version-3.14/tutorials/keycloak-oidc.md",sourceDirName:"tutorials",slug:"/tutorials/keycloak-oidc",permalink:"/docs/apisix/tutorials/keycloak-oidc",editUrl:"/edit#https://github.com/apache/apisix/edit/release/3.14/docs/en/latest/tutorials/keycloak-oidc.md",tags:[],version:"3.14",frontMatter:{title:"Set Up SSO with Keycloak (OIDC)",keywords:["APISIX","API Gateway","OIDC","Keycloak"],description:"This article describes how to integrate APISIX with Keycloak using the authorization code grant, client credentials grant, and password grant, using the openid-connect Plugin."},sidebar:"version-3.14/docs",previous:{title:"WebSocket Authentication",permalink:"/docs/apisix/tutorials/websocket-authentication"},next:{title:"API Gateway",permalink:"/docs/apisix/terminology/api-gateway"}},o=[{value:"Configure Keycloak",id:"configure-keycloak",children:[{value:"Create a Realm",id:"create-a-realm",children:[]},{value:"Create a Client",id:"create-a-client",children:[]},{value:"Create a User",id:"create-a-user",children:[]}]},{value:"Obtain the OIDC Configuration",id:"obtain-the-oidc-configuration",children:[{value:"Get Discovery Endpoint",id:"get-discovery-endpoint",children:[]},{value:"Get Client ID and Secret",id:"get-client-id-and-secret",children:[]}]},{value:"Implement Authorization Code Grant",id:"implement-authorization-code-grant",children:[{value:"Verify with Valid Credentials",id:"verify-with-valid-credentials",children:[]},{value:"Verify with Invalid Credentials",id:"verify-with-invalid-credentials",children:[]}]},{value:"Implement Client Credentials Grant",id:"implement-client-credentials-grant",children:[{value:"Verify With Valid Access Token",id:"verify-with-valid-access-token",children:[]},{value:"Verify With Invalid Access Token",id:"verify-with-invalid-access-token",children:[]},{value:"Verify without Access Token",id:"verify-without-access-token",children:[]}]},{value:"Implement Password Grant",id:"implement-password-grant",children:[{value:"Verify With Valid Access Token",id:"verify-with-valid-access-token-1",children:[]},{value:"Verify With Invalid Access Token",id:"verify-with-invalid-access-token-1",children:[]},{value:"Verify without Access Token",id:"verify-without-access-token-1",children:[]},{value:"Refresh Token",id:"refresh-token",children:[]}]}],c={toc:o};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://openid.net/connect/"},"OpenID Connect (OIDC)")," is a simple identity layer on top of the ",(0,a.kt)("a",{parentName:"p",href:"https://www.rfc-editor.org/rfc/rfc6749"},"OAuth 2.0 protocol"),". It allows clients to verify the identity of end users based on the authentication performed by the identity provider, as well as to obtain basic profile information about end users in an interoperable and REST-like manner. With APISIX and ",(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/"},"Keycloak"),", you can implement OIDC-based authentication processes to protect your APIs and enable single sign-on (SSO)."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/"},"Keycloak")," is an open-source identity and access management solution for modern applications and services. Keycloak supports single sign-on (SSO), which enables services to interface with Keycloak through protocols such as OIDC and OAuth 2.0. In addition, Keycloak also supports delegating authentication to third party identity providers such as Facebook and Google."),(0,a.kt)("p",null,"This tutorial will show you how to integrate APISIX with Keycloak using ",(0,a.kt)("a",{parentName:"p",href:"#implement-authorization-code-grant"},"authorization code grant"),", ",(0,a.kt)("a",{parentName:"p",href:"#implement-client-credentials-grant"},"client credentials grant"),", and ",(0,a.kt)("a",{parentName:"p",href:"#implement-password-grant"},"password grant"),", using the ",(0,a.kt)("a",{parentName:"p",href:"/hub/openid-connect"},(0,a.kt)("inlineCode",{parentName:"a"},"openid-connect"))," Plugin."),(0,a.kt)("h2",{id:"configure-keycloak"},"Configure Keycloak"),(0,a.kt)("p",null,"Start a Keycloak instance named ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix-quickstart-keycloak")," with the administrator name ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-admin")," and password ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-admin-pass")," in ",(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/server/configuration#_starting_keycloak_in_development_mode"},"development mode")," in Docker. The exposed port is mapped to ",(0,a.kt)("inlineCode",{parentName:"p"},"8080")," on the host machine:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"docker run -d --name \"apisix-quickstart-keycloak\" \\\n  -e 'KEYCLOAK_ADMIN=quickstart-admin' \\\n  -e 'KEYCLOAK_ADMIN_PASSWORD=quickstart-admin-pass' \\\n  -p 8080:8080 \\\n  quay.io/keycloak/keycloak:18.0.2 start-dev\n")),(0,a.kt)("p",null,"Keycloak provides an easy-to-use web UI to help the administrator manage all resources, such as clients, roles, and users."),(0,a.kt)("p",null,"Navigate to ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:8080")," in browser to access the Keycloak web page, then click ",(0,a.kt)("strong",{parentName:"p"},"Administration Console"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/ItcwYPIx_web-ui.png",alt:"web-ui"})),(0,a.kt)("p",null,"Enter the administrator\u2019s username ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-admin")," and password ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-admin-pass")," and sign in:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/6W3pjzE1_admin-signin.png",alt:"admin-signin"})),(0,a.kt)("p",null,"You need to maintain the login status to configure Keycloak during the following steps."),(0,a.kt)("h3",{id:"create-a-realm"},"Create a Realm"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Realms")," in Keycloak are workspaces to manage resources such as users, credentials, and roles. The resources in different realms are isolated from each other. You need to create a realm named ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-realm")," for APISIX."),(0,a.kt)("p",null,"In the left menu, hover over ",(0,a.kt)("strong",{parentName:"p"},"Master"),", and select ",(0,a.kt)("strong",{parentName:"p"},"Add realm")," in the dropdown:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/S1Xvqliv_create-realm.png",alt:"create-realm"})),(0,a.kt)("p",null,"Enter the realm name ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-realm")," and click ",(0,a.kt)("strong",{parentName:"p"},"Create")," to create it:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/jwb7QU8k_add-realm.png",alt:"add-realm"})),(0,a.kt)("h3",{id:"create-a-client"},"Create a Client"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Clients")," in Keycloak are entities that request Keycloak to authenticate a user. More often, clients are applications that want to use Keycloak to secure themselves and provide a single sign-on solution. APISIX is equivalent to a client that is responsible for initiating authentication requests to Keycloak, so you need to create its corresponding client named ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix-quickstart-client"),"."),(0,a.kt)("p",null,"Click ",(0,a.kt)("strong",{parentName:"p"},"Clients")," > ",(0,a.kt)("strong",{parentName:"p"},"Create")," to open the ",(0,a.kt)("strong",{parentName:"p"},"Add Client")," page:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/qLom0axN_create-client.png",alt:"create-client"})),(0,a.kt)("p",null,"Enter ",(0,a.kt)("strong",{parentName:"p"},"Client ID")," as ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix-quickstart-client"),", then select ",(0,a.kt)("strong",{parentName:"p"},"Client Protocol")," as ",(0,a.kt)("inlineCode",{parentName:"p"},"openid-connect")," and ",(0,a.kt)("strong",{parentName:"p"},"Save"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/X5on2r7x_add-client.png",alt:"add-client"})),(0,a.kt)("p",null,"The client ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix-quickstart-client")," is created. After redirecting to the detailed page, select ",(0,a.kt)("inlineCode",{parentName:"p"},"confidential")," as the ",(0,a.kt)("strong",{parentName:"p"},"Access Type"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/v70c8y9F_config-client.png",alt:"config-client"})),(0,a.kt)("p",null,"When the user login is successful during the SSO, Keycloak will carry the state and code to redirect the client to the addresses in ",(0,a.kt)("strong",{parentName:"p"},"Valid Redirect URIs"),". To simplify the operation, enter wildcard ",(0,a.kt)("inlineCode",{parentName:"p"},"*")," to consider any URI valid:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/xLxcyVkn_client-redirect.png",alt:"client-redirect"})),(0,a.kt)("p",null,"If you are implementing the ",(0,a.kt)("a",{parentName:"p",href:"#implement-authorization-code-grant"},"authorization code grant with PKCE"),", configure the PKCE challenge method in the client's advanced settings:"),(0,a.kt)("div",{style:{textAlign:"center"}},(0,a.kt)("img",{src:"https://static.api7.ai/uploads/2024/11/04/xvnCNb20_pkce-keycloak-revised.jpeg",alt:"PKCE keycloak configuration",style:{width:"70%"}})),(0,a.kt)("p",null,"If you are implementing ",(0,a.kt)("a",{parentName:"p",href:"#implement-client-credentials-grant"},"client credentials grant"),", enable service accounts for the client:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/12/29/h1uNtghd_sa.png",alt:"enable-service-account"})),(0,a.kt)("p",null,"Select ",(0,a.kt)("strong",{parentName:"p"},"Save")," to apply custom configurations."),(0,a.kt)("h3",{id:"create-a-user"},"Create a User"),(0,a.kt)("p",null,"Users in Keycloak are entities that are able to log into the system. They can have attributes associated with themselves, such as username, email, and address."),(0,a.kt)("p",null,"If you are only implementing ",(0,a.kt)("a",{parentName:"p",href:"#implement-client-credentials-grant"},"client credentials grant"),", you can ",(0,a.kt)("a",{parentName:"p",href:"#obtain-the-oidc-configuration"},"skip this section"),"."),(0,a.kt)("p",null,"Click ",(0,a.kt)("strong",{parentName:"p"},"Users")," > ",(0,a.kt)("strong",{parentName:"p"},"Add user")," to open the ",(0,a.kt)("strong",{parentName:"p"},"Add user")," page:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/onQEp23L_create-user.png",alt:"create-user"})),(0,a.kt)("p",null,"Enter the ",(0,a.kt)("strong",{parentName:"p"},"Username")," as ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-user")," and select ",(0,a.kt)("strong",{parentName:"p"},"Save"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/EKhuhgML_add-user.png",alt:"add-user"})),(0,a.kt)("p",null,"Click on ",(0,a.kt)("strong",{parentName:"p"},"Credentials"),", then set the ",(0,a.kt)("strong",{parentName:"p"},"Password")," as ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-user-pass"),". Switch ",(0,a.kt)("strong",{parentName:"p"},"Temporary")," to ",(0,a.kt)("inlineCode",{parentName:"p"},"OFF")," to turn off the restriction, so that you need not to change password the first time you log in:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/rQKEAEnh_user-pass.png",alt:"user-pass"})),(0,a.kt)("h2",{id:"obtain-the-oidc-configuration"},"Obtain the OIDC Configuration"),(0,a.kt)("p",null,"In this section, you will obtain the key OIDC configuration from Keycloak and define them as shell variables. Steps after this section will use these variables to configure the OIDC by shell commands."),(0,a.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"Open a separate terminal to follow the steps and define related shell variables. Then steps after this section could use the defined variables directly."))),(0,a.kt)("h3",{id:"get-discovery-endpoint"},"Get Discovery Endpoint"),(0,a.kt)("p",null,"Click ",(0,a.kt)("strong",{parentName:"p"},"Realm Settings"),", then right click ",(0,a.kt)("strong",{parentName:"p"},"OpenID Endpoints Configuration")," and copy the link."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/526lbJbg_get-discovery.png",alt:"get-discovery"})),(0,a.kt)("p",null,"The link should be the same as the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"http://localhost:8080/realms/quickstart-realm/.well-known/openid-configuration\n")),(0,a.kt)("p",null,"Configuration values exposed with this endpoint are required during OIDC authentication. Update the address with your host IP and save to environment variables:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"export KEYCLOAK_IP=192.168.42.145    # replace with your host IP\nexport OIDC_DISCOVERY=http://${KEYCLOAK_IP}:8080/realms/quickstart-realm/.well-known/openid-configuration\n")),(0,a.kt)("h3",{id:"get-client-id-and-secret"},"Get Client ID and Secret"),(0,a.kt)("p",null,"Click on ",(0,a.kt)("strong",{parentName:"p"},"Clients")," > ",(0,a.kt)("inlineCode",{parentName:"p"},"apisix-quickstart-client")," > ",(0,a.kt)("strong",{parentName:"p"},"Credentials"),", and copy the client secret from ",(0,a.kt)("strong",{parentName:"p"},"Secret"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/MwYmU20v_client-id.png",alt:"client-ID"})),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/f9iOG8aN_client-secret.png",alt:"client-secret"})),(0,a.kt)("p",null,"Save the OIDC client ID and secret to environment variables:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"export OIDC_CLIENT_ID=apisix-quickstart-client\nexport OIDC_CLIENT_SECRET=bSaIN3MV1YynmtXvU8lKkfeY0iwpr9cH  # replace with your value\n")),(0,a.kt)("h2",{id:"implement-authorization-code-grant"},"Implement Authorization Code Grant"),(0,a.kt)("p",null,"The authorization code grant is used by web and mobile applications. The flow starts by authorization server displaying a login page in browser where users could key in their credentials. During the process, a short-lived authorization code is exchanged for an access token, which APISIX stores in browser session cookies and will be sent with every request visiting the upstream resource server."),(0,a.kt)("p",null,"To implement authorization code grant, create a Route with ",(0,a.kt)("inlineCode",{parentName:"p"},"openid-connect")," Plugin as such:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "auth-with-oidc",\n  "uri":"/anything/*",\n  "plugins": {\n    "openid-connect": {\n      "bearer_only": false,\n      "session": {\n        "secret": "change_to_whatever_secret_you_want"\n      },\n      "client_id": "\'"$OIDC_CLIENT_ID"\'",\n      "client_secret": "\'"$OIDC_CLIENT_SECRET"\'",\n      "discovery": "\'"$OIDC_DISCOVERY"\'",\n      "scope": "openid profile",\n      "redirect_uri": "http://localhost:9080/anything/callback"\n    }\n  },\n  "upstream":{\n    "type":"roundrobin",\n    "nodes":{\n      "httpbin.org:80":1\n    }\n  }\n}\'\n')),(0,a.kt)("p",null,"Alternatively, if you would like to implement authorization code grant with PKCE, create a Route with ",(0,a.kt)("inlineCode",{parentName:"p"},"openid-connect")," Plugin as such:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "auth-with-oidc",\n  "uri":"/anything/*",\n  "plugins": {\n    "openid-connect": {\n      "bearer_only": false,\n      "session": {\n        "secret": "change_to_whatever_secret_you_want"\n      },\n      "use_pkce": true,\n      "client_id": "\'"$OIDC_CLIENT_ID"\'",\n      "client_secret": "\'"$OIDC_CLIENT_SECRET"\'",\n      "discovery": "\'"$OIDC_DISCOVERY"\'",\n      "scope": "openid profile",\n      "redirect_uri": "http://localhost:9080/anything/callback"\n    }\n  },\n  "upstream":{\n    "type":"roundrobin",\n    "nodes":{\n      "httpbin.org:80":1\n    }\n  }\n}\'\n')),(0,a.kt)("h3",{id:"verify-with-valid-credentials"},"Verify with Valid Credentials"),(0,a.kt)("p",null,"Navigate to ",(0,a.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:9080/anything/test")," in browser. The request will be redirected to a login page:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/30/i38u1x9a_validate-sign.png",alt:"test-sign-on"})),(0,a.kt)("p",null,"Log in with the correct username ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-user")," and password ",(0,a.kt)("inlineCode",{parentName:"p"},"quickstart-user-pass"),". If successful, the request will be forwarded to\xa0",(0,a.kt)("inlineCode",{parentName:"p"},"httpbin.org")," and you should see a response similar to the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {},\n  "headers": {\n    "Accept": "text/html..."\n    ...\n  },\n  "json": null,\n  "method": "GET",\n  "origin": "127.0.0.1, 59.71.244.81",\n  "url": "http://127.0.0.1/anything/test"\n}\n')),(0,a.kt)("h3",{id:"verify-with-invalid-credentials"},"Verify with Invalid Credentials"),(0,a.kt)("p",null,"Sign in with the wrong credentials. You should see an authentication failure:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://static.api7.ai/uploads/2023/03/31/YOuSYX1r_validate-sign-failed.png",alt:"test-sign-failed"})),(0,a.kt)("h2",{id:"implement-client-credentials-grant"},"Implement Client Credentials Grant"),(0,a.kt)("p",null,"In client credentials grant, clients obtain access tokens without any users involved. It is typically used in machine-to-machine (M2M) communications."),(0,a.kt)("p",null,"To implement client credentials grant, create a Route with ",(0,a.kt)("inlineCode",{parentName:"p"},"openid-connect")," Plugin to use the JWKS endpoint of the identity provider to verify the token. The endpoint would be obtained from the discovery document."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "auth-with-oidc",\n  "uri":"/anything/*",\n  "plugins": {\n    "openid-connect": {\n      "use_jwks": true,\n      "client_id": "\'"$OIDC_CLIENT_ID"\'",\n      "client_secret": "\'"$OIDC_CLIENT_SECRET"\'",\n      "discovery": "\'"$OIDC_DISCOVERY"\'",\n      "scope": "openid profile",\n      "redirect_uri": "http://localhost:9080/anything/callback"\n    }\n  },\n  "upstream":{\n    "type":"roundrobin",\n    "nodes":{\n      "httpbin.org:80":1\n    }\n  }\n}\'\n')),(0,a.kt)("p",null,"Alternatively, if you would like to use the introspection endpoint to verify the token, create the Route as such:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "auth-with-oidc",\n  "uri":"/anything/*",\n  "plugins": {\n    "openid-connect": {\n      "bearer_only": true,\n      "client_id": "\'"$OIDC_CLIENT_ID"\'",\n      "client_secret": "\'"$OIDC_CLIENT_SECRET"\'",\n      "discovery": "\'"$OIDC_DISCOVERY"\'",\n      "scope": "openid profile",\n      "redirect_uri": "http://localhost:9080/anything/callback"\n    }\n  },\n  "upstream":{\n    "type":"roundrobin",\n    "nodes":{\n      "httpbin.org:80":1\n    }\n  }\n}\'\n')),(0,a.kt)("p",null,"The introspection endpoint will be obtained from the discovery document."),(0,a.kt)("h3",{id:"verify-with-valid-access-token"},"Verify With Valid Access Token"),(0,a.kt)("p",null,"Obtain an access token for the Keycloak server at the ",(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/securing_apps/#token-endpoint"},"token endpoint"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"curl -i \"http://$KEYCLOAK_IP:8080/realms/quickstart-realm/protocol/openid-connect/token\" -X POST \\\n  -d 'grant_type=client_credentials' \\\n  -d 'client_id='$OIDC_CLIENT_ID'' \\\n  -d 'client_secret='$OIDC_CLIENT_SECRET''\n")),(0,a.kt)("p",null,"The expected response is similar to the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJoT3ludlBPY2d6Y3VWWnYtTU42bXZKMUczb0dOX2d6MFo3WFl6S2FSa1NBIn0.eyJleHAiOjE3MDM4MjU1NjQsImlhdCI6MTcwMzgyNTI2NCwianRpIjoiMWQ4NWE4N2UtZDFhMC00NThmLThiMTItNGZiYWM2ODA5YmYwIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMS44Mzo4MDgwL3JlYWxtcy9xdWlja3N0YXJ0LXJlYWxtIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjE1OGUzOWFlLTk0YjAtNDI3Zi04ZGU3LTU3MTRhYWYwOGYzOSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1xdWlja3N0YXJ0LXJlYWxtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiY2xpZW50SG9zdCI6IjE3Mi4xNy4wLjEiLCJjbGllbnRJZCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1hcGlzaXgtcXVpY2tzdGFydC1jbGllbnQiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjE3LjAuMSJ9.TltzSXqrJuVID7aGrb35jn-oc07U_-jugSn-3jKz4A44LwtAsME_8b3qkmR4boMOIht_5pF6bnnp70MFAlg6JKu4_yIQDxF_GAHjnZXEO8OCKhtIKwXm2w-hnnJVIhIdGkIVkbPP0HfILuar_m0hpa53VpPBGYR-OS4pyh0KTUs8MB22xAEqyz9zjCm6SX9vXCqgeVkSpRW2E8NaGEbAdY25uY-ZC4dI_pON87Ey5e8GdD6HQLXQlGIOdCDi3N7k0HDoD9TZRv2bMRPfy4zVYm1ZlClIuF79A-ZBwr0c-XYuq7t6EY0gPGEXB-s0SaKlrIU5S9JBeVXRzYvqAih41g","expires_in":300,"refresh_expires_in":0,"token_type":"Bearer","not-before-policy":0,"scope":"email profile"}\n')),(0,a.kt)("p",null,"Save the access token to an environment variable:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'# replace with your access token\nexport ACCESS_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJoT3ludlBPY2d6Y3VWWnYtTU42bXZKMUczb0dOX2d6MFo3WFl6S2FSa1NBIn0.eyJleHAiOjE3MDM4MjU1NjQsImlhdCI6MTcwMzgyNTI2NCwianRpIjoiMWQ4NWE4N2UtZDFhMC00NThmLThiMTItNGZiYWM2ODA5YmYwIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMS44Mzo4MDgwL3JlYWxtcy9xdWlja3N0YXJ0LXJlYWxtIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjE1OGUzOWFlLTk0YjAtNDI3Zi04ZGU3LTU3MTRhYWYwOGYzOSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1xdWlja3N0YXJ0LXJlYWxtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwiY2xpZW50SG9zdCI6IjE3Mi4xNy4wLjEiLCJjbGllbnRJZCI6ImFwaXNpeC1xdWlja3N0YXJ0LWNsaWVudCIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1hcGlzaXgtcXVpY2tzdGFydC1jbGllbnQiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjE3LjAuMSJ9.TltzSXqrJuVID7aGrb35jn-oc07U_-jugSn-3jKz4A44LwtAsME_8b3qkmR4boMOIht_5pF6bnnp70MFAlg6JKu4_yIQDxF_GAHjnZXEO8OCKhtIKwXm2w-hnnJVIhIdGkIVkbPP0HfILuar_m0hpa53VpPBGYR-OS4pyh0KTUs8MB22xAEqyz9zjCm6SX9vXCqgeVkSpRW2E8NaGEbAdY25uY-ZC4dI_pON87Ey5e8GdD6HQLXQlGIOdCDi3N7k0HDoD9TZRv2bMRPfy4zVYm1ZlClIuF79A-ZBwr0c-XYuq7t6EY0gPGEXB-s0SaKlrIU5S9JBeVXRzYvqAih41g"\n')),(0,a.kt)("p",null,"Send a request to the route\xa0with the valid access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test" -H "Authorization: Bearer $ACCESS_TOKEN"\n')),(0,a.kt)("p",null,"An\xa0",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK"),"\xa0response verifies that the request to the upstream resource was authorized."),(0,a.kt)("h3",{id:"verify-with-invalid-access-token"},"Verify With Invalid Access Token"),(0,a.kt)("p",null,"Send a request to the Route with invalid access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test" -H "Authorization: Bearer invalid-access-token"\n')),(0,a.kt)("p",null,"An ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," response verifies that the OIDC Plugin rejects requests with invalid access token."),(0,a.kt)("h3",{id:"verify-without-access-token"},"Verify without Access Token"),(0,a.kt)("p",null,"Send a request to the Route without access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test"\n')),(0,a.kt)("p",null,"An ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," response verifies that the OIDC Plugin rejects requests without access token."),(0,a.kt)("h2",{id:"implement-password-grant"},"Implement Password Grant"),(0,a.kt)("p",null,"Password grant is a legacy approach to exchange user credentials for an access token."),(0,a.kt)("p",null,"To implement password grant, create a Route with ",(0,a.kt)("inlineCode",{parentName:"p"},"openid-connect")," Plugin to use the JWKS endpoint of the identity provider to verify the token. The endpoint would be obtained from the discovery document."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9180/apisix/admin/routes" -X PUT -d \'\n{\n  "id": "auth-with-oidc",\n  "uri":"/anything/*",\n  "plugins": {\n    "openid-connect": {\n      "use_jwks": true,\n      "client_id": "\'"$OIDC_CLIENT_ID"\'",\n      "client_secret": "\'"$OIDC_CLIENT_SECRET"\'",\n      "discovery": "\'"$OIDC_DISCOVERY"\'",\n      "scope": "openid profile",\n      "redirect_uri": "http://localhost:9080/anything/callback"\n    }\n  },\n  "upstream":{\n    "type":"roundrobin",\n    "nodes":{\n      "httpbin.org:80":1\n    }\n  }\n}\'\n')),(0,a.kt)("h3",{id:"verify-with-valid-access-token-1"},"Verify With Valid Access Token"),(0,a.kt)("p",null,"Obtain an access token for the Keycloak server at the ",(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs/latest/securing_apps/#token-endpoint"},"token endpoint"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"OIDC_USER=quickstart-user\nOIDC_PASSWORD=quickstart-user-pass\ncurl -i \"http://$KEYCLOAK_IP:8080/realms/quickstart-realm/protocol/openid-connect/token\" -X POST \\\n  -d 'grant_type=password' \\\n  -d 'client_id='$OIDC_CLIENT_ID'' \\\n  -d 'client_secret='$OIDC_CLIENT_SECRET'' \\\n  -d 'username='$OIDC_USER'' \\\n  -d 'password='$OIDC_PASSWORD''\n")),(0,a.kt)("p",null,"The expected response is similar to the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ6U3FFaXN6VlpuYi1sRWMzZkp0UHNpU1ZZcGs4RGN3dXI1Mkx5V05aQTR3In0.eyJleHAiOjE2ODAxNjA5NjgsImlhdCI6MTY4MDE2MDY2OCwianRpIjoiMzQ5MTc4YjQtYmExZC00ZWZjLWFlYTUtZGY2MzJiMDJhNWY5IiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguNDIuMTQ1OjgwODAvcmVhbG1zL3F1aWNrc3RhcnQtcmVhbG0iLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMTg4MTVjM2EtNmQwNy00YTY2LWJjZjItYWQ5NjdmMmIwMTFmIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYXBpc2l4LXF1aWNrc3RhcnQtY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6ImIxNmIyNjJlLTEwNTYtNDUxNS1hNDU1LWYyNWUwNzdjY2I3NiIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1xdWlja3N0YXJ0LXJlYWxtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6ImIxNmIyNjJlLTEwNTYtNDUxNS1hNDU1LWYyNWUwNzdjY2I3NiIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoicXVpY2tzdGFydC11c2VyIn0.uD_7zfZv5182aLXu9-YBzBDK0nr2mE4FWb_4saTog2JTqFTPZZa99Gm8AIDJx2ZUcZ_ElkATqNUZ4OpWmL2Se5NecMw3slJReewjD6xgpZ3-WvQuTGpoHdW5wN9-Rjy8ungilrnAsnDA3tzctsxm2w6i9KISxvZrzn5Rbk-GN6fxH01VC5eekkPUQJcJgwuJiEiu70SjGnm21xDN4VGkNRC6jrURoclv3j6AeOqDDIV95kA_MTfBswDFMCr2PQlj5U0RTndZqgSoxwFklpjGV09Azp_jnU7L32_Sq-8coZd0nj5mSdbkJLJ8ZDQDV_PP3HjCP7EHdy4P6TyZ7oGvjw","expires_in":300,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0YjFiNTQ3Yi0zZmZjLTQ5YzQtYjE2Ni03YjdhNzIxMjk1ODcifQ.eyJleHAiOjE2ODAxNjI0NjgsImlhdCI6MTY4MDE2MDY2OCwianRpIjoiYzRjNjNlMTEtZTdlZS00ZmEzLWJlNGYtNDMyZWQ4ZmY5OTQwIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguNDIuMTQ1OjgwODAvcmVhbG1zL3F1aWNrc3RhcnQtcmVhbG0iLCJhdWQiOiJodHRwOi8vMTkyLjE2OC40Mi4xNDU6ODA4MC9yZWFsbXMvcXVpY2tzdGFydC1yZWFsbSIsInN1YiI6IjE4ODE1YzNhLTZkMDctNGE2Ni1iY2YyLWFkOTY3ZjJiMDExZiIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJhcGlzaXgtcXVpY2tzdGFydC1jbGllbnQiLCJzZXNzaW9uX3N0YXRlIjoiYjE2YjI2MmUtMTA1Ni00NTE1LWE0NTUtZjI1ZTA3N2NjYjc2Iiwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwic2lkIjoiYjE2YjI2MmUtMTA1Ni00NTE1LWE0NTUtZjI1ZTA3N2NjYjc2In0.8xYP4bhDg1U9B5cTaEVD7B4oxNp8wwAYEynUne_Jm78","token_type":"Bearer","not-before-policy":0,"session_state":"b16b262e-1056-4515-a455-f25e077ccb76","scope":"profile email"}\n')),(0,a.kt)("p",null,"Save the access token and refresh token to environment variables. The refresh token will be used in the ",(0,a.kt)("a",{parentName:"p",href:"#refresh-token"},"refresh token step"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'# replace with your access token\nexport ACCESS_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ6U3FFaXN6VlpuYi1sRWMzZkp0UHNpU1ZZcGs4RGN3dXI1Mkx5V05aQTR3In0.eyJleHAiOjE2ODAxNjA5NjgsImlhdCI6MTY4MDE2MDY2OCwianRpIjoiMzQ5MTc4YjQtYmExZC00ZWZjLWFlYTUtZGY2MzJiMDJhNWY5IiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguNDIuMTQ1OjgwODAvcmVhbG1zL3F1aWNrc3RhcnQtcmVhbG0iLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiMTg4MTVjM2EtNmQwNy00YTY2LWJjZjItYWQ5NjdmMmIwMTFmIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYXBpc2l4LXF1aWNrc3RhcnQtY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6ImIxNmIyNjJlLTEwNTYtNDUxNS1hNDU1LWYyNWUwNzdjY2I3NiIsImFjciI6IjEiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsiZGVmYXVsdC1yb2xlcy1xdWlja3N0YXJ0LXJlYWxtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sInNjb3BlIjoicHJvZmlsZSBlbWFpbCIsInNpZCI6ImIxNmIyNjJlLTEwNTYtNDUxNS1hNDU1LWYyNWUwNzdjY2I3NiIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoicXVpY2tzdGFydC11c2VyIn0.uD_7zfZv5182aLXu9-YBzBDK0nr2mE4FWb_4saTog2JTqFTPZZa99Gm8AIDJx2ZUcZ_ElkATqNUZ4OpWmL2Se5NecMw3slJReewjD6xgpZ3-WvQuTGpoHdW5wN9-Rjy8ungilrnAsnDA3tzctsxm2w6i9KISxvZrzn5Rbk-GN6fxH01VC5eekkPUQJcJgwuJiEiu70SjGnm21xDN4VGkNRC6jrURoclv3j6AeOqDDIV95kA_MTfBswDFMCr2PQlj5U0RTndZqgSoxwFklpjGV09Azp_jnU7L32_Sq-8coZd0nj5mSdbkJLJ8ZDQDV_PP3HjCP7EHdy4P6TyZ7oGvjw"\nexport REFRESH_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0YjFiNTQ3Yi0zZmZjLTQ5YzQtYjE2Ni03YjdhNzIxMjk1ODcifQ.eyJleHAiOjE2ODAxNjI0NjgsImlhdCI6MTY4MDE2MDY2OCwianRpIjoiYzRjNjNlMTEtZTdlZS00ZmEzLWJlNGYtNDMyZWQ4ZmY5OTQwIiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguNDIuMTQ1OjgwODAvcmVhbG1zL3F1aWNrc3RhcnQtcmVhbG0iLCJhdWQiOiJodHRwOi8vMTkyLjE2OC40Mi4xNDU6ODA4MC9yZWFsbXMvcXVpY2tzdGFydC1yZWFsbSIsInN1YiI6IjE4ODE1YzNhLTZkMDctNGE2Ni1iY2YyLWFkOTY3ZjJiMDExZiIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJhcGlzaXgtcXVpY2tzdGFydC1jbGllbnQiLCJzZXNzaW9uX3N0YXRlIjoiYjE2YjI2MmUtMTA1Ni00NTE1LWE0NTUtZjI1ZTA3N2NjYjc2Iiwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwic2lkIjoiYjE2YjI2MmUtMTA1Ni00NTE1LWE0NTUtZjI1ZTA3N2NjYjc2In0.8xYP4bhDg1U9B5cTaEVD7B4oxNp8wwAYEynUne_Jm78"\n')),(0,a.kt)("p",null,"Send a request to the route\xa0with the valid access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test" -H "Authorization: Bearer $ACCESS_TOKEN"\n')),(0,a.kt)("p",null,"An\xa0",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK"),"\xa0response verifies that the request to the upstream resource was authorized."),(0,a.kt)("h3",{id:"verify-with-invalid-access-token-1"},"Verify With Invalid Access Token"),(0,a.kt)("p",null,"Send a request to the Route with invalid access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test" -H "Authorization: Bearer invalid-access-token"\n')),(0,a.kt)("p",null,"An ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," response verifies that the OIDC Plugin rejects requests with invalid access token."),(0,a.kt)("h3",{id:"verify-without-access-token-1"},"Verify without Access Token"),(0,a.kt)("p",null,"Send a request to the Route without access token:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything/test"\n')),(0,a.kt)("p",null,"An ",(0,a.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," response verifies that the OIDC Plugin rejects requests without access token."),(0,a.kt)("h3",{id:"refresh-token"},"Refresh Token"),(0,a.kt)("p",null,"To refresh the access token, send a request to the Keycloak token endpoint as such:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"curl -i \"http://$KEYCLOAK_IP:8080/realms/quickstart-realm/protocol/openid-connect/token\" -X POST \\\n  -d 'grant_type=refresh_token' \\\n  -d 'client_id='$OIDC_CLIENT_ID'' \\\n  -d 'client_secret='$OIDC_CLIENT_SECRET'' \\\n  -d 'refresh_token='$REFRESH_TOKEN''\n")),(0,a.kt)("p",null,"You should see a response similar to the following, with the new access token and refresh token, which you can use for subsequent requests and token refreshes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},'{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJTdnVwLXlPMHhDdTJBVi1za2pCZ0h6SHZNaG1mcDVDQWc0NHpYb2QxVTlNIn0.eyJleHAiOjE3MzAyNzQ3NDUsImlhdCI6MTczMDI3NDQ0NSwianRpIjoiMjk2Mjk5MWUtM2ExOC00YWFiLWE0NzAtODgxNWEzNjZjZmM4IiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMTUyLjU6ODA4MC9yZWFsbXMvcXVpY2tzdGFydC1yZWFsbSIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiI2ZWI0ZTg0Yy00NmJmLTRkYzUtOTNkMC01YWM5YzE5MWU0OTciLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhcGlzaXgtcXVpY2tzdGFydC1jbGllbnQiLCJzZXNzaW9uX3N0YXRlIjoiNTU2ZTQyYjktMjE2Yi00NTEyLWE5ZjAtNzE3ZTAyYTQ4MjZhIiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJkZWZhdWx0LXJvbGVzLXF1aWNrc3RhcnQtcmVhbG0iLCJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwic2lkIjoiNTU2ZTQyYjktMjE2Yi00NTEyLWE5ZjAtNzE3ZTAyYTQ4MjZhIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJxdWlja3N0YXJ0LXVzZXIifQ.KLqn1LQdazoPBqLLR856C35XpqbMO9I7WFt3KrDxZF1N8vwv4AvZYWI_2rsbdjCakh9JmPgyYRgEGufYLiDBsqy9CrMVejAIJPYsJIonIXBCp5Ysu92ODJuqtTKuuJ6K7dam7fisBFfCBbVvGspnZ3p0caedpOaF_kSd-F8ARHKVsmkuX3_ucDrP3UctjEXHezefTY4YHjNMB9wuMDPXX2vXt2BsOasnznsIHHHX-ZH8JY6eEfWPtfx0qAED6lVZICT6Rqj_j5-Cf9ogzFtLyy_XvtG9BbHME2B8AXYpxdzqxOxmVVbZdrB8elfmFjs1R3vUn2r3xA9hO_znZo_IoQ","expires_in":300,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICIwYWYwZTAwYy0xMThjLTRkNDktYmIwMS1iMDIwNDE3MmFjMzIifQ.eyJleHAiOjE3MzAyNzYyNDUsImlhdCI6MTczMDI3NDQ0NSwianRpIjoiZGQyZTJmYTktN2Y3Zi00MjM5LWEwODAtNWQyZDFiZTdjNzk4IiwiaXNzIjoiaHR0cDovLzE5Mi4xNjguMTUyLjU6ODA4MC9yZWFsbXMvcXVpY2tzdGFydC1yZWFsbSIsImF1ZCI6Imh0dHA6Ly8xOTIuMTY4LjE1Mi41OjgwODAvcmVhbG1zL3F1aWNrc3RhcnQtcmVhbG0iLCJzdWIiOiI2ZWI0ZTg0Yy00NmJmLTRkYzUtOTNkMC01YWM5YzE5MWU0OTciLCJ0eXAiOiJSZWZyZXNoIiwiYXpwIjoiYXBpc2l4LXF1aWNrc3RhcnQtY2xpZW50Iiwic2Vzc2lvbl9zdGF0ZSI6IjU1NmU0MmI5LTIxNmItNDUxMi1hOWYwLTcxN2UwMmE0ODI2YSIsInNjb3BlIjoiZW1haWwgcHJvZmlsZSIsInNpZCI6IjU1NmU0MmI5LTIxNmItNDUxMi1hOWYwLTcxN2UwMmE0ODI2YSJ9.Uad4BVuojHfyxqedFT5BHliWjIqVDbjM-Xeme0G2AAg","token_type":"Bearer","not-before-policy":0,"session_state":"556e42b9-216b-4512-a9f0-717e02a4826a","scope":"email profile"}\n')))}p.isMDXComponent=!0}}]);