<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">Apache APISIX plugin priority, a leaky abstraction? | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2023/12/14/apisix-plugins-priority-leaky-abstraction/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="Apache APISIX plugin priority, a leaky abstraction? | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="Apache APISIX builds upon the OpenResty reverse-proxy to offer a plugin-based architecture. The main benefit of such an architecture is that it brings structure to the configuration of routes. It&#x27;s a help at scale, when managing hundreds or thousands of routes. In this post, I&#x27;d like to describe how plugins, priority, and phases play together and what pitfalls you must be aware of.
"><meta data-react-helmet="true" property="og:description" content="Apache APISIX builds upon the OpenResty reverse-proxy to offer a plugin-based architecture. The main benefit of such an architecture is that it brings structure to the configuration of routes. It&#x27;s a help at scale, when managing hundreds or thousands of routes. In this post, I&#x27;d like to describe how plugins, priority, and phases play together and what pitfalls you must be aware of.
"><meta data-react-helmet="true" name="keywords" content="DevOps,plugins,priority,abstraction"><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/uploads/2023/12/09/acT4tzVw_puzzle-3486885.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/uploads/2023/12/09/acT4tzVw_puzzle-3486885.jpg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-12-14T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/nfrankel"><meta data-react-helmet="true" property="article:tag" content="Ecosystem"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2023/12/14/apisix-plugins-priority-leaky-abstraction/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2023/12/14/apisix-plugins-priority-leaky-abstraction/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://blog.frankel.ch/apisix-plugins-priority-leaky-abstraction/"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">🤔 Introducing APISIX AI Gateway – Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX®️</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">中文博客</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Apache APISIX plugin priority, a leaky abstraction?</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-12-14T00:00:00.000Z" itemprop="datePublished">December 14, 2023</time> · <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a href="https://github.com/nfrankel" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_KCbV" src="https://avatars.githubusercontent.com/u/752258" alt="Nicolas Fränkel"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/nfrankel" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Nicolas Fränkel</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><meta itemprop="image" content="https://static.apiseven.com/uploads/2023/12/09/acT4tzVw_puzzle-3486885.jpg"><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p><a href="https://apisix.apache.org/" target="_blank" rel="noopener noreferrer">Apache APISIX</a> builds upon the <a href="https://openresty.org/en/" target="_blank" rel="noopener noreferrer">OpenResty</a> reverse-proxy to offer a plugin-based architecture. The main benefit of such an architecture is that it brings structure to the configuration of routes. It&#x27;s a help at scale, when managing hundreds or thousands of routes.</p><p>In this post, I&#x27;d like to describe how plugins, priority, and phases play together and what pitfalls you must be aware of.</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apisix-plugins-priority">APISIX plugin&#x27;s priority<a aria-hidden="true" class="hash-link" href="#apisix-plugins-priority" title="Direct link to heading">​</a></h2><p>When you configure a route with multiple plugins, Apache APISIX needs to execute them in a <strong>consistent</strong> order so that the results are the same over time. For this reason, every APISIX plugin has a <em>harcoded</em> <strong>priority</strong>. You can check a plugin priority directly in the code. For example, here&#x27;s the relevant code fragment for the <code>basic-auth</code> plugin:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local _M = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version = 0.1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority = 2520,                                 #1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &#x27;auth&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = plugin_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema = schema,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer_schema = consumer_schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Priority is 2520</li></ol><p>For documentation purposes, the <code>default-config.yaml</code> file lists the priority of all out-of-the-box plugins. Here&#x27;s an excerpt:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ldap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                      </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2540</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> hmac</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                      </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2530</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                     </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2520</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                       </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2510</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                       </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">restriction           </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> forward</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth                   </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> opa                            </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> authz</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">keycloak                 </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#- error-log-logger              # priority: 1091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cache                    </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1085</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">transformer               </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mirror                   </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1010</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">rewrite                  </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1008</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> workflow                       </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1006</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">breaker                    </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1005</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conn                     </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1003</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">count                    </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> limit</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">req                      </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1001</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Imagine a route configured with <code>proxy-mirror</code> and <code>proxy-rewrite</code>. Because of their respective priority, <code>proxy-mirror</code> would run before <code>proxy-rewrite</code>.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">upstream</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">&quot;oldapi:8081&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/v1/hello*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">upstream_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">proxy-rewrite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">                                 </span><span class="token comment" style="color:#999988;font-style:italic">#1-3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">regex_uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/v1(.*)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$1&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">proxy-mirror</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//new.api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8082</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>The plugin ordering in this file is not relevant</li><li><code>proxy-mirror</code> has priority 1010 and will execute first</li><li><code>proxy-rewrite</code> has priority 1008 and will run second</li></ol><p>The above setup has an issue. For example, if we call <code>localhost:9080/v1/hello</code>, APISIX will first mirror the request, then remove the <code>/v1</code> prefix. Hence, the new API receives <code>/v1/hello</code> instead of <code>/hello</code>. It&#x27;s possible to override the default priority to fix it:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/v1/hello*&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">upstream_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">proxy-rewrite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">_meta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">priority</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1020</span><span class="token plain">                             </span><span class="token comment" style="color:#999988;font-style:italic">#1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">regex_uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;/v1(.*)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$1&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">proxy-mirror</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//new.api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8082</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Override the default priority</li></ol><p>Now, <code>proxy-rewrite</code> has higher priority than <code>proxy-mirror</code>: the former runs before the latter.</p><p>In this case, it works flawlessly; in others, it might not. Let&#x27;s dive further.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apisix-phases">APISIX phases<a aria-hidden="true" class="hash-link" href="#apisix-phases" title="Direct link to heading">​</a></h2><p>APISIX runs plugins not only according to their priorities but also through dedicated phases. Because APISIX builds upon OpenResty, which builds upon ngxinx, the phases are very similar to the phases of these two components.</p><p>nginx defines several <a href="http://nginx.org/en/docs/dev/development_guide.html#http_phases" target="_blank" rel="noopener noreferrer">phases</a> an HTTP request goes through:</p><ol><li><code>NGX_HTTP_POST_READ_PHASE</code></li><li><code>NGX_HTTP_SERVER_REWRITE_PHASE</code></li><li><code>NGX_HTTP_FIND_CONFIG_PHASE</code></li><li><code>NGX_HTTP_REWRITE_PHASE</code></li><li><code>NGX_HTTP_POST_REWRITE_PHASE</code></li><li><code>NGX_HTTP_PREACCESS_PHASE</code></li><li><code>NGX_HTTP_ACCESS_PHASE</code></li><li><code>NGX_HTTP_POST_ACCESS_PHASE</code></li><li><code>NGX_HTTP_PRECONTENT_PHASE</code></li><li><code>NGX_HTTP_CONTENT_PHASE</code></li><li><code>NGX_HTTP_LOG_PHASE</code></li></ol><p>Each phase focuses on a task, <em>i.e.</em>, <code>NGX_HTTP_ACCESS_PHASE</code> verifies that the client is authorized to make the request.</p><p>In turn, OpenResty offers similarly named phases.</p><p><a href="https://openresty-reference.readthedocs.io/en/latest/Directives/" target="_blank" rel="noopener noreferrer">From nginx documentation:</a></p><p></p><div class="rc-image"><img loading="lazy" alt="Order of Lua Nginx Module Directives" class="rc-image-img" src="https://cloud.githubusercontent.com/assets/2137369/15272097/77d1c09e-1a37-11e6-97ef-d9767035fc3e.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><p>image:77d1c09e-1a37-11e6-97ef-d9767035fc3e.png<!-- -->[,840,761]</p><p>Finally, here are the phases of Apache APISIX:</p><ol><li><code>rewrite</code></li><li><code>access</code></li><li><code>before_proxy</code></li><li><code>header_filter</code></li><li><code>body_filter</code></li><li><code>log</code></li></ol><p><a href="https://apisix.apache.org/docs/apisix/terminology/plugin/#plugins-execution-lifecycle" target="_blank" rel="noopener noreferrer">From Apache APISIX documentation:</a></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/03/09/ZsH5C8Og_plugins-phases.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/03/09/ZsH5C8Og_plugins-phases.webp, https://static.apiseven.com/uploads/2023/03/09/ZsH5C8Og_plugins-phases.png" alt="Order of Apache APISIX phases" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/03/09/ZsH5C8Og_plugins-phases.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/03/09/ZsH5C8Og_plugins-phases.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/03/09/ZsH5C8Og_plugins-phases.png" alt="Order of Apache APISIX phases" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/03/09/ZsH5C8Og_plugins-phases.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>We have seen two ways to order plugins: by priority and by phase. Now comes the most important rule: <strong>order by priority only works inside a phase</strong>!</p><p>For example, the <code>redirect</code> plugin has a priority of 900 and runs in phase <code>rewrite</code>; the <code>gzip</code> plugin has a priority of 995 and runs in phase <code>body_filter</code>. Regardless of their respective priorities, <code>redirect</code> will happen before <code>gzip</code>, because <code>rewrite</code> happens before <code>body_filter</code>. Likewise, changing a priority won&#x27;t &quot;move&quot; a plugin out of its phase.</p><p>The example above with <code>proxy-mirror</code> and <code>proxy-rewrite</code> worked because both run in the <code>rewrite</code> phase.</p><p>The main issue is that priority is documented in the <a href="https://github.com/apache/apisix/blob/master/conf/config-default.yaml#L438" target="_blank" rel="noopener noreferrer">config-default.yaml</a> file, while the phase is buried in the code. Worse, some plugins run across different phases. For example, let&#x27;s check the proxy <code>proxy-rewrite</code> plugin and, more precisely, the functions defined <a href="https://github.com/apache/apisix/blob/master/apisix/plugins/proxy-rewrite.lua" target="_blank" rel="noopener noreferrer">there</a>:</p><ul><li><code>local function is_new_headers_conf(headers)</code></li><li><code>local function check_set_headers(headers)</code></li><li><code>function _M.check_schema(conf)</code></li><li><code>function _M.rewrite(conf, ctx)</code></li></ul><p>The name of the <code>rewrite()</code> function is suspiciously similar to one of the phases above. Looking at other plugins, we see the same pattern repeat. Apache APISIX runs plugin functions with the same name as the phase.</p><p>I took the liberty of summarizing all plugins and their respective phases in a table.</p><table><thead><tr><th>Plugin</th><th colspan="6">Phase</th></tr><tr><th><em>General</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>redirect</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>echo</code></td><td></td><td></td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>gzip</code></td><td></td><td></td><td></td><td>X</td><td></td><td></td></tr><tr><td><code>real-ip</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>ext-plugin-pre-req</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>ext-plugin-post-req</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>ext-plugin-post-resp</code></td><td></td><td></td><td>X</td><td></td><td></td><td></td></tr><tr><td><code>workflow</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr></tbody><thead><tr><th><em>Transformation</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>response-rewrite</code></td><td></td><td></td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>proxy-rewrite</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>grpc-transcode</code></td><td></td><td>X</td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>grpc-web</code></td><td></td><td>X</td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>fault-injection</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>mocking</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>degraphql</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>body-transformer</code></td><td>X</td><td></td><td></td><td>X</td><td>X</td><td></td></tr></tbody><thead><tr><th><em>Authentication</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>key-auth</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>jwt-auth</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>basic-auth</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>authz-keycloak</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>authz-casdoor</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>wolf-rbac</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>openid-connect</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>cas-auth</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>hmac-auth</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>authz-casbin</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>ldap-auth</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>opa</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>forward-auth</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr></tbody><thead><tr><th><em>Security</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>cors</code></td><td>X</td><td></td><td></td><td>X</td><td></td><td></td></tr><tr><td><code>uri-blocker</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>ua-restriction</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>referer-restriction</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>consumer-restriction</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>csrf</code></td><td></td><td>X</td><td></td><td>X</td><td></td><td></td></tr><tr><td><code>public-api</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>chaitin-waf</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr></tbody><thead><tr><th><em>Traffic</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>limit-req</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>limit-conn</code></td><td></td><td>X</td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>limit-count</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>proxy-cache</code> (init)</td><td></td><td>X</td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>proxy-cache</code> (disk)</td><td></td><td>X</td><td></td><td>X</td><td></td><td></td></tr><tr><td><code>proxy-cache</code> (memory)</td><td></td><td>X</td><td></td><td>X</td><td>X</td><td></td></tr><tr><td><code>request-validation</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>proxy-mirror</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>api-breaker</code></td><td></td><td>X</td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>traffic-split</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>request-id</code></td><td>X</td><td></td><td></td><td>X</td><td></td><td></td></tr><tr><td><code>proxy-control</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>client-control</code></td><td>X</td><td></td><td></td><td></td><td></td><td></td></tr></tbody><thead><tr><th><em>Observability</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>zipkin</code></td><td>X</td><td>X</td><td></td><td>X</td><td></td><td>X</td></tr><tr><td><code>skywalking</code></td><td>X</td><td></td><td></td><td></td><td>X</td><td></td></tr><tr><td><code>opentelemetry</code></td><td>X</td><td></td><td></td><td></td><td>X</td><td></td></tr><tr><td><code>prometheus</code></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>node-status</code></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>datadog</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>http-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>skywalking-logger</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>tcp-logger</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>kafka-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>rocketmq-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>udp-logger</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>clickhouse-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>syslog</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>log-rotate</code></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>error-log-logger</code></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>sls-logger</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>google-cloud-logging</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>splunk-hec-logging</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>file-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>loggly</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>elasticsearch-logger</code></td><td></td><td></td><td></td><td></td><td></td><td>X</td></tr><tr><td><code>tencent-cloud-cls</code></td><td></td><td>X</td><td></td><td></td><td>X</td><td>X</td></tr><tr><td><code>loki-logger</code></td><td></td><td></td><td></td><td></td><td>X</td><td>X</td></tr></tbody><thead><tr><th><em>Other</em></th><th><code>rewrite</code></th><th><code>access</code></th><th><code>before_proxy</code></th><th><code>header_filter</code></th><th><code>body_filter</code></th><th><code>log</code></th></tr></thead><tbody><tr><td><code>serverless</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>openwhisk</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>dubbo-proxy</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr><tr><td><code>kafka-proxy</code></td><td></td><td>X</td><td></td><td></td><td></td><td></td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="conclusion">Conclusion<a aria-hidden="true" class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>I&#x27;ve detailed Apache APISIX plugin phases and priorities in this post. I&#x27;ve explained their relationship with one another. Icing on the cake, I documented each out-of-the-box plugin&#x27;s phase(s). I hope it will prove helpful.</p><p><strong>To go further:</strong></p><ul><li><a href="https://github.com/apache/apisix/blob/master/conf/config-default.yaml#L438" target="_blank" rel="noopener noreferrer">Default plugin priorities</a></li><li><a href="https://apisix.apache.org/docs/apisix/terminology/plugin/#plugins-execution-lifecycle" target="_blank" rel="noopener noreferrer">Apache APISIX plugin execution lifecycle</a></li><li><a href="https://github.com/apache/apisix/blob/master/apisix/plugin.lua#L1126-L1193" target="_blank" rel="noopener noreferrer">Plugin execution code</a></li></ul><p><em>Originally published at <a href="https://blog.frankel.ch/apisix-plugins-priority-leaky-abstraction/" target="_blank" rel="noopener noreferrer">A Java Geek</a> on December 10<sup>th</sup>, 2023</em></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/ecosystem/">Ecosystem</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2023/12/19/datavisor-uses-apisix/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">Enhancing Security and Performance: DataVisor&#x27;s Dynamic Use of APISIX</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2023/12/14/migu-video-adopts-apisix/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">How to Supercharge Large-Scale Video Operations with APISIX</div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright © 2019-2025 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js"></script>
</body>
</html>