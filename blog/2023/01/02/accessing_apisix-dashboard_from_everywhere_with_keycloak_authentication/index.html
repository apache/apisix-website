<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">Accessing APISIX-Dashboard from Everywhere with Keycloak Authentication | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/202202/apache-apisix.png"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/202202/apache-apisix.png"><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2023/01/02/accessing_apisix-dashboard_from_everywhere_with_keycloak_authentication/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="Accessing APISIX-Dashboard from Everywhere with Keycloak Authentication | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="This guest blog shares how to expose the APISIX Dashboard using APISIX to authenticate access with the OpenID-Connect plugin and Keycloak server to manage identities."><meta data-react-helmet="true" property="og:description" content="This guest blog shares how to expose the APISIX Dashboard using APISIX to authenticate access with the OpenID-Connect plugin and Keycloak server to manage identities."><meta data-react-helmet="true" name="keywords" content="Alternatives to NGINX,Access and Authentication,Nginx reverse proxy,OpenID-Connect,Keycloak"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-01-02T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/MirtoBusico"><meta data-react-helmet="true" property="article:tag" content="Ecosystem"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/blog/2023/01/02/accessing_apisix-dashboard_from_everywhere_with_keycloak_authentication/"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2023/01/02/accessing_apisix-dashboard_from_everywhere_with_keycloak_authentication/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2023/01/02/accessing_apisix-dashboard_from_everywhere_with_keycloak_authentication/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">🤔 Introducing APISIX AI Gateway – Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX®️</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">中文博客</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Accessing APISIX-Dashboard from Everywhere with Keycloak Authentication</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-01-02T00:00:00.000Z" itemprop="datePublished">January 2, 2023</time> · <!-- -->18 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a href="https://github.com/MirtoBusico" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_KCbV" src="https://avatars.githubusercontent.com/u/11090934?s=400&amp;u=644e4f87c2fad56760f6eb4f46cbcb4db059880a&amp;v=4" alt="Busico Mirto Silvio"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/MirtoBusico" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Busico Mirto Silvio</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p>This article describes how to setup an external access to apisix-dashboard protecting the URL with authentication managed by a keycloak server.</p></blockquote><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mV2GUS21_blog01a.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/mV2GUS21_blog01a.webp, https://static.apiseven.com/uploads/2023/01/20/mV2GUS21_blog01a.png" alt="framework" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/mV2GUS21_blog01a.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mV2GUS21_blog01a.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mV2GUS21_blog01a.png" alt="framework" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mV2GUS21_blog01a.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>This article presents how to setup a framework where a user can access the Apisix-dashboard protected using an authentication system managed by a Keycloak server.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="prerequisites">Prerequisites<a aria-hidden="true" class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h2><p>Basic understanding of nginx reverse proxy, kubernetes, apisix and openid connect.</p><blockquote><p>A lot of information on this matter can be found in <a href="https://apisix.apache.org/blog/2022/07/06/use-keycloak-with-api-gateway-to-secure-apis/" target="_blank" rel="noopener noreferrer">&quot;Use Keycloak with API Gateway to secure APIs&quot;</a> blog post</p></blockquote><p>Here I&#x27;ll present instructions, examples, code and screenshots taken from my home lab.</p><p>The framework used in this article consists of some KVM virtual machines (from now VM):</p><table><thead><tr><th>VM Name</th><th>Role</th><th>Services</th><th>Description</th></tr></thead><tbody><tr><td>hdev</td><td>Development</td><td>kubectl, istioctl, helm</td><td>workstation from where manage the cluster</td></tr><tr><td>hserv</td><td>external services</td><td>DNS server, Nginx, Keycloak</td><td>services used by the cluster VM and external users</td></tr><tr><td>hkm</td><td>Kubernetes master</td><td>master node</td><td>control plane manager for K8S</td></tr><tr><td>hkw1</td><td>K8S worker 1</td><td>first worker node</td><td>node for hosting pods</td></tr><tr><td>hkw2</td><td>K8S worker 2</td><td>second worker node</td><td>node for hosting pods</td></tr><tr><td>hkw3</td><td>K8S worker 3</td><td>third worker node</td><td>node for hosting pods</td></tr></tbody></table><p>The <strong>hserv</strong> VM have two lan cards: one on an external lan to expose services and one an internal lan to communicate with the Kubernetes (from now K8S) cluster.
All the other VM are only connected to the internal lan.</p><p>All the machines resolve the IP addresses using the DNS server installed on <strong>hserv</strong></p><p><strong>Hserv</strong> and <strong>hdev</strong> machines have a Graphical User Interface (from now GUI). All the other machines have only the character console.</p><blockquote><p>The real framework is more complex. Here are reported only the relevant components</p></blockquote><p>All machines use Ubuntu distribution but commands reported here should worh for other distributions with some modifications.
The username used throughout this article will be <strong>&quot;sysop&quot;</strong> So the home directory will be indicated as <strong>&quot;/home/sysop&quot;</strong> or <strong>&quot;~/&quot;</strong>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-a-certification-authority-and-certificates">Create a Certification Authority and Certificates<a aria-hidden="true" class="hash-link" href="#create-a-certification-authority-and-certificates" title="Direct link to heading">​</a></h2><p>For all the VM the DNS server will resolve <strong>&quot;apisix.h.net&quot;</strong> to the external address of <strong>hserv</strong>.
In all others machine that will access the the services exposed by <strong>hserv</strong> there will be a line in the <strong>&quot;/etc/hosts&quot;</strong> file resolving <strong>&quot;apisix.h.net&quot;</strong> to the external address of <strong>hserv</strong>.</p><blockquote><p>Working on <strong>hserv</strong></p></blockquote><p>Create the directory for the entire project software</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> H</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the directory to hold the Certification authority (from now CA) certificates and the web sites certificates</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> hservcerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> hservcerts</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create a private key for <strong>&quot;hservca&quot;</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl genrsa -out hservca.key </span><span class="token number" style="color:#36acaa">2048</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>This generates a <strong>hservca.key</strong> key file. Using this fiile generate the CA certificate</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl req -x509 -new -nodes -key hservca.key -sha256 -days </span><span class="token number" style="color:#36acaa">3650</span><span class="token plain"> -out hservca.pem</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>This generates a <strong>hservca.pem&quot;</strong> certificate file. These two files will be used to create the web sites certificates</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="add-the-ca-to-browsers">Add the CA to Browsers<a aria-hidden="true" class="hash-link" href="#add-the-ca-to-browsers" title="Direct link to heading">​</a></h3><p>To be able to access the web sites with certidicates issued by this private CA, the CA certificate file have to be added to the web browser that will access these sites.</p><blockquote><p>Working on hdev</p></blockquote><p>Copy the <strong>&quot;hservca.pem&quot;</strong> file in any machine that will access these sites.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ~/H/hservcerts/hservca.pem </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rcp</span><span class="token plain"> hservca.pem mirto@_any_machine_name_://home/_your_username_/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>For <strong>Firefox</strong> browser go to:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">Preferences -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Privacy </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Security -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Certificates -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> View Certificates -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Authorities -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Import</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>and import <strong>&quot;hservca.pem&quot;</strong> (remember to flag all options)</p><p>For <strong>Chromium</strong> or <strong>Chrome</strong> browsers go to:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">Settings -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Advanced -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Privacy and security -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Manage certificates -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Authorities -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Import </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag all options</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>and import <strong>&quot;hservca.pem&quot;</strong> (remember to flag all options)</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="add-the-ca-to-the-operating-system">Add the CA to the Operating System<a aria-hidden="true" class="hash-link" href="#add-the-ca-to-the-operating-system" title="Direct link to heading">​</a></h3><blockquote><p>Working on hdev</p></blockquote><p>Copy the &quot;hservca.pem&quot; file in the &quot;/home/sysop&quot; directory.
Copy this file on any other machine that will use sertificates signed by this CA.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ~/H/hservcerts/hservca.pem </span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rcp</span><span class="token plain"> hservca.pem mirto@_any_machine_name_://home/_your_username_/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>Work on any machine</p></blockquote><p>Then on any machine and hserv do the following:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /usr/share/ca-certificates/extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> hservca.pem /usr/share/ca-certificates/extra/hservca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> dpkg-reconfigure ca-certificates</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p><strong>Attention</strong>:</p><p>• &quot;dpkg-reconfigure ca-certificates&quot; do not recognize the &quot;.pem&quot; extension. Copy the <strong>&quot;hservca.pem&quot;</strong> file to <strong>&quot;hservca.crt&quot;</strong></p><p>• select the new certificate in &quot;dpkg-reconfigure ca-certificates&quot; (extra/hservca.crt is not selected)</p></blockquote><p>Confirm that you want to proceed: select “yes” and click “Ok”. Select the new “hservca.crt” entry and click “Ok”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.webp, https://static.apiseven.com/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.png" alt="confirm" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.png" alt="confirm" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/uSuVlfv2_2%20ca-certificates.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="install-nginx-mainline">Install nginx-mainline<a aria-hidden="true" class="hash-link" href="#install-nginx-mainline" title="Direct link to heading">​</a></h2><p>Verify the system is updated</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> full-upgrade</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Install prerequisites</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> gnupg2 ca-certificates lsb-release ubuntu-keyring software-properties-common -y</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Download the Nginx GPG key</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> -O- https://nginx.org/keys/nginx_signing.key </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> gpg --dearmor </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /usr/share/keyrings/nginx-archive-keyring.gpg</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Add the Nginx mainline apt repository</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> deb </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">arch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">amd64,arm64 signed-by</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/share/keyrings/nginx-archive-keyring.gpg</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> http://nginx.org/packages/mainline/ubuntu </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">lsb_release -cs</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> nginx </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/apt/sources.list.d/nginx-mainline.list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Pin the Nginx repository</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;Package: *</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">Pin: origin nginx.org</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">Pin: release o=nginx</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">Pin-Priority: 900</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/apt/preferences.d/99nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Update apt and install nginx</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="install-keycloak">Install Keycloak<a aria-hidden="true" class="hash-link" href="#install-keycloak" title="Direct link to heading">​</a></h2><blockquote><p>Work on <strong>hserv</strong></p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="prerequisites-1">Prerequisites<a aria-hidden="true" class="hash-link" href="#prerequisites-1" title="Direct link to heading">​</a></h3><p>Install jdk</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> default-jdk</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Remove anacron</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> remove anacron</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Reboot the <strong>hserv</strong> machine</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="keycloak-installation">Keycloak Installation<a aria-hidden="true" class="hash-link" href="#keycloak-installation" title="Direct link to heading">​</a></h3><p>Go in base installation directory and get keycloak installation files (verify what is the last release)</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/keycloak/keycloak/releases/download/20.0.1/keycloak-20.0.1.zip</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Extract the files</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">unzip</span><span class="token plain"> keycloak-20.0.1.zip</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Go to the bin directory and start keycloak in standalone mode</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/keycloak-20.0.1/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./kc.sh start-dev</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Verify that Keycloak is accessible from <strong>hserv</strong> at the URL <strong>&quot;http://localhost:8080&quot;</strong></p><p>Create the admin user as name <strong>&quot;admin&quot;</strong> and password <strong>&quot;1357Togo&quot;</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/N8jhfNWf_3%20k6k01.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/N8jhfNWf_3%20k6k01.webp, https://static.apiseven.com/uploads/2023/01/20/N8jhfNWf_3%20k6k01.png" alt="k6k01" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/N8jhfNWf_3%20k6k01.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/N8jhfNWf_3%20k6k01.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/N8jhfNWf_3%20k6k01.png" alt="k6k01" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/N8jhfNWf_3%20k6k01.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Go to the administration console</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/casYhEXo_4%20k6k02.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/casYhEXo_4%20k6k02.webp, https://static.apiseven.com/uploads/2023/01/20/casYhEXo_4%20k6k02.png" alt="k6k02" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/casYhEXo_4%20k6k02.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/casYhEXo_4%20k6k02.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/casYhEXo_4%20k6k02.png" alt="k6k02" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/casYhEXo_4%20k6k02.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Login and the “Master” realm appears. Note the Keycloak version</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mReJJEkt_5%20k6k03.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/mReJJEkt_5%20k6k03.webp, https://static.apiseven.com/uploads/2023/01/20/mReJJEkt_5%20k6k03.png" alt="k6k03" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/mReJJEkt_5%20k6k03.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mReJJEkt_5%20k6k03.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mReJJEkt_5%20k6k03.png" alt="k6k03" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/mReJJEkt_5%20k6k03.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="automatic-keycloak-startup">Automatic Keycloak Startup<a aria-hidden="true" class="hash-link" href="#automatic-keycloak-startup" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p></blockquote><p>Create in <strong>“/usr/lib/systemd/system”</strong> a file named <strong>“keycloak.service”</strong> containing</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">keycloak </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/home/sysop/H/keycloak-20.0.1/bin/kc.sh start-dev </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/var/log/keycloak.log </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PIDFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/run/keycloak.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Enable and activate the service</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> keycloak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl start keycloak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Reboot hserv and verify Keycloak is accessible at startup</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-site-and-certificates-for-httpsk6khnet">Create site and certificates for &quot;<a href="https://k6k.h.net%22" target="_blank" rel="noopener noreferrer">https://k6k.h.net&quot;</a><a aria-hidden="true" class="hash-link" href="#create-site-and-certificates-for-httpsk6khnet" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p><p>Note that keycloak will be abbreviated in <strong>k6k</strong></p></blockquote><p>Verify that the keycloak address was added in <strong>&quot;/etc/hosts&quot;</strong> file on any machine that will access the service and is reported in the DNS server hosted on <strong>hserv</strong>.</p><p>The address used is the exsternal address o the <strong>hsrv</strong> machine</p><p>In the <strong>&quot;/etc/hosts&quot;</strong> fle add the line</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.100.20 k6k k6k.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>In the DNS server on <strong>hserv</strong> add the k6k entry in the <strong>“h.net”</strong> DNS zone with address <strong>“192.168.100.20”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/clouoRER_6%20dns01.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/clouoRER_6%20dns01.webp, https://static.apiseven.com/uploads/2023/01/20/clouoRER_6%20dns01.png" alt="dns01" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/clouoRER_6%20dns01.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/clouoRER_6%20dns01.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/clouoRER_6%20dns01.png" alt="dns01" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/clouoRER_6%20dns01.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create the certificate for <strong>&quot;k6k.h.net&quot;</strong></p><p>In <strong>&quot;~/H/hservcerts&quot;</strong> create a file called <strong>&quot;k6kssl.cnf&quot;</strong> containing</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_bits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguished_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req_distinguished_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">req_distinguished_name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Italy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Rome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">O </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Busico Mirto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OU </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Laboratory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CN </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k6k.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v3_ca</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjectAltName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> @alt_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">alt_names</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k6k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># other names</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k6k.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k6k.ext.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k6k.int.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the server private key and csr certificate request</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/hservcerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl req -new -sha256 -nodes -newkey rsa:2048 -keyout k6k.key -out k6k.csr -config k6kssl.cnf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the certificate signed by the <strong>&quot;hservca&quot;</strong> certification authority</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl x509 -req -in k6k.csr -CA hservca.pem -CAkey hservca.key -CAcreateserial -out k6k.crt -sha256 -days </span><span class="token number" style="color:#36acaa">3650</span><span class="token plain"> -extfile k6kssl.cnf -extensions v3_ca</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Now you have the key file <strong>k6k.key</strong> and the certificate file <strong>k6k.cert</strong> to be used in the nginx reverse proxy</p><p>Change the access rights for k6k.key file to permit nginx access</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/hservcerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> a+r k6k.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the root directory for k6k under nginx and create an index.html file in that directory</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /usr/share/nginx/k6k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">777</span><span class="token plain"> /usr/share/nginx/k6k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> /usr/share/nginx/k6k/index.html</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Put in index.html filke the &quot;K6K&quot; base document</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">DOCTYPE html</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">html</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">text</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">K6K default page</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/text</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/html</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>In the directory <strong>“/etc/nginx/conf.d”</strong> create the file <strong>“k6k.conf”</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/nginx/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> k6k.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The file contains</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> ssl http2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name k6k.h.net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root   /usr/share/nginx/k6k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log  /var/log/nginx/k6k.access.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_log  /var/log/nginx/k6k.error.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate     /home/sysop/H/hservcerts/k6k.crt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key /home/sysop/H/hservcerts/k6k.key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index  index.html index.htm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page  </span><span class="token number" style="color:#36acaa">404</span><span class="token plain">              /404.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># redirect server error pages to the static page /50x.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page   </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Restart Nginx</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Try to access “<a href="https://k6k.h.net%E2%80%9D" target="_blank" rel="noopener noreferrer">https://k6k.h.net”</a> from a browser: the k6k base document will be showed</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="add-keycloak-reverse-proxy">Add Keycloak Reverse Proxy<a aria-hidden="true" class="hash-link" href="#add-keycloak-reverse-proxy" title="Direct link to heading">​</a></h3><p>In the directory <strong>“/etc/nginx/conf.d”</strong> change the file <strong>“k6k.conf”</strong> to proxy keycloak</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/nginx/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> k6k.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The file now contains</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> ssl http2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name k6k.h.net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root   /usr/share/nginx/k6k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log  /var/log/nginx/k6k.access.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_log  /var/log/nginx/k6k.error.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate     /home/sysop/H/hservcerts/k6k.crt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key /home/sysop/H/hservcerts/k6k.key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header Host </span><span class="token variable" style="color:#36acaa">$host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Real-IP </span><span class="token variable" style="color:#36acaa">$remote_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-For </span><span class="token variable" style="color:#36acaa">$proxy_add_x_forwarded_for</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-Host </span><span class="token variable" style="color:#36acaa">$host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-Proto </span><span class="token variable" style="color:#36acaa">$scheme</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://127.0.0.1:8080</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page  </span><span class="token number" style="color:#36acaa">404</span><span class="token plain">              /404.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># redirect server error pages to the static page /50x.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page   </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Restart Nginx</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Rebuild keycloak for production</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/keycloak-20.0.1/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./kc.sh --verbose build</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Change in <strong>“/usr/lib/systemd/system”</strong> the file named <strong>“keycloak.service”</strong> with this content</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">keycloak </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/home/sysop/H/keycloak-20.0.1/bin/kc.sh start --proxy edge --hostname-strict</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/var/log/keycloak.log </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PIDFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/run/keycloak.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Enable and activate the service</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart keycloak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apisix-api-gateway">Apisix API Gateway<a aria-hidden="true" class="hash-link" href="#apisix-api-gateway" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="addresses-for-apisix-dashboard">Addresses for apisix-dashboard<a aria-hidden="true" class="hash-link" href="#addresses-for-apisix-dashboard" title="Direct link to heading">​</a></h3><p>The address used is the exsternal address o the <strong>hsrv</strong> machine</p><p>In the <strong>&quot;/etc/hosts&quot;</strong> file of any machine accessing the cluster through the nginx reverse proxy add the line</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.100.20 apisix apisix.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>In the DNS server on <strong>hserv</strong> add the apisix entry in the <strong>“h.net”</strong> DNS zone with address <strong>“192.168.100.20”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fAqZA2hy_7%20dns02.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fAqZA2hy_7%20dns02.webp, https://static.apiseven.com/uploads/2023/01/20/fAqZA2hy_7%20dns02.png" alt="dns02" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fAqZA2hy_7%20dns02.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fAqZA2hy_7%20dns02.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fAqZA2hy_7%20dns02.png" alt="dns02" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fAqZA2hy_7%20dns02.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apisix-deployment">APISIX Deployment<a aria-hidden="true" class="hash-link" href="#apisix-deployment" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hdev</strong></p></blockquote><p>create a namespace for apisix</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create ns apisix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Add apisix helm repo</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> ~/H/software/apisisx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/software/apisisx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> apisix https://charts.apiseven.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm repo list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>work on <strong>hserv</strong></p></blockquote><p>On <strong>“hserv”</strong> create the CA kubernetes secret (make readable hservca.key)</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/hservcerts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -lh hservca.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n apisix create secret generic hservcacert --from-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cert</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">./hservca.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe secret hservcacert -n apisix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>work on <strong>hdev</strong></p></blockquote><p>Get the core_dns service address and port (in this example 10.43.0.10:53)</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hdev:~/H/software/apisisx$ kubectl get svc -n kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME              TYPE           CLUSTER-IP     EXTERNAL-IP                                                   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                  AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-dns          ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.0.10     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">53</span><span class="token plain">/UDP,53/TCP,9153/TCP   97d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metrics-server    ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.64.71    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                  97d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-registry   LoadBalancer   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.183.18   </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.21,192.168.101.22,192.168.101.23,192.168.101.24   </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">:31397/TCP           92d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hdev:~/H/software/apisisx$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Get the apisic helm chart the default values and put the output in a file named <strong>apisix-values.yaml</strong> then edit this file</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> ~/H/software/apisisx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm show values apisix/apisix </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> apisix-values.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> apisix-values.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>You have to change:</p><ul><li>the gateway type to <strong>LoadBalancer</strong> (my home lab is powered off every day and with the default gateway type of NodePort the Apisix gateway starts every day on a different node changing IP address)</li><li>set the <strong>tls</strong> section to use the kubernetes secret with the private CA reference</li><li>set the discovery section to use the kube-dns address found before (doing this enables apisix upstream definition to use the service name instead of the IP address)</li><li>set a session secret in the httpSrv section as a workaround cited in the <a href="https://github.com/apache/apisix/pull/8068" target="_blank" rel="noopener noreferrer">#8068</a> feature request</li><li>enable (set to true) apisix dashboard and ingress-controller</li></ul><p>The relevant tiles changed are:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">gateway:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: LoadBalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    servicePort: </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    containerPort: </span><span class="token number" style="color:#36acaa">9443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    existingCASecret: </span><span class="token string" style="color:#e3116c">&quot;hservcacert&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    certCAFilename: </span><span class="token string" style="color:#e3116c">&quot;cert&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">discovery:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        servers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - </span><span class="token string" style="color:#e3116c">&quot;10.43.0.10:53&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   httpSrv: </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">set</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$session_secret</span><span class="token plain"> 0123456789a5bac9bb3c868ec8b202e93</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-controller:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled: </span><span class="token boolean" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Install apisix using the new values.yaml file</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> apisix apisix/apisix -f apisix-values.yaml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--set ingress-controller.config.apisix.serviceNamespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">apisix </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--set ingress-controller.config.apisix.serviceName</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">apisix-admin </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--set ingress-controller.config.kubernetes.apisixRouteVersion</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">apisix.apache.org/v2beta3 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--namespace apisix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Wait for the pods to start (it can take some time)</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n apisix </span><span class="token function" style="color:#d73a49">wait</span><span class="token plain"> --for</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Ready pods --all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods -n apisix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>When all the Apisix pods will be in <strong>Running</strong> state the installation is completed</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="accessing-apisix-dashboard">Accessing APISIX Dashboard<a aria-hidden="true" class="hash-link" href="#accessing-apisix-dashboard" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hdev</strong></p></blockquote><p>Port forward apisix-dashboard</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n apisix port-forward service/apisix-dashboard </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The command output should be something like</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hdev:~$ kubectl -n apisix port-forward service/apisix-dashboard </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:8080 -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">::1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:8080 -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Then access the dashboard on <strong>“hdev”</strong> pointing the web browser to the url “http://localhost:9090”
Login with <strong>“admin / admin”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/INeavn6G_8%20ad01.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/INeavn6G_8%20ad01.webp, https://static.apiseven.com/uploads/2023/01/20/INeavn6G_8%20ad01.png" alt="ad01" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/INeavn6G_8%20ad01.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/INeavn6G_8%20ad01.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/INeavn6G_8%20ad01.png" alt="ad01" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/INeavn6G_8%20ad01.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Verify the dashboard version</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2lzTvaa8_9ad02.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2lzTvaa8_9ad02.webp, https://static.apiseven.com/uploads/2023/01/20/2lzTvaa8_9ad02.png" alt="ad02" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2lzTvaa8_9ad02.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2lzTvaa8_9ad02.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2lzTvaa8_9ad02.png" alt="ad02" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2lzTvaa8_9ad02.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-apisix-resources-for-apisix-dashboard">Create Apisix resources for apisix-dashboard<a aria-hidden="true" class="hash-link" href="#create-apisix-resources-for-apisix-dashboard" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-the-certificate-for-apisixhnet">Create the certificate for <strong>&quot;apisix.h.net&quot;</strong><a aria-hidden="true" class="hash-link" href="#create-the-certificate-for-apisixhnet" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p></blockquote><p>In the “~/H/hservcerts/” folder create the key and certificate for apisix.h.net</p><p>Create a file called <strong>&quot;apisixssl.cnf&quot;</strong> containing</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_bits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distinguished_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req_distinguished_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">req_distinguished_name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Italy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Rome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">O </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Busico Mirto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OU </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Laboratory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CN </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apisix.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v3_ca</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subjectAltName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> @alt_names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">alt_names</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apisix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># other names</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apisix.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apisix.ext.h.net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DNS.4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apisix.int.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the server private key and csr</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl req -new -sha256 -nodes -newkey rsa:2048 -keyout apisix.key -out apisix.csr -config apisixssl.cnf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create the certificate file.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> openssl x509 -req -in apisix.csr -CA hservca.pem -CAkey hservca.key -CAcreateserial -out apisix.crt -sha256 -days </span><span class="token number" style="color:#36acaa">3650</span><span class="token plain"> -extfile apisixssl.cnf -extensions v3_ca</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Change the access rights for apisix key to permit nginx access</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> a+r apisix.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apply-certificates-nginx-and-enable-https">Apply certificates Nginx and enable HTTPS<a aria-hidden="true" class="hash-link" href="#apply-certificates-nginx-and-enable-https" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p></blockquote><p>Create the root directory for apisix under nginx and create an index.html file in that directory</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /usr/share/nginx/apisix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">777</span><span class="token plain"> /usr/share/nginx/apisix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> /usr/share/nginx/apisix/index.html</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create a <strong>index.html</strong> file containing</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">DOCTYPE html</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">html</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">text</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">apisix https default page</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/text</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/html</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>In the directory <strong>“/etc/nginx/conf.d”</strong> create the file named <strong>“apisix.conf”</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/nginx/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> apisix.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Put in the <strong>“apisix.conf”</strong> file this content</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> ssl http2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name apisix.h.net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root   /usr/share/nginx/apisix</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log  /var/log/nginx/apisix.access.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_log  /var/log/nginx/apisix.error.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate     /home/sysop/H/hservcerts/apisix.crt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key /home/sysop/H/hservcerts/apisix.key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index  index.html index.htm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page  </span><span class="token number" style="color:#36acaa">404</span><span class="token plain">              /404.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># redirect server error pages to the static page /50x.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page   </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Restart Nginx</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Add the apisix line in “/etc/hosts” on any machine that will access apisix-dashboard</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.100.20 apisix.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Add the apisix A record in the DNS in “h.net” zone</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/sXSh4zpz_10ad03.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/sXSh4zpz_10ad03.webp, https://static.apiseven.com/uploads/2023/01/20/sXSh4zpz_10ad03.png" alt="ad03" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/sXSh4zpz_10ad03.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/sXSh4zpz_10ad03.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/sXSh4zpz_10ad03.png" alt="ad03" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/sXSh4zpz_10ad03.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Access “<a href="https://apisix.h.net%E2%80%9D" target="_blank" rel="noopener noreferrer">https://apisix.h.net”</a> from a browser and the apisix default page should be presented</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-the-load-balancer-definition">Create the load balancer definition<a aria-hidden="true" class="hash-link" href="#create-the-load-balancer-definition" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p></blockquote><p>In the directory <strong>“/etc/nginx/conf.d”</strong> modify the file <strong>“apisix.conf”</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/nginx/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> apisix.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Put in the file this content</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">upstream hcluster </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.22:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.23:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.24:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> ssl http2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name apisix.h.net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root   /usr/share/nginx/apisix</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_log  /var/log/nginx/apisix.access.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_log  /var/log/nginx/apisix.error.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate     /home/sysop/H/hservcerts/apisix.crt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl_certificate_key /home/sysop/H/hservcerts/apisix.key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_busy_buffers_size   512k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_buffers   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> 512k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_buffer_size   256k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header Host </span><span class="token variable" style="color:#36acaa">$host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_ssl_server_name on</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_ssl_name apisix.h.net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Real-IP </span><span class="token variable" style="color:#36acaa">$remote_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-For </span><span class="token variable" style="color:#36acaa">$proxy_add_x_forwarded_for</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-Host </span><span class="token variable" style="color:#36acaa">$host</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_set_header X-Forwarded-Proto </span><span class="token variable" style="color:#36acaa">$scheme</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass https://hcluster</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page  </span><span class="token number" style="color:#36acaa">404</span><span class="token plain">              /404.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># redirect server error pages to the static page /50x.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_page   </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">502</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">503</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        root   /usr/share/nginx/html</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p><strong>Note:</strong></p><p>the lines</p></blockquote><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">upstream hcluster </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.22:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.23:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.24:443</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>use the internal address of the three kubernetes worker nodes and it is necessary to specify the 443 port to enable https traffic</p><p>The lines</p></blockquote><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_busy_buffers_size   512k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_buffers   </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> 512k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proxy_buffer_size   256k</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>are required because, after the Keycloak authentication, the apisix server replyes with the state in the URL.</p><p>With the default values nginx replies with a &quot;response too big&quot; error</p></blockquote><p>Restart Nginx</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl restart nginx</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Access “<a href="https://apisix.h.net%E2%80%9D" target="_blank" rel="noopener noreferrer">https://apisix.h.net”</a> from a browser. You should receive page not found error because there is no route in Apisix</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-apisix-dashboard-route-and-upstream-with-apisix-dashboard">Create “apisix-dashboard” route and upstream with apisix-dashboard<a aria-hidden="true" class="hash-link" href="#create-apisix-dashboard-route-and-upstream-with-apisix-dashboard" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hdev</strong></p></blockquote><p>port forward apisix-dashboard and access it at “http://localhost:9090” and login with <strong>“admin” / &quot;admin“</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n apisix port-forward service/apisix-dashboard </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Find the apisix-dashboard service name and port</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hdev:~/H/hservcerts$ kubectl get svc -n apisix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP                                                   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-etcd-headless        ClusterIP      None            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">2379</span><span class="token plain">/TCP,2380/TCP            12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-etcd                 ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.75.4      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">2379</span><span class="token plain">/TCP,2380/TCP            12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-ingress-controller   ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.170.105   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP                       12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-dashboard            ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.48.202    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP                       12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-admin                ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.169.123   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                                                        </span><span class="token number" style="color:#36acaa">9180</span><span class="token plain">/TCP                     12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apisix-gateway              LoadBalancer   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.161.47    </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.101.21,192.168.101.22,192.168.101.23,192.168.101.24   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:30508/TCP,443:32653/TCP   12h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hdev:~/H/hservcerts$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Create an upstream</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/awmMSYaW_11ad04.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/awmMSYaW_11ad04.webp, https://static.apiseven.com/uploads/2023/01/20/awmMSYaW_11ad04.png" alt="ad04" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/awmMSYaW_11ad04.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/awmMSYaW_11ad04.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/awmMSYaW_11ad04.png" alt="ad04" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/awmMSYaW_11ad04.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Set the name to <strong>“apisix-dashboard”</strong>, upstream type to <strong>“service discovery”</strong>, discovery type to <strong>“dns”</strong> and servicename to <strong>“apisix-dashboard.apisix.svc.cluster.local:80”</strong>.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HAQw19MF_12ad05.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/HAQw19MF_12ad05.webp, https://static.apiseven.com/uploads/2023/01/20/HAQw19MF_12ad05.png" alt="ad05" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/HAQw19MF_12ad05.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HAQw19MF_12ad05.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HAQw19MF_12ad05.png" alt="ad05" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HAQw19MF_12ad05.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Then click “Next” and after click “Submit”</p><p>Click “View” to see the json upstream definition</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2K7p0bZi_13ad06.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2K7p0bZi_13ad06.webp, https://static.apiseven.com/uploads/2023/01/20/2K7p0bZi_13ad06.png" alt="ad06" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2K7p0bZi_13ad06.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2K7p0bZi_13ad06.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2K7p0bZi_13ad06.png" alt="ad06" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2K7p0bZi_13ad06.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Note the upstream name to be used in the next route definition</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TduSqV0m_14ad07.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TduSqV0m_14ad07.webp, https://static.apiseven.com/uploads/2023/01/20/TduSqV0m_14ad07.png" alt="ad07" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TduSqV0m_14ad07.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TduSqV0m_14ad07.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TduSqV0m_14ad07.png" alt="ad07" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TduSqV0m_14ad07.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Now click “Create” on the “Route” page</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fuSqIVlL_15ad08.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fuSqIVlL_15ad08.webp, https://static.apiseven.com/uploads/2023/01/20/fuSqIVlL_15ad08.png" alt="ad08" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fuSqIVlL_15ad08.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fuSqIVlL_15ad08.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fuSqIVlL_15ad08.png" alt="ad08" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fuSqIVlL_15ad08.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create a route (&quot;Define api request&quot; - on top): set name to “apisix-dashboard” and add a description</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TEQaia56_16ad09.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TEQaia56_16ad09.webp, https://static.apiseven.com/uploads/2023/01/20/TEQaia56_16ad09.png" alt="ad09" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TEQaia56_16ad09.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TEQaia56_16ad09.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TEQaia56_16ad09.png" alt="ad09" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TEQaia56_16ad09.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create a route (&quot;Define api request&quot; - below): set host to <strong>“apisix.h.net”</strong> and path to <strong>“/*”</strong>. Then click <strong>“Next”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/U2C0nK9H_17ad10.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/U2C0nK9H_17ad10.webp, https://static.apiseven.com/uploads/2023/01/20/U2C0nK9H_17ad10.png" alt="ad10" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/U2C0nK9H_17ad10.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/U2C0nK9H_17ad10.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/U2C0nK9H_17ad10.png" alt="ad10" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/U2C0nK9H_17ad10.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Select the previous defined “apisix” upstream from the dropdown list. Then click “Next”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/aTCu1mIe_18ad11.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/aTCu1mIe_18ad11.webp, https://static.apiseven.com/uploads/2023/01/20/aTCu1mIe_18ad11.png" alt="ad11" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/aTCu1mIe_18ad11.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/aTCu1mIe_18ad11.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/aTCu1mIe_18ad11.png" alt="ad11" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/aTCu1mIe_18ad11.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>For now don’t use plugins and click “Next”. Then click “Submit”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/Z6m7MicN_19ad12.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/Z6m7MicN_19ad12.webp, https://static.apiseven.com/uploads/2023/01/20/Z6m7MicN_19ad12.png" alt="ad12" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/Z6m7MicN_19ad12.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/Z6m7MicN_19ad12.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/Z6m7MicN_19ad12.png" alt="ad12" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/Z6m7MicN_19ad12.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="enable-https-in-apisix">Enable https in apisix<a aria-hidden="true" class="hash-link" href="#enable-https-in-apisix" title="Direct link to heading">​</a></h3><blockquote><p>Work on <strong>hserv</strong></p></blockquote><p>Copy the certificates from hserv to hdev. From hserv:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hserv:~$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ~/H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sysop@hserv:~/H$ </span><span class="token function" style="color:#d73a49">rsync</span><span class="token plain"> -vau --stats ./hservcerts/* hdev.int.h.net://home/sysop/H/hservcerts/</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>Work on <strong>hdev</strong></p></blockquote><p>Port forward apisix-dashboard and access it ah “http://localhost:9090” and login with <strong>“admin” / &quot;admin“</strong></p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n apisix port-forward service/apisix-dashboard </span><span class="token number" style="color:#36acaa">9090</span><span class="token plain">:80</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Select the “SSL” page and click Create</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dEVd2rD6_20ad14.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/dEVd2rD6_20ad14.webp, https://static.apiseven.com/uploads/2023/01/20/dEVd2rD6_20ad14.png" alt="ad14" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/dEVd2rD6_20ad14.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dEVd2rD6_20ad14.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dEVd2rD6_20ad14.png" alt="ad14" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dEVd2rD6_20ad14.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Select <strong>“Way: Upload”</strong>, then click <strong>“upload certificate”</strong> and <strong>“upload key”</strong>. Clik “Next” (Take certificate and key files from <strong>~/H/hservcerts</strong>)</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/cBHW3QQH_21ad15.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/cBHW3QQH_21ad15.webp, https://static.apiseven.com/uploads/2023/01/20/cBHW3QQH_21ad15.png" alt="ad15" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/cBHW3QQH_21ad15.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/cBHW3QQH_21ad15.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/cBHW3QQH_21ad15.png" alt="ad15" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/cBHW3QQH_21ad15.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Preview the SSL resource and click “Submit”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5y67o7w7_22ad16.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/5y67o7w7_22ad16.webp, https://static.apiseven.com/uploads/2023/01/20/5y67o7w7_22ad16.png" alt="ad16" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/5y67o7w7_22ad16.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5y67o7w7_22ad16.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5y67o7w7_22ad16.png" alt="ad16" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5y67o7w7_22ad16.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The ssl resource appear in the list (note the SNI values)</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/0QcDTVt7_23ad17.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/0QcDTVt7_23ad17.webp, https://static.apiseven.com/uploads/2023/01/20/0QcDTVt7_23ad17.png" alt="ad17" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/0QcDTVt7_23ad17.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/0QcDTVt7_23ad17.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/0QcDTVt7_23ad17.png" alt="ad17" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/0QcDTVt7_23ad17.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Configure the “apisix-dashboard” route to enable http to https redirection</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rxL1HGlY_24ad18.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/rxL1HGlY_24ad18.webp, https://static.apiseven.com/uploads/2023/01/20/rxL1HGlY_24ad18.png" alt="ad18" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/rxL1HGlY_24ad18.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rxL1HGlY_24ad18.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rxL1HGlY_24ad18.png" alt="ad18" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rxL1HGlY_24ad18.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Set the <strong>“Redirect”</strong> field to <strong>“Enable HTTPS”</strong>. Then click “Next” until you see “Submit”. Click “Submit”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/iD0XRe4A_25ad19.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/iD0XRe4A_25ad19.webp, https://static.apiseven.com/uploads/2023/01/20/iD0XRe4A_25ad19.png" alt="ad19" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/iD0XRe4A_25ad19.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/iD0XRe4A_25ad19.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/iD0XRe4A_25ad19.png" alt="ad19" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/iD0XRe4A_25ad19.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>View the route configuration and verify that the redirect plugin is enabled</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/8I9QKdZj_26ad20.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/8I9QKdZj_26ad20.webp, https://static.apiseven.com/uploads/2023/01/20/8I9QKdZj_26ad20.png" alt="ad20" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/8I9QKdZj_26ad20.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/8I9QKdZj_26ad20.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/8I9QKdZj_26ad20.png" alt="ad20" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/8I9QKdZj_26ad20.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Now from any machine you can access the apisix-dashboard at the url <strong>“<a href="https://apisix.h.net%E2%80%9D" target="_blank" rel="noopener noreferrer">https://apisix.h.net”</a></strong> and verify that the apisix-dashboard login page is showed</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WYwVhc6V_27ad21.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/WYwVhc6V_27ad21.webp, https://static.apiseven.com/uploads/2023/01/20/WYwVhc6V_27ad21.png" alt="ad21" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/WYwVhc6V_27ad21.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WYwVhc6V_27ad21.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WYwVhc6V_27ad21.png" alt="ad21" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WYwVhc6V_27ad21.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Login with “admin” / “admin”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/33gBSogM_28ad22.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/33gBSogM_28ad22.webp, https://static.apiseven.com/uploads/2023/01/20/33gBSogM_28ad22.png" alt="ad22" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/33gBSogM_28ad22.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/33gBSogM_28ad22.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/33gBSogM_28ad22.png" alt="ad22" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/33gBSogM_28ad22.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="create-keycloak-definitions-for-openid-connect">Create Keycloak Definitions for OpenID-Connect<a aria-hidden="true" class="hash-link" href="#create-keycloak-definitions-for-openid-connect" title="Direct link to heading">​</a></h4><blockquote><p>Work on any machine</p></blockquote><p>Working on any machine, access the keycloak console at  “<a href="https://k6k.h.net%E2%80%9D" target="_blank" rel="noopener noreferrer">https://k6k.h.net”</a> and login with “admin” / &quot;1357Togo“</p><p>Click “Create Realm”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rgM4S46s_29k6k04.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/rgM4S46s_29k6k04.webp, https://static.apiseven.com/uploads/2023/01/20/rgM4S46s_29k6k04.png" alt="k6k04" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/rgM4S46s_29k6k04.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rgM4S46s_29k6k04.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rgM4S46s_29k6k04.png" alt="k6k04" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/rgM4S46s_29k6k04.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create a realm named <strong>“hcluster_admins”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WGPQt7eY_30k6k05.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/WGPQt7eY_30k6k05.webp, https://static.apiseven.com/uploads/2023/01/20/WGPQt7eY_30k6k05.png" alt="k6k05" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/WGPQt7eY_30k6k05.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WGPQt7eY_30k6k05.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WGPQt7eY_30k6k05.png" alt="k6k05" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/WGPQt7eY_30k6k05.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create a client named <strong>“hcadmins”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/nSIDqrMz_31k6k06.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/nSIDqrMz_31k6k06.webp, https://static.apiseven.com/uploads/2023/01/20/nSIDqrMz_31k6k06.png" alt="k6k06" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/nSIDqrMz_31k6k06.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/nSIDqrMz_31k6k06.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/nSIDqrMz_31k6k06.png" alt="k6k06" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/nSIDqrMz_31k6k06.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Verify that the client protocol is <strong>“openid-connect”</strong> and click “Next”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5FMWvLiZ_32k6k07.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/5FMWvLiZ_32k6k07.webp, https://static.apiseven.com/uploads/2023/01/20/5FMWvLiZ_32k6k07.png" alt="k6k07" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/5FMWvLiZ_32k6k07.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5FMWvLiZ_32k6k07.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5FMWvLiZ_32k6k07.png" alt="k6k07" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/5FMWvLiZ_32k6k07.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Set “Client authentication” to &quot;on&quot; (means OIDC type confidential). Click “Save”</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/OPLxpYCZ_33k6k08.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/OPLxpYCZ_33k6k08.webp, https://static.apiseven.com/uploads/2023/01/20/OPLxpYCZ_33k6k08.png" alt="k6k08" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/OPLxpYCZ_33k6k08.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/OPLxpYCZ_33k6k08.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/OPLxpYCZ_33k6k08.png" alt="k6k08" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/OPLxpYCZ_33k6k08.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>In <strong>“Cient details”</strong>, <strong>“Settings”</strong> tab, <strong>“access settings”</strong> section, set <strong>“Valid redirect URI”</strong> to <strong>“*”</strong>. Click <strong>“Save”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/ZtOy06uu_34k6k09.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/ZtOy06uu_34k6k09.webp, https://static.apiseven.com/uploads/2023/01/20/ZtOy06uu_34k6k09.png" alt="k6k09" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/ZtOy06uu_34k6k09.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/ZtOy06uu_34k6k09.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/ZtOy06uu_34k6k09.png" alt="k6k09" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/ZtOy06uu_34k6k09.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Create a new user</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2MPpK4Xw_35k6k10.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2MPpK4Xw_35k6k10.webp, https://static.apiseven.com/uploads/2023/01/20/2MPpK4Xw_35k6k10.png" alt="k6k10" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/2MPpK4Xw_35k6k10.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2MPpK4Xw_35k6k10.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2MPpK4Xw_35k6k10.png" alt="k6k10" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/2MPpK4Xw_35k6k10.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Set the username to <strong>“hcadmin”</strong> and click <strong>“Create”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/28/YEwkpnnp_k6k11.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/28/YEwkpnnp_k6k11.webp, https://static.apiseven.com/uploads/2023/01/28/YEwkpnnp_k6k11.png" alt="k6k11" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/28/YEwkpnnp_k6k11.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/28/YEwkpnnp_k6k11.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/28/YEwkpnnp_k6k11.png" alt="k6k11" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/28/YEwkpnnp_k6k11.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>In the <strong>“Credentials”</strong> tab click <strong>“Set password”</strong> (same procedure for &quot;Reset&quot; password)</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HzbaXwUN_37k6k12.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/HzbaXwUN_37k6k12.webp, https://static.apiseven.com/uploads/2023/01/20/HzbaXwUN_37k6k12.png" alt="k6k12" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/HzbaXwUN_37k6k12.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HzbaXwUN_37k6k12.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HzbaXwUN_37k6k12.png" alt="k6k12" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/HzbaXwUN_37k6k12.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Set a permanent (Temporary set to Off) password to <strong>“hcadmin”</strong> (equal to the username)</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fS53TVta_38k6k13.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fS53TVta_38k6k13.webp, https://static.apiseven.com/uploads/2023/01/20/fS53TVta_38k6k13.png" alt="k6k13" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fS53TVta_38k6k13.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fS53TVta_38k6k13.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fS53TVta_38k6k13.png" alt="k6k13" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fS53TVta_38k6k13.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="get-client-id-and-secret">Get Client ID and Secret<a aria-hidden="true" class="hash-link" href="#get-client-id-and-secret" title="Direct link to heading">​</a></h4><p>Select <strong>hcadmins</strong> client. Go to <strong>Credentials</strong> tab; show the Secret and copy the client id and secret to be used in the next steps</p><p>client ID: <strong>hcadmins</strong></p><p>Secret: <strong>MoqLUhwgsEDi36II0KuJldKq4YGLHxl3</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TSporVZx_39k6k14.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TSporVZx_39k6k14.webp, https://static.apiseven.com/uploads/2023/01/20/TSporVZx_39k6k14.png" alt="k6k14" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/TSporVZx_39k6k14.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TSporVZx_39k6k14.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TSporVZx_39k6k14.png" alt="k6k14" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/TSporVZx_39k6k14.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>In the <strong>“Realm settings”</strong>, <strong>“General”</strong> tab click on the link <strong>“OpenID Endpoint Configuration”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/MiFQHqS0_40k6k15.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/MiFQHqS0_40k6k15.webp, https://static.apiseven.com/uploads/2023/01/20/MiFQHqS0_40k6k15.png" alt="k6k15" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/MiFQHqS0_40k6k15.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/MiFQHqS0_40k6k15.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/MiFQHqS0_40k6k15.png" alt="k6k15" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/MiFQHqS0_40k6k15.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>This is the shown page</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/IQDtB8NP_41k6k16.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/IQDtB8NP_41k6k16.webp, https://static.apiseven.com/uploads/2023/01/20/IQDtB8NP_41k6k16.png" alt="k6k16" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/IQDtB8NP_41k6k16.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/IQDtB8NP_41k6k16.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/IQDtB8NP_41k6k16.png" alt="k6k16" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/IQDtB8NP_41k6k16.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Copy the link</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">https://k6k.h.net/realms/hcluster_admins/.well-known/openid-configuration</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Prepare a json client definition using the previous copied information</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;client_id&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;hcadmins&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;client_secret&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;MoqLUhwgsEDi36II0KuJldKq4YGLHxl3&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;discovery&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;https://k6k.h.net/realms/hcluster_admins/.well-known/openid-configuration&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;scope&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;openid profile&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;bearer_only&quot;</span><span class="token plain">:false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;realm&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;hcluster_admins&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;introspection_endpoint_auth_method&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;client_secret_post&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;redirect_uri&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;https://apisix.h.net/*&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;access_token_in_authorization_header&quot;</span><span class="token plain">:true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="openid-connect-for-apisix-dashboard">OpenID-Connect for APISIX Dashboard<a aria-hidden="true" class="hash-link" href="#openid-connect-for-apisix-dashboard" title="Direct link to heading">​</a></h4><blockquote><p>Work on any machine</p></blockquote><p>Configure the apisix-dashboard route.</p><p>Go to <strong>“3 Plugin config”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fRBFq9qA_42ad23.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fRBFq9qA_42ad23.webp, https://static.apiseven.com/uploads/2023/01/20/fRBFq9qA_42ad23.png" alt="ad23" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fRBFq9qA_42ad23.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fRBFq9qA_42ad23.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fRBFq9qA_42ad23.png" alt="ad23" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fRBFq9qA_42ad23.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Click <strong>“Enable”</strong> on openid-connect plugin (if you have already defined the plugin you&#x27;ll see &quot;Edit&quot; instead of &quot;Enable&quot;)</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/yh2HtjSR_43ad24.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/yh2HtjSR_43ad24.webp, https://static.apiseven.com/uploads/2023/01/20/yh2HtjSR_43ad24.png" alt="ad24" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/yh2HtjSR_43ad24.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/yh2HtjSR_43ad24.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/yh2HtjSR_43ad24.png" alt="ad24" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/yh2HtjSR_43ad24.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Enable the plugin. Copy the previous defined json definition and click <strong>“Submit”</strong></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/DSqrLV7K_44ad25.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/DSqrLV7K_44ad25.webp, https://static.apiseven.com/uploads/2023/01/20/DSqrLV7K_44ad25.png" alt="ad25" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/DSqrLV7K_44ad25.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/DSqrLV7K_44ad25.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/DSqrLV7K_44ad25.png" alt="ad25" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/DSqrLV7K_44ad25.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Clik &quot;next&quot; and then clik &quot;Submit&quot; to complete the route configuration</p><p>Then &quot;view&quot; the route to see the plugin configuration</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/hFGRuPmq_45ad26.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/hFGRuPmq_45ad26.webp, https://static.apiseven.com/uploads/2023/01/20/hFGRuPmq_45ad26.png" alt="ad26" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/hFGRuPmq_45ad26.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/hFGRuPmq_45ad26.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/hFGRuPmq_45ad26.png" alt="ad26" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/hFGRuPmq_45ad26.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="accessing-the-protected-apisix-dashboard-route">Accessing the Protected APISIX Dashboard Route<a aria-hidden="true" class="hash-link" href="#accessing-the-protected-apisix-dashboard-route" title="Direct link to heading">​</a></h3><blockquote><p>Work on any machine</p></blockquote><p>Go to the URL</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">https://apisix.h.net</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>You will be redirected to the Keycloak login page for the &quot;HCLUSTER_ADMINS&quot; realm.
Login with the previous defined user &quot;hcadmin&quot; / &quot;hcadmin&quot;</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fs5u4nNI_46ad27.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fs5u4nNI_46ad27.webp, https://static.apiseven.com/uploads/2023/01/20/fs5u4nNI_46ad27.png" alt="ad27" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/fs5u4nNI_46ad27.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fs5u4nNI_46ad27.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fs5u4nNI_46ad27.png" alt="ad27" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/fs5u4nNI_46ad27.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The apisix-dashboard login will be presented. Login with &quot;admin&quot; / &quot;admin&quot;</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/RnoBom2u_47ad28.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/RnoBom2u_47ad28.webp, https://static.apiseven.com/uploads/2023/01/20/RnoBom2u_47ad28.png" alt="ad28" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/RnoBom2u_47ad28.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/RnoBom2u_47ad28.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/RnoBom2u_47ad28.png" alt="ad28" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/RnoBom2u_47ad28.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>And now you can see the apisix dashboard</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dFEXeiAE_48ad29.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/dFEXeiAE_48ad29.webp, https://static.apiseven.com/uploads/2023/01/20/dFEXeiAE_48ad29.png" alt="ad29" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/uploads/2023/01/20/dFEXeiAE_48ad29.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dFEXeiAE_48ad29.webp, https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dFEXeiAE_48ad29.png" alt="ad29" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/uploads/2023/01/20/dFEXeiAE_48ad29.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="recap">Recap<a aria-hidden="true" class="hash-link" href="#recap" title="Direct link to heading">​</a></h2><p>In this article were presented the intruction to:</p><ul><li>set up a Certification authority and create key and certificates for various sites</li><li>set up a nginx server as reverse proxy and load balancer</li><li>set up a Keycloak server accessible through a nginx reverse proxy</li><li>set up Apisix in a kubernetes cluster with ingress-controller and apisix-dashboard</li><li>set up the authentication framework in Keycloak to access the apisix-dashboard</li><li>set up the nginx load balancer for apisix-dashboard inside kubernetes</li><li>set up the apisix resources, including openid-connect plugin, to access the apisix-dashboard with authentication provided by the keycloak server</li></ul><p>Note that this set up is only for educational purpose. Do not use in production.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/ecosystem/">Ecosystem</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2023/01/18/consul-with-apisix/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">How to Integrate API Gateway and Consul? Not Consul K/V</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/12/30/release-apache-apisix-3.1.0/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">Release Apache APISIX 3.1.0</div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright © 2019-2025 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js"></script>
</body>
</html>