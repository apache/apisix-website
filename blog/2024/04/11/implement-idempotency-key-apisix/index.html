<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">Implementing the Idempotency-Key specification on Apache APISIX | Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2024/04/11/implement-idempotency-key-apisix/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="Implementing the Idempotency-Key specification on Apache APISIX | Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="Last week, I wrote an analysis of the IETF Idempotency-Key specification. The specification aims to avoid duplicated requests. In short, the idea is for the client to send a unique key along with the request: If the server doesn&#x27;t know the key, it proceeds as usual and then stores the response. If the server knows the key, it short-circuits any further processing and immediately returns the stored response. This post shows how to implement it with Apache APISIX.
"><meta data-react-helmet="true" property="og:description" content="Last week, I wrote an analysis of the IETF Idempotency-Key specification. The specification aims to avoid duplicated requests. In short, the idea is for the client to send a unique key along with the request: If the server doesn&#x27;t know the key, it proceeds as usual and then stores the response. If the server knows the key, it short-circuits any further processing and immediately returns the stored response. This post shows how to implement it with Apache APISIX.
"><meta data-react-helmet="true" name="keywords" content="APISIX,Idempotency,IETF,specification,plugin,coding"><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/uploads/2024/04/09/0rfsRevo_stormtrooper-2899993.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/uploads/2024/04/09/0rfsRevo_stormtrooper-2899993.jpg"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2024-04-11T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/nfrankel"><meta data-react-helmet="true" property="article:tag" content="Plugin"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2024/04/11/implement-idempotency-key-apisix/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2024/04/11/implement-idempotency-key-apisix/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link data-react-helmet="true" rel="canonical" href="https://blog.frankel.ch/implement-idempotency-key-apisix/"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.4bbc9839.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.a516b59b.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">ü§î Introducing APISIX AI Gateway ‚Äì Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX¬Æ" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX¬Æ" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX¬Æ</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX¬ÆÔ∏è</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX¬ÆÔ∏è Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX¬ÆÔ∏è Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX¬ÆÔ∏è Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX¬ÆÔ∏è Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX¬ÆÔ∏è Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX¬ÆÔ∏è Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX¬ÆÔ∏è Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">‰∏≠ÊñáÂçöÂÆ¢</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Implementing the Idempotency-Key specification on Apache APISIX</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2024-04-11T00:00:00.000Z" itemprop="datePublished">April 11, 2024</time> ¬∑ <!-- -->10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a href="https://github.com/nfrankel" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_KCbV" src="https://avatars.githubusercontent.com/u/752258" alt="Nicolas Fr√§nkel"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/nfrankel" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Nicolas Fr√§nkel</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div></div></header><meta itemprop="image" content="https://static.apiseven.com/uploads/2024/04/09/0rfsRevo_stormtrooper-2899993.jpg"><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p>Last week, I wrote an <a href="https://apisix.apache.org/blog/2024/04/04/fix-duplicate-api-requests/" target="_blank" rel="noopener noreferrer">analysis</a> of the <a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04" target="_blank" rel="noopener noreferrer">IETF Idempotency-Key specification</a>. The specification aims to avoid duplicated requests. In short, the idea is for the client to send a unique key along with the request:</p><ul><li>If the server doesn&#x27;t know the key, it proceeds as usual and then stores the response</li><li>If the server knows the key, it short-circuits any further processing and immediately returns the stored response</li></ul><p>This post shows how to implement it with <a href="https://apisix.apache.org/" target="_blank" rel="noopener noreferrer">Apache APISIX</a>.</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="overview">Overview<a aria-hidden="true" class="hash-link" href="#overview" title="Direct link to heading">‚Äã</a></h2><p>Before starting coding, we need to define a couple of things. Apache APISIX offers a plugin-based architecture. Hence, we will code the above logic in a plugin.</p><p>Apache APISIX builds upon OpenResty, which builds upon nginx. Each component defines phases, which map more or less across the components. For more info on phases, please see <a href="https://apisix.apache.org/blog/2023/12/14/apisix-plugins-priority-leaky-abstraction/" target="_blank" rel="noopener noreferrer">this previous post</a>.</p><p>Finally, we shall decide on a priority. Priority defines the order in which APISIX runs plugins <em>inside a phase</em>. I decided on <code>1500</code>, as all authentication plugins have a priority in the <code>2000</code> and more range, but I want to return the cached response ASAP.</p><p>The specification requires us to store data. APISIX offers many abstractions, but storage is not one of them. We need access via the idempotency key so it looks like a key-value store.</p><p>I arbitrarily chose Redis, as it&#x27;s pretty widespread <strong>and</strong> the client is already part of the APISIX distribution. Note that simple Redis doesn&#x27;t offer JSON storage; hence, I use the <code>redis-stack</code> Docker image.</p><p>The local infrastructure is the following:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apisix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apache/apisix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3.9.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./apisix/config.yml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/usr/local/apisix/conf/config.yaml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./apisix/apisix.yml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/usr/local/apisix/conf/apisix.yaml</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro </span><span class="token comment" style="color:#999988;font-style:italic">#1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./plugin/src</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/opt/apisix/plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ro                  </span><span class="token comment" style="color:#999988;font-style:italic">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;9080:9080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis/redis</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">7.2.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">v9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8001:8001&quot;</span><span class="token plain">                                          </span><span class="token comment" style="color:#999988;font-style:italic">#3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Static route configuration</li><li>Path to our future plugin</li><li>Port of Redis Insights (GUI). Not necessary <em>per se</em>, but very useful during development for debugging</li></ol><p>The APISIX configuration is the following:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">deployment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> data_plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">role_data_plane</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config_provider</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yaml                                    </span><span class="token comment" style="color:#999988;font-style:italic">#1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apisix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extra_lua_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /opt/</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">.lua                                 </span><span class="token comment" style="color:#999988;font-style:italic">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> idempotency                    </span><span class="token comment" style="color:#999988;font-style:italic"># priority: 1500          #3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">plugin_attr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">                                                 </span><span class="token comment" style="color:#999988;font-style:italic">#4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">idempotency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> redis                                              </span><span class="token comment" style="color:#999988;font-style:italic">#5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Configure APISIX for static routes configuration</li><li>Configure the location of our plugin</li><li>Custom plugins need to be explicitly declared. The priority comment is not required but is good practice and improves maintainability</li><li>Common plugin configuration across all routes</li><li>See below</li></ol><p>Finally, we declare our single route:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">idempotency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null important">~</span><span class="token plain">                                         </span><span class="token comment" style="color:#999988;font-style:italic">#1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">upstream</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">&quot;httpbin.org:80&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#END                                                         #3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Declare the plugin that we are going to create</li><li>httpbin is a useful upstream as we can try different URIs and methods</li><li>Mandatory for static routes configuration!</li></ol><p>With this infrastructure in place, we can start the implementation.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="laying-out-the-plugin">Laying out the plugin<a aria-hidden="true" class="hash-link" href="#laying-out-the-plugin" title="Direct link to heading">‚Äã</a></h2><p>The foundations of an Apache APISIX plugin are pretty basic:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local plugin_name = &quot;idempotency&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local _M = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version = 1.0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority = 1500,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema = {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = plugin_name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return _M</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The next step is configuration, <em>e.g.</em> Redis host and port. For starters, we shall offer a single Redis configuration across all routes. That&#x27;s the idea behind the <code>plugin_attr</code> section in the <code>config.yaml</code> file: common configuration. Let&#x27;s flesh out our plugin:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local core = require(&quot;apisix.core&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local plugin = require(&quot;apisix.plugin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local attr_schema = {                                       --1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = &quot;object&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    properties = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type = &quot;string&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description = &quot;Redis host&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default = &quot;localhost&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            type = &quot;integer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description = &quot;Redis port&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default = 6379,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local attr = plugin.plugin_attr(plugin_name) or {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = core.schema.check(attr_schema, attr)    --2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        core.log.error(&quot;Failed to check the plugin_attr[&quot;, plugin_name, &quot;]&quot;, &quot;: &quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Define the shape of the configuration</li><li>Check the configuration is valid</li></ol><p>Because I defined default values in the plugin, I can override only the <code>host</code> to <code>redis</code> to run inside my Docker Compose infrastructure and use the default port.</p><p>Next, I need to create the Redis client. Note that the platform prevents me from connecting in any phase after the rewrite/access section. Hence, I&#x27;ll create it in the <code>init()</code> method and keep it until the end.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local redis_new = require(&quot;resty.redis&quot;).new                --1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis = redis_new()                                     --2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis:set_timeout(1000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = redis:connect(attr.host, attr.port)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not ok then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        core.log.error(&quot;Failed to connect to Redis: &quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Reference the <code>new</code> function of the OpenResty Redis module</li><li>Call it to get an instance</li></ol><p>The Redis client is now available in the <code>redis</code> variable throughout the rest of the plugin execution cycle.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="implementing-the-nominal-path">Implementing the nominal path<a aria-hidden="true" class="hash-link" href="#implementing-the-nominal-path" title="Direct link to heading">‚Äã</a></h2><p>In my previous software engineer life, I usually implemented the nominal path first. Afterward, I made the code more robust by managing error cases individually. This way, if I had to release at any point, I would still deliver business values - with warnings. I shall approach this mini-project the same way.</p><p>The pseudo-algorithm on the nominal path looks like the following:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">DO extract idempotency key from request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DO </span><span class="token function" style="color:#d73a49">look</span><span class="token plain"> up value from Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IF value doesn&#x27;t exist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DO </span><span class="token builtin class-name">set</span><span class="token plain"> key </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> Redis with empty value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ELSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RETURN cached response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DO forward to upstream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DO store response </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RETURN response</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>We need to map the logic to the phase I mentioned above. Two phases are available before the upstream, <code>rewrite</code> and <code>access</code>; three after, <code>header_filter</code>, <code>body_filter</code> and <code>log</code>. The <code>access</code> phase seemed obvious for work before, but I needed to figure out between the three others. I randomly chose the <code>body_filter</code>, but I&#x27;m more than willing to listen to sensible arguments for other phases.</p><p>Note that I removed logs to make the code more readable. Error and informational logs are necessary to ease debugging production issues.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.access(conf, ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local idempotency_key = core.request.header(ctx, &quot;Idempotency-Key&quot;) --1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local redis_key = &quot;idempotency#&quot; .. idempotency_key     --2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local resp, err = redis:hgetall(redis_key)              --3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if next(resp) == nil then                               --4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local resp, err = redis:hset(redis_key, &quot;request&quot;, true ) --4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if not resp then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local data = normalize_hgetall_result(resp)         --5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local response = core.json.decode(data[&quot;response&quot;]) --6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local body = response[&quot;body&quot;]                       --7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local status_code = response[&quot;status&quot;]              --7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local headers = response[&quot;headers&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for k, v in pairs(headers) do                       --7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            core.response.set_header(k, v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return core.response.exit(status_code, body)        --8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Extract the idempotency key from the request</li><li>Prefix the key so we avoid potential collisions</li><li>Get the data set stored in Redis under the idempotency key</li><li>If the key is not found, store it with a boolean mark</li><li>Transform the data in a Lua table via a custom utility function</li><li>The response is stored in JSON format to account for headers</li><li>Reconstruct the response</li><li>Return the reconstructed response to the client. Note the <code>return</code> statement: APISIX skips the later lifecycle phases</li></ol><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.body_filter(conf, ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local idempotency_key = core.request.header(ctx, &quot;Idempotency-Key&quot;) --1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local redis_key = &quot;idempotency#&quot; .. idempotency_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if core.response then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local response = {                                  --2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = ngx.status,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            body = core.response.hold_body_chunk(ctx, true),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers = ngx.resp.get_headers()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local redis_key = &quot;idempotency#&quot; .. redis_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local resp, err = red:set(redis_key, &quot;response&quot;, core.json.encode(response)) --3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if not resp then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Extract the idempotency key from the request</li><li>Arrange the different elements of a response in a Lua table</li><li>Store the JSON-encoded response in a Redis set</li></ol><p>Tests reveal that it works as expected.
Try:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK bash"><pre tabindex="0" class="prism-code language-bash codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i -X POST -H </span><span class="token string" style="color:#e3116c">&#x27;Idempotency-Key: A&#x27;</span><span class="token plain"> localhost:9080/response-headers</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">?freeform</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i -H </span><span class="token string" style="color:#e3116c">&#x27;Idempotency-Key: B&#x27;</span><span class="token plain"> localhost:9080/status/250</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i -H </span><span class="token string" style="color:#e3116c">&#x27;Idempotency-Key: C&#x27;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&#x27;foo: bar&#x27;</span><span class="token plain">  localhost:9080/status/250</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Also, try to reuse a mismatched idempotency key, <em>e.g.</em>, <code>A</code>, for the third request. As we haven&#x27;t implemented any error management yet, you&#x27;ll get the cached response for another request. It&#x27;s time to up our game.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="implementing-error-paths">Implementing error paths<a aria-hidden="true" class="hash-link" href="#implementing-error-paths" title="Direct link to heading">‚Äã</a></h2><p>The specification defines several error paths:</p><ul><li>Idempotency-Key is missing</li><li>Idempotency-Key is already used</li><li>A request is outstanding for this Idempotency-Key</li></ul><p>Let&#x27;s implement them one by one. First, let&#x27;s check that the request has an idempotency key. Note that we can configure the plugin on a per-route basis, so if the route includes the plugin, we can conclude that it&#x27;s mandatory.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.access(conf, ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local idempotency_key = core.request.header(ctx, &quot;Idempotency-Key&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not idempotency_key then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return core.response.exit(400, &quot;This operation is idempotent and it requires correct usage of Idempotency Key&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Just return the appropriate 400 if the key is missing. That one was easy.</p><p>Checking the reuse of an existing key for a different request is slightly more involved. We first need to store the request, or more precisely, the fingerprint of what constitutes a request. Two requests are the same if they have: the same method, the same path, the same body, and the same headers. Depending on your situation, the domain (and the port) might or may not be part of them. For my simple implementation, I&#x27;ll leave it out.</p><p>There are several problems to solve. First, I didn&#x27;t find an existing API to hash the <code>core.request</code> object like there is in other languages I&#x27;m more familiar with, <em>e.g.</em>, Java&#x27;s <code>Object.hash()</code>. I decided to encode the object in JSON and hash the string. However, the existing <code>core.request</code> has sub-elements that cannot be converted to JSON. I had to extract the parts mentioned above and convert the table.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local function hash_request(request, ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local request = {                                       --1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        method = core.request.get_method(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uri = ctx.var.request_uri,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers = core.request.headers(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body = core.request.get_body()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local json = core.json.stably_encode(request)           --2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ngx.encode_base64(json)                          --3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><ol><li>Create a table with only the relevant parts</li><li>The <code>cjson</code> library produces JSON whose members might be sorted differently across several calls. Hence, it results in different hashes. The <code>core.json.stably_encode</code> fixes that issue.</li><li>Hash it</li></ol><p>Then, instead of storing a boolean when receiving the request, we store the resulting hash instead.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local hash = hash_request(core.request, ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if next(resp) == nil then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core.log.warn(&quot;No key found in Redis for Idempotency-Key, set it: &quot;, redis_key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local resp, err = redis:hset(redis_key, &quot;request&quot;, hash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not resp then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        core.log.error(&quot;Failed to set data in Redis: &quot;, err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then -- ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>We read the hash stored under the idempotency key on the other branch. If they don&#x27;t match, we exit with the relevant error code:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local data = normalize_hgetall_result(resp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local stored_hash = data[&quot;request&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if hash ~= stored_hash then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return core.response.exit(422, &quot;This operation is idempotent and it requires correct usage of Idempotency Key. Idempotency Key MUST not be reused across different payloads of this operation.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The final error management happens just afterward. Imagine the following scenario:</p><ol><li>A request comes with idempotency key X</li><li>The plugin fingerprints and stores the hash in Redis</li><li>APISIX forwards the request to the upstream</li><li>A duplicate request comes with the same idempotency key, X</li><li>The plugin reads the data from Redis and finds no cached response</li></ol><p>The upstream didn&#x27;t finish processing the request; hence, the first request hasn&#x27;t yet reached the <code>body_filter</code> phase.</p><p>We append the following code to the above snippet:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">if not data[&quot;response&quot;] then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return core.response.exit(409, &quot; request with the same Idempotency-Key for the same operation is being processed or is outstanding.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>That&#x27;s it.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="conclusion">Conclusion<a aria-hidden="true" class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>In this post, I showed a simple implementation of the <code>Idempotency-Key</code> header specification on Apache APISIX via a plugin. At this stage, it has room for improvement: automated tests, the ability to configure Redis on a per route basis, configure the domain/path to be part of the request, configure a Redis cluster instead of a single instance, use another K/V store, etc.</p><p>Yet, it does implement the specification and has the potential to evolve into a more production-grade implementation.</p><p>The complete source code for this post can be found on <a href="https://github.com/ajavageek/apisix-idempotency-plugin" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p><strong>To go further:</strong></p><ul><li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpapi-idempotency-key-header-04" target="_blank" rel="noopener noreferrer">Idempotency-Key HTTP Header Field</a></li><li><a href="https://apisix.apache.org/blog/2024/04/04/fix-duplicate-api-requests/" target="_blank" rel="noopener noreferrer">Fixing duplicate API requests</a></li><li><a href="https://apisix.apache.org/docs/apisix/plugin-develop/" target="_blank" rel="noopener noreferrer">Plugin Develop - APISIX website</a></li><li><a href="https://api7.ai/blog/how-to-build-an-apache-apisix-plugin-from-0-to-1" target="_blank" rel="noopener noreferrer">How to Build an Apache APISIX Plugin From 0 to 1?</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/plugin/">Plugin</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2024/04/29/release-apache-apisix-3.9.1/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">Release Apache APISIX 3.9.1</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2024/04/05/build-apisix-in-sles15/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">How to build APISIX in SLES 15</div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright ¬© 2019-2026 The Apache Software Foundation. Apache APISIX, APISIX¬Æ, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.4bbc9839.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.a516b59b.js"></script>
</body>
</html>