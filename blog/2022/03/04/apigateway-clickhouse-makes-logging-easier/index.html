<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">APISIX Integrates ClickHouse to Improve Log Efficiency | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2022/03/04/apigateway-clickhouse-makes-logging-easier/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="APISIX Integrates ClickHouse to Improve Log Efficiency | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="This article describes how Zhendong Qi contributed `clickhouse-logger` to API gateway Apache APISIX, and how to use this plugin to simplify business architecture."><meta data-react-helmet="true" property="og:description" content="This article describes how Zhendong Qi contributed `clickhouse-logger` to API gateway Apache APISIX, and how to use this plugin to simplify business architecture."><meta data-react-helmet="true" name="keywords" content="Apache APISIX,API Gateway,ClickHouse,Logging,Ecosystem"><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/2022/11/18/63774d2d76267.png"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/2022/11/18/63774d2d76267.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-03-04T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/zhendongcmss,https://github.com/yzeng25"><meta data-react-helmet="true" property="article:tag" content="Plugins,Ecosystem"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/blog/2022/03/04/apigateway-clickhouse-makes-logging-easier/"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2022/03/04/apigateway-clickhouse-makes-logging-easier/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2022/03/04/apigateway-clickhouse-makes-logging-easier/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">🤔 Introducing APISIX AI Gateway – Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX®️</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">中文博客</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">APISIX Integrates ClickHouse to Improve Log Efficiency</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-04T00:00:00.000Z" itemprop="datePublished">March 4, 2022</time> · <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a href="https://github.com/zhendongcmss" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_KCbV" src="https://github.com/zhendongcmss.png" alt="Zhendong Qi"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zhendongcmss" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Zhendong Qi</span></a></div><small class="avatar__subtitle" itemprop="description">Author</small></div></div></div><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a href="https://github.com/yzeng25" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_KCbV" src="https://github.com/yzeng25.png" alt="Yilin Zeng"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yzeng25" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yilin Zeng</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Writer</small></div></div></div></div></header><meta itemprop="image" content="https://static.apiseven.com/2022/11/18/63774d2d76267.png"><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p>The author of this article, Zhendong Qi, is from China Mobile Cloud Competence Center. He has extensive experience in distributed object storage software development and has participated in the construction of several resource pools in the mobile cloud. This article describes how community contributor Zhendong Qi contributed <code>clickhouse-logger</code> to Apache APISIX and how he used the plugin to simplify the business architecture and improve the efficiency of logging.</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="background-information">Background Information<a aria-hidden="true" class="hash-link" href="#background-information" title="Direct link to heading">​</a></h2><p>Apache APISIX is a dynamic, real-time, high-performance API gateway that provides rich traffic management features such as load balancing, dynamic upstream, canary release, circuit breaking, authentication, observability, and more. It not only has many useful plugins, but also supports plugin dynamic change and hot reload.</p><p>Developed by Yandex and open sourced in 2016, ClickHouse is not only a database, but also a database management system that allows creating tables and databases, loading data and running queries at runtime without reconfiguring or restarting services.</p><p>As more and more companies start to migrate their business to the cloud, how to efficiently implement log sending and receiving and log analysis to enhance the observabilities of the system becomes a challenge. China Mobile Cloud Competence Center, as a company providing public cloud services, the architecture of the initial Apache APISIX-based business log sending and receiving and analysis system is roughly like this.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.webp, https://static.apiseven.com/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.png" alt="initial bussiness architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.png" alt="initial bussiness architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646363723740-f92d6a39-64e0-4464-8c44-c73832362bf6.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>As the business grows, the above solution is not only oddly expensive to maintain, but also difficult to meet our needs for fine-grained data analysis. Since the data received by rsyslog is a string rather than a JSON format log, it makes log analysis difficult.</p><p>There is a famous saying in computing that &quot;any problem can be solved by adding an indirect middle layer&quot;. We actually considered adding another intermediate layer between <code>tcp-logger</code> and rsyslog to convert strings to JSON, but this is obviously not a permanent solution.</p><p>So let&#x27;s look at the problem differently: if we consider the existing architecture of &quot;tcp-logger+rsyslog+Promtail+Loki&quot; as a huge middle layer, then no matter how many additional middle layers we add in between, it only solves the immediate problem. In the meantime, it makes it more bloated and difficult to maintain. Is there a product on the market that can directly replace &quot;tcp-logger+rsyslog+Promtail+Loki&quot;?</p><p>With this question in mind, we spent some time researching and ended up choosing ClickHouse for several reasons.</p><ol><li>ClickHouse provides HTTP interface for easy calling of other modules.</li><li>ClickHouse-based analysis toolbox is very mature and can meet our needs for log analysis.</li><li>ClickHouse supports the use of object storage as a storage engine, very convenient.</li><li>There is no need to repeat the &quot;tool-building&quot; process.</li></ol><p>There is only one problem left to solve: how to implement the interface between Apache APISIX and ClickHouse? A good way to do this is in the form of a plugin. As a member of the Apache APISIX community, I rarely speak up in the community. Seeing the recent progress in the ecosystem of Apache APISIX, I was actually a bit excited to use Apache APISIX, but I haven&#x27;t contributed any code to the community yet, so I thought I&#x27;d like to take this opportunity to add some fire to the community&#x27;s ecosystem development.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="how-it-works">How It Works<a aria-hidden="true" class="hash-link" href="#how-it-works" title="Direct link to heading">​</a></h2><p>The <code>clickhouse-logger</code> plugin acts as an middle layer between Apache APISIX and ClickHouse. As mentioned above, we use Apache APISIX as a seven-layer load balancer and requests passing through Apache APISIX generate logs, such as access log and error log. The <code>clickhouse-logger</code> collects the logs and organizes them according to the log format set by its own metadata. Finally, it relies on a batch processor to send the collated logs to ClickHouse in bulk.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.webp, https://static.apiseven.com/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.png" alt="clickhouse-logger architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.png" alt="clickhouse-logger architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646363936994-c2646095-1ea4-4c1f-8cad-1dcecfc41df3.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p><code>clickhouse-logger</code> serves as a replacement for &quot;tcp-logger+rsyslog+Promtail+Loki&quot; in our scenario. Eliminating the need for format conversion and data forwarding between multiple components, log data requests can be pushed directly to the ClickHouse server.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.webp, https://static.apiseven.com/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.png" alt="improved bussiness architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.png" alt="improved bussiness architecture" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646364005040-93d70286-e7e6-4fb5-a164-1de1c865ce2b.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="how-to-use-the-clickhouse-plugin">How to Use the ClickHouse Plugin<a aria-hidden="true" class="hash-link" href="#how-to-use-the-clickhouse-plugin" title="Direct link to heading">​</a></h2><p>Here is a sample process to enable the <code>clickhouse-logger</code> plugin in a route.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="enable-the-clickhouse-plugin">Enable the ClickHouse Plugin<a aria-hidden="true" class="hash-link" href="#enable-the-clickhouse-plugin" title="Direct link to heading">​</a></h3><p>Run the <code>curl</code> command to enable the <code>clickhouse-logger</code> plugin for the specified route.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;plugins&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;clickhouse-logger&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;user&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;password&quot;: &quot;a&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;database&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;logtable&quot;: &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                &quot;endpoint_addr&quot;: &quot;http://127.0.0.1:8123&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       },</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;upstream&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">           &quot;type&quot;: &quot;roundrobin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">           &quot;nodes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">               &quot;127.0.0.1:1980&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;uri&quot;: &quot;/hello&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The parameters of clickhouse-logger are listed in the chart below.</p><table><thead><tr><th>Name</th><th>Type</th><th>Required</th><th>Default Value</th><th>Range</th><th>Description</th></tr></thead><tbody><tr><td>endpoint_addr</td><td>string</td><td>Yes</td><td>n/a</td><td>n/a</td><td>ClickHouse server endpoint.</td></tr><tr><td>database</td><td>string</td><td>Yes</td><td>n/a</td><td>n/a</td><td>The database used.</td></tr><tr><td>logtable</td><td>string</td><td>Yes</td><td>n/a</td><td>n/a</td><td>The name of the table to write to.</td></tr><tr><td>user</td><td>string</td><td>Yes</td><td>n/a</td><td>n/a</td><td>User for ClickHouse.</td></tr><tr><td>password</td><td>string</td><td>Yes</td><td>n/a</td><td></td><td>Password for ClickHouse.</td></tr><tr><td>timeout</td><td>integer</td><td>No</td><td>3</td><td>[1,...]</td><td>The time to keep the connection active after sending the request.</td></tr><tr><td>name</td><td>string</td><td>No</td><td>&quot;clickhouse-logger&quot;</td><td>n/a</td><td>A unique identifier that identifies the logger.</td></tr><tr><td>batch_max_size</td><td>integer</td><td>No</td><td>100</td><td>[1,...]</td><td>Set the maximum number of logs to be sent each time, and when the maximum number of logs reaches the set value, all logs will be automatically pushed to <code>clickhouse</code>.</td></tr><tr><td>max_retry_count</td><td>integer</td><td>No</td><td>0</td><td>[0,...]</td><td>Maximum number of retries before being removed from the processing pipeline.</td></tr><tr><td>retry_delay</td><td>integer</td><td>No</td><td>1</td><td>[0,...]</td><td>If the execution fails, the execution of the process should be delayed for a number of seconds.</td></tr><tr><td>ssl_verify</td><td>boolean</td><td>No</td><td>true</td><td>[true,false]</td><td>Validate the certificate.</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="test-the-clickhouse-plugin">Test the ClickHouse Plugin<a aria-hidden="true" class="hash-link" href="#test-the-clickhouse-plugin" title="Direct link to heading">​</a></h3><ol><li><p>Use the <code>curl</code> command to test the plugin.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -i http://127.0.0.1:9080/hello</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li><li><p>If the following result is returned, it means it is successfully enabled.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello, world</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="advanced-skill-configure-log-format">Advanced Skill: Configure Log Format<a aria-hidden="true" class="hash-link" href="#advanced-skill-configure-log-format" title="Direct link to heading">​</a></h3><p>You can set a custom log format using the <code>log_format</code> metadata, as shown in the example below.</p><ol><li><p>Configure the <code>log_format</code> metadata parameter.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/plugin_metadata/clickhouse-logger </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;log_format&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;host&quot;: &quot;$host&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;@timestamp&quot;: &quot;$time_iso8601&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;client_ip&quot;: &quot;$remote_addr&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><blockquote><p>Declare the log format as a key-value pair in JSON format. For the value part, only strings are supported. If it starts with<code>$</code>, it indicates that it is to get <a href="https://apisix.apache.org/docs/apisix/apisix-variable" target="_blank" rel="noopener noreferrer">APISIX built-in variables</a> or <a href="http://nginx.org/en/docs/varindex.html" target="_blank" rel="noopener noreferrer">Nginx built-in variables</a>. In particular, <strong>this setting is global</strong>, meaning that specifying <code>log_format</code> will take effect on all routes or services bound to <code>http-logger</code>.</p></blockquote></li><li><p>Create a table for ClickHouse to write in.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK sql"><pre tabindex="0" class="prism-code language-sql codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">host</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">client_ip</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">route_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">@timestamp</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">@timestamp</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li><li><p>Execute <code>select * from default.test;</code> on ClickHouse, you will get data similar to the following.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">┌─host──────┬─client_ip─┬─route_id─┬─@timestamp────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 │ </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 │    </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">     │ </span><span class="token number" style="color:#36acaa">2022</span><span class="token plain">-01-17T10:03:10+08:00 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────┴───────────┴──────────┴───────────────────────────┘</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="advanced-skill-connect-grafana-with-clickhouse">Advanced Skill: Connect Grafana with ClickHouse<a aria-hidden="true" class="hash-link" href="#advanced-skill-connect-grafana-with-clickhouse" title="Direct link to heading">​</a></h3><ol><li><p>Enable the clickhouse-logger plugin globally.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/global_rules/1 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;clickhouse-logger&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;timeout&quot;: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;retry_delay&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;batch_max_size&quot;: 100,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;user&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;password&quot;: &quot;a&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;database&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;logtable&quot;: &quot;t&quot;,  &quot;max_retry_count&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;endpoint_addr&quot;: &quot;http://127.0.0.1:8123&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li><li><p>Configure the log_format metadata parameter. log_format must be in the same format as the database table structure, otherwise it will cause write failure.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/plugin_metadata/clickhouse-logger </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;log_format&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;upstream_header_time&quot;: &quot;$upstream_header_time&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;upstream_connect_time&quot;: &quot;$upstream_connect_time&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;status&quot;: &quot;$status&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;host&quot;: &quot;$host&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;body_bytes_sent&quot;: &quot;$body_bytes_sent&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;request&quot;: &quot;$request&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;remote_user&quot;: &quot;$remote_user&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;client_ip&quot;: &quot;$remote_addr&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;content_length&quot;: &quot;$content_length&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;local_time&quot;: &quot;$fmt_ms_time_local&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;http_referer&quot;: &quot;$http_referer&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;http_x_amz_target&quot;: &quot;$http_x_amz_target&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;http_x_request_id&quot;: &quot;$http_x_request_id&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;upstream_response_time&quot;: &quot;$upstream_response_time&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;upstream_status&quot;: &quot;$upstream_status&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;http_user_agent&quot;: &quot;$http_user_agent&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;request_time&quot;: &quot;$request_time&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;upstream_addr&quot;: &quot;$upstream_addr&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;http_host&quot;: &quot;$http_host&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;content_type&quot;: &quot;$content_type&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div></li></ol><p>Here are some screenshots of the dashboard after interfacing with Clickhouse using Grafana.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.webp, https://static.apiseven.com/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.png" alt="Grafana-1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.png" alt="Grafana-1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646366781343-ab2848fe-d10a-4222-a90d-79f4fe58999a.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.webp, https://static.apiseven.com/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.png" alt="Grafana-2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.png" alt="Grafana-2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646366807867-4391a9ff-8b71-411c-8353-38957a5a2da1.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.webp, https://static.apiseven.com/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.png" alt="Grafana-3" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.png" alt="Grafana-3" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646366832282-e8f24c63-c914-4051-8239-582bc3e58f50.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="disable-the-clickhouse-plugin">Disable the ClickHouse Plugin<a aria-hidden="true" class="hash-link" href="#disable-the-clickhouse-plugin" title="Direct link to heading">​</a></h3><p><code>clickhouse-logger</code> can be disabled by removing the appropriate configuration in the plugin configuration. Since the Apache APISIX plugin is hot-loaded, the configuration can be updated without a restart.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://127.0.0.1:9080/apisix/admin/routes/1  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-H </span><span class="token string" style="color:#e3116c">&#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;methods&quot;: [&quot;GET&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;uri&quot;: &quot;/hello&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;plugins&quot;: {},</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;upstream&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;type&quot;: &quot;roundrobin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;nodes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;127.0.0.1:1980&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="summary">Summary<a aria-hidden="true" class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>The above is the whole process of developing <code>clickhouse-logger</code> for Apache APISIX, and how to implement it with Grafana to achieve the same observability with simpler architechure and worlflows. I hope more people in the community will be willing to step out of their comfort zones, switching from followers to contributors is much easier than you think.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/plugins/">Plugins</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/ecosystem/">Ecosystem</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2022/03/05/apisix-integration-eureka-service-discovery/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">Integrate API Gateway with Eureka</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/03/04/apisix-uses-coredns-enable-service-discovery/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">Apache APISIX with CoreDNS enrich service discovery</div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright © 2019-2025 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js"></script>
</body>
</html>