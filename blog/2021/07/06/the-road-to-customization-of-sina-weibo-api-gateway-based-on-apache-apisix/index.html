<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">The Road to Customized Development of Sina Weibo API Gateway | Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2021/07/06/the-road-to-customization-of-sina-weibo-api-gateway-based-on-apache-apisix/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="The Road to Customized Development of Sina Weibo API Gateway | Apache APISIX¬Æ -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="This article analyzes the pain points of NGINX Sina Weibo when using NGINX, and why the cloud-native API gateway Apache APISIX was chosen as the company&#x27;s API gateway."><meta data-react-helmet="true" property="og:description" content="This article analyzes the pain points of NGINX Sina Weibo when using NGINX, and why the cloud-native API gateway Apache APISIX was chosen as the company&#x27;s API gateway."><meta data-react-helmet="true" name="keywords" content="Apache APISIX,Sina,Weibo,Usser Case,API Gateway"><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/2022/blog/0817/weibo.png"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/2022/blog/0817/weibo.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-07-14T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="Case Studies"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/blog/2021/07/06/the-road-to-customization-of-sina-weibo-api-gateway-based-on-apache-apisix/"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/07/06/the-road-to-customization-of-sina-weibo-api-gateway-based-on-apache-apisix/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/07/06/the-road-to-customization-of-sina-weibo-api-gateway-based-on-apache-apisix/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.4bbc9839.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.a516b59b.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">ü§î Introducing APISIX AI Gateway ‚Äì Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX¬Æ" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX¬Æ" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX¬Æ</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX¬ÆÔ∏è</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX¬ÆÔ∏è Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX¬ÆÔ∏è Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX¬ÆÔ∏è Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX¬ÆÔ∏è Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX¬ÆÔ∏è Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX¬ÆÔ∏è Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX¬ÆÔ∏è Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">‰∏≠ÊñáÂçöÂÆ¢</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">The Road to Customized Development of Sina Weibo API Gateway</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-07-14T00:00:00.000Z" itemprop="datePublished">July 14, 2021</time> ¬∑ <!-- -->13 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link avatar__photo"><div size="48" color="E4E2F3" class="go1040192816"><p color="280F6D" size="48" class="go197296499">Yo</p></div></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Yong Nie</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://static.apiseven.com/2022/blog/0817/weibo.png"><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p>Sina Weibo‚Äôs previous HTTP API gateway was built based on Nginx, which brought up a series of problems. After some research, we chose Apache APISIX, which is dynamic, efficient and stable to meet the fast response requirements of the business.</p></blockquote><p>Sina Weibo‚Äôs previous HTTP API gateway was built based on Nginx, and all routing rules were stored in Nginx configuration files, which brought a series of problems: long upgrade steps, inflexibility and difficulty in troubleshooting problems when adding, deleting, changing or tracking services. After some research, we chose the closest expected, cloud-based micro-service API gateway: Apache APISIX, which is dynamic, efficient and stable to meet the rapid response requirements of the business.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="background-information">Background Information<a aria-hidden="true" class="hash-link" href="#background-information" title="Direct link to heading">‚Äã</a></h2><p>In Sina Weibo, if an operation engineer wants to create an API service, he/she needs to write it in the Nginx configuration file first, submit it to the git code repository, and wait for other operation engineer responsible for the online checkout to confirm the success of the audit before they can push the deployment to the line, and then brutally notify Nginx to reload it, and only then is the service change successful.</p><p>The whole process is long and inefficient, and cannot meet the trend of low-code DevOps operation and maintenance. Therefore, we expect to have a management backend portal, where operation engineer can operate all the http api routing and other configurations in the UI interface.</p><p></p><div class="rc-image"><img loading="lazy" alt="Sina Weibo Publish Process" class="rc-image-img" src="https://user-images.githubusercontent.com/23514812/125594900-d4c01fb7-3af4-4e8c-8779-f3f16b7f0bca.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><p>After some research, we chose the closest to the expected cloud-based micro-services API gateway: Apache APISIX.</p><ol><li>Based on Nginx, the technology stack is unified before and after the canary release upgrade, security, stability, etc. are guaranteed.</li><li>Built-in unified control surface, unified management of multiple proxy services.</li><li>Dynamic API call, you can complete the common resource modifications in real time, compared to the traditional Nginx configuration + reload way progress is obvious.</li><li>Rich routing options to meet the needs of Sina Weibo routing.</li><li>Good scalability, support Consul kv.</li><li>Good performance.</li></ol><p></p><div class="rc-image"><img loading="lazy" alt="Apache APISIX Architecture" class="rc-image-img" src="https://user-images.githubusercontent.com/23514812/125596483-aee21ac7-a902-4e44-abc4-8bfda4f51f82.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="why-did-we-choose-custom-development">Why Did We Choose Custom Development?<a aria-hidden="true" class="hash-link" href="#why-did-we-choose-custom-development" title="Direct link to heading">‚Äã</a></h2><p>In the actual business situation, we cannot use Apache APISIX directly for the following reasons.</p><ol><li>Apache APISIX does not support SaaS multi-tenancy, and there are many upper-layer applications that actually need to be operated and maintained, and each business line development or operation and maintenance student only needs to manage and maintain their own rules, upstreams and other rules, which are not associated with each other.</li><li>When the routing rules are published online, they need fast roll back support if problems arise.</li><li>When creating or editing existing routing rules, we are not so sure about publishing them directly to the wire, and then we need it to be able to support canary release to a specified gateway instance for simulation or local testing.</li><li>The need for API gateways to be able to support Consul KV-style service registration and discovery mechanisms.</li></ol><p>None of these requirements are currently supported built-in by Apache APISIX, so custom development is the only way to make Apache APISIX truly usable within Weibo.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="what-did-we-change-in-the-control-plane-of-apacheapisix">What Did We Change in the Control Plane of Apache¬†APISIX?<a aria-hidden="true" class="hash-link" href="#what-did-we-change-in-the-control-plane-of-apacheapisix" title="Direct link to heading">‚Äã</a></h2><p>For our custom development, we used Apache APISIX version 1.5, and Apache APISIX Dashboard compatible with Apache APISIX version 1.5.</p><p>The goal of custom development is simple and clear, that is, completely zero code, UI, all seven layers of HTTP API service creation, editing, updating, up and down and all other actions must be done on the Dashboard. Therefore, in the actual environment, we forbid development and operation and operation engineer to call APISIX Admin API directly. If we skip the Dashboard and call APISIX Admin API directly, it will lead to the gateway operation not being audited at the UI level, so we cannot take the workflow, and naturally, there is not much security to speak of.</p><p>There is a slightly special case, operations and maintenance need to call the API to complete the bulk import of services, you can call the H5 Dashboard API to complete, so as to comply with the unified workflow.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="support-saas-based-services">Support Saas-based Services<a aria-hidden="true" class="hash-link" href="#support-saas-based-services" title="Direct link to heading">‚Äã</a></h3><p>A complete database of product lines and business lines is available at the enterprise level, and each specific product line and business line can be represented by a saas_id value. Then, before creating the gateway configuration data for insertion into the ETCD, a saas_id value is plugged in and all the data has a SaaS attribution in terms of logical attributes.</p><p>Users, roles and the actual product line of operation are then associated with the following correspondence.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.webp, https://static.apiseven.com/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.png" alt="Users, roles and product association" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.png" alt="Users, roles and product association" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646899698131-8e90270e-9849-435e-b776-0827c04b293c.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>A user can be assigned to undertake different operations and maintenance roles to manage and maintain different product lines of services.</p><p>The administrator role is very easy to understand, the core role of operation and maintenance services, for service addition / deletion / update / check; in addition, we have the concept of read-only users, read-only users are generally used to view the service configuration, view the workflow, debugging and so on.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="add-audit-function">Add Audit Function<a aria-hidden="true" class="hash-link" href="#add-audit-function" title="Direct link to heading">‚Äã</a></h3><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.webp, https://static.apiseven.com/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.png" alt="Audit Function1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.png" alt="Audit Function1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646899698135-0b92ed91-0803-4f2c-8d4b-6873c19fa492.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>In the open source version, a route can be published directly after it is created or modified.</p><p>In our custom version, after a route is created or modified, it needs to go through an audit workflow before it can be published, which lengthens the process, but we think it is more credible to publish after the authorization is reviewed at the enterprise level.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.webp, https://static.apiseven.com/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.png" alt="Audit Function2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.png" alt="Audit Function2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900059586-f7feca14-57ed-417b-aadc-ca02e31bfa47.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>When creating routing rules, they must be reviewed by default. To take into account efficiency, when entering new services, you can choose the no-review, fast-publishing channel and click the publish button directly.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.webp, https://static.apiseven.com/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.png" alt="Audit Function3" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.png" alt="Audit Function3" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900090210-6f08f1e5-fc62-4148-9d5a-879bc96a54d2.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>When an important API route has problems after a certain adjustment rule release goes live, you can select the previous version of the routing rule for a quick roll back, with the granularity of a single route roll back that will not affect other routing rules.</p><p>The internal processing flow of a single route roll back is shown in the following figure.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.webp, https://static.apiseven.com/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.png" alt="Audit Function4" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.png" alt="Audit Function4" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900126327-f297be1b-c7e5-4991-9fea-0e1e87bea937.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>We need to create version database storage for each release of a single route. This way, when we do a full release after the audit, each release will generate a version number and the corresponding full configuration data; then the version list grows. When we need to roll back, go to the version list and select a corresponding version to rollback; in a sense, the roll back is actually a special form of full release.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="support-canary-release">Support Canary Release<a aria-hidden="true" class="hash-link" href="#support-canary-release" title="Direct link to heading">‚Äã</a></h3><p>Our custom-developed canary release feature is different from what the community generally understands as canary release, and is less risky compared to full deployment. When a change to a routing rule is large, we can choose to publish and take effect only on a specific limited number of gateway instances, instead of publishing and taking effect on all gateway instances, thus reducing the scope of the release, lowering the risk, and enabling fast trial and error.</p><p>Although canary release is a low-frequency behavior, there is still a state transition between it and full volume release.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.webp, https://static.apiseven.com/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.png" alt="Support Canary Release1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.png" alt="Support Canary Release1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900161267-83d3bb57-596c-4e23-8fa3-4999739a77ca.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>When the percentage of canary release decreases to 0%, it is the state of full release; when the canary release rises to 100%, it is the next full release, and this is its state transition.
The full canary release feature requires some API support exposed on the gateway instance in addition to the administrative backend support.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.webp, https://static.apiseven.com/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.png" alt="Support Canary Release2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.png" alt="Support Canary Release2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900188100-bf697358-4d6a-44d7-ab3d-223728e860b2.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The above screenshot shows the screenshot when operating canary release to select a specific gateway instance.</p><p>The full canary release feature requires some API support exposed on the gateway instance in addition to the administrative backend support.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.webp, https://static.apiseven.com/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.png" alt="Support Canary Release3" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.png" alt="Support Canary Release3" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900211377-0c1df098-c5be-4c69-bda6-eabd1518f0f5.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Canary release API fixed URI, the unified path is /admin/services/gray/{SAAS_ID}/ routes. Different HTTP Method presents different business meanings, POST means create, DELETE means to stop canary release, GET means to view.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="activation-process">Activation Process<a aria-hidden="true" class="hash-link" href="#activation-process" title="Direct link to heading">‚Äã</a></h4><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.webp, https://static.apiseven.com/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.png" alt="Activation Process" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.png" alt="Activation Process" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900248884-ca1757d7-e6c0-45a3-a677-d29184b494d8.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>An API is published from the gateway level, and after receiving the data the worker process checks the legitimacy of the data sent, and the legitimate data is broadcast to all worker processes via events. Then the canary release API is called and the canary release rules are added and take effect when the next request is processed.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="deactivation-process">Deactivation Process<a aria-hidden="true" class="hash-link" href="#deactivation-process" title="Direct link to heading">‚Äã</a></h4><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.webp, https://static.apiseven.com/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.png" alt="Deactivation Process" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.png" alt="Deactivation Process" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900280677-87a90d54-c78d-4660-afab-33bbc433010d.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The deactivation process is basically the same as the canary release distribution process. The API for canary release distribution is called by the DELETE method and broadcasted to all work processes. If it exists in the route table, delete it and try to restore it from the ETCD. If the canary release is deactivated, make sure that the original ETCD can be restored without affecting the normal service.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="support-fastimport">Support Fast¬†Import<a aria-hidden="true" class="hash-link" href="#support-fastimport" title="Direct link to heading">‚Äã</a></h3><p>In addition to supporting the creation of routes on the management page, many operation engineer are still more accustomed to using scripts to import. We have a large number of HTTP API services, and it would be very time-consuming to manually enter them one by one. If you import through scripts, you can reduce a lot of service migration resistance.</p><p>By exposing the Go Import HTTP API for the management backend, the operation engineer can fill in the assigned token, SaaS ID and related UIDs in the ready-made Bash Script file to import the services into the management backend more quickly. The subsequent operation of importing services still needs to be done in the management backend H5 interface.</p><p></p><div class="rc-image"><img loading="lazy" alt="Fast¬†Import" class="rc-image-img" src="https://user-images.githubusercontent.com/23514812/125597641-54bf1649-0238-4973-8501-48c1cead328e.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="what-did-we-change-in-the-data-plane-of-apacheapisix">What Did We Change in the Data Plane of Apache¬†APISIX?<a aria-hidden="true" class="hash-link" href="#what-did-we-change-in-the-data-plane-of-apacheapisix" title="Direct link to heading">‚Äã</a></h2><p>Custom development based on the Apache APISIX data surface requires a number of code path rules to be followed. In particular, the code for the Apache APISIX gateway and the custom code are stored in separate paths, and the two work together and can each be iterated independently.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.webp, https://static.apiseven.com/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.png" alt="Changes in the Data Plane" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.png" alt="Changes in the Data Plane" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900844425-46711779-fa2c-4242-a3c4-311fd5ea2563.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="modification-of-installation-package">Modification of Installation Package<a aria-hidden="true" class="hash-link" href="#modification-of-installation-package" title="Direct link to heading">‚Äã</a></h3><p>So when packaging, not only custom code, but also dependencies, configuration, etc. all need to be packaged together for distribution. As for the output format, you can either choose Docker or type it into a tarball, as required.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.webp, https://static.apiseven.com/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.png" alt="Modification of Installation Package" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.png" alt="Modification of Installation Package" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900306141-5f85e7e9-3e13-4477-957c-657d5435bdef.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="custom-development-ofcode">Custom Development of¬†Code<a aria-hidden="true" class="hash-link" href="#custom-development-ofcode" title="Direct link to heading">‚Äã</a></h3><p>Some custom modules need to be loaded first when they are initialized, so that the code intrusion into Apache APISIX becomes minimal, requiring only modifications to the Nginx.conf file.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.webp, https://static.apiseven.com/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.png" alt="Custom Development of¬†Code1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.png" alt="Custom Development of¬†Code1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900356726-16c7b794-c5d9-43a4-af60-7dc675f56dc7.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>For example, if you need to stuff an upstream object with a saas_id attribute field, you can call the following method at initialize time.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.webp, https://static.apiseven.com/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.png" alt="Custom Development of¬†Code2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.png" alt="Custom Development of¬†Code2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900387986-d7036503-98a9-4cb8-a47e-27e7ae83796b.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>You need to be called in the initworker_by_lua* phase to complete the initialization for similar modifications.</p><p>Another scenario: how to directly rewrite the implementation of a currently existing module. For example, if you have a debug module and now you need to refactor its initialization logic, i.e. rewrite the init_worker function.</p><p></p><div class="rc-image"><img loading="lazy" alt="Custom Development of¬†Code3" class="rc-image-img" src="https://user-images.githubusercontent.com/23514812/125598066-fd0da722-7fb0-44a2-99cd-15bf07fd1ad6.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The advantage of this approach is that it not only keeps the original physical API files intact, but also adds custom API-specific logic rewrites, thus reducing the cost of later code management and bringing great convenience for subsequent upgrades.</p><p>If you have similar needs in a production environment, you can refer to the above approach.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="support-consulkv">Support Consul¬†KV<a aria-hidden="true" class="hash-link" href="#support-consulkv" title="Direct link to heading">‚Äã</a></h3><p>Currently, most of Weibo services use Consul KV as a service registration and discovery mechanism. Previously, Apache APISIX did not support the Consul KV method of service discovery mechanism, so a <code>consul_kv.lua</code> module needs to be added to the gateway layer, and a UI interface needs to be provided in the management backend as follows.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.webp, https://static.apiseven.com/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.png" alt="Support Consul¬†KV1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.png" alt="Support Consul¬†KV1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900423967-5b5db4c1-1c2c-495c-88ef-e0f4937bcef8.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>In the upstream list in the console, everything is filled in at a glance, and the metadata of all registered nodes is automatically presented when the mouse is moved over the registered service address, which greatly facilitates the daily operation of our operation engineers.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.webp, https://static.apiseven.com/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.png" alt="Support Consul¬†KV2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.png" alt="Support Consul¬†KV2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900450031-bf0109c1-c859-4fbd-9a47-967c193d27ff.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>The <code>consul_kv.lua</code> module is relatively simple to configure at the gateway level, supporting multiple connections to different Consul clusters at the same time, but this is also due to the requirements of the actual environment.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.webp, https://static.apiseven.com/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.png" alt="Support Consul¬†KV3" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.webp, https://static.apiseven.com/apisix-thumbnail/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.png" alt="Support Consul¬†KV3" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1646900471956-9490a2d0-256d-4f15-b24e-6f8204a60a17.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>This code has now been merged into the APISIX master branch and is included in version 2.4.</p><p>The module&#x27;s process model uses a subscription publishing model, where each gateway instance has one and only one process that polls multiple Consul service clusters with long connections and broadcasts new data to all business sub-processes as it becomes available.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="problems-encountered-during-customization">Problems Encountered during Customization<a aria-hidden="true" class="hash-link" href="#problems-encountered-during-customization" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="high-costs-for-migration">High Costs for Migration<a aria-hidden="true" class="hash-link" href="#high-costs-for-migration" title="Direct link to heading">‚Äã</a></h3><p>At the operation and maintenance level, we are actually facing a problem of migration cost.</p><p>Any new thing appeared, used to replace the existing foundation, will not be a smooth ride, but need to go through a period of time slowly familiar with, improve knowledge, and then keep trial and error, slowly move forward, and gradually eliminate all kinds of doubts in our minds. Only after a period of stable operation and various problems have been solved, will the next step of more rapid replacement phase be entered. There is no doubt that the use of APISIX in Weibo is still in the stage of gradual advancement, and we are still familiarizing ourselves with it, learning it, and gaining a deeper understanding of it, while solving various migration problems in order to find the best practice path.</p><p>For example, during the migration process, you need to import various upstream and routing rules from the Nginx.conf file into the gateway system administration backend one by one, which is a very tedious and manual process.</p><p></p><div class="rc-image"><img loading="lazy" alt="High Costs for Migration" class="rc-image-img" src="https://user-images.githubusercontent.com/23514812/125598279-1fa93710-e5a0-4dc4-b42b-46b02f66f6a8.png"><div class="rc-image-mask">Click to Preview</div></div><p></p><p>At the same time, we will also encounter Nginx various complex variable judgment statements, at present, we mainly find one to solve one, and continue to accumulate experience.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="high-costs-forupgrades">High Costs for¬†Upgrades<a aria-hidden="true" class="hash-link" href="#high-costs-forupgrades" title="Direct link to heading">‚Äã</a></h3><p>High level of customization, resulting in higher costs for subsequent upgrades. We are currently experiencing the same problem as everyone else, many people should be based on version 1.x Apache APISIX how to upgrade to 2.0, we also have a Dashboard of private custom development, the subsequent upgrade costs should be higher.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="feeding-the-community">Feeding the Community<a aria-hidden="true" class="hash-link" href="#feeding-the-community" title="Direct link to heading">‚Äã</a></h3><p>The final part is about the Apache APISIX community. We have been thinking about how to feed features of interest to the Apache APISIX community for everyone to use and modify together.</p><p>It is an objective fact that our custom development is driven primarily by actual internal Weibo requirements, and there is some variation from the evolution driven by the Apache APISIX community. However, excluding code that contains sensitive data, there are always common needs at the code level for more general functionality that the enterprise and open source communities can push together to make more stable and mature. For example, a common Consul KV service discovery module, handling of some highly available profiles, and fixes for other issues.</p><p>These common requirements are typically polished internally for a period of time until they fully satisfy internal requirements, and then gradually submitted to the community open source branch, but this also requires a process.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/case-studies/">Case Studies</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/07/21/apache-apisix-kubernetes/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">Live | Apache APISIX x Kubernetes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/07/06/celebrate-200-contributors/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">Apache APISIX has over 200 contributors in GitHub main repo! </div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright ¬© 2019-2026 The Apache Software Foundation. Apache APISIX, APISIX¬Æ, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.4bbc9839.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.a516b59b.js"></script>
</body>
</html>