<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WQLBQL6GY3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WQLBQL6GY3",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/articles/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/articles/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"><title data-react-helmet="true">Apache APISIX Architecture Analysis: How to Dynamically Manage Nginx Clustering? | Apache APISIX® -- Cloud-Native API Gateway</title><meta data-react-helmet="true" property="og:image" content="https://apisix.apache.org/img/apache-apisix.png"><meta data-react-helmet="true" name="twitter:image" content="https://apisix.apache.org/img/apache-apisix.png"><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2021/08/10/apisix-nginx"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="Apache APISIX Architecture Analysis: How to Dynamically Manage Nginx Clustering? | Apache APISIX® -- Cloud-Native API Gateway"><meta data-react-helmet="true" name="description" content="This article is re-posted from Tao Hui&#x27;s personal blog, and introduces the principles of Apache APISIX based on APISIX version 2.8, OpenResty version 1.19.3.2, and Nginx version 1.19.3 to implement a REST API for remote control of Nginx clusters."><meta data-react-helmet="true" property="og:description" content="This article is re-posted from Tao Hui&#x27;s personal blog, and introduces the principles of Apache APISIX based on APISIX version 2.8, OpenResty version 1.19.3.2, and Nginx version 1.19.3 to implement a REST API for remote control of Nginx clusters."><meta data-react-helmet="true" name="keywords" content="API Gateway,Apache APISIX,Nginx,Lua,Dynamic Management"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-08-10T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="Technology"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/zh/blog/2021/08/10/apisix-nginx" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/css/styles.4ccf253e.css">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/js/runtime~main.e8843a10.js" as="script">
<link rel="preload" href="https://cdn.jsdelivr.net/gh/apache/apisix-website@asf-site/assets/js/main.8811c3d7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">🤔 Have queries regarding apache APISIX, Join slack channel to discuss them <a target="_blank" rel="noopener noreferrer" href="https://apisix.apache.org/docs/general/community">join #apisix channel</a>! ⭐️</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"></path></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/apisix/getting-started">Apache APISIX®️</a></li><li><a class="dropdown__link" href="/docs/dashboard/USER_GUIDE">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" href="/docs/ingress-controller/getting-started/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" href="/docs/general/security">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/downloads">Downloads</a><a href="https://github.com/apache/apisix/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussions</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/showcase">Showcase</a></li><li><a class="dropdown__link" href="/plugins">Plugin Hub</a></li><li><a class="dropdown__link" href="/docs/general/community">Community</a></li><li><a class="dropdown__link" href="/contribute">Contribute</a></li><li><a class="dropdown__link" href="/team">Team</a></li><li><a class="dropdown__link" href="/help">Help</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2021/08/10/apisix-nginx" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/2021/08/10/apisix-nginx" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">All posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/12/02/weekly-report-1130">Biweekly Report｜11.15-11.30 Feature Highlights Update in Progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/12/01/apisix-supports-azure-functions">Apache APISIX&#x27;s intergration with Azure Serverless</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/30/use-apisix-ingress-in-kubesphere">Using Apache APISIX Ingress Gateway to access Custom Monitoring in KubeSphere</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/26/apache-apisix-committer-experience">Contributer to Committer journey @Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/23/cve-2021-43557-research-report">Apache APISIX request_uri variable is not properly controlled, with risk of path penetration</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/23/cve-2021-43557">Apache APISIX Path traversal in request_uri variable(CVE-2021-43557)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/22/develop-apisix-ingress-with-nocalhost-in-kubernetes">Developing APISIX Ingress Controller with Nocalhost in Kubernetes</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/19/apisix-supports-wasm">Apache APISIX embraces the WASM ecosystem</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/17/dapr-with-apisix">How to integrate with Dapr to build Apache APISIX Gateway Controller</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/16/weekly-report-1114">Weekly Report｜11.1-11.14 Feature Highlights Update in Progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/12/apisix-datadog">Cloud Monitoring with Datadog in Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/04/skywalking">The observability of Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/03/airwallex-usercase">How Apache APISIX protects Airwallex data sovereignty through the gateway layer</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/02/weekly-report-1031">Weekly Report｜10.15-10.31 Feature Highlights Update in Progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/29/Extension-guide">Apache APISIX Extensions Guide</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/26/APISIX-Ingress">From 0 to 1, How APISIX Ingress Has Grown and Gained Since Joining The Community</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/22/cert-manager-in-ingress">Tutorial: How to use Cert Manager to manage certificates in Apache APISIX Ingress Controller</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/18/meetup">Webinar | Apache APISIX × Apache SkyWalking Online Meetup</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/14/weekly-report-1014">Community Weekly｜10.1-10.14 Feature Highlight Updates in Progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/13/celebrating-300-contributors-of-apisix">New milestone for the Apache APISIX community - over 300 contributors worldwide!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/09/apisix-ingress-techblog">A thoughtful tutorial to get started with Apache APISIX Ingress from concept to practice</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/01/openEuler">Apache APISIX community members help openEuler release first community innovation version</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/30/weekly-report">Community Weekly｜New committer, feature highlight update in progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/29/release-apache-apisix-2.10">Release Apache APISIX 2.10.0</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/28/WPS-usercase">WPS has teamed up with Apache APISIX to create a new gateway experience</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/24/youpaicloud-usercase">Why is Apache APISIX Ingress a new option for building container gateways into the UPYUN?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/18/xiaodian-usercase">Apache APISIX helps DIAN to facilitate cloud native solution</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/16/tencent-cloud">Implementing Apache APISIX in Tencent Cloud TI-ONE Platform</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/15/weekly-report">Community Weekly｜Two new committers, feature highlight updates in progress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/14/youzan">Apache APISIX powers the Youzanyun native PaaS platform for comprehensive micro-service governance</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/13/china-mobile-cloud-usercase">How Apache APISIX is implemented in China Mobile Cloud</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/09/how-to-contribute-to-an-OpenSource-without-coding">How can I contribute to an open source project without writing code?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/07/how-to-use-apisix-auth">Centralized Authentication with Apache APISIX and Advanced Tricks</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/07/iQIYI-usercase">Based on Apache APISIX, iQIYI API Gateway Update and landing practice</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/09/06/python-helps-you-quickly-with-Apache-APISIX-development">Python helps you develop Apache APISIX plugin</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/31/Apache APISIX × KubeSphere-a-better-gateway-and-K8S-Ingress-Controller">Apache APISIX × KubeSphere: Providing a better gateway and K8S Ingress Controller</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/30/Ingress-Meeting">Webinar｜ See you at the Apache APISIX Ingress Community Meeting on Wednesday at 2pm!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/30/weekly-report">Apache APISIX Community Weekly Report ｜ 2021 8.23-8.29</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/27/release-apache-apisix-2.9">Release Apache APISIX 2.9</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/25/Auth-with-Casbin-in-Apache-APISIX">Authorization with Casbin in Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/25/Using-the-Apache-APISIX-OpenID-Connect-Plugin-for-Centralized-Authentication">Centralized authentication using the OpenID Connect plug-in for Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/25/Why-Apache-APISIX-chose-Nginx-and-Lua">Why Apache APISIX chose Nginx and Lua to build API Gateway</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/24/shanghai-meetup-recap">Apache APISIX Meetup in Shanghai</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/23/ApacheCon-Asia-2021">ApacheCon Asia 2021</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/23/weekly-report">Apache APISIX 社区周报 ｜ 2021 8.16-8.22</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/21/shanghai-meetup">August 21 Apache APISIX Meetup Shanghai, welcome to register!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/19/go-makes-Apache-APISIX-better">Go gives Apache APISIX a run for its money</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/19/weekly-report">Apache APISIX 社区周报 ｜ 08-09 ～ 08-15</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/18/Auth-with-Casbin-in-Apache-APISIX">Licensing with Casbin in Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/17/interview-airwallex">Apache APISIX in Airwallex | Interview with Yang Li, Head of Airwallex Technology Platform</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/16/Using-the-Apache-APISIX-OpenID-Connect-Plugin-for-Centralized-Authentication">Using the Apache APISIX OpenID Connect Plugin for Okta Centralized Authentication</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/14/contributors-the-golden-metric-of-openSource-projects">Contributors — The Golden Metric of OpenSource Projects</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/12/Chaos-Mesh-Helps-Apache-APISIX-Improve-System-Stability">Chaos Mesh Helps Apache APISIX Improve System Stability</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/11/interview-TuZhengsong">I issued my first PR in the Apache APISIX community</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2021/08/10/apisix-nginx">Apache APISIX Architecture Analysis: How to Dynamically Manage Nginx Clustering?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/09/Apache-APISIX-in-China-Mobile-Cloud">Apache APISIX 在移动云的应用</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/09/Apache-APISIX-in-Quliankeji">Abandoning Kong and Nginx, Hyperchain Technology implements on its BaaS platform</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/06/using-apache-apisix-to-improve-the-observability-of-nginx">How to Improve the Observability of Nginx with Apache APISX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/05/Kong-to-APISIX">Kong-To-APISIX Migration Tool</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/28/release-apache-apisix-2.8">Release Apache APISIX 2.8.0</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/27/use-of-plugin-orchestration-in-Apache-APISIX">Applying Plugin Orchestration in Apache APISIX</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/25/apachecon-asia">ApacheCon Asia 2021: Apache APISIX Technical Topics</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/21/Apache-APISIX-Kubernetes">Apache APISIX x Kubernetes: Just Right｜Live</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/14/the-road-to-customization-of-Sina-Weibo-API-gateway-based-on-Apache-APISIX">The Road to Customized Development of Sina Weibo API Gateway</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/07/06/celebrate-200-contributors">Apache APISIX has over 200 contributors in GitHub main repo! </a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/30/etcd3-support-HTTP-access-perfectly">Does etcd 3 Support HTTP Access Perfectly?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/29/release-apache-apisix-2.7">Release Apache APISIX 2.7.0</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/28/why-we-need-Apache-APISIX">Why do you need Apache APISIX when you have NGINX and Kong?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/23/deploy-great-open-source-gateway-and-ingress-controller-fast">Deploy Apache APISIX and Apache APISIX Ingress Controller on Rancher</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/21/use-Java-to-write-Apache-APISIX-plugins">How to Write an Apache APISIX Plugin in Java</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/18/first-GA-version-v1.0-of-Apache-APISIX-Ingress-Controller-released">The first GA release of Apache APISIX Ingress Controller v1.0 is now available!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/17/Apache-APISIX-Dashboard-Access-Control-Bypass-Vulnerability-Announcement">Apache APISIX Dashboard Access Control Bypass Vulnerability Advisory (CVE-2021-33190)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/16/Chaos-Mesh-helps-Apache-APISIX-improve-stability">Chaos Mesh Helps Apache APISIX Improve Stability</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/10/Apache-APISIX-and-Envoy-performance-comparison">Apache APISIX v.s Envoy: Which Has the Better Performance?</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/07/Apache-APISIX-not-affected-by-NGINX-CVE-2021-23017">Apache APISIX not affected by NGINX CVE-2021-23017</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/06/apisix-two-years">Apache APISIX Open Source 2 Year Anniversary!</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/03/experience-share-from-Apache-APISIX-committer">Experience sharing from Apache APISIX committer - Interview with Summer of Programming</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/05/25/Apache APISIX 2.6.0-Release">Apache APISIX 2.6.0-Release Officially Released</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/05/24/Tencent-Games">支持 10 亿日流量的基础设施：当 Apahce APISIX 遇上腾讯</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/03/02/get-front-end-test-coverage-with-cypress">Get Front-End Test Coverage with Cypress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/02/26/install-apache-apisix-from-helm-charts">Install Apache APISIX from Helm Charts</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/02/08/stable-product-delivery-with-cypress">Stable Product Delivery with Cypress</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/01/21/run-ingress-apisix-on-amazon-eks">Run Ingress APISIX on Amazon EKS</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/01/11/interview-Apache-APISIX-contributor-Wang-Pengcheng-Senior-Security-Advisor-of-PwC-South-China-Data-Security-and-Privacy-Protection-Team">Apache APISIX Contributor Interview | Pengcheng Wang, Senior Security Consultant, PricewaterhouseCoopers China Data Security &amp; Privacy Team</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/12/18/first-look-at-kubernetes-service-api">A First Look at Kubernetes Service APIs</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/12/16/another-way-to-implement-envoy-filter">Envoy and Apache APISIX: Another way to implement the Envoy filter</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/12/11/beike-how-to-build-gateway-based-on-apache-apisix">贝壳找房：如何基于 Apache APISIX 搭建网关</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Apache APISIX Architecture Analysis: How to Dynamically Manage Nginx Clustering?</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-10T00:00:00.000Z" itemprop="datePublished">August 10, 2021</time> · 17 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Hui Tao</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>This article is re-posted from Tao Hui&#x27;s personal blog, and introduces the principles of Apache APISIX for REST API remote control of Nginx clusters based on APISIX version 2.8, OpenResty version 1.19.3.2, and Nginx version 1.19.3.</p></blockquote><p>One of the most criticized aspects of the open source version of Nginx is that it does not have dynamic configuration, remote API, and cluster management capabilities. Apache APISIX, the open source seven-tier gateway graduated from the Apache Foundation, implements dynamic management of Nginx clusters based on etcd and Lua.</p><p><img src="https://static.apiseven.com/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.png" alt="APISIX architecture diagram"></p><p>Making Nginx dynamically, cluster-managed is not easy, as it would face the following problems.</p><ul><li>The microservices architecture makes for a large variety and number of upstream services, which leads to extremely frequent changes to routing rules, and upstream Servers. Nginx&#x27;s route matching is based on static Trie prefix trees, hash tables, and regular arrays, so once <code>server_name</code> and <code>location</code> change, it is impossible to dynamically change the configuration without performing a reload.</li><li>Nginx positions itself as an ADC edge load balancer, so it does not support the HTTP2 protocol upstream. This makes it more difficult for the OpenResty ecosystem to implement the etcd gRPC interface, so receiving configuration changes through the watch mechanism is inefficient</li><li>Multi-process architecture makes it harder to synchronize data between worker processes, so you must choose a low-cost implementation mechanism to ensure that each Nginx node and worker process has the latest configuration</li></ul><p>Apache APISIX is based on the Lua timer and the lua-resty-etcd module for dynamic configuration management. The principle of Nginx clustering.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="configuration-synchronization-scheme-based-on-etcd-watch-mechanism"></a>Configuration synchronization scheme based on etcd watch mechanism<a class="hash-link" href="#configuration-synchronization-scheme-based-on-etcd-watch-mechanism" title="Direct link to heading">#</a></h2><p>Managing a cluster must rely on a centralized configuration, and etcd is one such database. etcd was not chosen as the configuration center for Apache APISIX because it has two advantages.</p><ul><li>etcd uses the Paxos-like Raft protocol to guarantee data consistency, and it is a decentralized, distributed database that is more reliable than relational databases</li><li>etcd&#x27;s watch mechanism allows clients to monitor changes to a key, i.e., if the value of a key like /nginx/http/upstream changes, the watch client will be notified immediately, as shown in the following figure.
<img src="https://static.apiseven.com/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.jpeg" alt="etcd-based synchronization of nginx configuration"></li></ul><p>Therefore, unlike Orange and Kong, Apache APISIX uses etcd as the centralized configuration component. You can see a similar configuration in a production environment of Apache APISIX via etcdctl as follows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># etcdctl get &quot;/apisix/upstreams/1&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">/apisix/upstreams/1</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token key atrule" style="color:#00a4db">&quot;hash_on&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vars&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;nodes&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">&quot;httpbin.org</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">80&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;create_time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1627982128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;update_time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1627982128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;scheme&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; roundrobin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;pass_host&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pass&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where the prefix /apisix can be changed in conf/config.yaml, e.g.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:2379&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /apisix </span><span class="token comment" style="color:#999988;font-style:italic"># apisix configurations prefix</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and upstreams/1 is equivalent to http { upstream 1 {} } in nginx.conf. Similar keywords are used in /apisix/services/, /apisix/routes/, and so on.</p><p>So, how does Nginx get the etcd configuration data changes through the watch mechanism? Does it start a new agent process? Does it communicate with etcd via HTTP/1.1 or gRPC?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="ngxtimerat-timer"></a>ngx.timer.at timer<a class="hash-link" href="#ngxtimerat-timer" title="Direct link to heading">#</a></h2><p>Apache APISIX does not start a process other than Nginx to communicate with etcd. It actually implements the watch mechanism through the <code>ngx.timer.at</code> timer. For those who are not familiar with OpenResty, let&#x27;s take a look at how the timer is implemented in Nginx, which is the basis for the watch mechanism.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="nginxs-red-black-tree-timer"></a>Nginx&#x27;s red-black tree timer<a class="hash-link" href="#nginxs-red-black-tree-timer" title="Direct link to heading">#</a></h3><p>Nginx uses an epoll + nonblock socket multiplexing mechanism to implement an event handling model in which each worker process cycles through network IO and timer events.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><pre tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//see the src/os/unix/ngx_process_cycle.c file for Nginx</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_worker_process_cycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ngx_cycle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">ngx_process_events_and_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// See the ngx_proc.c file</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_process_events_and_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ngx_cycle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_event_find_timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_process_events</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_process_posted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ngx_posted_accept_events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_expire_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_process_posted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ngx_posted_events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>ngx_event_expire_timers</code> function calls the handler method of all timeout events. In fact, the timer is implemented by a <a href="https://zh.wikipedia.org/zh-hans/%E7%BA%A2%E9%BB%91%E6%A0%91" target="_blank" rel="noopener noreferrer">red-black tree</a> (a balanced ordered binary tree), where the key is the absolute expiration time of each event. This way, expired events can be found quickly by comparing the minimum node with the current time.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="lua-timer-for-openresty"></a>Lua timer for OpenResty<a class="hash-link" href="#lua-timer-for-openresty" title="Direct link to heading">#</a></h3><p>Of course, the above C functions are very inefficient to develop. Therefore, OpenResty wraps the Lua interface and exposes the C function <code>ngx_timer_add</code> to the Lua language via <a href="https://github.com/openresty/lua-nginx-module#ngxtimerat" target="_blank" rel="noopener noreferrer">ngx.timer.at</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly c"><pre tabindex="0" class="prism-code language-c codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//see OpenResty /ngx_lua-0.10.19/src/ngx_http_lua_timer.c file</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_inject_timer_api</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_createtable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* narr */</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* nrec */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ngx.timer. */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_pushcfunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ngx_http_lua_ngx_timer_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_setfield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;at&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_setfield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;timer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_helper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_helper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> every</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ngx_event_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ngx_http_lua_timer_handler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_add_timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> delay</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So when we call <code>ngx.timer.at</code> Lua timer, we are adding the <code>ngx_http_lua_timer_handler</code> callback function to Nginx&#x27;s red-black tree timer, which does not block Nginx.</p><p>Let&#x27;s see how Apache APISIX uses <code>ngx.timer.at</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="apache-apisix-timer-based-watch-mechanism"></a>Apache APISIX timer-based watch mechanism<a class="hash-link" href="#apache-apisix-timer-based-watch-mechanism" title="Direct link to heading">#</a></h3><p>The Nginx framework provides a number of hooks for C module development, and OpenResty exposes some of them as Lua, as shown in the following image.</p><p><img src="https://static.apiseven.com/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.png" alt="openresty hooks"></p><p>Apache APISIX uses only eight of these hooks (note that APISIX does not use <code>set_by_lua</code> and <code>rewrite_by_lua</code>; the rewrite phase of the plugin is actually self-defined by Apache APISIX and is not related to Nginx), including</p><ul><li>init_by_lua: initialization of the Master process when it starts</li><li>init_worker_by_lua: initialization of each worker process at startup (including initialization of privileged agent processes, which are key to implementing remote RPC calls from multilingual plugins such as Java)</li><li>ssl_certificate_by_lua: openssl provides a hook when handling the TLS handshake, which OpenResty exposes as Lua by modifying the Nginx source code</li><li>access_by_lua: After receiving the downstream HTTP request header, it matches the routing rules such as Host domain, URI, Method, etc., and selects the Service, plugins in Upstream and upstream Server.</li><li>balancer_by_lua: All reverse proxy modules executed in the content phase call back the <code>init_upstream</code> hook function, named <code>balancer_by_lua</code> by OpenResty, when the upstream Server is selected.</li><li>header_filter_by_lua: hook to be executed before sending HTTP response headers downstream</li><li>body_filter_by_lua: hook to be executed before sending the HTTP response packet body downstream</li><li>log_by_lua: hook for logging access logs</li></ul><p>Once we have the above knowledge ready, we can answer how Apache APISIX receives updates to etcd data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="how-nginxconf-is-generated"></a>How nginx.conf is generated<a class="hash-link" href="#how-nginxconf-is-generated" title="Direct link to heading">#</a></h4><p>Each Nginx worker process starts a timer in the <code>init_worker_by_lua</code> phase with the <code>http_init_worker</code> function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">init_worker_by_lua_block {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    apisix.http_init_worker()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You may be curious to know that you don&#x27;t see nginx.conf after downloading the Apache APISIX source code, where did this configuration come from?</p><p>The nginx.conf here is actually generated in real time by the Apache APISIX startup command. When you execute make run, it generates nginx.conf based on the Lua template apisix/cli/ngx_tpl.lua file. Note that the template rules here are self-implemented by OpenResty; see <a href="https://github.com" target="_blank" rel="noopener noreferrer">lua-resty-template</a> for syntax details. /bungle/lua-resty-template). See the apisix/cli/ops.lua file for the specific code that generates nginx.conf.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">local template = require(&quot;resty.template&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local ngx_tpl = require(&quot;apisix.cli.ngx_tpl&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function init(env)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local yaml_conf, err = file.read_yaml_conf(env.apisix_home)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local conf_render = template.compile(ngx_tpl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ngxconf = conf_render(sys_conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = util.write_file(env.apisix_home .. &quot;/conf/nginx.conf&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    ngxconf)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Of course, Apache APISIX allows you to modify some of the data in the nginx.conf template by modifying the conf/config.yaml configuration in a way that mimics the syntax of conf/config-default.yaml. See the <code>read_yaml_conf</code> function for an example of how to do this.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.read_yaml_conf(apisix_home)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local local_conf_path = profile:yaml_path(&quot;config-default&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local default_conf_yaml, err = util.read_file(local_conf_path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_conf_path = profile:yaml_path(&quot;config&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local user_conf_yaml, err = util.read_file(local_conf_path)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok, err = merge_conf(default_conf, user_conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, only some of the data in the ngx_tpl.lua template can be replaced by the yaml configuration, where conf/config-default.yaml is the official default configuration, and conf/config.yaml is a custom configuration overridden by the user. If you feel that replacing the template data is not enough, you can modify the ngx_tpl template directly.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithHideOnScrollNavbar_3R7-" id="how-apache-apisix-gets-etcd-notifications"></a>How Apache APISIX gets etcd notifications<a class="hash-link" href="#how-apache-apisix-gets-etcd-notifications" title="Direct link to heading">#</a></h4><p>Apache APISIX stores the configurations to be monitored in etcd with different prefixes, which currently include the following 11 types.</p><ul><li>/apisix/consumers/: Apache APISIX supports the consumer abstraction upstream category</li><li>/apisix/global_rules/: global generic rules</li><li>/apisix/plugin_configs/: Plugin that can be reused across Router</li><li>/apisix/plugin_metadata/: metadata of some plugins</li><li>/apisix/plugins/: list of all Plugin plugins</li><li>/apisix/proto/: When passing the gRPC protocol, some plugins need to convert the protocol content, this configuration stores the protobuf message definition</li><li>/apisix/routes/: Routing information, which is the entry point for HTTP request matching, you can specify the upstream Server directly, or mount services or upstream</li><li>/apisix/services/: you can abstract the common parts of similar router as services and mount the plugin</li><li>/apisix/ssl/: SSL certificate public and private keys and related matching rules</li><li>/apisix/stream_routes/: route matching rules for OSI Layer 4 gateways</li><li>/apisix/upstreams/: abstraction of a set of upstream Server hosts</li></ul><p>Each type of configuration here has a different processing logic, so Apache APISIX abstracts the apisix/core/config_etcd.lua file to focus on the update maintenance of each type of configuration on etcd. Each type of configuration in the <code>http_init_worker</code> function generates 1 config_etcd object.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.init_worker()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local err</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_configs, err = core.config.new(&quot;/plugin_configs&quot;, {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        automatic = true,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        item_schema = core.schema.plugin_config,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        checker = plugin_checker,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And in the new function of <code>config_etcd</code>, the <code>_automatic_fetch</code> timer will be registered recursively:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.new(key, opts)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ngx_timer_at(0, _automatic_fetch, obj)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>_automatic_fetch</code> function iterates the <code>sync_data</code> function (wrapped under xpcall to catch exceptions).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">local function _automatic_fetch(premature, self)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = xpcall(function()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        local ok, err = sync_data(self)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    end, debug.traceback)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ngx_timer_at(0, _automatic_fetch, self)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>sync_data</code> function will get updates through etcd&#x27;s watch mechanism, which we will analyze in detail next.</p><p>So to summarize, Apache APISIX inserts <code>_automatic_fetch</code> into the timer via the <code>ngx.timer.at</code> function during the startup of each Nginx worker process. The <code>_automatic_fetch</code> function receives notifications of configuration changes in etcd through the <code>sync_data</code> function, based on a watch mechanism, so that each Nginx node and worker process will be kept up to date with the latest configuration. This design also has one obvious advantage: the configuration in etcd is written directly to the Nginx worker process, so that the new configuration can be used directly when processing requests, without having to synchronize the configuration between processes, which is easier than starting an agent process!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="http11-protocol-for-the-lua-resty-etcd-library"></a>HTTP/1.1 protocol for the lua-resty-etcd library<a class="hash-link" href="#http11-protocol-for-the-lua-resty-etcd-library" title="Direct link to heading">#</a></h3><p>How exactly does the <code>sync_data</code> function get the configuration change messages from etcd? Let&#x27;s look at the <code>sync_data</code> source code.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">local etcd = require(&quot;resty.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd_cli, err = etcd.new(etcd_conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function sync_data(self)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dir_res, err = waitdir(self.etcd_cli, self.key, self.prev_index + 1, self.timeout)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function waitdir(etcd_cli, key, modified_index, timeout)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res_func, func_err, http_cli = etcd_cli:watchdir(key, opts)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if http_cli then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        local res_cancel, err_cancel = etcd_cli:watchcancel(http_cli)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The actual communication with etcd here is the <a href="https://github.com/api7/lua-resty-etcd" target="_blank" rel="noopener noreferrer">lua-resty-etcd</a> library. It provides the watchdir function to receive notifications from etcd when it finds a change in the value of the key directory.</p><p>And what does the watchcancel function do? This is actually the result of a deficiency in the OpenResty ecosystem. etcd v3 already supports the efficient gRPC protocol (the underlying HTTP2 protocol). As you may have heard, HTTP2 not only has the ability to multiplex, but also supports direct server pushing of messages from the HTTP3 protocol against HTTP2: !</p><p><img src="https://static.apiseven.com/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.png" alt="http2_stream_frame_conn"></p><p>However, Lua Eco does not currently support the HTTP2 protocol, so the lua-resty-etcd library actually communicates with etcd via the inefficient HTTP/1.1 protocol, and therefore receives /watch notifications via /v3/watch requests with timeouts. This phenomenon is actually caused by two things.</p><ol><li>Nginx positions itself as an edge load balancer, so the upstream must be the corporate intranet, which has low latency and high bandwidth, so it does not need to support the HTTP2 protocol for the upstream protocol
The HTTP2 protocol is very complex, and there is no HTTP2 cosocket library available for production environments.</li></ol><p>The lua-resty-etcd library using HTTP/1.1 is actually very inefficient, and if you capture packets on APISIX, you will see frequent POST messages with a URI of /v3/watch and a Base64-encoded watch directory with a body of</p><p><img src="https://static.apiseven.com/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.jpeg" alt="APISIX communicates with etcd over HTTP1"></p><p>We can verify the implementation details of the <code>watchdir</code> function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- lib/resty/etcd/v3.lua 文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.watchdir(self, key, opts)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return watch(self, key, attr)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function watch(self, key, attr)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback_fun, err, http_cli = request_chunk(self, &#x27;POST&#x27;, &#x27;/watch&#x27;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                opts, attr.timeout or self.timeout)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return callback_fun</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function request_chunk(self, method, path, opts, timeout)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    http_cli, err = utils.http.new()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 发起 TCP 连接</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint, err = http_request_chunk(self, http_cli)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 发送 HTTP 请求</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res, err = http_cli:request({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        method  = method,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        path    = endpoint.api_prefix .. path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        body    = body,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        query   = query,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers = headers,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function http_request_chunk(self, http_cli)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local endpoint, err = choose_endpoint(self)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok, err = http_cli:connect({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheme = endpoint.scheme,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        host = endpoint.host,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = endpoint.port,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_verify = self.ssl_verify,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_cert_path = self.ssl_cert_path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_key_path = self.ssl_key_path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return endpoint, err</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, Apache APISIX makes sure that each worker process contains the latest configuration by <strong>repeatedly requesting etcd through the <code>ngx.timer.at</code> and lua-resty-etcd libraries in each worker process.</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="apisix-configuration-and-plugin-remote-changes"></a>APISIX configuration and plugin remote changes<a class="hash-link" href="#apisix-configuration-and-plugin-remote-changes" title="Direct link to heading">#</a></h2><p>Next, let&#x27;s look at how to remotely modify the configuration in etcd.</p><p>We can of course modify the contents of the corresponding key in etcd directly through the gRPC interface, and then make the Nginx cluster automatically update its configuration based on the watch mechanism described above. However, this is risky because the configuration request is not verified, and the configuration data does not match the Nginx cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="modifying-configuration-via-nginxs-apisixadmin-interface"></a>Modifying configuration via Nginx&#x27;s /apisix/admin/ interface<a class="hash-link" href="#modifying-configuration-via-nginxs-apisixadmin-interface" title="Direct link to heading">#</a></h3><p>Apache APISIX provides a mechanism to access any one Nginx node, verify the request with Lua code in its worker process, and then write it to etcd through the /v3/dv/put interface. Let&#x27;s take a look at how Apache APISIX does this.</p><p>First, the nginx.conf generated by make run automatically listens on port 9080 (as modified by the apisix.node_listen configuration in config.yaml), and when <code>apisix.enable_admin</code> is set to true, nginx.conf will generate the following configuration.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 9080 default_server reuseport;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location/apisix/admin </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        content_by_lua_block </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            apisix.http_admin()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Thus, the /apisix/admin requests received by Nginx will be processed by the <code>http_admin</code> function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/init.lua file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.http_admin()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok = router:dispatch(get_var(&quot;uri&quot;), {method = get_method()})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>See the <a href="https://github.com/apache/apisix/blob/release/2.8/docs/zh/latest/admin-api.md" target="_blank" rel="noopener noreferrer">GitHub</a> documentation for APIs that the admin interface can handle, where when the method method differs from the URI, the dispatch performs different handler functions based on the following.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local uri_route = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/*]],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = { &quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = run,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/stream_routes/*]],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;}, { paths = [[/apisix/admin/stream_routes/*]], { methods = {&quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = run_stream,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/plugins/list]],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;GET&quot;},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = get_plugins_list,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = reload_event,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;PUT&quot;},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = post_reload_plugins,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For example, when creating 1 Upstream via /apisix/admin/upstreams/1 and the PUT method.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:9080/apisix/admin/upstreams/1&quot;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   &quot;type&quot;: &quot;roundrobin&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   &quot;nodes&quot;: {</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;     &quot;httpbin.org:80&quot;: 1</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt; }</span></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{&quot;action&quot;:&quot;set&quot;,&quot;node&quot;:{&quot;key&quot;:&quot;\/apisix\/upstreams\/1&quot;,&quot;value&quot;:{&quot;hash_on&quot;:&quot;vars&quot;,&quot;nodes&quot;:{&quot;httpbin.org:80&quot;:1},&quot;create_time&quot;:1627982128,&quot;update_time&quot;:1627982128,&quot;scheme&quot;:&quot;http&quot;,&quot;type&quot;:&quot;roundrobin&quot;,&quot;pass_host&quot;:&quot;pass&quot;,&quot;id&quot;:&quot;1&quot;}}}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You will see the following log in error.log (to see this line, you must set the nginx_config.error_log_level in config.yaml to INFO)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">2021/08/03 17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">28 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> 16437</span><span class="token comment" style="color:#999988;font-style:italic">#16437: *23572 [lua] init.lua:130: handler(): uri: [&quot;&quot;,&quot;apisix&quot;,&quot;admin&quot;,&quot;upstreams&quot;,&quot;1&quot;], client: 127.0.0.1, server: _, request: &quot;PUT /apisix/admin/upstreams/1 HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This line is actually printed by the <code>run</code> function in /apisix/admin/init.lua, which is executed based on the uri_route dictionary above. Let&#x27;s look at the contents of the run function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function run()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local uri_segs = core.utils.split_uri(ngx.var.uri)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    core.log.info(&quot;uri: &quot;, core.json.delay_encode(uri_segs))</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local seg_res, seg_id = uri_segs[4], uri_segs[5]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local seg_sub_path = core.table.concat(uri_segs, &quot;/&quot;, 6)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local resource = resources[seg_res]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local code, data = resource[method](seg_id, req_body, seg_sub_path,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        uri_args)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>这里 <code>resource[method]</code> 函数又被做了 1 次抽象，它是由 resources 字典决定的：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua文件</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local resources = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    routes          = require(&quot;apisix.admin.routes&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    services        = require(&quot;apisix.admin.services&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    upstreams       = require(&quot;apisix.admin.upstreams&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumers       = require(&quot;apisix.admin.consumers&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema          = require(&quot;apisix.admin.schema&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl             = require(&quot;apisix.admin.ssl&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugins         = require(&quot;apisix.admin.plugins&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    proto           = require(&quot;apisix.admin.proto&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    global_rules    = require(&quot;apisix.admin.global_rules&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    stream_routes   = require(&quot;apisix.admin.stream_routes&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_metadata = require(&quot;apisix.admin.plugin_metadata&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_configs  = require(&quot;apisix.admin.plugin_config&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Therefore, the above curl request will be processed by the <code>put</code> function in the /apisix/admin/upstreams.lua file, see the implementation of the <code>put</code> function as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/upstreams.lua file</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.put(id, conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- check the legitimacy of the requested data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local id, err = check_conf(id, conf, true)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local key = &quot;/upstreams/&quot; .. id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    core.log.info(&quot;key: &quot;, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Generate configuration data in etcd</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = utils.inject_conf_with_prev_conf(&quot;upstream&quot;, key, conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- write to etcd</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res, err = core.etcd.set(key, conf)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/core/etcd.lua</span></span><span class="token-line" style="color:#393A34"><span class="token plain">local function set(key, value, ttl)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res, err = etcd_cli:set(prefix ... key, value, {prev_kv = true, lease = data.body.ID})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The new configuration is eventually written to etcd. As you can see, Nginx verifies the data before writing it to etcd, so that other worker processes and Nginx nodes will receive the correct configuration through the watch mechanism. You can verify this process with the logs in error.log.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">2021/08/03 17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">28 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> 16437</span><span class="token comment" style="color:#999988;font-style:italic">#16437: *23572 [lua] upstreams.lua:72: key: /upstreams/1, client: 127.0.0.1, server: _, request: &quot;PUT /apisix/admin/upstreams/1 HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithHideOnScrollNavbar_3R7-" id="why-the-new-configuration-works-without-reload"></a>Why the new configuration works without reload<a class="hash-link" href="#why-the-new-configuration-works-without-reload" title="Direct link to heading">#</a></h3><p>Let&#x27;s look at how the Nginx worker process takes effect immediately after the admin request is executed.</p><p>The open source version of Nginx matches requests based on three different containers.</p><ol><li><p>The <code>server_name</code> configuration in the static hash table is matched to the requested <code>Host</code> domain name</p></li><li><p>Next, the location in the static Trie prefix tree is configured to match the requested URI</p><p><img src="https://static.apiseven.com/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.png" alt="Matching process for location prefix tree 2"></p></li><li><p>In both of these processes, if there are regular expressions, they are matched in order based on the order of the arrays (the order they appear in nginx.conf).</p></li></ol><p>Although these procedures are very efficient, they are written to die in the find_config phase and in the Nginx HTTP framework, and changes must be made after nginx -s reload to take effect. For this reason, Apache APISIX has abandoned this process altogether.</p><p>As you can see in nginx.conf, requests to any domain name, URI, or domain name will match the <code>http_access_phase</code> lua function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name _;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        access_by_lua_block {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            apisix.http_access_phase()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass      $upstream_scheme://apisix_backend$upstream_uri;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>http_access_phase</code> function will match Method, domain and URI based on a base prefix tree implemented in C (only wildcards are supported, no regular expressions), the library is [lua-resty-radixtree](<a href="https://github.com/api7/lua" target="_blank" rel="noopener noreferrer">https://github.com/api7/lua</a> -resty-radixtree). Whenever the routing rules change, the Lua code rebuilds this base tree: the</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.match(api_ctx)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not cached_version or cached_version ~= user_routes.conf_version then</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        uri_router = base_router.create_radixtree_uri_router(user_routes.values,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                             uri_routes, false)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cached_version = user_routes.conf_version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The rules for Plugin enablement, parameter and order adjustment are similar.</p><p>Finally, Script is mutually exclusive with Plugin. In fact, Lua JIT&#x27;s just-in-time compilation provides another killer feature, loadstring, which converts strings to Lua code. So, after storing Lua code in etcd and setting it to Script, you can pass it to Nginx to process requests.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithHideOnScrollNavbar_3R7-" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Nginx cluster management must rely on a centralized configuration component, and etcd, which is highly reliable and has a watch push mechanism, is the perfect choice! Although the Resty ecosystem does not have a gRPC client, it is still a good idea for each worker process to synchronize etcd configuration directly via the HTTP/1.1 protocol.</p><p>The key to dynamically modifying the Nginx configuration is 2 things: the Lua language is much more flexible than the nginx.conf syntax, and Lua code can be imported from external data via loadstring. Of course, to ensure efficient execution of route matching, Apache APISIX implements a prefix base tree in C to match requests based on Host, Method, and URI, improving performance while maintaining dynamism.</p><p>Apache APISIX has many good designs, and this article only discusses the dynamic management of Nginx clusters.</p><p><a href="https://www.taohui.tech/2021/08/10/%E5%BC%80%E6%BA%90%E7%BD%91%E5%85%B3APISIX%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/#more" target="_blank" rel="noopener noreferrer">click here for the link to the original article</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/technology">Technology</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/08/11/interview-TuZhengsong"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« I issued my first PR in the Apache APISIX community</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/08/09/Apache-APISIX-in-China-Mobile-Cloud"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Apache APISIX 在移动云的应用 »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuration-synchronization-scheme-based-on-etcd-watch-mechanism" class="table-of-contents__link">Configuration synchronization scheme based on etcd watch mechanism</a></li><li><a href="#ngxtimerat-timer" class="table-of-contents__link">ngx.timer.at timer</a><ul><li><a href="#nginxs-red-black-tree-timer" class="table-of-contents__link">Nginx&#39;s red-black tree timer</a></li><li><a href="#lua-timer-for-openresty" class="table-of-contents__link">Lua timer for OpenResty</a></li><li><a href="#apache-apisix-timer-based-watch-mechanism" class="table-of-contents__link">Apache APISIX timer-based watch mechanism</a></li><li><a href="#http11-protocol-for-the-lua-resty-etcd-library" class="table-of-contents__link">HTTP/1.1 protocol for the lua-resty-etcd library</a></li></ul></li><li><a href="#apisix-configuration-and-plugin-remote-changes" class="table-of-contents__link">APISIX configuration and plugin remote changes</a><ul><li><a href="#modifying-configuration-via-nginxs-apisixadmin-interface" class="table-of-contents__link">Modifying configuration via Nginx&#39;s /apisix/admin/ interface</a></li><li><a href="#why-the-new-configuration-works-without-reload" class="table-of-contents__link">Why the new configuration works without reload</a></li></ul></li><li><a href="#summary" class="table-of-contents__link">Summary</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ASF</div><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker</a></li><li class="footer__item"><a href="https://apisix.apache.org/docs/general/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://apisix.apache.org/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2019-2021 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e8843a10.js"></script>
<script src="/assets/js/main.8811c3d7.js"></script>
</body>
</html>