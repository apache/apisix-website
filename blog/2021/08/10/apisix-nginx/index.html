<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="ahrefs-site-verification" content="c2f7370ecf46173f4fb25f114e74c97e0a2976d4f02f61c9b00a9d7d34e34698">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIX® -- Cloud-Native API Gateway and AI Gateway" href="/opensearch.xml">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Apache APISIX","url":"https://apisix.apache.org"}</script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="24b59d9a-682e-4c3d-9e83-bf2ee85cdc19" data-project-name="APISIX" data-project-color="#E8442E" data-project-logo="https://static.apiseven.com/202202/apache-apisix.png" data-modal-disclaimer="This is a custom LLM for APISIX with access to all developer documentation, GitHub issues and discussions." data-modal-example-questions="How to set up canary release in APISIX?,How to develop a custom APISIX plugin?,How to use custom NGINX configuration in APISIX?,How to configure mTLS between clients and APISIX?,How to only allow a specific APISIX consumer to access special services or routes?" async></script><title data-react-helmet="true">APISIX Architecture: How to Dynamically Manage NGINX Cluster? | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway</title><meta data-react-helmet="true" property="og:image" content="https://static.apiseven.com/202202/apache-apisix.png"><meta data-react-helmet="true" name="twitter:image" content="https://static.apiseven.com/202202/apache-apisix.png"><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org/blog/2021/08/10/apisix-nginx/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" name="twitter:card" content="summary"><meta data-react-helmet="true" property="og:title" content="APISIX Architecture: How to Dynamically Manage NGINX Cluster? | Apache APISIX® -- Cloud-Native API Gateway and AI Gateway"><meta data-react-helmet="true" name="description" content="This article mainly introduces the principle of APISIX to implement REST API remote control of Nginx cluster based on APISIX 2.8, OpenResty 1.19.3.2 and Nginx 1.19.3."><meta data-react-helmet="true" property="og:description" content="This article mainly introduces the principle of APISIX to implement REST API remote control of Nginx cluster based on APISIX 2.8, OpenResty 1.19.3.2 and Nginx 1.19.3."><meta data-react-helmet="true" name="keywords" content="API Gateway,Apache APISIX,Nginx,Lua,Dynamic Management"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-08-10T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="Ecosystem"><link data-react-helmet="true" rel="shortcut icon" href="https://static.apiseven.com/202202/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx/"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org/blog/2021/08/10/apisix-nginx/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://38VC84A2WJ-dsn.algolia.net" crossorigin="anonymous"><link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Medium.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Bold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Light.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-Demi.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://static.apiseven.com/202202/MaisonNeue-ExtraBold.otf" as="font" type="font/otf" crossorigin>
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js" as="script">
<link rel="preload" href="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js" as="script">
<link rel="stylesheet" href="https://apisix-website-static.apiseven.com/assets/css/styles.9943cb19.css">
<!-- Matomo from the ASF -->
<script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var a="https://analytics.apache.org/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","17"]);var e=document,p=e.createElement("script"),t=e.getElementsByTagName("script")[0];p.async=!0,p.src=a+"matomo.js",t.parentNode.insertBefore(p,t)}()</script>
<!-- End Matomo Code -->
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" style="background-color:#e8433e;color:white" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">🤔 Introducing APISIX AI Gateway – Built for LLMs and AI workloads. <a target="_blank" rel="noopener noreferrer" href="/ai-gateway/"> Learn More</a></div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_RReh"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a target="_parent" class="navbar__brand" href="/"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo2.svg" alt="Apache APISIX®" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache APISIX®</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" target="_parent" href="/docs/">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/docs/apisix/getting-started/">Apache APISIX®️</a></li><li><a class="dropdown__link" target="_parent" href="/docs/apisix/next/dashboard/">Apache APISIX®️ Dashboard</a></li><li><a class="dropdown__link" target="_parent" href="/docs/ingress-controller/overview/">Apache APISIX®️ Ingress Controller</a></li><li><a class="dropdown__link" target="_parent" href="/docs/helm-chart/apisix/">Apache APISIX®️ Helm Charts</a></li><li><a class="dropdown__link" target="_parent" href="/docs/docker/build/">Apache APISIX®️ Docker</a></li><li><a class="dropdown__link" target="_parent" href="/docs/java-plugin-runner/development/">Apache APISIX®️ Java Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/go-plugin-runner/getting-started/">Apache APISIX®️ Go Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/python-plugin-runner/getting-started/">Apache APISIX®️ Python Plugin Runner</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">General</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_parent" href="/blog/">Blog</a><a class="navbar__item navbar__link" target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a class="navbar__item navbar__link" target="_parent" href="/downloads/">Downloads</a><a class="navbar__item navbar__link" target="_parent" href="/help/">Help</a><a class="navbar__item navbar__link" target="_parent" href="/team/">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_parent" href="/showcase/">Showcase</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/code-samples/">Code Samples</a></li><li><a class="dropdown__link" target="_parent" href="/plugins/">PluginHub</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/join/">Community</a></li><li><a class="dropdown__link" target="_parent" href="/docs/general/events/">Events</a></li><li><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li></ul></div><a href="/zh/blog" target="_parent" rel="noopener noreferrer" class="localizedBlogLink_W2zh">中文博客</a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_SGhp"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="sticky-outer-wrapper placeholder_iq-X"><div class="sticky-inner-wrapper" style="position:relative;top:0px;z-index:199"><div class="tagsHeader_HGHP"><a target="_parent" href="/blog/tags/case-studies/">Case Studies</a><a target="_parent" href="/blog/tags/ecosystem/">Ecosystem</a><a target="_parent" href="/blog/tags/authentication/">Authentication</a><a target="_parent" href="/blog/tags/plugins/">Plugins</a><a target="_parent" href="/blog/tags/community/">Community</a><a target="_parent" href="/blog/tags/vulnerabilities/">Vulnerabilities</a></div></div></div><div class="container margin-vert--lg"><div class="row" style="justify-content:center"><div class="col col--9"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">APISIX Architecture: How to Dynamically Manage NGINX Cluster?</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-08-10T00:00:00.000Z" itemprop="datePublished">August 10, 2021</time> · <!-- -->17 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_dGI0"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link avatar__photo"><div size="48" color="EEEDFD" class="go2679483636"><p color="4409B9" size="48" class="go1017449453">Hu</p></div></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Hui Tao</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><blockquote><p>This article is re-posted from Tao Hui&#x27;s personal blog, and introduces the principles of Apache APISIX for REST API remote control of Nginx clusters based on APISIX version 2.8, OpenResty version 1.19.3.2, and Nginx version 1.19.3.</p></blockquote><p>One of the most criticized aspects of the open source version of Nginx is that it does not have dynamic configuration, remote API, and cluster management capabilities. Apache APISIX, the open source seven-tier gateway graduated from the Apache Foundation, implements dynamic management of Nginx clusters based on etcd and Lua.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.webp, https://static.apiseven.com/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.png" alt="APISIX architecture diagram" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.png" alt="APISIX architecture diagram" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170283612-ba5e27ff-726b-47a6-aa51-84731b067c44.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Making Nginx dynamically, cluster-managed is not easy, as it would face the following problems.</p><ul><li>The microservices architecture makes for a large variety and number of upstream services, which leads to extremely frequent changes to routing rules, and upstream Servers. Nginx&#x27;s route matching is based on static Trie prefix trees, hash tables, and regular arrays, so once <code>server_name</code> and <code>location</code> change, it is impossible to dynamically change the configuration without performing a reload.</li><li>Nginx positions itself as an ADC edge load balancer, so it does not support the HTTP2 protocol upstream. This makes it more difficult for the OpenResty ecosystem to implement the etcd gRPC interface, so receiving configuration changes through the watch mechanism is inefficient</li><li>Multi-process architecture makes it harder to synchronize data between worker processes, so you must choose a low-cost implementation mechanism to ensure that each Nginx node and worker process has the latest configuration</li></ul><p>Apache APISIX is based on the Lua timer and the lua-resty-etcd module for dynamic configuration management. The principle of Nginx clustering.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="configuration-synchronization-scheme-based-on-etcd-watch-mechanism">Configuration synchronization scheme based on etcd watch mechanism<a aria-hidden="true" class="hash-link" href="#configuration-synchronization-scheme-based-on-etcd-watch-mechanism" title="Direct link to heading">​</a></h2><p>Managing a cluster must rely on a centralized configuration, and etcd is one such database. etcd was chosen as the configuration center for Apache APISIX because it has two advantages.</p><ul><li>etcd uses the Paxos-like Raft protocol to guarantee data consistency, and it is a decentralized, distributed database that is more reliable than relational databases</li><li>etcd&#x27;s watch mechanism allows clients to monitor changes to a key, i.e., if the value of a key like /nginx/http/upstream changes, the watch client will be notified immediately, as shown in the following figure.
<div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.webp, https://static.apiseven.com/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.jpeg" alt="etcd-based synchronization of nginx configuration" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.jpeg" alt="etcd-based synchronization of nginx configuration" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170345853-f020a64d-3e97-49c0-8395-c9e4e9cf4233.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div></li></ul><p>Therefore, unlike Orange and Kong, Apache APISIX uses etcd as the centralized configuration component. You can see a similar configuration in a production environment of Apache APISIX via etcdctl as follows.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># etcdctl get &quot;/apisix/upstreams/1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/apisix/upstreams/1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token key atrule" style="color:#00a4db">&quot;hash_on&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vars&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;nodes&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">&quot;httpbin.org</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">80&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;create_time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1627982128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;update_time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1627982128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;scheme&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> &quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot; roundrobin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;pass_host&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pass&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Where the prefix /apisix can be changed in conf/config.yaml, e.g.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:2379&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /apisix </span><span class="token comment" style="color:#999988;font-style:italic"># apisix configurations prefix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>and upstreams/1 is equivalent to http { upstream 1 {} } in nginx.conf. Similar keywords are used in /apisix/services/, /apisix/routes/, and so on.</p><p>So, how does Nginx get the etcd configuration data changes through the watch mechanism? Does it start a new agent process? Does it communicate with etcd via HTTP/1.1 or gRPC?</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="ngxtimerat-timer">ngx.timer.at timer<a aria-hidden="true" class="hash-link" href="#ngxtimerat-timer" title="Direct link to heading">​</a></h2><p>Apache APISIX does not start a process other than Nginx to communicate with etcd. It actually implements the watch mechanism through the <code>ngx.timer.at</code> timer. For those who are not familiar with OpenResty, let&#x27;s take a look at how the timer is implemented in Nginx, which is the basis for the watch mechanism.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="nginxs-red-black-tree-timer">Nginx&#x27;s red-black tree timer<a aria-hidden="true" class="hash-link" href="#nginxs-red-black-tree-timer" title="Direct link to heading">​</a></h3><p>Nginx uses an epoll + nonblock socket multiplexing mechanism to implement an event handling model in which each worker process cycles through network IO and timer events.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK c"><pre tabindex="0" class="prism-code language-c codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//see the src/os/unix/ngx_process_cycle.c file for Nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_worker_process_cycle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ngx_cycle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">ngx_process_events_and_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// See the ngx_proc.c file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_process_events_and_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ngx_cycle_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_event_find_timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_process_events</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_process_posted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ngx_posted_accept_events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_expire_timers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_event_process_posted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cycle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ngx_posted_events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The <code>ngx_event_expire_timers</code> function calls the handler method of all timeout events. In fact, the timer is implemented by a <a href="https://zh.wikipedia.org/zh-hans/%E7%BA%A2%E9%BB%91%E6%A0%91" target="_blank" rel="noopener noreferrer">red-black tree</a> (a balanced ordered binary tree), where the key is the absolute expiration time of each event. This way, expired events can be found quickly by comparing the minimum node with the current time.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="lua-timer-for-openresty">Lua timer for OpenResty<a aria-hidden="true" class="hash-link" href="#lua-timer-for-openresty" title="Direct link to heading">​</a></h3><p>Of course, the above C functions are very inefficient to develop. Therefore, OpenResty wraps the Lua interface and exposes the C function <code>ngx_timer_add</code> to the Lua language via <a href="https://github.com/openresty/lua-nginx-module#ngxtimerat" target="_blank" rel="noopener noreferrer">ngx.timer.at</a>.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK c"><pre tabindex="0" class="prism-code language-c codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//see OpenResty /ngx_lua-0.10.19/src/ngx_http_lua_timer.c file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_inject_timer_api</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_createtable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* narr */</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* nrec */</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ngx.timer. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_pushcfunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ngx_http_lua_ngx_timer_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_setfield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;at&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lua_setfield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;timer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_helper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ngx_http_lua_ngx_timer_helper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lua_State </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> every</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ngx_event_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ngx_http_lua_timer_handler</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ngx_add_timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> delay</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>So when we call <code>ngx.timer.at</code> Lua timer, we are adding the <code>ngx_http_lua_timer_handler</code> callback function to Nginx&#x27;s red-black tree timer, which does not block Nginx.</p><p>Let&#x27;s see how Apache APISIX uses <code>ngx.timer.at</code>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apache-apisix-timer-based-watch-mechanism">Apache APISIX timer-based watch mechanism<a aria-hidden="true" class="hash-link" href="#apache-apisix-timer-based-watch-mechanism" title="Direct link to heading">​</a></h3><p>The Nginx framework provides a number of hooks for C module development, and OpenResty exposes some of them as Lua, as shown in the following image.</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.webp, https://static.apiseven.com/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.png" alt="openresty hooks" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.png" alt="openresty hooks" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170424663-53f56c99-aefc-4546-ac0b-76a25a6f0071.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>Apache APISIX uses only eight of these hooks (note that APISIX does not use <code>set_by_lua</code> and <code>rewrite_by_lua</code>; the rewrite phase of the plugin is actually self-defined by Apache APISIX and is not related to Nginx), including</p><ul><li>init_by_lua: initialization of the Master process when it starts</li><li>init_worker_by_lua: initialization of each worker process at startup (including initialization of privileged agent processes, which are key to implementing remote RPC calls from multilingual plugins such as Java)</li><li>ssl_certificate_by_lua: openssl provides a hook when handling the TLS handshake, which OpenResty exposes as Lua by modifying the Nginx source code</li><li>access_by_lua: After receiving the downstream HTTP request header, it matches the routing rules such as Host domain, URI, Method, etc., and selects the Service, plugins in Upstream and upstream Server.</li><li>balancer_by_lua: All reverse proxy modules executed in the content phase call back the <code>init_upstream</code> hook function, named <code>balancer_by_lua</code> by OpenResty, when the upstream Server is selected.</li><li>header_filter_by_lua: hook to be executed before sending HTTP response headers downstream</li><li>body_filter_by_lua: hook to be executed before sending the HTTP response packet body downstream</li><li>log_by_lua: hook for logging access logs</li></ul><p>Once we have the above knowledge ready, we can answer how Apache APISIX receives updates to etcd data.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="how-nginxconf-is-generated">How nginx.conf is generated<a aria-hidden="true" class="hash-link" href="#how-nginxconf-is-generated" title="Direct link to heading">​</a></h4><p>Each Nginx worker process starts a timer in the <code>init_worker_by_lua</code> phase with the <code>http_init_worker</code> function.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">init_worker_by_lua_block {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apisix.http_init_worker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>You may be curious to know that you don&#x27;t see nginx.conf after downloading the Apache APISIX source code, where did this configuration come from?</p><p>The nginx.conf here is actually generated in real time by the Apache APISIX startup command. When you execute make run, it generates nginx.conf based on the Lua template apisix/cli/ngx_tpl.lua file. Note that the template rules here are self-implemented by OpenResty; see <a href="https://github.com" target="_blank" rel="noopener noreferrer">lua-resty-template</a> for syntax details. /bungle/lua-resty-template). See the apisix/cli/ops.lua file for the specific code that generates nginx.conf.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local template = require(&quot;resty.template&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local ngx_tpl = require(&quot;apisix.cli.ngx_tpl&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function init(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local yaml_conf, err = file.read_yaml_conf(env.apisix_home)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local conf_render = template.compile(ngx_tpl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ngxconf = conf_render(sys_conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = util.write_file(env.apisix_home .. &quot;/conf/nginx.conf&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    ngxconf)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Of course, Apache APISIX allows you to modify some of the data in the nginx.conf template by modifying the conf/config.yaml configuration in a way that mimics the syntax of conf/config-default.yaml. See the <code>read_yaml_conf</code> function for an example of how to do this.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.read_yaml_conf(apisix_home)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local local_conf_path = profile:yaml_path(&quot;config-default&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local default_conf_yaml, err = util.read_file(local_conf_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local_conf_path = profile:yaml_path(&quot;config&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local user_conf_yaml, err = util.read_file(local_conf_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok, err = merge_conf(default_conf, user_conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>As you can see, only some of the data in the ngx_tpl.lua template can be replaced by the yaml configuration, where conf/config-default.yaml is the official default configuration, and conf/config.yaml is a custom configuration overridden by the user. If you feel that replacing the template data is not enough, you can modify the ngx_tpl template directly.</p><h4 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="how-apache-apisix-gets-etcd-notifications">How Apache APISIX gets etcd notifications<a aria-hidden="true" class="hash-link" href="#how-apache-apisix-gets-etcd-notifications" title="Direct link to heading">​</a></h4><p>Apache APISIX stores the configurations to be monitored in etcd with different prefixes, which currently include the following 11 types.</p><ul><li>/apisix/consumers/: Apache APISIX supports the consumer abstraction upstream category</li><li>/apisix/global_rules/: global generic rules</li><li>/apisix/plugin_configs/: Plugin that can be reused across Router</li><li>/apisix/plugin_metadata/: metadata of some plugins</li><li>/apisix/plugins/: list of all Plugin plugins</li><li>/apisix/proto/: When passing the gRPC protocol, some plugins need to convert the protocol content, this configuration stores the protobuf message definition</li><li>/apisix/routes/: Routing information, which is the entry point for HTTP request matching, you can specify the upstream Server directly, or mount services or upstream</li><li>/apisix/services/: you can abstract the common parts of similar router as services and mount the plugin</li><li>/apisix/ssl/: SSL certificate public and private keys and related matching rules</li><li>/apisix/stream_routes/: route matching rules for OSI Layer 4 gateways</li><li>/apisix/upstreams/: abstraction of a set of upstream Server hosts</li></ul><p>Each type of configuration here has a different processing logic, so Apache APISIX abstracts the apisix/core/config_etcd.lua file to focus on the update maintenance of each type of configuration on etcd. Each type of configuration in the <code>http_init_worker</code> function generates 1 config_etcd object.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.init_worker()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_configs, err = core.config.new(&quot;/plugin_configs&quot;, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        automatic = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        item_schema = core.schema.plugin_config,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        checker = plugin_checker,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>And in the new function of <code>config_etcd</code>, the <code>_automatic_fetch</code> timer will be registered recursively:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.new(key, opts)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ngx_timer_at(0, _automatic_fetch, obj)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The <code>_automatic_fetch</code> function iterates the <code>sync_data</code> function (wrapped under xpcall to catch exceptions).</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local function _automatic_fetch(premature, self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = xpcall(function()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local ok, err = sync_data(self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end, debug.traceback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ngx_timer_at(0, _automatic_fetch, self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The <code>sync_data</code> function will get updates through etcd&#x27;s watch mechanism, which we will analyze in detail next.</p><p>So to summarize, Apache APISIX inserts <code>_automatic_fetch</code> into the timer via the <code>ngx.timer.at</code> function during the startup of each Nginx worker process. The <code>_automatic_fetch</code> function receives notifications of configuration changes in etcd through the <code>sync_data</code> function, based on a watch mechanism, so that each Nginx node and worker process will be kept up to date with the latest configuration. This design also has one obvious advantage: the configuration in etcd is written directly to the Nginx worker process, so that the new configuration can be used directly when processing requests, without having to synchronize the configuration between processes, which is easier than starting an agent process!</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="http11-protocol-for-the-lua-resty-etcd-library">HTTP/1.1 protocol for the lua-resty-etcd library<a aria-hidden="true" class="hash-link" href="#http11-protocol-for-the-lua-resty-etcd-library" title="Direct link to heading">​</a></h3><p>How exactly does the <code>sync_data</code> function get the configuration change messages from etcd? Let&#x27;s look at the <code>sync_data</code> source code.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">local etcd = require(&quot;resty.etcd&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd_cli, err = etcd.new(etcd_conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function sync_data(self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local dir_res, err = waitdir(self.etcd_cli, self.key, self.prev_index + 1, self.timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function waitdir(etcd_cli, key, modified_index, timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res_func, func_err, http_cli = etcd_cli:watchdir(key, opts)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if http_cli then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local res_cancel, err_cancel = etcd_cli:watchcancel(http_cli)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The actual communication with etcd here is the <a href="https://github.com/api7/lua-resty-etcd" target="_blank" rel="noopener noreferrer">lua-resty-etcd</a> library. It provides the watchdir function to receive notifications from etcd when it finds a change in the value of the key directory.</p><p>And what does the watchcancel function do? This is actually the result of a deficiency in the OpenResty ecosystem. etcd v3 already supports the efficient gRPC protocol (the underlying HTTP2 protocol). As you may have heard, HTTP2 not only has the ability to multiplex, but also supports direct server pushing of messages from the HTTP3 protocol against HTTP2: !</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.webp, https://static.apiseven.com/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.png" alt="http2_stream_frame_conn" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.png" alt="http2_stream_frame_conn" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170499370-57a7c452-e97e-4ac0-b7bf-073e13946a21.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>However, Lua Eco does not currently support the HTTP2 protocol, so the lua-resty-etcd library actually communicates with etcd via the inefficient HTTP/1.1 protocol, and therefore receives /watch notifications via /v3/watch requests with timeouts. This phenomenon is actually caused by two things.</p><ol><li>Nginx positions itself as an edge load balancer, so the upstream must be the corporate intranet, which has low latency and high bandwidth, so it does not need to support the HTTP2 protocol for the upstream protocol
The HTTP2 protocol is very complex, and there is no HTTP2 cosocket library available for production environments.</li></ol><p>The lua-resty-etcd library using HTTP/1.1 is actually very inefficient, and if you capture packets on APISIX, you will see frequent POST messages with a URI of /v3/watch and a Base64-encoded watch directory with a body of</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.webp, https://static.apiseven.com/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.jpeg" alt="APISIX communicates with etcd over HTTP1" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.jpeg" alt="APISIX communicates with etcd over HTTP1" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170602368-d105d014-efe4-48c7-93b8-be5447c76a70.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p><p>We can verify the implementation details of the <code>watchdir</code> function.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- lib/resty/etcd/v3.lua 文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.watchdir(self, key, opts)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return watch(self, key, attr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function watch(self, key, attr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callback_fun, err, http_cli = request_chunk(self, &#x27;POST&#x27;, &#x27;/watch&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                opts, attr.timeout or self.timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return callback_fun</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function request_chunk(self, method, path, opts, timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http_cli, err = utils.http.new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 发起 TCP 连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint, err = http_request_chunk(self, http_cli)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 发送 HTTP 请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res, err = http_cli:request({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        method  = method,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path    = endpoint.api_prefix .. path,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body    = body,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        query   = query,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers = headers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function http_request_chunk(self, http_cli)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local endpoint, err = choose_endpoint(self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok, err = http_cli:connect({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheme = endpoint.scheme,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host = endpoint.host,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port = endpoint.port,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_verify = self.ssl_verify,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_cert_path = self.ssl_cert_path,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssl_key_path = self.ssl_key_path,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return endpoint, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>As you can see, Apache APISIX makes sure that each worker process contains the latest configuration by <strong>repeatedly requesting etcd through the <code>ngx.timer.at</code> and lua-resty-etcd libraries in each worker process.</strong></p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="apisix-configuration-and-plugin-remote-changes">APISIX configuration and plugin remote changes<a aria-hidden="true" class="hash-link" href="#apisix-configuration-and-plugin-remote-changes" title="Direct link to heading">​</a></h2><p>Next, let&#x27;s look at how to remotely modify the configuration in etcd.</p><p>We can of course modify the contents of the corresponding key in etcd directly through the gRPC interface, and then make the Nginx cluster automatically update its configuration based on the watch mechanism described above. However, this is risky because the configuration request is not verified, and the configuration data does not match the Nginx cluster.</p><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="modifying-configuration-via-nginxs-apisixadmin-interface">Modifying configuration via Nginx&#x27;s /apisix/admin/ interface<a aria-hidden="true" class="hash-link" href="#modifying-configuration-via-nginxs-apisixadmin-interface" title="Direct link to heading">​</a></h3><p>Apache APISIX provides a mechanism to access any one Nginx node, verify the request with Lua code in its worker process, and then write it to etcd through the /v3/dv/put interface. Let&#x27;s take a look at how Apache APISIX does this.</p><p>First, the nginx.conf generated by make run automatically listens on port 9080 (as modified by the apisix.node_listen configuration in config.yaml), and when <code>apisix.enable_admin</code> is set to true, nginx.conf will generate the following configuration.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 9080 default_server reuseport;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location/apisix/admin </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content_by_lua_block </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            apisix.http_admin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Thus, the /apisix/admin requests received by Nginx will be processed by the <code>http_admin</code> function.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/init.lua file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.http_admin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok = router:dispatch(get_var(&quot;uri&quot;), {method = get_method()})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>See the <a href="https://github.com/apache/apisix/blob/release/2.8/docs/zh/latest/admin-api.md" target="_blank" rel="noopener noreferrer">GitHub</a> documentation for APIs that the admin interface can handle, where when the method method differs from the URI, the dispatch performs different handler functions based on the following.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local uri_route = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/*]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = { &quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = run,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/stream_routes/*]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;}, { paths = [[/apisix/admin/stream_routes/*]], { methods = {&quot;GET&quot;, &quot;PUT&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PATCH&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = run_stream,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = [[/apisix/admin/plugins/list]],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;GET&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = get_plugins_list,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paths = reload_event,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        methods = {&quot;PUT&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handler = post_reload_plugins,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>For example, when creating 1 Upstream via /apisix/admin/upstreams/1 and the PUT method.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK shell"><pre tabindex="0" class="prism-code language-shell codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:9080/apisix/admin/upstreams/1&quot;</span><span class="token plain"> -H </span><span class="token string" style="color:#e3116c">&quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot;</span><span class="token plain"> -X PUT -d </span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   &quot;type&quot;: &quot;roundrobin&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   &quot;nodes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;     &quot;httpbin.org:80&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt;   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&gt; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">{&quot;action&quot;:&quot;set&quot;,&quot;node&quot;:{&quot;key&quot;:&quot;\/apisix\/upstreams\/1&quot;,&quot;value&quot;:{&quot;hash_on&quot;:&quot;vars&quot;,&quot;nodes&quot;:{&quot;httpbin.org:80&quot;:1},&quot;create_time&quot;:1627982128,&quot;update_time&quot;:1627982128,&quot;scheme&quot;:&quot;http&quot;,&quot;type&quot;:&quot;roundrobin&quot;,&quot;pass_host&quot;:&quot;pass&quot;,&quot;id&quot;:&quot;1&quot;}}}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>You will see the following log in error.log (to see this line, you must set the nginx_config.error_log_level in config.yaml to INFO)</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">2021/08/03 17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">28 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> 16437</span><span class="token comment" style="color:#999988;font-style:italic">#16437: *23572 [lua] init.lua:130: handler(): uri: [&quot;&quot;,&quot;apisix&quot;,&quot;admin&quot;,&quot;upstreams&quot;,&quot;1&quot;], client: 127.0.0.1, server: _, request: &quot;PUT /apisix/admin/upstreams/1 HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>This line is actually printed by the <code>run</code> function in /apisix/admin/init.lua, which is executed based on the uri_route dictionary above. Let&#x27;s look at the contents of the run function.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local uri_segs = core.utils.split_uri(ngx.var.uri)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core.log.info(&quot;uri: &quot;, core.json.delay_encode(uri_segs))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local seg_res, seg_id = uri_segs[4], uri_segs[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local seg_sub_path = core.table.concat(uri_segs, &quot;/&quot;, 6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local resource = resources[seg_res]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local code, data = resource[method](seg_id, req_body, seg_sub_path,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        uri_args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>这里 <code>resource[method]</code> 函数又被做了 1 次抽象，它是由 resources 字典决定的：</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/init.lua文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local resources = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routes          = require(&quot;apisix.admin.routes&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    services        = require(&quot;apisix.admin.services&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    upstreams       = require(&quot;apisix.admin.upstreams&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumers       = require(&quot;apisix.admin.consumers&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema          = require(&quot;apisix.admin.schema&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssl             = require(&quot;apisix.admin.ssl&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugins         = require(&quot;apisix.admin.plugins&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proto           = require(&quot;apisix.admin.proto&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global_rules    = require(&quot;apisix.admin.global_rules&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stream_routes   = require(&quot;apisix.admin.stream_routes&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_metadata = require(&quot;apisix.admin.plugin_metadata&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plugin_configs  = require(&quot;apisix.admin.plugin_config&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>Therefore, the above curl request will be processed by the <code>put</code> function in the /apisix/admin/upstreams.lua file, see the implementation of the <code>put</code> function as follows:</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/admin/upstreams.lua file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function _M.put(id, conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- check the legitimacy of the requested data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local id, err = check_conf(id, conf, true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local key = &quot;/upstreams/&quot; .. id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    core.log.info(&quot;key: &quot;, key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Generate configuration data in etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local ok, err = utils.inject_conf_with_prev_conf(&quot;upstream&quot;, key, conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- write to etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res, err = core.etcd.set(key, conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- /apisix/core/etcd.lua</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">local function set(key, value, ttl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local res, err = etcd_cli:set(prefix ... key, value, {prev_kv = true, lease = data.body.ID})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The new configuration is eventually written to etcd. As you can see, Nginx verifies the data before writing it to etcd, so that other worker processes and Nginx nodes will receive the correct configuration through the watch mechanism. You can verify this process with the logs in error.log.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">2021/08/03 17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">28 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> 16437</span><span class="token comment" style="color:#999988;font-style:italic">#16437: *23572 [lua] upstreams.lua:72: key: /upstreams/1, client: 127.0.0.1, server: _, request: &quot;PUT /apisix/admin/upstreams/1 HTTP/1.1&quot;, host: &quot;127.0.0.1:9080&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="why-the-new-configuration-works-without-reload">Why the new configuration works without reload<a aria-hidden="true" class="hash-link" href="#why-the-new-configuration-works-without-reload" title="Direct link to heading">​</a></h3><p>Let&#x27;s look at how the Nginx worker process takes effect immediately after the admin request is executed.</p><p>The open source version of Nginx matches requests based on three different containers.</p><ol><li><p>The <code>server_name</code> configuration in the static hash table is matched to the requested <code>Host</code> domain name</p></li><li><p>Next, the location in the static Trie prefix tree is configured to match the requested URI</p><p></p><div type="image/webp" placeholdersrc="https://static.apiseven.com/apisix-thumbnail/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.webp" class="rc-image"><img loading="lazy" srcset="https://static.apiseven.com/apisix-webp/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.webp, https://static.apiseven.com/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.png" alt="Matching process for location prefix tree 2" class="rc-image-img" src="https://static.apiseven.com/apisix-webp/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.webp"><div aria-hidden="true" class="rc-image-placeholder"><div class="rc-image"><img srcset="https://static.apiseven.com/apisix-thumbnail/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.webp, https://static.apiseven.com/apisix-thumbnail/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.png" alt="Matching process for location prefix tree 2" class="rc-image-img" src="https://static.apiseven.com/apisix-thumbnail/202108/1631170657240-31bb3ff3-ee3b-4831-99ff-77cab1d6e298.webp"></div></div><div class="rc-image-mask">Click to Preview</div></div><p></p></li><li><p>In both of these processes, if there are regular expressions, they are matched in order based on the order of the arrays (the order they appear in nginx.conf).</p></li></ol><p>Although these procedures are very efficient, they are written to die in the find_config phase and in the Nginx HTTP framework, and changes must be made after nginx -s reload to take effect. For this reason, Apache APISIX has abandoned this process altogether.</p><p>As you can see in nginx.conf, requests to any domain name, URI, or domain name will match the <code>http_access_phase</code> lua function.</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name _;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        access_by_lua_block {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            apisix.http_access_phase()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass      $upstream_scheme://apisix_backend$upstream_uri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The <code>http_access_phase</code> function will match Method, domain and URI based on a base prefix tree implemented in C (only wildcards are supported, no regular expressions), the library is <!-- -->[lua-resty-radixtree]<!-- -->(<a href="https://github.com/api7/lua" target="_blank" rel="noopener noreferrer">https://github.com/api7/lua</a> -resty-radixtree). Whenever the routing rules change, the Lua code rebuilds this base tree: the</p><div class="codeBlockContainer_5tM7"><div class="codeBlockContent_VFOK lua"><pre tabindex="0" class="prism-code language-lua codeBlock_sqlf thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Aq39"><span class="token-line" style="color:#393A34"><span class="token plain">function _M.match(api_ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if not cached_version or cached_version ~= user_routes.conf_version then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uri_router = base_router.create_radixtree_uri_router(user_routes.values,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                             uri_routes, false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cached_version = user_routes.conf_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_gLFX clean-btn">Copy</button></div></div><p>The rules for Plugin enablement, parameter and order adjustment are similar.</p><p>Finally, Script is mutually exclusive with Plugin. In fact, Lua JIT&#x27;s just-in-time compilation provides another killer feature, loadstring, which converts strings to Lua code. So, after storing Lua code in etcd and setting it to Script, you can pass it to Nginx to process requests.</p><h2 class="anchor anchorWithHideOnScrollNavbar_3ly5" id="summary">Summary<a aria-hidden="true" class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>Nginx cluster management must rely on a centralized configuration component, and etcd, which is highly reliable and has a watch push mechanism, is the perfect choice! Although the Resty ecosystem does not have a gRPC client, it is still a good idea for each worker process to synchronize etcd configuration directly via the HTTP/1.1 protocol.</p><p>The key to dynamically modifying the Nginx configuration is 2 things: the Lua language is much more flexible than the nginx.conf syntax, and Lua code can be imported from external data via loadstring. Of course, to ensure efficient execution of route matching, Apache APISIX implements a prefix base tree in C to match requests based on Host, Method, and URI, improving performance while maintaining dynamism.</p><p>Apache APISIX has many good designs, and this article only discusses the dynamic management of Nginx clusters.</p><p><a href="https://www.taohui.tech/2021/08/10/%E5%BC%80%E6%BA%90%E7%BD%91%E5%85%B3APISIX%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/#more" target="_blank" rel="noopener noreferrer">click here for the link to the original article</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/ecosystem/">Ecosystem</a></li></ul></div></footer></article><section class="shareSection_OUzq"><div><button aria-label="linkedin" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#007fb1"></circle><path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white"></path></svg></button><button aria-label="twitter" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="reddit" class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button></div></section><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/08/11/interview-tuzhengsong/"><div class="pagination-nav__sublabel sublabel_M5Gs">Newer Post</div><div class="pagination-nav__label">My first PR in the Apache APISIX community</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/08/09/apache-apisix-in-quliankeji/"><div class="pagination-nav__sublabel sublabel_M5Gs">Older Post</div><div class="pagination-nav__label">Hyperchain Technology implements BaaS platform with APISIX</div></a></div></nav></div></div></div></div><footer class="container_N-4m"><div class="linksRow_U0oR"><div class="linksCol_R6VE"><div>ASF</div><ul><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span></span><span>Foundation</span></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer"><span></span><span>License</span></a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer"><span></span><span>Events</span></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer"><span></span><span>Security</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer"><span></span><span>Sponsorship</span></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer"><span></span><span>Thanks</span></a></li></ul></div><div class="linksCol_R6VE"><div>Community</div><ul><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer"><span></span><span>GitHub</span></a></li><li class="footer__item"><a href="/docs/general/join/"><span></span><span>Slack</span></a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer"><span></span><span>Twitter</span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCgPD18cMhOg5rmPVnQhAC8g" target="_blank" rel="noopener noreferrer"><span></span><span>YouTube</span></a></li></ul></div><div class="linksCol_R6VE"><div>More</div><ul><li class="footer__item"><a target="_parent" href="/blog/"><span></span><span>Blog</span></a></li><li class="footer__item"><a target="_parent" href="/showcase/"><span></span><span>Showcase</span></a></li><li class="footer__item"><a target="_parent" href="/plugins/"><span></span><span>Plugin Hub</span></a></li><li class="footer__item"><a href="https://github.com/apache/apisix/milestones" target="_parent" rel="noopener noreferrer"><span></span><span>Roadmap</span></a></li></ul></div></div><div class="copyright_Bdi1"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer"><span style="display:inline-block;width:231.25px;height:40px"></span></a><div>Copyright © 2019-2025 The Apache Software Foundation. Apache APISIX, APISIX®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></footer></div>
<script src="https://apisix-website-static.apiseven.com/assets/js/runtime~main.57eaa0fa.js"></script>
<script src="https://apisix-website-static.apiseven.com/assets/js/main.84c0a2cc.js"></script>
</body>
</html>