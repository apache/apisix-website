"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[99462],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>p});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),d=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=d(e.components);return a.createElement(o.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=d(n),p=r,c=m["".concat(o,".").concat(p)]||m[p]||h[p]||i;return n?a.createElement(c,l(l({ref:t},u),{},{components:n})):a.createElement(c,l({ref:t},u))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var d=2;d<i;d++)l[d]=n[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},54483:(e,t,n)=>{n.r(t),n.d(t,{contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var a=n(87462),r=(n(67294),n(3905));const i={title:"hmac-auth",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","HMAC Authentication","hmac-auth"],description:"hmac-auth \u63d2\u4ef6\u652f\u6301 HMAC \u8ba4\u8bc1\uff0c\u4fdd\u8bc1\u8bf7\u6c42\u7684\u5b8c\u6574\u6027\uff0c\u9632\u6b62\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u7684\u4fee\u6539\uff0c\u589e\u5f3a API \u7684\u5b89\u5168\u6027\u3002"},l=void 0,s={unversionedId:"plugins/hmac-auth",id:"plugins/hmac-auth",isDocsHomePage:!1,title:"hmac-auth",description:"hmac-auth \u63d2\u4ef6\u652f\u6301 HMAC \u8ba4\u8bc1\uff0c\u4fdd\u8bc1\u8bf7\u6c42\u7684\u5b8c\u6574\u6027\uff0c\u9632\u6b62\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u7684\u4fee\u6539\uff0c\u589e\u5f3a API \u7684\u5b89\u5168\u6027\u3002",source:"@site/i18n/zh/docusaurus-plugin-content-docs-docs-apisix/current/plugins/hmac-auth.md",sourceDirName:"plugins",slug:"/plugins/hmac-auth",permalink:"/zh/docs/apisix/next/plugins/hmac-auth",editUrl:"/zh/edit#https://github.com/apache/apisix/edit/master/docs/zh/latest/plugins/hmac-auth.md",tags:[],version:"current",frontMatter:{title:"hmac-auth",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","HMAC Authentication","hmac-auth"],description:"hmac-auth \u63d2\u4ef6\u652f\u6301 HMAC \u8ba4\u8bc1\uff0c\u4fdd\u8bc1\u8bf7\u6c42\u7684\u5b8c\u6574\u6027\uff0c\u9632\u6b62\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u7684\u4fee\u6539\uff0c\u589e\u5f3a API \u7684\u5b89\u5168\u6027\u3002"},sidebar:"docs",previous:{title:"cas-auth",permalink:"/zh/docs/apisix/next/plugins/cas-auth"},next:{title:"authz-casbin",permalink:"/zh/docs/apisix/next/plugins/authz-casbin"}},o=[{value:"\u63cf\u8ff0",id:"\u63cf\u8ff0",children:[]},{value:"\u5c5e\u6027",id:"\u5c5e\u6027",children:[]},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",children:[{value:"\u5728\u8def\u7531\u4e0a\u5b9e\u73b0 HMAC \u8eab\u4efd\u9a8c\u8bc1",id:"\u5728\u8def\u7531\u4e0a\u5b9e\u73b0-hmac-\u8eab\u4efd\u9a8c\u8bc1",children:[]},{value:"Hide Authorization Information From Upstream",id:"hide-authorization-information-from-upstream",children:[]},{value:"Enable Body Validation",id:"enable-body-validation",children:[]},{value:"\u5f3a\u5236\u7b7e\u540d\u6807\u5934",id:"\u5f3a\u5236\u7b7e\u540d\u6807\u5934",children:[]},{value:"\u533f\u540d\u6d88\u8d39\u8005\u7684\u901f\u7387\u9650\u5236",id:"\u533f\u540d\u6d88\u8d39\u8005\u7684\u901f\u7387\u9650\u5236",children:[]}]}],d={toc:o};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u63cf\u8ff0"},"\u63cf\u8ff0"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u63d2\u4ef6\u652f\u6301 HMAC\uff08\u57fa\u4e8e\u54c8\u5e0c\u7684\u6d88\u606f\u8ba4\u8bc1\u7801\uff09\u8ba4\u8bc1\uff0c\u4f5c\u4e3a\u4e00\u79cd\u786e\u4fdd\u8bf7\u6c42\u5b8c\u6574\u6027\u7684\u673a\u5236\uff0c\u9632\u6b62\u5b83\u4eec\u5728\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u88ab\u4fee\u6539\u3002\u8981\u4f7f\u7528\u8be5\u63d2\u4ef6\uff0c\u60a8\u9700\u8981\u5728 ",(0,r.kt)("a",{parentName:"p",href:"/zh/docs/apisix/next/terminology/consumer"},"Consumers")," \u4e0a\u914d\u7f6e HMAC \u5bc6\u94a5\uff0c\u5e76\u5728 Routes \u6216 Services \u4e0a\u542f\u7528\u8be5\u63d2\u4ef6\u3002"),(0,r.kt)("p",null,"\u5f53\u6d88\u8d39\u8005\u6210\u529f\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u540e\uff0cAPISIX \u4f1a\u5728\u5c06\u8bf7\u6c42\u4ee3\u7406\u5230\u4e0a\u6e38\u670d\u52a1\u4e4b\u524d\u5411\u8bf7\u6c42\u6dfb\u52a0\u5176\u4ed6\u6807\u5934\uff0c\u4f8b\u5982 ",(0,r.kt)("inlineCode",{parentName:"p"},"X-Consumer-Username"),"\u3001",(0,r.kt)("inlineCode",{parentName:"p"},"X-Credential-Indentifier")," \u548c\u5176\u4ed6\u6d88\u8d39\u8005\u81ea\u5b9a\u4e49\u6807\u5934\uff08\u5982\u679c\u5df2\u914d\u7f6e\uff09\u3002\u4e0a\u6e38\u670d\u52a1\u5c06\u80fd\u591f\u533a\u5206\u6d88\u8d39\u8005\u5e76\u6839\u636e\u9700\u8981\u5b9e\u73b0\u5176\u4ed6\u903b\u8f91\u3002\u5982\u679c\u8fd9\u4e9b\u503c\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u4e0d\u53ef\u7528\uff0c\u5219\u4e0d\u4f1a\u6dfb\u52a0\u76f8\u5e94\u7684\u6807\u5934\u3002"),(0,r.kt)("p",null,"\u542f\u7528\u540e\uff0c\u63d2\u4ef6\u4f1a\u9a8c\u8bc1\u8bf7\u6c42\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," \u6807\u5934\u4e2d\u7684 HMAC \u7b7e\u540d\uff0c\u5e76\u68c0\u67e5\u4f20\u5165\u7684\u8bf7\u6c42\u662f\u5426\u6765\u81ea\u53d7\u4fe1\u4efb\u7684\u6765\u6e90\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5f53 APISIX \u6536\u5230 HMAC \u7b7e\u540d\u7684\u8bf7\u6c42\u65f6\uff0c\u4f1a\u4ece ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," \u6807\u5934\u4e2d\u63d0\u53d6\u5bc6\u94a5 ID\u3002\u7136\u540e\uff0cAPISIX \u4f1a\u68c0\u7d22\u76f8\u5e94\u7684\u6d88\u8d39\u8005\u914d\u7f6e\uff0c\u5305\u62ec\u5bc6\u94a5\u3002\u5982\u679c\u5bc6\u94a5 ID \u6709\u6548\u4e14\u5b58\u5728\uff0cAPISIX \u5c06\u4f7f\u7528\u8bf7\u6c42\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"Date")," \u6807\u5934\u548c\u5bc6\u94a5\u751f\u6210 HMAC \u7b7e\u540d\u3002\u5982\u679c\u751f\u6210\u7684\u7b7e\u540d\u4e0e ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," \u6807\u5934\u4e2d\u63d0\u4f9b\u7684\u7b7e\u540d\u5339\u914d\uff0c\u5219\u8bf7\u6c42\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u5e76\u8f6c\u53d1\u5230\u4e0a\u6e38\u670d\u52a1\u3002"),(0,r.kt)("p",null,"\u63d2\u4ef6\u5b9e\u73b0\u57fa\u4e8e ",(0,r.kt)("a",{parentName:"p",href:"https://www.ietf.org/archive/id/draft-cavage-http-signatures-12.txt"},"draft-cavage-http-signatures"),"\u3002"),(0,r.kt)("h2",{id:"\u5c5e\u6027"},"\u5c5e\u6027"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5c5e\u6027\u53ef\u7528\u4e8e Consumers \u6216 Credentials \u7684\u914d\u7f6e\u3002"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"\u540d\u79f0"),(0,r.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,r.kt)("th",{parentName:"tr",align:null},"\u5fc5\u9009\u9879"),(0,r.kt)("th",{parentName:"tr",align:null},"\u9ed8\u8ba4\u503c"),(0,r.kt)("th",{parentName:"tr",align:null},"\u6709\u6548\u503c"),(0,r.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"access_key"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u6d88\u8d39\u8005\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u7528\u4e8e\u6807\u8bc6\u76f8\u5173\u914d\u7f6e\uff0c\u4f8b\u5982\u5bc6\u94a5\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"secret_key"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u7528\u4e8e\u751f\u6210 HMAC \u7684\u5bc6\u94a5\u3002\u6b64\u5b57\u6bb5\u652f\u6301\u4f7f\u7528 ",(0,r.kt)("a",{parentName:"td",href:"/zh/docs/apisix/next/terminology/secret"},"APISIX Secret")," \u8d44\u6e90\u5c06\u503c\u4fdd\u5b58\u5728 Secret Manager \u4e2d\u3002")))),(0,r.kt)("p",null,"\u4ee5\u4e0b\u5c5e\u6027\u53ef\u7528\u4e8e Routes \u6216 Services \u7684\u914d\u7f6e\u3002"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"\u540d\u79f0"),(0,r.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,r.kt)("th",{parentName:"tr",align:null},"\u5fc5\u9009\u9879"),(0,r.kt)("th",{parentName:"tr",align:null},"\u9ed8\u8ba4\u503c"),(0,r.kt)("th",{parentName:"tr",align:null},"\u6709\u6548\u503c"),(0,r.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"allowed_algorithms"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},'["hmac-sha1", "hmac-sha256", "hmac-sha512"]'),(0,r.kt)("td",{parentName:"tr",align:null},'"hmac-sha1"\u3001"hmac-sha256" \u548c "hmac-sha512" \u7684\u7ec4\u5408'),(0,r.kt)("td",{parentName:"tr",align:null},"\u5141\u8bb8\u7684 HMAC \u7b97\u6cd5\u5217\u8868\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"clock_skew"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"300"),(0,r.kt)("td",{parentName:"tr",align:null},">=1"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5ba2\u6237\u7aef\u8bf7\u6c42\u7684\u65f6\u95f4\u6233\u4e0e APISIX \u670d\u52a1\u5668\u5f53\u524d\u65f6\u95f4\u4e4b\u95f4\u5141\u8bb8\u7684\u6700\u5927\u65f6\u95f4\u5dee\uff08\u4ee5\u79d2\u4e3a\u5355\u4f4d\uff09\u3002\u8fd9\u6709\u52a9\u4e8e\u89e3\u51b3\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u65f6\u95f4\u540c\u6b65\u5dee\u5f02\uff0c\u5e76\u9632\u6b62\u91cd\u653e\u653b\u51fb\u3002\u65f6\u95f4\u6233\u5c06\u6839\u636e Date \u5934\u4e2d\u7684\u65f6\u95f4\uff08\u5fc5\u987b\u4e3a GMT \u683c\u5f0f\uff09\u8fdb\u884c\u8ba1\u7b97\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"signed_headers"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u5ba2\u6237\u7aef\u8bf7\u6c42\u7684 HMAC \u7b7e\u540d\u4e2d\u5e94\u5305\u542b\u7684 HMAC \u7b7e\u540d\u5934\u5217\u8868\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"validate_request_body"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u4e3a true\uff0c\u5219\u9a8c\u8bc1\u8bf7\u6c42\u6b63\u6587\u7684\u5b8c\u6574\u6027\uff0c\u4ee5\u786e\u4fdd\u5728\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u6ca1\u6709\u88ab\u7be1\u6539\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u63d2\u4ef6\u4f1a\u521b\u5efa\u4e00\u4e2a SHA-256 \u7684 base64 \u7f16\u7801 digest\uff0c\u5e76\u5c06\u5176\u4e0e ",(0,r.kt)("inlineCode",{parentName:"td"},"Digest")," \u5934\u8fdb\u884c\u6bd4\u8f83\u3002\u5982\u679c ",(0,r.kt)("inlineCode",{parentName:"td"},"Digest")," \u5934\u4e22\u5931\u6216 digest \u4e0d\u5339\u914d\uff0c\u9a8c\u8bc1\u5c06\u5931\u8d25\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"hide_credentials"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"false"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u4e3a true\uff0c\u5219\u4e0d\u4f1a\u5c06\u6388\u6743\u8bf7\u6c42\u5934\u4f20\u9012\u7ed9\u4e0a\u6e38\u670d\u52a1\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"anonymous_consumer"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u533f\u540d\u6d88\u8d39\u8005\u540d\u79f0\u3002\u5982\u679c\u5df2\u914d\u7f6e\uff0c\u5219\u5141\u8bb8\u533f\u540d\u7528\u6237\u7ed5\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u3002")))),(0,r.kt)("p",null,"\u6ce8\u610f\uff1aschema \u4e2d\u8fd8\u5b9a\u4e49\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},'encrypt_fields = {"secret_key"}'),"\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u5b57\u6bb5\u5c06\u4f1a\u88ab\u52a0\u5bc6\u5b58\u50a8\u5728 etcd \u4e2d\u3002\u5177\u4f53\u53c2\u8003 ",(0,r.kt)("a",{parentName:"p",href:"/zh/docs/apisix/next/plugin-develop#%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8%E5%AD%97%E6%AE%B5"},"\u52a0\u5bc6\u5b58\u50a8\u5b57\u6bb5"),"\u3002"),(0,r.kt)("h2",{id:"\u793a\u4f8b"},"\u793a\u4f8b"),(0,r.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u8bf4\u660e\u4e86\u5982\u4f55\u5728\u4e0d\u540c\u573a\u666f\u4e2d\u4f7f\u7528\u201chmac-auth\u201d\u63d2\u4ef6\u3002"),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"\u60a8\u53ef\u4ee5\u8fd9\u6837\u4ece ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," \u4e2d\u83b7\u53d6 ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," \u5e76\u5b58\u5165\u73af\u5883\u53d8\u91cf\uff1a"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"\u5728\u8def\u7531\u4e0a\u5b9e\u73b0-hmac-\u8eab\u4efd\u9a8c\u8bc1"},"\u5728\u8def\u7531\u4e0a\u5b9e\u73b0 HMAC \u8eab\u4efd\u9a8c\u8bc1"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u5728\u8def\u7531\u4e0a\u5b9e\u73b0 HMAC \u8eab\u4efd\u9a8c\u8bc1\u3002\u60a8\u8fd8\u5c06\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"Consumer-Custom-Id")," \u6807\u5934\u4e2d\u5c06\u6d88\u8d39\u8005\u81ea\u5b9a\u4e49 ID \u9644\u52a0\u5230\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u8bf7\u6c42\uff0c\u8be5 ID \u53ef\u7528\u4e8e\u6839\u636e\u9700\u8981\u5b9e\u73b0\u5176\u4ed6\u903b\u8f91\u3002"),(0,r.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u5e26\u6709\u81ea\u5b9a\u4e49 ID \u6807\u7b7e\u7684\u6d88\u8d39\u8005 ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),"\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "john",\n    "labels": {\n      "custom_id": "495aec6a"\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u4e3a\u6d88\u8d39\u8005\u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u51ed\u8bc1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/john/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-hmac-auth",\n    "plugins": {\n      "hmac-auth": {\n        "key_id": "john-key",\n        "secret_key": "john-secret-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u63d2\u4ef6\u7684\u9ed8\u8ba4\u914d\u7f6e\u521b\u5efa\u8def\u7531\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "hmac-auth-route",\n    "uri": "/get",\n    "methods": ["GET"],\n    "plugins": {\n      "hmac-auth": {}\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u751f\u6210\u7b7e\u540d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b Python \u4ee3\u7801\u7247\u6bb5\u6216\u5176\u4ed6\u6280\u672f\u6808\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="hmac-sig-header-gen.py"',title:'"hmac-sig-header-gen.py"'},'import hmac\nimport hashlib\nimport base64\nfrom datetime import datetime, timezone\n\nkey_id = "john-key"                # key id\nsecret_key = b"john-secret-key"    # secret key\nrequest_method = "GET"             # HTTP method\nrequest_path = "/get"              # Route URI\nalgorithm= "hmac-sha256"           # can use other algorithms in allowed_algorithms\n\n# get current datetime in GMT\n# note: the signature will become invalid after the clock skew (default 300s)\n# you can regenerate the signature after it becomes invalid, or increase the clock\n# skew to prolong the validity within the advised security boundary\ngmt_time = datetime.now(timezone.utc).strftime(\'%a, %d %b %Y %H:%M:%S GMT\')\n\n# construct the signing string (ordered)\n# the date and any subsequent custom headers should be lowercased and separated by a\n# single space character, i.e. `<key>:<space><value>`\n# https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#section-2.1.6\nsigning_string = (\n  f"{key_id}\\n"\n  f"{request_method} {request_path}\\n"\n  f"date: {gmt_time}\\n"\n)\n\n# create signature\nsignature = hmac.new(secret_key, signing_string.encode(\'utf-8\'), hashlib.sha256).digest()\nsignature_base64 = base64.b64encode(signature).decode(\'utf-8\')\n\n# construct the request headers\nheaders = {\n  "Date": gmt_time,\n  "Authorization": (\n    f\'Signature keyId="{key_id}",algorithm="{algorithm}",\'\n    f\'headers="@request-target date",\'\n    f\'signature="{signature_base64}"\'\n  )\n}\n\n# print headers\nprint(headers)\n')),(0,r.kt)("p",null,"\u8fd0\u884c\u811a\u672c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"python3 hmac-sig-header-gen.py\n")),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u6253\u5370\u7684\u8bf7\u6c42\u6807\u5934\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"{'Date': 'Fri, 06 Sep 2024 06:41:29 GMT', 'Authorization': 'Signature keyId=\"john-key\",algorithm=\"hmac-sha256\",headers=\"@request-target date\",signature=\"wWfKQvPDr0wHQ4IHdluB4IzeNZcj0bGJs2wvoCOT5rM=\"'}\n")),(0,r.kt)("p",null,"\u4f7f\u7528\u751f\u6210\u7684\u6807\u5934\uff0c\u5411\u8def\u7531\u53d1\u9001\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X GET "http://127.0.0.1:9080/get" \\\n  -H "Date: Fri, 06 Sep 2024 06:41:29 GMT" \\\n  -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date",signature="wWfKQvPDr0wHQ4IHdluB4IzeNZcj0bGJs2wvoCOT5rM="\'\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u5185\u5bb9\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," \u54cd\u5e94\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "headers": {\n    "Accept": "*/*",\n    "Authorization": "Signature keyId=\\"john-key\\",algorithm=\\"hmac-sha256\\",headers=\\"@request-target date\\",signature=\\"wWfKQvPDr0wHQ4IHdluB4IzeNZcj0bGJs2wvoCOT5rM=\\"",\n    "Date": "Fri, 06 Sep 2024 06:41:29 GMT",\n    "Host": "127.0.0.1",\n    "User-Agent": "curl/8.6.0",\n    "X-Amzn-Trace-Id": "Root=1-66d96513-2e52d4f35c9b6a2772d667ea",\n    "X-Consumer-Username": "john",\n    "X-Credential-Identifier": "cred-john-hmac-auth",\n    "X-Consumer-Custom-Id": "495aec6a",\n    "X-Forwarded-Host": "127.0.0.1"\n  },\n  "origin": "192.168.65.1, 34.0.34.160",\n  "url": "http://127.0.0.1/get"\n}\n')),(0,r.kt)("h3",{id:"hide-authorization-information-from-upstream"},"Hide Authorization Information From Upstream"),(0,r.kt)("p",null,"As seen the in the ",(0,r.kt)("a",{parentName:"p",href:"#implement-hmac-authentication-on-a-route"},"last example"),", the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," header passed to the Upstream includes the signature and all other details. This could potentially introduce security risks."),(0,r.kt)("p",null,"The following example demonstrates how to prevent these information from being sent to the Upstream service."),(0,r.kt)("p",null,"Update the plugin configuration to set ",(0,r.kt)("inlineCode",{parentName:"p"},"hide_credentials")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/hmac-auth-route" -X PATCH \\\n-H "X-API-KEY: ${admin_key}" \\\n-d \'{\n  "plugins": {\n    "hmac-auth": {\n      "hide_credentials": true\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,"Send a request to the route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X GET "http://127.0.0.1:9080/get" \\\n  -H "Date: Fri, 06 Sep 2024 06:41:29 GMT" \\\n  -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date",signature="wWfKQvPDr0wHQ4IHdluB4IzeNZcj0bGJs2wvoCOT5rM="\'\n')),(0,r.kt)("p",null,"You should see an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," response and notice the ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," header is entirely removed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "headers": {\n    "Accept": "*/*",\n    "Host": "127.0.0.1",\n    "User-Agent": "curl/8.6.0",\n    "X-Amzn-Trace-Id": "Root=1-66d96513-2e52d4f35c9b6a2772d667ea",\n    "X-Consumer-Username": "john",\n    "X-Credential-Identifier": "cred-john-hmac-auth",\n    "X-Forwarded-Host": "127.0.0.1"\n  },\n  "origin": "192.168.65.1, 34.0.34.160",\n  "url": "http://127.0.0.1/get"\n}\n')),(0,r.kt)("h3",{id:"enable-body-validation"},"Enable Body Validation"),(0,r.kt)("p",null,"The following example demonstrates how to enable body validation to ensure the integrity of the request body."),(0,r.kt)("p",null,"Create a consumer ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "john"\n  }\'\n')),(0,r.kt)("p",null,"\u4e3a\u6d88\u8d39\u8005\u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u51ed\u8bc1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/john/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-hmac-auth",\n    "plugins": {\n      "hmac-auth": {\n        "key_id": "john-key",\n        "secret_key": "john-secret-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," plugin as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "hmac-auth-route",\n    "uri": "/post",\n    "methods": ["POST"],\n    "plugins": {\n      "hmac-auth": {\n        "validate_request_body": true\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u751f\u6210\u7b7e\u540d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b Python \u4ee3\u7801\u7247\u6bb5\u6216\u5176\u4ed6\u6280\u672f\u6808\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="hmac-sig-digest-header-gen.py"',title:'"hmac-sig-digest-header-gen.py"'},'import hmac\nimport hashlib\nimport base64\nfrom datetime import datetime, timezone\n\nkey_id = "john-key"                 # key id\nsecret_key = b"john-secret-key"     # secret key\nrequest_method = "POST"             # HTTP method\nrequest_path = "/post"              # Route URI\nalgorithm= "hmac-sha256"            # can use other algorithms in allowed_algorithms\nbody = \'{"name": "world"}\'          # example request body\n\n# get current datetime in GMT\n# note: the signature will become invalid after the clock skew (default 300s).\n# you can regenerate the signature after it becomes invalid, or increase the clock\n# skew to prolong the validity within the advised security boundary\ngmt_time = datetime.now(timezone.utc).strftime(\'%a, %d %b %Y %H:%M:%S GMT\')\n\n# construct the signing string (ordered)\n# the date and any subsequent custom headers should be lowercased and separated by a\n# single space character, i.e. `<key>:<space><value>`\n# https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#section-2.1.6\nsigning_string = (\n    f"{key_id}\\n"\n    f"{request_method} {request_path}\\n"\n    f"date: {gmt_time}\\n"\n)\n\n# create signature\nsignature = hmac.new(secret_key, signing_string.encode(\'utf-8\'), hashlib.sha256).digest()\nsignature_base64 = base64.b64encode(signature).decode(\'utf-8\')\n\n# create the SHA-256 digest of the request body and base64 encode it\nbody_digest = hashlib.sha256(body.encode(\'utf-8\')).digest()\nbody_digest_base64 = base64.b64encode(body_digest).decode(\'utf-8\')\n\n# construct the request headers\nheaders = {\n    "Date": gmt_time,\n    "Digest": f"SHA-256={body_digest_base64}",\n    "Authorization": (\n        f\'Signature keyId="{key_id}",algorithm="hmac-sha256",\'\n        f\'headers="@request-target date",\'\n        f\'signature="{signature_base64}"\'\n    )\n}\n\n# print headers\nprint(headers)\n')),(0,r.kt)("p",null,"\u8fd0\u884c\u811a\u672c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"python3 hmac-sig-digest-header-gen.py\n")),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u6253\u5370\u7684\u8bf7\u6c42\u6807\u5934\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"{'Date': 'Fri, 06 Sep 2024 09:16:16 GMT', 'Digest': 'SHA-256=78qzJuLwSpZ8HacsTdFCQJWxzPMOf8bYctRk2ySLpS8=', 'Authorization': 'Signature keyId=\"john-key\",algorithm=\"hmac-sha256\",headers=\"@request-target date\",signature=\"rjS6NxOBKmzS8CZL05uLiAfE16hXdIpMD/L/HukOTYE=\"'}\n")),(0,r.kt)("p",null,"\u4f7f\u7528\u751f\u6210\u7684\u6807\u5934\uff0c\u5411\u8def\u7531\u53d1\u9001\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/post" -X POST \\\n  -H "Date: Fri, 06 Sep 2024 09:16:16 GMT" \\\n  -H "Digest: SHA-256=78qzJuLwSpZ8HacsTdFCQJWxzPMOf8bYctRk2ySLpS8=" \\\n  -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date",signature="rjS6NxOBKmzS8CZL05uLiAfE16hXdIpMD/L/HukOTYE="\' \\\n  -d \'{"name": "world"}\'\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u5185\u5bb9\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," \u54cd\u5e94\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "data": "",\n  "files": {},\n  "form": {\n    "{\\"name\\": \\"world\\"}": ""\n  },\n  "headers": {\n    "Accept": "*/*",\n    "Authorization": "Signature keyId=\\"john-key\\",algorithm=\\"hmac-sha256\\",headers=\\"@request-target date\\",signature=\\"rjS6NxOBKmzS8CZL05uLiAfE16hXdIpMD/L/HukOTYE=\\"",\n    "Content-Length": "17",\n    "Content-Type": "application/x-www-form-urlencoded",\n    "Date": "Fri, 06 Sep 2024 09:16:16 GMT",\n    "Digest": "SHA-256=78qzJuLwSpZ8HacsTdFCQJWxzPMOf8bYctRk2ySLpS8=",\n    "Host": "127.0.0.1",\n    "User-Agent": "curl/8.6.0",\n    "X-Amzn-Trace-Id": "Root=1-66d978c3-49f929ad5237da5340bbbeb4",\n    "X-Consumer-Username": "john",\n    "X-Credential-Identifier": "cred-john-hmac-auth",\n    "X-Forwarded-Host": "127.0.0.1"\n  },\n  "json": null,\n  "origin": "192.168.65.1, 34.0.34.160",\n  "url": "http://127.0.0.1/post"\n}\n')),(0,r.kt)("p",null,"\u5982\u679c\u60a8\u53d1\u9001\u7684\u8bf7\u6c42\u6ca1\u6709\u6458\u8981\u6216\u6458\u8981\u65e0\u6548\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/post" -X POST \\\n  -H "Date: Fri, 06 Sep 2024 09:16:16 GMT" \\\n  -H "Digest: SHA-256=78qzJuLwSpZ8HacsTdFCQJWxzPMOf8bYctRk2ySLpS8=" \\\n  -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date",signature="rjS6NxOBKmzS8CZL05uLiAfE16hXdIpMD/L/HukOTYE="\' \\\n  -d \'{"name": "world"}\'\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," \u54cd\u5e94\uff0c\u5176\u4e2d\u5305\u542b\u4ee5\u4e0b\u6d88\u606f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'{"message":"client request can\'t be validated"}\n')),(0,r.kt)("h3",{id:"\u5f3a\u5236\u7b7e\u540d\u6807\u5934"},"\u5f3a\u5236\u7b7e\u540d\u6807\u5934"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u5f3a\u5236\u5728\u8bf7\u6c42\u7684 HMAC \u7b7e\u540d\u4e2d\u5bf9\u67d0\u4e9b\u6807\u5934\u8fdb\u884c\u7b7e\u540d\u3002"),(0,r.kt)("p",null,"\u521b\u5efa\u6d88\u8d39\u8005 ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),"\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "john"\n  }\'\n')),(0,r.kt)("p",null,"\u4e3a\u6d88\u8d39\u8005\u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u51ed\u8bc1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/john/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-hmac-auth",\n    "plugins": {\n      "hmac-auth": {\n        "key_id": "john-key",\n        "secret_key": "john-secret-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u63d2\u4ef6\u521b\u5efa\u8def\u7531\uff0c\u8be5\u63d2\u4ef6\u8981\u6c42 HMAC \u7b7e\u540d\u4e2d\u5b58\u5728\u4e09\u4e2a\u6807\u5934\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "hmac-auth-route",\n    "uri": "/get",\n    "methods": ["GET"],\n    "plugins": {\n      "hmac-auth": {\n        "signed_headers": ["date","x-custom-header-a","x-custom-header-b"]\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u751f\u6210\u7b7e\u540d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b Python \u4ee3\u7801\u7247\u6bb5\u6216\u5176\u4ed6\u6280\u672f\u6808\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="hmac-sig-req-header-gen.py"',title:'"hmac-sig-req-header-gen.py"'},'import hmac\nimport hashlib\nimport base64\nfrom datetime import datetime, timezone\n\nkey_id = "john-key"                # key id\nsecret_key = b"john-secret-key"    # secret key\nrequest_method = "GET"             # HTTP method\nrequest_path = "/get"              # Route URI\nalgorithm= "hmac-sha256"           # can use other algorithms in allowed_algorithms\ncustom_header_a = "hello123"       # required custom header\ncustom_header_b = "world456"       # required custom header\n\n# get current datetime in GMT\n# note: the signature will become invalid after the clock skew (default 300s)\n# you can regenerate the signature after it becomes invalid, or increase the clock\n# skew to prolong the validity within the advised security boundary\ngmt_time = datetime.now(timezone.utc).strftime(\'%a, %d %b %Y %H:%M:%S GMT\')\n\n# construct the signing string (ordered)\n# the date and any subsequent custom headers should be lowercased and separated by a\n# single space character, i.e. `<key>:<space><value>`\n# https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#section-2.1.6\nsigning_string = (\n    f"{key_id}\\n"\n    f"{request_method} {request_path}\\n"\n    f"date: {gmt_time}\\n"\n    f"x-custom-header-a: {custom_header_a}\\n"\n    f"x-custom-header-b: {custom_header_b}\\n"\n)\n\n# create signature\nsignature = hmac.new(secret_key, signing_string.encode(\'utf-8\'), hashlib.sha256).digest()\nsignature_base64 = base64.b64encode(signature).decode(\'utf-8\')\n\n# construct the request headers\nheaders = {\n    "Date": gmt_time,\n    "Authorization": (\n        f\'Signature keyId="{key_id}",algorithm="hmac-sha256",\'\n        f\'headers="@request-target date x-custom-header-a x-custom-header-b",\'\n        f\'signature="{signature_base64}"\'\n    ),\n    "x-custom-header-a": custom_header_a,\n    "x-custom-header-b": custom_header_b\n}\n\n# print headers\nprint(headers)\n')),(0,r.kt)("p",null,"\u8fd0\u884c\u811a\u672c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"python3 hmac-sig-req-header-gen.py\n")),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u6253\u5370\u7684\u8bf7\u6c42\u6807\u5934\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"{'Date': 'Fri, 06 Sep 2024 09:58:49 GMT', 'Authorization': 'Signature keyId=\"john-key\",algorithm=\"hmac-sha256\",headers=\"@request-target date x-custom-header-a x-custom-header-b\",signature=\"MwJR8JOhhRLIyaHlJ3Snbrf5hv0XwdeeRiijvX3A3yE=\"', 'x-custom-header-a': 'hello123', 'x-custom-header-b': 'world456'}\n")),(0,r.kt)("p",null,"\u4f7f\u7528\u751f\u6210\u7684\u6807\u5934\uff0c\u5411\u8def\u7531\u53d1\u9001\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl -X GET "http://127.0.0.1:9080/get" \\\n     -H "Date: Fri, 06 Sep 2024 09:58:49 GMT" \\\n     -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date x-custom-header-a x-custom-header-b",signature="MwJR8JOhhRLIyaHlJ3Snbrf5hv0XwdeeRiijvX3A3yE="\' \\\n     -H "x-custom-header-a: hello123" \\\n     -H "x-custom-header-b: world456"\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u4ee5\u4e0b\u5185\u5bb9\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," \u54cd\u5e94\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "args": {},\n  "headers": {\n    "Accept": "*/*",\n    "Authorization": "Signature keyId=\\"john-key\\",algorithm=\\"hmac-sha256\\",headers=\\"@request-target date x-custom-header-a x-custom-header-b\\",signature=\\"MwJR8JOhhRLIyaHlJ3Snbrf5hv0XwdeeRiijvX3A3yE=\\"",\n    "Date": "Fri, 06 Sep 2024 09:58:49 GMT",\n    "Host": "127.0.0.1",\n    "User-Agent": "curl/8.6.0",\n    "X-Amzn-Trace-Id": "Root=1-66d98196-64a58db25ece71c077999ecd",\n    "X-Consumer-Username": "john",\n    "X-Credential-Identifier": "cred-john-hmac-auth",\n    "X-Custom-Header-A": "hello123",\n    "X-Custom-Header-B": "world456",\n    "X-Forwarded-Host": "127.0.0.1"\n  },\n  "origin": "192.168.65.1, 103.97.2.206",\n  "url": "http://127.0.0.1/get"\n}\n')),(0,r.kt)("h3",{id:"\u533f\u540d\u6d88\u8d39\u8005\u7684\u901f\u7387\u9650\u5236"},"\u533f\u540d\u6d88\u8d39\u8005\u7684\u901f\u7387\u9650\u5236"),(0,r.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u4e3a\u5e38\u89c4\u6d88\u8d39\u8005\u548c\u533f\u540d\u6d88\u8d39\u8005\u914d\u7f6e\u4e0d\u540c\u7684\u901f\u7387\u9650\u5236\u7b56\u7565\uff0c\u5176\u4e2d\u533f\u540d\u6d88\u8d39\u8005\u4e0d\u9700\u8981\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\uff0c\u914d\u989d\u8f83\u5c11\u3002"),(0,r.kt)("p",null,"\u521b\u5efa\u5e38\u89c4\u6d88\u8d39\u8005 ",(0,r.kt)("inlineCode",{parentName:"p"},"john"),"\uff0c\u5e76\u914d\u7f6e ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-count")," \u63d2\u4ef6\uff0c\u4ee5\u5141\u8bb8 30 \u79d2\u5185\u7684\u914d\u989d\u4e3a 3\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "john",\n    "plugins": {\n      "limit-count": {\n        "count": 3,\n        "time_window": 30,\n        "rejected_code": 429\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u4e3a\u6d88\u8d39\u8005 ",(0,r.kt)("inlineCode",{parentName:"p"},"john")," \u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u51ed\u8bc1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/john/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-hmac-auth",\n    "plugins": {\n      "hmac-auth": {\n        "key_id": "john-key",\n        "secret_key": "john-secret-key"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u521b\u5efa\u533f\u540d\u7528\u6237 ",(0,r.kt)("inlineCode",{parentName:"p"},"anonymous"),"\uff0c\u5e76\u914d\u7f6e ",(0,r.kt)("inlineCode",{parentName:"p"},"limit-count")," \u63d2\u4ef6\uff0c\u4ee5\u5141\u8bb8 30 \u79d2\u5185\u914d\u989d\u4e3a 1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "anonymous",\n    "plugins": {\n      "limit-count": {\n        "count": 1,\n        "time_window": 30,\n        "rejected_code": 429\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u521b\u5efa\u8def\u7531\u5e76\u914d\u7f6e ",(0,r.kt)("inlineCode",{parentName:"p"},"hmac-auth")," \u63d2\u4ef6\u4ee5\u63a5\u53d7\u533f\u540d\u6d88\u8d39\u8005 ",(0,r.kt)("inlineCode",{parentName:"p"},"anonymous")," \u7ed5\u8fc7\u8eab\u4efd\u9a8c\u8bc1\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "hmac-auth-route",\n    "uri": "/get",\n    "methods": ["GET"],\n    "plugins": {\n      "hmac-auth": {\n        "anonymous_consumer": "anonymous"\n      }\n    },\n    "upstream": {\n      "type": "roundrobin",\n      "nodes": {\n        "httpbin.org:80": 1\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u751f\u6210\u7b7e\u540d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b Python \u4ee3\u7801\u7247\u6bb5\u6216\u5176\u4ed6\u6280\u672f\u6808\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="hmac-sig-header-gen.py"',title:'"hmac-sig-header-gen.py"'},'import hmac\nimport hashlib\nimport base64\nfrom datetime import datetime, timezone\n\nkey_id = "john-key"                # key id\nsecret_key = b"john-secret-key"    # secret key\nrequest_method = "GET"             # HTTP method\nrequest_path = "/get"              # Route URI\nalgorithm= "hmac-sha256"           # can use other algorithms in allowed_algorithms\n\n# get current datetime in GMT\n# note: the signature will become invalid after the clock skew (default 300s)\n# you can regenerate the signature after it becomes invalid, or increase the clock\n# skew to prolong the validity within the advised security boundary\ngmt_time = datetime.now(timezone.utc).strftime(\'%a, %d %b %Y %H:%M:%S GMT\')\n\n# construct the signing string (ordered)\n# the date and any subsequent custom headers should be lowercased and separated by a\n# single space character, i.e. `<key>:<space><value>`\n# https://datatracker.ietf.org/doc/html/draft-cavage-http-signatures-12#section-2.1.6\nsigning_string = (\n  f"{key_id}\\n"\n  f"{request_method} {request_path}\\n"\n  f"date: {gmt_time}\\n"\n)\n\n# create signature\nsignature = hmac.new(secret_key, signing_string.encode(\'utf-8\'), hashlib.sha256).digest()\nsignature_base64 = base64.b64encode(signature).decode(\'utf-8\')\n\n# construct the request headers\nheaders = {\n  "Date": gmt_time,\n  "Authorization": (\n    f\'Signature keyId="{key_id}",algorithm="{algorithm}",\'\n    f\'headers="@request-target date",\'\n    f\'signature="{signature_base64}"\'\n  )\n}\n\n# print headers\nprint(headers)\n')),(0,r.kt)("p",null,"\u8fd0\u884c\u811a\u672c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"python3 hmac-sig-header-gen.py\n")),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u6253\u5370\u7684\u8bf7\u6c42\u6807\u5934\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"{'Date': 'Mon, 21 Oct 2024 17:31:18 GMT', 'Authorization': 'Signature keyId=\"john-key\",algorithm=\"hmac-sha256\",headers=\"@request-target date\",signature=\"ztFfl9w7LmCrIuPjRC/DWSF4gN6Bt8dBBz4y+u1pzt8=\"'}\n")),(0,r.kt)("p",null,"\u4f7f\u7528\u751f\u6210\u7684\u6807\u5934\u53d1\u9001\u4e94\u4e2a\u8fde\u7eed\u7684\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 5 | xargs -I{} curl "http://127.0.0.1:9080/anything" -H "Date: Mon, 21 Oct 2024 17:31:18 GMT" -H \'Authorization: Signature keyId="john-key",algorithm="hmac-sha256",headers="@request-target date",signature="ztFfl9w7LmCrIuPjRC/DWSF4gN6Bt8dBBz4y+u1pzt8="\' -o /dev/null -s -w "%{http_code}\\n") && \\\n  count_200=$(echo "$resp" | grep "200" | wc -l) && \\\n  count_429=$(echo "$resp" | grep "429" | wc -l) && \\\n  echo "200": $count_200, "429": $count_429\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u4ee5\u4e0b\u54cd\u5e94\uff0c\u663e\u793a\u5728 5 \u4e2a\u8bf7\u6c42\u4e2d\uff0c3 \u4e2a\u8bf7\u6c42\u6210\u529f\uff08\u72b6\u6001\u4ee3\u7801 200\uff09\uff0c\u800c\u5176\u4ed6\u8bf7\u6c42\u88ab\u62d2\u7edd\uff08\u72b6\u6001\u4ee3\u7801 429\uff09\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"200:    3, 429:    2\n")),(0,r.kt)("p",null,"\u53d1\u9001\u4e94\u4e2a\u533f\u540d\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'resp=$(seq 5 | xargs -I{} curl "http://127.0.0.1:9080/anything" -o /dev/null -s -w "%{http_code}\\n") && \\\n  count_200=$(echo "$resp" | grep "200" | wc -l) && \\\n  count_429=$(echo "$resp" | grep "429" | wc -l) && \\\n  echo "200": $count_200, "429": $count_429\n')),(0,r.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u4ee5\u4e0b\u54cd\u5e94\uff0c\u8868\u660e\u53ea\u6709\u4e00\u4e2a\u8bf7\u6c42\u6210\u529f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"200:    1, 429:    4\n")))}u.isMDXComponent=!0}}]);