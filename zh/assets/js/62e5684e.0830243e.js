"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[39164],{3905:(n,e,t)=>{t.d(e,{Zo:()=>m,kt:()=>u});var a=t(67294);function i(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function l(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,a)}return t}function o(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?l(Object(t),!0).forEach((function(e){i(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function r(n,e){if(null==n)return{};var t,a,i=function(n,e){if(null==n)return{};var t,a,i={},l=Object.keys(n);for(a=0;a<l.length;a++)t=l[a],e.indexOf(t)>=0||(i[t]=n[t]);return i}(n,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(n);for(a=0;a<l.length;a++)t=l[a],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(i[t]=n[t])}return i}var s=a.createContext({}),p=function(n){var e=a.useContext(s),t=e;return n&&(t="function"==typeof n?n(e):o(o({},e),n)),t},m=function(n){var e=p(n.components);return a.createElement(s.Provider,{value:e},n.children)},d={inlineCode:"code",wrapper:function(n){var e=n.children;return a.createElement(a.Fragment,{},e)}},c=a.forwardRef((function(n,e){var t=n.components,i=n.mdxType,l=n.originalType,s=n.parentName,m=r(n,["components","mdxType","originalType","parentName"]),c=p(t),u=i,k=c["".concat(s,".").concat(u)]||c[u]||d[u]||l;return t?a.createElement(k,o(o({ref:e},m),{},{components:t})):a.createElement(k,o({ref:e},m))}));function u(n,e){var t=arguments,i=e&&e.mdxType;if("string"==typeof n||i){var l=t.length,o=new Array(l);o[0]=c;var r={};for(var s in e)hasOwnProperty.call(e,s)&&(r[s]=e[s]);r.originalType=n,r.mdxType="string"==typeof n?n:i,o[1]=r;for(var p=2;p<l;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},13755:(n,e,t)=>{t.r(e),t.d(e,{contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>r,toc:()=>s});var a=t(87462),i=(t(67294),t(3905));const l={title:"ai-rate-limiting",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","ai-rate-limiting","AI","LLM"],description:"ai-rate-limiting \u63d2\u4ef6\u5bf9\u53d1\u9001\u5230 LLM \u670d\u52a1\u7684\u8bf7\u6c42\u5b9e\u65bd\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\uff0c\u9632\u6b62\u8fc7\u5ea6\u4f7f\u7528\uff0c\u4f18\u5316 API \u6d88\u8d39\uff0c\u5e76\u786e\u4fdd\u9ad8\u6548\u7684\u8d44\u6e90\u5206\u914d\u3002"},o=void 0,r={unversionedId:"plugins/ai-rate-limiting",id:"version-3.15/plugins/ai-rate-limiting",isDocsHomePage:!1,title:"ai-rate-limiting",description:"ai-rate-limiting \u63d2\u4ef6\u5bf9\u53d1\u9001\u5230 LLM \u670d\u52a1\u7684\u8bf7\u6c42\u5b9e\u65bd\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\uff0c\u9632\u6b62\u8fc7\u5ea6\u4f7f\u7528\uff0c\u4f18\u5316 API \u6d88\u8d39\uff0c\u5e76\u786e\u4fdd\u9ad8\u6548\u7684\u8d44\u6e90\u5206\u914d\u3002",source:"@site/i18n/zh/docusaurus-plugin-content-docs-docs-apisix/version-3.15/plugins/ai-rate-limiting.md",sourceDirName:"plugins",slug:"/plugins/ai-rate-limiting",permalink:"/zh/docs/apisix/plugins/ai-rate-limiting",editUrl:"/zh/edit#https://github.com/apache/apisix/edit/release/3.15/docs/zh/latest/plugins/ai-rate-limiting.md",tags:[],version:"3.15",frontMatter:{title:"ai-rate-limiting",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","ai-rate-limiting","AI","LLM"],description:"ai-rate-limiting \u63d2\u4ef6\u5bf9\u53d1\u9001\u5230 LLM \u670d\u52a1\u7684\u8bf7\u6c42\u5b9e\u65bd\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\uff0c\u9632\u6b62\u8fc7\u5ea6\u4f7f\u7528\uff0c\u4f18\u5316 API \u6d88\u8d39\uff0c\u5e76\u786e\u4fdd\u9ad8\u6548\u7684\u8d44\u6e90\u5206\u914d\u3002"},sidebar:"version-3.15/docs",previous:{title:"ai-proxy-multi",permalink:"/zh/docs/apisix/plugins/ai-proxy-multi"},next:{title:"ai-prompt-guard",permalink:"/zh/docs/apisix/plugins/ai-prompt-guard"}},s=[{value:"\u63cf\u8ff0",id:"\u63cf\u8ff0",children:[]},{value:"\u5c5e\u6027",id:"\u5c5e\u6027",children:[]},{value:"\u793a\u4f8b",id:"\u793a\u4f8b",children:[{value:"\u4e0e <code>ai-proxy</code> \u4e00\u8d77\u5e94\u7528\u901f\u7387\u9650\u5236",id:"\u4e0e-ai-proxy-\u4e00\u8d77\u5e94\u7528\u901f\u7387\u9650\u5236",children:[]},{value:"\u5bf9\u591a\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u4e00\u4e2a\u8fdb\u884c\u901f\u7387\u9650\u5236",id:"\u5bf9\u591a\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u4e00\u4e2a\u8fdb\u884c\u901f\u7387\u9650\u5236",children:[]},{value:"\u5bf9\u6240\u6709\u5b9e\u4f8b\u5e94\u7528\u76f8\u540c\u914d\u989d",id:"\u5bf9\u6240\u6709\u5b9e\u4f8b\u5e94\u7528\u76f8\u540c\u914d\u989d",children:[]},{value:"\u914d\u7f6e\u5b9e\u4f8b\u4f18\u5148\u7ea7\u548c\u901f\u7387\u9650\u5236",id:"\u914d\u7f6e\u5b9e\u4f8b\u4f18\u5148\u7ea7\u548c\u901f\u7387\u9650\u5236",children:[]},{value:"\u6309\u6d88\u8d39\u8005\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u548c\u901f\u7387\u9650\u5236",id:"\u6309\u6d88\u8d39\u8005\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u548c\u901f\u7387\u9650\u5236",children:[]}]}],p={toc:s};function m(n){let{components:e,...t}=n;return(0,i.kt)("wrapper",(0,a.Z)({},p,t,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("head",null,(0,i.kt)("link",{rel:"canonical",href:"https://docs.api7.ai/hub/ai-rate-limiting"})),(0,i.kt)("h2",{id:"\u63cf\u8ff0"},"\u63cf\u8ff0"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting")," \u63d2\u4ef6\u5bf9\u53d1\u9001\u5230 LLM \u670d\u52a1\u7684\u8bf7\u6c42\u5b9e\u65bd\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u3002\u5b83\u901a\u8fc7\u63a7\u5236\u5728\u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u6d88\u8017\u7684\u4ee4\u724c\u6570\u91cf\u6765\u5e2e\u52a9\u7ba1\u7406 API \u4f7f\u7528\uff0c\u786e\u4fdd\u516c\u5e73\u7684\u8d44\u6e90\u5206\u914d\u5e76\u9632\u6b62\u670d\u52a1\u8fc7\u8f7d\u3002\u5b83\u901a\u5e38\u4e0e ",(0,i.kt)("a",{parentName:"p",href:"/zh/docs/apisix/plugins/ai-proxy"},(0,i.kt)("inlineCode",{parentName:"a"},"ai-proxy"))," \u6216 ",(0,i.kt)("a",{parentName:"p",href:"/zh/docs/apisix/plugins/ai-proxy-multi"},(0,i.kt)("inlineCode",{parentName:"a"},"ai-proxy-multi"))," \u63d2\u4ef6\u4e00\u8d77\u4f7f\u7528\u3002"),(0,i.kt)("h2",{id:"\u5c5e\u6027"},"\u5c5e\u6027"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"\u540d\u79f0"),(0,i.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,i.kt)("th",{parentName:"tr",align:null},"\u5fc5\u9009\u9879"),(0,i.kt)("th",{parentName:"tr",align:null},"\u9ed8\u8ba4\u503c"),(0,i.kt)("th",{parentName:"tr",align:null},"\u6709\u6548\u503c"),(0,i.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"limit"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},">0"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5728\u7ed9\u5b9a\u65f6\u95f4\u95f4\u9694\u5185\u5141\u8bb8\u7684\u6700\u5927\u4ee4\u724c\u6570\u3002",(0,i.kt)("inlineCode",{parentName:"td"},"limit")," \u548c ",(0,i.kt)("inlineCode",{parentName:"td"},"instances.limit")," \u4e2d\u81f3\u5c11\u5e94\u914d\u7f6e\u4e00\u4e2a\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"time_window"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},">0"),(0,i.kt)("td",{parentName:"tr",align:null},"\u4e0e\u901f\u7387\u9650\u5236 ",(0,i.kt)("inlineCode",{parentName:"td"},"limit")," \u5bf9\u5e94\u7684\u65f6\u95f4\u95f4\u9694\uff08\u79d2\uff09\u3002",(0,i.kt)("inlineCode",{parentName:"td"},"time_window")," \u548c ",(0,i.kt)("inlineCode",{parentName:"td"},"instances.time_window")," \u4e2d\u81f3\u5c11\u5e94\u914d\u7f6e\u4e00\u4e2a\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"show_limit_quota_header"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null},"true"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u4e3a true\uff0c\u5219\u5728\u54cd\u5e94\u4e2d\u5305\u542b ",(0,i.kt)("inlineCode",{parentName:"td"},"X-AI-RateLimit-Limit-*"),"\u3001",(0,i.kt)("inlineCode",{parentName:"td"},"X-AI-RateLimit-Remaining-*")," \u548c ",(0,i.kt)("inlineCode",{parentName:"td"},"X-AI-RateLimit-Reset-*")," \u5934\u90e8\uff0c\u5176\u4e2d ",(0,i.kt)("inlineCode",{parentName:"td"},"*")," \u662f\u5b9e\u4f8b\u540d\u79f0\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"limit_strategy"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null},"total_tokens"),(0,i.kt)("td",{parentName:"tr",align:null},"[total_tokens, prompt_tokens, completion_tokens]"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5e94\u7528\u901f\u7387\u9650\u5236\u7684\u4ee4\u724c\u7c7b\u578b\u3002",(0,i.kt)("inlineCode",{parentName:"td"},"total_tokens")," \u662f ",(0,i.kt)("inlineCode",{parentName:"td"},"prompt_tokens")," \u548c ",(0,i.kt)("inlineCode",{parentName:"td"},"completion_tokens")," \u7684\u603b\u548c\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"instances"),(0,i.kt)("td",{parentName:"tr",align:null},"array","[object]"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"LLM \u5b9e\u4f8b\u901f\u7387\u9650\u5236\u914d\u7f6e\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"instances.name"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"LLM \u670d\u52a1\u5b9e\u4f8b\u7684\u540d\u79f0\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"instances.limit"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},">0"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5b9e\u4f8b\u5728\u7ed9\u5b9a\u65f6\u95f4\u95f4\u9694\u5185\u5141\u8bb8\u7684\u6700\u5927\u4ee4\u724c\u6570\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"instances.time_window"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},">0"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5b9e\u4f8b\u901f\u7387\u9650\u5236 ",(0,i.kt)("inlineCode",{parentName:"td"},"limit")," \u5bf9\u5e94\u7684\u65f6\u95f4\u95f4\u9694\uff08\u79d2\uff09\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"rejected_code"),(0,i.kt)("td",{parentName:"tr",align:null},"integer"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null},"503"),(0,i.kt)("td",{parentName:"tr",align:null},"[200, 599]"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5f53\u8d85\u51fa\u914d\u989d\u7684\u8bf7\u6c42\u88ab\u62d2\u7edd\u65f6\u8fd4\u56de\u7684 HTTP \u72b6\u6001\u7801\u3002")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"rejected_msg"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null},"\u5f53\u8d85\u51fa\u914d\u989d\u7684\u8bf7\u6c42\u88ab\u62d2\u7edd\u65f6\u8fd4\u56de\u7684\u54cd\u5e94\u4f53\u3002")))),(0,i.kt)("h2",{id:"\u793a\u4f8b"},"\u793a\u4f8b"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u4e3a\u4e0d\u540c\u573a\u666f\u914d\u7f6e ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting"),"\u3002"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4ece ",(0,i.kt)("inlineCode",{parentName:"p"},"config.yaml")," \u83b7\u53d6 ",(0,i.kt)("inlineCode",{parentName:"p"},"admin_key")," \u5e76\u4fdd\u5b58\u5230\u73af\u5883\u53d8\u91cf\u4e2d\uff1a"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,i.kt)("h3",{id:"\u4e0e-ai-proxy-\u4e00\u8d77\u5e94\u7528\u901f\u7387\u9650\u5236"},"\u4e0e ",(0,i.kt)("inlineCode",{parentName:"h3"},"ai-proxy")," \u4e00\u8d77\u5e94\u7528\u901f\u7387\u9650\u5236"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-proxy")," \u4ee3\u7406 LLM \u6d41\u91cf\uff0c\u5e76\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting")," \u5728\u5b9e\u4f8b\u4e0a\u914d\u7f6e\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u3002"),(0,i.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u8def\u7531\u5e76\u66f4\u65b0\u60a8\u7684 LLM \u63d0\u4f9b\u5546\u3001\u6a21\u578b\u3001API \u5bc6\u94a5\u548c\u7aef\u70b9\uff08\u5982\u9002\u7528\uff09\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "ai-rate-limiting-route",\n    "uri": "/anything",\n    "methods": ["POST"],\n    "plugins": {\n      "ai-proxy": {\n        "provider": "openai",\n        "auth": {\n          "header": {\n            "Authorization": "Bearer \'"$OPENAI_API_KEY"\'"\n          }\n        },\n        "options": {\n          "model": "gpt-35-turbo-instruct",\n          "max_tokens": 512,\n          "temperature": 1.0\n        }\n      },\n      "ai-rate-limiting": {\n        "limit": 300,\n        "time_window": 30,\n        "limit_strategy": "prompt_tokens"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff0c\u5728\u8bf7\u6c42\u4f53\u4e2d\u5305\u542b\u7cfb\u7edf\u63d0\u793a\u548c\u793a\u4f8b\u7528\u6237\u95ee\u9898\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "1 + 1 equals 2. This is a fundamental arithmetic operation where adding one unit to another results in a total of two units."\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  ...\n}\n')),(0,i.kt)("p",null,"\u5982\u679c\u5728 30 \u79d2\u7a97\u53e3\u5185\u6d88\u8017\u4e86 300 \u4e2a\u63d0\u793a\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff0c\u6240\u6709\u989d\u5916\u7684\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u3002"),(0,i.kt)("h3",{id:"\u5bf9\u591a\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u4e00\u4e2a\u8fdb\u884c\u901f\u7387\u9650\u5236"},"\u5bf9\u591a\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u4e00\u4e2a\u8fdb\u884c\u901f\u7387\u9650\u5236"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-proxy-multi")," \u914d\u7f6e\u4e24\u4e2a\u6a21\u578b\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u5c06 80% \u7684\u6d41\u91cf\u8f6c\u53d1\u5230\u4e00\u4e2a\u5b9e\u4f8b\uff0c20% \u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u3002\u6b64\u5916\uff0c\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting")," \u5bf9\u63a5\u6536 80% \u6d41\u91cf\u7684\u5b9e\u4f8b\u914d\u7f6e\u57fa\u4e8e\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\uff0c\u8fd9\u6837\u5f53\u914d\u7f6e\u7684\u914d\u989d\u5b8c\u5168\u6d88\u8017\u65f6\uff0c\u989d\u5916\u7684\u6d41\u91cf\u5c06\u88ab\u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u8def\u7531\uff0c\u5bf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek-instance-1")," \u5b9e\u4f8b\u5e94\u7528 30 \u79d2\u7a97\u53e3\u5185 100 \u4e2a\u603b\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff0c\u5e76\u66f4\u65b0\u60a8\u7684 LLM \u63d0\u4f9b\u5546\u3001\u6a21\u578b\u3001API \u5bc6\u94a5\u548c\u7aef\u70b9\uff08\u5982\u9002\u7528\uff09\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "ai-rate-limiting-route",\n    "uri": "/anything",\n    "methods": ["POST"],\n    "plugins": {\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "deepseek-instance-1",\n            "provider": "deepseek",\n            "weight": 8,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$DEEPSEEK_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "deepseek-chat"\n            }\n          },\n          {\n            "name": "deepseek-instance-2",\n            "provider": "deepseek",\n            "weight": 2,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$DEEPSEEK_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "deepseek-chat"\n            }\n          }\n        ]\n      },\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "deepseek-instance-1",\n            "limit_strategy": "total_tokens",\n            "limit": 100,\n            "time_window": 30\n          }\n        ]\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff0c\u5728\u8bf7\u6c42\u4f53\u4e2d\u5305\u542b\u7cfb\u7edf\u63d0\u793a\u548c\u793a\u4f8b\u7528\u6237\u95ee\u9898\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "1 + 1 equals 2. This is a fundamental arithmetic operation where adding one unit to another results in a total of two units."\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  ...\n}\n')),(0,i.kt)("p",null,"\u5982\u679c ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek-instance-1")," \u5b9e\u4f8b\u5728 30 \u79d2\u7a97\u53e3\u5185\u6d88\u8017\u4e86 100 \u4e2a\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff0c\u989d\u5916\u7684\u8bf7\u6c42\u5c06\u5168\u90e8\u8f6c\u53d1\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek-instance-2"),"\uff0c\u8be5\u5b9e\u4f8b\u6ca1\u6709\u901f\u7387\u9650\u5236\u3002"),(0,i.kt)("h3",{id:"\u5bf9\u6240\u6709\u5b9e\u4f8b\u5e94\u7528\u76f8\u540c\u914d\u989d"},"\u5bf9\u6240\u6709\u5b9e\u4f8b\u5e94\u7528\u76f8\u540c\u914d\u989d"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u5bf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting")," \u4e2d\u7684\u6240\u6709 LLM \u4e0a\u6e38\u5b9e\u4f8b\u5e94\u7528\u76f8\u540c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\u3002"),(0,i.kt)("p",null,"\u4e3a\u4e86\u6f14\u793a\u548c\u66f4\u5bb9\u6613\u533a\u5206\uff0c\u60a8\u5c06\u914d\u7f6e\u4e00\u4e2a OpenAI \u5b9e\u4f8b\u548c\u4e00\u4e2a DeepSeek \u5b9e\u4f8b\u4f5c\u4e3a\u4e0a\u6e38 LLM \u670d\u52a1\u3002"),(0,i.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u8def\u7531\uff0c\u5bf9\u6240\u6709\u5b9e\u4f8b\u5728 60 \u79d2\u7a97\u53e3\u5185\u5e94\u7528 100 \u4e2a\u603b\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff0c\u5e76\u66f4\u65b0\u60a8\u7684 LLM \u63d0\u4f9b\u5546\u3001\u6a21\u578b\u3001API \u5bc6\u94a5\u548c\u7aef\u70b9\uff08\u5982\u9002\u7528\uff09\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "ai-rate-limiting-route",\n    "uri": "/anything",\n    "methods": ["POST"],\n    "plugins": {\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "openai-instance",\n            "provider": "openai",\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$OPENAI_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "gpt-4"\n            }\n          },\n          {\n            "name": "deepseek-instance",\n            "provider": "deepseek",\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$DEEPSEEK_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "deepseek-chat"\n            }\n          }\n        ]\n      },\n      "ai-rate-limiting": {\n        "limit": 100,\n        "time_window": 60,\n        "rejected_code": 429,\n        "limit_strategy": "total_tokens"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff0c\u5728\u8bf7\u6c42\u4f53\u4e2d\u5305\u542b\u7cfb\u7edf\u63d0\u793a\u548c\u793a\u4f8b\u7528\u6237\u95ee\u9898\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newtons laws" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u6765\u81ea\u4efb\u4e00 LLM \u5b9e\u4f8b\u7684\u54cd\u5e94\uff0c\u7c7b\u4f3c\u4ee5\u4e0b\u5185\u5bb9\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "gpt-4-0613",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "Sure! Sir Isaac Newton formulated three laws of motion that describe the motion of objects. These laws are widely used in physics and engineering for studying and understanding how things move. Here they are:\\n\\n1. Newton\'s First Law - Law of Inertia: An object at rest tends to stay at rest and an object in motion tends to stay in motion with the same speed and in the same direction unless acted upon by an unbalanced force. This is also known as the principle of inertia.\\n\\n2. Newton\'s Second Law of Motion - Force and Acceleration: The acceleration of an object is directly proportional to the net force acting on it and inversely proportional to its mass. This is usually formulated as F=ma where F is the force applied, m is the mass of the object and a is the acceleration produced.\\n\\n3. Newton\'s Third Law - Action and Reaction: For every action, there is an equal and opposite reaction. This means that any force exerted on a body will create a force of equal magnitude but in the opposite direction on the object that exerted the first force.\\n\\nIn simple terms: \\n1. If you slide a book on a table and let go, it will stop because of the friction (or force) between it and the table.\\n2.",\n        "refusal": null\n      },\n      "logprobs": null,\n      "finish_reason": "length"\n    }\n  ],\n  "usage": {\n    "prompt_tokens": 23,\n    "completion_tokens": 256,\n    "total_tokens": 279,\n    "prompt_tokens_details": {\n      "cached_tokens": 0,\n      "audio_tokens": 0\n    },\n    "completion_tokens_details": {\n      "reasoning_tokens": 0,\n      "audio_tokens": 0,\n      "accepted_prediction_tokens": 0,\n      "rejected_prediction_tokens": 0\n    }\n  },\n  "service_tier": "default",\n  "system_fingerprint": null\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"total_tokens")," \u503c\u8d85\u8fc7\u4e86\u914d\u7f6e\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"100")," \u914d\u989d\uff0c\u9884\u671f\u5728 60 \u79d2\u7a97\u53e3\u5185\u7684\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5c06\u88ab\u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u5728\u540c\u4e00\u4e2a 60 \u79d2\u7a97\u53e3\u5185\uff0c\u5411\u8def\u7531\u53d1\u9001\u53e6\u4e00\u4e2a POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newtons laws" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u6765\u81ea\u53e6\u4e00\u4e2a LLM \u5b9e\u4f8b\u7684\u54cd\u5e94\uff0c\u7c7b\u4f3c\u4ee5\u4e0b\u5185\u5bb9\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "Sure! Newton\'s laws of motion are three fundamental principles that describe the relationship between the motion of an object and the forces acting on it. They were formulated by Sir Isaac Newton in the late 17th century and are foundational to classical mechanics. Here\'s an explanation of each law:\\n\\n---\\n\\n### **1. Newton\'s First Law (Law of Inertia)**\\n- **Statement**: An object will remain at rest or in uniform motion in a straight line unless acted upon by an external force.\\n- **What it means**: This law introduces the concept of **inertia**, which is the tendency of an object to resist changes in its state of motion. If no net force acts on an object, its velocity (speed and direction) will not change.\\n- **Example**: A book lying on a table will stay at rest unless you push it. Similarly, a hockey puck sliding on ice will keep moving at a constant speed unless friction or another force slows it down.\\n\\n---\\n\\n### **2. Newton\'s Second Law (Law of Acceleration)**\\n- **Statement**: The acceleration of an object is directly proportional to the net force acting on it and inversely proportional to its mass. Mathematically, this is expressed as:\\n  \\\\[\\n  F = ma\\n  \\\\]\\n"\n      },\n      "logprobs": null,\n      "finish_reason": "length"\n    }\n  ],\n  "usage": {\n    "prompt_tokens": 13,\n    "completion_tokens": 256,\n    "total_tokens": 269,\n    "prompt_tokens_details": {\n      "cached_tokens": 0\n    },\n    "prompt_cache_hit_tokens": 0,\n    "prompt_cache_miss_tokens": 13\n  },\n  "system_fingerprint": "fp_3a5770e1b4_prod0225"\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"total_tokens")," \u503c\u8d85\u8fc7\u4e86\u914d\u7f6e\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"100")," \u914d\u989d\uff0c\u9884\u671f\u5728 60 \u79d2\u7a97\u53e3\u5185\u7684\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u3002"),(0,i.kt)("p",null,"\u5728\u540c\u4e00\u4e2a 60 \u79d2\u7a97\u53e3\u5185\uff0c\u5411\u8def\u7531\u53d1\u9001\u7b2c\u4e09\u4e2a POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newtons laws" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"HTTP 429 Too Many Requests")," \u54cd\u5e94\u5e76\u89c2\u5bdf\u5230\u4ee5\u4e0b\u5934\u90e8\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"X-AI-RateLimit-Limit-openai-instance: 100\nX-AI-RateLimit-Remaining-openai-instance: 0\nX-AI-RateLimit-Reset-openai-instance: 0\nX-AI-RateLimit-Limit-deepseek-instance: 100\nX-AI-RateLimit-Remaining-deepseek-instance: 0\nX-AI-RateLimit-Reset-deepseek-instance: 0\n")),(0,i.kt)("h3",{id:"\u914d\u7f6e\u5b9e\u4f8b\u4f18\u5148\u7ea7\u548c\u901f\u7387\u9650\u5236"},"\u914d\u7f6e\u5b9e\u4f8b\u4f18\u5148\u7ea7\u548c\u901f\u7387\u9650\u5236"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u914d\u7f6e\u4e24\u4e2a\u5177\u6709\u4e0d\u540c\u4f18\u5148\u7ea7\u7684\u6a21\u578b\uff0c\u5e76\u5bf9\u5177\u6709\u8f83\u9ad8\u4f18\u5148\u7ea7\u7684\u5b9e\u4f8b\u5e94\u7528\u901f\u7387\u9650\u5236\u3002\u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"fallback_strategy")," \u8bbe\u7f6e\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},'["rate_limiting"]')," \u7684\u60c5\u51b5\u4e0b\uff0c\u4e00\u65e6\u9ad8\u4f18\u5148\u7ea7\u5b9e\u4f8b\u7684\u901f\u7387\u9650\u5236\u914d\u989d\u5b8c\u5168\u6d88\u8017\uff0c\u63d2\u4ef6\u5e94\u7ee7\u7eed\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u4f4e\u4f18\u5148\u7ea7\u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u8def\u7531\uff0c\u5bf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"openai-instance")," \u5b9e\u4f8b\u8bbe\u7f6e\u901f\u7387\u9650\u5236\u548c\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7\uff0c\u5e76\u5c06 ",(0,i.kt)("inlineCode",{parentName:"p"},"fallback_strategy")," \u8bbe\u7f6e\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},'["rate_limiting"]'),"\u3002\u66f4\u65b0\u60a8\u7684 LLM \u63d0\u4f9b\u5546\u3001\u6a21\u578b\u3001API \u5bc6\u94a5\u548c\u7aef\u70b9\uff08\u5982\u9002\u7528\uff09\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "ai-rate-limiting-route",\n    "uri": "/anything",\n    "methods": ["POST"],\n    "plugins": {\n      "ai-proxy-multi": {\n        "fallback_strategy": ["rate_limiting"],\n        "instances": [\n          {\n            "name": "openai-instance",\n            "provider": "openai",\n            "priority": 1,\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$OPENAI_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "gpt-4"\n            }\n          },\n          {\n            "name": "deepseek-instance",\n            "provider": "deepseek",\n            "priority": 0,\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$DEEPSEEK_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "deepseek-chat"\n            }\n          }\n        ]\n      },\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "openai-instance",\n            "limit": 10,\n            "time_window": 60\n          }\n        ],\n        "limit_strategy": "total_tokens"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff0c\u5728\u8bf7\u6c42\u4f53\u4e2d\u5305\u542b\u7cfb\u7edf\u63d0\u793a\u548c\u793a\u4f8b\u7528\u6237\u95ee\u9898\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "gpt-4-0613",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "1+1 equals 2.",\n        "refusal": null\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  "usage": {\n    "prompt_tokens": 23,\n    "completion_tokens": 8,\n    "total_tokens": 31,\n    "prompt_tokens_details": {\n      "cached_tokens": 0,\n      "audio_tokens": 0\n    },\n    "completion_tokens_details": {\n      "reasoning_tokens": 0,\n      "audio_tokens": 0,\n      "accepted_prediction_tokens": 0,\n      "rejected_prediction_tokens": 0\n    }\n  },\n  "service_tier": "default",\n  "system_fingerprint": null\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"total_tokens")," \u503c\u8d85\u8fc7\u4e86\u914d\u7f6e\u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"10")," \u914d\u989d\uff0c\u9884\u671f\u5728 60 \u79d2\u7a97\u53e3\u5185\u7684\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5c06\u88ab\u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u5728\u540c\u4e00\u4e2a 60 \u79d2\u7a97\u53e3\u5185\uff0c\u5411\u8def\u7531\u53d1\u9001\u53e6\u4e00\u4e2a POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newton law" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "Certainly! Newton\'s laws of motion are three fundamental principles that describe the relationship between the motion of an object and the forces acting on it. They were formulated by Sir Isaac Newton in the late 17th century and are foundational to classical mechanics.\\n\\n---\\n\\n### **1. Newton\'s First Law (Law of Inertia):**\\n- **Statement:** An object at rest will remain at rest, and an object in motion will continue moving at a constant velocity (in a straight line at a constant speed), unless acted upon by an external force.\\n- **Key Idea:** This law introduces the concept of **inertia**, which is the tendency of an object to resist changes in its state of motion.\\n- **Example:** If you slide a book across a table, it eventually stops because of the force of friction acting on it. Without friction, the book would keep moving indefinitely.\\n\\n---\\n\\n### **2. Newton\'s Second Law (Law of Acceleration):**\\n- **Statement:** The acceleration of an object is directly proportional to the net force acting on it and inversely proportional to its mass. Mathematically, this is expressed as:\\n  \\\\[\\n  F = ma\\n  \\\\]\\n  where:\\n  - \\\\( F \\\\) = net force applied (in Newtons),\\n  -"\n      },\n      ...\n    }\n  ],\n  ...\n}\n')),(0,i.kt)("h3",{id:"\u6309\u6d88\u8d39\u8005\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u548c\u901f\u7387\u9650\u5236"},"\u6309\u6d88\u8d39\u8005\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u548c\u901f\u7387\u9650\u5236"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u5982\u4f55\u914d\u7f6e\u4e24\u4e2a\u6a21\u578b\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\uff0c\u5e76\u6309\u6d88\u8d39\u8005\u5e94\u7528\u901f\u7387\u9650\u5236\u3002"),(0,i.kt)("p",null,"\u521b\u5efa\u6d88\u8d39\u8005 ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u5e76\u5bf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"openai-instance")," \u5b9e\u4f8b\u8bbe\u7f6e 60 \u79d2\u7a97\u53e3\u5185 10 \u4e2a\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "johndoe",\n    "plugins": {\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "openai-instance",\n            "limit": 10,\n            "time_window": 60\n          }\n        ],\n        "rejected_code": 429,\n        "limit_strategy": "total_tokens"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u914d\u7f6e ",(0,i.kt)("inlineCode",{parentName:"p"},"key-auth")," \u51ed\u636e\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/johndoe/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-john-key-auth",\n    "plugins": {\n      "key-auth": {\n        "key": "john-key"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u521b\u5efa\u53e6\u4e00\u4e2a\u6d88\u8d39\u8005 ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u5e76\u5bf9 ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek-instance")," \u5b9e\u4f8b\u8bbe\u7f6e 60 \u79d2\u7a97\u53e3\u5185 10 \u4e2a\u4ee4\u724c\u7684\u901f\u7387\u9650\u5236\u914d\u989d\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "janedoe",\n    "plugins": {\n      "ai-rate-limiting": {\n        "instances": [\n          {\n            "name": "deepseek-instance",\n            "limit": 10,\n            "time_window": 60\n          }\n        ],\n        "rejected_code": 429,\n        "limit_strategy": "total_tokens"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u4e3a ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u914d\u7f6e ",(0,i.kt)("inlineCode",{parentName:"p"},"key-auth")," \u51ed\u636e\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers/janedoe/credentials" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "cred-jane-key-auth",\n    "plugins": {\n      "key-auth": {\n        "key": "jane-key"\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u8def\u7531\u5e76\u66f4\u65b0\u60a8\u7684 LLM \u63d0\u4f9b\u5546\u3001\u6a21\u578b\u3001API \u5bc6\u94a5\u548c\u7aef\u70b9\uff08\u5982\u9002\u7528\uff09\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "ai-rate-limiting-route",\n    "uri": "/anything",\n    "methods": ["POST"],\n    "plugins": {\n      "key-auth": {},\n      "ai-proxy-multi": {\n        "fallback_strategy": ["rate_limiting"],\n        "instances": [\n          {\n            "name": "openai-instance",\n            "provider": "openai",\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$OPENAI_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "gpt-4"\n            }\n          },\n          {\n            "name": "deepseek-instance",\n            "provider": "deepseek",\n            "weight": 0,\n            "auth": {\n              "header": {\n                "Authorization": "Bearer \'"$DEEPSEEK_API_KEY"\'"\n              }\n            },\n            "options": {\n              "model": "deepseek-chat"\n            }\n          }\n        ]\n      }\n    }\n  }\'\n')),(0,i.kt)("p",null,"\u5411\u8def\u7531\u53d1\u9001\u4e0d\u5e26\u4efb\u4f55\u6d88\u8d39\u8005\u5bc6\u94a5\u7684 POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl -i "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 401 Unauthorized")," \u54cd\u5e94\u3002"),(0,i.kt)("p",null,"\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u7684\u5bc6\u94a5\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -H \'apikey: john-key\' \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "gpt-4-0613",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "1+1 equals 2.",\n        "refusal": null\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  "usage": {\n    "prompt_tokens": 23,\n    "completion_tokens": 8,\n    "total_tokens": 31,\n    "prompt_tokens_details": {\n      "cached_tokens": 0,\n      "audio_tokens": 0\n    },\n    "completion_tokens_details": {\n      "reasoning_tokens": 0,\n      "audio_tokens": 0,\n      "accepted_prediction_tokens": 0,\n      "rejected_prediction_tokens": 0\n    }\n  },\n  "service_tier": "default",\n  "system_fingerprint": null\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"total_tokens")," \u503c\u8d85\u8fc7\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"openai")," \u5b9e\u4f8b\u914d\u7f6e\u914d\u989d\uff0c\u9884\u671f\u5728 60 \u79d2\u7a97\u53e3\u5185\u6765\u81ea ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u7684\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5c06\u88ab\u8f6c\u53d1\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek")," \u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u5728\u540c\u4e00\u4e2a 60 \u79d2\u7a97\u53e3\u5185\uff0c\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"johndoe")," \u7684\u5bc6\u94a5\u5411\u8def\u7531\u53d1\u9001\u53e6\u4e00\u4e2a POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -H \'apikey: john-key\' \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newtons laws to me" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "Certainly! Newton\'s laws of motion are three fundamental principles that describe the relationship between the motion of an object and the forces acting on it. They were formulated by Sir Isaac Newton in the late 17th century and are foundational to classical mechanics.\\n\\n---\\n\\n### **1. Newton\'s First Law (Law of Inertia):**\\n- **Statement:** An object at rest will remain at rest, and an object in motion will continue moving at a constant velocity (in a straight line at a constant speed), unless acted upon by an external force.\\n- **Key Idea:** This law introduces the concept of **inertia**, which is the tendency of an object to resist changes in its state of motion.\\n- **Example:** If you slide a book across a table, it eventually stops because of the force of friction acting on it. Without friction, the book would keep moving indefinitely.\\n\\n---\\n\\n### **2. Newton\'s Second Law (Law of Acceleration):**\\n- **Statement:** The acceleration of an object is directly proportional to the net force acting on it and inversely proportional to its mass. Mathematically, this is expressed as:\\n  \\\\[\\n  F = ma\\n  \\\\]\\n  where:\\n  - \\\\( F \\\\) = net force applied (in Newtons),\\n  -"\n      },\n      ...\n    }\n  ],\n  ...\n}\n')),(0,i.kt)("p",null,"\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u7684\u5bc6\u94a5\u5411\u8def\u7531\u53d1\u9001 POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -H \'apikey: jane-key\' \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "What is 1+1?" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u6536\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "deepseek-chat",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "The sum of 1 and 1 is 2. This is a basic arithmetic operation where you combine two units to get a total of two units."\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  "usage": {\n    "prompt_tokens": 14,\n    "completion_tokens": 31,\n    "total_tokens": 45,\n    "prompt_tokens_details": {\n      "cached_tokens": 0\n    },\n    "prompt_cache_hit_tokens": 0,\n    "prompt_cache_miss_tokens": 14\n  },\n  "system_fingerprint": "fp_3a5770e1b4_prod0225"\n}\n')),(0,i.kt)("p",null,"\u7531\u4e8e ",(0,i.kt)("inlineCode",{parentName:"p"},"total_tokens")," \u503c\u8d85\u8fc7\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u7684 ",(0,i.kt)("inlineCode",{parentName:"p"},"deepseek")," \u5b9e\u4f8b\u914d\u7f6e\u914d\u989d\uff0c\u9884\u671f\u5728 60 \u79d2\u7a97\u53e3\u5185\u6765\u81ea ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u7684\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u5c06\u88ab\u8f6c\u53d1\u5230 ",(0,i.kt)("inlineCode",{parentName:"p"},"openai")," \u5b9e\u4f8b\u3002"),(0,i.kt)("p",null,"\u5728\u540c\u4e00\u4e2a 60 \u79d2\u7a97\u53e3\u5185\uff0c\u4f7f\u7528 ",(0,i.kt)("inlineCode",{parentName:"p"},"janedoe")," \u7684\u5bc6\u94a5\u5411\u8def\u7531\u53d1\u9001\u53e6\u4e00\u4e2a POST \u8bf7\u6c42\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/anything" -X POST \\\n  -H "Content-Type: application/json" \\\n  -H \'apikey: jane-key\' \\\n  -d \'{\n    "messages": [\n      { "role": "system", "content": "You are a mathematician" },\n      { "role": "user", "content": "Explain Newtons laws to me" }\n    ]\n  }\'\n')),(0,i.kt)("p",null,"\u60a8\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u54cd\u5e94\uff1a"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...,\n  "model": "gpt-4-0613",\n  "choices": [\n    {\n      "index": 0,\n      "message": {\n        "role": "assistant",\n        "content": "Sure, here are Newton\'s three laws of motion:\\n\\n1) Newton\'s First Law, also known as the Law of Inertia, states that an object at rest will stay at rest, and an object in motion will stay in motion, unless acted on by an external force. In simple words, this law suggests th",\n        "refusal": null\n      },\n      "logprobs": null,\n      "finish_reason": "stop"\n    }\n  ],\n  ...\n}\n')),(0,i.kt)("p",null,"\u8fd9\u663e\u793a\u4e86 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-proxy-multi")," \u6839\u636e\u6d88\u8d39\u8005\u5728 ",(0,i.kt)("inlineCode",{parentName:"p"},"ai-rate-limiting")," \u4e2d\u7684\u901f\u7387\u9650\u5236\u89c4\u5219\u5bf9\u6d41\u91cf\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u3002"))}m.isMDXComponent=!0}}]);