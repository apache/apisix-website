"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[20750],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(a),h=r,g=c["".concat(s,".").concat(h)]||c[h]||d[h]||i;return a?n.createElement(g,o(o({ref:t},u),{},{components:a})):n.createElement(g,o({ref:t},u))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},2297:(e,t,a)=>{a.r(t),a.d(t,{contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var n=a(87462),r=(a(67294),a(3905));const i={title:"lago",keywords:["Apache APISIX","API Gateway","Plugin","lago","monetization","github.com/getlago/lago"],description:"The lago plugin reports usage to a Lago instance, which allows users to integrate Lago with APISIX for API monetization."},o=void 0,l={unversionedId:"plugins/lago",id:"plugins/lago",isDocsHomePage:!1,title:"lago",description:"The lago plugin reports usage to a Lago instance, which allows users to integrate Lago with APISIX for API monetization.",source:"@site/docs/apisix/plugins/lago.md",sourceDirName:"plugins",slug:"/plugins/lago",permalink:"/zh/docs/apisix/next/plugins/lago",editUrl:"/zh/edit#https://github.com/apache/apisix/edit/master/docs/zh/latest/plugins/lago.md",tags:[],version:"current",frontMatter:{title:"lago",keywords:["Apache APISIX","API Gateway","Plugin","lago","monetization","github.com/getlago/lago"],description:"The lago plugin reports usage to a Lago instance, which allows users to integrate Lago with APISIX for API monetization."},sidebar:"docs",previous:{title:"loki-logger",permalink:"/zh/docs/apisix/next/plugins/loki-logger"},next:{title:"serverless",permalink:"/zh/docs/apisix/next/plugins/serverless"}},s=[{value:"Description",id:"description",children:[]},{value:"Attributes",id:"attributes",children:[]},{value:"Examples",id:"examples",children:[{value:"Report API call usage",id:"report-api-call-usage",children:[]}]},{value:"FAQ",id:"faq",children:[{value:"Purpose of the Plugin",id:"purpose-of-the-plugin",children:[]},{value:"Is it flexible?",id:"is-it-flexible",children:[]},{value:"Which Lago versions does it work with?",id:"which-lago-versions-does-it-work-with",children:[]},{value:"Why Lago can&#39;t receive events?",id:"why-lago-cant-receive-events",children:[]},{value:"Reliability of reporting",id:"reliability-of-reporting",children:[]},{value:"Will the event duplicate?",id:"will-the-event-duplicate",children:[]},{value:"Performance Impacts",id:"performance-impacts",children:[]},{value:"Resource overhead",id:"resource-overhead",children:[]}]}],p={toc:s};function u(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"description"},"Description"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"lago")," plugin pushes requests and responses to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/getlago/lago"},"Lago Self-hosted")," and ",(0,r.kt)("a",{parentName:"p",href:"https://getlago.com"},"Lago Cloud")," via the Lago REST API. the plugin allows you to use it with a variety of APISIX built-in features, such as the APISIX consumer and the request-id plugin."),(0,r.kt)("p",null,"This allows for API monetization or let APISIX to be an AI gateway for AI tokens billing scenarios."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"disclaimer")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Lago owns its trademarks and controls its commercial products and open source projects."),(0,r.kt)("p",{parentName:"div"},"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/getlago/lago"},"https://github.com/getlago/lago")," project uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"AGPL-3.0")," license instead of the ",(0,r.kt)("inlineCode",{parentName:"p"},"Apache-2.0")," license that is the same as Apache APISIX. As a user, you will need to evaluate for yourself whether it is applicable to your business to use the project in a compliant way or to obtain another type of license from Lago. Apache APISIX community does not endorse it."),(0,r.kt)("p",{parentName:"div"},"The plugin does not contain any proprietary code or SDKs from Lago, it is contributed by contributors to Apache APISIX and licensed under the ",(0,r.kt)("inlineCode",{parentName:"p"},"Apache-2.0")," license, which is in line with any other part of APISIX and you don't need to worry about its compliance."))),(0,r.kt)("p",null,"When enabled, the plugin will collect information from the request context (e.g. event code, transaction ID, associated subscription ID) as configured and serialize them into ",(0,r.kt)("a",{parentName:"p",href:"https://getlago.com/docs/api-reference/events/event-object"},"Event JSON objects")," as required by Lago. They will be added to the buffer and sent to Lago in batches of up to 100. This batch size is a ",(0,r.kt)("a",{parentName:"p",href:"https://getlago.com/docs/api-reference/events/batch"},"requirement")," from Lago. If you want to modify it, see ",(0,r.kt)("a",{parentName:"p",href:"../batch-processor.md"},"batch processor")," for more details."),(0,r.kt)("h2",{id:"attributes"},"Attributes"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Required"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid values"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_addrs"),(0,r.kt)("td",{parentName:"tr",align:null},"array","[string]"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Lago API address, such as ",(0,r.kt)("inlineCode",{parentName:"td"},"http://127.0.0.1:3000"),". It supports both self-hosted Lago and Lago Cloud. If multiple endpoints are configured, the log will be pushed to a randomly selected endpoint from the list.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_uri"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/v1/events/batch"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Lago API endpoint for ",(0,r.kt)("a",{parentName:"td",href:"https://docs.getlago.com/api-reference/events/batch"},"batch usage events"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"token"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Lago API key created in the Lago dashboard.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"event_transaction_id"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Event's transaction ID, used to identify and de-duplicate the event. It supports string templates containing APISIX and NGINX variables, such as ",(0,r.kt)("inlineCode",{parentName:"td"},"req_${request_id}"),", which allows you to use values returned by upstream services or the ",(0,r.kt)("inlineCode",{parentName:"td"},"request-id")," plugin.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"event_subscription_id"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Event's subscription ID, which is automatically generated or configured when you assign the plan to the customer on Lago. This is used to associate API consumption to a customer subscription and supports string templates containing APISIX and NGINX variables, such as ",(0,r.kt)("inlineCode",{parentName:"td"},"cus_${consumer_name}"),", which allows you to use values returned by upstream services or APISIX consumer.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"event_code"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"True"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Lago billable metric's code for associating an event to a specified billable item.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"event_properties"),(0,r.kt)("td",{parentName:"tr",align:null},"object"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Event's properties, used to attach information to an event. This allows you to send certain information on an event to Lago, such as the HTTP status to exclude failed requests from billing, or the AI token consumption in the response body for accurate billing. The keys are fixed strings, while the values can be string templates containing APISIX and NGINX variables, such as ",(0,r.kt)("inlineCode",{parentName:"td"},"${status}"),".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"true"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, verify Lago's SSL certificates.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"3000"),(0,r.kt)("td",{parentName:"tr",align:null},"[1, 60000]"),(0,r.kt)("td",{parentName:"tr",align:null},"Timeout for the Lago service HTTP call in milliseconds.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"keepalive"),(0,r.kt)("td",{parentName:"tr",align:null},"boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"true"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"If true, keep the connection alive for multiple requests.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"keepalive_timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"60000"),(0,r.kt)("td",{parentName:"tr",align:null},">=1000"),(0,r.kt)("td",{parentName:"tr",align:null},"Keepalive timeout in milliseconds.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"keepalive_pool"),(0,r.kt)("td",{parentName:"tr",align:null},"integer"),(0,r.kt)("td",{parentName:"tr",align:null},"False"),(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},">=1"),(0,r.kt)("td",{parentName:"tr",align:null},"Maximum number of connections in the connection pool.")))),(0,r.kt)("p",null,"This Plugin supports using batch processors to aggregate and process events in a batch. This avoids the need for frequently submitting the data. The batch processor submits data every ",(0,r.kt)("inlineCode",{parentName:"p"},"5")," seconds or when the data in the queue reaches ",(0,r.kt)("inlineCode",{parentName:"p"},"1000"),". See ",(0,r.kt)("a",{parentName:"p",href:"../batch-processor.md#configuration"},"Batch Processor")," for more information or setting your custom configuration."),(0,r.kt)("h2",{id:"examples"},"Examples"),(0,r.kt)("p",null,"The examples below demonstrate how you can configure ",(0,r.kt)("inlineCode",{parentName:"p"},"lago")," Plugin for typical scenario."),(0,r.kt)("p",null,"To follow along the examples, start a Lago instance. Refer to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/getlago/lago"},"https://github.com/getlago/lago")," or use Lago Cloud."),(0,r.kt)("p",null,"Follow these brief steps to configure Lago:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get the Lago API Key (also known as ",(0,r.kt)("inlineCode",{parentName:"li"},"token"),"), from the ",(0,r.kt)("strong",{parentName:"li"},"Developer")," page of the Lago dashboard."),(0,r.kt)("li",{parentName:"ol"},"Next, create a billable metric used by APISIX, assuming its code is ",(0,r.kt)("inlineCode",{parentName:"li"},"test"),". Set the ",(0,r.kt)("inlineCode",{parentName:"li"},"Aggregation type")," to ",(0,r.kt)("inlineCode",{parentName:"li"},"Count"),"; and add a filter with a key of ",(0,r.kt)("inlineCode",{parentName:"li"},"tier")," whose value contains ",(0,r.kt)("inlineCode",{parentName:"li"},"expensive")," to allow us to distinguish between API values, which will be demonstrated later."),(0,r.kt)("li",{parentName:"ol"},"Create a plan and add the created metric to it. Its code can be configured however you like. In the ",(0,r.kt)("strong",{parentName:"li"},"Usage-based charges")," section, add the billable metric created previously as a ",(0,r.kt)("inlineCode",{parentName:"li"},"Metered charge")," item. Specify the default price as ",(0,r.kt)("inlineCode",{parentName:"li"},"$1"),". Add a filter, use ",(0,r.kt)("inlineCode",{parentName:"li"},"tier: expensive")," to perform the filtering, and specify its price as ",(0,r.kt)("inlineCode",{parentName:"li"},"$10"),"."),(0,r.kt)("li",{parentName:"ol"},"Select an existing consumer or create a new one to assign the plan you just created. You need to specify a ",(0,r.kt)("inlineCode",{parentName:"li"},"Subscription external ID")," (or you can have Lago generate it), which will be used as the APISIX consumer username.")),(0,r.kt)("p",null,"Next we need to configure APISIX for demonstrations."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can fetch the ",(0,r.kt)("inlineCode",{parentName:"p"},"admin_key")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"config.yaml")," and save to an environment variable with the following command:"),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"admin_key=$(yq '.deployment.admin.admin_key[0].key' conf/config.yaml | sed 's/\"//g')\n")))),(0,r.kt)("h3",{id:"report-api-call-usage"},"Report API call usage"),(0,r.kt)("p",null,"The following example demonstrates how you can configure the ",(0,r.kt)("inlineCode",{parentName:"p"},"lago")," Plugin on a Route to measuring API call usage."),(0,r.kt)("p",null,"Create a Route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"lago"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"request-id"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Plugins as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "lago-route-1",\n    "uri": "/get",\n    "plugins": {\n      "request-id": {\n        "include_in_response": true\n      },\n      "key-auth": {},\n      "lago": {\n        "endpoint_addrs": ["http://12.0.0.1:3000"],\n        "token": "<Get token from Lago dashboard>",\n        "event_transaction_id": "${http_x_request_id}",\n        "event_subscription_id": "${http_x_consumer_username}",\n        "event_code": "test"\n      }\n    },\n    "upstream": {\n      "nodes": {\n        "httpbin.org:80": 1\n      },\n      "type": "roundrobin"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a second route with the ",(0,r.kt)("inlineCode",{parentName:"p"},"lago"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"request-id"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"key-auth")," Plugin as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "id": "lago-route-2",\n    "uri": "/anything",\n    "plugins": {\n      "request-id": {\n        "include_in_response": true\n      },\n      "key-auth": {},\n      "lago": {\n        "endpoint_addrs": ["http://12.0.0.1:3000"],\n        "token": "<Get token from Lago dashboard>",\n        "event_transaction_id": "${http_x_request_id}",\n        "event_subscription_id": "${http_x_consumer_username}",\n        "event_code": "test",\n        "event_properties": {\n          "tier": "expensive"\n        }\n      }\n    },\n    "upstream": {\n      "nodes": {\n        "httpbin.org:80": 1\n      },\n      "type": "roundrobin"\n    }\n  }\'\n')),(0,r.kt)("p",null,"Create a Consumer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/consumers" -X PUT \\\n  -H "X-API-KEY: ${admin_key}" \\\n  -d \'{\n    "username": "<Lago subscription external ID>",\n    "plugins": {\n      "key-auth": {\n        "key": "demo"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"Send three requests to the two routes respectively:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9080/get"\ncurl "http://127.0.0.1:9080/get"\ncurl "http://127.0.0.1:9080/get"\ncurl "http://127.0.0.1:9080/anything"\ncurl "http://127.0.0.1:9080/anything"\ncurl "http://127.0.0.1:9080/anything"\n')),(0,r.kt)("p",null,"You should receive ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP/1.1 200 OK")," responses for all requests."),(0,r.kt)("p",null,"Wait a few seconds, then navigate to the ",(0,r.kt)("strong",{parentName:"p"},"Developer")," page in the Lago dashboard. Under ",(0,r.kt)("strong",{parentName:"p"},"Events"),", you should see 6 event entries sent by APISIX."),(0,r.kt)("p",null,"If the self-hosted instance's event worker is configured correctly (or if you're using Lago Cloud), you can also see the total amount consumed in real time in the consumer's subscription usage, which should be ",(0,r.kt)("inlineCode",{parentName:"p"},"3 * $1 + 3 * $10 = $33")," according to our demo use case."),(0,r.kt)("h2",{id:"faq"},"FAQ"),(0,r.kt)("h3",{id:"purpose-of-the-plugin"},"Purpose of the Plugin"),(0,r.kt)("p",null,"When you make an effort to monetize your API, it's hard to find a ready-made, low-cost solution, so you may have to build your own billing stack, which is complicated."),(0,r.kt)("p",null,"This plugin allows you to use APISIX to handle API proxies and use Lago as a billing stack through direct integration with Lago, and both the APISIX open source project and Lago will be part of your portfolio, which is a huge time saver."),(0,r.kt)("p",null,"Every API call results in a Lago event, which allows you to bill users for real usage, i.e. pay-as-you-go, and thanks to our built-in transaction ID (request ID) support, you can simply implement API call logging and troubleshooting for your customers."),(0,r.kt)("p",null,"In addition to typical API monetization scenarios, APISIX can also do AI tokens-based billing when it is acting as an AI gateway, where each Lago event generated by an API request includes exactly how many tokens were consumed, to allow you to charge the user for a fine-grained per-tokens usage."),(0,r.kt)("h3",{id:"is-it-flexible"},"Is it flexible?"),(0,r.kt)("p",null,"Of course, the fact that we make transaction ID, subscription ID as a configuration item and allow you to use APISIX and NGINX variables in it means that it's simple to integrate the plugin with any existing or your own authentication and internal services."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use custom authentication: as long as the Lago subscription ID represented by the user ID is registered as an APISIX variable, it will be available from there, so custom authentication is completely possible!"),(0,r.kt)("li",{parentName:"ul"},"Integration with internal services: You might not need the APISIX built-in request-id plugin. That's OK. You can have your internal service (APISIX upstream) generate it and include it in the HTTP response header. Then you can access it via an NGINX variable in the transaction ID.")),(0,r.kt)("p",null,"Event properties are supported, allowing you to set special values for specific APIs. For example, if your service has 100 APIs, you can enable general billing for all of them while customizing a few with different pricing\u2014just as demonstrated above."),(0,r.kt)("h3",{id:"which-lago-versions-does-it-work-with"},"Which Lago versions does it work with?"),(0,r.kt)("p",null,"When we first developed the Lago plugin, it was released to ",(0,r.kt)("inlineCode",{parentName:"p"},"1.17.0"),", which we used for integration, so it works at least with ",(0,r.kt)("inlineCode",{parentName:"p"},"1.17.0"),"."),(0,r.kt)("p",null,"Technically, we use the Lago batch event API to submit events in batches, and APISIX will only use this API, so as long as Lago doesn't make any disruptive changes to this API, APISIX will be able to integrate with it."),(0,r.kt)("p",null,"Here's an ",(0,r.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20250516073803/https://getlago.com/docs/api-reference/events/batch"},"archive page")," of the API documentation, which allows you to check the differences between the API at the time of our integration and the latest API."),(0,r.kt)("p",null,"If the latest API changes, you can submit an issue to inform the APISIX maintainers that this may require some changes."),(0,r.kt)("h3",{id:"why-lago-cant-receive-events"},"Why Lago can't receive events?"),(0,r.kt)("p",null,"Look at ",(0,r.kt)("inlineCode",{parentName:"p"},"error.log")," for such a log."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"2023/04/30 13:45:46 [error] 19381#19381: *1075673 [lua] batch-processor.lua:95: Batch Processor[lago logger] failed to process entries: lago api returned status: 400, body: <error message>, context: ngx.timer, client: 127.0.0.1, server: 0.0.0.0:9080\n")),(0,r.kt)("p",null,"The error can be diagnosed based on the error code in the ",(0,r.kt)("inlineCode",{parentName:"p"},"failed to process entries: lago api returned status: 400, body: <error message>")," and the response body of the lago server."),(0,r.kt)("h3",{id:"reliability-of-reporting"},"Reliability of reporting"),(0,r.kt)("p",null,"The plugin may encounter a network problem that prevents the node where the gateway is located from communicating with the Lago API, in which case APISIX will discard the batch according to the ",(0,r.kt)("a",{parentName:"p",href:"../batch-processor.md"},"batch processor")," configuration, the batch will be discarded if the specified number of retries are made and the dosage still cannot be sent."),(0,r.kt)("p",null,"Discarded events are permanently lost, so it is recommended that you use this plugin in conjunction with other logging mechanisms and perform event replay after Lago is unavailable causing data to be discarded to ensure that all logs are correctly sent to Lago."),(0,r.kt)("h3",{id:"will-the-event-duplicate"},"Will the event duplicate?"),(0,r.kt)("p",null,"While APISIX performs retries based on the ",(0,r.kt)("a",{parentName:"p",href:"../batch-processor.md"},"batch processor")," configuration, you don't need to worry about duplicate events being reported to Lago."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"event_transcation_id")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"timestamp")," are generated and logged after the request is processed on the APISIX side, and Lago de-duplicates the event based on them.\nSo even if a retry is triggered because the network causes Lago to send a ",(0,r.kt)("inlineCode",{parentName:"p"},"success")," response that is not received by APISIX, the event is still not duplicated on Lago."),(0,r.kt)("h3",{id:"performance-impacts"},"Performance Impacts"),(0,r.kt)("p",null,"The plugin is logically simple and reliable; it simply builds a Lago event object for each request, buffers and sends them in bulk. The logic is not coupled to the request proxy path, so this does not cause latency to rise for requests going through the gateway."),(0,r.kt)("p",null,"Technically, the logic is executed in the NGINX log phase and ",(0,r.kt)("a",{parentName:"p",href:"../batch-processor.md"},"batch processor")," timer, so this does not affect the request itself."),(0,r.kt)("h3",{id:"resource-overhead"},"Resource overhead"),(0,r.kt)("p",null,"As explained earlier in the performance impact section, the plugin doesn't cause a significant increase in system resources. It only uses a small amount of memory to store events for batching."))}u.isMDXComponent=!0}}]);