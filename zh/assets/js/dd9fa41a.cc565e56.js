"use strict";(self.webpackChunkdoc=self.webpackChunkdoc||[]).push([[82656],{3905:(t,e,n)=>{n.d(e,{Zo:()=>m,kt:()=>k});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var p=a.createContext({}),d=function(t){var e=a.useContext(p),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},m=function(t){var e=d(t.components);return a.createElement(p.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},c=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,p=t.parentName,m=o(t,["components","mdxType","originalType","parentName"]),c=d(n),k=r,s=c["".concat(p,".").concat(k)]||c[k]||u[k]||l;return n?a.createElement(s,i(i({ref:e},m),{},{components:n})):a.createElement(s,i({ref:e},m))}));function k(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,i=new Array(l);i[0]=c;var o={};for(var p in e)hasOwnProperty.call(e,p)&&(o[p]=e[p]);o.originalType=t,o.mdxType="string"==typeof t?t:r,i[1]=o;for(var d=2;d<l;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},95636:(t,e,n)=>{n.r(e),n.d(e,{contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={title:"ai-aliyun-content-moderation",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","ai-aliyun-content-moderation"],description:"\u672c\u6587\u6863\u5305\u542b\u6709\u5173 Apache APISIX ai-aliyun-content-moderation \u63d2\u4ef6\u7684\u4fe1\u606f\u3002"},i=void 0,o={unversionedId:"plugins/ai-aliyun-content-moderation",id:"plugins/ai-aliyun-content-moderation",isDocsHomePage:!1,title:"ai-aliyun-content-moderation",description:"\u672c\u6587\u6863\u5305\u542b\u6709\u5173 Apache APISIX ai-aliyun-content-moderation \u63d2\u4ef6\u7684\u4fe1\u606f\u3002",source:"@site/i18n/zh/docusaurus-plugin-content-docs-docs-apisix/current/plugins/ai-aliyun-content-moderation.md",sourceDirName:"plugins",slug:"/plugins/ai-aliyun-content-moderation",permalink:"/zh/docs/apisix/next/plugins/ai-aliyun-content-moderation",editUrl:"/zh/edit#https://github.com/apache/apisix/edit/master/docs/zh/latest/plugins/ai-aliyun-content-moderation.md",tags:[],version:"current",frontMatter:{title:"ai-aliyun-content-moderation",keywords:["Apache APISIX","API \u7f51\u5173","Plugin","ai-aliyun-content-moderation"],description:"\u672c\u6587\u6863\u5305\u542b\u6709\u5173 Apache APISIX ai-aliyun-content-moderation \u63d2\u4ef6\u7684\u4fe1\u606f\u3002"},sidebar:"docs",previous:{title:"ai-aws-content-moderation",permalink:"/zh/docs/apisix/next/plugins/ai-aws-content-moderation"},next:{title:"ai-prompt-decorator",permalink:"/zh/docs/apisix/next/plugins/ai-prompt-decorator"}},p=[{value:"\u63cf\u8ff0",id:"\u63cf\u8ff0",children:[]},{value:"\u63d2\u4ef6\u5c5e\u6027",id:"\u63d2\u4ef6\u5c5e\u6027",children:[]},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",children:[]}],d={toc:p};function m(t){let{components:e,...n}=t;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u63cf\u8ff0"},"\u63cf\u8ff0"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ai-aliyun-content-moderation")," \u63d2\u4ef6\u96c6\u6210\u4e86\u963f\u91cc\u4e91\u7684\u5185\u5bb9\u5ba1\u6838\u670d\u52a1\uff0c\u7528\u4e8e\u5728\u4e0e\u5927\u8bed\u8a00\u6a21\u578b (LLM) \u4ea4\u4e92\u65f6\u68c0\u67e5\u8bf7\u6c42\u548c\u54cd\u5e94\u5185\u5bb9\u662f\u5426\u5305\u542b\u4e0d\u5f53\u6750\u6599\u3002\u5b83\u652f\u6301\u5b9e\u65f6\u6d41\u5f0f\u68c0\u67e5\u548c\u6700\u7ec8\u6570\u636e\u5305\u5ba1\u6838\u4e24\u79cd\u6a21\u5f0f\u3002"),(0,r.kt)("p",null,"\u6b64\u63d2\u4ef6\u5fc5\u987b\u5728\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy")," \u6216 ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy-multi")," \u63d2\u4ef6\u7684\u8def\u7531\u4e2d\u4f7f\u7528\u3002"),(0,r.kt)("h2",{id:"\u63d2\u4ef6\u5c5e\u6027"},"\u63d2\u4ef6\u5c5e\u6027"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\u5b57\u6bb5")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\u5fc5\u9009\u9879")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\u7c7b\u578b")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\u63cf\u8ff0")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u963f\u91cc\u4e91\u670d\u52a1\u7aef\u70b9 URL")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"region_id"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u963f\u91cc\u4e91\u533a\u57df\u6807\u8bc6\u7b26")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"access_key_id"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u963f\u91cc\u4e91\u8bbf\u95ee\u5bc6\u94a5 ID")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"access_key_secret"),(0,r.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u963f\u91cc\u4e91\u8bbf\u95ee\u5bc6\u94a5\u5bc6\u7801")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"check_request"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"\u542f\u7528\u8bf7\u6c42\u5185\u5bb9\u5ba1\u6838\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"true"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"check_response"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"\u542f\u7528\u54cd\u5e94\u5185\u5bb9\u5ba1\u6838\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"false"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_mode"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6d41\u5f0f\u5ba1\u6838\u6a21\u5f0f\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'"final_packet"'),"\u3002\u6709\u6548\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'["realtime", "final_packet"]'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_cache_size"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Integer"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5b9e\u65f6\u6a21\u5f0f\u4e0b\u6bcf\u6b21\u5ba1\u6838\u6279\u6b21\u7684\u6700\u5927\u5b57\u7b26\u6570\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"128"),"\u3002\u5fc5\u987b ",(0,r.kt)("inlineCode",{parentName:"td"},">= 1"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"stream_check_interval"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5b9e\u65f6\u6a21\u5f0f\u4e0b\u6279\u6b21\u68c0\u67e5\u4e4b\u95f4\u7684\u95f4\u9694\u79d2\u6570\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"3"),"\u3002\u5fc5\u987b ",(0,r.kt)("inlineCode",{parentName:"td"},">= 0.1"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"request_check_service"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u7528\u4e8e\u8bf7\u6c42\u5ba1\u6838\u7684\u963f\u91cc\u4e91\u670d\u52a1\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'"llm_query_moderation"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"request_check_length_limit"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6bcf\u4e2a\u8bf7\u6c42\u5ba1\u6838\u5757\u7684\u6700\u5927\u5b57\u7b26\u6570\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"2000"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"response_check_service"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u7528\u4e8e\u54cd\u5e94\u5ba1\u6838\u7684\u963f\u91cc\u4e91\u670d\u52a1\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'"llm_response_moderation"'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"response_check_length_limit"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"\u6bcf\u4e2a\u54cd\u5e94\u5ba1\u6838\u5757\u7684\u6700\u5927\u5b57\u7b26\u6570\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"5000"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"risk_level_bar"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5185\u5bb9\u62d2\u7edd\u7684\u9608\u503c\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'"high"'),"\u3002\u6709\u6548\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},'["none", "low", "medium", "high", "max"]'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"deny_code"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Number"),(0,r.kt)("td",{parentName:"tr",align:null},"\u88ab\u62d2\u7edd\u5185\u5bb9\u7684 HTTP \u72b6\u6001\u7801\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"200"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"deny_message"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"String"),(0,r.kt)("td",{parentName:"tr",align:null},"\u88ab\u62d2\u7edd\u5185\u5bb9\u7684\u81ea\u5b9a\u4e49\u6d88\u606f\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"-"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"timeout"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Integer"),(0,r.kt)("td",{parentName:"tr",align:null},"\u8bf7\u6c42\u8d85\u65f6\u65f6\u95f4\uff08\u6beb\u79d2\uff09\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"10000"),"\u3002\u5fc5\u987b ",(0,r.kt)("inlineCode",{parentName:"td"},">= 1"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ssl_verify"),(0,r.kt)("td",{parentName:"tr",align:null},"\u5426"),(0,r.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,r.kt)("td",{parentName:"tr",align:null},"\u542f\u7528 SSL \u8bc1\u4e66\u9a8c\u8bc1\u3002\u9ed8\u8ba4\u503c\uff1a",(0,r.kt)("inlineCode",{parentName:"td"},"true"))))),(0,r.kt)("h2",{id:"\u4f7f\u7528\u793a\u4f8b"},"\u4f7f\u7528\u793a\u4f8b"),(0,r.kt)("p",null,"\u9996\u5148\u521d\u59cb\u5316\u8fd9\u4e9b shell \u53d8\u91cf\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"ADMIN_API_KEY=edd1c9f034335f136f87ad84b625c8f1\nALIYUN_ACCESS_KEY_ID=your-aliyun-access-key-id\nALIYUN_ACCESS_KEY_SECRET=your-aliyun-access-key-secret\nALIYUN_REGION=cn-hangzhou\nALIYUN_ENDPOINT=https://green.cn-hangzhou.aliyuncs.com\nOPENAI_KEY=your-openai-api-key\n")),(0,r.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u5e26\u6709 ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-aliyun-content-moderation")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy")," \u63d2\u4ef6\u7684\u8def\u7531\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -X PUT \\\n  -H "X-API-KEY: ${ADMIN_API_KEY}" \\\n  -d \'{\n    "uri": "/v1/chat/completions",\n    "plugins": {\n      "ai-proxy": {\n        "provider": "openai",\n        "auth": {\n          "header": {\n            "Authorization": "Bearer \'"$OPENAI_KEY"\'"\n          }\n        },\n        "override": {\n          "endpoint": "http://localhost:6724/v1/chat/completions"\n        }\n      },\n      "ai-aliyun-content-moderation": {\n        "endpoint": "\'"$ALIYUN_ENDPOINT"\'",\n        "region_id": "\'"$ALIYUN_REGION"\'",\n        "access_key_id": "\'"$ALIYUN_ACCESS_KEY_ID"\'",\n        "access_key_secret": "\'"$ALIYUN_ACCESS_KEY_SECRET"\'",\n        "risk_level_bar": "high",\n        "check_request": true,\n        "check_response": true,\n        "deny_code": 400,\n        "deny_message": "\u60a8\u7684\u8bf7\u6c42\u8fdd\u53cd\u4e86\u5185\u5bb9\u653f\u7b56"\n      }\n    }\n  }\'\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"ai-proxy")," \u63d2\u4ef6\u662f\u56e0\u4e3a\u5b83\u7b80\u5316\u4e86\u5bf9 LLM \u7684\u8bbf\u95ee\u3002\u4e0d\u8fc7\uff0c\u60a8\u4e5f\u53ef\u4ee5\u5728\u4e0a\u6e38\u914d\u7f6e\u4e2d\u914d\u7f6e LLM\u3002"),(0,r.kt)("p",null,"\u73b0\u5728\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl http://127.0.0.1:9080/v1/chat/completions -i \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "model": "gpt-3.5-turbo",\n    "messages": [\n      {"role": "user", "content": "I want to kill you"}\n    ],\n    "stream": false\n  }\'\n')),(0,r.kt)("p",null,"\u7136\u540e\u8bf7\u6c42\u5c06\u88ab\u963b\u6b62\uff0c\u5e76\u8fd4\u56de\u5982\u4e0b\u9519\u8bef\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 400 Bad Request\nContent-Type: application/json\n\n{"id":"chatcmpl-123","object":"chat.completion","model":"gpt-3.5-turbo","choices":[{"index":0,"message":{"role":"assistant","content":"\u60a8\u7684\u8bf7\u6c42\u8fdd\u53cd\u4e86\u5185\u5bb9\u653f\u7b56"},"finish_reason":"stop"}],"usage":{"prompt_tokens":0,"completion_tokens":0,"total_tokens":0}}\n')))}m.isMDXComponent=!0}}]);