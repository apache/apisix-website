<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WQLBQL6GY3"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WQLBQL6GY3",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/events/rss.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/events/atom.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/zh/releases/rss.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/releases/atom.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/zh/articles/rss.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/articles/atom.xml" title="Apache APISIXÂ® --  Cloud-Native API Gateway Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"><title data-react-helmet="true">Envoy and Apache APISIX: Another way to implement the Envoy filter | Apache APISIXÂ® --  Cloud-Native API Gateway</title><meta data-react-helmet="true" property="og:title" content="Envoy and Apache APISIX: Another way to implement the Envoy filter | Apache APISIXÂ® --  Cloud-Native API Gateway"><meta data-react-helmet="true" property="og:description" content="@nic-chen, Apache APISIX PMC from Shenzhen Zhiliu Technology Co."><meta data-react-helmet="true" property="og:url" content="https://apisix.apache.org//zh/blog/2020/12/16/another-way-to-implement-envoy-filter"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="description" content="Apache APISIX is a dynamic, real-time, high-performance Cloud-Native API gateway, based on the Nginx library and etcd."><meta data-react-helmet="true" name="robots" content="index,follow"><meta data-react-helmet="true" property="og:image" content="https://apisix.apache.org//zh/img/favicon.png"><meta data-react-helmet="true" name="twitter:image" content="https://apisix.apache.org//zh/img/favicon.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://apisix.apache.org//zh/blog/2020/12/16/another-way-to-implement-envoy-filter"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org//blog/2020/12/16/another-way-to-implement-envoy-filter" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org//zh/blog/2020/12/16/another-way-to-implement-envoy-filter" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://apisix.apache.org//blog/2020/12/16/another-way-to-implement-envoy-filter" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.582781a9.css">
<link rel="preload" href="/zh/assets/js/runtime~main.e0738370.js" as="script">
<link rel="preload" href="/zh/assets/js/main.b2de653d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo2.svg" alt="Apache APISIXÂ®" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logo2.svg" alt="Apache APISIXÂ®" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Apache APISIXÂ®</strong></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs">æ–‡æ¡£</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/apisix/getting-started">Apache APISIXÂ®ï¸</a></li><li><a class="dropdown__link" href="/zh/docs/dashboard/USER_GUIDE">Apache APISIXÂ®ï¸ Dashboard</a></li><li><a class="dropdown__link" href="/zh/docs/ingress-controller/getting-started/">Apache APISIXÂ®ï¸ Ingress Controller</a></li><li><a class="dropdown__link" href="/zh/docs/helm-chart/apisix/">Apache APISIXÂ®ï¸ Helm Charts</a></li><li><a class="dropdown__link" href="/zh/docs/docker/build/">Apache APISIXÂ®ï¸ Docker</a></li><li><a class="dropdown__link" href="/zh/docs/java-plugin-runner/development/">Apache APISIXÂ®ï¸ Java Plugin Runner</a></li><li><a class="dropdown__link" href="/zh/docs/go-plugin-runner/getting-started/">Apache APISIXÂ®ï¸ Go Plugin Runner</a></li><li><a class="dropdown__link" href="/zh/docs/python-plugin-runner/getting-started/">Apache APISIXÂ®ï¸ Python Plugin Runner</a></li><li><a class="dropdown__link" href="/zh/docs/general/security">General</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">FAQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/apisix/FAQ/">Apache APISIXÂ®</a></li><li><a class="dropdown__link" href="/zh/docs/dashboard/FAQ/">Apache APISIXÂ® Dashboard</a></li><li><a class="dropdown__link" href="/zh/docs/ingress-controller/FAQ/">Apache APISIXÂ® Ingress Controller</a></li><li><a class="dropdown__link" href="/zh/docs/helm-chart/FAQ/">Apache APISIXÂ® Helm Chart</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/downloads">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/team">å›¢é˜Ÿ</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/plugins">Plugin Hub</a></li><li><a class="dropdown__link" href="/zh/events">Events</a></li><li><a class="dropdown__link" href="/zh/releases">Releases</a></li><li><a class="dropdown__link" href="/zh/help">Help</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2020/12/16/another-way-to-implement-envoy-filter" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/2020/12/16/another-way-to-implement-envoy-filter" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo2.svg" alt="Apache APISIXÂ®" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logo2.svg" alt="Apache APISIXÂ®" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Apache APISIXÂ®</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/zh/docs">æ–‡æ¡£</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/apisix/getting-started">Apache APISIXÂ®ï¸</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/dashboard/USER_GUIDE">Apache APISIXÂ®ï¸ Dashboard</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/ingress-controller/getting-started/">Apache APISIXÂ®ï¸ Ingress Controller</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/helm-chart/apisix/">Apache APISIXÂ®ï¸ Helm Charts</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/docker/build/">Apache APISIXÂ®ï¸ Docker</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/java-plugin-runner/development/">Apache APISIXÂ®ï¸ Java Plugin Runner</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/go-plugin-runner/getting-started/">Apache APISIXÂ®ï¸ Go Plugin Runner</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/python-plugin-runner/getting-started/">Apache APISIXÂ®ï¸ Python Plugin Runner</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/general/security">General</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/apisix/FAQ/">Apache APISIXÂ®</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/dashboard/FAQ/">Apache APISIXÂ® Dashboard</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/ingress-controller/FAQ/">Apache APISIXÂ® Ingress Controller</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/helm-chart/FAQ/">Apache APISIXÂ® Helm Chart</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/zh/blog">åšå®¢</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/downloads">ä¸‹è½½</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/team">å›¢é˜Ÿ</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Resources</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/plugins">Plugin Hub</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/events">Events</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/releases">Releases</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/help">Help</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog/2020/12/16/another-way-to-implement-envoy-filter" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/zh/blog/2020/12/16/another-way-to-implement-envoy-filter" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_nmLu">Envoy and Apache APISIX: Another way to implement the Envoy filter</h1><div class="postHeader_qYPS"><div class="avatar margin-bottom--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/nic-chen" target="_blank" rel="noopener noreferrer" class="authorName_3Neb">Author: nic-chen</a></h4></div></div><div class="margin-bottom--md line_1rJo"><div></div></div><div class="margin-bottom--md headerDate_67br marginLeft_rCVv"><svg width="16" height="16" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" fill-opacity="0.01" d="M0 0h48v48H0z"></path><path d="M24 44c11.046 0 20-8.954 20-20S35.046 4 24 4 4 12.954 4 24s8.954 20 20 20z" stroke="#333" stroke-width="4" stroke-linejoin="round"></path><path d="M24.008 12v12.009l8.479 8.48" stroke="#333" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path></svg><time datetime="2020-12-16T00:00:00.000Z" class="blogPostDate_3tMv">2020å¹´12æœˆ16æ—¥ Â· One min read</time></div><div class="margin-bottom--md line_1rJo"><div></div></div><div class="margin-bottom--md"><div class="col headerTags_2Lqv"><svg width="16" height="16" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" fill-opacity="0.01" d="M0 0h48v48H0z"></path><path d="M42.17 29.245L29.262 42.151a3.6 3.6 0 01-5.094 0L8 26V8h18l16.17 16.17a3.6 3.6 0 010 5.075z" stroke="#333" stroke-width="4" stroke-linejoin="round"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M18.5 21a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" fill="#333"></path></svg><a class="margin-horiz--sm" href="/zh/blog/tags/technology">technology</a></div></div></div></header><div class="markdown"><blockquote><p><a href="https://github.com/nic-chen" target="_blank" rel="noopener noreferrer">@nic-chen</a>, Apache APISIX PMC from <a href="https://www.apiseven.com/" target="_blank" rel="noopener noreferrer">Shenzhen Zhiliu Technology Co.</a></p></blockquote><blockquote><p>Source: <a href="https://www.apiseven.com/en/blog/another-way-to-implement-envoy-filter" target="_blank" rel="noopener noreferrer">https://www.apiseven.com/en/blog/another-way-to-implement-envoy-filter</a></p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="ways-to-implement-envoy-filter"></a>Ways to implement Envoy filter<a class="hash-link" href="#ways-to-implement-envoy-filter" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="envoy-filter"></a>Envoy filter<a class="hash-link" href="#envoy-filter" title="Direct link to heading">#</a></h3><p>Envoy is an L7 proxy and communication bus designed for large modern service oriented architectures.
A pluggable filter chain mechanism allows filters to be written to perform different tasks and inserted into the main server.</p><p><img src="https://static.apiseven.com/filters.png" alt="Envoy filter"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="expansion-method"></a>Expansion method<a class="hash-link" href="#expansion-method" title="Direct link to heading">#</a></h3><p>The existing filters may not meet the user&#x27;s custom requirements. In this case, Envoy needs to be extended. Customize new filters according to the existing filter chain to achieve customization requirements.</p><p>Developers can extend Envoy in three ways:</p><table><thead><tr><th align="center"></th><th align="center">Getting Started difficulty</th><th align="center">stability</th><th align="center">development efficiency</th><th align="center">Deploy and compile</th></tr></thead><tbody><tr><td align="center">C++</td><td align="center">high</td><td align="center">stable</td><td align="center">low</td><td align="center">long time to compile</td></tr><tr><td align="center">Lua</td><td align="center">low</td><td align="center">stable</td><td align="center">High</td><td align="center">no need to compile, deploy directly</td></tr><tr><td align="center">WASM</td><td align="center">high-medium</td><td align="center">on the fence</td><td align="center">depends on language</td><td align="center">compilation time depends on language</td></tr></tbody></table><ol><li>Using C++ to extend</li></ol><p>In this way, C++ code is written directly on the basis of Envoy for functional enhancement. After implementing a custom filter, the new binary file is recompiled to complete the upgrade. There are two problems with this way:</p><ul><li><p>Limited by the C++ language, difficulty of getting started, scarcity of developers.</p></li><li><p>Increasing the complexity of deployment, operation and maintenance, and upgrades. Envoy will become heavier and heavier, and every change requires recompiling the binary file, which is not conducive to iteration and management.</p></li></ul><ol start="2"><li>Using Lua to extend</li></ol><p>Lua is born to be embedded in the application, so as to provide flexible extension and customization features for application, and is widely used.</p><p>Lua Filter allows Lua scripts to be run in the request and response process. The main features currently supported include: inspection of headers, body, and trailers while streaming in either the request flow, response flow;modification of headers and trailers;blocking and buffering the full request/response body for inspection;performing an outbound async HTTP call to an upstream host;performing a direct response and skipping further filter iteration, etc.</p><p>At present, many people directly distribute Lua code in configuration, which is not conducive to code organization and management, and it is difficult to share with others to form an ecosystem.</p><ol start="3"><li>Using WASM extension</li></ol><p>Developers can write filters in their own programming language, compile them into WASM format using tools, and embed them into Envoy to run.</p><p>It currently supports few languages, and using these languages â€‹â€‹to extend is still not that simple. On the other hand, many people still have reservations about WASM and may not directly use it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="apache-apisix-solution"></a>Apache APISIX solution<a class="hash-link" href="#apache-apisix-solution" title="Direct link to heading">#</a></h2><p>Based on the above analysis, we could see that Lua is very suitable for extending Envoy, and it is easy to learn, and the development efficiency is extremely high. Because it is embedded in Envoy, there is no additional network overhead, and the performance is good.</p><p><a href="https://github.com/apache/apisix" target="_blank" rel="noopener noreferrer">Apache APISIX</a> community proposes its own solution based on Lua, which is to provide a powerful and flexible basic library to implement all plugins of Apache APISIX and plugins that will be developed in the future to run on Envoy. Developers could also develop their own customized plugins based on this basic library.</p><p>Apache APISIX is a dynamic, real-time, high-performance API gateway, based on the Nginx library and Lua. Apache APISIX provides rich traffic management features such as load balancing, dynamic upstream, canary release, circuit breaking, authentication, observability, and more.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h3><p>Please check the repo for specific code and how to run: <a href="https://github.com/api7/envoy-apisix" target="_blank" rel="noopener noreferrer">https://github.com/api7/envoy-apisix</a></p><p>The relevant configuration of Envoy is as follows:</p><p>Define a Filter:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">http_filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> entry.lua</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">typed_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;@type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source_codes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">entry.lua</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">filename</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /apisix/entry.lua</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Enable the Filter for a route and configure it with metadata:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">match</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">prefix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/foo&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">route</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cluster</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web_service</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">typed_per_filter_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">envoy.filters.http.lua</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">&quot;@type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute</span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> entry.lua</span></div><div class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">filter_metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">envoy.filters.http.lua</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> uri</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">blocker</span></div><div class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">conf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">rejected_code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">403</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">block_rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> root.exe</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> root.m+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="how-does-it-work"></a>How does it work<a class="hash-link" href="#how-does-it-work" title="Direct link to heading">#</a></h3><p>We don&#x27;t need to make major changes to Envoy, only some optimizations that are suitable for public needs.</p><p>We shield platform differences for the plugin layer. All interfaces that need to be used are abstracted in the underlying framework, which we call apisix.core, so that all plugins can run on Envoy and Apache APISIX at the same time.</p><p><img src="https://static.apiseven.com/main.png" alt="Architecture diagram"></p><p>We use the previous example to show how the plugin runs:</p><p><img src="https://static.apiseven.com/workflow.png" alt="Plugin workflow"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="first-step-read-configuration"></a>First step, read configuration<a class="hash-link" href="#first-step-read-configuration" title="Direct link to heading">#</a></h4><p>We configure through metadata to determine what plugins need to run on each route and what configuration is for each plugin.
In the example, we configured plugin <code>uri-blocker</code> for the route whose prefix is â€‹â€‹<code>/foo</code>, as well as the block rule of the plugin and the response status when a block is required.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="second-step-parse-request"></a>Second step, parse request<a class="hash-link" href="#second-step-parse-request" title="Direct link to heading">#</a></h4><p>We encapsulated the client request data into <code>ctx</code> so that it can be used directly in the entire process.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="third-step-run-the-plugin"></a>Third step, run the plugin<a class="hash-link" href="#third-step-run-the-plugin" title="Direct link to heading">#</a></h4><p>We determine whether we need to block this request by matching the configured rules and the obtained uri. If a block is needed, we call <code>respond</code> to directly respond, otherwise we let it go.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="future-outlook"></a>Future outlook<a class="hash-link" href="#future-outlook" title="Direct link to heading">#</a></h2><p>More and more APISIX plugins are available to run on Envoy, and finally all APISIX plugins (Even that will be developed in the future) will be available to run on Envoy.</p><p>At the same time, we hope that we could work with the Envoy community in the direction of Lua Filter, optimize and improve Lua Filter, enhance the expansion capabilities of Envoy, and reduce the difficulty of Envoy expansion.</p></div><footer class="row margin-vert--lg"></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/2020/12/18/a-first-look-at-kubernetes-service-api"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« åˆæ¢ Kubernetes Service APIs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/2020/08/22/new-website"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">New website for Apache APISIX Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ways-to-implement-envoy-filter" class="table-of-contents__link">Ways to implement Envoy filter</a><ul><li><a href="#envoy-filter" class="table-of-contents__link">Envoy filter</a></li><li><a href="#expansion-method" class="table-of-contents__link">Expansion method</a></li></ul></li><li><a href="#apache-apisix-solution" class="table-of-contents__link">Apache APISIX solution</a><ul><li><a href="#example" class="table-of-contents__link">Example</a></li><li><a href="#how-does-it-work" class="table-of-contents__link">How does it work</a></li></ul></li><li><a href="#future-outlook" class="table-of-contents__link">Future outlook</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">ASF</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation</a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License</a></li><li class="footer__item"><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events</a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship</a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/apisix/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issue Tracker</a></li><li class="footer__item"><a href="https://join.slack.com/t/the-asf/shared_invite/zt-nggtva4i-hDCsW1S35MuZ2g_2DgVDGg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack</a></li><li class="footer__item"><a href="https://twitter.com/ApacheAPISIX" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://apisix.apache.org/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/zh/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/zh/img/asf_logo_wide_small.png" alt="Apache Software Foundation" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2019-2021 The Apache Software Foundation. Apache APISIX, APISIXÂ®, Apache, the Apache feather logo, and the Apache APISIX project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.e0738370.js"></script>
<script src="/zh/assets/js/main.b2de653d.js"></script>
</body>
</html>